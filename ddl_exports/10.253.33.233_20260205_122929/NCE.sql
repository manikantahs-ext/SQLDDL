-- DDL Export
-- Server: 10.253.33.233
-- Database: NCE
-- Exported: 2026-02-05T12:29:44.236226

USE NCE;
GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_ProperCase
-- --------------------------------------------------





create function [dbo].[CLS_ProperCase](@Text as varchar(8000))
returns varchar(8000)
as
begin
   declare @Reset bit;
   declare @Ret varchar(8000);
   declare @i int;
   declare @c char(1);

   select @Reset = 1, @i=1, @Ret = '';

   while (@i <= len(@Text))
    select @c= substring(@Text,@i,1),
               @Ret = @Ret + case when @Reset=1 then UPPER(@c) else LOWER(@c) end,
               @Reset = case when @c like '[a-zA-Z]' then 0 else 1 end,
               @i = @i +1
   return @Ret
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertDigit
-- --------------------------------------------------

CREATE Function [dbo].[ConvertDigit] ( @MyDigit char(1)) returns varchar(10) 
	as 
	Begin
	 declare @vOutput varchar(8)
	 set @vOutput =  Case @MyDigit
	            when '1' then 'One'
	            when '2' then 'Two'
	            when '3' then 'Three'
	            when '4' then 'Four'
	            when '5' then 'Five'
	            when '6' then 'Six'
	            when '7' then 'Seven'
	            when '8' then 'Eight'
	            when '9' then 'Nine'
        	    Else '' end 
      	Return (@vOutPut)
	End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertHundreds
-- --------------------------------------------------
/*
Print dbo.ConvertHundreds('121')
*/
CREATE Function [dbo].[ConvertHundreds](@MyNumber varchar(3)) returns varchar(200)
as
Begin
	Declare @Result varchar(200)
	set @Result = ''
	-- Exit if there is nothing to convert.
	If convert(int,@MyNumber) <> 0 
	Begin
		--' Append leading zeros to number.
		set @MyNumber = Right('000' + @MyNumber, 3)
		--' Do we have a hundreds place digit to convert?
		If Left(@MyNumber, 1) <> '0' 
		Begin
			set @Result = dbo.ConvertDigit(Left(@MyNumber, 1)) + ' Hundred '
		End
		
		--' Do we have a tens place digit to convert?
		If SubString(@MyNumber, 2, 1) <> '0' 
		Begin
			set @Result = @Result + dbo.ConvertTens(SubString(@MyNumber, 2,2))
		End
		Else
		Begin
			--' If not, then convert the ones place digit.
			set @Result = @Result +  dbo.ConvertDigit(SubString(@MyNumber, 3,1))
		end
		
	End
	return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertIntoIndianCurEng
-- --------------------------------------------------
/*
Print dbo.ConvertIntoIndianCurEng('500.51')
*/

CREATE Function [dbo].[ConvertIntoIndianCurEng]( @MyNumber varchar(200)) returns varchar(200)
as
Begin
	Declare @Temp varchar(200),
	@Dollars varchar(200), @Cents varchar(100),
	@DecimalPlace int, @Count int , @Return varchar(200)
	
	--' Convert MyNumber to a string, trimming extra spaces.
	set @MyNumber = ltrim(rtrim(@mynumber))
	
	--' Find decimal place.
	set @DecimalPlace = CHARINDEX ('.',@MyNumber)

	set @Cents = ''
	set @Dollars = ''

	--' If we find decimal place...
	If @DecimalPlace > 0 
	Begin
		--' Convert cents
		set @Temp = Left(substring(@MyNumber, @DecimalPlace + 1,2) + '00', 2)
		set @Cents = dbo.ConvertTens(@Temp)
		--' Strip off cents from remainder to convert.
		set @MyNumber = Left(@MyNumber, @DecimalPlace - 1)
	End 

	

	set @Count = 1
	set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 3))


	If @Temp <> '' 
		set @Dollars = @Temp + dbo.Place(@Count) + @Dollars
	
	If Len(@MyNumber) > 3 
		--' Remove last 3 converted digits from MyNumber.
		set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 3)
	Else
		set @MyNumber = ''

	set @Count = @Count + 1

	While @MyNumber <> ''
	Begin
		--' Convert last 2 digits of MyNumber to Indian Rs.
		set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 2))
		If @Temp <> '' 
			set @Dollars = @Temp + dbo.Place(@Count) + @Dollars

		If Len(@MyNumber) > 2 
			--' Remove last 2 converted digits from MyNumber.
			set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 2)
		Else
			set @MyNumber = ''
		set @Count = @Count + 1
	end
	
	--' Clean up Rupees.

	set @Dollars = Case @Dollars
			when '' then 'Zero '
			when 'One' then 'One '
			Else @Dollars + ''
			end 

	
	--' Clean up cents.
	set @Cents  = Case @Cents
			when '' then '' 	--'Cents = " And zero Paise"
			when 'One' then ' And Paisa One '
			Else ' And ' +  'Paise ' + @Cents 
			end 
	

	set @Return =  @Dollars + @Cents + ' Only'
	Return (@Return) 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertTens
-- --------------------------------------------------

/*
Print dbo.ConvertTens(13)
*/
CREATE Function [dbo].[ConvertTens] (@MyTens char(2)) returns varchar(15)
  as 
  Begin
  Declare @Result varchar(15)
  
  -- Is value between 10 and 19?
	If Left(@MyTens, 1) = 1 
	Begin
		set  @Result = Case convert(int,(@MyTens))
		when 10 then 'Ten'
		when 11 then 'Eleven'
		when 12 then 'Twelve'
		when 13 then 'Thirteen'
		when 14 then 'Fourteen'
		when 15 then 'Fifteen'
		when 16 then 'Sixteen'
		when 17 then 'Seventeen'
		when 18 then 'Eighteen'
		when 19 then 'Nineteen'
		Else ''
		end 
	End
	Else
	Begin
		--' .. otherwise it's between 20 and 99.
		set  @Result = Case convert(int,Left(@MyTens, 1))
		when 2 then 'Twenty '
		when 3 then 'Thirty '
		when 4 then 'Forty '
		when 5 then 'Fifty '
		when 6 then 'Sixty '
		when 7 then 'Seventy '
		when 8 then 'Eighty '
		when 9 then 'Ninety '
		Else ''
		end 
		set @Result = @Result + dbo.ConvertDigit(Right(@MyTens, 1))
	End


    -- Convert ones place digit.
    
  Return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_DECRYPT
-- --------------------------------------------------



create FUNCTION [dbo].[FN_DATA_DECRYPT]
(
                                @KEY    VARCHAR(100),
                                @DATA VARBINARY(8000)
) RETURNS VARCHAR(MAX)
AS
BEGIN
DECLARE @DECRYPT_DATA VARCHAR(MAX)

SELECT @DECRYPT_DATA =  DECRYPTBYKEY(@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @DECRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_ENCRYPT
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FN_DATA_ENCRYPT]
(
                                @KEY    VARCHAR(100),
                                @DATA VARCHAR(MAX)
) RETURNS VARBINARY(8000)
AS
BEGIN
DECLARE @ENCRYPT_DATA VARBINARY(8000)

SELECT @ENCRYPT_DATA = ENCRYPTBYKEY(KEY_GUID('Key4CertAutoProcess'),@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @ENCRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnSplitString2Tbl
-- --------------------------------------------------





CREATE FUNCTION [dbo].[fnSplitString2Tbl] (
      @InputString                  VARCHAR(max),
      @Delimiter                    VARCHAR(50)
)

RETURNS @Items TABLE (
      Item                          VARCHAR(max)
)

AS
BEGIN
      IF @Delimiter = ' '
      BEGIN
            SET @Delimiter = ','
            SET @InputString = REPLACE(@InputString, ' ', @Delimiter)
      END

      IF (@Delimiter IS NULL OR @Delimiter = '')
            SET @Delimiter = ','

      DECLARE @Item                 VARCHAR(max)
      DECLARE @ItemList       VARCHAR(8000)
      DECLARE @DelimIndex     INT

      SET @ItemList = @InputString
      SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      WHILE (@DelimIndex != 0)
      BEGIN
            SET @Item = SUBSTRING(@ItemList, 0, @DelimIndex)
            INSERT INTO @Items VALUES (@Item)

            -- Set @ItemList = @ItemList minus one less item
            SET @ItemList = SUBSTRING(@ItemList, @DelimIndex+1, LEN(@ItemList)-@DelimIndex)
            SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      END -- End WHILE

      IF @Item IS NOT NULL -- At least one delimiter was encountered in @InputString
      BEGIN
            SET @Item = @ItemList
            INSERT INTO @Items VALUES (@Item)
      END

      -- No delimiters were encountered in @InputString, so just return @InputString
      ELSE INSERT INTO @Items VALUES (@InputString)

      RETURN

END -- End Function

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_GET_TBLREPORT
-- --------------------------------------------------



CREATE  FUNCTION [dbo].[FUN_GET_TBLREPORT](  
                @OLDSTRING VARCHAR(2000),  
                @NEWSTRING VARCHAR(2000))  
RETURNS  VARCHAR (8000)
AS

  
BEGIN 

    DECLARE @RETURNSTR VARCHAR(8000)
    SET @RETURNSTR =''

    DECLARE @DIFF_STRING  TABLE(  
    [STR1_VALUE] [VARCHAR](100) NOT NULL,  
    [STR2_VALUE] [VARCHAR](100) NOT NULL)  

    DECLARE      
	@REPCODE1 VARCHAR(10),
	@REPCODE2 VARCHAR(10),
	@TBLREPCUR CURSOR ,     
        @CATNAME VARCHAR(20)
  
  
	INSERT INTO @DIFF_STRING
	SELECT 
		STR1= CASE WHEN A.SPLITTED_VALUE IS NOT NULL THEN A.SPLITTED_VALUE ELSE '' END,
		STR2= CASE WHEN B.SPLITTED_VALUE IS NOT NULL THEN B.SPLITTED_VALUE ELSE '' END
	FROM
	(
		SELECT * FROM PRADNYA..FUN_SPLITSTRING(@OLDSTRING,',')
	) A
	 FULL OUTER JOIN
	(
		SELECT * FROM PRADNYA..FUN_SPLITSTRING(@NEWSTRING,',')
	) B
	 ON (A.SPLITTED_VALUE=B.SPLITTED_VALUE)
	WHERE A.SPLITTED_VALUE IS NULL OR B.SPLITTED_VALUE IS NULL
	

	SET @TBLREPCUR = CURSOR FOR  SELECT ISNULL(STR1_VALUE,''),ISNULL(STR2_VALUE,'') FROM  @DIFF_STRING
	OPEN @TBLREPCUR      
	     
	FETCH NEXT FROM @TBLREPCUR INTO @REPCODE1,@REPCODE2
	WHILE @@FETCH_STATUS = 0       
	BEGIN      
	      
	
	 IF @REPCODE1<>''
		BEGIN
			SET @CATNAME = NULL
			SELECT @CATNAME =FLDCATEGORYNAME FROM TBLCATEGORY (NOLOCK) WHERE FLDCATEGORYCODE = CONVERT(INT,@REPCODE1)
			SELECT @RETURNSTR = @RETURNSTR + '-' + ISNULL(@CATNAME,@REPCODE1) +', '
		END
	IF @REPCODE2<>''
		BEGIN
			SET @CATNAME = NULL
			SELECT @CATNAME =FLDCATEGORYNAME FROM TBLCATEGORY (NOLOCK)  WHERE FLDCATEGORYCODE = CONVERT(INT,@REPCODE2)
			SELECT @RETURNSTR = @RETURNSTR + '+' + ISNULL(@CATNAME,@REPCODE2) +', '
		END

	    
	 FETCH NEXT FROM @TBLREPCUR INTO @REPCODE1,@REPCODE2
	END      
	CLOSE @TBLREPCUR      
	DEALLOCATE @TBLREPCUR
     

	RETURN LEFT(@RETURNSTR,LEN(@RETURNSTR)-1)

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------

    
create  FUNCTION [dbo].[FUN_SPLITSTRING](    
                @SPLITSTRING VARCHAR(8000),    
                @DELIMITER   VARCHAR(3))    
RETURNS @SPLITTED TABLE (    
    [SNO] [INT] IDENTITY(1,1) NOT NULL,     
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)    
    
AS    
    
/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */    
BEGIN       
  DECLARE  @STRING         VARCHAR(8000),    
           @POSITION       INT,    
           @START_LOCATION INT,    
           @STRING_LENGTH  INT    
                               
  SET @STRING = @SPLITSTRING    
                    
  SET @POSITION = 0    
                      
  SET @START_LOCATION = 0    
                            
  SET @STRING_LENGTH = LEN(@STRING)    
                           
  WHILE @STRING_LENGTH > 0    
    BEGIN    
        
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)    
                          
      IF @POSITION = 0    
        BEGIN    
          INSERT INTO @SPLITTED    
          SELECT @STRING    
                     
          SET @STRING_LENGTH = 0    
                                   
        END    
      ELSE    
        BEGIN    
          INSERT INTO @SPLITTED    
          SELECT LEFT(@STRING,@POSITION - 1)    
                     
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)    
                            
          SET @STRING_LENGTH = LEN(@STRING)    
        END    
            
    END    
    
  RETURN     
    
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING_2NUM
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FUN_SPLITSTRING_2NUM](
                @SPLITSTRING VARCHAR(8000),
                @DELIMITER   VARCHAR(3))
RETURNS  INT
AS

BEGIN   

  DECLARE @INTRETURN INT
  DECLARE  @STRING         VARCHAR(8000),
           @POSITION       INT,
           @START_LOCATION INT,
           @STRING_LENGTH  INT
                           
  SET @STRING = @SPLITSTRING
                
  SET @POSITION = 0
                  
  SET @START_LOCATION = 0
  SET @INTRETURN = 0                    
  SET @STRING_LENGTH = LEN(@STRING)
                       
  WHILE @STRING_LENGTH > 0
    BEGIN
    
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)
                      
      IF @POSITION = 0
        BEGIN
          SET @INTRETURN = @INTRETURN +  CONVERT(INT,@STRING )                
          SET @STRING_LENGTH = 0
                               
        END
      ELSE
        BEGIN
          SET @INTRETURN = @INTRETURN + CONVERT(INT,LEFT(@STRING,@POSITION - 1))               
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)
                        
          SET @STRING_LENGTH = LEN(@STRING)
        END
        
    END


   RETURN  @INTRETURN
        
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------


create FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Place
-- --------------------------------------------------

CREATE Function [dbo].[Place](@Count as int ) Returns varchar(15)
as 
Begin
	Declare @Return varchar(15)
	set @Return = case @Count
			when 2 then ' Thousand '
			when 3 then ' Lakhs '
			when 4 then ' Crores '
			when 5 then ' Arab '
			else ''
			end
	Return(@Return)
End

GO

-- --------------------------------------------------
-- INDEX dbo.AccBill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[AccBill] ([Sett_No], [Sett_Type], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.AuthorisedSignetory
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXnM] ON [dbo].[AuthorisedSignetory] ([Name])

GO

-- --------------------------------------------------
-- INDEX dbo.bbgfosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [BBGFOMain_Inx] ON [dbo].[bbgfosettlement] ([Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.Bill_Digital_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxtype] ON [dbo].[Bill_Digital_DATA] ([C_SR_NO], [C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Bill_Digital_TEXT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSrNo] ON [dbo].[Bill_Digital_TEXT] ([C_SR_NO], [C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.BillNo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[BillNo] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchBrokTable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBrTbl] ON [dbo].[BranchBrokTable] ([Sr_No], [Branch_Code], [Table_No])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchPayMode
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxBrPmode] ON [dbo].[BranchPayMode] ([Sr_no], [Branch], [CltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Bk] ON [dbo].[broktable] ([Table_No], [Line_No], [Trd_Del], [Val_perc], [Upper_lim])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [broktable_Upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tabnouplim] ON [dbo].[broktable] ([Table_No], [Upper_lim], [Line_No], [Val_perc])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Upperlim] ON [dbo].[broktable] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch], [sett_sales], [round_to])

GO

-- --------------------------------------------------
-- INDEX dbo.Charges_Detail
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Charges_Detail2] ON [dbo].[Charges_Detail] ([CD_Party_Code], [CD_Inst_Type], [CD_Symbol], [CD_Option_Type], [CD_Strike_Price], [CD_AuctionPart], [CD_Sauda_Date], [CD_Expiry_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Charges_Detail
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[Charges_Detail] ([CD_Sauda_Date], [CD_Party_Code], [CD_Inst_Type], [CD_Symbol], [CD_Expiry_Date], [CD_Strike_Price], [CD_Option_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Charges_Detail
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Charges_Detail] ([CD_Party_Code], [CD_Sauda_Date], [CD_Inst_Type], [CD_Symbol], [CD_Expiry_Date], [CD_Option_Type], [CD_Strike_Price])

GO

-- --------------------------------------------------
-- INDEX dbo.Charges_Detail
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVBB] ON [dbo].[Charges_Detail] ([CD_ComputationLevel], [CD_Party_Code], [CD_Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcode] ON [dbo].[client1] ([Cl_Code], [trader], [Family])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[client1] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tclcode] ON [dbo].[client1] ([trader], [Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.client3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcodeparty] ON [dbo].[client3] ([cl_code], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.client4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clparty] ON [dbo].[client4] ([Cl_code], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.client4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clt4] ON [dbo].[client4] ([Party_code], [DefDp], [Depository], [BankID], [Cltdpid])

GO

-- --------------------------------------------------
-- INDEX dbo.client5
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [clcodeidx] ON [dbo].[client5] ([cl_code])

GO

-- --------------------------------------------------
-- INDEX dbo.clientbrok_scheme
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[clientbrok_scheme] ([PARTY_CODE], [From_Date], [To_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.clientsettings
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[clientsettings] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.clientstatus
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSt] ON [dbo].[clientstatus] ([Cl_Status])

GO

-- --------------------------------------------------
-- INDEX dbo.clienttaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyfrom] ON [dbo].[clienttaxes] ([Party_code], [FromDate], [ToDate])

GO

-- --------------------------------------------------
-- INDEX dbo.clienttaxes_new
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[clienttaxes_new] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.clienttype
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[clienttype] ([Cl_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.closing
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxdt] ON [dbo].[closing] ([SysDate], [SCRIP_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.COMPANY_LOGO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTYPE] ON [dbo].[COMPANY_LOGO] ([CL_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.ContGen
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[ContGen] ([Start_Date], [End_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.ContLogin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[ContLogin] ([Sauda_date], [FromParty], [ToParty])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_DATA] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [AUCTIONPART])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_DATA_DET
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_DATA_DET] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [AUCTIONPART])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Digital_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[Contract_Digital_DATA] ([C_SR_NO], [C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Digital_TEXT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSrNo] ON [dbo].[Contract_Digital_TEXT] ([C_SR_NO], [C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_MASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_MASTER] ([TRADE_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Plain_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[Contract_Plain_DATA] ([Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Contract_Rounding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Contract_Rounding] ([CR_Party_Code], [CR_Date_From], [CR_Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.ContractPrint_Setting
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpt] ON [dbo].[ContractPrint_Setting] ([Rpt_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Custodian
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCust] ON [dbo].[Custodian] ([Custodiancode])

GO

-- --------------------------------------------------
-- INDEX dbo.DATA_ARCHIVE_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[DATA_ARCHIVE_LOG] ([SYSTEM_DATE], [CUTOFF_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_CloseOut_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_CloseOut_Temp] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_ClosePos
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDelPos] ON [dbo].[Delivery_ClosePos] ([Trade_Date], [Party_code], [Inst_Type], [Expiry_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_DelCode
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_DelCode] ([RefNo])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Demat_Trans
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Demat_Trans] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.DELIVERY_DEMAT_TRANS_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[DELIVERY_DEMAT_TRANS_TMP] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_DematTransOut
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSettno] ON [dbo].[Delivery_DematTransOut] ([Sett_No], [Sett_Type], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_FoSett
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_FoSett] ([sett_type], [sett_no])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Look_Ahead_Period
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSymbol] ON [dbo].[Delivery_Look_Ahead_Period] ([From_date], [To_date], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Margin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Margin] ([Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Margin_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Margin_Temp] ([Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Market_Type
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxMType] ON [dbo].[Delivery_Market_Type] ([DPType], [MarketType])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Master] ([Company])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_MultiIsIn
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_MultiIsIn] ([Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Obl_CloseOut
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Obl_CloseOut] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Obl_Clt
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Obl_Clt] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Obl_Net
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Obl_Net] ([Sett_Type], [Sett_no])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Obl_Premium_Net
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Obl_Premium_Net] ([Sett_Type], [Sett_no])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Obl_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Obl_Temp] ([Sett_Type], [Sett_no])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Party_Margin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Party_Margin] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_PayOut
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSettNo] ON [dbo].[Delivery_PayOut] ([Sett_No], [Sett_Type], [Party_Code], [Scrip_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Sales_Tax] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStt] ON [dbo].[Delivery_Sales_Tax] ([Sett_Type], [Sett_No], [Symbol], [IsIn])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_BatchNo
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Sales_Tax_BatchNo] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Cl_Address
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Delivery_Sales_Tax_Cl_Address] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Cl_WareHouse
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Delivery_Sales_Tax_Cl_WareHouse] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Clt
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[Delivery_Sales_Tax_Clt] ([Sett_Type], [Sett_No], [Party_Code], [Symbol], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Clt
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Sales_Tax_Clt] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Final
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Sales_Tax_Final] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Final
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStt] ON [dbo].[Delivery_Sales_Tax_Final] ([Sett_Type], [Sett_No], [Party_Code], [Sales_Sett_Type], [Sales_Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sales_Tax_Perc
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[Delivery_Sales_Tax_Perc] ([Date_From], [Date_To], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.DELIVERY_SALESTAX_OBL_CLT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSTAX] ON [dbo].[DELIVERY_SALESTAX_OBL_CLT] ([SETT_TYPE], [SETT_NO], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Sett_Mst
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Sett_Mst] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_SlipFormat
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxProv] ON [dbo].[Delivery_SlipFormat] ([FormatProvider], [FromDp], [ToDp])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_Transaction
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[Delivery_Transaction] ([Sett_type], [Sett_No], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_TransactionTemp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSettno] ON [dbo].[Delivery_TransactionTemp] ([Sett_No], [Sett_type], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Delivery_TransPrintPool
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSettno] ON [dbo].[Delivery_TransPrintPool] ([Sett_No], [Sett_Type], [FromParty], [ToParty], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.DELIVERYDP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDp] ON [dbo].[DELIVERYDP] ([DpType], [DpId])

GO

-- --------------------------------------------------
-- INDEX dbo.DelPartyFlag
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[DelPartyFlag] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.DELPOASHORTAGE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXSETTNO] ON [dbo].[DELPOASHORTAGE] ([SETT_NO], [SETT_TYPE], [SCRIP_CD], [SERIES])

GO

-- --------------------------------------------------
-- INDEX dbo.DELPOATEMP_NEW
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXSETT] ON [dbo].[DELPOATEMP_NEW] ([SETT_NO], [SETT_TYPE], [PARTY_CODE], [SCRIP_CD], [SERIES])

GO

-- --------------------------------------------------
-- INDEX dbo.Digital_File_Name
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSrno] ON [dbo].[Digital_File_Name] ([D_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.EMail_Blank_Check
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFlag] ON [dbo].[EMail_Blank_Check] ([Email_Blank_Flag])

GO

-- --------------------------------------------------
-- INDEX dbo.EMail_Login_User
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[EMail_Login_User] ([EMail_Login_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.EMail_PartyReport
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxPartty] ON [dbo].[EMail_PartyReport] ([EMail_Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.EMail_Report_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[EMail_Report_Log] ([EMail_Report_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.EMail_Report_Settings
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[EMail_Report_Settings] ([email_report_name])

GO

-- --------------------------------------------------
-- INDEX dbo.ErrorLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[ErrorLog] ([ErrDate])

GO

-- --------------------------------------------------
-- INDEX dbo.exalloc_netposition
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[exalloc_netposition] ([party_code], [inst_type], [symbol], [expirydate], [strike_price], [option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FO_POS_DETAILS_DAS] ([FOPDD_SAUDA_DATE], [FOPDD_PARTY_CODE], [FOPDD_INST_TYPE], [FOPDD_SYMBOL], [FOPDD_STRIKE_PRICE], [FOPDD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FO_TRADE_DETAILS_DAS] ([FOTDD_SAUDA_DATE], [FOTDD_PARTY_CODE], [FOTDD_INST_TYPE], [FOTDD_SYMBOL], [FOTDD_STRIKE_PRICE], [FOTDD_OPTION_TYPE], [FOTDD_EXPIRY_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.foaccbill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FoAcc] ON [dbo].[foaccbill] ([BillDate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.foaccbill
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[foaccbill] ([BillDate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.foaccbill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDtParty] ON [dbo].[foaccbill] ([BillDate], [Branchcd], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLNO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[FOBILLNO] ([BILLDATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBillValan
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FOBillValan] ([Sauda_date], [Party_Code], [inst_type], [symbol], [expirydate], [Option_type], [Strike_Price])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBillValan
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOBillValan] ([Sauda_date], [Party_Code], [inst_type], [symbol], [expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBillValan
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FOBillValan] ([Sauda_date], [Party_Code], [inst_type], [symbol], [expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoBillValan_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FoBillValan_Temp] ([Sauda_date], [Party_Code], [inst_type], [symbol], [expirydate], [Option_type], [Strike_Price])

GO

-- --------------------------------------------------
-- INDEX dbo.FoBillValan_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FoBillValan_Temp] ([Sauda_date], [Party_Code], [inst_type], [symbol], [expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoClientBrokScheme
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FoClientBrokScheme] ([Party_Code], [Date_From], [Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.FoClientTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FoClientTaxes] ([Party_Code], [Date_From], [Date_To])

GO

-- --------------------------------------------------
-- INDEX dbo.foclosing
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [trdate] ON [dbo].[foclosing] ([Trade_Date], [Symbol], [Expirydate])

GO

-- --------------------------------------------------
-- INDEX dbo.foclosing_billreport
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IndxFoClBillRpt] ON [dbo].[foclosing_billreport] ([Trade_Date], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.foclosing_billreport
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Set] ON [dbo].[foclosing_billreport] ([Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLOSING_ULPRICE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOCLOSING_ULPRICE] ([TRADE_DATE], [SYMBOL])

GO

-- --------------------------------------------------
-- INDEX dbo.foerrorlog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[foerrorlog] ([ErrDate])

GO

-- --------------------------------------------------
-- INDEX dbo.FOERRTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FOERRTRADE] ([ActivityTime], [Party_Code], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.foexallocsettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[foexallocsettlement] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOexallocTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FOexallocTRADE] ([foeatrd_ActivityTime], [foeatrd_Party_Code], [foeatrd_Inst_Type], [foeatrd_Symbol], [foeatrd_Expirydate], [foeatrd_Strike_price], [foeatrd_Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.foexalloctradehist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[foexalloctradehist] ([foeatrd_ActivityTime], [foeatrd_Party_Code], [foeatrd_Inst_Type], [foeatrd_Symbol], [foeatrd_Expirydate], [foeatrd_Strike_price], [foeatrd_Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.foexpirybackup
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idDt] ON [dbo].[foexpirybackup] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoExpirysettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FoExpirysettlement] ([Sauda_Date], [Party_Code], [Inst_Type], [Symbol], [Expirydate], [Strike_Price])

GO

-- --------------------------------------------------
-- INDEX dbo.FoFinalClosing
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cl] ON [dbo].[FoFinalClosing] ([UnderlyingAsset])

GO

-- --------------------------------------------------
-- INDEX dbo.FoFinalClosing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Dateasset] ON [dbo].[FoFinalClosing] ([ClosingDate], [UnderlyingAsset])

GO

-- --------------------------------------------------
-- INDEX dbo.FoFttrade
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [fofttradei_nx] ON [dbo].[FoFttrade] ([Trade_No], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type], [Price], [Sell_Buy], [Order_No])

GO

-- --------------------------------------------------
-- INDEX dbo.FOFTTRAE_1_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOFTTRAE_1_IMP] ([SAUDA_DATE], [BUY_CLIENT], [SELL_CLIENT], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOGLOBALS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FoGlobals_inx] ON [dbo].[FOGLOBALS] ([exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Exp_Det_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FoMargin_Exp_Det_Log] ([Sauda_Date], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Exp_Details
-- --------------------------------------------------
CREATE CLUSTERED INDEX [udxDt] ON [dbo].[FoMargin_Exp_Details] ([Sauda_Date], [Party_Code], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Exp_Imp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[FoMargin_Exp_Imp] ([SrNo], [Margin_Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Exp_Log
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSymbol] ON [dbo].[FoMargin_Exp_Log] ([Margin_Year], [Margin_Month], [Margin_Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Exp_Perc
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSymbol] ON [dbo].[FoMargin_Exp_Perc] ([Margin_Year], [Margin_Month], [Margin_Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMargin_Span
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[FoMargin_Span] ([Mdate], [Party_Code], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMarginAdd
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxMDate] ON [dbo].[FoMarginAdd] ([Mdate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMarginAdd_Imp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxMDate] ON [dbo].[FoMarginAdd_Imp] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMarginPercent
-- --------------------------------------------------
CREATE CLUSTERED INDEX [isxParty] ON [dbo].[FOMarginPercent] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMg13PenaltyMaster
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxEDt] ON [dbo].[FoMg13PenaltyMaster] ([EffectiveDate])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMg13Reference
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSrno] ON [dbo].[FoMg13Reference] ([RefNo], [SubMenuRefno])

GO

-- --------------------------------------------------
-- INDEX dbo.FoMG13Shortage
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[FoMG13Shortage] ([FileDate], [Party_Code], [Batch_no], [RefNo])

GO

-- --------------------------------------------------
-- INDEX dbo.foowner_BKUP_18MAR24
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [foowne_mem] ON [dbo].[foowner_BKUP_18MAR24] ([membertype])

GO

-- --------------------------------------------------
-- INDEX dbo.FoRms_TBL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxFoRmsTbl] ON [dbo].[FoRms_TBL] ([SrNo], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoRms_TBL_Combine
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxExch] ON [dbo].[FoRms_TBL_Combine] ([Exchange], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSymbol] ON [dbo].[FOSCRIP] ([ContDate], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP_A_GROUP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSCR] ON [dbo].[FOSCRIP_A_GROUP] ([SYMBOL], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IndexFoScrip1] ON [dbo].[FOSCRIP1] ([Inst_Type], [Symbol], [Expirydate])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxFoScrip1] ON [dbo].[FOSCRIP1] ([Inst_Type], [Symbol], [Expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP1_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSymbol] ON [dbo].[FOSCRIP1_IMP] ([Inst_Type], [Symbol], [Expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IndxFoScrip2] ON [dbo].[FOSCRIP2] ([Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [o_datkeyopr_idx] ON [dbo].[FOSCRIP2] ([Maturitydate])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP2_IMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IndxFoScrip2Imp] ON [dbo].[FOSCRIP2_IMP] ([Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP3
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSymbol] ON [dbo].[FOSCRIP3] ([Inst_Type], [Symbol], [Expirydate], [Strike_Price], [Option_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoScripBrokerage
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFoScripBrok] ON [dbo].[FoScripBrokerage] ([Party_Code], [Inst_Type], [Symbol], [From_Date], [To_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.FoScripBrokerage
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FoScripBrokerage] ([From_Date], [To_Date], [Party_Code], [Inst_Type], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.fosett_mst
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFoSettMst] ON [dbo].[fosett_mst] ([Inst_type], [Symbol], [expirydate], [Strike_Price], [Option_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [fosettlement_FoSettlement1] ON [dbo].[fosettlement] ([Status], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type], [AuctionPart], [Price])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FoSettlement1] ON [dbo].[fosettlement] ([Status], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type], [AuctionPart], [Price], [Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[fosettlement] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[fosettlement] ([Sauda_date], [Status], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStm] ON [dbo].[fosettlement] ([Party_Code], [Symbol], [Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVBB] ON [dbo].[fosettlement] ([Party_Code], [Sauda_date], [Status], [Price])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlement
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IndxFoSett] ON [dbo].[fosettlement] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoSettlement_Inst
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSymbol] ON [dbo].[FoSettlement_Inst] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.fosettlementexpiry
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[fosettlementexpiry] ([Sauda_date], [Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price])

GO

-- --------------------------------------------------
-- INDEX dbo.FoSpanMarginNew
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[FoSpanMarginNew] ([Mdate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.fostat_trd
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[fostat_trd] ([sysdate])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[FoTaxes] ([Inst_Type], [From_date], [To_date])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxTax] ON [dbo].[FoTaxes] ([From_date], [To_date], [Symbol])

GO

-- --------------------------------------------------
-- INDEX dbo.fotmclchrg
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Saudadate] ON [dbo].[fotmclchrg] ([Sauda_date], [Party_code], [sell_buy], [orderno], [trade_no])

GO

-- --------------------------------------------------
-- INDEX dbo.foTMinfo
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTm] ON [dbo].[foTMinfo] ([TM_Code], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FOTRADE] ([Party_Code], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PartyCode] ON [dbo].[FOTRADE] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PartySymbol] ON [dbo].[FOTRADE] ([Party_Code], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type], [Sell_Buy])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTradeMissing
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FoTradeMissing] ([ActivityTime], [Party_Code], [Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_BrokTable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [fobrk_inx] ON [dbo].[FoTrd_BrokTable] ([Table_No], [Line_No])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_Client1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ClCode] ON [dbo].[FoTrd_Client1] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_Client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxcl] ON [dbo].[FoTrd_Client2] ([Cl_Code], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_Client2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycode] ON [dbo].[FoTrd_Client2] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_ClientBrokScheme
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[FoTrd_ClientBrokScheme] ([Date_From], [Date_To], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_ClientTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[FoTrd_ClientTaxes] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_ClientTaxes
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[FoTrd_ClientTaxes] ([Date_From], [Date_To], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_FoScrip1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSytmbol] ON [dbo].[FoTrd_FoScrip1] ([Inst_Type], [Symbol], [Expirydate], [Strike_Price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.FoTrd_FoScrip2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Symbol] ON [dbo].[FoTrd_FoScrip2] ([Inst_Type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.IMP_FilePath
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxFl] ON [dbo].[IMP_FilePath] ([File_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Inst_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Inst_Log] ([Sauda_Date], [Party_Code], [New_Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.instclient_tbl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[instclient_tbl] ([PartyCode])

GO

-- --------------------------------------------------
-- INDEX dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[LOG_PWDMAILS] ([UPDATEDATE], [FLDID])

GO

-- --------------------------------------------------
-- INDEX dbo.Login_Exp
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxPr] ON [dbo].[Login_Exp] ([Exp_Period_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.mg13batchno_tbl
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFl] ON [dbo].[mg13batchno_tbl] ([filedate], [batchno])

GO

-- --------------------------------------------------
-- INDEX dbo.MultiCltLog
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idParty] ON [dbo].[MultiCltLog] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.multicompany
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCompany] ON [dbo].[multicompany] ([CompanyName])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTIISIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxScrip] ON [dbo].[MULTIISIN] ([Scrip_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.PartyMapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [indxPartyMap] ON [dbo].[PartyMapping] ([OldParty_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.PRE_OFFERS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ix_party] ON [dbo].[PRE_OFFERS] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.rating
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRt] ON [dbo].[rating] ([Rating])

GO

-- --------------------------------------------------
-- INDEX dbo.Remissor_Master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[Remissor_Master] ([FromDate], [ToDate], [Party_Code], [RemCode])

GO

-- --------------------------------------------------
-- INDEX dbo.Remissor_Trans_Temp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[Remissor_Trans_Temp] ([Sauda_Date], [Party_Code], [RemCode], [Branch_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.roundparam
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRd] ON [dbo].[roundparam] ([RoundStyle])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[Scheme_Mapping] ([SP_Party_Code], [SP_Date_From], [SP_Date_To], [SP_Inst_Type], [SP_Scrip])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxS] ON [dbo].[Scheme_Mapping] ([SP_Brok_ComputeType])

GO

-- --------------------------------------------------
-- INDEX dbo.Scheme_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxScheme] ON [dbo].[Scheme_Master] ([SM_Scheme_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.Schemes
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSc] ON [dbo].[Schemes] ([schemeID])

GO

-- --------------------------------------------------
-- INDEX dbo.Scrip1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Scrip1] ([Co_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.SpanMargin_Imp
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxParty] ON [dbo].[SpanMargin_Imp] ([acct])

GO

-- --------------------------------------------------
-- INDEX dbo.SpanMargin_intraday
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Intradate] ON [dbo].[SpanMargin_intraday] ([acct], [Intradate])

GO

-- --------------------------------------------------
-- INDEX dbo.SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.SQLTableReIndex_Log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxLg] ON [dbo].[SQLTableReIndex_Log] ([UpdatedOn], [TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.STT_CLIENTDETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDXSTT] ON [dbo].[STT_CLIENTDETAIL] ([PARTY_CODE], [RECTYPE], [SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.STT_EXCEPTION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSYMBOL] ON [dbo].[STT_EXCEPTION] ([SYMBOL], [EFFDATE_FROM], [EFFDATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.STT_EXCHG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[STT_EXCHG] ([STT_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.TAXES_SETTING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTAXES] ON [dbo].[TAXES_SETTING] ([TAXES_TYPE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_Charge_Master
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxChrg] ON [dbo].[TBL_Charge_Master] ([Charge_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Party_code] ON [dbo].[TBL_CLIENT_GST_DATA] ([PARTY_CODE], [L_STATE], [EFF_FROM_DATE], [EFF_TO_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[tbl_clientmargin] ([margindate], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partydate] ON [dbo].[tbl_clientmargin] ([party_code], [margindate])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_MTomPremiumBill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxBillRpt] ON [dbo].[Tbl_MTomPremiumBill] ([Party_Code], [Symbol], [Inst_Type], [Expirydate], [Strike_Price], [Option_Type], [Bfdayflag], [Billdate])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_MTomPremiumBill
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[Tbl_MTomPremiumBill] ([Billdate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_MTomPremiumBill
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxMtom] ON [dbo].[Tbl_MTomPremiumBill] ([Billdate], [Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_mtompremiumbill_Report
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[tbl_mtompremiumbill_Report] ([billdate], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_mtompremiumbill_Report
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxTBLMtom] ON [dbo].[tbl_mtompremiumbill_Report] ([billdate], [party_code], [inst_type], [symbol], [expirydate], [option_type], [strike_price])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_mtompremiumbill_Report
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TblMtom] ON [dbo].[tbl_mtompremiumbill_Report] ([billdate], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.tbladmin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[tbladmin] ([fldauto_admin])

GO

-- --------------------------------------------------
-- INDEX dbo.TblAdminconfig
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TblAdminconfig] ([Fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.tblcategory
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [categoryidx] ON [dbo].[tblcategory] ([fldcategorycode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblcatmenu
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[tblcatmenu] ([fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXREP] ON [dbo].[TBLCATMENU_LOG] ([Fldreportcode], [Fldadminauto], [CREATED_ON])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_sno] ON [dbo].[TBLCLASSUSERLOGINS] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXLOGIN] ON [dbo].[TBLCLASSUSERLOGINS] ([FLDUSERNAME], [FLDSESSION], [FLDIPADDRESS])

GO

-- --------------------------------------------------
-- INDEX dbo.tblmenuhead
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxMenu] ON [dbo].[tblmenuhead] ([fldmenucode])

GO

-- --------------------------------------------------
-- INDEX dbo.tblPradnyausers
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblPradnyausers] ([fldauto], [fldadminauto])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [AutoIDx] ON [dbo].[tblUserControlMaster] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [UserIdidx] ON [dbo].[tblUserControlMaster] ([FLDUSERID])

GO

-- --------------------------------------------------
-- INDEX dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[tblUserControlMaster_Jrnl] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[V2_BUSINESS_PROCESS] ([BUSINESS_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_Contract_Digital_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IN_CONTRACT] ON [dbo].[V2_Contract_Digital_DATA] ([C_SR_NO])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[V2_LOGIN_ERR_LOG] ([LOGIN_DT])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.client2
-- --------------------------------------------------
ALTER TABLE [dbo].[client2] ADD CONSTRAINT [PK_client2_1] PRIMARY KEY ([Party_code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Delivery_PartyFlag
-- --------------------------------------------------
ALTER TABLE [dbo].[Delivery_PartyFlag] ADD CONSTRAINT [Pk_Delpartyflag] PRIMARY KEY ([Party_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.foclosing_billreport
-- --------------------------------------------------
ALTER TABLE [dbo].[foclosing_billreport] ADD CONSTRAINT [PK_foclosing_billreport] PRIMARY KEY ([Expirydate], [Trade_Date], [Symbol])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FOGLOBALS
-- --------------------------------------------------
ALTER TABLE [dbo].[FOGLOBALS] ADD CONSTRAINT [PK_FOGLOBALS] PRIMARY KEY ([year], [exchange], [year_start_dt], [year_end_dt])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.foowner_BKUP_18MAR24
-- --------------------------------------------------
ALTER TABLE [dbo].[foowner_BKUP_18MAR24] ADD CONSTRAINT [PK_foowner] PRIMARY KEY ([Company])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FoScripBrokerage
-- --------------------------------------------------
ALTER TABLE [dbo].[FoScripBrokerage] ADD CONSTRAINT [PK_FoscripBrokerage] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagr__C2B05B61D4A9854D] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_Charge_Detail
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_Charge_Detail] ADD CONSTRAINT [PK_TBL_Charge_Detail] PRIMARY KEY ([Party_Code], [Charge_Code], [Line_No], [FromDate], [ToDate])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_CHARGES_DATA
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_CHARGES_DATA] ADD CONSTRAINT [PK_TBL_CHARGES_DATA] PRIMARY KEY ([SAUDA_DATE], [PARTY_CODE], [CHARGE_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_GST_LOCATION
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_GST_LOCATION] ADD CONSTRAINT [PK_TBL_GST_LOCATION] PRIMARY KEY ([LOC_CODE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Rule_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Rule_Master] ADD CONSTRAINT [PK_Tbl_Rule_Master] PRIMARY KEY ([Rule_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblUserControlMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tblUserControlMaster] ADD CONSTRAINT [PK_TBLUSERCONTROLMASTER] PRIMARY KEY ([FLDUSERID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
ALTER TABLE [dbo].[TBLUSERPASSHIST] ADD CONSTRAINT [PK_TBLUSERPASSHIST] PRIMARY KEY ([FLDAUTO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.V2_grandsub
-- --------------------------------------------------
ALTER TABLE [dbo].[V2_grandsub] ADD CONSTRAINT [PK_V2_grandsub] PRIMARY KEY ([sno])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_client_proc_share_client_insert
-- --------------------------------------------------
--sp_help client5
--alter table client5 add director_Name varchar(100)

create   Proc Add_client_proc_share_client_insert As      
Insert Into Client1      
 Select      
  Tmppartycode,left(tmpshortname,21),tmplongname,tmpaddr1,tmpaddr2,tmpcity,tmpstate,      
  L_nation='',tmpzip,      
  Tmpfax,      
  Tmptelnor,      
  Res_phone2='',      
  Tmptelnoo,      
  Off_phone2='',      
  Tmpemail,      
  Tmpbranchcode,credit_limit='0',tmpclienttype,tmpclientstatus,gl_code='',fd_code='',      
  Tmpfamilycode,penalty='0',tmpsubbrokercode,confirm_fax='0',phoneold='',tmpaddr3,      
  Tmpcellno,      
  Tmppanno,tmptradercode, '', Tmpregion, Tmparea, '' From Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Cl_code From Client1)      
      
Insert Into Client2      
 Select      
  Tmppartycode,exchange='nse',tmptranscat,scrip_cat=0,tmppartycode,tmptrdtableno,tmpdeltableno,margin='0',      
  Turnover_tax='1',sebi_turn_tax='1',insurance_chrg='1',tmpservicetax,std_rate='0',p_to_p='0',exposure_lim='0',      
  Tmpdeltableno,bankid='',cltdpno='',printf=tmpprint,albmdelchrg='0',albmdelivery='0',albmcf_tableno='0',      
  Mf_tableno='0',sb_tableno='0',brok1_tableno='0',brok2_tableno='0',brok3_tableno='0',brokernote='1',      
  Other_chrg='1',brok_scheme=tmpbrokscheme,contcharge='0',mincontamt='0',addledgerbal='0',      
  Dummy1='',dummy2='',inscont='n',sertaxmethod='0',dummy6='',dummy7='',dummy8='',dummy9='',dummy10=tmpgroupcode      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Client2)      
      
Insert Into Pobank (bank_name,branch_name)      
 Select      
  Tmpbankname,tmpbranchname From Msajag.dbo.tmp_client_details      
 Where      
  Tmpbankname Not In (select Bank_name From Pobank Where Branch_name = Tmpbranchname)      
      
Insert Into Client4      
 Select      
  Tmppartycode,tmppartycode,'0',tmpdpid,tmpclientdpid,tmpdepository,tmpdefaultdp      
  From      
   Msajag.dbo.tmp_client_details      
  Where      
   Tmppartycode Not In (select Party_code From Client4 Where Tmppartycode = Party_code And Tmpdpid = Bankid And Tmpclientdpid = Cltdpid)      
      
Insert Into Client4      
 Select      
  Tmppartycode,tmppartycode,'1',bankid,tmpacno,tmpactype,'0'      
 From      
  Msajag.dbo.tmp_client_details, (select Bankid=min(bankid),bank_name, Branch_name From Pobank       
 Group By      
  Bank_name, Branch_name ) A      
 Where      
  Bank_name = Tmpbankname And Branch_name = Tmpbranchname      
      
Insert Into Client5      
 Select      
  Tmppartycode,tmpdob,tmpsex,      
  Activefrom = Convert(varchar, Getdate(), 106),      
  Interactmode='0',      
  Repatriatac='1',repatriatbank='0',repatriatacno='',introducer='',tmpapprover,kycform='0',bankcert='0',      
  Passport=(case When Tmppassportno<>'' Then 1 Else 0 End),tmppassportno,      
  Votersid=(case When Tmpvoteridno <>'' Then 1 Else 0 End),      
  Tmpvoteridno,      
  Itreturn='0',itreturndtl='',      
  Drivelicen=(case When Tmplicenceno<>'' Then 1 Else 0 End),tmplicenceno,      
  Rationcard=(case When Tmprationcardno<>'' Then 1 Else 0 End),tmprationcardno,      
  Corpdtlrecd='0',corpdeed='0',anualreport='0',networthcert='0',inactivefrom=convert(varchar,tmpinactivefrom,106),      
  P_address1='',p_address2='',p_address3='',p_city='',p_state='',p_nation='',p_phone='',p_zip='',addemailid='',      
  Tmppassportissuedon,tmppassportissuedat,      
  Tmpvoteridissuedon,      
  Tmpvoteridissuedat,      
  Itreturndateoffiling='',tmplicenceissuedon,tmplicenceissuedat,tmprationcardissuedon,tmprationcardissuedat ,      
  Client_agre_dt='',tmpregnno,regr_place='',tmpdateofinc,regr_auth='',introd_client_id='',introd_relation='',      
  Any_other_acc='',sett_mode='0',dealing_with_othrer_tm='',systumdate=getdate(),      
  Tmppassportexpireson,      
  Tmplicenceexpireson ,Director_Name=''  
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Cl_code From Client5)      
      
Insert Into Clienttaxes_new      
 Select      
  /*exchange*/ 'nse',       
  /*scidentity*/ '1',       
  /*party_code*/ Tmppartycode,       
  /*cl_type*/ Tmpclienttype,       
  /*trans_cat*/ 'trd',       
  /*insurance_chrg*/ 0.015,       
  /*turnover_tax*/ Tmptransactionchargestrd,     
  /*other_chrg*/ 0,       
  /*sebiturn_tax*/ 0,       
  /*broker_note*/ Tmpstampdutytrd,       
  /*demat_insure*/ 0,       
  /*service_tax*/ Tmpservicetax,       
  /*tax1*/ 0,       
  /*tax2*/ 0,       
  /*tax3*/ 0,       
  /*tax4*/ 0,       
  /*tax5*/ 0,       
  /*tax6*/ 0,       
  /*tax7*/ 0,       
  /*tax8*/ 0,       
  /*tax9*/ 0,       
  /*tax10*/ 0,       
  /*latest*/ 1,       
  /*state*/ 1,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/,       
  Tmproundtodigit,       
  Tmproundtopaisa,      
  Tmperrnum,       
  Tmpnozero       
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster)      
      
Insert Into Clienttaxes_new      
 Select      
  /*exchange*/ 'nse',       
  /*scidentity*/ '1',       
  /*party_code*/ Tmppartycode,       
  /*cl_type*/ Tmpclienttype,       
  /*trans_cat*/ 'del',       
  /*insurance_chrg*/ 0.075,       
  /*turnover_tax*/ Tmptransactionchargesdel,       
  /*other_chrg*/ 0,       
  /*sebiturn_tax*/ 0,       
  /*broker_note*/ Tmpstampdutydel,       
  /*demat_insure*/ 0,       
  /*service_tax*/ Tmpservicetax,       
  /*tax1*/ 0,       
  /*tax2*/ 0,       
  /*tax3*/ 0,       
  /*tax4*/ 0,       
  /*tax5*/ 0,       
  /*tax6*/ 0,       
  /*tax7*/ 0,       
  /*tax8*/ 0,       
  /*tax9*/ 0,       
  /*tax10*/ 0,       
  /*latest*/ 1,       
  /*state*/ 1,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/,       
  Tmproundtodigit,       
  Tmproundtopaisa,      
  Tmperrnum,       
  Tmpnozero      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster)      
      
Insert Into Clientbrok_scheme      
 Select      
  /*party_code*/ Tmppartycode,       
  /*table_no*/ Tmptrdtableno,       
  /*scheme_type*/'trd',       
  /*scrip_cd*/'all',       
  /*trade_type*/'nrm',       
  /*brokscheme*/tmpbrokscheme,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster) And      
  Tmpclienttype <> 'ins'      
      
Insert Into Clientbrok_scheme      
 Select      
  /*party_code*/ Tmppartycode,       
  /*table_no*/ Tmpdeltableno,       
  /*scheme_type*/'del',       
  /*scrip_cd*/'all',       
  /*trade_type*/'nrm',       
  /*brokscheme*/tmpbrokscheme,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster) And      
  Tmpclienttype <> 'ins'      
      
Insert Into Clientbrok_scheme      
 Select      
  /*party_code*/ Tmppartycode,       
  /*table_no*/ Tmptrdtableno,       
  /*scheme_type*/'trd',       
  /*scrip_cd*/'all',       
  /*trade_type*/'ins',       
  /*brokscheme*/tmpbrokscheme,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster) And      
  Tmpclienttype = 'ins'      
      
Insert Into Clientbrok_scheme      
 Select      
  /*party_code*/ Tmppartycode,       
  /*table_no*/ Tmpdeltableno,       
  /*scheme_type*/'del',       
  /*scrip_cd*/'all',       
  /*trade_type*/'ins',       
  /*brokscheme*/tmpbrokscheme,       
  /*fromdate*/ Left(convert(varchar, Dateadd(day, -30, Getdate()), 109), 11) /*+ ' 00:00:00'*/ ,       
  /*todate*/ 'dec 31 2049' /*+ ' 23:59:59'*/      
 From      
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.clientmaster) And      
  Tmpclienttype = 'ins'      
      
Insert Into Multicltid      
 Select      
  Tmppartycode,tmpclientdpid,tmpdpid,tmplongname,tmpdepository, Tmppoa      
 From      
  Msajag.dbo.tmp_client_details       
 Where      
  Tmppartycode Not In (select Party_code From Multicltid M Where Tmppartycode = Party_code And Tmpdpid = Dpid And Tmpclientdpid = Cltdpno)      
      
Insert Into Multicltid      
 Select      
  Tmppartycode,tmpclientdpid,tmpdpid,tmplongname,tmpdepository, Tmppoa      
 From      
  Msajag.dbo.tmp_client_details_multiclientdpid       
 Where      
  Tmppartycode Not In (select Party_code From Multicltid M Where Tmppartycode = Party_code And Tmpdpid = Dpid And Tmpclientdpid = Cltdpno)      
      
Insert Into Delpartyflag      
 Select      
  Tmppartycode, Tmpdebitbalance, Tmpintersettlement      
 From       
  Msajag.dbo.tmp_client_details      
 Where      
  Tmppartycode Not In (select Party_code From Msajag.dbo.delpartyflag)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Share_Proc_Insert
-- --------------------------------------------------



CREATE  Proc [dbo].[Add_Client_Share_Proc_Insert] (
@Exchange Varchar(3), 
@Segment Varchar(7), 
@Branch_Cd Varchar(10), 
@FromParty Varchar(10),
@ToParty Varchar(10),
@MainDate Varchar(30),
@DetDate Varchar(30)
) As

--Update Owner Set MemberCode = MemberCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Share_Proc_Update
-- --------------------------------------------------

CREATE PROC [dbo].[Add_Client_Share_Proc_Update] (          
@EXCHANGE VARCHAR(3),           
@SEGMENT VARCHAR(7),           
@BRANCH_CD VARCHAR(10),           
@FROMPARTY VARCHAR(10),          
@TOPARTY VARCHAR(10),          
@MAINDATE VARCHAR(30),          
@DETDATE VARCHAR(30)  

) WITH RECOMPILE AS          
/* 
ALtered under SRE-28702
STATUS = 'U', IMP_STATUS = '0' -- FOR FRESH INSERT          
IF IMP_STATUS = '0' THEN --DON'T UPDATE STATUS FEILD          
ELSE --UPDATE STATUS FEILD AS 'U'AND IMP_STATUS AS '0'          
*/          
          
TRUNCATE TABLE CLIENT_DETAILS_TMP          
TRUNCATE TABLE CLIENT_BROK_DETAILS_TMP          
    /*      
INSERT INTO CLIENT_DETAILS_TMP          
SELECT C.*           
       FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C With(Nolock), ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D  With(Nolock)         
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE          
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')           
       AND C.BRANCH_CD LIKE @BRANCH_CD          
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY           
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE          
          
INSERT INTO CLIENT_BROK_DETAILS_TMP          
SELECT D.*           
       FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C With(Nolock), ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D     With(Nolock)      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE          
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')           
       AND C.BRANCH_CD LIKE @BRANCH_CD          
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY           
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE       */
 
	   SELECT C.CL_CODE ,C.MODIFIDEDON,D.MODIFIEDON AS B_MOD  INTO #CLT_ADD_D                        
       FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH(NOLOCK), ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D      WITH(NOLOCK)                  
       WHERE                 
        C.CL_CODE = D.CL_CODE   AND D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT                                
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')                        
		--AND C.BRANCH_CD LIKE @BRANCH_CD                        
       AND C.CL_CODE BETWEEN @FROMPARTY AND @TOPARTY                        
       --AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE
	   
	   
	   SELECT C.CL_CODE INTO #CLT_ADD                        
       FROM #CLT_ADD_D   C  WITH(NOLOCK)                  
       WHERE C.CL_CODE BETWEEN @FROMPARTY AND @TOPARTY                        
       AND C.MODIFIDEDON <= @MAINDATE AND  B_MOD <= @DETDATE

	   CREATE INDEX #CL ON #CLT_ADD(CL_CODE)  
/*
	    SELECT D.CL_CODE ,D.MODIFIEDON  INTO #CL_BROK                  
       FROM  ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D      WITH(NOLOCK)                  
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT                          
       AND   D.IMP_STATUS = '0'                     
	   AND D.CL_CODE BETWEEN @FROMPARTY AND @TOPARTY  
	   
	    CREATE INDEX #CL ON #CL_BROK(CL_CODE)

	   SELECT C.CL_CODE ,C.MODIFIDEDON  INTO #CL_DETAIL           
       FROM  ANAND1.MSAJAG.DBO.CLIENT_DETAILS C      WITH(NOLOCK)                  
       WHERE C.IMP_STATUS = '0'                     
	   AND C.CL_CODE BETWEEN @FROMPARTY AND @TOPARTY   AND EXISTS (SELECT CL_CODE FROM  #CL_BROK B WHERE C.CL_CODE=B.CL_CODE)

	   SELECT DISTINCT C.CL_CODE INTO #CLT_ADD                        
       FROM #CL_DETAIL   C  WITH(NOLOCK) ,#CL_BROK B                 
       WHERE C.CL_CODE BETWEEN @FROMPARTY AND @TOPARTY   AND C.CL_CODE=B.CL_CODE                     
       AND C.MODIFIDEDON <= @MAINDATE AND  B.MODIFIEDON <= @DETDATE 


	   CREATE INDEX #CL ON #CLT_ADD(CL_CODE) */



		INSERT INTO CLIENT_DETAILS_TMP                        
		SELECT C.*                        
			   FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS C WITH(NOLOCK)
			   INNER JOIN  #CLT_ADD D      WITH(NOLOCK)                  
			   ON C.CL_CODE = D.CL_CODE                        
              

	INSERT INTO CLIENT_BROK_DETAILS_TMP                        
	SELECT D.*                        
		   FROM #CLT_ADD C WITH(NOLOCK)
		   INNER JOIN  ANAND1.MSAJAG.DBO.CLIENT_BROK_DETAILS D   WITH(NOLOCK)     ON C.CL_CODE = D.CL_CODE               
		   WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT     	   
	      
          
DELETE FROM CLIENT1 WHERE CL_CODE IN ( SELECT C.CL_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE)          
          
/* CLIENT1 INSERT QUERY */          
INSERT INTO CLIENT1          
SELECT C.CL_CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,FAX,RES_PHONE1,          
RES_PHONE2,OFF_PHONE1,OFF_PHONE2,EMAIL,BRANCH_CD,CREDIT_LIMIT,CL_TYPE,CL_STATUS,GL_CODE='',FD_CODE='',FAMILY,          
PENALTY=0,SUB_BROKER,CONFIRM_FAX=0,PHONEOLD='',L_ADDRESS3,MOBILE_PAGER,PAN_GIR_NO,TRADER,WARD_NO,REGION,AREA,CLRATING=''          
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE           
          
DELETE FROM CLIENT2 WHERE PARTY_CODE IN ( SELECT PARTY_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE )          
          
/* CLIENT2 INSERT QUERY */          
INSERT INTO CLIENT2          
SELECT C.CL_CODE,D.EXCHANGE,TRAN_CAT='TRD',SCRIP_CAT=0,PARTY_CODE=C.CL_CODE,TRD_BROK,DEL_BROK,MARGIN=0,          
TURNOVER_TAX=FUT_TRAN_CHRGS,          
SEBI_TURN_TAX=FUT_SEBI_FEES,          
--INSURANCE_CHRG=FUT_STT,    
INSURANCE_CHRG=1,---CHANGES FOR CTT        
SER_TAX,STD_RATE=FUT_BROK,P_TO_P=0,          
EXPOSURE_LIM=0,DEMAT_TABLENO=DEL_BROK,BANKID=PARTICIPANT_CODE,CLTDPNO=CUSTODIAN_CODE,PRINTF=PRINT_OPTIONS,          
ALBMDELCHRG=0,ALBMDELIVERY=0,ALBMCF_TABLENO=0,MF_TABLENO=DEL_BROK,SB_TABLENO=0,          
BROK1_TABLENO=FUT_FUT_FIN_BROK,BROK2_TABLENO=FUT_OPT_BROK,BROK3_TABLENO=0,          
BROKERNOTE=FUT_STAMP_DUTY,          
OTHER_CHRG=FUT_OTHER_CHRGS,          
D.BROK_SCHEME,CONTCHARGE=0,MINCONTAMT=0,ADDLEDGERBAL=0,DUMMY1=FUT_BROK_APPLICABLE,          
DUMMY2=FUT_OPT_BROK,INSCONT=(CASE WHEN INST_CONTRACT = '' OR INST_CONTRACT IS NULL THEN 'N' ELSE INST_CONTRACT END),  
SERTAXMETHOD=SER_TAX_METHOD,DUMMY6=STP_PROVIDER,          
DUMMY7=STP_RP_STYLE,DUMMY8=REL_MGR,DUMMY9=C_GROUP,DUMMY10=SBU, PARENTCODE, PRODUCTCODE    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE           
          
DELETE FROM CLIENT3 WHERE PARTY_CODE IN ( SELECT PARTY_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE)          
          
/* CLIENT3 INSERT QUERY */          
INSERT INTO CLIENT3          
SELECT C.CL_CODE,C.PARTY_CODE,EXCHANGE,MARKETTYPE=SEGMENT,MARGIN=0,NOOFTIMES=MULTIPLIER,MARGIN_RECD=CHARGED,MTOM=0,          
PMARGINRATE=0,MTOMDATE=GETDATE(),INITIALMARGIN=0,MAINENANCETMARGIN=MAINTENANCE,MARGINEXCHANGE=REQD_BY_EXCH,MARGINBROKER=0,          
DUMMY1=0,DUMMY2=0          
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE           
        
          
INSERT INTO CLIENT4          
SELECT C.CL_CODE,PARTY_CODE,INSTRU=0,BANKID=DPID1,CLTDPID1,DEPOSITORY1,DEF=1           
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE           
AND DPID1 <> '' AND CLTDPID1 <> ''           
AND DEPOSITORY1 IN ('NSDL', 'CDSL')           
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY IN ('NSDL', 'CDSL') )          
          
 Insert Into MultiCltId            
Select Party_code, CltDpId1, DpId1, Long_Name, Depository1, 
DEF=(CASE WHEN POA1 = 0 THEN 0
	  WHEN POA1 = 1 THEN 1
		  WHEN POA1 = 2 THEN 1
		  WHEN POA1 = 3 THEN 1
		  WHEN POA1 = 4 THEN 1
		  ELSE 0 END),
DDPIFLAG=(CASE WHEN POA1 = 0 THEN 'N'
		  WHEN POA1 = 1 THEN 'O'
		  WHEN POA1 = 2 THEN 'Y'
		  WHEN POA1 = 3 THEN 'B'
		  WHEN POA1 = 4 THEN 'N'
		  ELSE 'N' END)
		              
From Client_Details_Tmp C, Client_Brok_Details_Tmp D            
Where D.Exchange = @Exchange And D.Segment = @Segment              
And C.Cl_Code = D.Cl_Code             
And DpId1 <> '' And CltDpId1 <> ''             
And Depository1 In ('NSDL', 'CDSL')            
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId1 And CltDpNo = CltDpId1)            
            
/* MultiCltId Insert Query */            
Insert Into MultiCltId            
Select Party_code, CltDpId2, DpId2, Long_Name, Depository2, 
DEF=(CASE WHEN POA2 = 0 THEN 0
		  WHEN POA2 = 1 THEN 1
		  WHEN POA2 = 2 THEN 1
		  WHEN POA2 = 3 THEN 1
		  WHEN POA2 = 4 THEN 1
		  ELSE 0 END),

DDPIFLAG=(CASE WHEN POA2 = 0 THEN 'N'
		  WHEN POA2 = 1 THEN 'O'
		  WHEN POA2 = 2 THEN 'Y'
		  WHEN POA2 = 3 THEN 'B'
		  WHEN POA2 = 4 THEN 'N'
		  ELSE 'N' END)                
From Client_Details_Tmp C, Client_Brok_Details_Tmp D            
Where D.Exchange = @Exchange And D.Segment = @Segment              
And C.Cl_Code = D.Cl_Code             
And DpId2 <> '' And CltDpId2 <> ''            
And Depository2 In ('NSDL', 'CDSL')            
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId2 And CltDpNo = CltDpId2)            
            
/* MultiCltId Insert Query */            
Insert Into MultiCltId            
Select Party_code, CltDpId3, DpId3, Long_Name, Depository3, 
DEF=(CASE WHEN POA3 = 0 THEN 0
		  WHEN POA3 = 1 THEN 1
		  WHEN POA3 = 2 THEN 1
		  WHEN POA3 = 3 THEN 1
		  WHEN POA3 = 4 THEN 1
		  ELSE 0 END),

DDPIFLAG=(CASE WHEN POA3 = 0 THEN 'N'
		  WHEN POA3 = 1 THEN 'O'
		  WHEN POA3 = 2 THEN 'Y'
		  WHEN POA3 = 3 THEN 'B'
		  WHEN POA3 = 4 THEN 'N'
		  ELSE 'N' END)            
From Client_Details_Tmp C, Client_Brok_Details_Tmp D            
Where D.Exchange = @Exchange And D.Segment = @Segment              
And C.Cl_Code = D.Cl_Code             
And DpId3 <> '' And CltDpId3 <> ''            
And Depository3 In ('NSDL', 'CDSL')            
And C.Party_Code Not In (Select Party_Code From MultiCltId Where DpId = DpId3 And CltDpNo = CltDpId3)            
                      
DELETE FROM CLIENT4 WHERE CL_CODE IN ( SELECT C.CL_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE )          
       AND DEPOSITORY NOT IN ('NSDL', 'CDSL')          
          
INSERT INTO POBANK (BANK_NAME,BRANCH_NAME)          
SELECT DISTINCT BANK_NAME, BRANCH_NAME = LEFT(BRANCH_NAME,40)           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE          
       AND BANK_NAME NOT IN (SELECT BANK_NAME FROM POBANK WHERE POBANK.BANK_NAME = C.BANK_NAME AND POBANK.BRANCH_NAME = C.BRANCH_NAME )          
          
/* CLIENT4 INSERT QUERY */ 
/*
INSERT INTO CLIENT4          
SELECT C.CL_CODE,PARTY_CODE,INSTRU=1,BANKID=MAX(P.BANKID),CLTDPID=AC_NUM,          
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'           
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'           
                        ELSE 'OTHER' END), 'OTHER'),          
DEF=0       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, POBANK P          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE          
AND AC_TYPE <> ''          
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY NOT IN ('CDSL','NSDL'))          
AND P.BANK_NAME = C.BANK_NAME AND P.BRANCH_NAME = C.BRANCH_NAME     
GROUP BY C.CL_CODE,PARTY_CODE,AC_NUM,AC_TYPE--  ADD BY SURESH TO ADD DISTICNT RECORDS FROM POBANK  MAX(P.BANKID)      */

SELECT C.Cl_code,Party_code,Instru=1,BankID=P.BankID,CltDpId=AC_Num,              
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'               
                        When Ac_Type = 'C' Then 'CURRENT'               
                        Else 'OTHER' End), 'OTHER'),              
DEF=0              INTO #Client4_Tmp
From Client_Details_Tmp C (NOLOCK) , Client_Brok_Details_Tmp D (NOLOCK) , POBank P (NOLOCK)          
Where D.Exchange = @Exchange And D.Segment = @Segment                
And C.Cl_Code = D.Cl_Code              
And Ac_Type <> ''              
And Not Exists (Select Party_Code From Client4 T (NOLOCK) Where Depository Not In ('CDSL','NSDL') And T.Party_code =C.Party_Code)              
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name   

Insert Into Client4  
Select * from #Client4_Tmp

Drop table #Client4_Tmp



           
DELETE FROM CLIENT5 WHERE CL_CODE IN ( SELECT C.CL_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT           
       AND C.CL_CODE = D.CL_CODE)          
          
/* CLIENT5 INSERT QUERY */          
INSERT INTO CLIENT5          
SELECT C.CL_CODE,BIRTHDATE=DOB,SEX,ACTIVEFROM=ACTIVE_DATE,INTERACTMODE,          
REPATRIATAC=(CASE WHEN LEN(REPATRIAT_BANK) = 0 THEN 1 ELSE 0 END),          
REPATRIATBANK=REPATRIAT_BANK,REPATRIATACNO=REPATRIAT_BANK_AC_NO,          
INTRODUCER,APPROVER,KYCFORM=CHK_KYC_FORM,BANKCERT=CHK_BANK_CERTIFICATE,          
PASSPORT=(CASE WHEN PASSPORT_NO <> '' THEN 1 ELSE 0 END), PASSPORTDTL=PASSPORT_NO,          
VOTERSID=(CASE WHEN VOTERSID_NO <> '' THEN 1 ELSE 0 END), VOTERSIDDTL = VOTERSID_NO,          
ITRETURN=(CASE WHEN IT_RETURN_YR <> '' THEN 1 ELSE 0 END), ITRETURNDTL=IT_RETURN_YR,          
DRIVELICEN=(CASE WHEN LICENCE_NO <> '' THEN 1 ELSE 0 END), DRIVELICENDTL = LICENCE_NO,          
RATIONCARD=(CASE WHEN RAT_CARD_NO <> '' THEN 1 ELSE 0 END), RATIONCARDDTL = RAT_CARD_NO,          
CORPDTLRECD=CHK_CORPORATE_DEED,CORPDEED=CHK_CORP_DTLS_RECD,          
ANUALREPORT=CHK_ANNUAL_REPORT,NETWORTHCERT=CHK_NETWORTH_CERT,INACTIVEFROM=INACTIVE_FROM,          
P_ADDRESS1,P_ADDRESS2,P_ADDRESS3,P_CITY,P_STATE,P_NATION,P_PHONE,P_ZIP,ADDEMAILID,          
PASSPORTDATEOFISSUE=PASSPORT_ISSUED_ON,PASSPORTPLACEOFISSUE=PASSPORT_ISSUED_AT,          
VOTERIDDATEOFISSUE=VOTERSID_ISSUED_ON,VOTERIDPLACEOFISSUE=VOTERSID_ISSUED_AT,          
ITRETURNDATEOFFILING=IT_RETURN_FILED_ON,LICENCENODATEOFISSUE=LICENCE_ISSUED_ON,          
LICENCENOPLACEOFISSUE=LICENCE_ISSUED_AT,RATIONCARDDATEOFISSUE=RAT_CARD_ISSUED_ON,          
RATIONCARDPLACEOFISSUE=RAT_CARD_ISSUED_AT,CLIENT_AGRE_DT=CLIENT_AGREEMENT_ON,REGR_NO=REGR_NO,          
REGR_PLACE=REGR_AT,REGR_DATE=REGR_ON,REGR_AUTH=REGR_AUTHORITY,INTROD_CLIENT_ID=INTRODUCER_ID,          
INTROD_RELATION=INTRODUCER_RELATION,          
ANY_OTHER_ACC=OTHER_AC_NO,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(DEALING_WITH_OTHER_TM,''),          
SYSTUMDATE=SYSTEMDATE,PASSPORTEXPDATE=PASSPORT_EXPIRES_ON,DRIVEEXPDATE=LICENCE_EXPIRES_ON/*,DIRECTOR_NAME     */      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE          
          
DELETE FROM INSTCLIENT_TBL WHERE PARTYCODE IN ( SELECT PARTY_CODE           
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
       AND C.CL_CODE = D.CL_CODE )          
          
/* INSTCLIENT_TBL INSERT QUERY */          
INSERT INTO INSTCLIENT_TBL          
SELECT PARTY_CODE, ROUNDMARKETRATE, ROUNDBROKERAGE, ROUNDNETRATE, NO_OF_COPIES, RES1 = 0, RES2 = 0, RES3 = 0, RES4 = 0          
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, ROUNDPARAM R          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT            
AND C.CL_CODE = D.CL_CODE           
AND D.ROUND_STYLE = R.ROUNDSTYLE          
          
IF @SEGMENT = 'CAPITAL'      
BEGIN    
  
 UPDATE CLIENTBROK_SCHEME SET TO_DATE = BROK_EFF_DATE - 1          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
   WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
   AND C.CL_CODE = D.CL_CODE           
   AND C.PARTY_CODE = CLIENTBROK_SCHEME.PARTY_CODE          
   AND TO_DATE LIKE 'DEC 31 2049%'          
           
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD NORMAL */          
 INSERT INTO CLIENTBROK_SCHEME          
 SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',           
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
           
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL NORMAL */          
 INSERT INTO CLIENTBROK_SCHEME          
 SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',           
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
           
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD INS */          
 INSERT INTO CLIENTBROK_SCHEME          
 SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',           
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
           
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL INS */          
 INSERT INTO CLIENTBROK_SCHEME          
 SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',           
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
           
 UPDATE CLIENTTAXES_NEW SET TODATE = TRD_EFF_DT - 1           
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
   WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
   AND C.CL_CODE = D.CL_CODE           
   AND C.PARTY_CODE = CLIENTTAXES_NEW.PARTY_CODE          
   AND CLIENTTAXES_NEW.TODATE LIKE 'DEC 31 2049%'          
             
 /* CLIENTTAXES_NEW INSERT QUERY FOR TRD */          
 INSERT INTO CLIENTTAXES_NEW          
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'TRD', INSURANCE_CHRG = TRD_STT,          
 TURNOVER_TAX = TRD_TRAN_CHRGS, OTHER_CHRG = TRD_OTHER_CHRGS, SEBITURN_TAX = TRD_SEBI_FEES,           
 BROKER_NOTE = TRD_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,           
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(TRD_EFF_DT,11),          
 TODATE = 'DEC 31 2049 23:59:59',           
 ROUND_TO = 4, ROFIG = ROUND_TO_PAISE,           
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'           
       THEN 0.5          
       WHEN ROUNDING_METHOD = 'NEXT'          
       THEN (CASE WHEN ROUND_TO_PAISE = 1           
         THEN -0.01          
         ELSE -0.1          
       END)                         
   WHEN ROUNDING_METHOD = 'PREVIOUS'           
       THEN (CASE WHEN ROUND_TO_PAISE = 1           
         THEN 0.01          
         ELSE 0.1          
       END)                         
   WHEN ROUNDING_METHOD = 'BANKER'           
       THEN (CASE WHEN ROUND_TO_PAISE = 5          
         THEN -2.5          
         ELSE 2.5          
       END)                         
     END ),           
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
           
 /* CLIENTTAXES_NEW INSERT QUERY FOR DEL */          
 INSERT INTO CLIENTTAXES_NEW          
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'DEL', INSURANCE_CHRG = DEL_STT,          
 TURNOVER_TAX = DEL_TRAN_CHRGS, OTHER_CHRG = DEL_OTHER_CHRGS, SEBITURN_TAX = DEL_SEBI_FEES,           
 BROKER_NOTE = DEL_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,           
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(DEL_EFF_DT,11),           
 TODATE = 'DEC 31 2049 23:59:59',           
 ROUND_TO = 4, ROFIG = ROUND_TO_PAISE,           
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'           
       THEN 0.5          
       WHEN ROUNDING_METHOD = 'NEXT'          
       THEN (CASE WHEN ROUND_TO_PAISE = 1           
         THEN -0.01          
         ELSE -0.1          
       END)                         
   WHEN ROUNDING_METHOD = 'PREVIOUS'           
       THEN (CASE WHEN ROUND_TO_PAISE = 1           
         THEN 0.01          
         ELSE 0.1          
       END)                         
   WHEN ROUNDING_METHOD = 'BANKER'           
       THEN (CASE WHEN ROUND_TO_PAISE = 5          
         THEN -2.5          
         ELSE 2.5          
       END)                         
     END ),           
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)          
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
 AND C.CL_CODE = D.CL_CODE          
END  
  
DELETE FROM UCC_CLIENT          
WHERE PARTY_CODE IN ( SELECT PARTY_CODE           
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
      AND C.CL_CODE = D.CL_CODE)           
          
INSERT INTO UCC_CLIENT          
SELECT PARTY_CODE, LONG_NAME, CONTRACT_PERSON = INTRODUCER, CLEARINGNO1 = '', CLEARINGNO2 = '', CLEARINGNO3 = '',          
CLEARINGNO4 = '', MAPIDID = MAPIN_ID, FMCODE = ISNULL(C.FMCODE,''), DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = OTHER_AC_NO,           
FAMILY_CODE1 = '', FAMILY_CODE2 = '', FAMILY_CODE3 = '', FAMILY_CODE4 = '', REMARK = '', UCC_CODE,           
STPPROVIDER = '', DUMMY1 = '', DUMMY2 = ''          
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE      
      
DELETE FROM DELPARTYFLAG         
WHERE PARTY_CODE IN ( SELECT PARTY_CODE           
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
      AND C.CL_CODE = D.CL_CODE)           
      
INSERT INTO DELPARTYFLAG      
SELECT PARTY_CODE, DEBIT_BALANCE, INTER_SETT      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D          
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE      
  
IF @SEGMENT = 'FUTURES'      
BEGIN    
  
 UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT  
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE      
 AND DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTBROKSCHEME      
 SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',  
 FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK,   
 FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,  
 COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME,   
 OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0  
           THEN 'PRICE'   
       WHEN FUT_BROK_APPLICABLE = 1  
       THEN 'SPRICE'     
           ELSE 'SSPRICE'   
          END)  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 UPDATE FOCLIENTTAXES SET DATE_TO = TRD_EFF_DT - 1       
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE      
 AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTTAXES      
 SELECT PARTY_CODE, DATE_FROM = LEFT(TRD_EFF_DT,11), DATE_TO = 'DEC 31 2049 23:59',  
 FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS,   
 FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,       
 FUT_BROKER_NOTE = TRD_STAMP_DUTY,  
 OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS,   
 OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,       
 OPT_BROKER_NOTE = DEL_STAMP_DUTY,  
 ROUND_TO = 4, ROFIG = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 0 ELSE ROUND_TO_PAISE END),       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1  
                           THEN 0.000001   
                           ELSE 0.000001    
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)        
           END ),       
 NOZERO = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 1   
      ELSE 0 END)  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO  
 DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO      
      
 END  
 
 /*Commented due to closure of Rounding off effective from 15/10/2024

INSERT INTO CONTRACT_ROUNDING  
SELECT PARTY_CODE, MINCONTRACTAMOUNT = 30, MAXCONTRACTAMT = -1,  
CR_DATE_FROM = LEFT(GETDATE(), 11), CR_DATE_TO = 'DEC 31 2049 23:59:59',   
CR_CREATEDBY = 'SYSTEM', CR_CREATEDON = GETDATE(), CR_MODIFIEDBY = '',  
CR_MODIFIEDON = ''  
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D  
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT   
AND C.CL_CODE = D.CL_CODE  
AND C.CL_CODE NOT IN (SELECT CR_PARTY_CODE FROM CONTRACT_ROUNDING)  
AND C.CL_TYPE NOT IN ( 'INS', 'AGS','NRI')   */

-------------------------GST ADDITION

UPDATE TBL_CLIENT_GST_DATA SET EFF_TO_DATE = LEFT(GETDATE()-1,11) + ' 23:59:59'
FROM CLIENT_DETAILS_TMP
WHERE TBL_CLIENT_GST_DATA.PARTY_CODE = CLIENT_DETAILS_TMP.CL_CODE
AND EFF_TO_DATE >= LEFT(GETDATE(),11)

DELETE FROM TBL_CLIENT_GST_DATA
WHERE EFF_FROM_DATE > EFF_TO_DATE

INSERT INTO TBL_CLIENT_GST_DATA 
SELECT PARTY_CODE, BRANCH_CD, SUB_BROKER, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE, L_ZIP, L_NATION, GST_NO, GST_LOCATION,
EFF_FROM_DATE = LEFT(GETDATE(),11), EFF_TO_DATE = 'DEC 31 2049 23:59:59', CREATED_ON = GETDATE()
FROM CLIENT_DETAILS_TMP

--------------------------END GST
  exec VBB_DailyMapping

 /*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Add_Client_Share_Proc_Update_BKUP_17Mar2024
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.ADD_CLIENT_SHARE_PROC_UPDATE    SCRIPT DATE: 01/18/2006 12:58:59 ******/    
CREATE PROC [dbo].[Add_Client_Share_Proc_Update] (      
@EXCHANGE VARCHAR(3),       
@SEGMENT VARCHAR(7),       
@BRANCH_CD VARCHAR(10),       
@FROMPARTY VARCHAR(10),      
@TOPARTY VARCHAR(10),      
@MAINDATE VARCHAR(30),      
@DETDATE VARCHAR(30)      
) AS      
/*      
STATUS = 'U', IMP_STATUS = '0' -- FOR FRESH INSERT      
IF IMP_STATUS = '0' THEN --DON'T UPDATE STATUS FEILD      
ELSE --UPDATE STATUS FEILD AS 'U'AND IMP_STATUS AS '0'      
*/      
      
TRUNCATE TABLE CLIENT_DETAILS_TMP      
TRUNCATE TABLE CLIENT_BROK_DETAILS_TMP      
TRUNCATE TABLE CLIENT_PARTY_MODIFICATION_TMP  
  
INSERT INTO CLIENT_DETAILS_TMP      
SELECT C.*       
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')  
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'      
       AND C.BRANCH_CD LIKE @BRANCH_CD      
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY       
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE      
      
INSERT INTO CLIENT_BROK_DETAILS_TMP      
SELECT D.*       
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')   
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'      
       AND C.BRANCH_CD LIKE @BRANCH_CD      
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY       
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE      
  
INSERT INTO CLIENT_PARTY_MODIFICATION_TMP  
SELECT OLD_PARTY_CODE,NEW_PARTY_CODE,BRANCH_CD,SUB_BROKER,TRADER,FAMILY,AREA,REGION,STATUS,  
ADDEDBY,ADDEDON,UPDATEDON  
FROM MSAJAG.DBO.CLIENT_PARTY_MODIFICATION  
WHERE STATUS = 0  
  
DELETE FROM CLIENT1 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT1 INSERT QUERY */      
INSERT INTO CLIENT1      
SELECT C.CL_CODE,LEFT(SHORT_NAME,21),LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,FAX,RES_PHONE1,      
RES_PHONE2,OFF_PHONE1,OFF_PHONE2,EMAIL,BRANCH_CD,CREDIT_LIMIT,CL_TYPE,CL_STATUS,GL_CODE=PAYLOCATION,FD_CODE=SEBI_REGN_NO,FAMILY,      
PENALTY=0,SUB_BROKER,CONFIRM_FAX=0,PHONEOLD='',L_ADDRESS3,MOBILE_PAGER,PAN_GIR_NO,TRADER,WARD_NO,REGION,AREA,CLRATING=CLIENT_RATING     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
      
DELETE FROM CLIENT2 WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
      
/* CLIENT2 INSERT QUERY */      
INSERT INTO CLIENT2      
SELECT C.CL_CODE,D.EXCHANGE,TRAN_CAT='TRD',SCRIP_CAT=0,PARTY_CODE=C.CL_CODE,TRD_BROK,DEL_BROK,MARGIN=0,      
TURNOVER_TAX=FUT_TRAN_CHRGS,      
SEBI_TURN_TAX=FUT_SEBI_FEES,      
INSURANCE_CHRG=FUT_STT,      
SER_TAX,STD_RATE=FUT_BROK,P_TO_P=0,      
EXPOSURE_LIM=0,DEMAT_TABLENO=DEL_BROK,BANKID=PARTICIPANT_CODE,CLTDPNO=CUSTODIAN_CODE,PRINTF=PRINT_OPTIONS,      
ALBMDELCHRG=0,ALBMDELIVERY=0,ALBMCF_TABLENO=0,MF_TABLENO=DEL_BROK,SB_TABLENO=0,      
BROK1_TABLENO=FUT_FUT_FIN_BROK,BROK2_TABLENO=FUT_OPT_BROK,BROK3_TABLENO=0,      
BROKERNOTE=FUT_STAMP_DUTY,      
OTHER_CHRG=FUT_OTHER_CHRGS,      
D.BROK_SCHEME,CONTCHARGE=0,MINCONTAMT=0,ADDLEDGERBAL=0,DUMMY1=FUT_BROK_APPLICABLE,      
DUMMY2=FUT_OPT_EXC,INSCONT=(CASE WHEN INST_CONTRACT = '' OR INST_CONTRACT IS NULL THEN 'N' ELSE INST_CONTRACT END),SERTAXMETHOD=SER_TAX_METHOD,DUMMY6=STP_PROVIDER,      
DUMMY7=STP_RP_STYLE,DUMMY8=REL_MGR,DUMMY9=SBU,DUMMY10=C_GROUP, PARENTCODE, PRODUCTCODE  
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
      
DELETE FROM CLIENT3 WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT3 INSERT QUERY */      
INSERT INTO CLIENT3      
SELECT C.CL_CODE,C.PARTY_CODE,EXCHANGE,MARKETTYPE=SEGMENT,MARGIN=0,NOOFTIMES=0,MARGIN_RECD=CHARGED,MTOM=0,      
PMARGINRATE=MULTIPLIER,MTOMDATE=GETDATE(),INITIALMARGIN=CHARGED,MAINENANCETMARGIN=MAINTENANCE,MARGINEXCHANGE=REQD_BY_EXCH,MARGINBROKER=0,      
DUMMY1=0,DUMMY2=0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE  
      
INSERT INTO CLIENT4      
SELECT C.CL_CODE,PARTY_CODE,INSTRU=0,BANKID=DPID1,CLTDPID1,DEPOSITORY1,DEF=1       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID1 <> '' AND CLTDPID1 <> ''       
AND DEPOSITORY1 IN ('NSDL', 'CDSL')       
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY IN ('NSDL', 'CDSL') )      

/*      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID1, DPID1, LONG_NAME, DEPOSITORY1, POA1       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID1 <> '' AND CLTDPID1 <> ''       
AND DEPOSITORY1 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID1 AND CLTDPNO = CLTDPID1)      
      
/* MULTICLTID INSERT QUERY */      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID2, DPID2, LONG_NAME, DEPOSITORY2, POA2       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID2 <> '' AND CLTDPID2 <> ''      
AND DEPOSITORY2 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID2 AND CLTDPNO = CLTDPID2)      
      
/* MULTICLTID INSERT QUERY */      
INSERT INTO MULTICLTID      
SELECT PARTY_CODE, CLTDPID3, DPID3, LONG_NAME, DEPOSITORY3, POA3       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND DPID3 <> '' AND CLTDPID3 <> ''      
AND DEPOSITORY3 IN ('NSDL', 'CDSL')      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID3 AND CLTDPNO = CLTDPID3)      
*/


Insert Into MultiCltId      
Select Party_code, CltDpId1, DpId1, Long_Name, Depository1, 
DEF=(CASE WHEN POA1 = 0 THEN 0
		  WHEN POA1 = 1 THEN 1
		  WHEN POA1 = 2 THEN 1
		  WHEN POA1 = 3 THEN 1
		  WHEN POA1 = 4 THEN 1
		  ELSE 0 END),
--POA1_DATE,
--PoaType='',
DDPIFLAG=(CASE WHEN POA1 = 0 THEN 'N'
		  WHEN POA1 = 1 THEN 'O'
		  WHEN POA1 = 2 THEN 'Y'
		  WHEN POA1 = 3 THEN 'B'
		  WHEN POA1 = 4 THEN 'N'
		  ELSE 'N' END)
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId1 <> '' And CltDpId1 <> ''       
And Depository1 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId)      
      
/* MultiCltId Insert Query */      
Insert Into MultiCltId      
Select Party_code, CltDpId2, DpId2, Long_Name, Depository2, 
DEF=(CASE WHEN POA2 = 0 THEN 0
		  WHEN POA2 = 1 THEN 1
		  WHEN POA2 = 2 THEN 1
		  WHEN POA2 = 3 THEN 1
		  WHEN POA2 = 4 THEN 1
		  ELSE 0 END),
--POA2_DATE,
--PoaType='',
DDPIFLAG=(CASE WHEN POA2 = 0 THEN 'N'
		  WHEN POA2 = 1 THEN 'O'
		  WHEN POA2 = 2 THEN 'Y'
		  WHEN POA2 = 3 THEN 'B'
		  WHEN POA2 = 4 THEN 'N'
		  ELSE 'N' END)     
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId2 <> '' And CltDpId2 <> ''      
And Depository2 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId)      
      
/* MultiCltId Insert Query */      
Insert Into MultiCltId      
Select Party_code, CltDpId3, DpId3, Long_Name, Depository3 ,
DEF=(CASE WHEN POA3 = 0 THEN 0
		  WHEN POA3 = 1 THEN 1
		  WHEN POA3 = 2 THEN 1
		  WHEN POA3 = 3 THEN 1
		  WHEN POA3 = 4 THEN 1
		  ELSE 0 END),
--POA3_DATE,
--PoaType='',
DDPIFLAG=(CASE WHEN POA3 = 0 THEN 'N'
		  WHEN POA3 = 1 THEN 'O'
		  WHEN POA3 = 2 THEN 'Y'
		  WHEN POA3 = 3 THEN 'B'
		  WHEN POA3 = 4 THEN 'N'
		  ELSE 'N' END)
From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code       
And DpId3 <> '' And CltDpId3 <> ''      
And Depository3 In ('NSDL', 'CDSL')      
And C.Party_Code Not In (Select Party_Code From MultiCltId)  
   
      
DELETE FROM CLIENT4 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
       AND DEPOSITORY NOT IN ('NSDL', 'CDSL')      
/*      
INSERT INTO POBANK (BANK_NAME,BRANCH_NAME)      
SELECT DISTINCT BANK_NAME, BRANCH_NAME       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE      
       AND BANK_NAME NOT IN (SELECT BANK_NAME FROM POBANK WHERE POBANK.BANK_NAME = C.BANK_NAME AND POBANK.BRANCH_NAME = C.BRANCH_NAME )      
*/      
/* CLIENT4 INSERT QUERY    
INSERT INTO CLIENT4      
SELECT C.CL_CODE,PARTY_CODE,INSTRU=1,BANKID=P.BANKID,CLTDPID=AC_NUM,      
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'       
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'       
                        ELSE 'OTHER' END), 'OTHER'),      
DEF=0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, POBANK P      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE     
AND AC_TYPE <> ''      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY NOT IN ('CDSL','NSDL'))      
AND P.BANK_NAME = C.BANK_NAME AND P.BRANCH_NAME = C.BRANCH_NAME      
--And P.MICRNO = C.Micr_No  
--And P.IFSCCODE = C.Bank_id   
and P.Bankid>55014   
*/


/*
Insert into POBank (Bank_Name,Branch_Name,IFSCCODE,MICRNO)      
Select Distinct Bank_Name, Branch_Name,Bank_id,MICR_NO      
       From Client_Details_Tmp C, Client_Brok_Details_Tmp D      
       Where D.Exchange = @Exchange And D.Segment = @Segment        
       And C.Cl_Code = D.Cl_Code
       And Bank_Name not in (Select Bank_Name From POBank 
							Where POBank.Bank_Name = C.Bank_Name 
							And POBank.Branch_Name = C.Branch_Name	
							And POBank.MICRNO = C.Micr_No
							And POBank.IFSCCODE = C.Bank_id						 
							)      

*/
      
/* Client4 Insert Query */      
Insert Into Client4      
SELECT C.Cl_code,Party_code,Instru=1,BankID=P.BankID,CltDpId=AC_Num,      
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'       
                        When Ac_Type = 'C' Then 'CURRENT'       
                        Else 'OTHER' End), 'OTHER'),      
DEF=0      
From Client_Details_Tmp C, Client_Brok_Details_Tmp D, POBank P      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code      
And Ac_Type <> ''      
And C.Party_Code Not In (Select Party_Code From Client4 Where Depository Not In ('CDSL','NSDL'))      
And P.Bank_Name = C.Bank_Name 
And P.Branch_Name = C.Branch_Name 
And P.MICRNO = C.Micr_No
And P.IFSCCODE = C.Bank_id

       
DELETE FROM CLIENT5 WHERE CL_CODE IN ( SELECT C.CL_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE)      
      
/* CLIENT5 INSERT QUERY */      
INSERT INTO CLIENT5      
SELECT C.CL_CODE,BIRTHDATE=DOB,SEX,ACTIVEFROM=ACTIVE_DATE,INTERACTMODE,      
REPATRIATAC=(CASE WHEN LEN(REPATRIAT_BANK) = 0 THEN 1 ELSE 0 END),      
REPATRIATBANK=REPATRIAT_BANK,REPATRIATACNO=REPATRIAT_BANK_AC_NO,      
INTRODUCER,APPROVER,KYCFORM=CHK_KYC_FORM,BANKCERT=CHK_BANK_CERTIFICATE,      
PASSPORT=(CASE WHEN PASSPORT_NO <> '' THEN 1 ELSE 0 END), PASSPORTDTL=PASSPORT_NO,      
VOTERSID=(CASE WHEN VOTERSID_NO <> '' THEN 1 ELSE 0 END), VOTERSIDDTL = VOTERSID_NO,      
ITRETURN=(CASE WHEN IT_RETURN_YR <> '' THEN 1 ELSE 0 END), ITRETURNDTL=IT_RETURN_YR,      
DRIVELICEN=(CASE WHEN LICENCE_NO <> '' THEN 1 ELSE 0 END), DRIVELICENDTL = LICENCE_NO,      
RATIONCARD=(CASE WHEN RAT_CARD_NO <> '' THEN 1 ELSE 0 END), RATIONCARDDTL = RAT_CARD_NO,      
CORPDTLRECD=CHK_CORPORATE_DEED,CORPDEED=CHK_CORP_DTLS_RECD,      
ANUALREPORT=CHK_ANNUAL_REPORT,NETWORTHCERT=CHK_NETWORTH_CERT,INACTIVEFROM=INACTIVE_FROM,      
P_ADDRESS1,P_ADDRESS2,P_ADDRESS3,P_CITY,P_STATE,P_NATION,P_PHONE,P_ZIP,ADDEMAILID,      
PASSPORTDATEOFISSUE=PASSPORT_ISSUED_ON,PASSPORTPLACEOFISSUE=PASSPORT_ISSUED_AT,      
VOTERIDDATEOFISSUE=VOTERSID_ISSUED_ON,VOTERIDPLACEOFISSUE=VOTERSID_ISSUED_AT,      
ITRETURNDATEOFFILING=IT_RETURN_FILED_ON,LICENCENODATEOFISSUE=LICENCE_ISSUED_ON,      
LICENCENOPLACEOFISSUE=LICENCE_ISSUED_AT,RATIONCARDDATEOFISSUE=RAT_CARD_ISSUED_ON,      
RATIONCARDPLACEOFISSUE=RAT_CARD_ISSUED_AT,CLIENT_AGRE_DT=CLIENT_AGREEMENT_ON,REGR_NO=REGR_NO,      
REGR_PLACE=REGR_AT,REGR_DATE=REGR_ON,REGR_AUTH=REGR_AUTHORITY,INTROD_CLIENT_ID=INTRODUCER_ID,      
INTROD_RELATION=INTRODUCER_RELATION,      
ANY_OTHER_ACC=OTHER_AC_NO,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(DEALING_WITH_OTHER_TM,''),      
SYSTUMDATE=SYSTEMDATE,PASSPORTEXPDATE=PASSPORT_EXPIRES_ON,DRIVEEXPDATE=LICENCE_EXPIRES_ON,DIRECTOR_NAME       
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE      
      
DELETE FROM INSTCLIENT_TBL WHERE PARTYCODE IN ( SELECT PARTY_CODE       
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE )      
      
/* INSTCLIENT_TBL INSERT QUERY */      
INSERT INTO INSTCLIENT_TBL      
SELECT PARTY_CODE, ROUNDMARKETRATE, ROUNDBROKERAGE, ROUNDNETRATE, NO_OF_COPIES, RES1 = 0, RES2 = 0, RES3 = 0, RES4 = 0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, ROUNDPARAM R      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE       
AND D.ROUND_STYLE = R.ROUNDSTYLE      
  
IF @SEGMENT = 'CAPITAL' OR @SEGMENT = 'SLBS'   
BEGIN  
 UPDATE CLIENTBROK_SCHEME SET TO_DATE = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE       
      AND C.PARTY_CODE = CLIENTBROK_SCHEME.PARTY_CODE      
      AND TO_DATE LIKE 'DEC 31 2049%'      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD NORMAL */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL NORMAL */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR TRD INS */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = INST_TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTBROK_SCHEME INSERT QUERY FOR DEL INS */      
 INSERT INTO CLIENTBROK_SCHEME      
 SELECT PARTY_CODE, TABLE_NO = INST_DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',       
 TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 UPDATE CLIENTTAXES_NEW SET TODATE = TRD_EFF_DT - 1       
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE       
      AND C.PARTY_CODE = CLIENTTAXES_NEW.PARTY_CODE      
      AND CLIENTTAXES_NEW.TODATE LIKE 'DEC 31 2049%'      
         
 /* CLIENTTAXES_NEW INSERT QUERY FOR TRD */      
 INSERT INTO CLIENTTAXES_NEW      
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'TRD', INSURANCE_CHRG = TRD_STT,      
 TURNOVER_TAX = TRD_TRAN_CHRGS, OTHER_CHRG = TRD_OTHER_CHRGS, SEBITURN_TAX = TRD_SEBI_FEES,       
 BROKER_NOTE = TRD_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,       
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(TRD_EFF_DT,11),      
 TODATE = 'DEC 31 2049 23:59',       
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1  
                           THEN 0.000001     
                           ELSE 0.000001  
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE      
       
 /* CLIENTTAXES_NEW INSERT QUERY FOR DEL */      
 INSERT INTO CLIENTTAXES_NEW      
 SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'DEL', INSURANCE_CHRG = DEL_STT,      
 TURNOVER_TAX = DEL_TRAN_CHRGS, OTHER_CHRG = DEL_OTHER_CHRGS, SEBITURN_TAX = DEL_SEBI_FEES,       
 BROKER_NOTE = DEL_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,       
 TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(DEL_EFF_DT,11),       
 TODATE = 'DEC 31 2049 23:59',       
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN 0.000001      
                           ELSE 0.000001      
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE   
  
 DELETE FROM CLIENTTAXES_NEW WHERE FROMDATE > TODATE  
 DELETE FROM CLIENTBROK_SCHEME WHERE FROM_DATE > TO_DATE  
  
END  
  
IF @SEGMENT = 'FUTURES'  
BEGIN  
 UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT  
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE      
 AND DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTBROKSCHEME      
 SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',  
 FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK,   
 FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,  
 COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME,   
 OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0  
           THEN 'PRICE'   
       WHEN FUT_BROK_APPLICABLE = 1  
       THEN 'SPRICE'     
           ELSE 'SSPRICE'   
          END)  
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 UPDATE FOCLIENTTAXES SET DATE_TO = TRD_EFF_DT - 1       
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE       
 AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE      
 AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'  
  
 INSERT INTO FOCLIENTTAXES      
 SELECT PARTY_CODE, DATE_FROM = LEFT(TRD_EFF_DT,11), DATE_TO = 'DEC 31 2049 23:59',  
 FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS,   
 FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,       
 FUT_BROKER_NOTE = TRD_STAMP_DUTY,  
 OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS,   
 OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,       
 OPT_BROKER_NOTE = DEL_STAMP_DUTY,  
 ROUND_TO = ROUND_TO_DIGIT, ROFIG = ROUND_TO_PAISE,       
 ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'       
                THEN 0.5      
                WHEN ROUNDING_METHOD = 'NEXT'      
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1       
                           THEN -0.01      
                           ELSE -0.1      
                      END)                     
         WHEN ROUNDING_METHOD = 'PREVIOUS'       
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1  
                           THEN 0.000001   
                           ELSE 0.000001    
                      END)                     
         WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'  
                THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5      
                           THEN -2.5      
                           ELSE 2.5      
                      END)                     
           END ),       
 NOZERO = (CASE WHEN ROUND_TO_PAISE <> 0 THEN 0 ELSE 1 END)      
 FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
 WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
 AND C.CL_CODE = D.CL_CODE  
  
 DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO  
 DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO  
  
END  
  
IF @SEGMENT = 'SLBS'  
BEGIN  
 UPDATE CLIENT_DETAILS_TMP SET UCC_CODE = ISNULL(U.UCC_CODE, '')   
 FROM UCC_CLIENT U  
 WHERE U.PARTY_CODE = CLIENT_DETAILS_TMP.PARTY_CODE  
END  
  
DELETE FROM UCC_CLIENT      
WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE)       
      
INSERT INTO UCC_CLIENT      
SELECT PARTY_CODE, LONG_NAME, CONTRACT_PERSON = INTRODUCER, CLEARINGNO1 = '', CLEARINGNO2 = '', CLEARINGNO3 = '',      
CLEARINGNO4 = '', MAPIDID = MAPIN_ID, FMCODE = FMCODE, DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = OTHER_AC_NO,       
FAMILY_CODE1 = '', FAMILY_CODE2 = '', FAMILY_CODE3 = '', FAMILY_CODE4 = '', REMARK = '', UCC_CODE,       
STPPROVIDER = '', DUMMY1 = '', DUMMY2 = ''      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE  
  
DELETE FROM DELPARTYFLAG     
WHERE PARTY_CODE IN ( SELECT PARTY_CODE       
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
      AND C.CL_CODE = D.CL_CODE)       
  
INSERT INTO DELPARTYFLAG  
SELECT PARTY_CODE, DEBIT_BALANCE, INTER_SETT  
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE  
  
DELETE FROM CLIENT4 WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)  
AND DEPOSITORY IN ('NSDL', 'CDSL')  
  
DELETE FROM MULTICLTID WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)  


UPDATE TBL_CLIENT_GST_DATA SET EFF_TO_DATE = LEFT(GETDATE()-1,11) + ' 23:59:59'
FROM CLIENT_DETAILS_TMP
WHERE TBL_CLIENT_GST_DATA.PARTY_CODE = CLIENT_DETAILS_TMP.CL_CODE
AND EFF_TO_DATE >= LEFT(GETDATE(),11)

DELETE FROM TBL_CLIENT_GST_DATA
WHERE EFF_FROM_DATE > EFF_TO_DATE

INSERT INTO TBL_CLIENT_GST_DATA 
SELECT PARTY_CODE, BRANCH_CD, SUB_BROKER, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE, L_ZIP, L_NATION, GST_NO, GST_LOCATION,
EFF_FROM_DATE = LEFT(GETDATE(),11), EFF_TO_DATE = 'DEC 31 2049 23:59:59', CREATED_ON = GETDATE()
FROM CLIENT_DETAILS_TMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_DELUSER
-- --------------------------------------------------
CREATE PROC [dbo].[ADMIN_DELUSER]
(
	@FLDAUTO VARCHAR(500),
	@ADMIN_NAME VARCHAR(50),
	@IPADD VARCHAR(20)
)

AS
/*
ADMIN_DELUSER '19,10,11,13','BROKER_CHECKER','10.11.12.74' 
SELECT * FROM TBLUSERCONTROLMASTER_JRNL
SELECT * FROM TBLPRADNYAUSERS_LOG WHERE FLDUSERNAME  ='testBhrt'

ROLLBACK
*/
CREATE TABLE #TEMPID
(
	ID INT
)

DECLARE 
	@LOOPID INT,
	@LOOPDATA VARCHAR(300),
	@GLOBALDATE DATETIME,
	@ADMINID INT

SET @GLOBALDATE = GETDATE()
SELECT  @ADMINID = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @ADMIN_NAME

BEGIN TRAN
	SET @LOOPID = 1
	WHILE 1 = 1
	 BEGIN
		SET @LOOPDATA = .DBO.PIECE(@FLDAUTO,',',@LOOPID)

		IF @LOOPDATA = '' OR @LOOPDATA IS NULL
		 BEGIN
			BREAK
		 END
			
		INSERT INTO #TEMPID(ID) VALUES(@LOOPDATA)
		SET @LOOPID = @LOOPID + 1 
	 END	
select * from #TEMPID
	INSERT INTO TBLPRADNYAUSERS_LOG 
		(FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		EDIT_FLAG,
		CREATED_BY,
		CREATED_ON,
		MACHINEIP,
		FLDLOG_DATA)
	SELECT 
		FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		'D',
		@ADMIN_NAME,
		@GLOBALDATE,
		@IPADD,
		'DELETEENTRY' 
	FROM 
		TBLPRADNYAUSERS, #TEMPID
	WHERE 
		FLDAUTO = ID

	INSERT INTO TBLUSERCONTROLMASTER_JRNL
		(FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		FLDUPDTBY,
		FLDUPDTDT)
	SELECT 
		FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		@ADMINID,
		@GLOBALDATE 
	FROM 
		TBLUSERCONTROLMASTER TBC, #TEMPID
	WHERE 
		FLDUSERID = ID
	
	DELETE 
		TB
	FROM 
		TBLPRADNYAUSERS TB,  #TEMPID 
	WHERE 
		FLDAUTO = ID
COMMIT

DROP TABLE #TEMPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_GET_CATEGORIES
-- --------------------------------------------------
CREATE PROC [dbo].[ADMIN_GET_CATEGORIES]
(
	@FLDADMINAUTO INT
)
AS
/*
ADMIN_GET_CATEGORIES 26
SELECT * FROM TBLADMIN
SELECT * FROM TBLCATEGORY
DROP PROC  GET_CATEGORIES
*/

SELECT 
	FLDAUTO_ADMIN, FLDSTATUS 
INTO 
	#TEMP
FROM 
	TBLADMIN 
WHERE FLDSTATUS = (SELECT FLDSTATUS FROM TBLADMIN WHERE FLDAUTO_ADMIN = @FLDADMINAUTO)

--SELECT * FROM #TEMP

SELECT * FROM TBLCATEGORY, #TEMP WHERE FLDAUTO_ADMIN = FLDADMINAUTO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTO_BULK_MARGINUPLOAD_INTRADAY
-- --------------------------------------------------



 
CREATE PROC [dbo].[AUTO_BULK_MARGINUPLOAD_INTRADAY]  
(
	@FILENAME VARCHAR(100)='',
	@MARGINDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT NSEFO MARGINUPLOAD_INTRADAY FILE
*/ 
DECLARE @STRSQL VARCHAR(MAX),
@RECCNT	INT,
@FILECOUNTER INT

SET @FILECOUNTER = LEFT(RIGHT(@FILENAME,6),2)

 
SELECT MDATE,PARTY_CODE,SPAN_MARGIN,NET_BUY_PREMIUM,EXTREME_LOSS_MARGIN,MTOM_LOSS,OTHER_MARGIN,TOTAL_MARGIN,CL_TYPE
INTO #FOMARGINNEW_INTRADAY FROM FOMARGINNEW_INTRADAY
WHERE 1 = 2 

	SET @STRSQL = LOWER('BULK INSERT #FOMARGINNEW_INTRADAY FROM ''' + @FILENAME  + '''  WITH (FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
	EXEC(@STRSQL)
  
  
DELETE FROM FOMARGINNEW_INTRADAY
WHERE MDATE = @MARGINDATE AND FILECOUNTER = @FILECOUNTER

UPDATE #FOMARGINNEW_INTRADAY SET PARTY_CODE = P.NEWPARTY_CODE 
FROM PARTYMAPPING P
WHERE #FOMARGINNEW_INTRADAY.PARTY_CODE = P.OldParty_Code

INSERT INTO FOMARGINNEW_INTRADAY
SELECT FILECOUNTER=@FILECOUNTER,MDATE,PARTY_CODE,SPAN_MARGIN,NET_BUY_PREMIUM,EXTREME_LOSS_MARGIN,MTOM_LOSS,OTHER_MARGIN,TOTAL_MARGIN,CL_TYPE,
UPLOAD_BY='',UPLOAD_ON=GETDATE()
FROM #FOMARGINNEW_INTRADAY

SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #FOMARGINNEW_INTRADAY

IF @RECCNT = 0 
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'NO DATA FOUND IN THE FILE, PLEASE CHECK AND IMPORT CORRECT FILE'
END

IF @RECCNT > 0 
BEGIN
	SELECT STRMSGCODE = 1, STRMSG = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORD(S) ' + CONVERT(VARCHAR,@RECCNT)
END

DROP TABLE #FOMARGINNEW_INTRADAY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.aws_Bill_Comm
-- --------------------------------------------------

--[aws_Bill_Comm] '2020-04-01' --,'2020-04-15'

--Created this SP under SRE-30720
CREATE proc [dbo].[aws_Bill_Comm] (@dt datetime)
as

declare @date varchar(30),@sdt varchar(11),@tdt varchar(11)


select @date= convert(varchar(11),@dt,103)
print  @date 

select @sdt=replace( convert(varchar(12),@dt,107),',','') 
select @tdt=replace( convert(varchar(12),@dt,107),',','') +' 23:59:59'

 
--EXEC  aws_nce_Bill '','ALL','zzzzzzzzzz','','zzzzzzzzz',@sdt,@sdt,'broker','broker'  
EXEC NCE_Digital_Bill_aws 'A','ZZZZZZZZ',@sdt,@sdt,'broker','broker','%','%','%' 

 
 


truncate table comm_bill_process

 
SELECT * INTO #DELAING_ADDRESS FROM (
SELECT DISTINCT PARTY_CODE ,(CASE WHEN DEALING_ADDRESS='- ' THEN 'G-1, Akruti Trade Centre, Road No. 7,MIDC Marol, Andheri (East),MUMBAI-400093 MAHARASHTRA' ELSE DEALING_ADDRESS END)
 DEALING_ADDRESS,GST_LOCATION=isnull(ltrim(rtrim(state)),'MAHARASHTRA'),SUB_BROKER,TGST_NO='0',roW_NUMBER()OVER (PARTITION BY PARTY_CODE ORDER BY PARTY_CODE) AS ROW_NO FROM (
SELECT distinct party_code,ISNULL(LTRIM(RTRIM(Address1)),'')+ ISNULL(LTRIM(RTRIM(Address2)),'')+ isnull(LTRIM(RTRIM(Address3)),'')+isnull(LTRIM(RTRIM(City)),'')+'-'+
isnull(LTRIM(RTRIM(ZIP)),'')+' '+isnull(LTRIM(RTRIM(sTATE)),'')  AS DEALING_ADDRESS ,c.SUB_BROKER,state
--FROM nce_aws_bill  C  
From nce_aws_digital_bill c
LEFT OUTER JOIN 
anand1.msajag.dbo.vwGetSubBrokerDetail_dummY V  with(nolock)
ON  C.Sub_Broker =V.Sub_Broker )A )A
WHERE ROW_NO=1


/*
 SELECT DISTINCT EXCHANGE,SEGMENT,PARTY_CODE,ORDER_NO,SCRIPNAME,SELL_BUY INTO #TEMP12 FROM Contractnote_comm_Daily 

SELECT CD_PARTY_CODE, EXCHANGE='MCX' ,SEGMENT ='FUTURES', CONVERT(VARCHAR(200),CD_SYMBOL) SCRIP_CD ,SELL_FLAG=CONVERT(VARCHAR(10),''), CONVERT(VARCHAR,CD_Order_No) CD_Order_No,
 CD_Tot_BuyQty	+CD_Tot_SellQty  AS TRD_QTY,CD_BUYRATE+CD_SELLRATE AS PRICE,
CD_TOT_TURNOVER TURNOVER ,CONVERT(VARCHAR,CD_TOT_BROK) AS BROKERAGE
INTO #ORDER_WISE
FROM MCDX.DBO.Charges_Detail   WHERE CD_SAUDA_DATE =@dt  AND CD_ComputationLevel ='O'  AND CD_PARTY_CODE >='A000' AND CD_PARTY_CODE <='ZZZZZ'
UNION ALL
SELECT CD_PARTY_CODE, EXCHANGE='NCX' ,SEGMENT ='FUTURES', CONVERT(VARCHAR(200),CD_SYMBOL) SCRIP_CD ,SELL_FLAG=CONVERT(VARCHAR(10),''), CONVERT(VARCHAR,CD_Order_No) CD_Order_No,
 CD_Tot_BuyQty	+CD_Tot_SellQty  AS TRD_QTY,CD_BUYRATE+CD_SELLRATE AS PRICE,
CD_TOT_TURNOVER TURNOVER ,CONVERT(VARCHAR,CD_TOT_BROK) AS BROKERAGE
FROM MCDX.DBO.Charges_Detail   WHERE CD_SAUDA_DATE =@dt  AND CD_ComputationLevel ='O'  AND CD_PARTY_CODE >='A000' AND CD_PARTY_CODE <='ZZZZZ'

UPDATE O SET SCRIP_CD =T.SCRIPNAME,SELL_FLAG =SELL_BUY FROM #ORDER_WISE O,#TEMP12 T
WHERE O.CD_Order_No=ORDER_NO 
AND T.EXCHANGE=O.EXCHANGE AND T.SEGMENT=O.SEGMENT
AND T.PARTY_CODE =O.CD_Party_Code*/
 
  
  
 INSERT INTO comm_bill_process
SELECT DISTINCT C.PARTY_CODE,'1' AS SNO,C.PARTY_CODE+'|'+'H'+'|'+C.PARTY_CODE+'('+c.branch_cd+'/'+c.sub_broker+')'+'|'+long_name+'|'
+replace(C.L_ADDRESS1,'|','')+'|'+replace(isnull(C.L_ADDRESS2,''),'|','')+'|'+replace(isnull(C.L_ADDRESS3,''),'|','')+'|'+C.L_CITY+'|'+C.L_STATE+'-'+C.L_ZIP+'|'+billno+'|'+C.PAN_GIR_NO+'|'+
CONVERT(VARCHAR(11),SAUDA_DATE,120) +'|'+email +'|'+mobile_pager  AS TEXT ,'','','','',''
--CONVERT(VARCHAR(11),SAUDA_DATE,120) +'|'+'shashi.soni@angelbroking.com' +'|'+'9321501694'  AS TEXT ,'','','','',''
FROM nce_aws_digital_bill D,anand1.msajag.dbo.CLIENT_DETAILS C
WHERE SAUDA_DATE =@date  AND C.PARTY_CODE >='a0' AND C.PARTY_CODE <='zzzzz'  
AND D.PARTY_CODE=C.CL_CODE 

 INSERT INTO comm_bill_process 
SELECT PARTY_CODE,'2' AS SNO,LTRIM(RTRIM(PARTY_CODE))+'|'+'A'+'|'+isnull(DEALING_ADDRESS,'')+'|'+isnull(GST_LOCATION,'')+'|'+isnull(TGST_NO,''),'','','','','' FROM #DELAING_ADDRESS 

   
 INSERT INTO comm_bill_process 
SELECT PARTY_CODE,'3' AS SNO,LTRIM(RTRIM(PARTY_CODE))+'|'+'D'+'|'+
convert( varchar(20), cast(samt as decimal(18,4)))+'|'+convert( varchar(20), cast(srate as decimal(18,4)))+'|'
+CONVERT(VARCHAR,sqty)+'|'+CONVERT(VARCHAR,inst_type)
+'|'+CONVERT(VARCHAR(100),symbol)+'|'+expirydate+'|'+option_type+'|'+CONVERT(VARCHAR,strike_price)+'|'+convert( varchar(20), cast(cl_rate as decimal(18,4)))+'|'
+CONVERT(VARCHAR,pqty)
+'|'+convert( varchar(20), cast(prate as decimal(18,4)))+'|'+
convert( varchar(20), cast(pamt as decimal(18,4))),SRNO,'','','',''
FROM (
SELECT  dense_rank ()OVER(PARTITION BY PARTY_CODE ORDER BY PARTY_CODE,billno DESC, symbol )AS SRNO, PARTY_CODE,--,EXCHANGE,SEGMENT
SAMT,srate,sqty,inst_type,symbol,expirydate,option_type,pqty,prate,pamt,strike_price,cl_rate
FROM nce_aws_digital_bill  WITH(NOLOCK) WHERE   PARTY_CODE >='A0' AND PARTY_CODE <='ZZZZZ'
)a order by PARTY_CODE,strike_price,symbol,expirydate


INSERT INTO comm_bill_process
SELECT PARTY_CODE,'4' AS SNO,PARTY_CODE+'|'+'F'+'|'+CONVERT(VARCHAR(20),CAST(SUM(SERVICE_TAX)AS DECIMAL(18,4))) +'|'+
CONVERT(VARCHAR(20),CAST(SUM(Insurance_Chrg)AS DECIMAL(18,4))) +'|'+CONVERT(VARCHAR(20),CAST(SUM(broker_note)AS DECIMAL(18,4))) +'|'+CONVERT(VARCHAR(20),CAST(SUM(TURN_TAX)AS DECIMAL(18,4))) 
+'|'+CONVERT(VARCHAR(20),CAST(SUM(other_chrg)AS DECIMAL(18,4)))+'|'+CONVERT(VARCHAR(20),CAST(SUM(SEBI_TAX)AS DECIMAL(18,4)))
+'|'+CONVERT(VARCHAR(20),CAST(SUM(samt-pamt-(SERVICE_TAX+SEBI_TAX+TURN_TAX+BROKER_NOTE+INSURANCE_CHRG+other_chrg)) AS DECIMAL(18,2)))+'|'+CONVERT(VARCHAR(5),billno)
 ,0,'','','',''
FROM nce_aws_digital_bill WHERE  PARTY_CODE >='a00' AND PARTY_CODE <='zzzzzz' --and UGST <>0
GROUP BY  PARTY_CODE,billno



SELECT B2C_SB INTO #BTWOB FROM [MIS].REMISIOR.DBO.B2C_SB WITH(NOLOCK)
WHERE ISNULL(B2C_SB,'')  NOT IN ('AMRVT')

update n set  Data_text=data_text+'|'+(case when B2C_SB is null then 'B2B' else 'B2C' end) 
from comm_bill_process n,anand1.msajag.dbo.client_Details d
 left outer join #BTWOB on B2C_SB=sub_broker
 where n.party_code =d.cl_code and sno=1 

 update comm_bill_process set Data_text=Data_text+'|NCE',EXCHANGE='NCE' 

  
/*

declare @NSEQUERY varchar(max)
set @NSEQUERY = ' bcp " select Data_text'
set @NSEQUERY = @NSEQUERY + ' from angelcommodity.nce.dbo.comm_bill_process  order by party_code ,sno,SRNO " queryout D:\Backoffice\Contract_Note\ContractNote_ncebill_'+replace(convert(varchar,@dt,103),'/','')+'.txt -c -t"," -Sangelcommodity -Usa -Psuropt09'
set @NSEQUERY = '''' + @NSEQUERY + ''''
set @NSEQUERY = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @NSEQUERY
print @NSEQUERY 
exec (@NSEQUERY)  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGDirectFOGenContract_exalloc
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.BBGDirectFOGenContract_exalloc    Script Date: 1/17/2004 11:42:36 PM ******/







/*
drop PROCEDURE BBGDirectFOGenContract_exalloc

execute BBGDirectFOGenContract_exalloc

*/
CREATE  PROCEDURE BBGDirectFOGenContract_exalloc
AS 
Declare @@Party varchar(12),
        @@Sett_Type varchar(2),  
        @@ContNo varchar(7),
        @@ContNoPartiPant varchar(7),
        @@ParticiPantCode Varchar(15),
        @@MemberCode Varchar(15),
        @@Sauda_Date Varchar(11),
        @@Order_no Varchar(16),
        @@Scrip_Cd Varchar(12),
        @@Series Varchar(2),
        @@Sell_buy Int,
        @@Style int,
        @@StartDate varchar(11),
        @@EndDate Varchar(11),
        @@Flag int,
        @@Cont Cursor  ,  
        @@PartyCont Cursor    ,
        @@CurSettType Varchar(2),
        @@inscontno varchar(7),
 	@@insttype varchar(6),
	@@symbol varchar(12),
	@@expirydate datetime,
	@@strikeprice money,
	@@optiontype varchar(2),      
        @@MaxContNoS Int,
        @@MaxConnoI  Int,
        @@BBGcontcur Cursor,
        @@getmaxcontno cursor,
        @@Inscont   Varchar(4)

Set @@PartyCont = Cursor for
     Select Distinct sauda_date = Left(Convert(Varchar,sauda_date,109),11) from bbgfosettlement
     Open @@PartyCont
     Fetch next  from @@PartyCont into   @@sauda_date
Close @@PartyCont
     
Set @@PartyCont = cursor for 
    Select MemberCode,Style=IsNull(Style,0) from foOwner
    Open @@PartyCont
    Fetch next  from @@PartyCont into   @@MemberCode,@@Style
Close @@PartyCont

Print ' Inserting into BBgSettlement from confirmview '

If @@Style = 0
Begin
     Set @@BBGContcur =  Cursor for
     Select isnull(Max(Convert(Int,Contractno)),0) From foSettlement Where sauda_Date like  @@Sauda_date +'%' and convert(int,contractno) <> 0
End


If @@Style = 1 
Begin
     Set @@BBGContcur = Cursor for	
     Select isnull(Convert(int,Contractno),0) From ContGen Where Start_Date <= @@sauda_date and End_Date >= @@sauda_date +' 23:59:59'
End 


                   
Open @@BBGcontcur
Fetch next from @@BBGcontcur into @@MaxcontNos
Close @@BBGcontCur

print @@sauda_date
Print @@MaxcontNos

Print 'Inserted all records into bbgfosettlement '
/* Now first we will update the parties who have previous contracts in either scrip or order */    
     Set @@Partycont = cursor for
     Select Distinct I.Party_code,I.Contractno,I.Order_no,I.inst_type,i.symbol,i.expirydate,
	i.strike_price,i.option_type,InsCont 
       From fosettlement I ,Client2 C2 
	Where I.Sauda_date like @@Sauda_date +'%'  
	and I.Party_code = C2.Party_code 
     and convert(int,i.contractno) <> 0
     Order by I.Party_code,I.inst_type,i.symbol,i.expirydate,i.strike_price,i.option_type,I.Order_no,I.Contractno
     open @@PartyCont
     Fetch next  from @@PartyCont into  @@Party,@@contno,@@Order_no,@@insttype,@@symbol,@@expirydate,@@strikeprice,@@optiontype,@@Inscont
     While @@fetch_status = 0
     Begin
          If @@InsCont = 'N' or @@inscont is null or @@inscont = ''
          Begin
               Update bbgfosettlement set Contractno = @@Contno 
               Where
               Party_code = @@Party
          End
          If @@InsCont = 'O' 
 Begin 
         Update bbgfosettlement set Contractno = @@Contno 
               Where
               Party_code = @@Party
               and
               Order_no = @@Order_no
          End
          If @@InsCont = 'S' 
          Begin 
               Update bbgfosettlement set Contractno = @@Contno 
               Where
               Party_code = @@Party
               and
               inst_type = @@insttype
               and
               symbol = @@symbol
               and
               expirydate = @@expirydate
               and
               strike_price = @@strikeprice
               and
               option_type = @@optiontype
          End
     Fetch next  from @@PartyCont into  @@Party,@@contno,@@Order_no,@@insttype,@@symbol,@@expirydate,@@strikeprice,@@optiontype,@@Inscont
     End 
 Close @@Partycont
     Select @@Party=''
        
     Set @@PartyCont = cursor for 
     Select Distinct bbgfosettlement.Party_Code  From Bbgfosettlement,Client2,client1 
     Where convert(int,contractno) = 0  and bbgfosettlement.party_code = client2.party_code and inscont =  'N'
     and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'
     order by bbgFOsettlement.party_code 
     open @@PartyCont
     Fetch next  from @@PartyCont into   @@Party
     While @@fetch_status = 0
     Begin
          Select @@ContNo =@@Maxcontnos +1
          Select @@Maxcontnos = @@Maxcontnos + 1
          Select @@Party,@@ContNo
          Update bbgFOsettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where Party_code =@@Party 
		Print @@maxcontnos

          fetch next  from @@PartyCont into @@Party
     End
     Close @@PartyCont
     Select @@Party=''

/* Now Order Wise    */
     Set @@PartyCont = cursor for 
     Select distinct bbgFOsettlement.Party_Code,bbgfosettlement.Order_no From bbgFOsettlement,Client2,client1
     Where convert(int,contractno) = 0  and bbgfosettlement.party_code = client2.party_code
     and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'
     and inscont  =  'O'
     Order by bbgFOsettlement.party_code,bbgfosettlement.Order_no  
     Open @@PartyCont
     Fetch next  from @@PartyCont into @@Party,@@Order_no
     While @@fetch_status = 0
     Begin
          Select @@ContNo = 0
          Select @@ContNo =@@Maxcontnos +1
          Select @@Maxcontnos = @@Maxcontnos + 1
          Update bbgFOsettlement Set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) Where
          Party_code =@@Party 
          and Order_no = @@Order_no

		Print @@maxcontnos
          Fetch next  from @@PartyCont into  @@Party,@@Order_no
     End
/*     If @@Style = 1 
     Update ContGen set ContractNo = @@ContNo where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date  */
 
     Close @@PartyCont
     Select @@Party=''
     select @@order_no = ''	
/* Now Scrip_wise   */
      
        Set @@PartyCont = cursor for 
        Select Distinct bbgFOsettlement.Party_Code,bbgfosettlement.inst_type,bbgfosettlement.symbol,bbgfosettlement.expirydate,bbgfosettlement.strike_price,bbgfosettlement.option_type 
	from bbgFOsettlement,Client2,client1
	Where convert(int,contractno) = 0  and bbgfosettlement.party_code = client2.party_code and inscont =  'S'
     	and client1.cl_code = client2.cl_code and client1.cl_type <> 'PRO'
        order by bbgFOsettlement.party_code,bbgfosettlement.inst_type,bbgfosettlement.symbol,bbgfosettlement.expirydate,bbgfosettlement.strike_price,bbgfosettlement.option_type 
        open @@PartyCont
        Fetch next  from @@PartyCont into @@Party,@@insttype,@@symbol,@@expirydate,@@strikeprice,@@optiontype
        Select @@Party,@@insttype,@@symbol,@@expirydate,@@strikeprice,@@optiontype
        While @@fetch_status = 0
        Begin
             Select @@ContNo = 0
             Select @@ContNo =@@Maxcontnos +1
    	     Select @@Maxcontnos = @@Maxcontnos + 1
             Update bbgFOsettlement set contractno = STUFF('0000000', 8 - Len(@@Contno), Len(@@Contno), @@Contno) where
             Party_code =@@Party 
             and
             inst_type = @@insttype
             and
             symbol = @@symbol
             and
             expirydate = @@expirydate
             and
             strike_price = @@strikeprice
             and
             option_type = @@optiontype

		Print @@maxcontnos
        Fetch next  from @@PartyCont into @@Party,@@insttype,@@symbol,@@expirydate,@@strikeprice,@@optiontype
        End
        Close @@PartyCont

print @@contno	
print @@maxcontnos


	if @@Maxcontnos is not null
	begin

	Update foowner set contno = @@maxcontnos

        If @@style = 1
	begin
	Update ContGen set ContractNo = @@Maxcontnos Where @@sauda_Date >= Start_Date and @@Sauda_Date <= End_Date 
	end

	end
deallocate @@Partycont

print @@maxcontnos
print @@contno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGDIRECTFOGENCONTRACT_EXPIRY
-- --------------------------------------------------




CREATE PROCEDURE BBGDIRECTFOGENCONTRACT_EXPIRY
AS 
DECLARE @@PARTY VARCHAR(12),
        @@SETT_TYPE VARCHAR(2),  
        @@CONTNO VARCHAR(7),
        @@CONTNOPARTIPANT VARCHAR(7),
        @@PARTICIPANTCODE VARCHAR(15),
        @@MEMBERCODE VARCHAR(15),
        @@SAUDA_DATE VARCHAR(11),
        @@ORDER_NO VARCHAR(16),
        @@SCRIP_CD VARCHAR(12),
        @@SERIES VARCHAR(2),
        @@SELL_BUY INT,
        @@STYLE INT,
        @@STARTDATE VARCHAR(11),
        @@ENDDATE VARCHAR(11),
        @@FLAG INT,
        @@CONT CURSOR  ,  
        @@PARTYCONT CURSOR    ,
        @@CURSETTTYPE VARCHAR(2),
        @@INSCONTNO VARCHAR(7),
 	@@INSTTYPE VARCHAR(6),
	@@SYMBOL VARCHAR(12),
	@@EXPIRYDATE DATETIME,
	@@STRIKEPRICE MONEY,
	@@OPTIONTYPE VARCHAR(2),      
        @@MAXCONTNOS INT,
        @@MAXCONNOI  INT,
        @@BBGCONTCUR CURSOR,
        @@GETMAXCONTNO CURSOR,
        @@INSCONT   VARCHAR(4)
SET @@PARTYCONT = CURSOR FOR
     SELECT DISTINCT SAUDA_DATE = LEFT(CONVERT(VARCHAR,ACTIVITYTIME,109),11) FROM  FOTRADE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@SAUDA_DATE
CLOSE @@PARTYCONT
     
SET @@PARTYCONT = CURSOR FOR 
    SELECT MEMBERCODE,STYLE=ISNULL(STYLE,0) FROM FOOWNER
    OPEN @@PARTYCONT
    FETCH NEXT  FROM @@PARTYCONT INTO   @@MEMBERCODE,@@STYLE
CLOSE @@PARTYCONT

IF @@STYLE = 0
BEGIN
     SET @@BBGCONTCUR =  CURSOR FOR
     SELECT ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM FOSETTLEMENT
     WHERE SAUDA_DATE LIKE  @@SAUDA_DATE +'%'
     AND CONVERT(INT,CONTRACTNO) <> 0
END

IF @@STYLE = 1 
BEGIN
     SET @@BBGCONTCUR = CURSOR FOR	
     SELECT ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
END 
                   
OPEN @@BBGCONTCUR
FETCH NEXT FROM @@BBGCONTCUR INTO @@MAXCONTNOS
CLOSE @@BBGCONTCUR

     SET @@PARTYCONT = CURSOR FOR
	SELECT DISTINCT C2.PARENTCODE,I.CONTRACTNO,I.ORDER_NO,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,
	I.STRIKE_PRICE,I.OPTION_TYPE,INSCONT 
	FROM FOSETTLEMENT I ,CLIENT2_VIEW C2 
	WHERE I.SAUDA_DATE LIKE @@SAUDA_DATE +'%'  
	AND I.PARTY_CODE = C2.PARTY_CODE 
	AND CONVERT(INT,I.CONTRACTNO) <> 0
	ORDER BY PARENTCODE,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,I.ORDER_NO,I.CONTRACTNO
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
     WHILE @@FETCH_STATUS = 0
     BEGIN
          IF @@INSCONT = 'N' OR @@INSCONT IS NULL OR @@INSCONT = ''
          BEGIN
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARENTCODE = @@PARTY
          END
          IF @@INSCONT = 'O' 
	 BEGIN 
         UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARENTCODE = @@PARTY
               AND
               ORDER_NO = @@ORDER_NO
          END
          IF @@INSCONT = 'S' 
          BEGIN 
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARENTCODE = @@PARTY
               AND
               INST_TYPE = @@INSTTYPE
               AND
               SYMBOL = @@SYMBOL
               AND
               EXPIRYDATE = @@EXPIRYDATE
               AND
               STRIKE_PRICE = @@STRIKEPRICE
               AND
               OPTION_TYPE = @@OPTIONTYPE
          END
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
     END     
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
        
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARENTCODE  FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1 
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT NOT IN ('O','S')
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'  AND PRICE <> 0
     ORDER BY BBGFOSETTLEMENT.PARENTCODE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          SELECT @@PARTY,@@CONTNO
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
          PARENTCODE =@@PARTY 
          FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY
     END
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.ORDER_NO FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND PRICE <> 0
     AND INSCONT  =  'O'
     ORDER BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.ORDER_NO  
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO = 0
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
          PARENTCODE =@@PARTY 
          AND ORDER_NO = @@ORDER_NO
          FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO
     END
 
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
     SELECT @@ORDER_NO = ''	
      
        SET @@PARTYCONT = CURSOR FOR 
        SELECT DISTINCT BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
	FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
	WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'
     	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND PRICE <> 0
        ORDER BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
        OPEN @@PARTYCONT
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        SELECT @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        WHILE @@FETCH_STATUS = 0
        BEGIN
             SELECT @@CONTNO = 0
             SELECT @@CONTNO =@@MAXCONTNOS +1
    	     SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
             UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
             PARENTCODE =@@PARTY 
             AND
             INST_TYPE = @@INSTTYPE
             AND
             SYMBOL = @@SYMBOL
             AND
             EXPIRYDATE = @@EXPIRYDATE
             AND
             STRIKE_PRICE = @@STRIKEPRICE
             AND
             OPTION_TYPE = @@OPTIONTYPE
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        END
        CLOSE @@PARTYCONT

	IF @@MAXCONTNOS IS NOT NULL
	BEGIN
		UPDATE FOOWNER SET CONTNO = @@MAXCONTNOS 
	
        	IF @@STYLE = 1 
		BEGIN
		UPDATE CONTGEN SET CONTRACTNO = @@MAXCONTNOS WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
		END
	END
DEALLOCATE @@PARTYCONT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULK_MARGINUPLOAD_INRADAY
-- --------------------------------------------------


CREATE PROC [dbo].[BULK_MARGINUPLOAD_INRADAY]  
(
	@TDATE VARCHAR(10), 
	@FILEFOR VARCHAR(20), 
	@FILETYPE VARCHAR(50), 
	@PROGID VARCHAR(50), 
	@UNAME VARCHAR(50),
	@FILENAME VARCHAR(100) = ''
)
AS         
      
DECLARE @STRSQL VARCHAR(500), 
		@FILECOUNTER INT,
		@FILEDT VARCHAR(8),
		@FILEDATE	DATETIME,
		@RECCNT	INT,
		@SAUDA_DATE	VARCHAR(11)
		  
SET @SAUDA_DATE = CONVERT(DATETIME,@TDATE,103)

SET @FILECOUNTER = LEFT(RIGHT(@FILENAME,6),2)

SET @FILEDT = LEFT(RIGHT(@FILENAME,16),8)

SET @FILEDATE = CONVERT(DATETIME,LEFT(@FILEDT,2)+'/'+RIGHT(LEFT(@FILEDT,4),2)+'/'+RIGHT(@FILEDT,4),103)

IF CONVERT(DATETIME,@SAUDA_DATE) <> @FILEDATE
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'SELECTED DATE IS NOT MATCHING WITH THE FILE DATE.'
	RETURN
END

SELECT MDATE, PARTY_CODE, SPANMARGIN, FILLER,EXTREAMELOSSMARGIN,DEL_MARGIN,MTOMLOSS,TOTALMARGIN,CL_TYPE
INTO #FOMARGINNEW_INTRADAY FROM FOMARGINNEW_INTRADAY
WHERE 1 = 2 



IF @FILETYPE = 'BLK'
BEGIN
	SET @STRSQL = LOWER('BULK INSERT #FOMARGINNEW_INTRADAY FROM ''' + @FILENAME  + '''  WITH (FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
	EXEC(@STRSQL)
END
ELSE
BEGIN
	INSERT INTO #FOMARGINNEW_INTRADAY
	SELECT 
		MDATE = DBO.PIECE(FILE_DATA,',',1),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',2),
		SPANMARGIN = DBO.PIECE(FILE_DATA,',',3),
		FILLER = DBO.PIECE(FILE_DATA,',',4),
		EXTREAMELOSSMARGIN = DBO.PIECE(FILE_DATA,',',5),
		DEL_MARGIN = DBO.PIECE(FILE_DATA,',',6),
		MTOMLOSS = DBO.PIECE(FILE_DATA,',',7),
		TOTAL_MARGIN = DBO.PIECE(FILE_DATA,',',8),
		CL_FLAG  = DBO.PIECE(FILE_DATA,',',9)
	FROM FILEDATA  (NOLOCK)
	WHERE PROGID= @PROGID
	AND ISNULL(DBO.PIECE(FILE_DATA,',',1),0) <> ''
END

SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #FOMARGINNEW_INTRADAY
IF @RECCNT = 0 
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'NO DATA FOUND IN THE FILE, PLEASE CHECK AND IMPORT CORRECT FILE'
END

DELETE FROM FOMARGINNEW_INTRADAY
WHERE MDATE = @FILEDATE AND FILECOUNTER = @FILECOUNTER

INSERT INTO FOMARGINNEW_INTRADAY
SELECT FILECOUNTER=@FILECOUNTER,MDATE, PARTY_CODE, SPANMARGIN, FILLER,EXTREAMELOSSMARGIN,DEL_MARGIN,MTOMLOSS,TOTALMARGIN,CL_TYPE,
UPLOAD_ON=GETDATE(),UPLOAD_BY=''
FROM #FOMARGINNEW_INTRADAY

IF @RECCNT > 0 
BEGIN
	SELECT STRMSGCODE = 1, STRMSG = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORD(S) ' + CONVERT(VARCHAR,@RECCNT)
END

DROP TABLE #FOMARGINNEW_INTRADAY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY
-- --------------------------------------------------

CREATE  PROC [DBO].[CALCULATE_STAMP_DUTY]          
(                
  @SAUDA_DATE VARCHAR(11),          
  @FROMPARTY VARCHAR(10)='0',                 
  @TOPARTY VARCHAR(10)='ZZZZZZZ'                
)          
AS          
          
      
IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END      
      
IF (SELECT COUNT(1) FROM STATE_MASTER (NOLOCK) WHERE @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE) = 0 BEGIN  RETURN  END   
  
      
CREATE TABLE #STAMP       
(      
  [PARTY_CODE]         [VARCHAR](10),      
  [BROKER_NOTE]        NUMERIC (36,12),      
  [L_STATE]            [VARCHAR](50),      
  [TURNOVER]           NUMERIC (36,12),      
  [ROUNDEDTURNOVER]    NUMERIC (36,12),      
  [TOBECHRG_STAMPDUTY] NUMERIC (36,12)      
)      
      
CREATE TABLE #CLIENTLIST       
(      
  PARTYCODE VARCHAR(10)      
)      
  
SELECT DISTINCT PARTY_CODE INTO #FOSETT FROM FOSETTLEMENT  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'      
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
  
SELECT * INTO #CLIENT1  
FROM CLIENT1  
WHERE EXISTS (SELECT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = CL_CODE)  
  
SELECT * INTO #CLIENT2  
FROM CLIENT2  
WHERE EXISTS (SELECT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = CL_CODE)  
  
INSERT INTO #CLIENTLIST      
SELECT PARTY_CODE      
FROM   FOCLIENTTAXES (NOLOCK)      
WHERE  @SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO      
       AND FUT_BROKER_NOTE = 0 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
                                   
INSERT INTO #CLIENTLIST      
SELECT PARTY_CODE      
FROM   CLIENT2 (NOLOCK)      
WHERE  BROKERNOTE = 0      
AND    PARTY_CODE NOT IN (SELECT PARTYCODE FROM #CLIENTLIST)      
                          
/*UPDATING REST RECORDS BASED ON CLIENT'S STATE*/      
UPDATE FOSETTLEMENT      
SET    BROKER_CHRG = 0      
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
       AND EXISTS (SELECT PARTYCODE      
                   FROM   #CLIENTLIST (NOLOCK) WHERE PARTY_CODE = PARTYCODE)      
                       
UPDATE FOSETTLEMENT      
SET    BROKER_CHRG = ROUND((CASE       
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY      
                        ELSE TRDSTAMPDUTY      
                      END * (CASE       
                               WHEN TAXESFLAG = 0 THEN PRICE      
                               ELSE CASE       
                                      WHEN TAXESFLAG = 1 THEN CASE       
                                                                WHEN STRIKE_PRICE = 0 THEN PRICE      
                                                                ELSE STRIKE_PRICE      
                                                              END      
                                      ELSE STRIKE_PRICE + PRICE      
                                    END      
                             END) * TRADEQTY * BOOKTYPE / INSTRUMENT / 100),4)  
FROM   #CLIENT1 CLIENT1,      
       #CLIENT2 CLIENT2,      
       STATE_MASTER,      
       FOOWNER      
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE      
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE      
       AND L_STATE = STATE_MASTER.STATE      
       AND SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE      
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'      
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
       AND AUCTIONPART <> 'CA'      
       AND NOT EXISTS (SELECT PARTYCODE      
                       FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)      
                            
/*UPDATING REST RECORDS BASED ON MEMEBER'S STATE*/      
UPDATE FOSETTLEMENT      
SET    BROKER_CHRG = ROUND((CASE       
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY      
                        ELSE TRDSTAMPDUTY      
                      END * (CASE       
          WHEN TAXESFLAG = 0 THEN PRICE      
                               ELSE CASE       
                                      WHEN TAXESFLAG = 1       
     THEN CASE       
                                         WHEN STRIKE_PRICE = 0 THEN PRICE      
                                         ELSE STRIKE_PRICE      
                                       END      
                                      ELSE STRIKE_PRICE + PRICE      
                                    END      
                             END) * TRADEQTY * BOOKTYPE / INSTRUMENT / 100),4)    
FROM   #CLIENT1 CLIENT1,      
       #CLIENT2 CLIENT2,      
       STATE_MASTER,      
       FOOWNER      
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE      
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE      
       AND STATE_MASTER.STATE = FOOWNER.STATE   
       AND L_STATE NOT IN (SELECT STATE      
                           FROM   STATE_MASTER      
                           WHERE  @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)      
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'     
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
       AND AUCTIONPART <> 'CA'      
       AND NOT EXISTS (SELECT PARTYCODE      
                 FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)      
                           
       
INSERT INTO #STAMP      
SELECT   S.PARTY_CODE,      
         BROKER_NOTE = SUM(BROKER_CHRG),      
         L_STATE,      
         TURNOVER = SUM(TRADEQTY * (CASE       
                                      WHEN TAXESFLAG = 0 THEN PRICE      
                                      ELSE CASE       
                                             WHEN TAXESFLAG = 1       
      THEN CASE       
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE      
                                                       ELSE STRIKE_PRICE      
                                                     END      
                                             ELSE STRIKE_PRICE + PRICE      
                                           END      
                                    END) * BOOKTYPE / INSTRUMENT),      
         ROUNDEDTURNOVER = SUM(TRADEQTY * (CASE       
                                             WHEN TAXESFLAG = 0 THEN PRICE      
                                             ELSE CASE       
                                                    WHEN TAXESFLAG = 1       
       THEN CASE       
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE      
                                                       ELSE STRIKE_PRICE      
                                                     END      
                                                    ELSE STRIKE_PRICE + PRICE      
                                                  END      
                                           END) * BOOKTYPE / INSTRUMENT),      
         TOBECHRG_STAMPDUTY = SUM(BROKER_CHRG)      
FROM     FOSETTLEMENT S,      
         #CLIENT1 C1,      
         #CLIENT2 C2,      
         FOOWNER      
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
         AND C1.CL_CODE = C2.CL_CODE      
         AND C2.PARTY_CODE = S.PARTY_CODE      
         AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
         AND TRADEQTY > 0      
         AND PRICE > 0      
         AND AUCTIONPART <> 'CA'      
         AND NOT EXISTS (SELECT PARTYCODE      
                         FROM   #CLIENTLIST (NOLOCK) WHERE S.PARTY_CODE = PARTYCODE)      
         AND L_STATE IN (SELECT STATE      
                         FROM   STATE_MASTER      
                         WHERE  MIN_MULTIPLIER > 0      
                                 OR MAXIMUM_LIMIT > 0      
                                    AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)      
GROUP BY S.PARTY_CODE,L_STATE      
               
UPDATE #STAMP      
SET    ROUNDEDTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(TURNOVER,FOR_TURNOVER)      
FROM   STATE_MASTER      
WHERE  L_STATE = STATE      
       AND FOR_TURNOVER > 0      
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE      
              
UPDATE #STAMP      
SET    TOBECHRG_STAMPDUTY = ROUND((CASE       
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > MAXIMUM_LIMIT      
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT      
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > BROKER_NOTE       
     THEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER      
                               WHEN BROKER_NOTE > MAXIMUM_LIMIT      
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT      
                               ELSE BROKER_NOTE      
                             END),4)      
FROM   STATE_MASTER      
WHERE  L_STATE = STATE      
       AND FOR_TURNOVER > 0      
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE      
                                                         
UPDATE FOSETTLEMENT      
SET    BROKER_CHRG = 0      
WHERE FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'      
                      AND EXISTS (SELECT PARTY_CODE      
 FROM   #STAMP      
               WHERE  #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)      
                    
SELECT   PARTY_CODE,      
         TRADESCRIPSELL = MIN(TRADE_NO + ORDER_NO + CONVERT(CHAR(1),SELL_BUY))      
INTO     #SETTSTAMP      
FROM     FOSETTLEMENT      
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'     
         AND AUCTIONPART <> 'CA'      
         AND TRADEQTY > 0      
         AND PRICE > 0      
         AND EXISTS (SELECT PARTY_CODE      
                     FROM   #STAMP      
                     WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'     
                            AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)      
GROUP BY PARTY_CODE      
               
UPDATE FOSETTLEMENT      
SET    BROKER_CHRG = TOBECHRG_STAMPDUTY      
FROM   #STAMP,      
       #SETTSTAMP      
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
    AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY      
       AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE      
       AND #SETTSTAMP.PARTY_CODE = #STAMP.PARTY_CODE      
       AND #SETTSTAMP.TRADESCRIPSELL = FOSETTLEMENT.TRADE_NO + FOSETTLEMENT.ORDER_NO +      
     CONVERT(CHAR(1),FOSETTLEMENT.SELL_BUY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_TRANS_CHRG
-- --------------------------------------------------
  
  
CREATE PROCEDURE [dbo].[CALCULATE_TRANS_CHRG] (@SAUDADATE VARCHAR(11))                 
AS  
  
IF (SELECT COUNT(1) FROM  TAXES_SETTING (NOLOCK) WHERE TAXES_TYPE ='TRANS_CHRG' AND @SAUDADATE BETWEEN DATE_FROM AND DATE_TO  AND COMPUTE_FLAG = 1) > 0          
BEGIN         
 -- COMPUTING COMMODITY WISE STAMP DUTY (ONLY FOR EXCEPTIONS)        
 UPDATE FOSETTLEMENT          
  SET TURN_TAX = ROUND((TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT) * TAXES_PERC / (CASE WHEN TAXES_UNIT =0 THEN 100 ELSE TAXES_UNIT END),4)  
 FROM  
  TAXES_SETTING (NOLOCK)  
 WHERE  
  SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'          
  AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO  
  AND TAXES_TYPE = 'TRANS_CHRG'  
  AND FOSETTLEMENT.SYMBOL = TAXES_SETTING.SYMBOL  
  AND FOSETTLEMENT.TURN_TAX <> 0 
  
 UPDATE  FOSETTLEMENT  
 SET     TURN_TAX = PRICE * TRADEQTY * TAX_PERC / 100
	FROM   TURNTAX_EXCEPTION  
	WHERE  SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59' 
	AND FOSETTLEMENT.SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO  
	AND TURNTAX_EXCEPTION.INST_TYPE = FOSETTLEMENT.INST_TYPE  
	AND TURNTAX_EXCEPTION.SYMBOL = FOSETTLEMENT.SYMBOL  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CalculateMargin
-- --------------------------------------------------



CREATE  Procedure CalculateMargin (@margindate as char(11))
As

   /*
     Procedure Name : CalculateMargin 
     Description : Calculating marging for a given period and storing at FoMarginNew table
     Parameter : Trade Date in long format
     Author : Sinulal
     Date : 30 Oct 2003
     Last Modified : 24 Feb 2004
   */

    /*inserting to tmp table from trade file*/
    select s.party_code,s.inst_type,s.symbol,s.ExpiryDate,sum(Case When Sell_buy = 1 Then S.Tradeqty Else -TradeQty End) trqty,
    stlmntprice=s.strike_price, marginflag = 0,smarginamt=s.strike_price,
    pmarginamt=s.strike_price, buymargin=s.strike_price, sellmargin=s.strike_price
    into #tmpMargin
    from fosettlement s      
    where s.expirydate > @margindate +' 00:00:00' 
    and s.Sauda_date <= @margindate +' 23:59:00'    
    group by s.party_code,s.inst_type,s.symbol,s.ExpiryDate,s.strike_price
    Having sum(Case When Sell_buy = 1 Then S.Tradeqty Else -TradeQty End) <> 0 

    /*filtering commodity contract master for further process*/
    select * into #commcontract from commcontract c
    where c.expirydate > @margindate +' 00:00:00' 

    /*filtering closing file for forther process*/
    select * into #foclosing from foclosing f
    where f.trade_date >= @margindate + ' 00:00:00'

    /*updating tmp table margin persentage / flat for buy*/
    update tmp set tmp.buymargin=(RegularBuyMargin +  SpecialBuyMargin), 
    tmp.sellmargin=(RegularsellMargin +  SpecialsellMargin)
    from #tmpMargin tmp,#commcontract c
    where c.recordtype = tmp.inst_type and (c.CommodityCode = tmp.symbol or c.CommodityAsset = tmp.symbol)
    and left(c.ExpiryDate,12) = left(tmp.ExpiryDate,12) 

    /*updating tmp table margin flag 0-no,1-persentage,2-flat*/
    update tmp set tmp.marginflag=c.Marginindicator
    from #tmpMargin tmp,#commcontract c
    where c.recordtype = tmp.inst_type and (c.CommodityCode = tmp.symbol or c.CommodityAsset = tmp.symbol)
    and c.ExpiryDate = tmp.ExpiryDate 

    /*updating tmp table settlement price whith closing price*/
    update tmp set tmp.stlmntprice=f.cl_rate from #tmpMargin tmp,#foclosing f
    where f.inst_type = tmp.inst_type and f.symbol = tmp.symbol
    and f.ExpiryDate = tmp.ExpiryDate 
       
    /*calculating margin amount according to margin flag*/
    update #tmpMargin 
    Set pmarginamt = (Case When TrQty > 0
			   Then (Case when marginflag = 1 
		                      Then ((buymargin * stlmntprice * Abs(trqty)) / 100) 
		                      when marginflag = 2 
			 	      Then (buymargin * stlmntprice * Abs(trqty))
				      Else 0
	    		         End )
			   Else 0 		
		      End ),
        smarginamt = (Case When TrQty < 0 
			   Then (Case when marginflag = 1 
		                      Then ((sellmargin * stlmntprice * Abs(trqty)) / 100) 
		                      when marginflag = 2 
			 	      Then (sellmargin * stlmntprice * Abs(trqty))
				      Else 0
	    		         End )
			   Else 0 		
		      End )    
  
    /*deleting rows from margin table for the party and the date*/
    delete fomarginnew where mdate >= @margindate + ' 00:00:00' and mdate <= @margindate + ' 23:59:00'
    and  symbol =''

    /*inserring rows to margin table*/
    insert into fomarginnew (Party_Code,SpreadMargin,NonSpreadMargin,TotalMargin,Pmargin,Mdate,
    PMarginAmount,PspanMargin,Cl_Type,MtoM,Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Cor_Act_Level,NetPosition,MarginablePosition,SettlementPrice,MarginPercent,AddMargin)
    Select party_code,Spreadmargin,NonSpreadmargin,TotalMargin=Sum(TotalMargin),
    PMargin,MDate,PMarginAmount,PspanMargin,Cl_Type,MtoM,'','','',0,'','',0,0,0,0,0 From 
    ( select party_code,Spreadmargin=0,NonSpreadmargin=0,
    TotalMargin=abs(sum(smarginamt-pmarginamt)),Pmargin=0,MDate=@margindate + ' 23:59:00',PMarginAmount=0,PspanMargin=0,Cl_Type='',MtoM=abs(sum(smarginamt-pmarginamt)) from #tmpMargin 
    group by party_code,Inst_Type,Symbol,ExpiryDate ) A
    Group by party_code,Spreadmargin,NonSpreadmargin,PMargin,MDate,PMarginAmount,PspanMargin,Cl_Type,MtoM 
    having Sum(TotalMargin) > 0     		
 
    /*  ------------------------------------    End of Procedure -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATESTAMPDUTY
-- --------------------------------------------------




CREATE PROC [dbo].[CALCULATESTAMPDUTY]  
(                      
 @SAUDA_DATE VARCHAR(11),                
 @FROMPARTY VARCHAR(10)='0',                       
 @TOPARTY VARCHAR(10)='ZZZZZZZ'                      
)                
AS   
DECLARE 
		@SETTCUR		CURSOR,
		@PARTY_CODE		VARCHAR(10),
		@FLAG			INT,
		@SNO			NUMERIC(18,0),
		@TOTALSTAMP		NUMERIC(18,4),
		@DIFF			NUMERIC(18,4),
		@CONTRACTNO		VARCHAR(7),
		@STAMPCUR CURSOR,
		@DIFFCUR	CURSOR 
-- EXEC CALCULATE_STAMP_DUTY_NEW 'DEC  1 2015', '0', 'ZZZZZZZZ'
IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END            

CREATE TABLE [#FOCLIENTTAXES]
(
	[SRNO] [INT] ,
	[PARTY_CODE] [VARCHAR](10) ,
	[DATE_FROM] [DATETIME] ,
	[DATE_TO] [DATETIME] ,
	[FUT_INSURANCE_CHRG] [FLOAT] ,
	[FUT_TURNOVER_TAX] [FLOAT] ,
	[FUT_OTHER_CHRG] [FLOAT] ,
	[FUT_SEBITURN_TAX] [FLOAT] ,
	[FUT_BROKER_NOTE] [FLOAT] ,
	[OPT_INSURANCE_CHRG] [FLOAT] ,
	[OPT_TURNOVER_TAX] [FLOAT] ,
	[OPT_OTHER_CHRG] [FLOAT] ,
	[OPT_SEBITURN_TAX] [FLOAT] ,
	[OPT_BROKER_NOTE] [FLOAT] ,
	[ROUND_TO] [DECIMAL](18, 0) ,
	[ROFIG] [INT] ,
	[ERRNUM] [NUMERIC](18, 10) ,
	[NOZERO] [INT] 
) 
CREATE CLUSTERED INDEX [IDXCL] ON [#FOCLIENTTAXES] 
(
	[PARTY_CODE] ASC,
	[DATE_FROM] ASC,
	[DATE_TO] ASC
)
  
SELECT * INTO #FOSETTLEMENT FROM NCE.DBO.FOSETTLEMENT (NOLOCK)
WHERE  SAUDA_DATE BETWEEN  @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
 
INSERT INTO #FOCLIENTTAXES
SELECT * FROM FOCLIENTTAXES F (NOLOCK)
WHERE @SAUDA_DATE BETWEEN F.DATE_FROM AND F.DATE_TO
AND EXISTS (SELECT PARTY_CODE FROM #FOSETTLEMENT S 
			WHERE S.PARTY_CODE = F.PARTY_CODE)

UPDATE #FOSETTLEMENT SET BROKER_CHRG = 0

SELECT SAUDA_DATE=CONVERT(DATETIME,LEFT(SAUDA_DATE,11)), CONTRACTNO = (CASE WHEN RESERVED1 <> 1 THEN '' ELSE CONTRACTNO END), 
PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,
BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END), 
SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END), 
BUYAVGRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 THEN
								(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
									  THEN CONVERT(NUMERIC(18,2),(SUM(CASE WHEN SELL_BUY = 1 THEN PRICE * TRADEQTY ELSE 0 END)
									       / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END))) ELSE 0 END) ELSE 0 END),
			   SELLAVGRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 THEN
								(CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
									  THEN CONVERT(NUMERIC(18,2),(SUM(CASE WHEN SELL_BUY = 2 THEN PRICE * TRADEQTY ELSE 0 END)
									       / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END))) ELSE 0 END) ELSE 0 END),
BUYSTAMP = CONVERT(NUMERIC(18,2),0),
SELLSTAMP = CONVERT(NUMERIC(18,2),0),
TOTALSTAMP =  CONVERT(NUMERIC(18,2),0),
SRNO = 0, TRADEQTY = MAX(TRADEQTY),
L_STATE = CONVERT(VARCHAR(100),''),
SELL_BUY,
BOOKTYPE,
INSTRUMENT 
INTO #STAMP_DATA
FROM #FOSETTLEMENT
--WHERE AUCTIONPART <> 'CA'
WHERE AUCTIONPART = ''
AND TRADEQTY > 0 
AND PRICE > 0 
GROUP BY CONVERT(DATETIME,LEFT(SAUDA_DATE,11)), (CASE WHEN RESERVED1 <> 1 THEN '' ELSE CONTRACTNO END), PARTY_CODE, 
INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, SELL_BUY,
BOOKTYPE,
INSTRUMENT
/*
UPDATE #STAMP_DATA SET L_STATE = C.L_STATE
FROM #TBL_STAMP_DATA C
WHERE C.PARTY_CODE = #STAMP_DATA.PARTY_CODE
*/

UPDATE #STAMP_DATA SET L_STATE = C1.L_STATE
FROM CLIENT1 C1
WHERE C1.CL_CODE = #STAMP_DATA.PARTY_CODE
AND #STAMP_DATA.L_STATE = ''

UPDATE #STAMP_DATA SET SRNO = C.SRNO
FROM #FOSETTLEMENT C
WHERE 
#STAMP_DATA.INST_TYPE = C.INST_TYPE
AND #STAMP_DATA.SYMBOL = C.SYMBOL
AND #STAMP_DATA.EXPIRYDATE = C.EXPIRYDATE 
AND #STAMP_DATA.STRIKE_PRICE = C.STRIKE_PRICE
AND #STAMP_DATA.OPTION_TYPE = C.OPTION_TYPE  
AND #STAMP_DATA.PARTY_CODE = C.PARTY_CODE
AND #STAMP_DATA.CONTRACTNO = (CASE WHEN RESERVED1 <> 1 THEN '' ELSE C.CONTRACTNO END)
AND #STAMP_DATA.SELL_BUY = C.SELL_BUY  
AND #STAMP_DATA.TRADEQTY = C.TRADEQTY
AND C.TRADEQTY > 0 
--AND AUCTIONPART <> 'CA'
AND AUCTIONPART = ''
AND PRICE > 0

UPDATE #STAMP_DATA SET 
BUYSTAMP = (BUYAVGRATE * (BOOKTYPE / INSTRUMENT) * BUYQTY * BUYTAX) / 100,
SELLSTAMP = (SELLAVGRATE * (BOOKTYPE / INSTRUMENT) * SELLQTY * SELLTAX) / 100
FROM TBL_STAMP_TAX
WHERE TBL_STAMP_TAX.INST_TYPE = #STAMP_DATA.INST_TYPE
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
AND L_STATE <> 'SIKKIM'  
		
UPDATE #STAMP_DATA SET 
BUYSTAMP = CONVERT(NUMERIC(18,2),BUYSTAMP),
SELLSTAMP = CONVERT(NUMERIC(18,2),SELLSTAMP) 

UPDATE #STAMP_DATA SET TOTALSTAMP = BUYSTAMP + SELLSTAMP

ALTER TABLE #STAMP_DATA
ADD SNO INT IDENTITY(1,1)

SELECT 
PARTY_CODE, CONTRACTNO, 
BROKER_CHRG = SUM(TOTALSTAMP), 
ACT_BROKER_CHRG = CONVERT(NUMERIC(18,0),SUM(TOTALSTAMP))
INTO #DIFF
FROM #STAMP_DATA
GROUP BY PARTY_CODE, CONTRACTNO
HAVING SUM(TOTALSTAMP) <> CONVERT(NUMERIC(18,0),SUM(TOTALSTAMP))


CREATE CLUSTERED INDEX IDX_SNO ON #STAMP_DATA
(	
	SNO
)		
 
		SET @STAMPCUR = CURSOR FOR 
			SELECT PARTY_CODE, CONTRACTNO, DIFF = ACT_BROKER_CHRG - BROKER_CHRG, FLAG = (CASE WHEN ACT_BROKER_CHRG - BROKER_CHRG > 0 THEN 0 ELSE 1 END)
			FROM #DIFF
			WHERE BROKER_CHRG <> ACT_BROKER_CHRG
		OPEN @STAMPCUR
		FETCH NEXT FROM @STAMPCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF, @FLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			SET @DIFFCUR = CURSOR FOR
				SELECT SNO, TOTALSTAMP
				FROM #STAMP_DATA
				WHERE PARTY_CODE = @PARTY_CODE
				AND CONTRACTNO = (CASE WHEN @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END)
				ORDER BY TOTALSTAMP DESC
			OPEN @DIFFCUR
			FETCH NEXT FROM @DIFFCUR INTO @SNO, @TOTALSTAMP
			WHILE @@FETCH_STATUS = 0 
			BEGIN
				IF @TOTALSTAMP > ABS(@DIFF) 
				BEGIN
					UPDATE #STAMP_DATA SET TOTALSTAMP = TOTALSTAMP + @DIFF
					WHERE SNO = @SNO
					SET @DIFF = 0 
				END
				ELSE
				BEGIN
					IF @FLAG = 0
					BEGIN
						UPDATE #STAMP_DATA SET TOTALSTAMP = TOTALSTAMP + @DIFF
						WHERE SNO = @SNO
						SET @DIFF = 0 
					END 
					ELSE
					BEGIN
						UPDATE #STAMP_DATA SET TOTALSTAMP = 0
						WHERE SNO = @SNO
						SET @DIFF = @DIFF + @TOTALSTAMP
					END 
				END
				FETCH NEXT FROM @DIFFCUR INTO @SNO, @TOTALSTAMP
			END
			CLOSE @DIFFCUR
			DEALLOCATE @DIFFCUR
		
			FETCH NEXT FROM @STAMPCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF, @FLAG
		END
		CLOSE @STAMPCUR
		DEALLOCATE @STAMPCUR 
		 
 

DELETE FROM TBL_STAMP_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 

INSERT INTO TBL_STAMP_DATA
SELECT SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	   BUYQTY=SUM(BUYQTY),SELLQTY=SUM(SELLQTY),BUYAVGRATE=SUM(BUYAVGRATE),SELLAVGRATE=SUM(SELLAVGRATE),
	   BUYSTAMP=SUM(BUYSTAMP),SELLSTAMP=SUM(SELLSTAMP),TOTALSTAMP=SUM(TOTALSTAMP),
	   L_STATE,LASTRUNDATE=GETDATE() 
FROM #STAMP_DATA
GROUP BY SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE, L_STATE

UPDATE #STAMP_DATA SET BUYSTAMP = 0, SELLSTAMP = 0, TOTALSTAMP = 0  
FROM #FOCLIENTTAXES
WHERE #FOCLIENTTAXES.PARTY_CODE = #STAMP_DATA.PARTY_CODE
AND (FUT_BROKER_NOTE = 0  OR OPT_BROKER_NOTE = 0)

UPDATE #STAMP_DATA SET BUYSTAMP = 0, SELLSTAMP = 0, TOTALSTAMP = 0  
FROM CLIENT2
WHERE CLIENT2.PARTY_CODE = #STAMP_DATA.PARTY_CODE
AND BrokerNOTE = 0  



UPDATE #FOSETTLEMENT
SET BROKER_CHRG = #STAMP_DATA.TOTALSTAMP
FROM #STAMP_DATA
WHERE #FOSETTLEMENT.SRNO = #STAMP_DATA.SRNO

UPDATE NCE.DBO.FOSETTLEMENT
SET BROKER_CHRG = #FOSETTLEMENT.BROKER_CHRG
FROM #FOSETTLEMENT
WHERE #FOSETTLEMENT.SRNO = NCE.DBO.FOSETTLEMENT.SRNO 


DECLARE @SAUDA_DATE1 DATETIME
SET @SAUDA_DATE1 =CONVERT(DATETIME,@SAUDA_DATE)

UPDATE F SET TURN_TAX =ROUND((TRADEQTY*PRICE*0.00001),4),SEBI_TAX =ROUND((TRADEQTY*PRICE*0.000001),4)
  FROM FOSETTLEMENT F (NOLOCK) WHERE SAUDA_DATE >=@SAUDA_DATE1 AND SAUDA_DATE <@SAUDA_DATE1 +' 23:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CERCULARUPDATE
-- --------------------------------------------------

--EXEC CERCULARUPDATE


CREATE PROC [dbo].[CERCULARUPDATE]
AS

BEGIN

--SELECT * into V2_CONTRACT_DIGITAL_DATA_31072013 FROM V2_CONTRACT_DIGITAL_DATA

DELETE  V2_CONTRACT_DIGITAL_DATA WHERE C_TYPE='F'

IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[V2_Contract_Digital_DATA]') AND name = N'PK_V2_Contract_Digital_DATA')
ALTER TABLE [dbo].[V2_Contract_Digital_DATA] DROP CONSTRAINT [PK_V2_Contract_Digital_DATA]

SET IDENTITY_INSERT V2_CONTRACT_DIGITAL_DATA ON


--EXEC CERCULARUPDATE

DECLARE @GETCOMPANYNAME VARCHAR(30)
DECLARE @PANNO VARCHAR(16)
SELECT 
	@GETCOMPANYNAME = COMPANY
FROM OWNER


INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(11,'','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(12,'<TR><TD colspan=4><b>NOTES:</b></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(13,'<TR><TD colspan=4><b>For Buy Transactions : </b>You will be liable to pay to seller, the sales tax, levies and other charges as applicable under the VAT/Local State/Central Sales Tax laws and the Rules, Bye-laws and Regulations of the Exchange, for issue of valid sales tax certificates/declaration forms as may be applicable to the seller and for compliance of sales Tax laws and regulations upon sale of commodities covered by the spot/forward contract. Please pay the amount shown for purchase of contracts/commodities as the case maybe.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(14,'<TR><TD colspan=4><b>For Sale Transactions : </b>You will be responsible for recovery of sales tax, Commodities Transaction Tax (CTT),levies and other charges as applicable under the VAT/Local State/Central Sales Tax/Income Tax  laws and the Rules, Bye-laws and Regulations of the Exchange, for issue of sales invoice valid sales tax certificates/declaration forms as may be applicable to the buyer and for compliance of sales Tax laws and regulations upon purchase of commodities covered by the spot/forward contract. Please intimate depository transfer imeediately for sale transactions in case of delivery/spot transactions.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(16,'<TR><TD colspan=4>This contract constitutes and shall be deemed to constitute an agreement between you and me/us that all claims (whether admitted or not), differences and disputes in respect of this contract or any dealings, transactions and contracts of a date prior or subsequent to the date of this contract(including any question whether such dealings, transactionsor contracts have been enterd into or not) shall be submitted to and decided by arbitration as provided in the Rules, Bye-laws and Regulations of National Commodity & Derivative Exchange , Mumbai. A part of the relevant extract of the Bye-laws given overleaf shall inter-alia, form part of this contract.</TD></TR> <TR><TD colspan=4> In matters where the Exchange is the party to the dispute, Civil Courts at Mumbai shall have exclusive jurisdiction.In all other matters, proper courts within area covered under the Religional Arbitration centre as may be notified by the Exchange shall have juridiction.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(17,'<TR><TD colspan=4><b>This contract is subject to the rules, Byelaws and Regulations and usage of National Commodity & Derivative Exchange Limited, Mumbai, as in force from time to time.</b> </TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(18,'<TR><TD colspan=4><b>*Strike off whichever is not applicable.</b></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(19,'<TR><TD  colspan=3>Place:AHMEDABAD</TD><TD colspan=1 align=center> </TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(20,'<TR><TD colspan=3>Date: DATE:</TD><TD colspan=1 align=center> </TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(21,'<TR><TD colspan=3 nowrap>AUTHORISED SIGNATORY:</TD><TD colspan=1 align=center>Yours faithfully,</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(22,'<TR><TD colspan=3></TD><TD align=center >For  '+ @GETCOMPANYNAME +'</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(23,'<TR><TD colspan=3 nowrap></TD><TD colspan=1 align=center></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(24,'<TR><TD colspan=3 nowrap></TD><TD colspan=1 align=center><BR><BR>DIRECTOR / AUTHORISED SIGNATORY</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(25,'<TR><TD colspan=3 nowrap></TD><TD colspan=1 align=center>Member of National Commodity & Derivatives Exchange Ltd.</TD></TR></TABLE>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(26,'<TABLE borderColor=black cellSpacing=1 cellPadding=1 border=1 width="100%">','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(27,'<TR><TD colspan=4 Align=Center><B>Extracts pertaining to Arbitration from the Bye-laws of National Commodity & Derivatives Exchange Limited</B></TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(28,'<TR><TD colspan=4>11.2 (1)  All claims, differences or disputes between the Trading Members inter se and between Trading Members and Constituents and Clearing Members inter-se and Clearing Members and Constituents and between Clearing Members and Trading Members arising out of or in relation to dealings, contracts and transactions executed or reported on the Exchange and made subject to and in accordance with the Bye-laws, Rules and Regulations of the Exchange or with reference to anything incidental thereto or in pursuance thereof or relating to interpretation, fulfillment or the rights, obligations and liabilities of the parties thereto shall be submitted to arbitration in accordance with the provisions of these Byelaws, Rules and Regulations.','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(29,'<BR>Provided however that the Relevant Authority may satisfy itself that the above referred claims, differences or disputes arise out of or in relation to dealings, contracts and transactions executed/reported on the Exchange and are in accordance with and subject to the Bye-laws, Rules and Regulations of the Exchange and are referable to Arbitration.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(30,'<TR><TD colspan=4>11.3) In all dealings, contracts and transactions, which are made or deemed to be made subject to the Byelaws, Rules and Regulations of the Exchange, the provisions relating to arbitration as provided in these Byelaws,Rules and Regulations shall form and shall be deemed to form part of the dealings, contracts and transactions and the parties shall be deemed to have entered into an arbitration agreement in writing by which all claims, differences, or disputes of the nature referred to in clause (1) above shall be submitted to arbitration as per the provisions of these Byelaws, Rules and Regulations.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(31,'<TR><TD colspan=4>11.4) All claims, differences or disputes referred to in clause (1) above shall be submitted to arbitration within  three (03) from the date on which the claim, difference or dispute arose or shall be deemed to have arisen. The time taken in conciliation proceedings, if any, initiated and conducted as per the provisions of the Act and the time taken by the Relevant Authority to administratively resolve the claim, differences or disputes shall be excluded for the purpose of determining the period of three (03) years.</TD></TR>','F')
INSERT INTO [V2_CONTRACT_DIGITAL_DATA] ([C_SR_NO],[C_TEXT],[C_Type])VALUES(32,'<TR><TD colspan=4><B>For More details please refer to the Bye-laws and Regulations of National Commodity & Derivatives Exchange Limited.</B></TD></TR>','F')


SET IDENTITY_INSERT V2_CONTRACT_DIGITAL_DATA OFF

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[V2_Contract_Digital_DATA]') AND name = N'IN_CONTRACT')
CREATE CLUSTERED INDEX IN_CONTRACT ON V2_CONTRACT_DIGITAL_DATA(C_SR_NO);

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECK_USER
-- --------------------------------------------------
CREATE PROC [dbo].[CHECK_USER]      
(      
 @UID VARCHAR(50),      
 @STNAME VARCHAR(50),      
 @RESULT INT OUTPUT      
)       
/*      
CHECK_USER 'DFS','',''
      
SELECT * FROM MSAJAG..CLIENT_DETAILS WHERE CL_CODE = '00000031'       
SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME ='TEST'
*/       
     
AS      
 DECLARE @COUNT SMALLINT      
       
SET @COUNT = 0       
      
IF UPPER(@STNAME) = 'CLIENT'      
 BEGIN      
 SELECT @COUNT = COUNT(*) FROM MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = @UID      
       
 IF @COUNT = 0       
  BEGIN      
  SET @RESULT = 2 --'NOTEXISTS'      
  SELECT @RESULT      
  RETURN      
  END      
 END       

SELECT @COUNT = COUNT(FLDNAME) FROM TBLUSERBLOCK WHERE FLDNAME LIKE '%'+@UID OR FLDNAME LIKE @UID+'%'
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 4 --'INVALID'      
 SELECT @RESULT      
 RETURN      
 END      

      
SELECT       
 @COUNT = COUNT(FLDUSERNAME) FROM TBLPRADNYAUSERS (NOLOCK) WHERE FLDUSERNAME LIKE @UID      
      
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 1 --'EXSITSINMASTER'      
 SELECT @RESULT      
 RETURN      
 END      
ELSE      
 BEGIN      
 SET @RESULT = 0 --'OK'      
 SELECT @RESULT      
 RETURN      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9S52WJ619S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_18Mar2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9R12WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_21042025
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_21042025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9S42WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_26102024
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_26102024]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '5,/9S42WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_31may2025
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_31may2025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '0/>9U02WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_bkp03032025
-- --------------------------------------------------

create PROC [dbo].[CHECKVERSION_bkp03032025]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '7=!9U92WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_11MAR2024
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION_BKUP_11MAR2024]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '1*:9/]/(<(7@!+87-\[:2-@5!'
SET @ERRCODE2 = '<<!9S32WJ639S8xTKD2 '
SET @ERRCODE3 = 'SY'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'J1 8Q'
SET @ERRCODE11 = 'R7'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'SYX'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_15Apr2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9T72WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_18Mar2024
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '<<!9R12WJ639S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_BKUP_20JAN2025
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-/-\8*{8''9>!'
SET @ERRCODE2 = '0=>9T22WJ629S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '6,'''
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'S6  M'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.chkBusinessDateStatus
-- --------------------------------------------------

CREATE Proc chkBusinessDateStatus AS
	Select 
		Count(1) 
	From 
		V2_BUSINESS_PROCESS (nolock)
	Where 
		Open_Close = 1 And 
		Left(Business_Date,11) = (Select Top 1 Left(ActivityTime,11) From FoTrade)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTHORIZED_COUNT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_AUTHORIZED_COUNT]    
(    
 @UNAME VARCHAR(30),    
 @ADMIN_NAME VARCHAR(30),  
 @CUREXCHSEG VARCHAR(50)      
)    
/*    
 CLASS_USER_COUNT 'Bha', 'ADMINISTRATOR', ''    
 SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DSS'    
EXEC CLASS_USER_COUNT 'SAMARTHLANJEKAR','Broker','NSE~~CAPITAL'  
  
*/    
AS    
 DECLARE      
 @@EXCHANGE AS VARCHAR(3),    
 @@SEGMENT AS VARCHAR(15),    
 @@SHARESVR AS VARCHAR(20),    
 @@SHAREDB   AS VARCHAR(20),    
 @@SEGORD AS TINYINT,    
 @@SQL  AS VARCHAR(500),    
 @@MAINREC AS CURSOR    
     
  CREATE TABLE [DBO].[#RESULT]      
  (      
  EXCHANGE VARCHAR(6),       
  SEGMENT VARCHAR(10),    
  RESULT VARCHAR(100)    
  ) ON [PRIMARY]    
      
 CREATE TABLE #USERS    
 (    
  FLDUSERNAME VARCHAR(30)    
 )    
    
 IF UPPER(@ADMIN_NAME) = 'ADMINISTRATOR'  
 BEGIN  
  SET @@MAINREC = CURSOR FOR       
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE PRIMARYSERVER = 1 ORDER BY 1     
 END  
 ELSE  
 BEGIN  
  SET @@MAINREC = CURSOR FOR    
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE EXCHANGE + '~~' + SEGMENT =  @CUREXCHSEG  AND PRIMARYSERVER = 1 ORDER BY 1  
 END    
     
 SET @@SEGORD = 1      
 OPEN @@MAINREC      
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR     
  WHILE @@FETCH_STATUS = 0    
   BEGIN    
   IF @@SHARESVR <> @@SERVERNAME AND 1 <> 1     
    BEGIN    
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU WHERE TP.FLDAUTO = TU.FLDUSERID AND FLDSTATUS <> 0 AND FLDUSERNAME = '"+ @UNAME +"' "    
    END    
    ELSE    
    BEGIN     
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME #USERS FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU WHERE TP.FLDAUTO = TU.FLDUSERID AND FLDSTATUS <> 0 AND FLDUSERNAME = '"+ @UNAME +"' "    
    END    
   PRINT(@@SQL)    
   EXEC(@@SQL)     
  --SELECT * FROM #USERS     
  IF @@ROWCOUNT <> 0    
   BEGIN    
   INSERT INTO #RESULT VALUES(@@EXCHANGE,@@SEGMENT,'USER AVAILABLE')    
   END     
      
 SET @@SEGORD = @@SEGORD + 1    
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR    
 END     
    
 SELECT * FROM #RESULT    
 DROP TABLE #RESULT    
 DROP TABLE #USERS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_ALERT
-- --------------------------------------------------

CREATE PROC [dbo].[CLASS_AUTO_PROCESS_ALERT]
AS
 
 
DECLARE @SNO NUMERIC(18,0),  
  @EXCHANGE VARCHAR(3),  
  @SEGMENT VARCHAR(7),  
  @BUSINESS_DATE VARCHAR(11),  
  @PROCESS_FOR VARCHAR(30),  
  @PROCESS_STATUS INT,  
  @PROCESS_START_DATE DATETIME,  
  @PROCESS_HALTED_REASON VARCHAR(500),  
  @PROCESS_FILE_NAME VARCHAR(500),  
  @SETT_NO  VARCHAR(10),  
  @SETT_TYPE  VARCHAR(10),  
  @TO_EMAIL_ID VARCHAR(500),  
  @CC_EMAIL_ID VARCHAR(500),  
  @BCC_EMAIL_ID VARCHAR(500),  
  @ALERT_CURSOR CURSOR,  
  @BODYTEXT  VARCHAR(MAX),  
  @SUBJECTTEXT    VARCHAR(MAX),  
  @PROCESS_OUTPUT_QUERY VARCHAR(MAX),  
  @XML NVARCHAR(MAX),  
  @INTERNAL_PROCESS_ID INT,  
  @ATTACHEMENT_FILE_NAME VARCHAR(200),  
  @FILE_DWLOAD_LOCATION VARCHAR(200),  
  @FILE_DWLOAD_NAME  VARCHAR(200)  
  
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
SET @ALERT_CURSOR = CURSOR FOR  
SELECT SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_FOR, PROCESS_STATUS, PROCESS_START_DATE,   
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(.DBO.FN_DATA_DECRYPT('MKTTECH.IN',D.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),  
PROCESS_HALTED_REASON = (CASE WHEN PROCESS_STATUS = 99   
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME > GETDATE() THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK'  
         ELSE 'NOACTION' END)  
         WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''  
         THEN 'NOT YET STARTED'  
         ELSE PROCESS_HALTED_REASON END),
TO_EMAIL_ID, CC_EMAIL_ID, BCC_EMAIL_ID,   
--TO_EMAIL_ID=CC_EMAIL_ID, CC_EMAIL_ID = '', BCC_EMAIL_ID = '',
PROCESS_OUTPUT_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(D.PROCESS_OUTPUT_QUERY,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),  
D.SETT_NO, LTRIM(RTRIM(D.SETT_TYPE)), INTERNAL_PROCESS_ID, ATTACHEMENT_FILE_NAME  
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL E, OWNER  
WHERE PROCESS_DATE = LEFT(GETDATE(),11)  
AND D.EXCHANGE = E.EXCHANGE  
AND D.SEGMENT = E.SEGMENT  
AND D.PROCESS_FOR = E.PROCESS_FOR  
AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT   
AND GETDATE() >= PROCESS_LAST_ALERT_DATE + ' ' + PROCESS_STATUS_ALERT_INTERVAL  
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD  
OR D.PROCESS_START_DATE <= GETDATE())  
AND 1 = (CASE WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''   
        THEN 0   
     ELSE 1  
   END)  
AND (CASE WHEN PROCESS_STATUS = 99   
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME > GETDATE() THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK'  
         ELSE 'NOACTION' END)  
         ELSE PROCESS_HALTED_REASON END) <> 'NOACTION'  
AND IS_DEPEND_ON = ''  
AND EMAIL_SEND_FLAG = 1  
ORDER BY SNO  
OPEN @ALERT_CURSOR  
FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,   
       @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,   
    @ATTACHEMENT_FILE_NAME  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @BODYTEXT = 'LIVE ALERT STATUS OF ' + @PROCESS_FOR + ' FOR THE EXCHANGE ' + @EXCHANGE + ' AND SEGMENT ' + @SEGMENT   
 IF LEN(@SETT_NO) <> ''   
 BEGIN  
  SET @BODYTEXT = @BODYTEXT + ' SETT NO - ' + CONVERT(VARCHAR,@SETT_NO) + ' AND SETT TYPE - ' + CONVERT(VARCHAR,@SETT_TYPE)  
 END  
 --SET @BODYTEXT = @BODYTEXT + ' FOR THE PROCESS NO - ' + CONVERT(VARCHAR,@SNO)  
 SET @SUBJECTTEXT = @BODYTEXT  
 SET @BODYTEXT = @BODYTEXT + ' <BR> ' + @PROCESS_HALTED_REASON   
 IF LEN(@PROCESS_FILE_NAME) > 0   
 BEGIN   
  IF @PROCESS_FILE_NAME NOT LIKE '%#%'  
  BEGIN  
   SET @BODYTEXT = @BODYTEXT + ' AS PER THE FILE ' + @PROCESS_FILE_NAME  
  END  
  ELSE  
  BEGIN  
   SELECT   
   @FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),  
   @FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE)))  
   FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),   
   TBL_AUTO_PROCESS_MASTER M,   
   OWNER O  
   WHERE PROCESS_DATE = LEFT(GETDATE(),11)  
   AND D.PROCESS_FOR = M.PROCESS_FOR  
   AND D.SNO = @SNO  
   SET @BODYTEXT = @BODYTEXT + ' NO NEW FILE PRESENT IN LOCATION ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME  
  END  
 END   
  
 IF @PROCESS_OUTPUT_QUERY <> '' AND @PROCESS_STATUS <> 0  
 BEGIN    
  --SET @PROCESS_OUTPUT_QUERY = 'EXECUTE SaveTableAsHTML @DBFetch = ''' + replace(@PROCESS_OUTPUT_QUERY,'''','''''') + ''''   
  
  --SET @PROCESS_OUTPUT_QUERY = ''''+replace(@PROCESS_OUTPUT_QUERY,'''','''''')+''''  
  --PRINT @PROCESS_OUTPUT_QUERY  
  
  exec SpCustomTable2HTML @PROCESS_OUTPUT_QUERY, @XML OUTPUT, ' border="1" cellpadding="2" cellspacing="0" style="font-size:14px";', ' style="color:blue;background-color:yellow;"'  
  --SELECT ISNULL(@XML,'')  
  SET @BODYTEXT = @BODYTEXT + ISNULL(@XML,'')  
    
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO  
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0  
  BEGIN  
   EXEC MSDB.DBO.SP_SEND_DBMAIL   
   @profile_name= 'DEL CLASS AUTO PROCESS ALERT Profile',  
   @RECIPIENTS=@TO_EMAIL_ID,  
   @BODY=@BODYTEXT,   
   @copy_recipients = @CC_EMAIL_ID,   
   @blind_copy_recipients = @BCC_EMAIL_ID,  
   @subject = @SUBJECTTEXT,  
   @body_format = 'HTML',  
   @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME  
  END  
 END  
 ELSE  
 BEGIN  
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO  
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0  
  BEGIN  
   EXEC MSDB.DBO.SP_SEND_DBMAIL   
   @profile_name= 'DEL CLASS AUTO PROCESS ALERT Profile',  
   @RECIPIENTS=@TO_EMAIL_ID,  
   @BODY=@BODYTEXT,   
   @copy_recipients = @CC_EMAIL_ID,   
   @blind_copy_recipients = @BCC_EMAIL_ID,  
   @subject = @SUBJECTTEXT,  
   @body_format = 'HTML',  
   @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME  
  END  
 END  
 UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS_ALERT_COUNT = PROCESS_STATUS_ALERT_COUNT + 1, PROCESS_LAST_ALERT_DATE = GETDATE()  
 WHERE SNO = @SNO  
 FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,   
           @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,   
     @ATTACHEMENT_FILE_NAME   
END  
CLOSE @ALERT_CURSOR  
DEALLOCATE @ALERT_CURSOR  
  
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER]   
(  
 @TYPE varchar(1),  
 @PROCESSFOR varchar(30) ='SELECT',  
 @PROCESSTYPE varchar(30)='SELECT'  
)   
AS    
  
-- EXEC CLASS_AUTO_PROCESS_EDIT_MASTER 'E', 'SELECT','SELECT'  
BEGIN    
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 IF @TYPE='P'  
 BEGIN  
  SELECT     
   SNO,PROCESS_TYPE,PROCESS_FOR,    
   PROCESS_START_TIME = LEFT(PROCESS_START_TIME,5),      
   PROCESS_END_TIME = LEFT(PROCESS_END_TIME,5) ,    
   IS_FILE_BASED,    
   FILE_DWLOAD_LOCATION=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION),    
   FILE_DWLOAD_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_NAME),    
   FILE_DWLOAD_USERID=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),    
   FILE_DWLOAD_PWD=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),    
   FILE_DWLOAD_MAP_DRIVE,    
   PROCESS_FILE_PATH=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_PATH),    
   PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME),    
   PROCESS_FILE_MOVE_PATH =.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_MOVE_PATH)     
  FROM  TBL_AUTO_PROCESS_MASTER    
  WHERE PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN PROCESS_FOR ELSE @PROCESSFOR END)  
  AND   PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
  ORDER BY PROCESS_TYPE,IS_FILE_BASED    
 END  
 IF @TYPE='E'  
 BEGIN  
  SELECT E.PROCESS_FOR,TO_EMAIL_ID,CC_EMAIL_ID,BCC_EMAIL_ID,EMAIL_SEND_FLAG  FROM TBL_AUTO_PROCESS_EMAIL E,  
  TBL_AUTO_PROCESS_MASTER M  
  WHERE E.PROCESS_FOR = M.PROCESS_FOR  
  AND E.PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN E.PROCESS_FOR ELSE @PROCESSFOR END)  
  AND PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
 END  
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE
-- --------------------------------------------------

  
CREATE procedure [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE]  
(  
 @PROCESSDATA VARCHAR(MAX),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @UNAME VARCHAR(50),  
 @REQIP VARCHAR(200)  
)  
AS  
BEGIN  
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 CREATE TABLE #DATA (FDATA VARCHAR(MAX))    
 INSERT INTO #DATA     
 SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|')   
   
 UPDATE TBL_AUTO_PROCESS_MASTER SET     
  PROCESS_START_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),  
  PROCESS_END_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),  
  IS_FILE_BASED = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),  
  FILE_DWLOAD_LOCATION = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))),  
  FILE_DWLOAD_NAME = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 6)))),  
  FILE_DWLOAD_USERID = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 7)))),  
  FILE_DWLOAD_PWD = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 8)))),  
  FILE_DWLOAD_MAP_DRIVE = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 9))),  
  PROCESS_FILE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 10)))),  
  PROCESS_FILE_NAME  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 11)))),  
  PROCESS_FILE_MOVE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 12))))  
 FROM #DATA B    
 WHERE SNO = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))  
 AND FDATA<>''  
  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
   
 SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE
-- --------------------------------------------------

CREATE procedure [dbo].[CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE]
(
	@PROCESSDATA VARCHAR(MAX),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@UNAME VARCHAR(50),
	@REQIP VARCHAR(200)
)
AS
BEGIN
	CREATE TABLE #DATA (FDATA VARCHAR(MAX))  
	INSERT INTO #DATA   
	SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|') 
	
	UPDATE TBL_AUTO_PROCESS_EMAIL SET   
		TO_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),
		CC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),
		BCC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),
		EMAIL_SEND_FLAG = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))
	FROM #DATA B  
	WHERE PROCESS_FOR = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))
	AND FDATA<>''
	
	SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_FILE
-- --------------------------------------------------


CREATE PROC [dbo].[CLASS_AUTO_PROCESS_FILE] (@FILEPATH VARCHAR(100), @BUSINESS_DATE VARCHAR(11), @FLD_FILEDATE DATETIME OUTPUT, @FLD_FILENAME VARCHAR(200) OUTPUT)      
AS       
    
SET @FILEPATH = 'DIR "' +@FILEPATH + '" /C' 

CREATE TABLE #FILELIST       
( FILENAMELIST VARCHAR(100))      
INSERT INTO #FILELIST       
EXEC MASTER.DBO.XP_CMDSHELL @FILEPATH     
 
UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')
WHERE FILENAMELIST IS NOT NULL
AND FILENAMELIST LIKE '%'
AND FILENAMELIST LIKE '%/%'

SELECT FLD_FILEDATE=CONVERT(DATETIME,LEFT(CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),101),11) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',3))) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',4)))),
FLD_FILENAME=LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1))))
INTO #FILELISTNEW   
FROM #FILELIST 
WHERE FILENAMELIST IS NOT NULL
AND FILENAMELIST LIKE '%'
AND FILENAMELIST LIKE '%/%'
AND LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1)))) LIKE '%.%'

DELETE FROM #FILELISTNEW
WHERE FLD_FILEDATE + ' 00:05' > GETDATE()

SELECT TOP 1 @FLD_FILEDATE = FLD_FILEDATE, @FLD_FILENAME = FLD_FILENAME FROM #FILELISTNEW N
WHERE FLD_FILEDATE LIKE @BUSINESS_DATE + '%'
AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE F
						 WHERE F.FLD_FILEDATE LIKE @BUSINESS_DATE + '%'
						 AND N.FLD_FILEDATE = F.FLD_FILEDATE)
ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_LISNER
-- --------------------------------------------------




CREATE  PROC [dbo].[CLASS_AUTO_PROCESS_LISNER]
AS

DECLARE 
  @SNO     NUMERIC(18,0),  
  @BUSINESS_DATE   VARCHAR(11),          
  @PROCESS_FOR   VARCHAR(30),          
  @FILE_DWLOAD_LOCATION VARCHAR(200),          
  @PROCESS_FILE_NAME  VARCHAR(200),          
  @PROCESS_FILE_NAME_NEW VARCHAR(200),          
  @FILE_DWLOAD_PATH VARCHAR(200),          
  @FILE_DWLOAD_USERID  VARCHAR(100),          
  @FILE_DWLOAD_PWD  VARCHAR(100), 
  @PROCESS_CURSOR   CURSOR,
  @CMD				VARCHAR(MAX),
  @FLD_FILEDATE   DATETIME,          
  @FLD_FILENAME		VARCHAR(200),
  @PROCESS_SET		VARCHAR(100),
  @PROCESS_TYPE		VARCHAR(10),
  @LST_CNT			INT,
  @PRC_CNT			INT

SELECT * INTO #FILEDATA
FROM TBL_AUTO_PROCESS_FILE
WHERE PROCESS_ON LIKE LEFT(GETDATE(),11) + '%'

UPDATE TBL_AUTO_PROCESS_LISNER_LOG SET PROCESS_FLAG = 2 
FROM #FILEDATA F
WHERE TBL_AUTO_PROCESS_LISNER_LOG.BUSINESS_DATE = LEFT(FLD_FILEDATE,11)
AND PROCESS_FILE_NAME = FLD_FILENAME

OPEN SYMMETRIC KEY   KEY4CERTAUTOPROCESS          
     DECRYPTION BY   CERTIFICATE CERTAUTOPROCESS   
SET @PROCESS_CURSOR = CURSOR FOR 
SELECT D.SNO, L.PROCESS_FOR, L.PROCESS_TYPE, L.PROCESS_FILE_NAME, BUSINESS_DATE = LEFT(BUSINESS_DATE,11), 
FILE_DWLOAD_LOCATION=PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(L.PROCESS_FILE_PATH,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))), 
FILE_COPY_LOCATION=PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))), 
FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), 
FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),
PROCESS_SET
FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D, TBL_AUTO_PROCESS_MASTER M, OWNER
WHERE PROCESS_DATE = LEFT(GETDATE(),11)
AND L.PROCESS_FOR = D.PROCESS_FOR
AND L.PROCESS_FOR = M.PROCESS_FOR
AND L.PROCESS_FOR NOT IN (SELECT P.PROCESS_FOR FROM TBL_AUTO_PROCESS_LISNER_LOG P WHERE P.BUSINESS_DATE = D.BUSINESS_DATE
						AND P.PROCESS_FOR = D.PROCESS_FOR AND PROCESS_FLAG = 1)
AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)
AND GETDATE() BETWEEN CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_START_TIME) AND CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_END_TIME)
AND L.PROCESS_TYPE IN ('F', 'C') AND PROCESS_FREQ = 'RECCUR'
OPEN @PROCESS_CURSOR
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET
WHILE @@FETCH_STATUS = 0
BEGIN
	SELECT @LST_CNT = 0 
	SELECT @PRC_CNT = 0
	--select @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET

	SELECT @LST_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L WHERE PROCESS_SET = @PROCESS_SET AND PROCESS_TYPE = ''

	SELECT @PRC_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D 
	WHERE PROCESS_DATE = LEFT(GETDATE(),11)
	AND L.PROCESS_FOR = D.PROCESS_FOR
	AND PROCESS_SET = @PROCESS_SET AND L.PROCESS_TYPE = ''
	AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)

	IF @LST_CNT = @PRC_CNT
	BEGIN
		IF @PROCESS_TYPE = 'F'
		BEGIN
			SET @FILE_DWLOAD_PATH = REPLACE(@FILE_DWLOAD_PATH, '\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-'),'')

			set @cmd = 'exec xp_cmdshell ''net use "' + @FILE_DWLOAD_PATH + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'          
			exec (@cmd) 

			SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-') + ''', NO_OUTPUT'          
			EXEC (@CMD)  

			set @cmd = 'exec xp_cmdshell ''net use ' + @FILE_DWLOAD_PATH + ' /delete'', no_output'          
			exec (@cmd)    

			SET @FILE_DWLOAD_PATH = @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-')

			set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_path + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'          
			exec (@cmd) 
		END

		set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_location + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'          
		exec (@cmd) 
		
		SET @PROCESS_FILE_NAME_NEW = @file_dwload_location + '\' + @PROCESS_FILE_NAME   

		SET @FLD_FILENAME = '' 

		EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT               
		 
		IF ISNULL(@FLD_FILENAME,'') <> ''
		BEGIN
			IF @PROCESS_TYPE = 'F'
			BEGIN
				SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @file_dwload_location + '\' + @FLD_FILENAME + ' ' + @file_dwload_path + '\' + @FLD_FILENAME + ''', NO_OUTPUT'          
				EXEC (@CMD)  

				INSERT INTO TBL_AUTO_PROCESS_LISNER_LOG VALUES (@BUSINESS_DATE, @PROCESS_FOR, @FLD_FILENAME, 1, GETDATE())
			END

			UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON_ORG,'#-1,',''), PROCESS_STATUS = 0, PROCESS_HALTED_REASON = ''
			FROM TBL_AUTO_PROCESS_LISNER L
			WHERE PROCESS_DATE = LEFT(GETDATE(),11) AND (IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)
			AND L.PROCESS_FOR = TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR
			AND PROCESS_SET = @PROCESS_SET
		END

		set @cmd = 'exec xp_cmdshell ''net use ' + @file_dwload_location + ' /delete'', no_output'          
		exec (@cmd)    

		set @cmd = 'exec xp_cmdshell ''net use ' + @file_dwload_path + ' /delete'', no_output'          
		exec (@cmd)   
	END

	FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET
END
CLOSE @PROCESS_CURSOR
DEALLOCATE @PROCESS_CURSOR

CLOSE SYMMETRIC KEY   KEY4CERTAUTOPROCESS;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_PRM
-- --------------------------------------------------



--exec msajag.dbo.CLASS_AUTO_PROCESS_PRM @FOR='3' 
--exec ANGELFO.BSEMFSS.dbo.CLASS_AUTO_PROCESS_PRM @FOR='1'
CREATE   PROCEDURE [dbo].[CLASS_AUTO_PROCESS_PRM]      
(      
 @FOR VARCHAR(2)      
)      
AS      
BEGIN      
 IF @FOR='1'      
  BEGIN      
   SELECT DISTINCT PROCESS_TYPE FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='2'      
  BEGIN      
   SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='3'      
  BEGIN      
   SELECT DISTINCT  UPPER(LTRIM(RTRIM(EXCHANGE))) , UPPER(LTRIM(RTRIM(SEGMENT))),(CASE WHEN PRIMARYSERVER = 1 
   THEN 'PRIMARY-' ELSE 'DELIVERY-' END) + UPPER(LTRIM(RTRIM(EXCHANGE))) +'-'+ UPPER(LTRIM(RTRIM(SEGMENT)))
    AS SEGMENT,SERVERNAME = SHARESERVER+ '.'
  
 + SHAREDB + '.dbo.'  FROM PRADNYA.DBO.MULTICOMPANY  WHERE SHAREDB IN ('BSEDB','Msajag','NSEFO','NSECURFO','NCDX','MCDX','NSESLBS')  
 /*union all
     SELECT DISTINCT EXCHANGE = 'BSE', SEGMENT='MFSS',  
	'BSE-MFSS'
    AS SEGMENT,SERVERNAME = 'ANGELFO.BSEMFSS.dbo.'    
     ORDER BY 2,1 DESC    */    
    
  END      
END      
    
-- exec CLASS_AUTO_PROCESS_PRM 3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETTLEMENT
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_SETTLEMENT]
(	
	@PROCESS_DATE VARCHAR(11)
)
AS

--EXEC CLASS_AUTO_PROCESS_SETTLEMENT 'NOV 28 2014'
SET @PROCESS_DATE = LEFT(GETDATE(),11)

DECLARE @SNO					NUMERIC(18,0),
		@EXCHANGE				VARCHAR(3),
		@SEGMENT				VARCHAR(7),
		@BUSINESS_DATE			VARCHAR(11),
		@PROCESS_FOR			VARCHAR(30),
		@INTERNAL_PROCESS_ID	INT,
		@FILE_DWLOAD_LOCATION	VARCHAR(200),
		@FILE_DWLOAD_NAME		VARCHAR(200),
		@FILE_DWLOAD_NAME_TEMP	varchar(200),
		@FILE_DWLOAD_MAP_DRIVE	VARCHAR(100),
		@FILE_DWLOAD_USERID		VARCHAR(100),
		@FILE_DWLOAD_PWD		VARCHAR(100),
		@PROCESS_FILE_PATH		VARCHAR(200),
		@PROCESS_FILE_NAME		VARCHAR(200),
		@PROCESS_FILE_NAME_NEW	VARCHAR(200),
		@PROCESS_FILE_MOVE_PATH	VARCHAR(200),
		@PROCESS_SP_NAME		VARCHAR(8000),
		@PROCESS_CHECK_QUERY	VARCHAR(MAX),
		@PROCESS_HALTED_REASON	VARCHAR(500),
		@FILE_INTERNET_LOCATION	VARCHAR(500),
		@FILE_INTERNAL_ISS_PATH	VARCHAR(500),
		@PROCESS_CURSOR			CURSOR,
		@IS_FILE_BASED			VARCHAR(1),
		@PROCESS_ID				INT,
		@SUB_PROCESS_ID			INT,
		@ISEXISTS				INT,
		@ERRFLAG				INT,
		@CMD					VARCHAR(8000),
		@TIME					VARCHAR(8),
		@CHKFLAG				INT,
		@MYOUTPUT				VARCHAR(MAX),
		@OTHER_DBDETAILS		VARCHAR(200), 
		@OTHER_PROCESS_FOR		VARCHAR(200), 
		@SETT_NO				VARCHAR(20), 
		@SETT_TYPE				VARCHAR(20),
		@FLD_FILEDATE			DATETIME,
		@FLD_FILENAME			VARCHAR(200)

SET NOCOUNT ON
SET @ERRFLAG = 0
SET @CHKFLAG = 1

OPEN SYMMETRIC KEY   Key4CertAutoProcess
     DECRYPTION BY   CERTIFICATE CertAutoProcess 

SET @PROCESS_CURSOR = CURSOR FOR		

SELECT  
DISTINCT D.SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_ID, D.INTERNAL_PROCESS_ID, D.PROCESS_FOR, 
PROCESS_FILE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_FILE_MOVE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_MOVE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_SP_NAME = Replace(Replace(Replace(PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_SP_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),'<FileName>',
					  '''' + PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + 
					  PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + ''''),
					  '<SNO>',D.Sno),'<SUBPROCESSID>',D.SUB_PROCESS_ID),
PROCESS_CHECK_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_CHECK_QUERY),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
IS_FILE_BASED,
FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
FILE_DWLOAD_MAP_DRIVE, FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),
FILE_INTERNET_LOCATION, FILE_INTERNAL_ISS_PATH, SUB_PROCESS_ID, OTHER_DBDETAILS, OTHER_PROCESS_FOR, D.SETT_NO, D.SETT_TYPE
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), 
     TBL_AUTO_PROCESS_MASTER M (NOLOCK), 
	 OWNER O
WHERE PROCESS_DATE = LEFT(GETDATE(),11)
AND D.PROCESS_FOR = M.PROCESS_FOR
AND D.INTERNAL_PROCESS_ID = M.INTERNAL_PROCESS_ID
AND D.PROCESS_STATUS = 0
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD
OR D.PROCESS_START_DATE <= GETDATE())
AND (D.PROCESS_END_DATE + D.WAIT_PERIOD >= GETDATE() 
OR D.PROCESS_END_DATE >= GETDATE())
AND D.IS_DEPEND_ON = ''
AND IS_FILE_BASED <> ''
ORDER BY D.SNO

OPEN @PROCESS_CURSOR
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									 @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY, 
									 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
									 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									 @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
WHILE @@FETCH_STATUS = 0
BEGIN

	/*
	SELECT @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									 @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY, 
									 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
									 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									 @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
	*/

	
 --print @PROCESS_FILE_PATH
 --print @PROCESS_SP_NAME
 --print @PROCESS_FILE_NAME


	SET @PROCESS_FILE_NAME_NEW = ''
	SET @FLD_FILENAME = ''

	SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
	WHERE PROCESS_DATE = @PROCESS_DATE 
	AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
	AND PROCESS_FOR = @PROCESS_FOR
	AND PROCESS_STATUS NOT IN (0, 100)
	IF @CHKFLAG = 1 
	BEGIN
		SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'
	END	

	IF @CHKFLAG = 0 
	BEGIN
		SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
		WHERE PROCESS_DATE = @PROCESS_DATE 
		AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
		AND INTERNAL_PROCESS_ID = (CASE WHEN @INTERNAL_PROCESS_ID = 0 
										THEN -1 
										ELSE @INTERNAL_PROCESS_ID 
								   END)
		AND PROCESS_STATUS NOT IN (0, 100)
		IF @CHKFLAG = 1 
		BEGIN
			SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'
		END	
	END
			
	IF @CHKFLAG = 0 
	BEGIN
		IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
			WHERE SNO = @SNO
			AND PROCESS_STATUS = 0) = 0
		BEGIN
			SET @CHKFLAG = -1 
		END
	END
	IF @CHKFLAG = 0 
	BEGIN
		SET @ISEXISTS = 0 
		IF (@IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'F' OR @IS_FILE_BASED = 'I') AND @SUB_PROCESS_ID = 0
		BEGIN
			IF @FILE_DWLOAD_LOCATION <> ''
			BEGIN
				IF @IS_FILE_BASED = 'I'
				BEGIN
					SET @PROCESS_FILE_NAME_NEW = @FILE_INTERNAL_ISS_PATH + @FILE_INTERNET_LOCATION + '&FILENAME=' + @FILE_DWLOAD_NAME
					EXEC HTTP_REQUEST @PROCESS_FILE_NAME_NEW, @MYOUTPUT 
				END
				
				IF @IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'I'
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)

					SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_MAP_DRIVE + ' ' + @FILE_DWLOAD_LOCATION + ' /USER:' + @FILE_DWLOAD_USERID + ' ' + @FILE_DWLOAD_PWD + ' /persistent:Y'', NO_OUTPUT'
					SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE
					
					EXEC (@CMD)

					IF @FILE_DWLOAD_NAME LIKE '%*%'
					BEGIN
						SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,@PROCESS_FILE_NAME,'#')
						SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME
						EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT					
						
						SET @FILE_DWLOAD_NAME = @FLD_FILENAME
						IF @FILE_DWLOAD_NAME <> ''
						BEGIN
							IF @PROCESS_FILE_NAME NOT LIKE '%#%' 
							BEGIN
								SET @PROCESS_FILE_NAME = @FLD_FILENAME
							END
							ELSE
							BEGIN		
								SET @PROCESS_FILE_NAME = LEFT(@FLD_FILENAME, LEN(@FILE_DWLOAD_NAME)-LEN(.DBO.PIECE(@PROCESS_FILE_NAME,'#',1))) + .DBO.PIECE(@PROCESS_FILE_NAME,'#',2)
							END
							SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,'#',@PROCESS_FILE_NAME)	
										
						END
						ELSE
						BEGIN
							SET @PROCESS_FILE_NAME = ''
						END
					END
					IF @FILE_DWLOAD_NAME <> ''
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT'
						EXEC (@CMD)

						IF @IS_FILE_BASED = 'I'
						BEGIN
							SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '
							EXEC (@CMD)
						END

						SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_MAP_DRIVE + ' /delete'', NO_OUTPUT'
						EXEC (@CMD)
					END 
				END
				ELSE
				IF @IS_FILE_BASED = 'F'
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)
					--SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE
					SET @FILE_DWLOAD_NAME_TEMP = @FILE_DWLOAD_NAME + '_1'
					SELECT  @cmd = 'echo '+ 'open ' + @FILE_DWLOAD_LOCATION+ ' > ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ @FILE_DWLOAD_USERID+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ @FILE_DWLOAD_PWD+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
										select  @cmd = 'echo '+ 'dir ' + @file_dwload_map_drive + @file_dwload_name + ' >> ' + @process_file_path + @file_dwload_name_temp
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ 'get ' + @FILE_DWLOAD_MAP_DRIVE + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ 'quit'+ ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					-- Executing steps from working file
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT

					CREATE TABLE #FILELIST       
					( 
						FILENAMELIST VARCHAR(MAX)
					) 

					SELECT  @cmd = 'ftp -s:' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					-- Executing final step
					INSERT INTO #FILELIST
					EXEC master..xp_cmdshell @cmd--, NO_OUTPUT

					SELECT * FROM #FILELIST

					DELETE FROM #FILELIST
					WHERE FILENAMELIST IS  NULL

					DELETE FROM #FILELIST
					WHERE FILENAMELIST NOT LIKE '%' + @FILE_DWLOAD_NAME + '%'

					DELETE FROM #FILELIST
					WHERE FILENAMELIST LIKE 'DIR%'

					DELETE FROM #FILELIST
					WHERE FILENAMELIST LIKE 'GET%'

					UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')

					SET @FLD_FILEDATE = '1900-01-01'

					SELECT @FLD_FILEDATE = CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),1)
					FROM #FILELIST

					IF LEFT(@FLD_FILEDATE,11) <> @BUSINESS_DATE
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @process_file_path + @file_dwload_name + '''--, NO_OUTPUT '
						EXEC (@CMD)
					END
					SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP + ''', NO_OUTPUT '
					EXEC (@CMD)

					DROP TABLE #FILELIST
				END
			END
			IF @PROCESS_FILE_NAME <> ''
			BEGIN
				SET @PROCESS_FILE_NAME_NEW = @PROCESS_FILE_PATH + @PROCESS_FILE_NAME
				IF PRADNYA.DBO.CHECKZIPFILE(@FILE_DWLOAD_NAME) > 0
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''"C:\program files\Winzip\WZUNZIP.exe" -yb -o ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					
					print @cmd
					EXEC (@CMD)

					SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '
					EXEC (@CMD)
				END
			END
			
		--	PRINT @PROCESS_FILE_NAME_NEW
			
			EXEC MASTER.DBO.XP_FILEEXIST @PROCESS_FILE_NAME_NEW, @ISEXISTS OUTPUT
			IF @ISEXISTS = 0 
			BEGIN
				UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = 'FILE NOT AVAILABLE IN THE SPECIFIED LOCATION.',
				PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()
				WHERE SNO = @SNO
			END
			ELSE
			BEGIN			
				SET @ERRFLAG = 0
				UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))
				WHERE SNO = @SNO
				BEGIN
					BEGIN TRAN
						BEGIN TRY
							SET @CMD = @PROCESS_SP_NAME 
							print @cmd
							EXEC (@CMD)
						END TRY
						BEGIN CATCH
							ROLLBACK TRAN
							UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),
							PROCESS_STATUS = 0
							WHERE SNO = @SNO
							SET @ERRFLAG = 1
						END CATCH
						
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_MOVE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)
					SELECT @TIME = REPLACE(CONVERT(VARCHAR,GETDATE(),108),':','')
					IF LEN(@PROCESS_FILE_MOVE_PATH) > 0 
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''MOVE ' + @PROCESS_FILE_NAME_NEW + ' ' + @PROCESS_FILE_MOVE_PATH + @PROCESS_FILE_NAME + @TIME + ''', NO_OUTPUT'
					END
					ELSE
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_NAME_NEW + ''', NO_OUTPUT'
					END
					EXEC (@CMD)

					IF @ERRFLAG = 0      
					BEGIN	
						INSERT INTO TBL_AUTO_PROCESS_FILE VALUES (@FLD_FILENAME, @FLD_FILEDATE, GETDATE())
						COMMIT TRAN
						
						IF LEN(@PROCESS_CHECK_QUERY) > 0 
						BEGIN
							SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''
							SET @CMD = @CMD + ' IF (@RECCNT) > 0 '
							SET @CMD = @CMD + ' BEGIN '
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','
							SET @CMD = @CMD + '		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
							
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
							SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
							SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
							SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
							SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
							
							IF @OTHER_DBDETAILS <> ''
							BEGIN
								SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
								SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
								SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
								SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
								SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
								SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
							END
							SET @CMD = @CMD + ' END '
							SET @CMD = @CMD + ' ELSE ' 
							SET @CMD = @CMD + ' BEGIN ' 
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET '
							SET @CMD = @CMD + '		PROCESS_HALTED_REASON = @MSG,'
							SET @CMD = @CMD + '		PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
							SET @CMD = @CMD + ' END '
							EXEC (@CMD)
						END
						ELSE
						BEGIN
							SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '
							SET @CMD = @CMD + ' BEGIN '

							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
							SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
							SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
							SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
							SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
							IF @OTHER_DBDETAILS <> ''
							BEGIN
								SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
								SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
								SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
								SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
								SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
								SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
							END
							SET @CMD = @CMD + ' END '
							EXEC (@CMD)
						END
					END				
				END
			END
		END
		ELSE
		BEGIN
			SET @ERRFLAG = 0
			UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))
			WHERE SNO = @SNO	
			BEGIN TRAN		
				BEGIN TRY
					SET @CMD = @PROCESS_SP_NAME 
					PRINT @CMD
					EXEC (@CMD)
				END TRY
				BEGIN CATCH
					ROLLBACK TRAN

					UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),
					PROCESS_STATUS = 0
					WHERE SNO = @SNO
					SET @ERRFLAG = 1
				END CATCH
			IF @ERRFLAG = 0      
			BEGIN
				COMMIT TRAN

				IF LEN(@PROCESS_CHECK_QUERY) > 0 
				Begin
					SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''
					SET @CMD = @CMD + ' IF (@RECCNT) > 0 '
					SET @CMD = @CMD + ' BEGIN '
					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','
					SET @CMD = @CMD + '		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '

					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
					SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
					SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
					SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
					SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
					IF @OTHER_DBDETAILS <> ''
					BEGIN
						SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
						SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
						SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
						SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
						SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
						SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
					END

					SET @CMD = @CMD + ' END '
					SET @CMD = @CMD + ' ELSE ' 
					SET @CMD = @CMD + ' BEGIN ' 
					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET '
					SET @CMD = @CMD + '		PROCESS_HALTED_REASON = @MSG,'
					SET @CMD = @CMD + '		PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
					SET @CMD = @CMD + ' END '
					EXEC (@CMD)
				END
				ELSE
				BEGIN
					SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '
					SET @CMD = @CMD + ' BEGIN '

					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
					SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
					SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
					SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
					SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
					IF @OTHER_DBDETAILS <> ''
					BEGIN
						SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
						SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
						SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
						SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
						SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
						SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
					END
					SET @CMD = @CMD + ' END '
					EXEC (@CMD)
				END
			END
		END
	END
	ELSE
	BEGIN
		IF @CHKFLAG = 1 
		BEGIN
			UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @PROCESS_HALTED_REASON,
			PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()
			WHERE SNO = @SNO AND PROCESS_STATUS = 0
		END
	END
	FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									     @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,
										 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
										 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									     @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
END
CLOSE @PROCESS_CURSOR
DEALLOCATE @PROCESS_CURSOR

CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

EXEC CLASS_AUTO_PROCESS_ALERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETTLEMENT_bkup
-- --------------------------------------------------


create PROCEDURE [dbo].[CLASS_AUTO_PROCESS_SETTLEMENT_bkup]
(	
	@PROCESS_DATE VARCHAR(11)
)
AS

--EXEC CLASS_AUTO_PROCESS_SETTLEMENT 'NOV 28 2014'
SET @PROCESS_DATE = LEFT(GETDATE(),11)

DECLARE @SNO					NUMERIC(18,0),
		@EXCHANGE				VARCHAR(3),
		@SEGMENT				VARCHAR(7),
		@BUSINESS_DATE			VARCHAR(11),
		@PROCESS_FOR			VARCHAR(30),
		@INTERNAL_PROCESS_ID	INT,
		@FILE_DWLOAD_LOCATION	VARCHAR(200),
		@FILE_DWLOAD_NAME		VARCHAR(200),
		@FILE_DWLOAD_NAME_TEMP	varchar(200),
		@FILE_DWLOAD_MAP_DRIVE	VARCHAR(100),
		@FILE_DWLOAD_USERID		VARCHAR(100),
		@FILE_DWLOAD_PWD		VARCHAR(100),
		@PROCESS_FILE_PATH		VARCHAR(200),
		@PROCESS_FILE_NAME		VARCHAR(200),
		@PROCESS_FILE_NAME_NEW	VARCHAR(200),
		@PROCESS_FILE_MOVE_PATH	VARCHAR(200),
		@PROCESS_SP_NAME		VARCHAR(8000),
		@PROCESS_CHECK_QUERY	VARCHAR(MAX),
		@PROCESS_HALTED_REASON	VARCHAR(500),
		@FILE_INTERNET_LOCATION	VARCHAR(500),
		@FILE_INTERNAL_ISS_PATH	VARCHAR(500),
		@PROCESS_CURSOR			CURSOR,
		@IS_FILE_BASED			VARCHAR(1),
		@PROCESS_ID				INT,
		@SUB_PROCESS_ID			INT,
		@ISEXISTS				INT,
		@ERRFLAG				INT,
		@CMD					VARCHAR(8000),
		@TIME					VARCHAR(8),
		@CHKFLAG				INT,
		@MYOUTPUT				VARCHAR(MAX),
		@OTHER_DBDETAILS		VARCHAR(200), 
		@OTHER_PROCESS_FOR		VARCHAR(200), 
		@SETT_NO				VARCHAR(20), 
		@SETT_TYPE				VARCHAR(20),
		@FLD_FILEDATE			DATETIME,
		@FLD_FILENAME			VARCHAR(200)

SET NOCOUNT ON
SET @ERRFLAG = 0
SET @CHKFLAG = 1

OPEN SYMMETRIC KEY   Key4CertAutoProcess
     DECRYPTION BY   CERTIFICATE CertAutoProcess 

SET @PROCESS_CURSOR = CURSOR FOR		

SELECT  
DISTINCT D.SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_ID, D.INTERNAL_PROCESS_ID, D.PROCESS_FOR, 
PROCESS_FILE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_FILE_MOVE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_MOVE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
PROCESS_SP_NAME = Replace(Replace(Replace(PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_SP_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),'<FileName>',
					  '''' + PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + 
					  PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + ''''),
					  '<SNO>',D.Sno),'<SUBPROCESSID>',D.SUB_PROCESS_ID),
PROCESS_CHECK_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_CHECK_QUERY),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
IS_FILE_BASED,
FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),
FILE_DWLOAD_MAP_DRIVE, FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),
FILE_INTERNET_LOCATION, FILE_INTERNAL_ISS_PATH, SUB_PROCESS_ID, OTHER_DBDETAILS, OTHER_PROCESS_FOR, D.SETT_NO, D.SETT_TYPE
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), 
     TBL_AUTO_PROCESS_MASTER M (NOLOCK), 
	 OWNER O
WHERE PROCESS_DATE = LEFT(GETDATE(),11)
AND D.PROCESS_FOR = M.PROCESS_FOR
AND D.INTERNAL_PROCESS_ID = M.INTERNAL_PROCESS_ID
AND D.PROCESS_STATUS = 0
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD
OR D.PROCESS_START_DATE <= GETDATE())
AND (D.PROCESS_END_DATE + D.WAIT_PERIOD >= GETDATE() 
OR D.PROCESS_END_DATE >= GETDATE())
AND D.IS_DEPEND_ON = ''
AND IS_FILE_BASED <> ''
ORDER BY D.SNO

OPEN @PROCESS_CURSOR
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									 @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY, 
									 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
									 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									 @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
WHILE @@FETCH_STATUS = 0
BEGIN

	/*
	SELECT @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									 @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY, 
									 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
									 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									 @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
	*/

	
 print @PROCESS_FILE_PATH
 print @PROCESS_SP_NAME
 print @PROCESS_FILE_NAME


	SET @PROCESS_FILE_NAME_NEW = ''
	SET @FLD_FILENAME = ''

	SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
	WHERE PROCESS_DATE = @PROCESS_DATE 
	AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
	AND PROCESS_FOR = @PROCESS_FOR
	AND PROCESS_STATUS NOT IN (0, 100)
	IF @CHKFLAG = 1 
	BEGIN
		SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'
	END	

	IF @CHKFLAG = 0 
	BEGIN
		SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
		WHERE PROCESS_DATE = @PROCESS_DATE 
		AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
		AND INTERNAL_PROCESS_ID = (CASE WHEN @INTERNAL_PROCESS_ID = 0 
										THEN -1 
										ELSE @INTERNAL_PROCESS_ID 
								   END)
		AND PROCESS_STATUS NOT IN (0, 100)
		IF @CHKFLAG = 1 
		BEGIN
			SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'
		END	
	END
			
	IF @CHKFLAG = 0 
	BEGIN
		IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)
			WHERE SNO = @SNO
			AND PROCESS_STATUS = 0) = 0
		BEGIN
			SET @CHKFLAG = -1 
		END
	END
	IF @CHKFLAG = 0 
	BEGIN
		SET @ISEXISTS = 0 
		IF (@IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'F' OR @IS_FILE_BASED = 'I') AND @SUB_PROCESS_ID = 0
		BEGIN
			IF @FILE_DWLOAD_LOCATION <> ''
			BEGIN
				IF @IS_FILE_BASED = 'I'
				BEGIN
					SET @PROCESS_FILE_NAME_NEW = @FILE_INTERNAL_ISS_PATH + @FILE_INTERNET_LOCATION + '&FILENAME=' + @FILE_DWLOAD_NAME
					EXEC HTTP_REQUEST @PROCESS_FILE_NAME_NEW, @MYOUTPUT 
				END
				
				IF @IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'I'
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)

					SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_MAP_DRIVE + ' ' + @FILE_DWLOAD_LOCATION + ' /USER:' + @FILE_DWLOAD_USERID + ' ' + @FILE_DWLOAD_PWD + ' /persistent:Y'', NO_OUTPUT'
					EXEC (@CMD)

					IF @FILE_DWLOAD_NAME LIKE '%*%'
					BEGIN
						SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,@PROCESS_FILE_NAME,'#')
						SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME
						EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT					
						
						SET @FILE_DWLOAD_NAME = @FLD_FILENAME
						IF @FILE_DWLOAD_NAME <> ''
						BEGIN
							IF @PROCESS_FILE_NAME NOT LIKE '%#%' 
							BEGIN
								SET @PROCESS_FILE_NAME = @FLD_FILENAME
							END
							ELSE
							BEGIN		
								SET @PROCESS_FILE_NAME = LEFT(@FLD_FILENAME, LEN(@FILE_DWLOAD_NAME)-LEN(.DBO.PIECE(@PROCESS_FILE_NAME,'#',1))) + .DBO.PIECE(@PROCESS_FILE_NAME,'#',2)
							END
							SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,'#',@PROCESS_FILE_NAME)	
										
						END
						ELSE
						BEGIN
							SET @PROCESS_FILE_NAME = ''
						END
					END
					IF @FILE_DWLOAD_NAME <> ''
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT'
						EXEC (@CMD)

						IF @IS_FILE_BASED = 'I'
						BEGIN
							SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @FILE_DWLOAD_MAP_DRIVE + '\' + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '
							EXEC (@CMD)
						END

						SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_MAP_DRIVE + ' /delete'', NO_OUTPUT'
						EXEC (@CMD)
					END 
				END
				ELSE
				IF @IS_FILE_BASED = 'F'
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)
					--SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE
					SET @FILE_DWLOAD_NAME_TEMP = @FILE_DWLOAD_NAME + '_1'
					SELECT  @cmd = 'echo '+ 'open ' + @FILE_DWLOAD_LOCATION+ ' > ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ @FILE_DWLOAD_USERID+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ @FILE_DWLOAD_PWD+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
										select  @cmd = 'echo '+ 'dir ' + @file_dwload_map_drive + @file_dwload_name + ' >> ' + @process_file_path + @file_dwload_name_temp
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ 'get ' + @FILE_DWLOAD_MAP_DRIVE + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT
					SELECT  @cmd = 'echo '+ 'quit'+ ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					-- Executing steps from working file
					EXEC master..xp_cmdshell @cmd, NO_OUTPUT

					CREATE TABLE #FILELIST       
					( 
						FILENAMELIST VARCHAR(MAX)
					) 

					SELECT  @cmd = 'ftp -s:' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP
					-- Executing final step
					INSERT INTO #FILELIST
					EXEC master..xp_cmdshell @cmd--, NO_OUTPUT

					SELECT * FROM #FILELIST

					DELETE FROM #FILELIST
					WHERE FILENAMELIST IS  NULL

					DELETE FROM #FILELIST
					WHERE FILENAMELIST NOT LIKE '%' + @FILE_DWLOAD_NAME + '%'

					DELETE FROM #FILELIST
					WHERE FILENAMELIST LIKE 'DIR%'

					DELETE FROM #FILELIST
					WHERE FILENAMELIST LIKE 'GET%'

					UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')

					SET @FLD_FILEDATE = '1900-01-01'

					SELECT @FLD_FILEDATE = CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),1)
					FROM #FILELIST

					IF LEFT(@FLD_FILEDATE,11) <> @BUSINESS_DATE
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @process_file_path + @file_dwload_name + '''--, NO_OUTPUT '
						EXEC (@CMD)
					END
					SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP + ''', NO_OUTPUT '
					EXEC (@CMD)

					DROP TABLE #FILELIST
				END
			END
			IF @PROCESS_FILE_NAME <> ''
			BEGIN
				SET @PROCESS_FILE_NAME_NEW = @PROCESS_FILE_PATH + @PROCESS_FILE_NAME
				IF PRADNYA.DBO.CHECKZIPFILE(@FILE_DWLOAD_NAME) > 0
				BEGIN
					SET @CMD = 'EXEC XP_CMDSHELL ''"C:\program files\Winzip\WZUNZIP.exe" -yb -o ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'
					
					print @cmd
					EXEC (@CMD)

					SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '
					EXEC (@CMD)
				END
			END
			
		--	PRINT @PROCESS_FILE_NAME_NEW
			
			EXEC MASTER.DBO.XP_FILEEXIST @PROCESS_FILE_NAME_NEW, @ISEXISTS OUTPUT
			IF @ISEXISTS = 0 
			BEGIN
				UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = 'FILE NOT AVAILABLE IN THE SPECIFIED LOCATION.',
				PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()
				WHERE SNO = @SNO
			END
			ELSE
			BEGIN			
				SET @ERRFLAG = 0
				UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))
				WHERE SNO = @SNO
				BEGIN
					BEGIN TRAN
						BEGIN TRY
							SET @CMD = @PROCESS_SP_NAME 
							EXEC (@CMD)
						END TRY
						BEGIN CATCH
							ROLLBACK TRAN
							UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),
							PROCESS_STATUS = 0
							WHERE SNO = @SNO
							SET @ERRFLAG = 1
						END CATCH
						
					SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_MOVE_PATH + ''', NO_OUTPUT'
					EXEC (@CMD)
					SELECT @TIME = REPLACE(CONVERT(VARCHAR,GETDATE(),108),':','')
					IF LEN(@PROCESS_FILE_MOVE_PATH) > 0 
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''MOVE ' + @PROCESS_FILE_NAME_NEW + ' ' + @PROCESS_FILE_MOVE_PATH + @PROCESS_FILE_NAME + @TIME + ''', NO_OUTPUT'
					END
					ELSE
					BEGIN
						SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_NAME_NEW + ''', NO_OUTPUT'
					END
					EXEC (@CMD)

					IF @ERRFLAG = 0      
					BEGIN	
						INSERT INTO TBL_AUTO_PROCESS_FILE VALUES (@FLD_FILENAME, @FLD_FILEDATE, GETDATE())
						COMMIT TRAN
						
						IF LEN(@PROCESS_CHECK_QUERY) > 0 
						BEGIN
							SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''
							SET @CMD = @CMD + ' IF (@RECCNT) > 0 '
							SET @CMD = @CMD + ' BEGIN '
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','
							SET @CMD = @CMD + '		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
							
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
							SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
							SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
							SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
							SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
							
							IF @OTHER_DBDETAILS <> ''
							BEGIN
								SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
								SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
								SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
								SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
								SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
								SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
							END
							SET @CMD = @CMD + ' END '
							SET @CMD = @CMD + ' ELSE ' 
							SET @CMD = @CMD + ' BEGIN ' 
							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET '
							SET @CMD = @CMD + '		PROCESS_HALTED_REASON = @MSG,'
							SET @CMD = @CMD + '		PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
							SET @CMD = @CMD + ' END '
							EXEC (@CMD)
						END
						ELSE
						BEGIN
							SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '
							SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '
							SET @CMD = @CMD + ' BEGIN '

							SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
							SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
							SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
							SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
							SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
							IF @OTHER_DBDETAILS <> ''
							BEGIN
								SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
								SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
								SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
								SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
								SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
								SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
							END
							SET @CMD = @CMD + ' END '
							EXEC (@CMD)
						END
					END				
				END
			END
		END
		ELSE
		BEGIN
			SET @ERRFLAG = 0
			UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))
			WHERE SNO = @SNO	
			BEGIN TRAN		
				BEGIN TRY
					SET @CMD = @PROCESS_SP_NAME 
					PRINT @CMD
					EXEC (@CMD)
				END TRY
				BEGIN CATCH
					ROLLBACK TRAN

					UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),
					PROCESS_STATUS = 0
					WHERE SNO = @SNO
					SET @ERRFLAG = 1
				END CATCH
			IF @ERRFLAG = 0      
			BEGIN
				COMMIT TRAN

				IF LEN(@PROCESS_CHECK_QUERY) > 0 
				Begin
					SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''
					SET @CMD = @CMD + ' IF (@RECCNT) > 0 '
					SET @CMD = @CMD + ' BEGIN '
					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','
					SET @CMD = @CMD + '		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '

					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
					SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
					SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
					SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
					SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
					IF @OTHER_DBDETAILS <> ''
					BEGIN
						SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
						SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
						SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
						SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
						SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
						SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
					END

					SET @CMD = @CMD + ' END '
					SET @CMD = @CMD + ' ELSE ' 
					SET @CMD = @CMD + ' BEGIN ' 
					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET '
					SET @CMD = @CMD + '		PROCESS_HALTED_REASON = @MSG,'
					SET @CMD = @CMD + '		PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '
					SET @CMD = @CMD + ' END '
					EXEC (@CMD)
				END
				ELSE
				BEGIN
					SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '
					SET @CMD = @CMD + '		WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '
					SET @CMD = @CMD + ' BEGIN '

					SET @CMD = @CMD + '		UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '
					SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
					SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
					SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
					SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''
					IF @OTHER_DBDETAILS <> ''
					BEGIN
						SET @CMD = @CMD + '		UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '
						SET @CMD = @CMD + '		PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '
						SET @CMD = @CMD + '		PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE ' 
						SET @CMD = @CMD + '		ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'
						SET @CMD = @CMD + '		WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''
						SET @CMD = @CMD + '		AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''
					END
					SET @CMD = @CMD + ' END '
					EXEC (@CMD)
				END
			END
		END
	END
	ELSE
	BEGIN
		IF @CHKFLAG = 1 
		BEGIN
			UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @PROCESS_HALTED_REASON,
			PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()
			WHERE SNO = @SNO AND PROCESS_STATUS = 0
		END
	END
	FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH, 
									     @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,
										 @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,
										 @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,
									     @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE
END
CLOSE @PROCESS_CURSOR
DEALLOCATE @PROCESS_CURSOR

CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

EXEC CLASS_AUTO_PROCESS_ALERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP
-- --------------------------------------------------


CREATE PROC [dbo].[CLASS_AUTO_PROCESS_SETUP]
(  
 @BUSINESS_DATE VARCHAR(11)  
)  
AS  
  
DECLARE @PROCESSCURSOR CURSOR,  
  @SETT_NO  VARCHAR(7),   
  @SETT_TYPE  VARCHAR(2),  
  @NEWPROCESS_ID INT  
  
 
  
IF (SELECT ISNULL(COUNT(1),0) FROM MSAJAG.DBO.SETT_MST
	WHERE START_DATE = @BUSINESS_DATE) > 0
BEGIN  
	SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)   
	FROM   TBL_AUTO_PROCESS_MASTER  
	  
	CREATE TABLE #MASTER_SETUP  
	(  
	 [PROCESS_ID]  [INT] ,  
	 [SETT_NO]   [VARCHAR](20) ,  
	 [SETT_TYPE]   [VARCHAR](20) ,  
	 [PROCESS_FOR]  [VARCHAR](30) ,  
	 [IS_DEPEND_ON]  [VARCHAR](20) ,  
	 [NEWPROCESS_ID]  [INT]  ,  
	 [BUSINESS_DATE]  [VARCHAR](11)  ,  
	 [PROCESS_START_DATE][DATETIME] ,  
	 [PROCESS_END_DATE] [DATETIME]   
	)  
	  
	IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='CAPITAL'  
	BEGIN  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)  
	   
	 FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M   
	  WHERE LEFT(START_DATE,11) = @BUSINESS_DATE  
	  AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC')  
	  AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'   
				THEN 500   
				ELSE 0   
			  END)  
	  AND PROCESS_TYPE = 'TRADE'  
	  AND PROCESS_FOR <> 'FINOBL'  
	  AND PROCESS_FOR <> 'DAILYOBL'  
	  AND T.SETT_TYPE <> ''  
	  AND PROCESS_FREQ = 'ONCE'  
	 ORDER BY 1  
	  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)  
	 FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M   
	  WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE  
	  AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC')  
	  AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'   
				THEN 500   
				ELSE 0   
			  END)  
	  AND PROCESS_TYPE = 'SETTLEMENT'  
	  AND PROCESS_FOR <> 'FINOBL'  
	  AND T.SETT_TYPE <> ''  
	  AND PROCESS_FREQ = 'ONCE'  
	 ORDER BY 1  
	  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)  
	 FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M   
	  WHERE LEFT(START_DATE,11) = @BUSINESS_DATE  
	  AND M.SETT_TYPE NOT IN ('O', 'Z')  
	  AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'   
				THEN 500   
				ELSE 0   
			  END)  
	  AND PROCESS_TYPE = 'TRADE'  
	  AND PROCESS_FOR <> 'FINOBL'  
	  AND PROCESS_FOR = 'DAILYOBL'  
	  AND T.SETT_TYPE <> ''  
	  AND PROCESS_FREQ = 'ONCE'  
	  AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')  
		ORDER BY 1  
	  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)  
	 FROM TBL_AUTO_PROCESS_MASTER T, SETT_MST M, (SELECT START_DATE = MAX(START_DATE) FROM SETT_MST M1   
				 WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE  
				 AND SETT_TYPE IN ('N', 'D')) M1  
	  WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)  
	  AND M.SETT_TYPE NOT IN ('O', 'Z')  
	  AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'   
				THEN 500   
				ELSE 0   
			  END)  
	  AND PROCESS_TYPE = 'SETTLEMENT'  
	  AND PROCESS_FOR = 'FINOBL'  
	  AND T.SETT_TYPE <> ''  
	  AND PROCESS_FREQ = 'ONCE'  
	  AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')  
	 ORDER BY 1  
	  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, SETT_NO, SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)   
	 FROM TBL_AUTO_PROCESS_MASTER T  
	 WHERE PROCESS_TYPE = 'TRADE'  
	 AND PROCESS_FREQ = 'ONCE'  
	 AND T.SETT_TYPE = ''  
	 ORDER BY 1  
	END  
	ELSE  
	BEGIN  
	 INSERT INTO #MASTER_SETUP  
	 SELECT PROCESS_ID, SETT_NO, SETT_TYPE,   
		 PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		 BUSINESS_DATE = @BUSINESS_DATE,  
		 PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),  
		 PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)   
	 FROM TBL_AUTO_PROCESS_MASTER T  
	 WHERE PROCESS_TYPE = 'TRADE'  
	 AND PROCESS_FREQ = 'ONCE'  
	 ORDER BY 1  
	END  
	  
	DECLARE @PROCESS_ID     INT,  
	  @STARTDATE     DATETIME,  
	  @ENDDATE     DATETIME,  
	  @PROCESS_REPEAT_INTERVAL INT,  
	  @PROCESS_CURSOR    CURSOR,  
	  @TEMPPROCESS_ID    INT,  
	  @NEWSTARTDATE    DATETIME,  
	  @NEWENDDATE     DATETIME  
	  
	  
	CREATE TABLE #DATA  
	(  
	 PROCESS_ID INT,  
	 STARTDATE DATETIME,  
	 ENDDATE  DATETIME  
	)  
	  
	SET @PROCESS_CURSOR = CURSOR FOR  
	SELECT PROCESS_ID,  
		STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,   
		ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,  
		PROCESS_REPEAT_INTERVAL  
	FROM TBL_AUTO_PROCESS_MASTER  
	WHERE PROCESS_FREQ = 'MULTIPLE'  
	ORDER BY PROCESS_ID  
	OPEN @PROCESS_CURSOR  
	FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL  
	WHILE @@FETCH_STATUS = 0  
	BEGIN  
	 SET @TEMPPROCESS_ID = @PROCESS_ID  
	 SET @NEWSTARTDATE = @STARTDATE  
	 WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0  
	 BEGIN   
	  SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)  
	  IF @NEWENDDATE > @ENDDATE  
	  BEGIN  
	   SET @NEWENDDATE = @ENDDATE  
	  END  
	  INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)  
	  SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)  
	 END  
	 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL  
	END  
	CLOSE @PROCESS_CURSOR  
	DEALLOCATE @PROCESS_CURSOR  
	  
	INSERT INTO #MASTER_SETUP  
	SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,   
		PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,  
		BUSINESS_DATE = @BUSINESS_DATE,  
		PROCESS_START_DATE=STARTDATE,  
		PROCESS_END_DATE=ENDDATE  
		FROM TBL_AUTO_PROCESS_MASTER M, #DATA D  
	WHERE M.PROCESS_ID = D.PROCESS_ID  
	  
	TRUNCATE TABLE #DATA  
	DROP TABLE #DATA  
	  
	ALTER TABLE #MASTER_SETUP  
	ADD SNO INT IDENTITY(1,1)  
	  
	UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO  

	DECLARE @INTLOOP INT  
	DECLARE @INTLOOP_MAX INT  
	SET @INTLOOP = 1  
	SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP  
	  
	WHILE @INTLOOP <= @INTLOOP_MAX  
	BEGIN  
	 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')  
	 FROM #MASTER_SETUP M1, #MASTER_SETUP  
	 WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'  
	 AND #MASTER_SETUP.SETT_NO = M1.SETT_NO  
	 AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE  
	 AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE  
	 AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2  
				WHERE M1.PROCESS_ID = M2.PROCESS_ID  
				AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)  
	 SET @INTLOOP = @INTLOOP + 1  
	END  
	  
	ALTER TABLE #MASTER_SETUP  
	ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)  
	  
	UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON
	  
	SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP  
	SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP  
	  
	WHILE @INTLOOP <= @INTLOOP_MAX  
	BEGIN  
	 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = 
	 REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',
	 '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')	   
	 FROM #MASTER_SETUP M1, #MASTER_SETUP  
	 WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'  
	 AND M1.NEWPROCESS_ID = @INTLOOP   
	  
	 SET @INTLOOP = @INTLOOP + 1  
	END    

	UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP  
	WHERE IS_DEPEND_ON_ORG_TEMP <> ''  
	  
	DELETE TBL_AUTO_PROCESS_DETAIL  
	WHERE PROCESS_DATE = LEFT(GETDATE(),11)  
	  
	INSERT INTO TBL_AUTO_PROCESS_DETAIL  
	SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),  
		EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,  
		SETT_NO,  
		SETT_TYPE,  
		INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,  
		PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',  
		PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',  
		PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,  
		PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,   
		PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',  
		PROCESS_OUTPUT_QUERY,''  
	FROM TBL_AUTO_PROCESS_MASTER  
	WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)  
	AND SETT_NO <> '<SETNO>'  
	  
	INSERT INTO TBL_AUTO_PROCESS_DETAIL  
	SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),  
		EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,  
		S.SETT_NO,  
		S.SETT_TYPE,  
		INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,  
		S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,  
		PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,  
		WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,  
		PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,   
		PROCESS_STATUS_ALERT_INTERVAL, '',  
		PROCESS_OUTPUT_QUERY,''  
	FROM TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S  
	WHERE M.PROCESS_ID = S.PROCESS_ID  
	AND S.SETT_NO <> '<SETNO>'  
	  
	TRUNCATE TABLE #MASTER_SETUP  
	DROP TABLE #MASTER_SETUP  
END
  
/*  
SET @PROCESSCURSOR = CURSOR FOR  
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE  
 AND SETT_TYPE NOT IN ('O', 'Z')  
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)  
 ORDER BY SETT_NO, SETT_TYPE  
OPEN @PROCESSCURSOR  
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SELECT @SETT_NO, @SETT_TYPE  
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE  
END  
CLOSE @PROCESSCURSOR  
DEALLOCATE @PROCESSCURSOR  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_UPDATE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_UPDATE]  
(  
 @PROCESSDATE VARCHAR(11),  
 @PROCESSFLAG VARCHAR(2),  
 @PROCESSID VARCHAR(max),  
 @TIME VARCHAR(5),  
 @UNAME VARCHAR(25),  
 @STATUSNAME VARCHAR(25),  
 @REQIP VARCHAR(100),  
 @STATUSID VARCHAR(25)  
)  
AS  
--EXEC CLASS_AUTO_PROCESS_UPDATE @PROCESSDATE='19/12/2014',@PROCESSFLAG='RS',@PROCESSID='51~63~55~59~',@TIME='15:52',@STATUSID='BROKER',@STATUSNAME='BROKER',@UNAME='YATINN',@REQIP='::1'  
  
  
/*  
 @PROCESSFLAG  : RS - RE SCHEDULE PROCESS  
 @PROCESSFLAG  : RM - MARK TO RESUMING A PROCESS  
 @PROCESSFLAG  : CM - MARK TO PROCESS COMPLETED  
  
 PROCESS_STATUS = 0  - 'PENDING'   
 PROCESS_STATUS = 100 - 'COMPLETED'   
 PROCESS_STATUS = 99  - 'IN - PROCESS'   
 ELSE     -'HALT DUE TO SOME ISSUE'  
   
*/  
/*
INSERT INTO BAK_AUTO
SELECT @PROCESSDATE + '#' + @PROCESSFLAG + '#' + @PROCESSID + '#' + @TIME + '#' + @UNAME + '#' + @STATUSNAME + '#' + @REQIP + '#' + @STATUSID
*/
SET @PROCESSDATE = LEFT(CONVERT(DATETIME,@PROCESSDATE,103),11)  
  
DECLARE @NEWSTART_TIME DATETIME  
DECLARE @ERRCODE INT  
DECLARE @ERRSDESC VARCHAR(100)
DECLARE @PROCESS_FOR  VARCHAR(100)
DECLARE @OTHER_DBDETAILS  VARCHAR(100)
DECLARE @OTHER_PROCESS_FOR  VARCHAR(100)
  
CREATE TABLE #PROCESSID (PSNO INT IDENTITY(1,1), PROCID INT)  
INSERT INTO #PROCESSID   
SELECT * FROM DBO.FNSPLITSTRING2TBL(@PROCESSID,'~')  
  
--------------------------------- RE SCHEDULE ----------------------------------  
IF @PROCESSFLAG='RS'    
BEGIN  
 SET @NEWSTART_TIME = LEFT(CONVERT(DATETIME, @PROCESSDATE),11) + ' ' + @TIME

 IF @NEWSTART_TIME < GETDATE()  
 BEGIN  
  SET @ERRCODE = -1  
  SET @ERRSDESC = 'INVALID PROCESS START NEW TIME'  
  SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC  
  RETURN  
 END  
    
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_START_DATE = @NEWSTART_TIME,   
 PROCESS_STARTED_DATE = '',   
 PROCESS_ENDED_DATE = '',   
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME 
						   THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)  
						   ELSE PROCESS_END_DATE
					  END),
 PROCESS_STATUS = 0,
 PROCESS_HALTED_REASON = '',
 IS_DEPEND_ON = (CASE WHEN B.PSNO = 1 THEN IS_DEPEND_ON ELSE IS_DEPEND_ON_ORG END)
 FROM #PROCESSID B  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
 AND PROCESS_START_DATE < @NEWSTART_TIME  
  
 DROP TABLE #PROCESSID  
   
 SET @ERRCODE = 0  
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'  
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC  
 RETURN  
END  
  
  
--------------------------------- MARK TO RESUMING A PROCESS ---------------------------------  
IF @PROCESSFLAG='RM'    
BEGIN  
 SET @NEWSTART_TIME = CONVERT(DATETIME, @PROCESSDATE + ' ' + CONVERT(VARCHAR(5),GETDATE(),114))  
   
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 0  
 FROM #PROCESSID B  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
   
 -- RE SCHEDULING TO NEW TIMING   
 UPDATE TBL_AUTO_PROCESS_DETAIL SET   
 PROCESS_START_DATE = @NEWSTART_TIME,   
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME 
						   THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)  
						   ELSE PROCESS_END_DATE
					  END)
 FROM #PROCESSID B  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
 AND PROCESS_START_DATE < @NEWSTART_TIME  
  
 DROP TABLE #PROCESSID  
   
 SET @ERRCODE = 0  
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'  
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC  
 RETURN  
  
END  
   
--------------------------------- MARK TO COMPLETE ---------------------------------  
IF @PROCESSFLAG='CM'     
BEGIN  
   
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 100,
 PROCESS_HALTED_REASON = 'MARKED SUCCESS BY THE USER ' + UPPER(@UNAME),
 PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 1,
 PROCESS_ENDED_DATE = GETDATE()
 FROM #PROCESSID B  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
 AND B.PSNO = 1 
   
 SELECT @PROCESS_FOR = PROCESS_FOR FROM TBL_AUTO_PROCESS_DETAIL, #PROCESSID B  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
 AND B.PSNO = 1 AND PROCESS_STATUS = 100 
 
 SELECT @OTHER_DBDETAILS = OTHER_DBDETAILS, @OTHER_PROCESS_FOR = OTHER_PROCESS_FOR
 FROM TBL_AUTO_PROCESS_MASTER
 WHERE PROCESS_FOR = @PROCESS_FOR

 DECLARE @SQL VARCHAR(2000)

 SET @SQL = 'UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') '
 SET @SQL = @SQL + ' WHERE PROCESS_DATE = ''' + @PROCESSDATE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''  
 EXEC (@SQL)

UPDATE TBL_AUTO_PROCESS_DETAIL SET  IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,'#'+CONVERT(VARCHAR,C.PROCID)+',',''),
PROCESS_START_DATE = GETDATE() + ' 00:01:00', 
PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + ' 00:01:00' + APPROX_END_TIME) THEN PROCESS_END_DATE
			 ELSE GETDATE() + ' 00:01:00' + APPROX_END_TIME END)
 FROM #PROCESSID B, #PROCESSID C  
 WHERE PROCESS_DATE = @PROCESSDATE  
 AND PROCESS_ID = B.PROCID  
 AND B.PSNO <> 1 
 AND C.PSNO = 1
 AND IS_DEPEND_ON LIKE '%#'+CONVERT(VARCHAR,C.PROCID)+',%'

 
 DROP TABLE #PROCESSID  
   
 SET @ERRCODE = 0  
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'  
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC  
 RETURN  
END  
  
/*------------------------------------------ END OF THE PROC ---------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_VIEW
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_VIEW]
(	
	@PROCESSDATE VARCHAR(11),
	@PROCESSON VARCHAR(30),
	@PROCESSTYPE VARCHAR(30),
	@PROCESSFOR VARCHAR(30),
	@UNAME VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@REQIP VARCHAR(100),
	@STATUSID VARCHAR(25),
	@PROCESSID BIGINT,
	@LEVEL VARCHAR(1)	
)
AS

OPEN SYMMETRIC KEY   Key4CertAutoProcess
     DECRYPTION BY   CERTIFICATE CertAutoProcess 

SET @PROCESSDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESSDATE, 103), 109) 
BEGIN	
		
	IF @LEVEL='1'---summary
	BEGIN	
		SELECT SNO
		,PROCESS_TYPE
		,PROCESS_FOR
		,PROCESS_ID
		,SETT_NO
		,SETT_TYPE
		,PROCESS_START_DATE = CONVERT(VARCHAR(5),PROCESS_START_DATE,114)
		,PROCESS_END_DATE = CONVERT(VARCHAR(5),PROCESS_END_DATE,114)
		,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)
		,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)
		,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)
		,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETED' 
							WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END) 
		,PROCESS_HALTED_REASON      
		FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)
		WHERE 
		PROCESS_DATE = @PROCESSDATE
		AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'
		AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'
		AND PROCESS_STATUS  = CASE WHEN @PROCESSON <> '' THEN @PROCESSON ELSE PROCESS_STATUS END	
		--ORDER BY SNO							   	
	END
	
	IF @LEVEL='2'---detail
	BEGIN	
		
		DECLARE @PROCESSCUR CURSOR 
		DECLARE @IS_DEPEND_ON_ORG VARCHAR(20)
		DECLARE @PROCESS_ID BIGINT		 
		
		CREATE TABLE #PROCESSID (PROCID BIGINT,DEPEND_ON BIGINT)

		SET @PROCESSCUR = CURSOR FOR  		
						SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(IS_DEPEND_ON_ORG,'#','') 
						FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)
						WHERE PROCESS_DATE = @PROCESSDATE
						AND IS_DEPEND_ON_ORG <> ''
						--AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'
		OPEN @PROCESSCUR
		
		FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG
		WHILE @@FETCH_STATUS = 0
		BEGIN
			INSERT INTO #PROCESSID
			SELECT @PROCESS_ID,* FROM dbo.fnSplitString2Tbl(@IS_DEPEND_ON_ORG,',')
			
			FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG
		END
		CLOSE @PROCESSCUR
		DEALLOCATE @PROCESSCUR
		delete from #processid where DEPEND_ON = 0 

		INSERT INTO #PROCESSID
		SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(REPLACE(IS_DEPEND_ON_ORG,'#',''),',','') 
		FROM  .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK) WHERE PROCESS_DATE = @PROCESSDATE 
		AND PROCESS_ID NOT IN(SELECT PROCID FROM #PROCESSID)
		--AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'

		CREATE TABLE #PROC(PROCID BIGINT,DPND BIGINT,FLAG BIGINT)
		INSERT INTO #PROC VALUES(@PROCESSID,0,1)
		
		DECLARE @EXITLOOP BIGINT
		SET @EXITLOOP = 0

		DECLARE @I BIGINT
		SET @I = 1
		--exec CLASS_AUTO_PROCESS_VIEW '18/12/2014','','','','','','','','12','2'
		WHILE @EXITLOOP = 0
		BEGIN
			SET @I = @I + 1
			
			INSERT INTO #PROC
			SELECT PROCID,DEPEND_ON,@I FROM #PROCESSID WHERE DEPEND_ON IN (SELECT PROCID FROM #PROC WHERE FLAG=@I-1)
			
			IF (SELECT COUNT(1) FROM #PROC WHERE FLAG=@I) =0
			BEGIN
				SET @EXITLOOP = 1
			END

		END
		 
		SELECT SNO
		,PROCESS_TYPE
		,PROCESS_FOR
		,PROCESS_ID
		,SETT_NO
		,SETT_TYPE
		,PROCESS_START_DATE = CONVERT(VARCHAR(5),PROCESS_START_DATE,114)
		,PROCESS_END_DATE = CONVERT(VARCHAR(5),PROCESS_END_DATE,114)
		,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)
		,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)
		,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)
		,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETED' 
							WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END) 
		,PROCESS_HALTED_REASON      
		FROM .DBO.TBL_AUTO_PROCESS_DETAIL D (NOLOCK),#PROC 
		WHERE 
		PROCESS_DATE = @PROCESSDATE
		--AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'
		--AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'
		--AND PROCESS_STATUS  = CASE WHEN @PROCESSON <> '' THEN @PROCESSON ELSE PROCESS_STATUS END
		AND PROCESS_ID = #PROC.PROCID
		ORDER BY FLAG
		
		DROP TABLE #PROCESSID
		DROP TABLE #PROC

	END	
END

CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_USER_COUNT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_USER_COUNT]  
(  
 @UNAME VARCHAR(30),  
 @ADMIN_NAME VARCHAR(30),
 @CUREXCHSEG VARCHAR(50) 	  
)  
/*  
 CLASS_USER_COUNT 'TEST', 'ADMINISTRATOR', ''  
 SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DSS'  
EXEC CLASS_USER_COUNT 'SAMARTHLANJEKAR','Broker','NSE~~CAPITAL'

*/  
AS  
 DECLARE    
 @@EXCHANGE AS VARCHAR(3),  
 @@SEGMENT AS VARCHAR(15),  
 @@SHARESVR AS VARCHAR(20),  
 @@SHAREDB   AS VARCHAR(20),  
 @@SEGORD AS TINYINT,  
 @@SQL  AS VARCHAR(500),  
 @@MAINREC AS CURSOR  
   
  CREATE TABLE [DBO].[#RESULT]    
  (    
  EXCHANGE VARCHAR(6),     
  SEGMENT VARCHAR(10),  
  RESULT VARCHAR(100)  
  ) ON [PRIMARY]  
    
 CREATE TABLE #USERS  
 (  
  FLDUSERNAME VARCHAR(30)  
 )  
  
 IF UPPER(@ADMIN_NAME) = 'ADMINISTRATOR'
 BEGIN
  SET @@MAINREC = CURSOR FOR 	  	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE PRIMARYSERVER = 1 ORDER BY 1   
 END
 ELSE
 BEGIN
  SET @@MAINREC = CURSOR FOR 	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE EXCHANGE + '~~' + SEGMENT = 	@CUREXCHSEG  AND PRIMARYSERVER = 1 ORDER BY 1
 END		
   
 SET @@SEGORD = 1    
 OPEN @@MAINREC    
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR   
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
   IF @@SHARESVR <> @@SERVERNAME   
    BEGIN  
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
    ELSE  
    BEGIN   
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME #USERS FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
   PRINT(@@SQL)  
   EXEC(@@SQL)   
  --SELECT * FROM #USERS   
  IF @@ROWCOUNT <> 0  
   BEGIN  
   INSERT INTO #RESULT VALUES(@@EXCHANGE,@@SEGMENT,'USER AVAILABLE')  
   END   
    
 SET @@SEGORD = @@SEGORD + 1  
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR  
 END   
  
 SELECT * FROM #RESULT  
 DROP TABLE #RESULT  
 DROP TABLE #USERS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_ADMIN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_VALIDATE_ADMIN]    
(    
    @ADMINID     VARCHAR(50),    
    @IPADDRESS  VARCHAR(20),    
    @RETCODE    INT  OUTPUT,    
    @RETMSG     VARCHAR(200)  OUTPUT,    
    @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,    
    @LASTLOGIN VARCHAR(40) OUTPUT    
)    
AS    

  DECLARE  @@USER_COUNT TINYINT    
  DECLARE  @@LASTLOGIN VARCHAR(40)      
  DECLARE  @@USER_SESSION VARCHAR(200)    
    
                              
  SELECT @@USER_COUNT = COUNT(1)    
  FROM   TBLCLASSADMINLOGINS (NOLOCK)    
  WHERE  FLDADMINNAME = @ADMINID    
                        
  IF ISNULL(@@USER_COUNT,0) = 0    
    BEGIN    
      INSERT INTO TBLCLASSADMINLOGINS    
	  (    
	   FLDAUTO,    
	   FLDADMINNAME,    
	   FLDSTATUS,    
	   FLDSTNAME,    
	   FLDSESSION,    
	   FLDIPADDRESS,    
	   FLDLASTVISIT,    
	   FLDTIMEOUTPRD    
	  )  
	  SELECT A.FLDAUTO_ADMIN,    
		A.FLDNAME,    
		A.FLDSTATUS,    
		A.FLDSTNAME,    
		'',    
		'',    
		GETDATE(),    
		''   
	  FROM   TBLADMIN A (NOLOCK)    
	  WHERE  A.FLDNAME = @ADMINID   
                                 
	  IF @@ERROR <> 0    
		BEGIN    
		 SET @RETCODE = 0    
		 SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'    
		 RETURN    
		END    
	END    
        
    
 SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)    
 FROM TBLCLASSADMINLOGINS    
 WHERE FLDADMINNAME = @ADMINID    
    
    
 SET @@USER_SESSION = NEWID()    
                           
 UPDATE TBLCLASSADMINLOGINS    
 SET    FLDIPADDRESS = @IPADDRESS,    
   FLDSESSION = @@USER_SESSION,    
   FLDLASTVISIT = GETDATE(),    
   FLDLASTLOGIN = GETDATE()    
 WHERE  FLDADMINNAME = @ADMINID    
                            
  IF @@ERROR <> 0    
    BEGIN    
  SET @RETCODE = 0    
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'    
  RETURN    
    END    
        
  SET @RETCODE = 1    
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'    
  SET @UM_SESSION = @@USER_SESSION    
  SET @LASTLOGIN = @@LASTLOGIN                    
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_USER
-- --------------------------------------------------



CREATE PROCEDURE [DBO].[CLASS_VALIDATE_USER]  
(  
                @USERID     VARCHAR(50),  
                @IPADDRESS  VARCHAR(20),  
                @RETCODE    INT  OUTPUT,  
                @RETMSG     VARCHAR(200)  OUTPUT,  
                @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,  
				@LASTLOGIN VARCHAR(40) OUTPUT  
)  
AS  
  
  DECLARE  @@USER_COUNT TINYINT  
  DECLARE  @@LASTLOGIN VARCHAR(40)    
  DECLARE  @@USER_SESSION VARCHAR(200)  
  
                            
  SELECT @@USER_COUNT = COUNT(1)  
  FROM   TBLCLASSUSERLOGINS (NOLOCK)  
  WHERE  FLDUSERNAME = @USERID  
                         
  IF ISNULL(@@USER_COUNT,0) = 0  
    BEGIN  
      
  INSERT INTO TBLCLASSUSERLOGINS  
  (  
   FLDAUTO,  
   FLDUSERNAME,  
   FLDSTATUS,  
   FLDSTNAME,  
   FLDSESSION,  
   FLDIPADDRESS,  
   FLDLASTVISIT,  
   FLDTIMEOUTPRD  
  )  
  SELECT P.FLDAUTO,  
     P.FLDUSERNAME,  
     A.FLDSTATUS,  
     P.FLDSTNAME,  
     '',  
     '',  
     GETDATE(),  
     ISNULL(M.FLDTIMEOUT,1)  
  FROM   TBLPRADNYAUSERS P (NOLOCK)  
     LEFT OUTER JOIN TBLUSERCONTROLMASTER M (NOLOCK)  
    ON (M.FLDUSERID = P.FLDAUTO)  
     INNER JOIN TBLADMIN A (NOLOCK)  
    ON (P.FLDADMINAUTO = A.FLDAUTO_ADMIN)  
  WHERE  P.FLDUSERNAME = @USERID  
                               
  IF @@ERROR <> 0  
    BEGIN  
   SET @RETCODE = 0  
             
   SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'  
             
   RETURN  
    END  
          
    END  
      
  
     SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)  
 FROM TBLCLASSUSERLOGINS  
 WHERE FLDUSERNAME = @USERID  
  
  
 SET @@USER_SESSION = NEWID()  
                         
 UPDATE TBLCLASSUSERLOGINS  
 SET    FLDIPADDRESS = @IPADDRESS,  
   FLDSESSION = @@USER_SESSION,  
   FLDLASTVISIT = GETDATE(),  
   FLDLASTLOGIN = GETDATE()  
 WHERE  FLDUSERNAME = @USERID  
                          
  IF @@ERROR <> 0  
    BEGIN  
  SET @RETCODE = 0  
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'  
  RETURN  
    END  
      
  SET @RETCODE = 1  
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'  
  SET @UM_SESSION = @@USER_SESSION  
  SET @LASTLOGIN = @@LASTLOGIN                  
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientMargin_Upd
-- --------------------------------------------------




CREATE PROC [dbo].[ClientMargin_Upd]
(
           @mdate VARCHAR(11)
)
AS

  DECLARE  @@opendate  AS VARCHAR(11)
                          
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SELECT *
  INTO   #TBL_CLIENTMARGIN
  FROM   TBL_CLIENTMARGIN
  WHERE  1 = 2
             
  INSERT INTO #TBL_CLIENTMARGIN
  SELECT DISTINCT C2.PARTY_CODE,
                  @mdate + ' 00:00',
                  0,
                  0,
                  0,
                  0,
                  0,
                  GETDATE(),
                  C1.SHORT_NAME,
                  LEFT(C1.LONG_NAME,50),
                  LTRIM(RTRIM(C1.BRANCH_CD)),
                  LTRIM(RTRIM(C1.FAMILY)),
                  LTRIM(RTRIM(C1.SUB_BROKER)),
                  LTRIM(RTRIM(C1.TRADER)),
                  0,
                  0
  FROM   CLIENT2 C2,
         CLIENT1 C1
  WHERE  C1.CL_CODE = C2.CL_CODE
                      
  UPDATE T
  SET    BILLAMOUNT = AMOUNT
  FROM   #TBL_CLIENTMARGIN T,
         (SELECT   PARTY_CODE,
                   AMOUNT = ISNULL(SUM((CASE 
                                          WHEN SELL_BUY = 2 THEN ISNULL(AMOUNT,0)
                                          ELSE (0 - ISNULL(AMOUNT,0))
                                        END)),0)
          FROM     FOACCBILL
          WHERE    BILLDATE LIKE @mdate + '%'
          GROUP BY PARTY_CODE) P
  WHERE  P.PARTY_CODE = T.PARTY_CODE
                        
  /*Getting Closing balance from Ledger with out  today's bill*/
  SELECT *
  INTO   #LEDGER
  FROM   ACCOUNTNCE.DBO.LEDGER
  WHERE  CLTCODE IN (SELECT DISTINCT PARTY_CODE
                     FROM   #TBL_CLIENTMARGIN)
                    
  SELECT @@opendate = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11)
                       FROM   #LEDGER
                       WHERE  VTYP = 18
                              AND VDT <= @mdate + ' 23:59')
                      
  SELECT CLTCODE,
         OPPBAL = VAMT
  INTO   #OPPBALANCE
  FROM   #LEDGER
  WHERE  1 = 2
             
  IF @@opendate <> ''
    BEGIN
      INSERT INTO #OPPBALANCE
                  
      SELECT   CLTCODE,
               SUM(OPPBAL)  OPPBAL
      FROM     (SELECT   CLTCODE,
                         OPPBAL = ISNULL(SUM(CASE 
                                               WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT
                                               ELSE -B.VAMT
                                             END),0)
                FROM     #LEDGER B
                WHERE    B.VDT LIKE @@opendate + '%'
                         AND VTYP = 18
                GROUP BY CLTCODE
                         
                UNION ALL
               
                SELECT   CLTCODE,
                         OPPBAL = ISNULL(SUM(CASE 
                                               WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT
                                               ELSE -B.VAMT
                                             END),0)
                FROM     #LEDGER B
                WHERE    B.VDT >= @@opendate
                         AND VDT < @mdate
                         AND VTYP <> 18
                GROUP BY CLTCODE) T
      GROUP BY CLTCODE
    END
  ELSE
    BEGIN
      INSERT INTO #OPPBALANCE
      SELECT   CLTCODE,
               OPPBAL = ISNULL(SUM(CASE 
                                     WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT
                                     ELSE -B.VAMT
                                   END),0)
      FROM     #LEDGER B
      WHERE    VDT < @mdate
      GROUP BY CLTCODE
    END
    
  SELECT   CLTCODE,
           ROUND(SUM(OPPBAL),2)  OPPBAL
  INTO     #OPPBALANCEFINAL
  FROM     (SELECT   CLTCODE,
                     SUM(OPPBAL)  OPPBAL
            FROM     #OPPBALANCE
            GROUP BY CLTCODE
                     
            UNION ALL
           
            SELECT   CLTCODE,
                     OPPBAL = ISNULL(SUM(CASE 
                                           WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT
                                           ELSE -B.VAMT
                                         END),0)
            FROM     #LEDGER B
            WHERE    VDT LIKE @mdate + '%'
                     AND (VTYP <> '15'
                           OR (NARRATION LIKE 'Settno=%'
                               AND VTYP = '15')
			   OR (narration not like 'NCE'+@mdate + '%' and vtyp  ='15')
			) AND VTYP <> '18' 

            GROUP BY CLTCODE) T
  GROUP BY CLTCODE
           
  UPDATE T
  SET    LEDGERAMOUNT = OPPBAL
  FROM   #TBL_CLIENTMARGIN T,
         #OPPBALANCEFINAL P
  WHERE  P.CLTCODE = T.PARTY_CODE
                     
  /*getting collateral from msajag*/
  UPDATE T
  SET    CASH_COLL = ACTCASH,
         NONCASH_COLL = ACTNONCASH
  FROM   #TBL_CLIENTMARGIN T,
         (SELECT PARTY_CODE,
                 ACTCASH = ISNULL(CASH,0),
                 ACTNONCASH = ISNULL(NONCASH,0)
          FROM   MSAJAG.DBO.COLLATERAL
          WHERE  EXCHANGE = 'NCE'
                 AND SEGMENT LIKE 'FUT%'
                 AND TRANS_DATE LIKE @mdate + '%') P
  WHERE  P.PARTY_CODE = T.PARTY_CODE
                        
  /*getting margin details*/

------- SRE-34986 DONE BY VAIBHAV K ------------------ 
  UPDATE T
  SET    INITIALMARGIN = P.MARGINAMOUNT,
         MTMMARGIN = P.MTMMARGIN,
         ADDMARGIN = P.ADDMARGIN
  FROM   #TBL_CLIENTMARGIN T,
         (SELECT   PARTY_CODE,
                   SUM(TOTALMARGIN - ADDMARGIN) MARGINAMOUNT,
                   MTMMARGIN = SUM(MTOM),
                   ADDMARGIN = SUM(ADDMARGIN)
          FROM     FOMARGINNEW
          WHERE    CL_TYPE LIKE 'C%'
                   AND MDATE LIKE (SELECT LEFT(MAX(MDATE),11)
                                   FROM   FOMARGINNEW
                                   WHERE  MDATE <= @mdate + ' 23:59') + '%'
          GROUP BY PARTY_CODE) P
  WHERE  P.PARTY_CODE = T.PARTY_CODE
  ------- SRE-34986 DONE BY VAIBHAV K ------------------ 
    
	
	/*
 UPDATE T SET INITIALMARGIN=P.MARGINAMOUNT,MTMMARGIN=P.MTMMARGIN,ADDMARGIN=P.ADDMARGIN FROM #TBL_CLIENTMARGIN T,                 
(                
 SELECT  PARTY_CODE,SUM(INITIALMARGIN) MARGINAMOUNT, MTMMARGIN = SUM(MTOMMARGIN)  ,ADDMARGIN=SUM(OTHERMARGIN)                    
 FROM FOMARGINNEW_DATA                        
 WHERE  MDATE LIKE  (                
  SELECT LEFT(MAX(MDATE),11) FROM FOMARGINNEW                  
  WHERE MDATE <=  @MDATE +' 23:59') + '%'                      
 GROUP BY PARTY_CODE                
) P                
 WHERE P.PARTY_CODE = T.PARTY_CODE   
    */
                        
  /*updating tbl_clientmargin*/
  DELETE TBL_CLIENTMARGIN
  WHERE  MARGINDATE LIKE @mdate + '%'
                                  
  INSERT INTO TBL_CLIENTMARGIN
  SELECT   *
  FROM     #TBL_CLIENTMARGIN
  WHERE    (BILLAMOUNT <> 0
             OR INITIALMARGIN <> 0
             OR LEDGERAMOUNT <> 0
             OR CASH_COLL <> 0
             OR NONCASH_COLL <> 0)
  ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClientMargin_Upd_New
-- --------------------------------------------------
CREATE  Proc  ClientMargin_Upd_New (@DateFrom VARCHAR (20),@DateTo as varchar(20))
As      
  
Declare      
@mdate  varchar(11),
@DateCur Cursor      
      
Create Table #MarginDates (MDate Datetime)
Declare @ReportDate as datetime   
Set   @ReportDate  = @DateFrom  
  
while @ReportDate <=  @DateTo  -- + ' 23:59'     
 begin    
 Insert Into #MarginDates values (Convert(varchar,@ReportDate,101))  
 select @ReportDate = dateadd(day,1,@ReportDate)                
end 
      
Set @DateCur = Cursor for  Select left(MDate,11) From  #MarginDates
Open @DateCur      
          
      
Fetch Next From @DateCur into @mdate
While @@Fetch_Status = 0       
Begin      
      
 EXECUTE ClientMargin_Upd  @mdate
    
 Fetch Next From @DateCur into @mdate
End      
Close @DateCur      
DeAllocate @DateCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.clientname
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.clientname    Script Date: 1/17/2004 11:42:41 PM ******/






/****** Object:  Stored Procedure dbo.clientname    Script Date: 09/10/2001 6:27:17 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 09/07/2001 10:36:00 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 9/7/01 5:07:17 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 9/7/2001 4:09:58 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 08/10/2001 4:53:36 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 08/10/01 4:45:24 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 7/25/01 10:05:55 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 7/1/01 2:26:21 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 06/26/2001 8:47:46 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 3/17/01 9:55:48 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 3/21/01 12:50:04 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 20-Mar-01 11:38:47 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 2/5/01 12:06:10 PM ******/
/****** Object:  Stored Procedure dbo.clientname    Script Date: 12/27/00 8:58:47 PM ******/
CREATE  PROCEDURE clientname
@partycode varchar(10)
 AS
select c1.short_name, isnull(c2.bankid,''), isnull(c2.cltdpno,'') from client1 c1, client2 c2  where  c2.party_code=@partycode
and c1.cl_code=c2.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_ALL_TRADEPROCESS_VALID
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_ALL_TRADEPROCESS_VALID]  
 (
	@BDATE VARCHAR(11)
 )
 AS  
 
 DECLARE  @INTSTAT INT
 DECLARE  @INTSTT INT
 DECLARE  @INTVBB INT
 
 
  IF NOT EXISTS(SELECT TOP 1 BUSINESS_DATE FROM V2_BUSINESS_PROCESS (NOLOCK)   
  WHERE OPEN_CLOSE = 0   AND BUSINESS_DATE BETWEEN @BDATE AND @BDATE + ' 23:59')
  BEGIN
		SET @INTSTAT  =0
		SET @INTSTT  = 0
		SET @INTVBB  = 0
  END
  ELSE
  BEGIN
		SET @INTSTAT  =1
		IF EXISTS (SELECT TOP  1 SP_PARTY_CODE FROM SCHEME_MAPPING)
		BEGIN
			SET @INTVBB  = 1
		END

		IF EXISTS (SELECT TOP  1 STT_DATE FROM STT_EXCHG)
		BEGIN
			SET @INTSTT  = 1
		END
  END
SELECT @INTSTAT,@INTVBB,@INTSTT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BULK_MARGINUPLOAD_INTRADAY
-- --------------------------------------------------




 
CREATE PROC [dbo].[CLS_BULK_MARGINUPLOAD_INTRADAY]  
(
	@FILENAME VARCHAR(100)='',
	@MARGINDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT NSEFO MARGINUPLOAD_INTRADAY FILE
*/ 
DECLARE @STRSQL VARCHAR(MAX),
@RECCNT	INT,
@FILECOUNTER INT

SET @FILECOUNTER = LEFT(RIGHT(@FILENAME,6),2)

 
--SELECT MDATE,PARTY_CODE,SPAN_MARGIN,NET_BUY_PREMIUM,EXTREME_LOSS_MARGIN,MTOM_LOSS,OTHER_MARGIN,TOTAL_MARGIN,CL_TYPE
--INTO #FOMARGINNEW_INTRADAY FROM FOMARGINNEW_INTRADAY

TRUNCATE TABLE FOMARGINNEW_INTRADAY_IMP

 

	SET @STRSQL = LOWER('BULK INSERT FOMARGINNEW_INTRADAY_IMP FROM ''' + @FILENAME  + '''  WITH (FIELDTERMINATOR = '','',ROWTERMINATOR = ''\n'')')          
	EXEC(@STRSQL)
  
  
DELETE FROM FOMARGINNEW_INTRADAY
WHERE MDATE = @MARGINDATE AND FILECOUNTER = @FILECOUNTER

UPDATE FOMARGINNEW_INTRADAY_IMP SET PARTY_CODE = P.NEWPARTY_CODE 
FROM PARTYMAPPING P
WHERE FOMARGINNEW_INTRADAY_IMP.PARTY_CODE = P.OldParty_Code

INSERT INTO FOMARGINNEW_INTRADAY
SELECT FILECOUNTER=@FILECOUNTER,MDATE,PARTY_CODE,SPAN_MARGIN,NET_BUY_PREMIUM,EXTREME_LOSS_MARGIN,MTOM_LOSS,OTHER_MARGIN,TOTAL_MARGIN,CL_TYPE,
UPLOAD_BY='',UPLOAD_ON=GETDATE()
FROM FOMARGINNEW_INTRADAY_IMP

--SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #FOMARGINNEW_INTRADAY

--IF @RECCNT = 0 
--BEGIN
--	SELECT STRMSGCODE = -1, STRMSG = 'NO DATA FOUND IN THE FILE, PLEASE CHECK AND IMPORT CORRECT FILE'
--END

--IF @RECCNT > 0 
--BEGIN
--	SELECT STRMSGCODE = 1, STRMSG = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORD(S) ' + CONVERT(VARCHAR,@RECCNT)
--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cls_CHECKVERSION
-- --------------------------------------------------


CREATE PROC [dbo].[cls_CHECKVERSION]   
AS
EXEC CHECKVERSION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENT_INFO
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_CLIENT_INFO]    
(    
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@FROMPARTY VARCHAR(25),    
@TOPARTY VARCHAR(25)    
)    
AS     
IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0    
BEGIN    
 SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)    
END    
IF LEN(@TODATE) = 10 AND CHARINDEX('/', @TODATE) > 0    
BEGIN    
 SET @TODATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TODATE, 103), 109)    
END    
--EXEC CLS_CLIENT_INFO 'Sep 10 2005','Sep 10 2015','HOC00024','HOC00024'    
SELECT     
 DISTINCT     
 [CLIENT CODE]=PARTY_CODE,    
 [CLIENT NAME]=CD.LONG_NAME,    
 [REGISTRATION DATE] = CONVERT(VARCHAR,MIN(SYSTEMDATE),103),  
 REPORTDATE=left(convert(varchar,Getdate(),103),11),    
 L_ADDRESS1,    
 L_ADDRESS2,    
 L_ADDRESS3,    
 L_CITY,    
 L_ZIP,    
 RES_PHONE1,    
 RES_PHONE2,    
 OFF_PHONE1,    
 OFF_PHONE2,    
 CELLNO = MOBILE_PAGER,    
 PAN_GIR_NO,    
 EMAIL=LOWER(CD.EMAIL),    
 PASSPORT_NO AS PASSPORTNO,    
 VOTERSID_NO AS VOTERSID,    
 RAT_CARD_NO AS RATIONCARD,    
 LICENCE_NO AS LICENCENO,    
 (    
  CASE     
   WHEN YEAR(PASSPORT_ISSUED_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, PASSPORT_ISSUED_ON, 103)    
   END    
  ) AS PASSPORTDATEOFISSUE,    
 PASSPORT_ISSUED_AT AS PASSPORTPLACEOFISSUE,    
 (    
  CASE     
   WHEN YEAR(VOTERSID_ISSUED_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, VOTERSID_ISSUED_ON, 103)    
   END    
  ) AS VOTERIDDATEOFISSUE,    
 VOTERSID_ISSUED_AT AS VOTERIDPLACEOFISSUE,    
 (    
  CASE     
   WHEN YEAR(LICENCE_ISSUED_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, LICENCE_ISSUED_ON, 103)    
   END    
  ) AS LICENCENODATEOFISSUE,    
 LICENCE_ISSUED_AT AS LICENCENOPLACEOFISSUE,    
 (    
  CASE     
   WHEN YEAR(RAT_CARD_ISSUED_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, RAT_CARD_ISSUED_ON, 103)    
   END    
  ) AS RATIONCARDDATEOFISSUE,    
 RAT_CARD_ISSUED_AT AS RATIONCARDPLACEOFISSUE,    
 (    
  CASE     
   WHEN YEAR(PASSPORT_EXPIRES_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, PASSPORT_EXPIRES_ON, 103)    
   END    
  ) AS PASSPORT_EXPIRES_ON,    
 (    
  CASE     
   WHEN YEAR(LICENCE_EXPIRES_ON) = '1900'    
    THEN ''    
   ELSE CONVERT(VARCHAR, LICENCE_EXPIRES_ON, 103)    
   END    
  ) AS LICENCE_EXPIRES_ON,    
 BANK_NAME,    
 BRANCH_NAME,    
 AC_NUM AS AC_NUM,    
 (    
  CASE     
   WHEN AC_TYPE = 'S'    
    THEN 'SAVING'    
   WHEN AC_TYPE = 'C'    
    THEN 'CURRENT'    
   ELSE 'OTHER'    
   END    
  ) AS AC_TYPE,    
 BANKNAME = ISNULL(BANKNAME, 'N/A'),    
 DPID1 AS BANKID,    
 CLTDPID1 AS CLTDPID,    
 UPPER(DEPOSITORY1) AS DEPOSITORY,    
 --SYSTEMDATE = LEFT(MIN(SYSTEMDATE), 11),    
 BRANCH_CD = BR.BRANCH_CODE,    
 BRNAME = BR.BRANCH,    
 BRADD1 = BR.ADDRESS1,    
 BRADD2 = BR.ADDRESS2,    
 BRCITY = BR.CITY,    
 BRZIP = BR.ZIP,    
 BRPHONE1 = BR.PHONE1,    
 BRPHONE2 = BR.PHONE2,    
 BREMAIL = BR.EMAIL,    
 FLAG_NODETAIL,FLAG_PASSPORTDET,FLAG_LICENCEDET,FLAG_VOTERDET,    
 FLAG_RATCARDDET,FLAG_BANKDET,FLAG_DPDET,FLAG_BROKDET    
    
FROM     
 MSAJAG.DBO.CLIENT_BROK_DETAILS CB,    
 MSAJAG.DBO.CLIENT_DETAILS CD    
 LEFT JOIN BANK BA    
 ON (DPID1 = BANKID)    
 LEFT JOIN BRANCH BR    
 ON (BR.BRANCH_CODE = CD.BRANCH_CD),    
 MSAJAG.DBO.CLS_CLIENT_SETTING    
     
WHERE     
    CB.CL_CODE = CD.CL_CODE    
 AND PARTY_CODE >= @FROMPARTY    
 AND PARTY_CODE <= @TOPARTY    
 AND SYSTEMDATE >= @FROMDATE    
 AND SYSTEMDATE <= @TODATE + ' 23:59:59'    
GROUP BY CD.LONG_NAME,    
 L_ADDRESS1,    
 L_ADDRESS2,    
 L_ADDRESS3,    
 L_CITY,    
 L_ZIP,    
 PARTY_CODE,    
 RES_PHONE1,    
 RES_PHONE2,    
 OFF_PHONE1,    
 OFF_PHONE2,    
 MOBILE_PAGER,    
 PAN_GIR_NO,    
 CD.EMAIL,    
 PASSPORT_NO,    
 VOTERSID_NO,    
 RAT_CARD_NO,    
 LICENCE_NO,    
 PASSPORT_ISSUED_ON,    
 PASSPORT_ISSUED_AT,    
 VOTERSID_ISSUED_ON,    
 PASSPORT_EXPIRES_ON,    
 LICENCE_EXPIRES_ON,    
 VOTERSID_ISSUED_AT,    
 LICENCE_ISSUED_ON,    
 LICENCE_ISSUED_AT,    
 RAT_CARD_ISSUED_ON,    
 RAT_CARD_ISSUED_AT,    
 BANK_NAME,    
 BRANCH_NAME,    
 AC_NUM,    
 AC_TYPE,    
 BA.BANKNAME,    
CD.DPID1,    
 CD.CLTDPID1,    
 CD.DEPOSITORY1,    
 BR.BRANCH_CODE,    
 BR.BRANCH,    
 BR.ADDRESS1,    
 BR.ADDRESS2,    
 BR.CITY,    
 BR.ZIP,    
 BR.PHONE1,    
 BR.PHONE2,    
 BR.EMAIL,    
 FLAG_NODETAIL,FLAG_PASSPORTDET,FLAG_LICENCEDET,FLAG_VOTERDET,FLAG_RATCARDDET,    
 FLAG_BANKDET,FLAG_DPDET,FLAG_BROKDET    
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENT_SUMMARY
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_CLIENT_SUMMARY]
(
@FROMDATE VARCHAR(11),
@TODATE VARCHAR(11),
@FROMPARTY VARCHAR(25),
@TOPARTY VARCHAR(25)
)
AS 
--EXEC CLS_CLIENT_SUMMARY '10/09/2014','10/09/2015','0','zzzzzz'
IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
BEGIN
	SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
END
IF LEN(@TODATE) = 10 AND CHARINDEX('/', @TODATE) > 0
BEGIN
	SET @TODATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TODATE, 103), 109)
END


SELECT 
	DISTINCT 
	[CLIENT CODE]=PARTY_CODE,
	[CLIENT NAME]=CD.LONG_NAME,
	[REGISTRATION DATE] = CONVERT(VARCHAR,MIN(SYSTEMDATE),103)
FROM 
    MSAJAG.DBO.CLIENT_BROK_DETAILS CB,
	MSAJAG.DBO.CLIENT_DETAILS CD
WHERE 
    CB.CL_CODE = CD.CL_CODE
	AND PARTY_CODE >= @FROMPARTY
	AND PARTY_CODE <= @TOPARTY
	AND SYSTEMDATE >= @FROMDATE
	AND SYSTEMDATE <= @TODATE + ' 23:59:59'
GROUP BY CD.LONG_NAME,
	PARTY_CODE
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTBROKTABLEDETAILS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_CLIENTBROKTABLEDETAILS]
(@PARTY_CODE VARCHAR(25))
AS      

--EXEC DBO.[CLS_CLIENTBROKTABLEDETAILS] @PARTY_CODE='0A141'

CREATE TABLE #BROKTABLE(
	[TABLE_NO] [smallint] NOT NULL,
	[UPPER_LIM] [money] NULL,
	[DAY_PUC] [float] NULL,
	[DAY_SALES] [float] NULL,
	[SETT_PURCH] [float] NULL,
	[SETT_SALES] [float] NULL,
	[NORMAL] [float] NULL,
	[TRD_DEL] [char](1) NULL,
	[VAL_PERC] [char](1) NULL,
	[LINE_NO] [decimal](3, 0) NOT NULL,
	[TABLE_NAME] [char](25) NULL,
	[ROUND_TO] [decimal](10, 2) NULL,
	[ROFIG] [int] NULL,
	[ERRNUM] [money] NULL,
	[NOZERO] [int] NULL,
	[RT] [varchar](7) NULL,
	[EXCHANGE] [varchar](3) NOT NULL,
	[SEGMENT] [varchar](7) NOT NULL,
	[TABLETYPE] [varchar](20) NULL,
	[ORDFLAG] [int] NOT NULL
) ON [PRIMARY]



IF  EXISTS (SELECT EXCHANGE FROM PRADNYA..CLS_MULTICOMPANY WHERE EXCHANGE='NSE' AND SEGMENT ='CAPITAL' AND PRIMARYSERVER=1)
BEGIN
	INSERT INTO #BROKTABLE
	SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,      
	ROFIG,ERRNUM,NOZERO,      
	RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE       
			( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE       
			 ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE      
		( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE      
		 ( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE       
		  ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'             
		  END )END )END )END )END )END ),
	EXCHANGE, SEGMENT, TABLETYPE = (CASE WHEN TABLE_NO = TRD_BROK THEN 'TRADING' ELSE 'DELIVERY' END),
	ORDFLAG = 2
	FROM BROKTABLE, MSAJAG.DBO.CLIENT_BROK_DETAILS C
	WHERE CL_CODE = @PARTY_CODE
	AND (TABLE_NO = TRD_BROK
	OR TABLE_NO = DEL_BROK) 
	AND EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL'
END

IF  EXISTS (SELECT EXCHANGE FROM PRADNYA..CLS_MULTICOMPANY WHERE EXCHANGE='BSE' AND SEGMENT ='CAPITAL' AND PRIMARYSERVER=1)
BEGIN
	INSERT INTO #BROKTABLE
	SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
	NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,      
	ROFIG,ERRNUM,NOZERO,      
	RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE       
			( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE       
			 ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE      
		( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE      
		 ( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE       
		  ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'             
		  END )END )END )END )END )END ),
	EXCHANGE, SEGMENT, TABLETYPE = (CASE WHEN TABLE_NO = TRD_BROK THEN 'TRADING' ELSE 'DELIVERY' END),
	ORDFLAG = 1
	FROM BSEDB..BROKTABLE, MSAJAG.DBO.CLIENT_BROK_DETAILS C
	WHERE CL_CODE = @PARTY_CODE
	AND (TABLE_NO = TRD_BROK
	OR TABLE_NO = DEL_BROK) 
	AND EXCHANGE = 'BSE' AND SEGMENT = 'CAPITAL'
END

IF  EXISTS (SELECT EXCHANGE FROM PRADNYA..CLS_MULTICOMPANY WHERE EXCHANGE='NSE' AND SEGMENT ='FUTURES' AND PRIMARYSERVER=1)
BEGIN
INSERT INTO #BROKTABLE
SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,      
ROFIG,ERRNUM,NOZERO,      
RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE       
        ( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE       
         ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE      
    ( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE      
     ( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE       
      ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'             
      END )END )END )END )END )END ),
EXCHANGE, SEGMENT, 
TABLETYPE = (CASE WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK 
		       AND FUT_OPT_BROK = FUT_FUT_FIN_BROK 
		       AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE ALL TYPE'
		  WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK THEN 'FUTURE/OPTION NORMAL'
		  WHEN TABLE_NO = FUT_FUT_FIN_BROK AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE/OPTION EXPIRY'
		  WHEN TABLE_NO = FUT_BROK THEN 'FUTURE NORMAL' 
	          WHEN TABLE_NO = FUT_OPT_BROK THEN 'OPTION NORMAL' 
	          WHEN TABLE_NO = FUT_FUT_FIN_BROK THEN 'FUTURE EXPIRY' 
	          WHEN TABLE_NO = FUT_OPT_EXC THEN 'OPTION EXERCISE' 
             END),
ORDFLAG = 3
FROM NSEFO..BROKTABLE, MSAJAG.DBO.CLIENT_BROK_DETAILS C
WHERE CL_CODE = @PARTY_CODE
AND (TABLE_NO = FUT_BROK
OR TABLE_NO = FUT_OPT_BROK
OR TABLE_NO = FUT_FUT_FIN_BROK
OR TABLE_NO = FUT_OPT_EXC) 
AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
END

IF  EXISTS (SELECT EXCHANGE FROM PRADNYA..CLS_MULTICOMPANY WHERE EXCHANGE='MCX' AND SEGMENT ='FUTURES' AND PRIMARYSERVER=1)
BEGIN
INSERT INTO #BROKTABLE
SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,      
ROFIG,ERRNUM,NOZERO,      
RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE       
( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE       
         ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE      
    ( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE      
     ( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE       
      ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'             
      END )END )END )END )END )END ),
EXCHANGE, SEGMENT, 
TABLETYPE = (CASE WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK 
		       AND FUT_OPT_BROK = FUT_FUT_FIN_BROK 
		       AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE ALL TYPE'
		  WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK THEN 'FUTURE/OPTION NORMAL'
		  WHEN TABLE_NO = FUT_FUT_FIN_BROK AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE/OPTION EXPIRY'
		  WHEN TABLE_NO = FUT_BROK THEN 'FUTURE NORMAL' 
	          WHEN TABLE_NO = FUT_OPT_BROK THEN 'OPTION NORMAL' 
	          WHEN TABLE_NO = FUT_FUT_FIN_BROK THEN 'FUTURE EXPIRY' 
	          WHEN TABLE_NO = FUT_OPT_EXC THEN 'OPTION EXERCISE'
	          WHEN TABLE_NO = DEL_BROK THEN 'DELIVERY BROKERAGE'  
             END),
ORDFLAG = 4
FROM MCDX..BROKTABLE, MSAJAG.DBO.CLIENT_BROK_DETAILS C
WHERE CL_CODE = @PARTY_CODE
AND (TABLE_NO = FUT_BROK
OR TABLE_NO = FUT_OPT_BROK
OR TABLE_NO = FUT_FUT_FIN_BROK
OR TABLE_NO = FUT_OPT_EXC
OR TABLE_NO = DEL_BROK) 
AND EXCHANGE = 'MCX' AND SEGMENT = 'FUTURES'
END

IF  EXISTS (SELECT EXCHANGE FROM PRADNYA..CLS_MULTICOMPANY WHERE EXCHANGE='NCE' AND SEGMENT ='FUTURES' AND PRIMARYSERVER=1)
BEGIN

INSERT INTO #BROKTABLE
SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,      
ROFIG,ERRNUM,NOZERO,      
RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE       
     ( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE       
         ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE      
    ( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE      
     ( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE       
      ( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'             
      END )END )END )END )END )END ),
EXCHANGE, SEGMENT, 
TABLETYPE = (CASE WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK 
		       AND FUT_OPT_BROK = FUT_FUT_FIN_BROK 
		       AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE ALL TYPE'
		  WHEN TABLE_NO = FUT_BROK AND FUT_BROK = FUT_OPT_BROK THEN 'FUTURE/OPTION NORMAL'
		  WHEN TABLE_NO = FUT_FUT_FIN_BROK AND FUT_FUT_FIN_BROK = FUT_OPT_EXC THEN 'FUTURE/OPTION EXPIRY'
		  WHEN TABLE_NO = FUT_BROK THEN 'FUTURE NORMAL' 
	          WHEN TABLE_NO = FUT_OPT_BROK THEN 'OPTION NORMAL' 
	          WHEN TABLE_NO = FUT_FUT_FIN_BROK THEN 'FUTURE EXPIRY' 
	          WHEN TABLE_NO = FUT_OPT_EXC THEN 'OPTION EXERCISE' 
	          WHEN TABLE_NO = DEL_BROK THEN 'DELIVERY BROKERAGE' 
             END),
ORDFLAG = 5
FROM NCE..BROKTABLE, MSAJAG.DBO.CLIENT_BROK_DETAILS C
WHERE CL_CODE = @PARTY_CODE
AND (TABLE_NO = FUT_BROK
OR TABLE_NO = FUT_OPT_BROK
OR TABLE_NO = FUT_FUT_FIN_BROK
OR TABLE_NO = FUT_OPT_EXC
OR TABLE_NO = DEL_BROK) 
AND EXCHANGE = 'NCE' AND SEGMENT = 'FUTURES'
ORDER BY ORDFLAG, EXCHANGE, SEGMENT, TABLE_NO, LINE_NO, UPPER_LIM
END

SELECT   TABLE_NO,UPPER_LIM=CONVERT(INT,UPPER_LIM),
		 DAY_PUC=CAST(DAY_PUC AS NUMERIC(10, 4)),
		 DAY_SALES=CAST(DAY_SALES AS NUMERIC(10, 4)),
		 SETT_PURCH=CAST(SETT_PURCH AS NUMERIC(10, 4)),
		 SETT_SALES=CAST(SETT_SALES AS NUMERIC(10, 4)),
		 NORMAL=CAST(NORMAL AS NUMERIC(10, 4)),
		 TRD_DEL,VAL_PERC,LINE_NO,
         TABLE_NAME,ROUND_TO,ROFIG,ERRNUM,NOZERO,RT,EXCHANGE=UPPER(EXCHANGE),SEGMENT=UPPER(SEGMENT),TABLETYPE,ORDFLAG
FROM     #BROKTABLE
ORDER BY ORDFLAG, EXCHANGE, SEGMENT, TABLE_NO, LINE_NO, UPPER_LIM

DROP TABLE #BROKTABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLIST_REPORT
-- --------------------------------------------------


-- EXEC CLS_CLIENTLIST_REPORT '30/07/2014','30/07/2014','','','','','ALL','PARTYCODE','BRANCH','STAFF'

CREATE PROCEDURE  [dbo].[CLS_CLIENTLIST_REPORT]
 (
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@CLTYPE VARCHAR(10) ='',
	@CLTSTATUS VARCHAR(10)='',
	@FILTERCD VARCHAR(10) ='ALL',
	@ORDER_BY AS VARCHAR(16)='PARTYCODE',
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
 )
 
 AS
 
 
 /*
	@FILTERCD
	A 		 - 	 ACTIVE
	IN 		 - 	 INACTIVE
	ACT 	 - 	 ACTIVATED
	DACT 	 - 	 DEACTIVATED
	MAIL 	 - 	 NOT HAVING MAIL ID
	PAN 	 - 	 NOT HAVING PAN NO
	TELR 	 - 	 NOT HAVING TELEPHONE (R)
	TELO 	 - 	 NOT HAVING TELEPHONE (O)
	MOBILE 	 - 	 NOT HAVING MOBILE
	FAX 	 - 	 NOT HAVING FAX
	ADD1 	 - 	 NOT HAVING ADDRESS1
	ADD2 	 - 	 NOT HAVING ADDRESS2
	ADD3 	 - 	 NOT HAVING ADDRESS3
	CITY 	 - 	 NOT HAVING CITY
	STATE 	 - 	 NOT HAVING STATE
	ZIP 	 - 	 NOT HAVING ZIP
	
	
	@ORDER_BY
	BRANCH		-	BRANCH
	PARTYCODE	-	PARTY CODE
	CLIENT		-	CLIENT NAME
	ACTIVE		-	ACTIVE
	INACTIVE	-	INACTIVE

*/

SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)

IF @TOPARTY =''
SET @TOPARTY = 'ZZZZZZZ'

SELECT            
    C1.CL_CODE,         
    C1.SHORT_NAME,         
    C1.LONG_NAME,         
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,         
    ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,         
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,
	ORDERBY = (          
    CASE           
        WHEN @ORDER_BY = 'BRANCH'           
        THEN C1.BRANCH_CD+C2.PARTY_CODE           
        ELSE       
        CASE
            WHEN @ORDER_BY = 'PARTYCODE'           
            THEN C2.PARTY_CODE           
            ELSE           
            CASE           
                WHEN @ORDER_BY = 'CLIENT'           
                THEN C1.SHORT_NAME+C2.PARTY_CODE           
                ELSE           
                CASE           
                    WHEN @ORDER_BY = 'ACTIVE'           
                    THEN CONVERT(VARCHAR(11),ACTIVEFROM)+C2.PARTY_CODE           
                    ELSE           
                    CASE           
                        WHEN @ORDER_BY = 'INACTIVE'           
                        THEN CONVERT(VARCHAR(11),INACTIVEFROM)+C2.PARTY_CODE        
                    END           
                END           
            END           
        END           
    END           
    )        
FROM CLIENT1 C1 (NOLOCK),    
CLIENT5 CL5 (NOLOCK), 
CLIENT2 C2 (NOLOCK)  
WHERE  1 = (CASE WHEN @FILTERCD='' THEN CASE WHEN CL5.ACTIVEFROM BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'  THEN 1 ELSE 2 END ELSE   
	   CASE WHEN @FILTERCD = 'MAIL' THEN (CASE WHEN C1.EMAIL = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'PAN' THEN (CASE WHEN C1.PAN_GIR_NO = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELR' THEN (CASE WHEN C1.RES_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELO' THEN (CASE WHEN C1.OFF_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'MOBILE' THEN (CASE WHEN C1.MOBILE_PAGER = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'FAX' THEN (CASE WHEN C1.FAX = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD1' THEN (CASE WHEN C1.L_ADDRESS1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD2' THEN (CASE WHEN C1.L_ADDRESS2 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD3' THEN (CASE WHEN C1.L_ADDRESS3 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'CITY' THEN (CASE WHEN C1.L_CITY = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'STATE' THEN (CASE WHEN C1.L_STATE = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ZIP' THEN (CASE WHEN C1.L_ZIP = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'A' THEN (CASE WHEN GETDATE() BETWEEN ACTIVEFROM AND INACTIVEFROM THEN 1 ELSE 2 END)
	   WHEN @FILTERCD = 'IN' THEN (CASE WHEN INACTIVEFROM < GETDATE()  THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'ACT' THEN (CASE WHEN CL5.ACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59' THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'DACT' THEN (CASE WHEN CL5.INACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59'  THEN 1 ELSE 2 END) 
     ELSE 1
    END
    END )      
	AND	
C1.CL_CODE = CL5.CL_CODE
AND C1.CL_CODE = C2.CL_CODE        
AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND CL5.SYSTUMDATE BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'
	AND CL_TYPE  = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
	AND CL_STATUS  = CASE WHEN @CLTSTATUS = '' THEN CL_STATUS ELSE @CLTSTATUS END
	AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
		WHEN @STATUSID = 'TRADER' THEN C1.TRADER
		WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
		WHEN @STATUSID = 'AREA' THEN C1.AREA
		WHEN @STATUSID = 'REGION' THEN C1.REGION
		WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
	ELSE 'BROKER' END)
ORDER BY 8

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLOSING_RATE
-- --------------------------------------------------


  
CREATE PROC [dbo].[CLS_CLOSING_RATE]  
 (  
	@FRMDATE VARCHAR(10),  
	@TODATE  VARCHAR(10),
	@SCRIPCD VARCHAR(20),
	@INST_TYPE VARCHAR(3)
 )  
   
 AS  
  
 --EXEC CLS_CLOSING_RATE '01/05/2000','31/12/2014' ,'' ,'' 
   
 DECLARE @R_FRMDATE VARCHAR(11),  
   @R_TODATE VARCHAR(11)  
   
 SELECT @R_FRMDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FRMDATE,103),109)  
 SELECT @R_TODATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE,103),109)  
   
 SELECT  
	TRADE_DATE=CONVERT(VARCHAR(11),TRADE_DATE,103),
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE = CONVERT(VARCHAR(11),EXPIRYDATE,103),
	STRIKE_PRICE,
	OPTION_TYPE,
	CL_RATE
 FROM  
  FOCLOSING (NOLOCK)  
 WHERE  
  TRADE_DATE BETWEEN @R_FRMDATE AND @R_TODATE + ' 23:59:59' 
  AND SYMBOL = (CASE WHEN @SCRIPCD = '' THEN SYMBOL ELSE @SCRIPCD END)
  AND LEFT(INST_TYPE,3) = (CASE WHEN @INST_TYPE = '' THEN LEFT(INST_TYPE,3) ELSE @INST_TYPE END)
 ORDER BY  1,2,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CONFIRMATION
-- --------------------------------------------------



--- EXEC [CLS_CONFIRMATION] '30/04/2015','S116725','S116725','','ZZZZZZ','','ZZZZZZZ','BROKER','BROKER',0


CREATE PROCEDURE [dbo].[CLS_CONFIRMATION] 
	(
	@FDATEFROM	VARCHAR(11),
	@FPARTYCODE VARCHAR(20),
	@TPARTYCODE VARCHAR(20),
	@FBRANCH	VARCHAR(20),
	@TBRANCH	VARCHAR(20),
	@FSUBBROKER VARCHAR(20),
	@TSUBBROKER VARCHAR(20),
	@STATUSID	VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@RPT_TYPE	INT = 1
	)

AS

IF @TBRANCH = ''
BEGIN
	SET @TBRANCH = 'zzzzzzzzzzzz'
END

IF @TSUBBROKER = ''
BEGIN
	SET @TSUBBROKER = 'zzzzzzzzzzzz'
END

IF @TPARTYCODE = ''
BEGIN
	SET @TPARTYCODE = 'zzzzzzzzzzzz'
END

IF LEN(@FDATEFROM) = 10 AND CHARINDEX('/',@FDATEFROM) > 0    
BEGIN
	SET @FDATEFROM = CONVERT(VARCHAR (11), CONVERT(DATETIME,@FDATEFROM,103),109)
END

DECLARE @MYRECCOUNT INT

SET @MYRECCOUNT = 0

SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT	ORDER_NO,
		TRADE_NO,
		SAUDA_DATE,
		PARTY_CODE,
		CONTRACTNO,
		TRADEQTY,
		PRICE,
		AUCTIONPART,
		SELL_BUY,
		BROKAPPLIED,
		SERVICE_TAX,
		NETRATE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		BROKER_CHRG,
		TURN_TAX,
		SEBI_TAX,
		INS_CHRG,
		OTHER_CHRG,
		PARTICIPANTCODE,
		USER_ID,
		INSTRUMENT,
		BOOKTYPE
INTO	#FOSETT 
FROM	FOSETTLEMENT (NOLOCK)
WHERE	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
		AND PARTY_CODE >= @FPARTYCODE 
		AND PARTY_CODE <= @TPARTYCODE 
		AND TRADEQTY <> 0 

SELECT	@MYRECCOUNT = COUNT(1)
FROM	PRADNYA.DBO.DATAIN_HISTORY_FOSETTLEMENT_NSEFO
WHERE	SAUDA_DATE = @FDATEFROM

IF @MYRECCOUNT > 0
BEGIN
	INSERT	INTO #FOSETT
	SELECT	ORDER_NO,
			TRADE_NO,
			SAUDA_DATE,
			PARTY_CODE,
			CONTRACTNO,
			TRADEQTY,
			PRICE,
			AUCTIONPART,
			SELL_BUY,
			BROKAPPLIED,
			SERVICE_TAX,
			NETRATE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			BROKER_CHRG,
			TURN_TAX,
			SEBI_TAX,
			INS_CHRG,
			OTHER_CHRG,
			PARTICIPANTCODE,
			USER_ID,
			INSTRUMENT,
			BOOKTYPE			
	FROM	PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
			AND PARTY_CODE >= @FPARTYCODE 
			AND PARTY_CODE <= @TPARTYCODE 
			AND TRADEQTY <> 0 
END


SELECT C2.PARTY_CODE,
	C1.LONG_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_STATE,
	C1.L_ZIP,
	C1.BRANCH_CD,
	C1.SUB_BROKER,
	C1.TRADER,
	C1.PAN_GIR_NO,
	C1.RES_PHONE1,
	C1.RES_PHONE2,
	C2.SERVICE_CHRG,
	BROKERNOTE,
	TURNOVER_TAX,
	SEBI_TURN_TAX,
	C2.OTHER_CHRG,
	INSURANCE_CHRG
INTO #CLIENTMASTER
FROM 
	CLIENT1 C1 WITH (NOLOCK),
	CLIENT2 C2 WITH (NOLOCK)
WHERE C2.CL_CODE = C1.CL_CODE 
	AND C2.PARTY_CODE BETWEEN @FPARTYCODE AND @TPARTYCODE 
	AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = C2.PARTY_CODE)
	AND @STATUSNAME = (
		CASE 
			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY
			WHEN @STATUSID = 'AREA'			THEN C1.AREA
			WHEN @STATUSID = 'REGION'		THEN C1.REGION
			WHEN @STATUSID = 'CLIENT'		THEN C2.PARTY_CODE
			ELSE 'BROKER'
			END
		) 
		AND BRANCH_CD BETWEEN @FBRANCH AND @TBRANCH
		AND SUB_BROKER BETWEEN @FSUBBROKER AND @TSUBBROKER


IF @RPT_TYPE = 1
BEGIN
	SELECT
		CLIENT_CODE = PARTY_CODE,
		CLIENT_NAME = LONG_NAME
	FROM
		#CLIENTMASTER
	ORDER BY
		PARTY_CODE
	
	RETURN
END

---===================================================================---

SELECT 
	ORDER_NO = (
		CASE 
			WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 2	THEN 'EXERCISE'
			WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 1	THEN 'ASSIGNMENT'
			ELSE ORDER_NO
			END
		),
	TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
	TRADETIME = CONVERT(VARCHAR, SAUDA_DATE, 108),
	TRADEQTY,
	PRICE = ISNULL(PRICE, 0),
	PQTY = (
		CASE 
			WHEN SELL_BUY = 1
				THEN TRADEQTY
			ELSE 0
			END
		),
	SQTY = (
		CASE 
			WHEN SELL_BUY = 2
				THEN TRADEQTY
			ELSE 0
			END
		),
	BROKAPPLIED = CONVERT(MONEY, ISNULL(BROKAPPLIED + (
				CASE 
					WHEN C.SERVICE_CHRG = 1
						THEN ISNULL(((F.SERVICE_TAX * INSTRUMENT/BOOKTYPE)/ TRADEQTY), 0)
					ELSE 0
					END
				), 0)),
	TOTBROKAPPLIED = CONVERT(MONEY, ISNULL((BROKAPPLIED * TRADEQTY * BOOKTYPE/INSTRUMENT) + (
				CASE 
					WHEN C.SERVICE_CHRG = 1
						THEN ISNULL(F.SERVICE_TAX, 0)
					ELSE 0
					END
				), 0)),
	NETRATE = (
	CASE
		WHEN SELL_BUY = 1 THEN NETRATE + (
				CASE 
					WHEN C.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX * INSTRUMENT/BOOKTYPE)/ TRADEQTY), 0)
					ELSE 0
				END)
		ELSE NETRATE - (
				CASE 
					WHEN C.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX * INSTRUMENT/BOOKTYPE)/ TRADEQTY), 0)
					ELSE 0
				END)
	END),
	INST_TYPE = F.INST_TYPE,
	SYMBOL = F.SYMBOL,
	AMT = (
		CASE 
			WHEN SELL_BUY = 1
				THEN - (
						(TRADEQTY * NETRATE * BOOKTYPE/INSTRUMENT) + (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL(F.SERVICE_TAX, 0)
								ELSE 0
								END
							)
						)
			ELSE (
					(TRADEQTY * NETRATE * BOOKTYPE/INSTRUMENT) - (
						CASE 
							WHEN C.SERVICE_CHRG = 1
								THEN ISNULL(F.SERVICE_TAX, 0)
							ELSE 0
							END
						)
					)
			END
		),
	EXPIRYDATE = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 106), 11),
	EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 101), 11),
	F.PARTY_CODE,
	SELL_BUY = (
		CASE 
			WHEN SELL_BUY = 1	THEN 'B'
			ELSE 'S'
			END
		),
	CONTRACTNO,
	SAUDA_DATE = CONVERT(VARCHAR, SAUDA_DATE, 103),
	STRIKE_PRICE = ISNULL(F.STRIKE_PRICE, 0),
	F.OPTION_TYPE,
	YY = YEAR(SAUDA_DATE),
	MM = MONTH(SAUDA_DATE),
	DD = DAY(SAUDA_DATE),
	SERVICE_TAX = (
		CASE 
			WHEN C.SERVICE_CHRG = 0
				THEN (F.SERVICE_TAX)
			ELSE 0
			END
		),
	BROKER_CHRG = (
		CASE 
			WHEN BROKERNOTE = 1
				THEN (BROKER_CHRG)
			ELSE 0
			END
		),
	TURN_TAX = (
		CASE 
			WHEN TURNOVER_TAX = 1
				THEN (TURN_TAX)
			ELSE 0
			END
		),
	SEBI_TAX = (
		CASE 
			WHEN SEBI_TURN_TAX = 1
				THEN (SEBI_TAX)
			ELSE 0
			END
		),
	INSURANCE_CHRG = (
		CASE 
			WHEN INSURANCE_CHRG = 1
				THEN (INS_CHRG)
			ELSE 0
			END
		),
	OTHER_CHRG = (
		CASE 
			WHEN C.OTHER_CHRG = 1
				THEN (F.OTHER_CHRG)
			ELSE 0
			END
		),
	STAX = FOGLOBALS.SERVICE_TAX,
	CESSTAX = FOGLOBALS.CESS_TAX,
	PARTYNAME = C.LONG_NAME,
	C.L_ADDRESS1,
	C.L_ADDRESS2,
	C.L_ADDRESS3,
	C.L_CITY,
	C.L_STATE,
	C.L_ZIP,
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	C.PAN_GIR_NO,
	C.RES_PHONE1,
	C.RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID
INTO #CONFIRMATION_TEMP
FROM #FOSETT F(NOLOCK),
	#CLIENTMASTER C(NOLOCK),
	FOSCRIP2 FOS2(NOLOCK),
	FOGLOBALS(NOLOCK)
WHERE 
	SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59'
	AND F.PARTY_CODE >= @FPARTYCODE 
	AND F.PARTY_CODE <= @TPARTYCODE 
	AND TRADEQTY <> 0 
	AND F.SYMBOL = FOS2.SYMBOL 
	AND F.INST_TYPE = FOS2.INST_TYPE 
	AND F.EXPIRYDATE = FOS2.EXPIRYDATE 
	AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE 
	AND F.OPTION_TYPE = FOS2.OPTION_TYPE 
	AND F.PARTY_CODE = C.PARTY_CODE 
	AND F.AUCTIONPART <> 'CA' 
	AND F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT


IF @MYRECCOUNT > 0
BEGIN
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	INSERT INTO #CONFIRMATION_TEMP
	SELECT ORDER_NO = (
			CASE 
				WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 2	THEN 'EXERCISE'
				WHEN AUCTIONPART = 'EA' AND LEFT(F.INST_TYPE,3) = 'OPT' AND SELL_BUY = 1	THEN 'ASSIGNMENT'
				ELSE ORDER_NO
				END
			),
		TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
		TRADETIME = CONVERT(VARCHAR, SAUDA_DATE, 108),
		TRADEQTY,
		PRICE = ISNULL(PRICE, 0),
		PQTY = (
			CASE 
				WHEN SELL_BUY = 1
					THEN TRADEQTY
				ELSE 0
				END
			),
		SQTY = (
			CASE 
				WHEN SELL_BUY = 2
					THEN TRADEQTY
				ELSE 0
				END
			),
		BROKAPPLIED = CONVERT(MONEY, ISNULL(BROKAPPLIED + (
					CASE 
						WHEN C.SERVICE_CHRG = 1
							THEN ISNULL(((F.SERVICE_TAX* INSTRUMENT/BOOKTYPE) / TRADEQTY), 0)
						ELSE 0
						END
					), 0)),
		TOTBROKAPPLIED = CONVERT(MONEY, ISNULL((BROKAPPLIED * TRADEQTY * BOOKTYPE/INSTRUMENT) + (
					CASE 
						WHEN C.SERVICE_CHRG = 1
							THEN ISNULL(F.SERVICE_TAX, 0)
						ELSE 0
						END
					), 0)),
		NETRATE = (
		CASE
			WHEN SELL_BUY = 1 THEN NETRATE + (
					CASE 
						WHEN C.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX * INSTRUMENT/BOOKTYPE)/ TRADEQTY), 0)
						ELSE 0
					END)
			ELSE NETRATE - (
					CASE 
						WHEN C.SERVICE_CHRG = 1 THEN ISNULL(((F.SERVICE_TAX * INSTRUMENT/BOOKTYPE)/ TRADEQTY), 0)
						ELSE 0
					END)
		END),
		INST_TYPE = F.INST_TYPE,
		SYMBOL = F.SYMBOL,
		AMT = (
			CASE 
				WHEN SELL_BUY = 1
					THEN - (
							(TRADEQTY * NETRATE * BOOKTYPE/INSTRUMENT) + (
								CASE 
									WHEN C.SERVICE_CHRG = 1
										THEN ISNULL(F.SERVICE_TAX, 0)
									ELSE 0
									END
								)
							)
				ELSE (
						(TRADEQTY * NETRATE * BOOKTYPE/INSTRUMENT) - (
							CASE 
								WHEN C.SERVICE_CHRG = 1
									THEN ISNULL(F.SERVICE_TAX, 0)
								ELSE 0
								END
							)
						)
				END
			),
		EXPIRYDATE = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 106), 11),
		EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR, F.EXPIRYDATE, 101), 11),
		F.PARTY_CODE,
		SELL_BUY = (
			CASE 
				WHEN SELL_BUY = 1
					THEN 'B'
				ELSE 'S'
				END
			),
		CONTRACTNO,
		SAUDA_DATE = CONVERT(VARCHAR, SAUDA_DATE, 103),
		STRIKE_PRICE = ISNULL(F.STRIKE_PRICE, 0),
		F.OPTION_TYPE,
		YY = YEAR(SAUDA_DATE),
		MM = MONTH(SAUDA_DATE),
		DD = DAY(SAUDA_DATE),
		SERVICE_TAX = (
			CASE 
				WHEN C.SERVICE_CHRG = 0
					THEN (F.SERVICE_TAX)
				ELSE 0
				END
			),
		BROKER_CHRG = (
			CASE 
				WHEN BROKERNOTE = 1
					THEN (BROKER_CHRG)
				ELSE 0
				END
			),
		TURN_TAX = (
			CASE 
				WHEN TURNOVER_TAX = 1
					THEN (TURN_TAX)
				ELSE 0
				END
			),
		SEBI_TAX = (
			CASE 
				WHEN SEBI_TURN_TAX = 1
					THEN (SEBI_TAX)
				ELSE 0
				END
			),
		INSURANCE_CHRG = (
			CASE 
				WHEN INSURANCE_CHRG = 1
					THEN (INS_CHRG)
				ELSE 0
				END
			),
		OTHER_CHRG = (
			CASE 
				WHEN C.OTHER_CHRG = 1
					THEN (F.OTHER_CHRG)
				ELSE 0
				END
			),
		STAX = FOGLOBALS.SERVICE_TAX,
		CESSTAX = FOGLOBALS.CESS_TAX,
		PARTYNAME = C.LONG_NAME,
		C.L_ADDRESS1,
		C.L_ADDRESS2,
		C.L_ADDRESS3,
		C.L_CITY,
		C.L_STATE,
		C.L_ZIP,
		C.BRANCH_CD,
		C.SUB_BROKER,
		C.TRADER,
		C.PAN_GIR_NO,
		C.RES_PHONE1,
		C.RES_PHONE2,
		PARTICIPANTCODE,
		USER_ID
	FROM #FOSETT F(NOLOCK),
		#CLIENTMASTER C(NOLOCK),
		FOSCRIP2 FOS2(NOLOCK),
		FOGLOBALS(NOLOCK)
	WHERE F.SYMBOL = FOS2.SYMBOL 
		AND F.INST_TYPE = FOS2.INST_TYPE 
		AND F.EXPIRYDATE = FOS2.EXPIRYDATE 
		AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE 
		AND F.OPTION_TYPE = FOS2.OPTION_TYPE 
		AND F.PARTY_CODE >= @FPARTYCODE AND F.PARTY_CODE <= @TPARTYCODE 
		AND SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59' 
		AND TRADEQTY <> 0 
		AND F.PARTY_CODE = C.PARTY_CODE 
		AND F.AUCTIONPART <> 'CA' 
		AND F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
END

---===================================================================---      
SELECT ORDER_NO = ORDER_NO,
	TRADE_NO = TRADE_NO,
	TRADETIME = TRADETIME,
	TRADEQTY = SUM(TRADEQTY),
	PRICE = SUM(PRICE * TRADEQTY) / SUM(TRADEQTY),
	PQTY = SUM(PQTY),
	SQTY = SUM(SQTY),
	BROKAPPLIED = SUM(BROKAPPLIED),
	TOTBROKAPPLIED = SUM(TOTBROKAPPLIED),
	NETRATE = SUM(NETRATE * TRADEQTY) / SUM(TRADEQTY),
	INST_TYPE = INST_TYPE,
	SYMBOL = SYMBOL,
	AMT = SUM(AMT),
	EXPIRYDATE = EXPIRYDATE,
	EXPIRYDATE_ANX = EXPIRYDATE_ANX,
	CLIENT_CODE = PARTY_CODE,
	SELL_BUY = SELL_BUY,
	CONTRACTNO = CONTRACTNO,
	SAUDA_DATE = SAUDA_DATE,
	STRIKE_PRICE = STRIKE_PRICE,
	OPTION_TYPE = OPTION_TYPE,
	YY,
	MM,
	DD,
	SERVICE_TAX = SUM(SERVICE_TAX),
	BROKER_CHRG = SUM(BROKER_CHRG),
	TURN_TAX = SUM(TURN_TAX),
	SEBI_TAX = SUM(SEBI_TAX),
	INSURANCE_CHRG = SUM(INSURANCE_CHRG),
	OTHER_CHRG = SUM(OTHER_CHRG),
	STAX = STAX,
	CESSTAX = CESSTAX,
	CLIENT_NAME = PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PAN_GIR_NO,
	RES_PHONE1,
	RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID,
	TOT_SERVICE_TAX = CONVERT(NUMERIC(20,4),0),
	EDUCESS_TAX = CONVERT(NUMERIC(20,4),0),
	SBC_CHRG = CONVERT(NUMERIC(20,4),0),
	KRISHICESS_CHRG = CONVERT(NUMERIC(20,4),0)	
INTO #CONFIRMATION
FROM #CONFIRMATION_TEMP(NOLOCK)
GROUP BY ORDER_NO,
	TRADE_NO,
	TRADETIME,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	EXPIRYDATE_ANX,
	PARTY_CODE,
	SELL_BUY,
	CONTRACTNO,
	SAUDA_DATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	YY,
	MM,
	DD,
	STAX,
	CESSTAX,
	PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP,
	BRANCH_CD,
	SUB_BROKER,
	TRADER,
	PAN_GIR_NO,
	RES_PHONE1,
	RES_PHONE2,
	PARTICIPANTCODE,
	USER_ID

---===================================================================---      
UPDATE #CONFIRMATION
SET NETRATE = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN PRICE + CD_TOT_BUYBROK / TRADEQTY + CASE 
						WHEN SERVICE_CHRG = 1
							THEN CD_TOT_BUYSERTAX / TRADEQTY
						ELSE 0
						END
			ELSE PRICE - CD_TOT_SELLBROK / TRADEQTY - CASE 
					WHEN SERVICE_CHRG = 1
						THEN CD_TOT_SELLSERTAX / TRADEQTY
					ELSE 0
					END
			END
		),
	TOTBROKAPPLIED = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN CD_TOT_BUYBROK
			ELSE CD_TOT_SELLBROK
			END + CASE 
			WHEN SERVICE_CHRG = 1
				THEN CASE 
						WHEN SELL_BUY = 'B'
							THEN CD_TOT_BUYSERTAX
						ELSE CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CASE 
						WHEN SELL_BUY = 'B'
							THEN SERVICE_TAX + CD_TOT_BUYSERTAX
						ELSE SERVICE_TAX + CD_TOT_SELLSERTAX
						END
			ELSE 0
			END
		),
	AMT = (
		CASE 
			WHEN SELL_BUY = 'B'
				THEN - (
						PRICE * TRADEQTY + CD_TOT_BUYBROK + CASE 
							WHEN SERVICE_CHRG = 1
								THEN CD_TOT_BUYSERTAX
							ELSE 0
							END
						)
			ELSE PRICE * TRADEQTY - CD_TOT_SELLBROK - CASE 
					WHEN SERVICE_CHRG = 1
						THEN CD_TOT_SELLSERTAX
					ELSE 0
					END
			END
		)
FROM CHARGES_DETAIL D(NOLOCK),
	#CLIENTMASTER C(NOLOCK)
WHERE CONVERT(VARCHAR, CD_SAUDA_DATE, 103) = CONVERT(VARCHAR, SAUDA_DATE, 103) 
	AND CD_PARTY_CODE = C.PARTY_CODE 
	AND CD_PARTY_CODE = #CONFIRMATION.CLIENT_CODE 
	AND CD_INST_TYPE = INST_TYPE 
	AND CD_SYMBOL = SYMBOL 
	AND CONVERT(VARCHAR, CD_EXPIRY_DATE, 106) = EXPIRYDATE 
	AND CD_OPTION_TYPE = OPTION_TYPE 
	AND CD_STRIKE_PRICE = STRIKE_PRICE 
	AND CD_TRADE_NO = TRADE_NO 
	AND CD_ORDER_NO = (
		CASE 
			WHEN ORDER_NO = 'EXERCISE' OR ORDER_NO = 'ASSIGNMENT'
				THEN CD_ORDER_NO
			ELSE ORDER_NO
			END
		)

---===================================================================---      
INSERT INTO #CONFIRMATION
SELECT ORDER_NO = CD_ORDER_NO,
	TRADE_NO = CD_TRADE_NO,
	TRADETIME = '',
	TRADEQTY = 0,
	PRICE = 0,
	PQTY = 0,
	SQTY = 0,
	BROKAPPLIED = 0,
	TOTBROKAPPLIED = CD_TOT_BROK + (
		CASE 
			WHEN SERVICE_CHRG = 1 THEN CD_TOT_SERTAX
			ELSE 0
			END
		),
	NETRATE = 0,
	INST_TYPE = CD_INST_TYPE,
	SYMBOL = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN 'CONT BROK'
			ELSE CD_SYMBOL
			END
		),
	AMT = 0,
	EXPIRYDATE = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 106), 11)
			END
		),
	EXPIRYDATE_ANX = (
		CASE 
			WHEN CD_SYMBOL = ''
				THEN ''
			ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 101), 11)
			END
		),
	PARTY_CODE = CD_PARTY_CODE,
	SELL_BUY = (
		CASE
			WHEN CD_TOT_BUYBROK > 0 THEN 'B'
			ELSE 'S'
		END),
	CONTRACTNO = CD_CONTRACT_NO,
	SAUDA_DATE = CONVERT(VARCHAR, CD_SAUDA_DATE, 103),
	STRIKE_PRICE = ISNULL(F.CD_STRIKE_PRICE, 0),
	OPTION_TYPE = CD_OPTION_TYPE,
	YY = YEAR(CD_SAUDA_DATE),
	MM = MONTH(CD_SAUDA_DATE),
	DD = DAY(CD_SAUDA_DATE),
	SERVICE_TAX = (
		CASE 
			WHEN SERVICE_CHRG = 0
				THEN CD_TOT_SERTAX
			ELSE 0
			END
		),
	BROKER_CHRG = 0,
	TURN_TAX = 0,
	SEBI_TAX = 0,
	INSURANCE_CHRG = 0,
	OTHER_CHRG = 0,
	STAX = 0,
	CESSTAX = 0,
	PARTYNAME = C.LONG_NAME,
	C.L_ADDRESS1,
	C.L_ADDRESS2,
	C.L_ADDRESS3,
	C.L_CITY,
	C.L_STATE,
	C.L_ZIP,
	C.BRANCH_CD,
	C.SUB_BROKER,
	C.TRADER,
	C.PAN_GIR_NO,
	C.RES_PHONE1,
	C.RES_PHONE2,
	PARTICIPANTCODE = '',
	USER_ID = '',
	TOT_SERVICE_TAX = 0,
	EDUCESS_TAX = 0,
	SBC_CHRG = 0,
	KRISHICESS_CHRG = 0	
FROM CHARGES_DETAIL F,
	#CLIENTMASTER C
WHERE 
	CD_SAUDA_DATE BETWEEN @FDATEFROM AND @FDATEFROM + ' 23:59:59' 
	AND CD_PARTY_CODE >= '0' AND CD_PARTY_CODE <= 'zzzzzzzzz' 
	AND CD_CONTRACT_NO BETWEEN (
				CASE 
					WHEN LEFT(CD_INST_TYPE,3) = 'OPT' AND CD_AUCTIONPART = 'EA' THEN 0
					ELSE '0'
					END
				)
		AND '9999' 
		AND CD_PARTY_CODE = C.PARTY_CODE 
		AND CD_TRADE_NO = '' 



SELECT	CLIENT_CODE,
		SAUDA_DATE,
		SERVICE_TAX = SUM(SERVICE_TAX)
INTO	#SUMMARY		
FROM	#CONFIRMATION
GROUP BY
		CLIENT_CODE,
		SAUDA_DATE
		

UPDATE	#CONFIRMATION
SET		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S,#CONFIRMATION
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE


UPDATE	#CONFIRMATION
SET		EDUCESS_TAX = (
		CASE
			--WHEN ISNULL(CESS_TAX,0) <> 0 THEN ((S.SERVICE_TAX * 100 / G.SERVICE_TAX) * CESS_TAX / 100)
			WHEN ISNULL(CESS_TAX,0) <> 0 THEN (S.SERVICE_TAX - (S.SERVICE_TAX*100/(100+CESS_TAX)))
			ELSE 0
		END),
		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S, FOGLOBALS G
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE
		AND (CONVERT(DATETIME,S.SAUDA_DATE,103) BETWEEN YEAR_START_DT AND YEAR_END_DT)
		AND ISNULL(CESS_TAX,0) <> 0


UPDATE	#CONFIRMATION
SET		SBC_CHRG = (
		CASE
			WHEN ISNULL(SBCCHARGE,0) <> 0 THEN ((S.SERVICE_TAX * 100 / G.SERVICE_TAX) * SBCCHARGE / 100)
			ELSE 0
		END),
		TOT_SERVICE_TAX = ISNULL(S.SERVICE_TAX,0)
FROM	#SUMMARY S, FOGLOBALS G
WHERE	S.CLIENT_CODE = #CONFIRMATION.CLIENT_CODE
		AND (CONVERT(DATETIME,S.SAUDA_DATE,103) BETWEEN YEAR_START_DT AND YEAR_END_DT)
		AND ISNULL(SBCCHARGE,0) <> 0
		

UPDATE	#CONFIRMATION
SET		TOT_SERVICE_TAX = (TOT_SERVICE_TAX - (ISNULL(EDUCESS_TAX,0)+ISNULL(SBC_CHRG,0)))


SELECT *
FROM #CONFIRMATION
ORDER BY YY,
	MM,
	DD,
	CLIENT_CODE,
	INST_TYPE,
	SYMBOL,
	OPTION_TYPE,
	STRIKE_PRICE,
	TRADETIME,
	ORDER_NO,
	TRADE_NO,
	SELL_BUY
	
	
DROP TABLE #FOSETT
DROP TABLE #CONFIRMATION
DROP TABLE #CLIENTMASTER
DROP TABLE #CONFIRMATION_TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CONFMEMO_HEADER
-- --------------------------------------------------

      
CREATE PROC [dbo].[CLS_CONFMEMO_HEADER]      
 (      
  @FROMDATE VARCHAR(11)      
 )      
       
 AS      
       
 /*      
 DECLARE @FROMDATE VARCHAR(11)      
 SET  @FROMDATE = '12/09/2014'      
 EXEC CLS_COMMON_CONTRACT_HEADER '17/03/2009'       
 */      
      
 CREATE TABLE #COMPANY_INFO      
  (      
  COMPANY   VARCHAR(100),       
  COMPANY_ADDR1 VARCHAR(100),       
  COMPANY_ADDR2 VARCHAR(100),       
  COMPANY_CITY VARCHAR(50),       
  COMPANY_ZIP  VARCHAR(10),       
  COMPANY_PHONE VARCHAR(50),       
  COMPANY_FAX  VARCHAR(50),      
  EXCHANGECODE VARCHAR(3),       
  TM_CODE   VARCHAR(20),      
  BROKERSEBIREGNO VARCHAR(20),      
  COMPANY_PANNO VARCHAR(50),       
  COMPANY_EMAIL VARCHAR(100),      
  COMPLIANCE_NAME VARCHAR(100),      
  COMPLIANCE_EMAIL VARCHAR(100),      
  COMPLIANCE_PHONE VARCHAR(50),      
  COMPLIANCE_MOBILE VARCHAR(50),      
  SERVICES_TAXNO  VARCHAR(50),      
  WEBSITE_ID   VARCHAR(100),      
  LOGO_FILE_PATH  VARCHAR(100),      
  COMPANY_CIN   VARCHAR(30)     
    
  )      
       
 INSERT INTO #COMPANY_INFO        
 SELECT       
  COMPANY,       
  ADDR1,       
  ADDR2,       
  CITY,       
  ZIP,       
  PHONE,       
  FAX,       
  EXCHANGECODE,       
  TM_CODE='',       
  BROKERSEBIREGNO,       
  PANNO,       
  EMAIL,       
  COMPLIANCE_NAME = ISNULL(COMPLIANCE_NAME,''),      
  COMPLIANCE_EMAIL = ISNULL(COMPLIANCE_EMAIL,''),      
  COMPLIANCE_PHONE = ISNULL(COMPLIANCE_PHONE,''),      
  COMPLIANCE_MOBILE = ISNULL(COMPLIANCE_MOBILE,''),      
  SERVICES_TAXNO = ISNULL(SERVICES_TAXNO,''),      
  WEBSITE_ID = ISNULL(WEBSITE_ID,''),      
  LOGO_FILE_PATH = '',      
  CIN = ISNULL(CIN,'')      
      
          
 FROM       
  OWNER (NOLOCK)      
       
 SELECT * FROM #COMPANY_INFO      
       
 DROP TABLE #COMPANY_INFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_DAILYLEDGER
-- --------------------------------------------------




CREATE PROC [dbo].[CLS_DAILYLEDGER]
	@VDT VARCHAR(11),
	@CLTCODE VARCHAR(10)
AS

SET @VDT = LEFT(CONVERT(DATETIME,@VDT,103),11)

DECLARE	@@SDTCUR VARCHAR(11)

SELECT 	@@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM ACCOUNTNCE.DBO.PARAMETER WHERE @VDT BETWEEN SDTCUR AND LDTCUR

SELECT 
	VDESC, 
	L.CLTCODE, 
	TRAN_DRAMT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END, 
	TRAN_CRAMT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 
	L.NARRATION,
	OPP_DRAMT = CASE WHEN L1.DRAMT > 0 THEN L1.DRAMT ELSE 0 END, 
	OPP_CRAMT = CASE WHEN L1.CRAMT > 0 THEN L1.CRAMT ELSE 0 END,
	CLS_DRAMT = CASE WHEN L2.DRAMT > 0 THEN L2.DRAMT ELSE 0 END, 
	CLS_CRAMT = CASE WHEN L2.CRAMT > 0 THEN L2.CRAMT ELSE 0 END
FROM (
	SELECT 
		CLTCODE, DRCR, VAMT, NARRATION, VTYP 
	FROM 
		 ACCOUNTNCE.DBO.LEDGER (NOLOCK)
	WHERE 
		CLTCODE = @CLTCODE 
	AND EDT BETWEEN @VDT AND @VDT + ' 23:59'
	) L
	LEFT OUTER JOIN
	(
	SELECT 
		CLTCODE, 
		DRAMT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END),
		CRAMT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END),
		NARRATION = 'OPENING BALANCE'
	FROM 
		ACCOUNTNCE.DBO.LEDGER (NOLOCK)
	WHERE 
		CLTCODE = @CLTCODE AND EDT >= @@SDTCUR AND EDT < @VDT
	GROUP BY CLTCODE
	) L1 ON L.CLTCODE = L1.CLTCODE
	LEFT OUTER JOIN 
	(
	SELECT 
		CLTCODE, 
		DRAMT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END),
		CRAMT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END),
		NARRATION = 'CLOSING BALANCE'
	FROM 
		ACCOUNTNCE.DBO.LEDGER (NOLOCK)
	WHERE 
		CLTCODE = @CLTCODE AND EDT >= @@SDTCUR AND EDT <= @VDT + ' 23:59'
	GROUP BY CLTCODE
	) L2
	ON L.CLTCODE = L2.CLTCODE,
	ACCOUNTNCE.DBO.VMAST V (NOLOCK)
WHERE 
	V.VTYPE = L.VTYP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_DAS_HEADER
-- --------------------------------------------------



CREATE PROC [dbo].[CLS_DAS_HEADER] (@FROMDATE VARCHAR(11))

AS

/*  
 DECLARE @FROMDATE VARCHAR(11)  
 SET  @FROMDATE = '12/09/2014'  
 EXEC CLS_DAS_HEADER '05/01/2015'   
 */

SELECT @FROMDATE = CONVERT(VARCHAR, CONVERT(DATETIME, @FROMDATE, 103), 109)

CREATE TABLE #COMPANY_INFO (
	COMPANY VARCHAR(100),
	COMPANY_ADDR1 VARCHAR(100),
	COMPANY_ADDR2 VARCHAR(100),
	COMPANY_CITY VARCHAR(50),
	COMPANY_ZIP VARCHAR(10),
	COMPANY_PHONE VARCHAR(50),
	COMPANY_FAX VARCHAR(50),
	EXCHANGECODE VARCHAR(3),
	TM_CODE VARCHAR(20),
	BROKERSEBIREGNO VARCHAR(20),
	COMPANY_PANNO VARCHAR(50),
	COMPANY_EMAIL VARCHAR(100),
	COMPLIANCE_NAME VARCHAR(100),
	COMPLIANCE_EMAIL VARCHAR(100),
	COMPLIANCE_PHONE VARCHAR(50),
	COMPLIANCE_MOBILE VARCHAR(50),
	SERVICES_TAXNO VARCHAR(50),
	WEBSITE_ID VARCHAR(100),
	LOGO_FILE_PATH VARCHAR(100),
	COMPANY_CIN VARCHAR(30),
	/*COMMONSEBINO  VARCHAR(200),  
	COMMONMEMBERCODE VARCHAR(200),  
	IGRIV_EMAIL   VARCHAR(200),   
	CORP_ADDR1   VARCHAR(100),  
	CORP_ADDR2   VARCHAR(100),  
	CORP_ADDR3   VARCHAR(100),  
	CORP_PHONE   VARCHAR(50),  
	CORP_ZIP   VARCHAR(10),  
	CORP_CITY   VARCHAR(50),  
	CORP_STATE   VARCHAR(50),  
	CORP_COUNTRY  VARCHAR(50),  
	AUTHORISEDSIGNETORY1 VARCHAR(150),  
	AUTHORISEDSIGNETORY2 VARCHAR(150),  
	AUTHORISEDSIGNETORY3 VARCHAR(150),  
	AUTHORISEDSIGNETORY4 VARCHAR(150),  
	AUTHORISEDSIGNETORY5 VARCHAR(150),  
	AUTHORISEDSIGNETORY6 VARCHAR(150),  
	AUTHORISEDSIGNETORY7 VARCHAR(150),  
	CONTRACT_TYPE  INT,   
	FNO_CONTRACT_BILL INT,  
	PRINT_SUB_TOT  INT,  
	PRINT_NET_TOT  INT,  
	PRINT_DEALING  VARCHAR(10),  
	PRINT_STT_COLUMN INT,  
	SERTAXPER   NUMERIC(18,2),  
	CONTRACTDATE  VARCHAR(11),*/
	CESS_TAX NUMERIC(18, 4),
	EDUCESSTAX NUMERIC(18, 4),
	SERTAXPER NUMERIC(18, 4),
	SBC_TAX NUMERIC(18, 4),
	KKC_TAX NUMERIC(18, 4)
	)

INSERT INTO #COMPANY_INFO
SELECT COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	FAX,
	EXCHANGECODE,
	TM_CODE = '',
	BROKERSEBIREGNO,
	PANNO,
	EMAIL,
	COMPLIANCE_NAME = ISNULL(COMPLIANCE_NAME, ''),
	COMPLIANCE_EMAIL = ISNULL(COMPLIANCE_EMAIL, ''),
	COMPLIANCE_PHONE = ISNULL(COMPLIANCE_PHONE, ''),
	COMPLIANCE_MOBILE = ISNULL(COMPLIANCE_MOBILE, ''),
	SERVICES_TAXNO = ISNULL(SERVICES_TAXNO, ''),
	WEBSITE_ID = ISNULL(WEBSITE_ID, ''),
	LOGO_FILE_PATH = '',
	CIN = ISNULL(CIN, ''),
	/*COMMONSEBINO = ISNULL(COMMONSEBINO,''),  
	COMMONMEMBERCODE = ISNULL(COMMONMEMBERCODE,''),
	IGRIV_EMAIL = ISNULL(IGRIV_EMAIL,''),   
	CORP_ADDR1 = ISNULL(CORP_ADDR1,''),  
	CORP_ADDR2 = ISNULL(CORP_ADDR2,''),  
	CORP_ADDR3 = ISNULL(CORP_ADDR3,''),  
	CORP_PHONE = ISNULL(CORP_PHONE,''),  
	CORP_ZIP = ISNULL(CORP_ZIP,''),  
	CORP_CITY = ISNULL(CORP_CITY,''),  
	CORP_STATE = ISNULL(CORP_STATE,''),  
	CORP_COUNTRY = ISNULL(CORP_COUNTRY,''),  
	AUTHORISEDSIGNETORY1 = '',  
	AUTHORISEDSIGNETORY2 = '',  
	AUTHORISEDSIGNETORY3 = '',  
	AUTHORISEDSIGNETORY4 = '',  
	AUTHORISEDSIGNETORY5 = '',  
	AUTHORISEDSIGNETORY6 = '',  
	AUTHORISEDSIGNETORY7 = '',  
	CONTRACT_TYPE  = '',  
	FNO_CONTRACT_BILL = '',  
	PRINT_SUB_TOT  = '',  
	PRINT_NET_TOT  = '',  
	PRINT_DEALING  = '',  
	PRINT_STT_COLUMN = 0,  
	SERTAXPER   = 0,  
	CONTRACTDATE  = '',  
	CESS_TAX   = 0,  
	EDUCESSTAX   = 0 */
	CESS_TAX = 0,
	EDUCESSTAX = 0,
	SERTAXPER = 0,
	SBC_TAX = 0,
	KKC_TAX = 0
FROM FOOWNER (NOLOCK)

/*
UPDATE	#COMPANY_INFO  
SET		AUTHORISEDSIGNETORY1 = ISNULL(A.AUTHORISEDSIGNETORY1,''),  
		AUTHORISEDSIGNETORY2 = ISNULL(A.AUTHORISEDSIGNETORY2,''),  
		AUTHORISEDSIGNETORY3 = ISNULL(A.AUTHORISEDSIGNETORY3,''),  
		AUTHORISEDSIGNETORY4 = ISNULL(A.AUTHORISEDSIGNETORY4,''),  
		AUTHORISEDSIGNETORY5 = ISNULL(A.AUTHORISEDSIGNETORY5,''),  
		AUTHORISEDSIGNETORY6 = ISNULL(A.AUTHORISEDSIGNETORY6,''),  
		AUTHORISEDSIGNETORY7 = ISNULL(A.AUTHORISEDSIGNETORY7,'')  
FROM	AUTHORISEDSIGNETORIES A (NOLOCK)  
   
   
UPDATE	#COMPANY_INFO  
SET		CONTRACT_TYPE  = ISNULL(T.CONTRACT_TYPE,0),  
		FNO_CONTRACT_BILL = ISNULL(T.FNO_CONTRACT_BILL,0),  
		PRINT_SUB_TOT  = ISNULL(T.PRINT_SUB_TOT,0),  
		PRINT_NET_TOT  = ISNULL(T.PRINT_NET_TOT,0),  
		PRINT_DEALING  = ISNULL(T.PRINT_DEALING,''),  
		PRINT_STT_COLUMN = ISNULL(T.PRINT_STT_COLUMN,'')  
FROM	TBL_COMMONCONTRACT_MASTER T (NOLOCK)   
WHERE	GETDATE() BETWEEN EFFECTIVE_FROM AND EFFECTIVE_TO   
  
  
UPDATE	#COMPANY_INFO  
SET		SERTAXPER  = SERVICE_TAX,  
		CONTRACTDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE,103),112),  
		CESS_TAX  = ISNULL(G.CESS_TAX,0),  
		EDUCESSTAX  = ISNULL(G.EDUCESSTAX,0)  
FROM	GLOBALS G (NOLOCK)  
WHERE	@FROMDATE BETWEEN YEAR_START_DT AND YEAR_END_DT*/


UPDATE	#COMPANY_INFO
SET		SERTAXPER = ISNULL(G.SERVICE_TAX, 0),
		CESS_TAX = ISNULL(G.CESS_TAX, 0),
		EDUCESSTAX = ISNULL(G.EDUCESS_TAX, 0),
		SBC_TAX = ISNULL(G.SBCCHARGE, 0),
		KKC_TAX = ISNULL(G.KRISHICHARGE, 0)
FROM	FOGLOBALS G(NOLOCK)
WHERE	@FROMDATE BETWEEN YEAR_START_DT AND YEAR_END_DT

SELECT * FROM #COMPANY_INFO

DROP TABLE #COMPANY_INFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FileListProc
-- --------------------------------------------------








/*

	CLS_FILELISTPROC 'DIR D:\BackOffice\*.* /C'
	SELECT INSTR("W3Schools.com", "3") AS MatchPosition;
*/
CREATE PROC [dbo].[CLS_FileListProc] (@FILEPATH VARCHAR(100) )      
AS       
    

CREATE TABLE #FILELIST       
( FILENAMELIST VARCHAR(500))      
INSERT INTO #FILELIST       
EXEC MASTER.DBO.XP_CMDSHELL  @FILEPATH -- 'DIR D:\BACKOFFICE\TEST\*.* /C'

ALTER TABLE #FILELIST
ADD FILETYPE VARCHAR(1)

UPDATE #FILELIST SET FILETYPE = 'F'

UPDATE #FILELIST SET FILETYPE = 'D'
WHERE FILENAMELIST LIKE '%<DIR>%' 

UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')
WHERE FILENAMELIST IS NOT NULL
AND FILENAMELIST LIKE '%'
AND (FILENAMELIST LIKE '%/%'  OR FILENAMELIST LIKE '%-%' )


SELECT FILENAMELIST=LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1)))), DIR = FILETYPE
INTO #FILELISTNEW   
FROM #FILELIST 
WHERE FILENAMELIST IS NOT NULL
AND FILENAMELIST LIKE '%'
AND (FILENAMELIST LIKE '%/%' OR FILENAMELIST LIKE '%-%')
ORDER BY FILETYPE

ALTER TABLE #FILELISTNEW
ADD ID INT IDENTITY(1,1)
SELECT ID, FILENAMELIST = .dbo.CLS_ProperCase(FILENAMELIST), DIR FROM #FILELISTNEW N 
WHERE FILENAMELIST <> '.'
AND FILENAMELIST <> '..'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_BILLDETAIL_RPT
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_FO_BILLDETAIL_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@REPORTTYPE VARCHAR(10) = 'SUMMARY'
)

AS

/*
	@REPORTTYPE  : SUMMARY /DETAIL
*/


SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @REPORTTYPE = 'SUMMARY'
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,
		

		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			(F.PBILLAMT - F.SBILLAMT)
		ELSE
			(F.PBILLAMT+F.SBILLAMT)
		END))
		 AS NET_DRCR, 
		CONVERT(NUMERIC(18,2), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - ((F.SBILLAMT)  )
		ELSE
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + ((F.SBILLAMT)  )
		END))
		 AS NETBILLAMT
		 ,FILENAME = 'FOBILL_' + LTRIM(RTRIM(F.PARTY_CODE))+'_'+ CONVERT(VARCHAR,F.SAUDA_DATE,112)
		 
	FROM
		FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE
		
END
ELSE			-- DETAIL REPORT
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,		
		F.INST_TYPE, 
		SYMBOL = F.SYMBOL + ' - ' + TRADETYPE,
		CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,
		F.STRIKE_PRICE, 
		CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,		
		CONVERT(NUMERIC(18,2),CL_RATE) AS CLOSINGRATE,	

		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
				   THEN CASE WHEN SUM(PQTY) > 0 
						 THEN SUM(PAMT)/SUM(PQTY) 
						 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(PQTY) > 0 
				   THEN SUM(PRATE*PQTY)/SUM(PQTY) 
				   ELSE 0 
			  END 
		END) AS PRATE,
		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
					   THEN CASE WHEN SUM(SQTY) > 0 
					 THEN SUM(SAMT)/SUM(SQTY) 
					 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(SQTY) > 0 
				   THEN SUM(SRATE*SQTY)/SUM(SQTY)
				   ELSE 0
			  END 
		END) AS SRATE,

		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,
		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END 
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		AS DEBIT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END 
		ELSE
			0
		END)
		AS CREDIT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT)) - SUM((F.SBILLAMT))
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		 AS NET_DRCR,
		
		CONVERT(NUMERIC(18,4), SUM(F.SERVICE_TAX - F.EXSER_TAX))AS 'SERVICE_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.SEBI_TAX)) AS 'SEBI_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.TURN_TAX)) AS 'TURNOVER_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.BROKER_NOTE)) AS 'STAMP_DUTY',
		CONVERT(NUMERIC(18,4), SUM(F.INS_CHRG)) AS 'STT_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.OTHER_CHRG)) AS  'OTHER_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.PBROKAMT+F.SBROKAMT)) AS 'BROKERAGE',
		CONVERT(NUMERIC(18,4), SUM(F.TOT_SERVICETAX))AS 'SERVICE_TAX_INCL',
		CONVERT(NUMERIC(18,4), SUM(F.SBC_CHRG)) AS 'SBC_CHRG',
		CONVERT(NUMERIC(18,4), SUM(F.KRISHI_CHRG)) AS 'KKC_CHRG',
		
		CONVERT(NUMERIC(18,4), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,4), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )
		ELSE
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + SUM((F.SBILLAMT)  )
		END)
		 AS NETBILLAMT,

		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL ,
		 TRADEDATE = CONVERT(VARCHAR,F.SAUDA_DATE,112)
		 ,FILENAME = 'FOBILL_' + LTRIM(RTRIM(F.PARTY_CODE))+'_'+ CONVERT(VARCHAR,F.SAUDA_DATE,112)
		 
	FROM
		FOBILLVALAN_CHRG F (NOLOCK), 
		--FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME,  
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE,
		F.TRADETYPE, 
		CL_RATE,
		AUCTIONPART,
		PARTICIPANTCODE,
		MEMBERCODE,		
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL 		

	HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME, 
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE, 
		F.TRADETYPE
END

/*---------------------------------------------------------- END OF THE PROC -------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_COLLATERAL_DETAILS_DAS_GET
-- --------------------------------------------------



CREATE PROC [dbo].[CLS_FO_COLLATERAL_DETAILS_DAS_GET]
	(
 	@SDATE VARCHAR(11),
	@PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = ''
	)

	AS
	
	IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)  
	
	IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	IF @DISPLAY <> ''
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NCE',
				SEGMENT = 'FUTURES',
				QTY=SUM(QTY),
				FINALAMOUNT=SUM(FINALAMOUNT)
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NCE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
				AND  1 = 2
			GROUP BY 
				PARENTCODE
			ORDER BY
				PARENTCODE
		END
	ELSE
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NCE',
				SEGMENT = 'FUTURES',
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END),
				EXPIRYDATE = (
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),	
				QTY=SUM(QTY),
				CL_RATE,
				VAKUATIONPER = MAX(100 - HAIRCUT),
				FINALAMOUNT=SUM(FINALAMOUNT),
				CASH_NCASH,
				SERIES = ISNULL(SERIES,'')
			INTO
				#COLLDETAILS
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NCE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
				AND  1 = 2
			GROUP BY 
				PARENTCODE,SCRIP_CD,CL_RATE,CASH_NCASH,ISNULL(SERIES,''),
				(
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),
				(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END)				
			ORDER BY
				CASH_NCASH,
				PARTY_CODE,
				SCRIP_CD


			UPDATE 
				#COLLDETAILS
				SET SCRIP_CD = S2.SCRIP_CD
			FROM 
				BSEDB.DBO.SCRIP2 S2 (NOLOCK),
				BSEDB.DBO.SCRIP2 S1 (NOLOCK)
			WHERE 
				S1.CO_CODE = S2.CO_CODE
				AND S1.SERIES = S2.SERIES
				AND #COLLDETAILS.SCRIP_CD = S2.BSECODE
				AND #COLLDETAILS.SERIES = 'BSE'
				

			SELECT *
			FROM #COLLDETAILS C
			ORDER BY PARTY_CODE,CASH_NCASH, SCRIP_CD
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------




CREATE  PROCEDURE [dbo].[CLS_FO_LEDGER_DETAILS_DAS_UP]
(
@SDATE VARCHAR(11),
@PARTYCODE VARCHAR(20),
@TOCODE VARCHAR(20) = '',
@DISPLAY VARCHAR(1) = ''
)       

AS

--EXEC CLS_FO_LEDGER_DETAILS_DAS_UP '31/12/2015','n01881','n01881'

DECLARE @EXTRADET INT
SET @EXTRADET = 0

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0
BEGIN
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)
END	

IF @TOCODE = ''
BEGIN
	SET @TOCODE = @PARTYCODE
END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			MARGINAMT = SUM((LEDDD_CASH_MARGIN + LEDDD_NONCASH_COLL_HC) - (LEDDD_INIT_EXPO_MARGIN))
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END
ELSE
	BEGIN
	
		DECLARE @COMPANYNAME	VARCHAR(100)
		
		SELECT @COMPANYNAME =COMPANY FROM FOOWNER(NOLOCK)

		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_SAUDA_DATE = @SDATE,
			LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),
			LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),
			LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),
			LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),
			LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),
			LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),
			LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),
			LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),
			LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),
			LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),
			LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),
			LEDDD_CREATED_BY = 'BACK-END',
			LEDDD_CREATED_DT = GETDATE(),
			LEDDD_ADD_MARGIN = 0, --SUM(LEDDD_ADD_MARGIN),
			LEDDD_FT_D = SUM(LEDDD_FT_D),
			LEDDD_FT_C = SUM(LEDDD_FT_C),
			LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),
			LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
			LEDDD_CASH_COLL_HC = 0 --SUM(LEDDD_CASH_COLL_HC)
		INTO
			#LEDGER_DETAILS_DAS
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE



		CREATE TABLE #FOTRADEDATA
			(
			FOTDD_PARTY_CODE	VARCHAR(20),             
			FOTDD_INST_TYPE		VARCHAR(10),             
			FOTDD_SYMBOL		VARCHAR(50),             
			FOTDD_STRIKE_PRICE	NUMERIC(18,4),
			FOTDD_OPTION_TYPE	VARCHAR(5),             
			FOTDD_EXPIRY_DATE	DATETIME,
			FOTDD_SEC_NAME		VARCHAR(100),
			FOTDD_TRADEQTY		INT,             
			FOTDD_VALUE			NUMERIC(18,4),
			FOTDD_PRICE			NUMERIC(18,4),
			FOTDD_PQTY			INT,             
			FOTDD_SQTY			INT,             
			FOTDD_PAMT			NUMERIC(18,4),
			FOTDD_SAMT			NUMERIC(18,4),
			FOTDD_NETRATE		NUMERIC(18,4),
			FOTDD_CFPPRICE		NUMERIC(18,4),
			FOTDD_CFSPRICE		NUMERIC(18,4),
			FOTDD_SETTPRICE		NUMERIC(18,4),
			FOTDD_SAUDA_DATE	DATETIME,
			FOTDD_PNETRATE		NUMERIC(18,4),
			FOTDD_SNETRATE		NUMERIC(18,4),
			FOTDD_CHARGES		NUMERIC(18,4),
			FOTDD_BROKERAGE		NUMERIC(18,4),
			FOTDD_SERVICE_TAX	NUMERIC(18,4),
			FOTDD_BROKER_NOTE	NUMERIC(18,4),
			FOTDD_TURN_TAX		NUMERIC(18,4),
			FOTDD_SEBI_TAX		NUMERIC(18,4),
			FOTDD_CONTRACTNO	VARCHAR(10),
			FOTDD_PCOMM			NUMERIC(18,4),
			FOTDD_SCOMM			NUMERIC(18,4),
			FOTDD_INS_CHRG		NUMERIC(18,4),
			FOTDD_FLAG			VARCHAR(2),
			TRADE_TYPE			VARCHAR(2),
			FOTDD_O_C_FLAG		VARCHAR(5),
			FOTDD_AUCTIONPART	VARCHAR(2),
			FOTDD_CREATED_BY	VARCHAR(15),
			FOTDD_CREATED_DT	DATETIME,
			FOTDD_OTHER_CHRG	NUMERIC(18,4),
			GSTFLAG				VARCHAR(15)
			)

		INSERT INTO #FOTRADEDATA
		EXEC CLS_FO_TRADE_DETAILS_DAS_GET @SDATE, @PARTYCODE, @TOCODE
		
		
		CREATE TABLE #LEDGER_SUMMARY
			(
			SRNO				INT IDENTITY(1,1),
			LEDDD_PARTY_CODE	VARCHAR(20),
			LEDDD_SAUDA_DATE	DATETIME,
			COLUMN_HEAD			VARCHAR(MAX),
			COLUMN_VALUE1		VARCHAR(50),
			COLUMN_VALUE2		VARCHAR(10),
			COLUMN_STYLE		VARCHAR(100)
			)


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	TOP 1 LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'DAILY ACTIVITY LEDGER',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'TITAL'
		FROM	#LEDGER_DETAILS_DAS


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	TOP 1 LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cash Summary',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'TITAL'
		FROM	#LEDGER_DETAILS_DAS

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Opening Balance - Settlement Ledger A/c',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_OPENING_BAL),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cheque Receipts during the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CHQ_REC),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(LEDDD_CHQ_REC) <> 0

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cheque Payments during the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CHQ_PAY),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(LEDDD_CHQ_PAY) <> 0

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Journal entries for the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_JV_ENTRY),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(LEDDD_JV_ENTRY) <> 0

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'MTM of Futures',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)),2))),
				COLUMN_VALUE2 = '(a)',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS L,
				#FOTRADEDATA F
		WHERE	FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
				AND LEDDD_PARTY_CODE = FOTDD_PARTY_CODE
				AND LEFT(FOTDD_FLAG,2) = '04'
		GROUP BY LEDDD_PARTY_CODE
		HAVING (SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Premium - Options',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)),2))),
				COLUMN_VALUE2 = '(b)',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS L,
				#FOTRADEDATA F
		WHERE	FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
				AND LEDDD_PARTY_CODE = FOTDD_PARTY_CODE
				AND LEFT(FOTDD_FLAG,2) = '02'
		GROUP BY LEDDD_PARTY_CODE
		HAVING (SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Brokerage + Other Charges',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(FOTDD_BROKERAGE+FOTDD_SERVICE_TAX+FOTDD_BROKER_NOTE+FOTDD_TURN_TAX+FOTDD_SEBI_TAX+FOTDD_INS_CHRG+FOTDD_OTHER_CHRG),2))),
				COLUMN_VALUE2 = '(c)',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS L,
				#FOTRADEDATA F
		WHERE	FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
				AND LEDDD_PARTY_CODE = FOTDD_PARTY_CODE
				AND LEFT(FOTDD_FLAG,2) IN ('01','02','03')
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(FOTDD_BROKERAGE+FOTDD_SERVICE_TAX+FOTDD_BROKER_NOTE+FOTDD_TURN_TAX+FOTDD_SEBI_TAX+FOTDD_INS_CHRG+FOTDD_OTHER_CHRG) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Exercise / Assignment Settlement Amount',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND((SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)),2))),
				COLUMN_VALUE2 = '(d)',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS L,
				#FOTRADEDATA F
		WHERE	FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
				AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
				AND LEDDD_PARTY_CODE = FOTDD_PARTY_CODE
				AND LEFT(FOTDD_FLAG,2) = '03'
		GROUP BY LEDDD_PARTY_CODE
		HAVING (SUM(FOTDD_SAMT)-SUM(FOTDD_PAMT)) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Fund Transfered To/From Common Pool A/C',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_FT_D),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(LEDDD_FT_D) <> 0
			

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Fund Transfered To/From Common Pool A/C',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_FT_C),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING SUM(LEDDD_FT_C) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Closing Balance - Settlement Ledger A/c  (A)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CLOSING_BAL),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cash Margin',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CLOSING_BAL),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY LEDDD_PARTY_CODE
		HAVING	SUM(LEDDD_CLOSING_BAL) < 0

		/*
		INSERT	INTO #LEDGER_SUMMARY
		SELECT	TOP 1 LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = '',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'TITAL'
		FROM	#LEDGER_DETAILS_DAS
		*/


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	TOP 1 LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Margin Summary',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'TITAL'
		FROM	#LEDGER_DETAILS_DAS


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Opening Balance - Client Cash Initial Margin A/c',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_OPENING_INIT_MARGIN),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
				

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Margin Receipts during the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_MRG_REC),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
		HAVING	SUM(LEDDD_MRG_REC) <> 0		
				
		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Margin Repayment for the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_MRG_REPAY),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
		HAVING	SUM(LEDDD_MRG_REPAY) <> 0		
				

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Journal entries for the day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_MRG_JV_ENTRY),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
		HAVING	SUM(LEDDD_MRG_JV_ENTRY) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Fund Transfered To/From Common Pool A/C',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_MRG_FT),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
		HAVING	SUM(LEDDD_MRG_FT) <> 0


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Closing Balance - Client Cash Initial Margin A/c  (B)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CLOSING_INIT_MARGIN),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE

		/*
		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cash Collateral Value (after hair-cut)  (F)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CASH_COLL_HC),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
		*/		

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Non-Cash Collateral Value (after hair-cut)  (C)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_NONCASH_COLL_HC),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Total Available Margin (B+C)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Initial and Exposure Margin for Today (D)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_INIT_EXPO_MARGIN),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Additional Margin (E)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_ADD_MARGIN),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Excess / (-) Deficit Margin (B+C-D-E)',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN)-SUM(LEDDD_ADD_MARGIN),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Available margin exposure for next day',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(
				CASE
					WHEN SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN) > 0 
					THEN SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN)
					ELSE 0
				END,2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE


		/*
		INSERT	INTO #LEDGER_SUMMARY
		SELECT	TOP 1 LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = '',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'TITAL'
		FROM	#LEDGER_DETAILS_DAS
		*/


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Cash Margin Due',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(
				CASE
					WHEN SUM(LEDDD_CLOSING_BAL) < 0 THEN SUM(LEDDD_CLOSING_BAL)
					ELSE 0
				END,2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
				

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Initial Margin Due',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(
				CASE
					WHEN SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN) > 0 
					THEN 0
					ELSE SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN)
				END,2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
            

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Total Margin Due',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(
				CASE
					WHEN SUM(LEDDD_CLOSING_BAL) > (SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN))
					THEN SUM(LEDDD_CLOSING_INIT_MARGIN+LEDDD_NONCASH_COLL_HC)-SUM(LEDDD_INIT_EXPO_MARGIN)
					ELSE SUM(LEDDD_CLOSING_BAL)
				END,2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE
            

		INSERT	INTO #LEDGER_SUMMARY
		SELECT	LEDDD_PARTY_CODE,
				@SDATE,
				COLUMN_HEAD = 'Free Balance Available',
				COLUMN_VALUE1 = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(LEDDD_RUNNINGBAL),2))),
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = ''
		FROM	#LEDGER_DETAILS_DAS
		GROUP BY 
				LEDDD_PARTY_CODE


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = '',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'


		/*INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = '',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'*/


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = 'Please arrange to make the payment as referred above, for Cash Margin Due and Initial Margin immediately in favour of '+ @COMPANYNAME,
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = 'All discrepancies, differences or objections should be immediately reported to us. If no report is made to us within 24 hours, this statement shall be deemed correct.',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = '',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'


		INSERT	INTO #LEDGER_SUMMARY
		SELECT	@PARTYCODE,
				@SDATE,
				COLUMN_HEAD = 'THIS IS A SYSTEM GENERATED STATEMENT AND DOES NOT REQUIRE A SIGNATURE',
				COLUMN_VALUE1 = '',
				COLUMN_VALUE2 = '',
				COLUMN_STYLE = 'FOOTER'


		SELECT * FROM #LEDGER_SUMMARY
		ORDER BY LEDDD_PARTY_CODE, SRNO
		

		DROP TABLE #LEDGER_SUMMARY
		DROP TABLE #LEDGER_DETAILS_DAS			
		DROP TABLE #FOTRADEDATA


		/*	
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_SAUDA_DATE = @SDATE,
			LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),
			LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),
			LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),
			LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),
			LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),
			LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),
			LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),
			LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),
			LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),
			LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),
			LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),
			LEDDD_CREATED_BY = 'BACK-END',
			LEDDD_CREATED_DT = GETDATE(),
			LEDDD_ADD_MARGIN = 0, --SUM(LEDDD_ADD_MARGIN),
			LEDDD_FT_D = SUM(LEDDD_FT_D),
			LEDDD_FT_C = SUM(LEDDD_FT_C),
			LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),
			LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
			LEDDD_CASH_COLL_HC = 0, --SUM(LEDDD_CASH_COLL_HC),
			LEDDD_DFLAG = '1',
			LEDDD_NARRATION = CONVERT(VARCHAR(100),''),
			LEDDD_VDESC = CONVERT(VARCHAR(100),''),
			LEDDD_VNO = CONVERT(VARCHAR(30),''),
			LEDDD_DDNO = CONVERT(VARCHAR(20),''),
			LEDDD_VAMT = CONVERT(NUMERIC(18,4),0),
			LEDDD_ANOV = CONVERT(NUMERIC(18,4),0),
			LEDDD_SPANREQ = CONVERT(NUMERIC(18,4),0),
			LEDDD_PMARGINRATE = CONVERT(NUMERIC(18,4),0),
			LEDDD_INITIALMARGIN = CONVERT(NUMERIC(18,4),0),
			LEDDD_MTOM_MARGIN = CONVERT(NUMERIC(18,4),0),
			LEDDD_FD_AMT = CONVERT(NUMERIC(18,4),0),
			
			LEDDD_TOTACCOUNTVALUE = CONVERT(NUMERIC(18,4),0),
			LEDDD_TOTNETLIQVALUE = CONVERT(NUMERIC(18,4),0),
			LEDDD_TOTMARGINREQAMT = CONVERT(NUMERIC(18,4),0),
			LEDDD_TOTMINCASHCOLLREQ = CONVERT(NUMERIC(18,4),0),
			LEDDD_MARGINEXCESS = CONVERT(NUMERIC(18,4),0),
			LEDDD_CASHMARGINCALL = CONVERT(NUMERIC(18,4),0),
			LEDDD_AVL_CASH_WITHDRAWL = CONVERT(NUMERIC(18,4),0),
			LEDDD_PURCHASINGPOWER = CONVERT(NUMERIC(18,4),0)
		INTO
			#LEDGER_DETAILS_DAS
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
			
		/*
		IF (@EXTRADET = 1)
		BEGIN
			/*
			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_ANOV = ISNULL(ANOV,0),
					LEDDD_SPANREQ = ISNULL(SPANREQ,0)
			FROM	(		
					SELECT 
						PARTY_CODE,
						SPANREQ=SUM(SPANREQ), 
						ANOV=SUM(ANOV) 
					FROM
						(	
						SELECT 
							PARTY_CODE = ACCT,
							SPANREQ=ISNULL(SUM(SPANREQ),0),
							ANOV = ISNULL(SUM(ANOV),0)
						FROM 
							SPANMARGIN_INTRADAY (NOLOCK)
						WHERE 
							ACCT BETWEEN @PARTYCODE AND @TOCODE AND CONVERT(DATETIME,INTRADATE) BETWEEN @SDATE AND @SDATE + ' 23:59:59'
						GROUP BY
							ACCT	
					 	
						UNION ALL 
					 	
						SELECT
							PARTY_CODE = ACCT,
							SPANREQ = ISNULL(SUM( ROUND(((CASE WHEN (SPANREQ-ISNULL(SAMT,0)) < 0 THEN 0 ELSE (SPANREQ-ISNULL(SAMT,0)) END)*HAIRCUT/100),0)),0), 
							ANOV =0
						FROM 
							SPANMARGIN_INTRADAY I (NOLOCK)
							LEFT OUTER JOIN 
							(
							SELECT 
								SQTY = SUM(SQTY), 
								SYMBOL, 
								PARTY_CODE, 
								SAMT=SUM(SQTY*NETRATE)
							FROM 
								NSEFO.DBO.FODAILY (NOLOCK)
							WHERE 
								SAUDA_DATE =  @SDATE +' 23:59:00'
								AND LEFT(INST_TYPE,3) = 'OPT' 
								AND LEFT(FLAG,2) = 'CF' 
								AND EXPIRYDATE >  @SDATE +' 23:59:00' 
								AND PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
								AND PARTY_CODE IN (SELECT PARTY_CODE FROM REFCODB.DBO.RSS_TAB_CLIENTMASTER (NOLOCK) WHERE DUMMY2='Y' )
								AND SYMBOL IN (SELECT SYMBOL FROM REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS A (NOLOCK) WHERE STATUS='ACTIVE'
								AND LEFT(EFFDATE,11) = (SELECT LEFT(MAX(EFFDATE),11) FROM REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS B WHERE A.SYMBOL = B.SYMBOL AND B.EFFDATE <= @SDATE + ' 23:59:00') )
							GROUP BY 
								SYMBOL, PARTY_CODE
							HAVING 
								SUM(PQTY) = 0 
													
							/*SELECT 
								SQTY = SUM(FOTDD_SQTY), 
								SYMBOL = FOTDD_SYMBOL, 
								PARTY_CODE = FOTDD_PARTY_CODE, 
								SAMT=SUM(FOTDD_SQTY*FOTDD_NETRATE)
							FROM 
								FO_TRADE_DETAILS_DAS (NOLOCK)
							WHERE 
								FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
								AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
								AND LEFT(FOTDD_INST_TYPE,3) = 'OPT' 
								AND LEFT(FOTDD_FLAG,2) = 'CF'
								AND FOTDD_EXPIRY_DATE >  @SDATE +' 23:59:00'
								AND FOTDD_PARTY_CODE IN (SELECT PARTY_CODE FROM REFCODB.DBO.RSS_TAB_CLIENTMASTER (NOLOCK) WHERE DUMMY2='Y' )
								AND FOTDD_SYMBOL IN (SELECT SYMBOL FROM REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS A (NOLOCK) WHERE STATUS='ACTIVE'
								AND LEFT(FOTDD_SAUDA_DATE,11) = (SELECT LEFT(MAX(EFFDATE),11) FROM REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS B WHERE A.SYMBOL = B.SYMBOL AND B.EFFDATE <= @SDATE + ' 23:59:00') )
							GROUP BY 
								FOTDD_SYMBOL, FOTDD_PARTY_CODE
							HAVING 
								SUM(FOTDD_PQTY) = 0 */
							) 
							P ON (I.ACCT = P.PARTY_CODE AND I.CC = P.SYMBOL),
							(
							SELECT 
								SYMBOL,
								HAIRCUT 
							FROM 
								REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS A (NOLOCK)
							WHERE 
								STATUS='ACTIVE'
								AND EFFDATE = (SELECT MAX(EFFDATE) FROM REFCODB.DBO.RSS_TAB_HIGHERMRGSCRIPS B (NOLOCK) WHERE A.SYMBOL = B.SYMBOL AND B.EFFDATE <= @SDATE + ' 23:59:00')
							) S
						WHERE 
							ACCT BETWEEN @PARTYCODE AND @TOCODE AND CONVERT(DATETIME,INTRADATE) BETWEEN @SDATE AND @SDATE + ' 23:59:59'
							AND ACCT IN (SELECT PARTY_CODE FROM REFCODB.DBO.RSS_TAB_CLIENTMASTER (NOLOCK) WHERE DUMMY2='Y' )
							AND CC = S.SYMBOL
						GROUP BY
							ACCT	
						) ABC
					GROUP BY
						PARTY_CODE		
					) A
			WHERE	A.PARTY_CODE = LEDDD_PARTY_CODE



			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_PMARGINRATE = ISNULL(PMARGINRATE,0),
					LEDDD_INITIALMARGIN = ISNULL(INITIALMARGIN,0)
			FROM	CLIENT3 C3 (NOLOCK)
			WHERE	C3.PARTY_CODE = LEDDD_PARTY_CODE
					AND MARKETTYPE = 'FUTURES'
					

			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_ADD_MARGIN = ISNULL(DUMMY1,0)
			FROM	REFCODB.DBO.RSS_TAB_CLIENTMASTER 
			WHERE	PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE

			/*
			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_ADD_MARGIN = (
					CASE 
						WHEN ISNULL(LEDDD_ADD_MARGIN,0) = 0 THEN 
						CASE
							WHEN LEFT(LEDDD_PARTY_CODE,1) = 'P' THEN 10
							ELSE 15 
						END
						ELSE ISNULL(LEDDD_ADD_MARGIN,0)
					END)
			*/

			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_MTOM_MARGIN = ISNULL(MTOMMARGIN,0)
			FROM	(
					SELECT 
						PARTY_CODE,
						MTOMMARGIN = ISNULL(SUM(MTOM),0) 
					FROM 
						FOMARGINNEW 
					WHERE 
						PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE 
						AND MDATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
						AND PARTY_CODE IN (SELECT PARTY_CODE FROM NSEFO.DBO.CLIENT3 (NOLOCK) WHERE  MARKETTYPE = 'FUTURES' AND EXCHANGE = 'NSE' AND MARGINBROKER = 0)
					GROUP BY
						PARTY_CODE	
					) A
			WHERE	A.PARTY_CODE = LEDDD_PARTY_CODE
			
			

			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_FD_AMT = ISNULL(TOTALFD,0)
			FROM	(
					SELECT 
						PARTY_CODE,
						TOTALFD = ISNULL(SUM(TOTALFD),0) 
					FROM 
						(
						SELECT 
							PARTY_CODE,
							TOTALFD 
						FROM 
							MSAJAG.DBO.COLLATERAL 
						WHERE 
							TRANS_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
							AND PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE 
							AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' 
							AND (PARTY_CODE IN (
							SELECT PARTY_CODE FROM MSAJAG.DBO.INSTRUTYPEMST WHERE LEFT(EFFDATE,11) = (SELECT LEFT(MIN(EFFDATE),11) 
							FROM MSAJAG.DBO.INSTRUTYPEMST (NOLOCK)
							WHERE EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES' AND PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE 
							AND INSTRU_TYPE='FD' AND CASH_NCASH = 'C')) OR '' = (SELECT PARTY_CODE FROM MSAJAG.DBO.INSTRUTYPEMST WHERE EXCHANGE ='NSE'
							AND SEGMENT='FUTURES' AND INSTRU_TYPE ='FD' AND CASH_NCASH = 'C' AND PARTY_CODE = '' AND CLIENT_TYPE = '')
							)
						UNION ALL 
						SELECT 
							PARTY_CODE,
							TOTALFD=ISNULL(FINALAMOUNT,0) 
						FROM 
							MSAJAG.DBO.COLLATERALDETAILS 
						WHERE 
							EFFDATE BETWEEN @SDATE AND @SDATE + ' 23:59:59' AND PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE 
							AND EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES'
							AND ISIN IN (SELECT ISIN FROM MSAJAG..TBL_LIQUID_MASTER WHERE @SDATE BETWEEN FROMDATE AND TODATE ) 
						) A
					GROUP BY
						PARTY_CODE
					) AA
			WHERE	AA.PARTY_CODE = LEDDD_PARTY_CODE
			*/
			
			UPDATE	#LEDGER_DETAILS_DAS
			SET		LEDDD_TOTACCOUNTVALUE = ISNULL(TOTACCOUNTVALUE,0),
					LEDDD_TOTNETLIQVALUE = ISNULL(TOTNETLIQVALUE,0),
					LEDDD_TOTMARGINREQAMT = ISNULL(TOTMARGINREQAMT,0),
					LEDDD_TOTMINCASHCOLLREQ = ISNULL(TOTMINCASHCOLLREQ,0),
					LEDDD_MARGINEXCESS = ISNULL(MARGINEXCESS,0),
					LEDDD_CASHMARGINCALL = ISNULL(CASHMARGINCALL,0),
					LEDDD_AVL_CASH_WITHDRAWL = ISNULL(AVL_CASH_WITHDRAWL,0),
					LEDDD_PURCHASINGPOWER = ISNULL(PURCHASINGPOWER,0)
			FROM	CLS_FO_EXTRA_DETAILS_DAS C (NOLOCK)
			WHERE	C.PARTY_CODE = #LEDGER_DETAILS_DAS.LEDDD_PARTY_CODE
					AND DET_FLAG = 'LED_FINSTATE'

		END
		*/
		*/
		/*
		SELECT * FROM #LEDGER_DETAILS_DAS
		ORDER BY LEDDD_PARTY_CODE, LEDDD_DFLAG desc
		

		DROP TABLE #LEDGER_DETAILS_DAS
		*/
				
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[CLS_FO_OPEN_POSITION_DAS_GET]
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            
            
AS  


IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)            

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOPDD_PARTY_CODE,
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),
			FOPDD_INST_TYPE
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
		ORDER BY             
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
	END
ELSE
	BEGIN
		PRINT @BLOCK
		SELECT             
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			FOPDD_INTFLAG=ISNULL(FOPDD_INTFLAG,'IN'),            
			FOPDD_EXPIRYDATE = LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_OPENING_PQTY = SUM(FOPDD_OPENING_PQTY),   
			FOPDD_OPENING_SQTY = SUM(FOPDD_OPENING_SQTY),   
			FOPDD_TODAY_PQTY = SUM(FOPDD_TODAY_PQTY),   
			FOPDD_TODAY_SQTY = SUM(FOPDD_TODAY_SQTY),   
			FOPDD_EXERCISEDQTY = SUM(FOPDD_EXERCISEDQTY) ,   
			FOPDD_ASSIGNEDQTY = SUM(FOPDD_ASSIGNEDQTY),   
			FOPDD_INS_PQTY = SUM(FOPDD_INS_PQTY),   
			FOPDD_INS_SQTY = SUM(FOPDD_INS_SQTY),   
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),   
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),   
			FOPDD_EXPQTY = SUM(FOPDD_EXPQTY),   
			FOPDD_AUTOCORPQTY = SUM(FOPDD_AUTOCORPQTY),   
			FOPDD_LONGVALUE = SUM(FOPDD_LONGVALUE),   
			FOPDD_SHORTVALUE = SUM(FOPDD_SHORTVALUE),   
			FOPDD_CLOSINGPRICE= MAX(FOPDD_CLOSINGPRICE) ,           
			FOPDD_STLMNTPRICE=MAX(FOPDD_STLMNTPRICE)  ,            
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,          
			FOPDD_CREATED_DT = LEFT(FOPDD_CREATED_DT,11)             
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			ISNULL(FOPDD_INTFLAG,'IN'),            
			LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     
			FOPDD_CREATED_BY   ,          
			LEFT(FOPDD_CREATED_DT,11)
		ORDER BY             
			FOPDD_PARTY_CODE,             
			FOPDD_FLAG,               
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE ,           
			FOPDD_EXPIRYDATE   
	END

	SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_FO_TRADE_DETAILS_DAS_GET]             
(            
    	@SDATE VARCHAR(11),             
    	@PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            

AS

DECLARE @STDATE		DATETIME,
		@GSTDATE	DATETIME
		
SET		@GSTDATE	= '2017-07-01 00:00:00.000'
SET		@STDATE		= CONVERT(DATETIME,  @SDATE,103)

DECLARE @GSTFLAG NVARCHAR(50)

IF (DATEDIFF(DAY,@GSTDATE,@STDATE)>=0)
BEGIN
	SET @GSTFLAG='GST'
END
ELSE
BEGIN
	SET @GSTFLAG='Service Tax'
END

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
BEGIN
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)             
END

IF @TOCODE = ''
BEGIN
	SET @TOCODE = @PARTYCODE
END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_PQTY = SUM(FOTDD_PQTY),
			FOTDD_SQTY = SUM(FOTDD_SQTY),
			FOTDD_PAMT = SUM(FOTDD_PAMT),
			FOTDD_SAMT = SUM(FOTDD_SAMT),
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),
			FOTDD_INST_TYPE
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		GROUP BY
			FOTDD_PARTY_CODE,
			RIGHT(FOTDD_FLAG,2),   
		    FOTDD_INST_TYPE
		ORDER BY             
			FOTDD_PARTY_CODE ,
			RIGHT(FOTDD_FLAG,2)
	END
ELSE
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_INST_TYPE,             
			FOTDD_SYMBOL,             
			FOTDD_STRIKE_PRICE,             
			FOTDD_OPTION_TYPE,             
			FOTDD_EXPIRY_DATE = LEFT(FOTDD_EXPIRY_DATE,11),             
			FOTDD_SEC_NAME,             
			FOTDD_TRADEQTY,             
			FOTDD_VALUE,             
			FOTDD_PRICE,             
			FOTDD_PQTY,             
			FOTDD_SQTY,             
			FOTDD_PAMT,             
			FOTDD_SAMT,             
			FOTDD_NETRATE,             
			FOTDD_CFPPRICE,             
			FOTDD_CFSPRICE,             
			FOTDD_SETTPRICE,             
			FOTDD_SAUDA_DATE = LEFT(FOTDD_SAUDA_DATE,11),             
			FOTDD_PNETRATE,             
			FOTDD_SNETRATE,             
			FOTDD_CHARGES,             
			FOTDD_BROKERAGE,             
			FOTDD_SERVICE_TAX,             
			FOTDD_BROKER_NOTE,             
			FOTDD_TURN_TAX,             
			FOTDD_SEBI_TAX,             
			FOTDD_CONTRACTNO,             
			FOTDD_PCOMM,             
			FOTDD_SCOMM,             
			FOTDD_INS_CHRG,             
			FOTDD_FLAG = LEFT(FOTDD_FLAG,2),     
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),     
			FOTDD_O_C_FLAG,             
			FOTDD_AUCTIONPART,             
			FOTDD_CREATED_BY,             
			FOTDD_CREATED_DT = LEFT(FOTDD_CREATED_DT,11),
			FOTDD_OTHER_CHRG = CONVERT(NUMERIC(18,4),0)
			--CONTRACTDESCRIPTOR =  FOTDD_INST_TYPE + ' ' + FOTDD_SYMBOL + ' ' + FOTDD_OPTION_TYPE + ' ' + CONVERT(VARCHAR, FOTDD_STRIKE_PRICE) + ' ' + CONVERT(VARCHAR(11), FOTDD_EXPIRY_DATE, 109)
		INTO
			#FO_TRADE_DETAILS
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		ORDER BY             
			FOTDD_PARTY_CODE,           
			LEFT(FOTDD_FLAG,2),           
			FOTDD_INST_TYPE,           
			FOTDD_SYMBOL,           
			FOTDD_STRIKE_PRICE,           
			FOTDD_OPTION_TYPE,           
			FOTDD_EXPIRY_DATE,     
			TRADE_TYPE
		
		UPDATE	#FO_TRADE_DETAILS
		SET		FOTDD_OTHER_CHRG = ISNULL(A.OTHERCHRG,0)
		FROM	(
				SELECT
					PARTY_CODE,
					INST_TYPE,
					SYMBOL,
					STRIKE_PRICE,
					OPTION_TYPE,
					EXPIRYDATE,
					OTHERCHRG = SUM(OTHER_CHRG)
				FROM	
					FOBILLVALAN F (NOLOCK)
				WHERE	
					SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59:59'
					AND PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
					AND TRADETYPE ='BT'
				GROUP BY
					PARTY_CODE,
					INST_TYPE,
					SYMBOL,
					STRIKE_PRICE,
					OPTION_TYPE,
					EXPIRYDATE
				) A	
		WHERE	A.PARTY_CODE = #FO_TRADE_DETAILS.FOTDD_PARTY_CODE
				AND A.INST_TYPE = FOTDD_INST_TYPE
				AND A.SYMBOL = FOTDD_SYMBOL
				AND A.STRIKE_PRICE = FOTDD_STRIKE_PRICE
				AND A.OPTION_TYPE = FOTDD_OPTION_TYPE
				AND LEFT(A.EXPIRYDATE,11) = LEFT(FOTDD_EXPIRY_DATE,11)
				AND #FO_TRADE_DETAILS.FOTDD_FLAG IN ('01','02','03')
		
		SELECT *,GSTFLAG=@GSTFLAG FROM #FO_TRADE_DETAILS
		ORDER BY             
			FOTDD_PARTY_CODE,           
			LEFT(FOTDD_FLAG,2),           
			FOTDD_INST_TYPE,           
			FOTDD_SYMBOL,           
			FOTDD_STRIKE_PRICE,           
			FOTDD_OPTION_TYPE,           
			FOTDD_EXPIRY_DATE,     
			TRADE_TYPE
		
		DROP TABLE #FO_TRADE_DETAILS	
		
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPFILE_PARAM_GET
-- --------------------------------------------------




CREATE  PROC [dbo].[CLS_IMPFILE_PARAM_GET] 
(	@MODE VARCHAR(20),
	@FILETYPE VARCHAR(20) ='',
	@EXCHANGE VARCHAR(3)='',
	@SEGMENT VARCHAR(7)='',
	@SAUDA_DATE VARCHAR(11)=''
	
) AS 

/*
	@MODE : IMPFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : TRDFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : BULK_IMP_PATH - TO FETCH THE BULK IMPORT DEFAULT PATH
	@MODE : MEMBER_DET - TO FETCH THE MEMBER DETAILS
	@MODE : TRDATE_STAT - TO FETCH THE BUSSINESS DATE CLOSE STATUS
*/

DECLARE @STRSQL VARCHAR(MAX)


-----------------------------------------------------------------
IF @MODE = 'IMPFILE_TYPE'			-- IMPORT EXCHANGE FILES
BEGIN
	SELECT FILETYPE_CD+'|'+isnull([FILE_NAME],'NA') AS FILETYPE_CD,FILETYPE_DESC,FILE_SAMPLE FROM CLS_EXCH_IMPFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END

-----------------------------------------------------------------
IF @MODE = 'TRDFILE_TYPE'		-- TRADE FILE IMPORT
BEGIN
	SELECT FILETYPE_CD+'|'+isnull([FILE_NAME],'NA') AS FILETYPE_CD,FILETYPE_DESC,FILE_SAMPLE FROM CLS_TRADEFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END
-----------------------------------------------------------------

IF @MODE = 'BULK_IMP_PATH'
BEGIN
	IF (SELECT COUNT(1) FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE) > 0
	BEGIN
		SELECT FILE_PATH FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE
	END
	ELSE
	BEGIN
		SELECT 'C:' AS FILE_PATH
	END
END
-------------------------------------------------------------------

IF @MODE = 'MEMBER_DET'
BEGIN
	SELECT COMPANY,MEMBERTYPE='TM',MEMBERCODE FROM [OWNER] (NOLOCK)
END

-----------------------------------------------------------------------------

IF @MODE = 'TRDATE_STAT'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') > 0
	BEGIN
		IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE OPEN_CLOSE = 1 AND BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') = 0
		BEGIN
			SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
		END
		ELSE
		BEGIN
			SELECT 'CLOSED' AS TRDATE_STAT, ERRMSG ='CANNOT PROCEED. BUSINESS DATE ' +  @SAUDA_DATE + ' IS CLOSED'
		END
	END
	ELSE
	BEGIN
		SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
	END
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_PROCESS
-- --------------------------------------------------







CREATE PROC [dbo].[CLS_IMPORT_TRADE_FILE_PROCESS]
(	@MODE VARCHAR(20),
	@SAUDA_DATE VARCHAR(11)='',
	@SESSIONID VARCHAR(30)='',
	@IMPORTMODE INT=0	
) AS 

/*
	@MODE : RESET_TRD - TO RESET THE TRADE
	@MODE : TRDCOUNT_GET - TO GET THE TRADE REC COUNTS
	@MODE : NEXTSTEP_GET - TO GET THE IMP TRD PROCESS NEXT STEP
	@MODE : ERRTRD_GET - TO GET THE ERROR TRADE LIST
	@MODE : CHECK_ERR - TO CHECK THE TRADE ERROS
*/
/*
TRADE PROCESS STEP - ACTION CODES
I10 - TRADE FILE IMPORTED
I50 - ERROR CORRECTED CHECKED
I60 - TRADE CONFIRMED
I70 - CONCTRACT GENERATED
*/
-----------------------------------------------------------------------------------------
DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

IF @MODE = 'RESET_TRD'
BEGIN	
	TRUNCATE TABLE FOFTTRADE
	TRUNCATE TABLE FOTRADE
	TRUNCATE TABLE FOSTAT_TRD
END
-----------------------------------------------------------------------------------------

IF @MODE = 'TRDCOUNT_GET'
BEGIN	
	DECLARE @TRADE_DATE VARCHAR(11)

	IF (SELECT COUNT(1) FROM FOTRADE) >0
	BEGIN
		SELECT TOP 1 @TRADE_DATE = CONVERT(VARCHAR,ACTIVITYTIME,103) FROM FOTRADE
		IF @TRADE_DATE <> @SAUDA_DATE
		BEGIN
			IF @SESSIONID=''
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= COUNT(1),
				--ERRMSG = @TRADE_DATE
				ERRMSG ='', EXCHSEG='NSX-CAPITAL', TRADE_DATE = ISNULL(@TRADE_DATE,'NA')
				FROM FOTRADE
			END
			ELSE
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= 0, 
				ERRMSG = 'ERROR - TRADE DATE IN THE FILE ' + @TRADE_DATE + ' IS NOT MACHING THE ENTERED DATE'
				RETURN
			END
		END
	END
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
	IF ISNull(@TRADE_DATE,'') = ''
	 SET @TRADE_DATE = CONVERT(VARCHAR(11), GETDATE(), 103)

	IF @IMPORTMODE  = 1 -- NORMAL IMPORT
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG ='', EXCHSEG='NSX-CAPITAL', TRADE_DATE = @TRADE_DATE
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD WHERE SESSION_ID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM FOFTTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END
	ELSE
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG ='', EXCHSEG='NSX-CAPITAL', TRADE_DATE = @TRADE_DATE
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD_BULK WHERE SPID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM FOFTTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END

END
-----------------------------------------------------------------------------------------

IF @MODE = 'NEXTSTEP_GET'
BEGIN	
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE LIKE @SAUDA_DATE+'%' )=0
	BEGIN
		SELECT CURR_STEP='', NEXT_STEP = 'START_IMP'
		RETURN
	END

	SELECT 
			CURR_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'START_IMP'
							WHEN LAST_STEP='I50' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I60' THEN 'CONFIRM_TRD'
						ELSE 'CONTRACT_TRD'
						END,

			NEXT_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I50' THEN 'CONFIRM_TRD'
							WHEN LAST_STEP='I60' THEN 'CONTRACT_TRD'
						ELSE 'RESET_TRD'
						END
	FROM
	(
		SELECT LAST_STEP = MAX(ACTIONCODE) FROM FOSTAT_TRD 
		WHERE SYSDATE LIKE @SAUDA_DATE+'%'
	) A
END
-----------------------------------------------------------------------------------------

IF @MODE = 'ERRTRD_GET'
BEGIN

	SET @ERR_CD = -1
	SET @ERR_DESC = 'ERROR TRADE LIST. PLEASE VERIFY'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

	SELECT PARTY_CODE AS [PARTY CODE],TRADE_NO AS [TRADE NO],ORDER_NO AS [ORDER NO],[STATUS],
	[CONTRACT] = INST_TYPE + ' ' + SYMBOL + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + OPTION_TYPE
	FROM FOFTTRADE  
	WHERE STATUS IN (12,17)
	AND ORDER_NO NOT IN ( SELECT ORDER_NO FROM FOTRADE)
	ORDER BY 1,2,3,4,5
	
	RETURN
END
-----------------------------------------------------------------------------------------------------
IF @MODE = 'CHECK_ERR'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
	
	IF(SELECT COUNT(1) FROM FOTRADE ) = 0
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. NO RECORD TO PROCESS'
		
		TRUNCATE TABLE FOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF(SELECT COUNT(1) FROM (SELECT  DISTINCT LEFT(ACTIVITYTIME,11) AS SDATE FROM FOTRADE) TRD) > 1
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. DUPLICATE TRADE DATES FOUND IN THE FILE'
		
		TRUNCATE TABLE FOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF (SELECT MEMBERTYPE FROM FOOWNER) = 'CM'
	BEGIN
		UPDATE FOTRADE SET RESERVED2='0'
		UPDATE FOTRADE SET PARTY_CODE= CLIENT2.PARTY_CODE,RESERVED2='2' FROM CLIENT2 WHERE CLIENT2.BANKID =FOTRADE.PARTICIPANTCODE
		UPDATE FOTRADE SET PARTY_CODE=FOTMINFO.PARTY_CODE,RESERVED2='2' FROM FOTMINFO WHERE FOTMINFO.TM_CODE=FOTRADE.MEMBERCODE AND FOTRADE.RESERVED2='0'
	END


	UPDATE FOTRADE SET FOTRADE.PARTY_CODE = TERMPARTY.PARTY_CODE FROM TERMPARTY WHERE TERMPARTY.USERID = FOTRADE.USER_ID 
	AND FOTRADE.PARTY_CODE NOT LIKE TERMPARTY.EXCEPTPARTY AND FOTRADE.PRO_CLI = PROCLI 

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

		SELECT DISTINCT PARTY_CODE AS [PARTY CODE],USER_ID AS [TERMIAL ID],ISNULL(PARTICIPANTCODE,'') AS [PARTICIPANT CODE],
		MEMBERCODE AS [MEMBER CODE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE)
			
		RETURN
	END

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING SCRIPTS FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT DISTINCT INST_TYPE AS [INST TYPE],SYMBOL, LEFT(EXPIRYDATE,11) AS [EXPIRY DATE],
		STRIKE_PRICE AS [STRIKE PRICE], OPTION_TYPE AS [OPTION TYPE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE)
		RETURN
	END

	EXEC FOTRD_CLIENTMASTER

	SELECT FOTRADE.* INTO #FOERRTRADE 
	FROM FOTRADE (NOLOCK), FOOWNER (NOLOCK) WHERE EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK)
	WHERE CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE AND CLIENT2.BANKID <> FOTRADE.PARTICIPANTCODE)
	AND ISNULL(PARTICIPANTCODE,'') <> ''
	AND PARTICIPANTCODE <> FOOWNER.MEMBERCODE

	INSERT INTO FOERRTRADE      
	SELECT * FROM #FOERRTRADE

	IF (((SELECT COUNT(1) FROM #FOERRTRADE) > 0) OR ((SELECT COUNT(1) FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) 
												WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE
												AND CLIENT5.INACTIVEFROM <= GETDATE())>0))
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. WRONG CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]


		SELECT PARTY_CODE,'IN ACTIVE' FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE
		AND CLIENT5.INACTIVEFROM <= GETDATE()

		/*UNION ALL

		SELECT C.PARTY_CODE,'EXPIRED SEBI REG' FROM 
		FOTRD_CLIENT2 (NOLOCK), CLIENT_DETAILS_VIEW C (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = C.CL_CODE
		AND ISNULL(C.SEBI_REGN_NO,'') <> '' AND C.SEBI_EXP_DATE <= GETDATE()*/

		UNION ALL

		SELECT DISTINCT PARTY_CODE,'WRONG CP CODE' FROM #FOERRTRADE 
		
		RETURN
	END

	EXEC FOTRD_SCRIPMASTER


	DECLARE @TRDCOUNT BIGINT
	DECLARE @CONFCOUNT BIGINT
	DECLARE @TRDQTY BIGINT
	DECLARE @CONFQTY BIGINT
	DECLARE @TRDAMT MONEY
	DECLARE @CONFAMT MONEY

	SELECT @CONFQTY=ISNULL(SUM(TRADEQTY),0),@CONFAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@CONFCOUNT=COUNT(1) FROM FOCONFIRMVIEW 
	SELECT @TRDQTY=ISNULL(SUM(TRADEQTY),0),@TRDAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@TRDCOUNT=COUNT(1) FROM FOTRADE  
	 
	IF @TRDQTY <> @CONFQTY OR @TRDCOUNT <> @CONFCOUNT OR @TRDAMT <> @CONFAMT
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'STILL SOME ERROS IN MASTERS . HENCE THE BELOW TRADE AND CONFIRMVIEW IS NOT MATCHING'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT 'TRADE COUNT ' +  CONVERT(VARCHAR,@TRDCOUNT) AS [TRADE] , 'CONFIRM TRADE COUNT ' +  CONVERT(VARCHAR,@CONFCOUNT) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE QTY ' +  CONVERT(VARCHAR,@TRDQTY) AS [TRADE] , 'CONFIRM TRADE QTY ' +  CONVERT(VARCHAR,@CONFQTY) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE AMT ' +  CONVERT(VARCHAR,@TRDAMT) AS [TRADE] , 'CONFIRM TRADE AMT ' +  CONVERT(VARCHAR,@CONFAMT) AS [CONFIRM TRADE] 
		
		RETURN	
	END

	INSERT INTO FOSTAT_TRD
	SELECT ACTIONCODE	 = 'I50',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)

	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_CALC_GET
-- --------------------------------------------------





CREATE PROC [dbo].[CLS_MARGIN_CALC_GET] (@MARGINDATE VARCHAR(11),@UNAME VARCHAR(20)) AS

DECLARE @MARGINDATE_ORG VARCHAR(11)
SET @MARGINDATE_ORG = @MARGINDATE

SET @MARGINDATE = LEFT(CONVERT(DATETIME,@MARGINDATE,103),11)

DECLARE @INTBATCHNO INT
DECLARE @STRFILENAME VARCHAR(200)

SET @INTBATCHNO = 1
IF (SELECT COUNT(1) FROM MG13BATCHNO_TBL (NOLOCK) WHERE FILEDATE = @MARGINDATE)> 0
BEGIN
	SELECT @INTBATCHNO = MAX(BATCHNO)+1 FROM MG13BATCHNO_TBL (NOLOCK) WHERE FILEDATE = @MARGINDATE
	UPDATE MG13BATCHNO_TBL SET BATCHNO = BATCHNO + 1 WHERE FILEDATE = @MARGINDATE
END
ELSE
BEGIN
	INSERT INTO MG13BATCHNO_TBL VALUES (@MARGINDATE,@INTBATCHNO,0,0,0,0,'',GETDATE())
END

DECLARE @COLLOPTION VARCHAR(300)
DECLARE @ACTPTION VARCHAR(300)
DECLARE @HAIRCUTOPTION VARCHAR(300)


SET @COLLOPTION = 'ACCOUNTS AND COLLATERAL'
SET @COLLOPTION = 'WITHOUT BILL'
SET @HAIRCUTOPTION = 'AFTER HAIRCUT'

SELECT @COLLOPTION=HEADING FROM FOMG13REFERENCE WHERE SUBJECT='MENU' 
AND  REFNO = (SELECT MAX(REFNO) FROM FOMG13REFERENCE WHERE SUBJECT='MENU')

IF (SELECT COUNT(1) FROM FOMG13REFERENCE WHERE SUBJECT='MENU' AND HEADING ='WITH BILL' AND SUBMENUREFNO=1) > 0
BEGIN
	SET @COLLOPTION = 'WITH BILL'
END

IF (SELECT COUNT(1) FROM FOMG13REFERENCE WHERE SUBJECT='MENU' AND HEADING ='BEFORE HAIRCUT' AND SUBMENUREFNO=1) > 0
BEGIN
	SET @COLLOPTION = 'BEFORE HAIRCUT'
END

EXEC FOMARGINNEW_CALC @MARGINDATE,@COLLOPTION,@COLLOPTION,@HAIRCUTOPTION,@INTBATCHNO,@INTBATCHNO

DECLARE @REPORTEXCESS VARCHAR(10)
SET @REPORTEXCESS ='REQUIRED'

IF (SELECT COUNT(1) FROM FOMG13REFERENCE WHERE SUBJECT ='MRGOPTION' AND HEADING = 'REPORT EXCESS TOO' AND SUBMENUREFNO = 1) > 0
BEGIN
	SET @REPORTEXCESS ='WHOLE'
END


CREATE TABLE #FOMARGIN_SHORTAGE
(
	MDATE VARCHAR(11),
	PARTY_CODE VARCHAR(20),
	SPREADMARGIN MONEY,
	NONSPREADMARGIN MONEY,
	TOTALMARGIN MONEY,
	MTOM MONEY,
	EFFECTIVECOLL MONEY,
	CL_TYPE VARCHAR(2)
)


INSERT INTO #FOMARGIN_SHORTAGE
SELECT 
	UPPER(REPLACE(CONVERT(VARCHAR,MDATE,106),' ','-')) MDATE,
	(CASE WHEN FOMARGINNEW_EFFCOLL.PARTY_CODE = MEMBERCODE THEN 'PRO_' ELSE '' END) 
		+ ISNULL(OLDPARTY_CODE,FOMARGINNEW_EFFCOLL.PARTY_CODE) PARTY_CODE,
	SPREADMARGIN,
	NONSPREADMARGIN,
	TOTALMARGIN,
	MTOM,
	CASE WHEN @REPORTEXCESS  ='REQUIRED'
		THEN
			(CASE
				WHEN EFFECTIVECOLL > TOTALMARGIN
				THEN
					TOTALMARGIN
				ELSE
					CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
				END)
		ELSE
			CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
		END

	AS EFFECTIVECOLL,
	LTRIM(RTRIM( CL_TYPE))
FROM
	FOMARGINNEW_EFFCOLL (NOLOCK) ,
    FOOWNER (NOLOCK),
	FOMARGINNEW (NOLOCK)
	LEFT OUTER JOIN PARTYMAPPING (NOLOCK) ON (FOMARGINNEW.PARTY_CODE = NEWPARTY_CODE)
WHERE
	FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
    AND FOMARGINNEW.MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
    AND CL_TYPE <> 'TM'
					
					
UPDATE #FOMARGIN_SHORTAGE  SET PARTY_CODE = BANKID 
FROM CLIENT1,CLIENT2 WHERE #FOMARGIN_SHORTAGE.PARTY_CODE =CLIENT2.PARTY_CODE 
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
AND CLIENT1.CL_TYPE = 'NRI'
AND ISNULL(BANKID,'') <> ''


IF (SELECT MEMBERTYPE FROM FOOWNER) = 'TM'
	BEGIN
		SET @STRFILENAME = 'F_MRG_TM_' + REPLACE(CONVERT(VARCHAR,@MARGINDATE_ORG,103),'/','')+'_'+CONVERT(VARCHAR,@INTBATCHNO)+'.CSV'
	END
ELSE
	BEGIN
		SET @STRFILENAME = 'F_MRG_CM_' + REPLACE(CONVERT(VARCHAR,@MARGINDATE_ORG,103),'/','')+'_'+CONVERT(VARCHAR,@INTBATCHNO)+'.CSV'
	END

EXEC CLIENTMARGIN_UPD @MARGINDATE

EXEC V2_PROCESS_STATUS_LOG_UPD @MARGINDATE,'MRGFILE','',@UNAME,''  

IF (SELECT MEMBERTYPE FROM FOOWNER) = 'TM'
	BEGIN
		SELECT @STRFILENAME AS [FILENAME],
				MDATE + ',' + PARTY_CODE + ',' + CONVERT(VARCHAR,SPREADMARGIN) + ',' + CONVERT(VARCHAR,NONSPREADMARGIN) + ',' + 
				CONVERT(VARCHAR,TOTALMARGIN) + ',' + CONVERT(VARCHAR,MTOM) + ',' + CL_TYPE + ',' + 
				CONVERT(VARCHAR,EFFECTIVECOLL) AS [FILEDATA]
		FROM #FOMARGIN_SHORTAGE
		
	END
ELSE
	BEGIN
		SELECT @STRFILENAME AS [FILENAME],
				MDATE + ',' + PARTY_CODE + ',' + CONVERT(VARCHAR,SPREADMARGIN) + ',' + CONVERT(VARCHAR,NONSPREADMARGIN) + ',' + 
				CONVERT(VARCHAR,TOTALMARGIN) + ',' + CONVERT(VARCHAR,MTOM) + ',' +
				CONVERT(VARCHAR,EFFECTIVECOLL) AS [FILEDATA]
		FROM #FOMARGIN_SHORTAGE
	END

DROP TABLE #FOMARGIN_SHORTAGE

/*--------------------------------------------- END OF THE PROC ----------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_RPT
-- --------------------------------------------------



CREATE  PROC [dbo].[CLS_MARGIN_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25)
)  AS

--EXEC CLS_MARGIN_RPT '02/02/2009','02/02/2009','0','zzz','BROKER','BROKER'
--EXEC RPT_DAILYMARGINSTATEMENT 'FEB  2 2009', '','ZZZZZZZZZZ','','ZZZZZZZZZ','','ZZZZZZZZZ','BROKER','BROKER'  

SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)

IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF (SELECT COUNT(1) FROM PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NCDX (NOLOCK)
WHERE MARGINDATE  BETWEEN @DATEFROM  AND  @DATETO + ' 23:59:00' ) > 0
BEGIN
SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(BILLAMOUNT,2)),
		LEDGER_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(LEDGERAMOUNT,2)),      
		NET_CASH_AVAILABLE = CONVERT(NUMERIC(18,2),ROUND(BILLAMOUNT + LEDGERAMOUNT,2)),
		COLLATERAL_AVAILABLE = CONVERT(NUMERIC(18,2),ROUND(CASH_COLL + NONCASH_COLL,2)),
		REPORTED_MRG_COLLATERAL = CONVERT(NUMERIC(18,2),ROUND(ISNULL(F.FINALAMOUNT,0),2)),
		INITIALMARGIN = CONVERT(NUMERIC(18,2),ROUND(INITIALMARGIN,2)), 
		MTMMARGIN = CONVERT(NUMERIC(18,2),ROUND(MTMMARGIN,2)),
		ADDMARGIN = CONVERT(NUMERIC(18,2),ROUND(ADDMARGIN,2)),
		FREE_COLLATERALS = CONVERT(NUMERIC(18,2),ROUND(((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),2)),
		NET_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN))+(BILLAMOUNT + LEDGERAMOUNT),2)),
		FREE_COLLATERALS_REPORTING = CONVERT(NUMERIC(18,2),ROUND((ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))-(INITIALMARGIN+MTMMARGIN+ADDMARGIN)),2)),
		NET_AMOUNT_REPORTING = CONVERT(NUMERIC(18,2),ROUND((ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN))+(BILLAMOUNT + LEDGERAMOUNT),2))
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NCDX FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(BILLAMOUNT,2)),
		LEDGER_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(LEDGERAMOUNT,2)),      
		NET_CASH_AVAILABLE = CONVERT(NUMERIC(18,2),ROUND(BILLAMOUNT + LEDGERAMOUNT,2)),
		COLLATERAL_AVAILABLE = CONVERT(NUMERIC(18,2),ROUND(CASH_COLL + NONCASH_COLL,2)),
		REPORTED_MRG_COLLATERAL = CONVERT(NUMERIC(18,2),ROUND(ISNULL(F.FINALAMOUNT,0),2)),
		INITIALMARGIN = CONVERT(NUMERIC(18,2),ROUND(INITIALMARGIN,2)), 
		MTMMARGIN = CONVERT(NUMERIC(18,2),ROUND(MTMMARGIN,2)),
		ADDMARGIN = CONVERT(NUMERIC(18,2),ROUND(ADDMARGIN,2)),
		FREE_COLLATERALS = CONVERT(NUMERIC(18,2),ROUND(((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),2)),
		NET_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),2)),
		FREE_COLLATERALS_REPORTING = CONVERT(NUMERIC(18,2),ROUND((ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),2)),
		NET_AMOUNT_REPORTING = CONVERT(NUMERIC(18,2),ROUND((ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),2))
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		TBL_CLIENTMARGIN FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGINSHORTFALL
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_MARGINSHORTFALL]

	(

	@STATUSID		VARCHAR(20),

	@STATUSNAME		VARCHAR(30),

	@FROMDATE		VARCHAR(11),

	@FROMCLIENT		VARCHAR(20),

	@TOCLIENT		VARCHAR(20),

	@FROMBRANCH		VARCHAR(20),

	@TOBRANCH		VARCHAR(20)	

	)



	AS 

	

	/*

	DECLARE		@FROMBRANCH		VARCHAR(20),

				@TOBRANCH		VARCHAR(20),

				@FROMDATE		VARCHAR(11),

				@TODATE			VARCHAR(11),

				@FROMCLIENT		VARCHAR(20),

				@TOCLIENT		VARCHAR(20)

				

	SET	@FROMBRANCH	= ''

	SET	@TOBRANCH = 'zzzzzzzzz'

	SET	@FROMDATE = 'JAN  1 2011'

	SET @TODATE = 'DEC 31 2016'

	SET @FROMCLIENT = ''

	SET @TOCLIENT = 'zzzzzzzzz'

	

	EXEC CLS_MARGINSHORTFALL 'BROKER','BROKER','JAN  1 2012','','ZZZZZZ','','ZZZZZZ'

	*/

	

	DECLARE		@MARGINDATE VARCHAR(11)



	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0

	BEGIN

		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)

	END	



	SELECT @MARGINDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE,109),103)	



	IF @TOCLIENT = ''

	BEGIN

		SET @TOCLIENT = 'zzzzzzzzzzz'

	END 



	IF @TOBRANCH = ''

	BEGIN

		SET @TOBRANCH = 'zzzzzzzzzzz'

	END 





	DECLARE @COLLDATE VARCHAR(11)

	SELECT @COLLDATE = MAX(EFFDATE)

	FROM MSAJAG..COLLATERALDETAILS (NOLOCK)

	WHERE EFFDATE < @FROMDATE + ' 23:59:59'

	AND EXCHANGE='NCE' AND SEGMENT='FUTURES'





	CREATE TABLE #MARGINSHORTFALL

		(

		CLIENT_CODE			VARCHAR(20),

		CLIENT_NAME			VARCHAR(100),

		MARGINDATE			VARCHAR(11),

		CLOSING_BAL			NUMERIC(18,4),

		UNCLEARED_AMT		NUMERIC(18,4),

		COLLATERAL_AMT		NUMERIC(18,4),

		MARGIN_REQ			NUMERIC(18,4),

		EXCESS_SHORT_MARGIN NUMERIC(18,4),

		MTM_AMT				NUMERIC(18,4),

		TOTAL_REQ_MARGIN	NUMERIC(18,4),

		FUND_EXCESS_REQ		NUMERIC(18,4)

		)





	SELECT 

		DISTINCT

		CLIENT_CODE = C2.PARTY_CODE,

		CLIENT_NAME = C1.LONG_NAME

	INTO #CL_MASTER

	FROM

		CLIENT1 C1 (NOLOCK),

		CLIENT2 C2 (NOLOCK)

	WHERE

		C1.CL_CODE = C2.CL_CODE

		AND C2.CL_CODE BETWEEN @FROMCLIENT AND @TOCLIENT

		AND @STATUSNAME = (               

		CASE             

			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD             

			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER             

			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER             

			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY             

			WHEN @STATUSID = 'AREA'         THEN C1.AREA             

			WHEN @STATUSID = 'REGION'       THEN C1.REGION       

			WHEN @STATUSID = 'CLIENT'       THEN C2.PARTY_CODE             

			ELSE 'BROKER'

		END)



	--CLOSING BALANCE

	DECLARE	@@SDTCUR VARCHAR(11)

	SELECT	@@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM ACCOUNTNCE.DBO.PARAMETER (NOLOCK)
	 WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR



	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = CLTCODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = SUM(CASE DRCR WHEN 'D' THEN -VAMT ELSE VAMT END),

		UNCLEARED_AMT = 0,

		COLLATERAL_AMT = 0,

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = 0,

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM 

		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),

		#CL_MASTER M

	WHERE 

		CLTCODE = CLIENT_CODE 

		AND EDT >= @@SDTCUR AND EDT <= @FROMDATE + ' 23:59'

	GROUP BY 

		CLTCODE,

		CLIENT_NAME

		INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = CLTCODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = SUM(CASE DRCR WHEN 'C' THEN -VAMT ELSE VAMT END),

		UNCLEARED_AMT = 0,

		COLLATERAL_AMT = 0,

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = 0,

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM 

		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),

		#CL_MASTER M

	WHERE 

		CLTCODE = CLIENT_CODE 

		AND EDT >= @@SDTCUR AND vdt < @@SDTCUR

	GROUP BY 

		CLTCODE,

		CLIENT_NAME

		



	--COLLATERAL STATEMENT

	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = C.PARTY_CODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = 0,

		UNCLEARED_AMT = 0,

		COLLATERAL_AMT = SUM(FINALAMOUNT),

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = 0,

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM

		MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),

		#CL_MASTER M (NOLOCK)

	WHERE

		CLIENT_CODE = C.PARTY_CODE

		AND C.EXCHANGE = 'NCE'

		AND C.SEGMENT = 'FUTURES'

		AND EFFDATE BETWEEN @COLLDATE AND @COLLDATE + ' 23:59:59'

	GROUP BY

		C.PARTY_CODE,

		CLIENT_NAME

		



	--Exchange Margin Requirement (d)

	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = LEDDD_PARTY_CODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = 0,

		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,

		MARGIN_REQ = SUM(LEDDD_INIT_EXPO_MARGIN),

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = 0,

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM

		LEDGER_DETAILS_DAS F (NOLOCK),

		#CL_MASTER M (NOLOCK)

	WHERE

		CLIENT_CODE = F.LEDDD_PARTY_CODE	

		AND LEDDD_SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'

	GROUP BY

		LEDDD_PARTY_CODE,

		CLIENT_NAME







	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = CLTCODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = 0,

		UNCLEARED_AMT = 0,

		COLLATERAL_AMT = 0,

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = SUM(CASE DRCR WHEN 'D' THEN -VAMT ELSE VAMT END),--sum(vamt),

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM 

		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),

		#CL_MASTER M

	WHERE 

		CLTCODE = CLIENT_CODE 

		AND VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'

		AND VTYP = '15'

	GROUP BY 

		CLTCODE,

		CLIENT_NAME



/*						

	--MTM for 29.11.2016 (f )

	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = FOTDD_PARTY_CODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = 0,

		UNCLEARED_AMT = 0,

		COLLATERAL_AMT = 0,

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = (SUM(FOTDD_SAMT-FOTDD_PAMT)),

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM             

		FO_TRADE_DETAILS_DAS F (NOLOCK),

		#CL_MASTER M (NOLOCK)

	WHERE

		CLIENT_CODE = F.FOTDD_PARTY_CODE

		AND FOTDD_SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'

		AND FOTDD_FLAG = '04'

	GROUP BY

		FOTDD_PARTY_CODE,

		CLIENT_NAME    

*/	    



	--Un cleared Cheque (b)

	INSERT INTO #MARGINSHORTFALL

	SELECT 

		CLIENT_CODE = CLTCODE,

		CLIENT_NAME,

		MARGINDATE = @MARGINDATE,

		CLOSING_BAL = 0,

		UNCLEARED_AMT = SUM(CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END),

		COLLATERAL_AMT = 0,

		MARGIN_REQ = 0,

		EXCESS_SHORT_MARGIN = 0,

		MTM_AMT = 0,

		TOTAL_REQ_MARGIN = 0,

		FUND_EXCESS_REQ = 0

	FROM      

		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),

		#CL_MASTER M (NOLOCK)

	WHERE

		CLIENT_CODE = L.CLTCODE

		AND VDT >= (SELECT SDTCUR FROM ACCOUNTNCE.DBO.PARAMETER (NOLOCK) WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR)

		AND VDT <= @FROMDATE + ' 23:59'

		AND EDT > @FROMDATE + ' 23:59'

		AND VTYP = '2'

	GROUP BY 

		CLTCODE,

		CLIENT_NAME

		

		

	SELECT 

		CLIENT_CODE,

		CLIENT_NAME,

		MARGINDATE,

		CLOSING_BAL = SUM(CLOSING_BAL),

		UNCLEARED_AMT = SUM(UNCLEARED_AMT),

		COLLATERAL_AMT = SUM(COLLATERAL_AMT),

		MARGIN_REQ = -(SUM(MARGIN_REQ)),

		EXCESS_SHORT_MARGIN = (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL_AMT)-SUM(MARGIN_REQ)),

		MTM_AMT = SUM(MTM_AMT),

		TOTAL_REQ_MARGIN = (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL_AMT)-SUM(MARGIN_REQ)+SUM(MTM_AMT)),

		FUND_EXCESS_REQ = CASE WHEN sum(COLLATERAL_AMT) > sum(MARGIN_REQ) THEN SUM(CLOSING_BAL) + SUM(UNCLEARED_AMT) + SUM(MTM_AMT)

		ELSE (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL_AMT)-SUM(MARGIN_REQ)+SUM(MTM_AMT)) END

	FROM #MARGINSHORTFALL

	GROUP BY

		CLIENT_CODE,

		CLIENT_NAME,

		MARGINDATE

	HAVING

		(ABS(SUM(CLOSING_BAL))+SUM(UNCLEARED_AMT)+SUM(COLLATERAL_AMT)+SUM(MARGIN_REQ)+SUM(MTM_AMT)) <> 0

	ORDER BY

		CLIENT_CODE





	DROP TABLE #MARGINSHORTFALL

	DROP TABLE #CL_MASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGINSHORTFALLT1
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_MARGINSHORTFALLT1]

	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(30),
	@FROMDATE		VARCHAR(11),
	@FROMCLIENT		VARCHAR(20),
	@TOCLIENT		VARCHAR(20),
	@FROMBRANCH		VARCHAR(20),
	@TOBRANCH		VARCHAR(20)	
	)


	AS 

--	EXEC CLS_MARGINSHORTFALL 'BROKER','BROKER','JAN  1 2012','','ZZZZZZ','','ZZZZZZ'

	
	DECLARE		@MARGINDATE VARCHAR(11)
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END	

	SELECT @MARGINDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE,109),103)	



	IF @TOCLIENT = ''
	BEGIN
		SET @TOCLIENT = 'zzzzzzzzzzz'
	END 



	IF @TOBRANCH = ''
	BEGIN
		SET @TOBRANCH = 'zzzzzzzzzzz'
	END 


	DECLARE @COLLDATE VARCHAR(11)
	SELECT @COLLDATE = MAX(EFFDATE)
	FROM MSAJAG..COLLATERALDETAILS (NOLOCK)
	WHERE EFFDATE <= @FROMDATE + ' 23:59:59'
	AND EXCHANGE='NCE' AND SEGMENT='FUTURES'

	
	DECLARE @COLLDATET1 VARCHAR(11)
	SELECT  @COLLDATET1 = MAX(EFFDATE)
	FROM MSAJAG..COLLATERALDETAILS (NOLOCK)
	WHERE EFFDATE < @FROMDATE
	AND EXCHANGE='NCE' AND SEGMENT='FUTURES'



	CREATE TABLE #MARGINSHORTFALL
		(
		CLIENT_CODE			VARCHAR(20),
		CLIENT_NAME			VARCHAR(100),
		MARGINDATE			VARCHAR(11),
		CLOSING_BAL			NUMERIC(18,4),
		UNCLEARED_AMT		NUMERIC(18,4),
		COLLATERAL_AMT		NUMERIC(18,4),
		COLLATERAL1_AMT		NUMERIC(18,4),
		MARGIN_REQ			NUMERIC(18,4),
		EXCESS_SHORT_MARGIN NUMERIC(18,4),
		MTM_AMT				NUMERIC(18,4),
		TOTAL_REQ_MARGIN	NUMERIC(18,4),
		FUND_EXCESS_REQ		NUMERIC(18,4)
		)

	SELECT 
		DISTINCT
		CLIENT_CODE = C2.PARTY_CODE,
		CLIENT_NAME = C1.LONG_NAME
	INTO #CL_MASTER
	FROM
		CLIENT1 C1 (NOLOCK),
		CLIENT2 C2 (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE
		AND C2.CL_CODE BETWEEN @FROMCLIENT AND @TOCLIENT
		AND @STATUSNAME = (               
		CASE             
			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD             
			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER             
			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER             
			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY             
			WHEN @STATUSID = 'AREA'         THEN C1.AREA             
			WHEN @STATUSID = 'REGION'       THEN C1.REGION       
			WHEN @STATUSID = 'CLIENT'       THEN C2.PARTY_CODE             
			ELSE 'BROKER'
		END)



	--CLOSING BALANCE

	DECLARE	@@SDTCUR VARCHAR(11)

	SELECT	@@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM ACCOUNTNCE.DBO.PARAMETER (NOLOCK)
	 WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR



	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = CLTCODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = SUM(CASE DRCR WHEN 'D' THEN -VAMT ELSE VAMT END),
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM 
		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),
		#CL_MASTER M
	WHERE 
		CLTCODE = CLIENT_CODE 
		AND EDT >= @@SDTCUR AND EDT <= @FROMDATE + ' 23:59'
	GROUP BY 
		CLTCODE,
		CLIENT_NAME

		INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = CLTCODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = SUM(CASE DRCR WHEN 'C' THEN -VAMT ELSE VAMT END),
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM 
		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),
		#CL_MASTER M
	WHERE 
		CLTCODE = CLIENT_CODE 
		AND EDT >= @@SDTCUR AND vdt < @@SDTCUR
	GROUP BY 
		CLTCODE,
		CLIENT_NAME

		



	--COLLATERAL STATEMENT

	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = C.PARTY_CODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = 0,
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = SUM(FINALAMOUNT),
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM
		MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
		#CL_MASTER M (NOLOCK)
	WHERE
		CLIENT_CODE = C.PARTY_CODE
		AND C.EXCHANGE = 'NCE'
		AND C.SEGMENT = 'FUTURES'
		AND EFFDATE BETWEEN @COLLDATE AND @COLLDATE + ' 23:59:59'
	GROUP BY
		C.PARTY_CODE,
		CLIENT_NAME

	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = C.PARTY_CODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = 0,
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = SUM(FINALAMOUNT),
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM
		MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
		#CL_MASTER M (NOLOCK)
	WHERE
		CLIENT_CODE = C.PARTY_CODE
		AND C.EXCHANGE = 'NCE'
		AND C.SEGMENT = 'FUTURES'
		AND EFFDATE BETWEEN @COLLDATET1 AND @COLLDATET1 + ' 23:59:59'
	GROUP BY
		C.PARTY_CODE,
		CLIENT_NAME	



	--Exchange Margin Requirement (d)

	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = LEDDD_PARTY_CODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = 0,
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = SUM(LEDDD_INIT_EXPO_MARGIN),
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM
		LEDGER_DETAILS_DAS F (NOLOCK),
		#CL_MASTER M (NOLOCK)
	WHERE
		CLIENT_CODE = F.LEDDD_PARTY_CODE	
		AND LEDDD_SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
	GROUP BY
		LEDDD_PARTY_CODE,
		CLIENT_NAME


	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = CLTCODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = 0,
		UNCLEARED_AMT = 0,
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = SUM(CASE DRCR WHEN 'D' THEN -VAMT ELSE VAMT END),--sum(vamt),
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM 
		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),
		#CL_MASTER M
	WHERE 
		CLTCODE = CLIENT_CODE 
		AND VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
		AND VTYP = '15'
	GROUP BY 
		CLTCODE,
		CLIENT_NAME


	--Un cleared Cheque (b)

	INSERT INTO #MARGINSHORTFALL
	SELECT 
		CLIENT_CODE = CLTCODE,
		CLIENT_NAME,
		MARGINDATE = @MARGINDATE,
		CLOSING_BAL = 0,
		UNCLEARED_AMT = SUM(CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END),
		COLLATERAL_AMT = 0,
		COLLATERAL1_AMT = 0,
		MARGIN_REQ = 0,
		EXCESS_SHORT_MARGIN = 0,
		MTM_AMT = 0,
		TOTAL_REQ_MARGIN = 0,
		FUND_EXCESS_REQ = 0
	FROM      
		ACCOUNTNCE.DBO.LEDGER L (NOLOCK),
		#CL_MASTER M (NOLOCK)
	WHERE
		CLIENT_CODE = L.CLTCODE
		AND VDT >= (SELECT SDTCUR FROM ACCOUNTNCE.DBO.PARAMETER (NOLOCK) WHERE @FROMDATE BETWEEN SDTCUR AND LDTCUR)
		AND VDT <= @FROMDATE + ' 23:59'
		AND EDT > @FROMDATE + ' 23:59'
		AND VTYP = '2'
	GROUP BY 
		CLTCODE,
		CLIENT_NAME
		

	SELECT 
		CLIENT_CODE,
		CLIENT_NAME,
		MARGINDATE,
		CLOSING_BAL = SUM(CLOSING_BAL),
		UNCLEARED_AMT = SUM(UNCLEARED_AMT),
		COLLATERAL_AMT = SUM(COLLATERAL_AMT),
		COLLATERAL1_AMT = SUM(COLLATERAL1_AMT),
		MARGIN_REQ = -(SUM(MARGIN_REQ)),
		EXCESS_SHORT_MARGIN = (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL1_AMT)-SUM(MARGIN_REQ)),
		MTM_AMT = SUM(MTM_AMT),
		TOTAL_REQ_MARGIN = (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL1_AMT)-SUM(MARGIN_REQ)+SUM(MTM_AMT)),
		FUND_EXCESS_REQ = CASE WHEN sum(COLLATERAL1_AMT) > sum(MARGIN_REQ) THEN SUM(CLOSING_BAL) + SUM(UNCLEARED_AMT) + SUM(MTM_AMT)
		ELSE (SUM(CLOSING_BAL)+SUM(UNCLEARED_AMT)+SUM(COLLATERAL1_AMT)-SUM(MARGIN_REQ)+SUM(MTM_AMT)) END
	FROM #MARGINSHORTFALL
	GROUP BY
		CLIENT_CODE,
		CLIENT_NAME,
		MARGINDATE
	HAVING
		(ABS(SUM(CLOSING_BAL))+SUM(UNCLEARED_AMT)+SUM(COLLATERAL1_AMT)+SUM(MARGIN_REQ)+SUM(MTM_AMT)) <> 0
	ORDER BY
		CLIENT_CODE


	DROP TABLE #MARGINSHORTFALL
	DROP TABLE #CL_MASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETAILS_RPT
-- --------------------------------------------------



-- EXEC CLS_PARTYDETAILS_RPT '010A141'

CREATE PROCEDURE [dbo].[CLS_PARTYDETAILS_RPT]     
(    
	@PARTYCODE AS VARCHAR(20)    
)       
AS  
   
/*
	RECORD SET 1 - BASIC INFO
	RECORD SET 2 - TRD & DEL BROK FOR EQ / FUT & OPT FOR F&O
	RECORD SET 3 - TRD & DEL VBB BROK EQ / FUT & OPT FOR F&O
	RECORD SET 4 - DP DETAILS - PAYIN A/C 
	RECORD SET 5 - DP DETAILS - PAYOUT A/C 
	
*/
    

------------------------------------------------------------------------------------------------------------------------------
DECLARE @SEGMENT VARCHAR(20)
SELECT TOP 1 @SEGMENT= SEGMENT FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK) WHERE SHAREDB = DB_NAME()

IF @SEGMENT = 'CAPITAL'
BEGIN

	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN CLIENTTAXES_NEW CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN FROMDATE AND TODATE
														AND TRANS_CAT = 'TRD' )
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  
	--------------------------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'TRADING BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'TRD' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'DELIVERY BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'DEL' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3
END
ELSE
BEGIN


	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.FUT_TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.FUT_SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.FUT_INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.FUT_OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.FUT_BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN FOCLIENTTAXES CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO)
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  	
	---------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'FUTURE BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=FUT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'OPTION BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=OPT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3

END

--------------------------------------------------------------------------------------------------------------------------------
SELECT 
	BROKERAGE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'TRADING' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY' 
			END + 
			CASE WHEN @SEGMENT = 'CAPITAL' THEN '' ELSE SP_INST_TYPE END
			+' VOLUME BASED BROKERAGE' ,
	SCHEMEDT = LEFT(SP_DATE_FROM,11) + ' -  ' + LEFT(SP_DATE_TO,11),
	SCHEMEID = SP_SCHEME_ID,
	SCHEMEDESC = ISNULL(SM_SCHEME_DESC,''),
	SCHEMETYPE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'NORMAL TRADE' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY TRADE' 
			END,
	SYMBOL = SP_SCRIP , 
	COMPUTATIONTYPE = CASE SP_BROK_COMPUTETYPE WHEN  'I' THEN 'INCREMENTAL' ELSE 'VARIABLE' END,
	BROKCOMPUTEON = CASE WHEN SP_BROK_COMPUTEON ='T' THEN 'TURNOVER' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='Q' THEN 'QUANTITY' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='L' THEN 'LOT SIZE' ELSE
				'VALUE OF LOT' END END END ,
	COMPUTATIONLEVEL = CASE WHEN SP_COMPUTATION_LEVEL ='T' THEN 'TRADES' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='O' THEN 'ORDER' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='S' THEN 'SCRIP' ELSE
					'CONTRACT' END END END,
	SCHEME = CASE WHEN SP_SCHEME_TYPE=0 THEN 'DEFAULT' ELSE
			 CASE WHEN SP_SCHEME_TYPE=1 THEN 'MAX LOGIC BS FL' ELSE 
			'MAX LOGIC SS FL' END END,
	VALUERANGE = CONVERT(VARCHAR,SP_VALUE_FROM) + ' - ' + CASE WHEN SP_VALUE_TO = -1 THEN 'UN LIMIT' ELSE
		CONVERT(VARCHAR,SP_VALUE_TO) END,
	BROK = 'BUY ' + CONVERT(VARCHAR,SP_BUY_BROK) + CASE WHEN SP_BUY_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END  +
		' SELL ' + CONVERT(VARCHAR,SP_SELL_BROK) + CASE WHEN SP_SELL_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END,

	SCRORD = CASE WHEN SP_SCRIP='ALL' THEN 1 ELSE 2 END,
	RCOUNT = 1
FROM SCHEME_MAPPING MP LEFT OUTER JOIN SCHEME_MASTER MS ON (SM_SCHEME_ID = SP_SCHEME_ID)
WHERE SP_PARTY_CODE = @PARTYCODE
AND GETDATE() BETWEEN SP_DATE_FROM AND SP_DATE_TO
ORDER BY 1,3,SCRORD

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY IN ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =DPID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPNO,
	POA_STATUS = CASE WHEN DEF = 1 THEN 'RECEIVED' ELSE 'NOT RECEIVED' END
FROM MULTICLTID M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.DPID AND PARTY_CODE= @PARTYCODE AND M.DPTYPE = B.BANKTYPE

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY OUT ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =B.BANKID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPID
FROM CLIENT4 M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.BANKID AND PARTY_CODE= @PARTYCODE AND  B.BANKTYPE = M.DEPOSITORY

----------------------------------------------------------------------------------------------------------------------

	CREATE TABLE  #MULTIBANKID
	(
		[CLTCODE] [VARCHAR](20),
		[BANKID] [VARCHAR](16),
		[ACCNO] [VARCHAR](20),
		[ACCTYPE] [VARCHAR](7)
	) 

	DECLARE @ACCOUNTDB VARCHAR(50)
	DECLARE @STRSQL VARCHAR(1000)
	
	SELECT TOP 1 @ACCOUNTDB= ACCOUNTDB FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK)  WHERE SHAREDB = DB_NAME()
	
	SET @STRSQL = 'INSERT INTO #MULTIBANKID SELECT CLTCODE,BANKID,ACCNO,ACCTYPE FROM ' + @ACCOUNTDB + '.DBO.MULTIBANKID (NOLOCK) WHERE CLTCODE ='''+ @PARTYCODE +''''
	EXEC (@STRSQL)


	 SELECT 
	  BANK_DETAILS = 'BANK DETAILS',  
	  BANKNAME = ISNULL(P.BANK_NAME,''),      
	  BRANCH = ISNULL(P.BRANCH_NAME,''),      
	  ACNUM = ISNULL(C.ACCNO,''),      
	  ACTYPE = (CASE WHEN ISNULL(C.ACCTYPE,'')  = 'SAVING' OR ISNULL(C.ACCTYPE,'')  = 'SB' THEN 'SAVING'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'CURRENT' OR ISNULL(C.ACCTYPE,'')  = 'CA' THEN 'CURRENT'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'OD' THEN 'OVER DRAFT'     
							   ELSE 'OTHER'    
					  END)
	 FROM      
	  #MULTIBANKID C      
	   JOIN POBANK P (NOLOCK)      
	   ON (P.BANKID = C.BANKID)      
	 WHERE      
	  C.CLTCODE = @PARTYCODE    
	 ORDER BY       
	  BANKNAME 
	  
	  DROP TABLE #MULTIBANKID

/*--------------------------------------------------END OF THE PROC ---------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_PARTYDETDAILYNEW] (
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@FPARTY VARCHAR(20),
	@TPARTY VARCHAR(20),
	@SAUDA VARCHAR(11),
	@BRANCHCD VARCHAR(16) = '%',
	@DIGIFLAG INT = 0
	)
AS
IF @BRANCHCD = ''
BEGIN
	SET @BRANCHCD = '%'
END

IF @TPARTY = ''
BEGIN
	SET @TPARTY = 'ZZZZZZZZZZ'
END

DECLARE @SAUDADATE VARCHAR(11)

SET @SAUDADATE = @SAUDA

IF LEN(@SAUDA) = 10 AND CHARINDEX('/', @SAUDA) > 0
BEGIN
	SET @SAUDA = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA, 103), 109)
END
	
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	[CLIENT CODE] = C2.CL_CODE,
	[CLIENT NAME] = C1.LONG_NAME,
	[TRADE DATE] = @SAUDADATE,
	C2.EXCHANGE,
	C2.TRAN_CAT,
	C1.EMAIL,
	C1.RES_PHONE1,
	C1.SHORT_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_ZIP,
	C1.FAMILY,
	C1.BRANCH_CD,
	C2.PARTY_CODE,
	TRADER = ISNULL(C1.TRADER, ''),
	C1.PAN_GIR_NO,
	EXTRAFIELDS = 0,
	MARGINSTATEFLAG = 0
FROM CLIENT1 C1(NOLOCK),
	CLIENT2 C2(NOLOCK),
	(
		SELECT DISTINCT PARTY_CODE = FOPDD_PARTY_CODE
		FROM FO_POS_DETAILS_DAS(NOLOCK)
		WHERE FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59' 
				AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
				AND ((FOPDD_OPENING_PQTY + FOPDD_TODAY_PQTY) - (FOPDD_OPENING_SQTY + FOPDD_TODAY_SQTY)) <> 0
		
		UNION
		
		SELECT DISTINCT PARTY_CODE = FOTDD_PARTY_CODE
		FROM FO_TRADE_DETAILS_DAS(NOLOCK)
		WHERE FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59' 
				AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		) F,
	CLIENT_PRINT_SETTINGS CP(NOLOCK)
WHERE	F.PARTY_CODE = C2.PARTY_CODE 
		AND C1.CL_CODE = C2.CL_CODE 
		AND C1.BRANCH_CD = (CASE WHEN @BRANCHCD = '' OR @BRANCHCD ='%' THEN C1.BRANCH_CD ELSE @BRANCHCD END) 
		AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
		AND C2.PRINTF = CP.PRINT_FLAG 
		AND CP.VALID_REPORT LIKE (
		CASE 
			WHEN @DIGIFLAG = 0		THEN '%'
			WHEN @DIGIFLAG = 1		THEN '%CONTRACT%'
			WHEN @DIGIFLAG = 2		THEN '%DIGITAL%'
			ELSE CP.VALID_REPORT	
		END
		) AND @STATUSNAME = (
		CASE 
			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY
			WHEN @STATUSID = 'AREA'			THEN C1.AREA
			WHEN @STATUSID = 'REGION'		THEN C1.REGION
			WHEN @STATUSID = 'CLIENT'		THEN C2.PARTY_CODE
			ELSE 'BROKER'
		END
		)
ORDER BY C2.PARTY_CODE
	/* 
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = CONVERT(VARCHAR, FOTDD_SAUDA_DATE, 103),
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE,
  TRADER = '',  
  PAN_GIR_NO = '',
  EXTRAFIELDS = 1     
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW_SUMMARY
-- --------------------------------------------------




create PROCEDURE [dbo].[CLS_PARTYDETDAILYNEW_SUMMARY] (
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@FPARTY VARCHAR(20),
	@TPARTY VARCHAR(20),
	@SAUDA VARCHAR(11),
	@BRANCHCD VARCHAR(16) = '%',
	@DIGIFLAG INT = 0
	)

AS

IF @BRANCHCD = ''
BEGIN
	SET @BRANCHCD = '%'
END

IF @TPARTY = ''
BEGIN
	SET @TPARTY = 'ZZZZZZZZZZ'
END

DECLARE @SAUDADATE VARCHAR(11)

SET @SAUDADATE = @SAUDA

IF LEN(@SAUDA) = 10 AND CHARINDEX('/', @SAUDA) > 0
BEGIN
	SET @SAUDA = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA, 103), 109)
END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT [CLIENT CODE] = C2.CL_CODE,
	[CLIENT NAME] = C1.LONG_NAME,
	[TRADE DATE] = @SAUDADATE
FROM CLIENT1 C1(NOLOCK),
	CLIENT2 C2(NOLOCK),
	(
		SELECT DISTINCT PARTY_CODE = FOPDD_PARTY_CODE
		FROM FO_POS_DETAILS_DAS(NOLOCK)
		WHERE FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59' 
				AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
				AND ((FOPDD_OPENING_PQTY + FOPDD_TODAY_PQTY) - (FOPDD_OPENING_SQTY + FOPDD_TODAY_SQTY)) <> 0
		
		UNION
		
		SELECT DISTINCT PARTY_CODE = FOTDD_PARTY_CODE
		FROM FO_TRADE_DETAILS_DAS(NOLOCK)
		WHERE FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59' 
				AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		) F,
	CLIENT_PRINT_SETTINGS CP(NOLOCK)
WHERE 
	F.PARTY_CODE = C2.PARTY_CODE 
	AND C1.CL_CODE = C2.CL_CODE 
	AND C1.BRANCH_CD LIKE @BRANCHCD 
	AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
	AND C2.PRINTF = CP.PRINT_FLAG 
	AND CP.VALID_REPORT LIKE (
		CASE 
			WHEN @DIGIFLAG = 0		THEN '%'
			WHEN @DIGIFLAG = 1		THEN '%CONTRACT%'
			WHEN @DIGIFLAG = 2		THEN '%DIGITAL%'
			ELSE CP.VALID_REPORT
		END
		) AND @STATUSNAME = (
		CASE 
			WHEN @STATUSID = 'BRANCH'		THEN C1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER'	THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER'		THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY'		THEN C1.FAMILY
			WHEN @STATUSID = 'AREA'			THEN C1.AREA
			WHEN @STATUSID = 'REGION'		THEN C1.REGION
			WHEN @STATUSID = 'CLIENT'		THEN C2.PARTY_CODE
			ELSE 'BROKER'
		END
		)
ORDER BY C2.PARTY_CODE
	/*  
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = @SAUDADATE 
  /*,
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE*/      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_VALIDATEFILE
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_PR_VALIDATEFILE] 
(
	@FILETYPE VARCHAR(12),
	@FILEPATHNAME VARCHAR(8000),
	@SAUDA_DATE VARCHAR(11)
) AS
/*
INX_TRTM_<CLG NO.>_<yyyymmdd>_<SessionID>.csv

select substring
*/
DECLARE @FILESINGLE VARCHAR(1000),			@LOOPID INT,				@DEFPATH VARCHAR(500),			@IMPFILE VARCHAR(500),
		@VALIDATEFILE VARCHAR(500),			@MEMBERCODE VARCHAR(15),	@SQL VARCHAR(8000),				@FILENAME VARCHAR(100),
		@INTSTAT INT,						@STRRET VARCHAR(200),		@EXCHANGECODE VARCHAR(3),		@INTDATEVAL INT,
		@ORGSAUDA_DATE VARCHAR(11),			@FILEDATE_V VARCHAR(12)

SET @ORGSAUDA_DATE = @SAUDA_DATE

IF LEN(@SAUDA_DATE) = 10 AND CHARINDEX('/', @SAUDA_DATE) > 0  
 BEGIN  
  SET @SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)  
 END 


IF  CHARINDEX('\',@FILEPATHNAME) > 0
BEGIN
	SET @FILENAME = REVERSE(LEFT(REVERSE(@FILEPATHNAME),CHARINDEX('\',REVERSE(@FILEPATHNAME))-1))
END
ELSE
BEGIN
	SET @FILENAME = @FILEPATHNAME
END


SET @INTSTAT = 0
SET @STRRET  = ''
SET @INTDATEVAL = 0

	IF @FILETYPE = 'DBVIEW'
	 BEGIN
		SET @INTSTAT = 0
		SET @STRRET  = ''
		SELECT @INTSTAT AS INTSTAT,@STRRET AS STRRET	
		return
	 END
		
	IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
	WHERE OPEN_CLOSE = 1 AND BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') = 0
	BEGIN
		SET @INTSTAT = 0
	END

	SET @LOOPID = 1
	SET @DEFPATH = .DBO.PIECE(@FILEPATHNAME, '$', 1)
	SET @FILEPATHNAME = .DBO.PIECE(@FILEPATHNAME, '$', 2)
	WHILE 1 = 1
		BEGIN
			SET @FILESINGLE = .DBO.PIECE(@FILEPATHNAME, '|', @LOOPID)
			IF @FILESINGLE = '' OR @FILESINGLE IS NULL
				BEGIN
					BREAK
				END
			--SET @FILESINGLE = @DEFPATH + '\' + @FILESINGLE
			SET @FILENAME = @FILESINGLE
			
			IF (SELECT COUNT(*) FROM CLS_TRADEFILE_TYPE WHERE FILETYPE_CD  = @FILETYPE) > 0 --@FILETYPE ='TERMINAL'
			BEGIN
				SELECT @MEMBERCODE = MEMBERCODE FROM OWNER
				SELECT @VALIDATEFILE = FILE_NAME FROM CLS_TRADEFILE_TYPE WHERE FILETYPE_CD  = @FILETYPE
				SET @VALIDATEFILE = REPLACE(REPLACE(@VALIDATEFILE,'DDMMYYYY',REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')),'MEMBERCODE',@MEMBERCODE)
			
				IF UPPER(@FILENAME) <> UPPER(@VALIDATEFILE) OR UPPER(RIGHT(@FILENAME,4)) <> '.CSV' OR CHARINDEX(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''), @FILENAME, 1)  = 0
				BEGIN
					--select UPPER(@FILENAME) ,UPPER(@VALIDATEFILE) ,UPPER(RIGHT(@FILENAME,4)) ,'.TXT' ,CHARINDEX(@SAUDA_DATE, @FILENAME, 1), @FILENAME,CHARINDEX(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''), @FILENAME, 1)
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID TRADE FILE SELECTED'
				END
			END
		SET @LOOPID = @LOOPID + 1
	END
	SET @SAUDA_DATE = @ORGSAUDA_DATE
	SET @FILENAME = REPLACE(@FILENAME,'|','')
		IF @FILETYPE ='CONTRACT'
		BEGIN
			IF @EXCHANGECODE = 'NSE' OR @EXCHANGECODE = 'NCM'  
				BEGIN
				IF @FILENAME <> 'CONTRACT.TXT'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
				END
			END
			IF @EXCHANGECODE = 'NSX' OR @EXCHANGECODE = 'NXM'  
				BEGIN
				IF @FILENAME <> 'CD_CONTRACT.TXT'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
				END
			END	
			IF @EXCHANGECODE = 'NCE' OR @EXCHANGECODE = 'NCP'  
				BEGIN
				IF @FILENAME <> 'CO_CONTRACT.TXT'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
				END
			END	
			
		END

		IF @FILETYPE ='CLOSING'
		BEGIN
			IF RIGHT(@FILENAME,3) <> '.MD' OR RIGHT(@FILENAME,8)= 'BHAV.CSV'
			BEGIN
				SET @INTSTAT = 1
				SET @STRRET  = 'INVALID CLOSING FILE SELECTED'
			END
			SET @FILENAME = REVERSE(SUBSTRING(REVERSE(@FILENAME), CHARINDEX('.', REVERSE(@FILENAME)) + 1, 999))
			SET @FILEDATE_V = LEFT(@FILENAME,4)
			SET @SAUDA_DATE = LEFT(REPLACE(@SAUDA_DATE,'/',''),4)
			SET @INTDATEVAL = 1
			--SELECT @FILENAME,@FILEDATE_V,@SAUDA_DATE
		END

		IF @FILETYPE ='CORPACT_1'
		BEGIN
			IF RIGHT(@FILENAME,23) <> '_EXISTING_POSITIONS.CSV'
			BEGIN
				SET @INTSTAT = 1
				SET @STRRET  = 'INVALID CORPORATE ACTION FILE SELECTED'
			END
		END


		IF @FILETYPE ='CORPACT_2'
		BEGIN
			IF RIGHT(@FILENAME,23) <> '_ADJUSTED_POSITIONS.CSV' 
			BEGIN
				SET @INTSTAT = 1
				SET @STRRET  = 'INVALID CORPORATE ACTION FILE SELECTED'
			END
		END

		IF @FILETYPE ='MARGIN'
		BEGIN
			-- NSEFFO, NSEFOPCM
			IF @EXCHANGECODE = 'NSE' OR @EXCHANGECODE = 'NCM'  
				BEGIN
				IF LEFT(@FILENAME,4) <> 'F_MG'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
				END
			END

			-- NSECURFO, NSECURFOPCM
			IF @EXCHANGECODE = 'NSX' OR @EXCHANGECODE = 'NXM'  
				BEGIN
				IF LEFT(@FILENAME,4) <> 'X_MG'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
				END
			END	
			SET @FILENAME = REVERSE(SUBSTRING(REVERSE(@FILENAME), CHARINDEX('.', REVERSE(@FILENAME)) + 1, 999))
			SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-7,8)--LEFT(@FILENAME,4)
			SET @SAUDA_DATE = LEFT(REPLACE(@SAUDA_DATE,'/',''),8)
			SET @INTDATEVAL = 1
			--SELECT @FILENAME,@FILEDATE_V,@SAUDA_DATE
		END

		IF @FILETYPE ='F_CN01'
		BEGIN
			-- NSEFFO, NSEFOPCM
			IF @EXCHANGECODE = 'NSE' OR @EXCHANGECODE = 'NCM'  
				BEGIN
				IF LEFT(@FILENAME,6) <> 'F_CN01'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
				END
			END

			-- NSECURFO, NSECURFOPCM
			IF @EXCHANGECODE = 'NSX' OR @EXCHANGECODE = 'NXM'  
				BEGIN
				IF LEFT(@FILENAME,6) <> 'X_CN01'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
				END
			END	
			SET @SAUDA_DATE = REPLACE(@SAUDA_DATE,'/','')
			SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
			SET @INTDATEVAL = 1
		END


		IF @FILETYPE ='POSITION'
		BEGIN
			-- NSEFFO, NSEFOPCM
			IF @EXCHANGECODE = 'NSE' OR @EXCHANGECODE = 'NCM'  
				BEGIN
				IF LEFT(@FILENAME,5) <> 'F_PS0'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID POSITION FILE SELECTED'
				END
			END

			-- NSECURFO, NSECURFOPCM
			IF @EXCHANGECODE = 'NSX' OR @EXCHANGECODE = 'NXM'  
				BEGIN
				IF LEFT(@FILENAME,5) <> 'X_PS0'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID POSITION FILE SELECTED'
				END
			END	
			SET @SAUDA_DATE = REPLACE(@SAUDA_DATE,'/','')
			SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
			SET @INTDATEVAL = 1
		END


		IF @FILETYPE ='STT'
		BEGIN
			-- NSEFFO, NSEFOPCM
			IF @EXCHANGECODE = 'NSE' OR @EXCHANGECODE = 'NCM'  
				BEGIN
				IF LEFT(@FILENAME,5) <> 'F_STT'
				BEGIN
					SET @INTSTAT = 1
					SET @STRRET  = 'INVALID STT FILE SELECTED'
				END
			END

			SET @SAUDA_DATE = REPLACE(@SAUDA_DATE,'/','')
			SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
			SET @INTDATEVAL = 1
		END



IF @INTDATEVAL = 1 AND @INTSTAT = 0
BEGIN
	
	DECLARE @FILEDATE VARCHAR(12)

	
	--SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
	
	
	--IF LEN(@FILEDATE_V) <> 8
	--BEGIN
	--	SET @INTSTAT = 1
	--	SET @STRRET = 'WRONG FILE NAME'		
	--END	 
	--ELSE
	--BEGIN
		IF @FILEDATE_V <> @SAUDA_DATE
		BEGIN
			SET @INTSTAT = 1	
			SET @STRRET = 'FILE DATE AND ENTER SELECT DATE IS DIFFERENT'			
		END
	--END
END	

SELECT @INTSTAT AS INTSTAT,@STRRET AS STRRET

/*-------------------------------------- END OF THE PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PROC_MARGIN_MG13_INTRADAY_WRAPPER
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_PROC_MARGIN_MG13_INTRADAY_WRAPPER]   
(
	@TDATE VARCHAR(11),
	@FILEFOR VARCHAR(10),
	@FILETYPE VARCHAR(20),
	@PROGID VARCHAR(50),
	@UNAME VARCHAR(10) = '',
	@FILENAME VARCHAR(100)

	)  
AS  

BEGIN 
		IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0  
		 BEGIN  
			SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)  
		END 

		
		EXEC AUTO_BULK_MARGINUPLOAD_INTRADAY @FILENAME,@TDATE

		select 'File Uploaded Successfully, Please Verify Data.'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PROC_MARGIN_MG13_WRAPPER
-- --------------------------------------------------






CREATE PROC [dbo].[CLS_PROC_MARGIN_MG13_WRAPPER]   
(
	@TDATE VARCHAR(11),
	@FILEFOR VARCHAR(10),
	@FILETYPE VARCHAR(20),
	@PROGID VARCHAR(50),
	@UNAME VARCHAR(10) = '',
	@FILENAME VARCHAR(100)

	)  
AS  

BEGIN 
		IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0  
		 BEGIN  
			SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)  
		END 

		
		EXEC PROC_MARGIN_MG13_UP @FILENAME,@TDATE

		select 'File Uploaded Successfully, Please Verify Data.'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PROC_RBI_RATE_UPLOAD
-- --------------------------------------------------



  
CREATE PROCEDURE [dbo].[CLS_PROC_RBI_RATE_UPLOAD]  
 @FILESINGLE VARCHAR(100),  
 @SAUDA_DATE VARCHAR(11),  
 @UNAME VARCHAR(15),  
 @PROCID VARCHAR(30)  
AS  

BEGIN  
DECLARE @STRSQL VARCHAR(MAX), @RECCNT INT  
DELETE FROM FILE_DATA  
IF @PROCID <> ''  
BEGIN  
 INSERT INTO FILE_DATA  
 SELECT FILE_DATA FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID  
 DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID  
END  
ELSE  
BEGIN  
 SET @STRSQL = 'BULK INSERT FILE_DATA FROM ''' + @FILESINGLE  + '''  WITH ( ROWTERMINATOR = '''+char(10)+''', FirstRow = 2)'          
 PRINT @STRSQL  
 EXEC(@STRSQL)  
 END  
  
SELECT @RECCNT = ISNULL(COUNT(1),0) FROM FILE_DATA  
WHERE RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))) <> 'DATE'   
AND RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))) = @SAUDA_DATE  
  
DELETE FROM TBL_RBI_RATE  
WHERE TRADE_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_RBI_RATE  
SELECT   
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))),  
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',2))),  
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',3))),  
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',4))),   
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',5))),   
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',6))),   
RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',7))),   
@UNAME,  
@SAUDA_DATE  
FROM FILE_DATA  
WHERE RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))) <> 'DATE'   
--AND RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))) = REPLACE(CONVERT(VARCHAR,@SAUDA_DATE,106),' ','-')
AND RTRIM(LTRIM(.DBO.PIECE(TEXTDATA,',',1))) = REPLACE (CONVERT(VARCHAR,(CONVERT(DATE,@SAUDA_DATE,106)), 106),' ','-')



UPDATE TBL_RBI_RATE SET EXPIRY_DATE = EXPIRY_DATE + '  23:59'   
WHERE TRADE_DATE = @SAUDA_DATE  
  
UPDATE TBL_RBI_RATE SET RBI_REFERENCE_RATE = RBI_REFERENCE_RATE / TICKSIZE  
FROM TBL_CURR_TICKREF  
WHERE TRADE_DATE = @SAUDA_DATE  
AND TRADE_DATE BETWEEN FROMDATE AND TODATE  
AND TBL_RBI_RATE.SYMBOL = TBL_CURR_TICKREF.SYMBOL  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cls_PROC_TRADE_NSEFURFO_UP
-- --------------------------------------------------







CREATE PROC [dbo].[cls_PROC_TRADE_NSEFURFO_UP]       
(    
	@SNO   NUMERIC(18,0),    
	@SUBPROCESSID INT,    
	@FILETYPE  VARCHAR(10),    
	@SAUDA_DATE  VARCHAR(11),    
	@FILEPATH  VARCHAR(200),
	@STEP VARCHAR(25),
	@IMPORTTYPE VARCHAR(10)
)      
AS      
/*    
 PROC TO IMPORT F&O TRADE FILE & PROCESS    
*/    
    
DECLARE @SQL  VARCHAR(MAX),    
  @TRADEQTY NUMERIC(18,0),    
  @CONFIRMQTY NUMERIC(18,0),    
  @TRADEAMT NUMERIC(18,4),    
  @CONFIRMAMT NUMERIC(18,4),    
  @RECCNT  NUMERIC(18,0),    
  @ERRMSG  VARCHAR(MAX)    
      
EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE, '', '', 'AUTO', ''
    
UPDATE CLS_TBL_PROCESS_DETAIL SET PROCESS_STATUS = 99
WHERE SNO = @SNO
IF @STEP = 'START_IMP'
BEGIN 
	IF @SUBPROCESSID = 0     
	BEGIN    
	--TRUNCATE TABLE FOFTTRADE_1_IMP    
	--TRUNCATE TABLE FOFTTRADE_2_IMP    
	--TRUNCATE TABLE FOFTTRADE_3_IMP    
	--TRUNCATE TABLE FOFTTRADE_4_IMP     
	--TRUNCATE TABLE FOFTTRADE
	--TRUNCATE TABLE FOTRADE  
	 
 --   IF @FILETYPE = 'TRFILE'     
	--BEGIN
	--	IF @IMPORTTYPE = 'BULK'
	--	BEGIN 
	--		BEGIN TRY    
	--			SET @SQL = LOWER('BULK INSERT FOFTTRADE FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')  
	--			PRINT @SQL
	--			EXEC (@SQL)    
	--		END TRY    
	--		BEGIN CATCH    
	--			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,    
	--			PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
	--			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
	--			PROCESS_OUTPUT_QUERY = ''    
	--			WHERE SNO = @SNO AND PROCESS_STATUS = 99      
	--			RETURN    
	--		END CATCH
	--	END
	--		--EXEC INS_FOFTTRADE 4    
	--END  

	--/*IF @FILETYPE = 'TERMINAL'     
	--BEGIN    
	--	BEGIN TRY    
	--		SET @SQL = LOWER('BULK INSERT FOFTTRADE_1_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')    
	--		PRINT @SQL
	--		EXEC (@SQL)    
	--		END TRY    
	--		BEGIN CATCH    
	--		UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,    
	--		PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
	--		PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
	--		PROCESS_OUTPUT_QUERY = ''    
	--		WHERE SNO = @SNO AND PROCESS_STATUS = 99      
	--		RETURN    
	--	END CATCH    
	--		EXEC INS_FOFTTRADE 1    
	--	END    */
     
	--IF @FILETYPE = 'NOTICE'     
	--BEGIN
	--	IF @IMPORTTYPE = 'BULK'
	--	BEGIN 
	--		BEGIN TRY    
	--			SET @SQL = LOWER('BULK INSERT FOFTTRADE_2_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')    
	--			EXEC (@SQL)    
	--		END TRY    
	--		BEGIN CATCH    
	--			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,    
	--			PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
	--			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
	--			PROCESS_OUTPUT_QUERY = ''    
	--			WHERE SNO = @SNO AND PROCESS_STATUS = 99      
	--			RETURN    
	--		END CATCH    
	--	END
	--	EXEC INS_FOFTTRADE 2   		 
	--END   
	----IF @FILETYPE = 'FTP'   
	--IF @FILETYPE = 'FTP'
	--BEGIN
	--	IF @IMPORTTYPE = 'BULK'
	--	BEGIN     
	--		BEGIN TRY    
	--			SET @SQL = LOWER('BULK INSERT FOFTTRADE_3_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')    
	--			EXEC (@SQL)    
	--		END TRY    
	--		BEGIN CATCH    
	--			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,    
	--			PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
	--			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
	--			PROCESS_OUTPUT_QUERY = ''    
	--			WHERE SNO = @SNO AND PROCESS_STATUS = 99      
	--			RETURN    
	--		END CATCH  
	--	END  
	--	EXEC INS_FOFTTRADE 3    
	--END    
     
	--IF @FILETYPE = 'EXCHANGE'     
	--BEGIN
	--	IF @IMPORTTYPE = 'BULK'
	--	BEGIN 
	--		BEGIN TRY    
	--			SET @SQL = LOWER('BULK INSERT FOFTTRADE_4_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')    
	--			PRINT @SQL
	--			EXEC (@SQL)    
	--		END TRY    
	--		BEGIN CATCH    
	--			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,    
	--			PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
	--			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
	--			PROCESS_OUTPUT_QUERY = ''    
	--			WHERE SNO = @SNO AND PROCESS_STATUS = 99      
	--			RETURN    
	--		END CATCH   
	--	END
	--	EXEC INS_FOFTTRADE 4    
	--END     
    
	IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE WHERE LEFT(ACTIVITYTIME,11) <> @SAUDA_DATE) > 0    
	BEGIN    
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET     
		PROCESS_HALTED_REASON = 'SELECTED FILE IS HAVING SOME OTHER DATE DATA THAN THE BUSINESS DATE.',    
		PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()     
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
		TRUNCATE TABLE FOTRADE    
      
		RETURN    
	END    
      
	IF (SELECT ISNULL(COUNT(1),0) FROM (     
	SELECT TOP 1 LEFT(ACTIVITYTIME,11) AS ACTIVITYTIME FROM FOTRADE ) A WHERE LEFT(ACTIVITYTIME,11) NOT IN    
	(SELECT BUSINESS_DATE = LEFT(BUSINESS_DATE,11) FROM V2_BUSINESS_PROCESS (NOLOCK)    
	WHERE OPEN_CLOSE = 0)) > 0     
	BEGIN    
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET     
		PROCESS_HALTED_REASON = 'NOT ALLOW TO IMPORT THE DATA OF OTHER THEN THE PROCESS DATE IS OPEN.',    
		PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()     
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
		TRUNCATE TABLE FOTRADE    
      
		RETURN    
	END    
	ELSE    
	BEGIN   
		EXEC FODUPRECCHECK  
		--INSERT INTO FOSTAT_TRD VALUES ('I10', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE()) 
		SET @SUBPROCESSID = 1   
	END    
END    
    
IF @SUBPROCESSID = 1 OR @SUBPROCESSID = 0    
BEGIN    
	
	EXEC FODUPRECSETTCHECK    
	--INSERT INTO FOSTAT_TRD VALUES ('I20', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())    
	IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0    
	BEGIN    
	PRINT 'TEST 1' 
	PRINT @SNO
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 1,    
		PROCESS_HALTED_REASON = 'ALL TRADES ARE DELETED BECAUSE OF DUPLICATION.',    
		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'    
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
		DELETE FROM FOSTAT_TRD WHERE FILEDATE = @SAUDA_DATE    
    
		RETURN    
	END    
	SET @SUBPROCESSID = 2   
END    
    
IF @SUBPROCESSID = 2 OR @SUBPROCESSID = 0    
BEGIN    
	UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 2    
	WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
	UPDATE FOTRADE SET FOTRADE.PARTY_CODE = TERMPARTY.PARTY_CODE FROM TERMPARTY     
	WHERE TERMPARTY.USERID = FOTRADE.USER_ID AND FOTRADE.PARTY_CODE <> TERMPARTY.EXCEPTPARTY AND FOTRADE.PRO_CLI = PROCLI    
    
	--INSERT INTO FOSTAT_TRD VALUES ('I21', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())    
	SET @SUBPROCESSID = 3    
END    
    
IF @SUBPROCESSID = 3 OR @SUBPROCESSID = 0    
BEGIN    
	SET @SUBPROCESSID = 4    
END    
    
IF @SUBPROCESSID = 4 OR @SUBPROCESSID = 0    
BEGIN    
 -- FOR SKIPPING OF TRADE IN CASE OF MISSING CLIENT AND SCRIP    
	SET @SUBPROCESSID = 5    
END    
	PRINT 1
	UPDATE CLS_TBL_PROCESS_DETAIL SET SUB_PROCESS_ID = @SUBPROCESSID, INTERNAL_PROCESS_ID = 'ERROR_CORR' WHERE SNO = @SNO    
	INSERT INTO FOSTAT_TRD VALUES ('I10', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())         
END

IF @STEP = 'ERROR_CORR'
BEGIN     
	IF @SUBPROCESSID = 5 OR @SUBPROCESSID = 0    
	BEGIN    
		--INSERT INTO FOSTAT_TRD VALUES ('I40', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())    
		EXEC FOTRD_CLIENTMASTER    
		EXEC FOTRD_SCRIPMASTER    
      
		IF (SELECT COUNT(1) FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE    
		AND CLIENT5.INACTIVEFROM <= GETDATE()) > 0    
		BEGIN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
			PROCESS_HALTED_REASON = 'TRADES CONTAINS THE INACTIVE CLIENT DATA, PLEASE CORRECT.#1',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = 'SELECT PARTY_CODE FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE AND CLIENT5.INACTIVEFROM <= GETDATE() '    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
			RETURN    
		END    
    
		IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTRD_CLIENT2)) > 0    
		BEGIN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
			PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING CLIENT DATA, PLEASE CORRECT.#2',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = 'SELECT DISTINCT PARTY_CODE, TERMINAL = USER_ID FROM FOTRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTRD_CLIENT2) '    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
			RETURN    
		END    

			IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE WHERE USER_ID NOT IN (SELECT USERID FROM TERMLIMIT)) > 0        
			BEGIN        
				UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,        
				PROCESS_HALTED_REASON = 'TRADE CONTAIN THE MISSING TERMINAL ID, PLEASE ADD TERMINAL ID.',       
				PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),        
				PROCESS_OUTPUT_QUERY = 'SELECT DISTINCT PARTY_CODE, TERMINAL = USER_ID FROM FOTRADE WHERE USER_ID NOT IN (SELECT USERID FROM TERMLIMIT)', 
				PROCESS_STATUS_ALERT_COUNT = 0        
				WHERE SNO = @SNO AND PROCESS_STATUS = 99        
        
				RETURN        
			END 
    
		IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK)     
					WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE    
					AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE    
					AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL    
					AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE    
					AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE    
					AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE))> 1    
		BEGIN         
			SET @ERRMSG = 'SELECT DISTINCT INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE'    
			SET @ERRMSG = @ERRMSG + ' FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 WHERE '    
			SET @ERRMSG = @ERRMSG + ' FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE'    
			SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL'    
			SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE'    
			SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE'    
			SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE) '    
                   
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
			PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING SCRIP DATA, PLEASE CORRECT.',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = @ERRMSG    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
			RETURN    
		END    
 		UPDATE CLS_TBL_PROCESS_DETAIL SET SUB_PROCESS_ID = @SUBPROCESSID, INTERNAL_PROCESS_ID = 'CONFIRM_TRD' WHERE SNO = @SNO   
		INSERT INTO FOSTAT_TRD VALUES ('I50', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())           
	END
END 
     
IF @STEP = 'CONFIRM_TRD'
BEGIN    
    
	SELECT @TRADEQTY = ISNULL(SUM(TRADEQTY),0), @TRADEAMT = ISNULL(SUM(TRADEQTY*PRICE),0) FROM FOTRADE    
    SELECT @CONFIRMQTY = ISNULL(SUM(TRADEQTY),0), @CONFIRMAMT = ISNULL(SUM(TRADEQTY*PRICE),0) FROM FOCONFIRMVIEW    
    
	IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0    
	BEGIN    
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
		PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',    
		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE()    
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
		RETURN    
	END    
    
	IF (@TRADEQTY - @CONFIRMQTY) <> 0 OR (@TRADEAMT - @CONFIRMAMT) <> 0     
	BEGIN    
		IF @TRADEQTY > @CONFIRMQTY OR @TRADEAMT > @CONFIRMAMT    
		BEGIN    
			IF @CONFIRMQTY = 0    
			BEGIN    
				UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
				PROCESS_HALTED_REASON = 'SEEMS TO BE ISSUE IN MASTER.',    
				PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()    
				WHERE SNO = @SNO AND PROCESS_STATUS = 99    
			END    
			ELSE    
			BEGIN     
				--SET @ERRMSG = 'SELECT PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'    
				SET @ERRMSG = 'SELECT PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE'    
				SET @ERRMSG = @ERRMSG + ' FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOCONFIRMVIEW WHERE '    
				SET @ERRMSG = @ERRMSG + ' FOTRADE.INST_TYPE = FOCONFIRMVIEW.INST_TYPE'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.SYMBOL = FOCONFIRMVIEW.SYMBOL'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.EXPIRYDATE = FOCONFIRMVIEW.EXPIRYDATE'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.STRIKE_PRICE = FOCONFIRMVIEW.STRIKE_PRICE'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.OPTION_TYPE = FOCONFIRMVIEW.OPTION_TYPE'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.TRADE_NO = FOCONFIRMVIEW.TRADE_NO'    
				SET @ERRMSG = @ERRMSG + ' AND FOTRADE.ORDER_NO = FOCONFIRMVIEW.ORDER_NO) '    
          
				UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
				PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER.',    
				PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),        
				PROCESS_OUTPUT_QUERY = @ERRMSG    
				WHERE SNO = @SNO AND PROCESS_STATUS = 99    
			END    
		END    
		ELSE    
		BEGIN    
			SET @ERRMSG = 'SELECT PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'    
			SET @ERRMSG = @ERRMSG + ' FROM FOCONFIRMVIEW GROUP BY '    
			SET @ERRMSG = @ERRMSG + ' PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'    
			SET @ERRMSG = @ERRMSG + ' HAVING COUNT(1) > 1'    
      
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 5,    
			PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER. DUPLICATE DATA IS COMING FROM THE CONFIRMATION.',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = @ERRMSG    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
		END    
		RETURN    
	END    
	ELSE
	BEGIN
		UPDATE CLS_TBL_PROCESS_DETAIL SET SUB_PROCESS_ID = 6, INTERNAL_PROCESS_ID = 'CONTRACT_TRD'
		WHERE SNO = @SNO AND PROCESS_STATUS = 99

		INSERT INTO FOSTAT_TRD VALUES ('I70', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())
		SET @SUBPROCESSID = 6
	END
END
----CONFIRMATION ENDS AND CONTRACT GEN START-----------------------     
IF @STEP = 'CONTRACT_TRD'
BEGIN  
	IF @SUBPROCESSID = 6 OR @SUBPROCESSID = 0    
	BEGIN    
    
		EXEC FOREARRANGETRDFLAG    
		EXEC FOTRD_CLIENTMASTER    
     
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 7    
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
		--INSERT INTO FOSTAT_TRD VALUES ('I80', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())    
		SET @SUBPROCESSID = 7    
	END    
    
	IF @SUBPROCESSID = 7 OR @SUBPROCESSID = 0    
	BEGIN    
		IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0    
		BEGIN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 7,    
			PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
			RETURN    
		END    
    
		IF (SELECT ISNULL(COUNT(*),0) FROM CONTGEN, FOTRADE WHERE ACTIVITYTIME >= START_DATE AND ACTIVITYTIME <= END_DATE) <= 0    
		BEGIN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 7,    
			PROCESS_HALTED_REASON = 'PLEASE ENTER THE CONTRACT NO IN THE TABLE FOR THE CURRENT YEAR.',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = ''    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
			RETURN    
		END    
    
		BEGIN TRAN    
		SELECT @TRADEQTY = 0    
    
		SELECT @TRADEQTY = ISNULL(SUM(TRADEQTY * C_REGULAR_LOT),0), @RECCNT = ISNULL(COUNT(1),0)     
		FROM FOTRADE, FOSCRIP2      
		WHERE FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE AND      
		FOSCRIP2.SYMBOL = FOTRADE.SYMBOL AND      
		FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE AND      
		FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE AND      
		FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE     
   
		/*  
		SELECT @TRADEQTY = ISNULL(SUM(TRADEQTY),0), @RECCNT = ISNULL(COUNT(1),0)     
		FROM FOTRADE    
		*/    
		SELECT @TRADEQTY = @TRADEQTY + ISNULL(SUM(TRADEQTY),0) FROM FOSETTLEMENT     
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'    
     
		BEGIN TRY    
			EXEC FOGENCONTRACT 'AUTO_PROCESS'    
		END TRY    
		BEGIN CATCH    
			ROLLBACK TRAN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 7,    
			PROCESS_HALTED_REASON = ERROR_MESSAGE(),    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = ''    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99      
			RETURN    
		END CATCH    
		SELECT @CONFIRMQTY = 0    
		SELECT @CONFIRMQTY = @CONFIRMQTY + ISNULL(SUM(TRADEQTY),0) FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'    
    
		IF @TRADEQTY <> @CONFIRMQTY     
		BEGIN      
			ROLLBACK TRAN    
			UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 7,    
			PROCESS_HALTED_REASON = 'QTY BEFORE CONTRACT AND AFTER CONTRACT NOT MATCHING.',    
			PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),    
			PROCESS_OUTPUT_QUERY = ''    
			WHERE SNO = @SNO AND PROCESS_STATUS = 99    
		RETURN    
		END    
    
		SET @SUBPROCESSID = 8    
		COMMIT     
    
		UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 8,    
		PROCESS_HALTED_REASON = 'TRADE IMPORTED SUCCESSFULLY.' + CONVERT(VARCHAR,@RECCNT),    
		PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),    
		PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'    
		WHERE SNO = @SNO AND PROCESS_STATUS = 99    
    
--INSERT INTO FOSTAT_TRD VALUES ('I95', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())    
	END    
    
	IF @SUBPROCESSID = 8 OR @SUBPROCESSID = 0    
	BEGIN    
		DELETE FROM FOSTAT_TRD WHERE FILEDATE = @SAUDA_DATE    
	END    
		INSERT INTO FOSTAT_TRD VALUES ('I80', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())       
END

IF @STEP = 'RESET_TRD'
BEGIN  
	TRUNCATE TABLE FOFTTRADE_1_IMP    
	TRUNCATE TABLE FOFTTRADE_2_IMP    
	TRUNCATE TABLE FOFTTRADE_3_IMP    
	TRUNCATE TABLE FOFTTRADE_4_IMP     
	TRUNCATE TABLE FOFTTRADE
	TRUNCATE TABLE FOTRADE
	TRUNCATE TABLE FOSTAT_TRD

	UPDATE CLS_TBL_PROCESS_DETAIL SET SUB_PROCESS_ID = 0,          
	PROCESS_HALTED_REASON = 'TRADE RESET SUCCESSFULLY.',          
	PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE(),          
	PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'          
	WHERE SNO = @SNO 
END      
    
/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_DORMANTCLIENTLIST
-- --------------------------------------------------



CREATE PROC [dbo].[CLS_RPT_DORMANTCLIENTLIST] 
	(
	@FROMPARTY	VARCHAR(15),
	@TOPARTY	VARCHAR(15),
	@D_PERIOD	INT,
	@EXCHANGE	VARCHAR(12)
	)
	
	AS
	
	/*
	EXEC [CLS_RPT_DORMANTCLIENTLIST] '','zzzzzzzzzzzz',360,'NSECAPITAL'
	*/
	
	DECLARE @CUTOFDAY INT
	SET @CUTOFDAY = @D_PERIOD

	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'zzzzzzzzzzzz'
	END
		
	CREATE TABLE #CLIENT (
		PARTY_CODE VARCHAR(15)
		,SAUDA_DATE DATETIME
		,EXCHANGE VARCHAR(3)
		,SEGMENT VARCHAR(8)
		)


	SELECT 
		DISTINCT PARTY_CODE
	INTO
		#PARTY	
	FROM	
		MSAJAG.DBO.CLIENT_DETAILS CD (NOLOCK),
		MSAJAG.DBO.CLIENT_BROK_DETAILS CB (NOLOCK)
	WHERE
		CD.CL_CODE = CB.CL_CODE
		AND EXCHANGE+SEGMENT IN ('NSECAPITAL','BSECAPITAL','NSEFUTURES')
		AND EXCHANGE+SEGMENT = (CASE WHEN @EXCHANGE = '' THEN EXCHANGE+SEGMENT ELSE @EXCHANGE END)
		AND INACTIVE_FROM >= GETDATE()
		--AND ISNULL(DEACTIVE_VALUE,'') = ''


	INSERT INTO #CLIENT
	SELECT PARTY_CODE
		,SAUDA_DATE = MAX(SAUDA_DATE)
		,EXCHANGE
		,SEGMENT
	FROM (
		SELECT PARTY_CODE
			,SAUDA_DATE = MAX(SAUDA_DATE)
			,EXCHANGE = 'NSE'
			,SEGMENT = 'CAPITAL'
		FROM MSAJAG.DBO.CMBILLVALAN(NOLOCK)
		WHERE
			PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND (PQTYTRD + SQTYTRD + PQTYDEL + SQTYDEL) <> 0
			AND TRADETYPE NOT IN (
				'SCF'
				,'ICF'
				,'IR'
				)
			AND @EXCHANGE IN ('NSECAPITAL','')
		GROUP BY PARTY_CODE
		
		UNION
		
		SELECT PARTY_CODE
			,SAUDA_DATE = MAX(SAUDA_DATE)
			,EXCHANGE = 'BSE'
			,SEGMENT = 'CAPITAL'
		FROM BSEDB.DBO.CMBILLVALAN
		WHERE
			PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND (PQTYTRD + SQTYTRD + PQTYDEL + SQTYDEL) <> 0
			AND TRADETYPE NOT IN (
				'SCF'
				,'ICF'
				,'IR'
				)
			AND @EXCHANGE IN ('BSECAPITAL','')
		GROUP BY PARTY_CODE
		
		UNION
		
		SELECT PARTY_CODE
			,SAUDA_DATE = MAX(SAUDA_DATE)
			,EXCHANGE = 'NSE'
			,SEGMENT = 'FUTURES'
		FROM NSEFO.DBO.FOBILLVALAN
		WHERE
			PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND (PQTY + SQTY) <> 0
			--AND TRADETYPE = 'BT'       
			AND AUCTIONPART = ''
			AND @EXCHANGE IN ('NSEFUTURES','')
		GROUP BY PARTY_CODE
		) C

	GROUP BY PARTY_CODE
		,EXCHANGE
		,SEGMENT

	
	DELETE FROM #CLIENT WHERE NOT EXISTS 
	(SELECT PARTY_CODE FROM #PARTY WHERE #CLIENT.PARTY_CODE = #PARTY.PARTY_CODE) 

	ALTER TABLE #CLIENT
	ADD PARTY_NAME VARCHAR(100)

	ALTER TABLE #CLIENT
	ADD BRANCH_CD VARCHAR(20)

	ALTER TABLE #CLIENT
	ADD FAMILY VARCHAR(15)
	
	UPDATE	#CLIENT
	SET		PARTY_NAME = ISNULL(LONG_NAME,''),
			BRANCH_CD = ISNULL(CD.BRANCH_CD,''),
			FAMILY	= ISNULL(CD.FAMILY,'')
	FROM	MSAJAG.DBO.CLIENT_DETAILS CD (NOLOCK)
	WHERE	#CLIENT.PARTY_CODE = CD.CL_CODE
		
	SELECT 
		FAMILY
		,PARTY_CODE
		,SAUDA_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103)
		,EXCHANGE
		,SEGMENT
		,DAYDIFF = CONVERT(NUMERIC, DATEDIFF(DAY,(SAUDA_DATE), GETDATE()))
		,PARTY_NAME
		,BRANCH_CD
	FROM #CLIENT C
	WHERE 
		1 = 1
		AND EXISTS (
			SELECT PARTY_CODE
			FROM (
				SELECT PARTY_CODE
					,SAUDA_DATE = MAX(SAUDA_DATE)
				FROM #CLIENT T(NOLOCK)
				GROUP BY PARTY_CODE
				HAVING CONVERT(NUMERIC, DATEDIFF(DAY, MAX(SAUDA_DATE), GETDATE())) > @CUTOFDAY
				) A
			WHERE A.PARTY_CODE = C.PARTY_CODE
			)
	ORDER BY FAMILY
		,PARTY_CODE
		,EXCHANGE
		,SEGMENT

	DROP TABLE #CLIENT		
	DROP TABLE #PARTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWCLIENTSUMMARY
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWCLIENTSUMMARY]
	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(25),
	@FROMDATE		VARCHAR(11),
	@FROMPARTY		VARCHAR(20),
	@TOPARTY		VARCHAR(20),
	@RATE_FLAG		VARCHAR(10),
	@NETPOS_FLAG	INT = 0,
	@BILL_FLAG		INT = 0,
	@EXCHANGE		VARCHAR(3),
	@SEGMENT 		VARCHAR(10),
	@RPT_TYPE		INT = 0
	)
	
	AS	
	
	/*
	EXEC CLS_RPT_PROC_FO_NEWCLIENTSUMMARY 'BROKER','BROKER','DEC  2 2010','','ZZZZZZZZZ','PRICE',1,1,'NSE','FUTURES',0
	*/
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZ'
	END
	
	CREATE TABLE #CLIENTSUMMARY
		(
		CLIENT_CODE	VARCHAR(20),
		CLIENT_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(5),
		EMAIL		VARCHAR(100),
		L_ADDRESS1	VARCHAR(100), 
		L_ADDRESS2	VARCHAR(100), 
		L_ADDRESS3	VARCHAR(100),  
		L_CITY		VARCHAR(50),
		L_ZIP		VARCHAR(20),
		PAN_GIR_NO	VARCHAR(20),
		OFF_PHONE1	VARCHAR(50),
		OFF_PHONE2	VARCHAR(50),
		BRANCH_CODE VARCHAR(20),
		SUB_BROKER	VARCHAR(20),
		DAILYMTOMSETTLEMENT			MONEY,
		FINALFUTURESSETTLEMENT		MONEY,
		PREMIUMSETTLEMENT			MONEY,
		OPTIONSEXERCISEASSIGNMENT	MONEY,
		BROKANDMISC					MONEY,
		CLEARINGCHARGES				MONEY,

		MARGINDATE	VARCHAR(11),
		LEDBALANCE	MONEY,
		PAYREC		MONEY,
		MINLEDBAL	MONEY,
		MINMARGIN	MONEY,      
		MARGIN		MONEY,
		AVLCOLL		MONEY,
		SPANMAR		MONEY,
		VARMARGIN	MONEY,
		TOTCASH		MONEY,
		TOTCOLLNONCASH MONEY,      
		TOTNONCASH	MONEY,
		TOTCOLL		MONEY,
		EFFCOLL		MONEY,
		SPREADMARGIN	MONEY, 
		NONSPREADMARGIN	MONEY,
		MTOMMARGIN		MONEY,
		EFFNONCASH		MONEY,

		INST_TYPE		VARCHAR(6), 
		SYMBOL			VARCHAR(25), 
		EXPIRYDATE		VARCHAR(11),
		STRIKE_PRICE	MONEY, 
		OPTION_TYPE		VARCHAR(2), 
		OPENPOSITION	MONEY,
		PROFITORLOSS	MONEY,

		S_SPANMARGIN	MONEY,
		S_PREMIUM		MONEY,
		S_ADDMARGINPERC MONEY,
		S_TOTALMARGIN	MONEY,
		E_MARGINPERC	MONEY,
		E_MARGINAMT		MONEY,
		
		REC_TYPE		INT
		)
	
	SELECT	* INTO #FOBILLVALAN
	FROM	FOBILLVALAN (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,CLIENT_NAME,CLIENT_TYPE,EMAIL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PAN_GIR_NO,OFF_PHONE1,OFF_PHONE2,BRANCH_CODE,SUB_BROKER,DAILYMTOMSETTLEMENT,FINALFUTURESSETTLEMENT,PREMIUMSETTLEMENT,OPTIONSEXERCISEASSIGNMENT,BROKANDMISC,CLEARINGCHARGES,REC_TYPE)
	SELECT 
		CLIENT_CODE = F.PARTY_CODE, 
		PARTY_NAME = C1.LONG_NAME,
		CLIENT_TYPE,
		EMAIL = C1.EMAIL,
		L_ADDRESS1 = C1.L_ADDRESS1, 
		L_ADDRESS2 = C1.L_ADDRESS2, 
		L_ADDRESS3 = C1.L_ADDRESS3,  
		L_CITY = C1.L_CITY,
		L_ZIP = C1.L_ZIP, 
		PAN_GIR_NO = C1.PAN_GIR_NO, 
		OFF_PHONE1 = C1.OFF_PHONE1,
		OFF_PHONE2 = C1.OFF_PHONE2,
		BRANCH_CODE = F.BRANCH_CODE,
		SUB_BROKER = F.SUB_BROKER,		 
		DAILYMTOMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0
		END),
		FINALFUTURESSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		PREMIUMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		OPTIONSEXERCISEASSIGNMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		BROKANDMISC = (
		CASE
			WHEN @RATE_FLAG = 'PRICE' THEN -(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			WHEN @RATE_FLAG = 'NETRATE' THEN -(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			ELSE 0
		END),
		CLEARINGCHARGES = -(SUM(CL_CHRG) - SUM(EXCL_CHRG)),
		REC_TYPE = 1
	FROM 
		#FOBILLVALAN F (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE
		F.PARTY_CODE = C1.CL_CODE  
		AND @STATUSNAME = 		
		(CASE
			WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
			WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN C1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
			WHEN @STATUSID = 'AREA' THEN C1.AREA
			WHEN @STATUSID = 'REGION' THEN C1.REGION
			WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE 
			ELSE 'BROKER' 
		END)    
	GROUP BY 
		F.PARTY_CODE, 
		C1.LONG_NAME,
		CLIENT_TYPE,
		C1.EMAIL,
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2, 
		C1.L_ADDRESS3,  
		C1.L_CITY,
		C1.L_ZIP, 
		C1.PAN_GIR_NO, 
		C1.OFF_PHONE1,
		C1.OFF_PHONE2,
		F.BRANCH_CODE,
		F.SUB_BROKER
	ORDER BY 
		F.PARTY_CODE, 
		PARTY_NAME, 
		CLIENT_TYPE
		


	CREATE TABLE #CL_LEDGER
		(
		CLIENT_CODE		VARCHAR(20),
		OPENBALANCE   	MONEY,
		LEDBALANCE   	MONEY,
		PAYREC       	MONEY,    
		MINLEDBAL   	MONEY,    
		MINMARGIN   	MONEY,    
		MARGIN			MONEY,    
		AVLCOLL      	MONEY,    
		SPANMAR      	MONEY,    
		VARMARGIN		MONEY,    
		TOTCASH     	MONEY,    
		TOTNONCASH		MONEY,    
		TOTCOLL  		MONEY,    
		EFFCOLL    		MONEY,    
		SPREADMARGIN 	MONEY,    
		NONSPREADMARGIN MONEY,    
		MTOMMARGIN 		MONEY,    
		MARGINPER 		MONEY,
		EFFNONCASH		MONEY  
		)

	INSERT	INTO #CL_LEDGER 
	SELECT	DISTINCT CLIENT_CODE,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	FROM	#CLIENTSUMMARY
	    
	/* LEDGER BALANCE */    
	UPDATE	#CL_LEDGER
	SET		LEDBALANCE = ISNULL(A.LEDBALANCE,0)
	FROM	(
			SELECT CLTCODE, LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTMCDX.DBO.LEDGER L (NOLOCK), ACCOUNTMCDX.DBO.PARAMETER P (NOLOCK)
			WHERE VDT < @FROMDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND @FROMDATE BETWEEN SDTCUR AND LDTCUR
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
		    
	/* OPEN BALANCE */    
	UPDATE	#CL_LEDGER
	SET		OPENBALANCE = ISNULL(A.OPENBALANCE,0)
	FROM	(
			SELECT CLTCODE, OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTMCDX.DBO.LEDGER L (NOLOCK)
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND VTYP = 18 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* PAYMENT RECEIVED FOR THE DAY */    
	UPDATE	#CL_LEDGER
	SET		PAYREC = ISNULL(A.PAYREC,0)
	FROM	(
			SELECT CLTCODE, PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTMCDX.DBO.LEDGER L (NOLOCK) 
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			AND VTYP NOT IN (15,18)
			GROUP  BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* MARGIN AMOUNT */    
	UPDATE	#CL_LEDGER
	SET		MARGIN = ISNULL(A.MARGIN,0)
	FROM	(
			SELECT PARTY_CODE, MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
			FROM ACCOUNTMCDX.DBO.MARGINLEDGER L (NOLOCK), ACCOUNTMCDX.DBO.PARAMETER P (NOLOCK)  
			WHERE VDT <= @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT 
			AND VDT < @FROMDATE AND VDT >= SDTCUR AND CURYEAR = 1
			GROUP BY PARTY_CODE     
			) A
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	    
	/* SPAN AND VAR MARGIN */    
	IF (SELECT COUNT(1) FROM FOMARGIN_SPAN WHERE MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0 OR  (SELECT COUNT(1) FROM FOMARGIN_EXP_DETAILS (NOLOCK) WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) ,  
					SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0)
				FROM 
					FOMARGIN_SPAN (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE	
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

				
		UPDATE	#CL_LEDGER
		SET		VARMARGIN = ISNULL(A.VARMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					VARMARGIN = -ISNULL(SUM(MARGINAMT),0) ,  
					MTOMMARGIN = -ISNULL(SUM(MARGINAMT),0)
				FROM 
					FOMARGIN_EXP_DETAILS (NOLOCK)
				WHERE 
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE		
				) A	
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

	END
	ELSE
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				VARMARGIN = ISNULL(A.VARMARGIN,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0),
				NONSPREADMARGIN = ISNULL(A.NONSPREADMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(PMARGINAMOUNT),0) , 
					VARMARGIN = -ISNULL(SUM(MTOM),0) , 
					SPREADMARGIN = -ISNULL(SUM(SPREADMARGIN),0), 
					NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0),
					MTOMMARGIN = -ISNULL(SUM(MTOM),0) 
				FROM 
					FOMARGINNEW (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' 
					AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND CL_TYPE <> 'TM'     
				GROUP BY
					PARTY_CODE							
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	END 

	/* COLLATERAL DETAILS */    
	UPDATE	#CL_LEDGER
	SET		TOTCASH = ISNULL(A.TOTCASH,0),
			TOTNONCASH = ISNULL(A.TOTNONCASH,0),
			TOTCOLL = ISNULL(A.TOTCOLL,0),
			EFFCOLL = ISNULL(A.EFFCOLL,0),
			AVLCOLL = ISNULL(A.AVLCOLL,0),
			EFFNONCASH = ISNULL(A.EFFNONCASH,0)
	FROM	(			
			SELECT 
				PARTY_CODE,
				TOTCASH = ISNULL(SUM(CASH),0), 
				TOTNONCASH = ISNULL(SUM(NONCASH),0), 
				TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
				EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
			FROM 
				MSAJAG.DBO.COLLATERAL (NOLOCK)
			WHERE 
				PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND TRANS_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
				AND EXCHANGE = @EXCHANGE    
				AND SEGMENT = @SEGMENT     
			GROUP BY
				PARTY_CODE	
			) A	
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	 

	UPDATE	#CL_LEDGER
	SET		MARGINPER = 100,
			LEDBALANCE = LEDBALANCE + OPENBALANCE
	     

	--INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,MARGINDATE,LEDBALANCE,PAYREC,MINLEDBAL,MINMARGIN,MARGIN,AVLCOLL,SPANMAR,VARMARGIN,TOTCASH, TOTCOLLNONCASH,TOTNONCASH,TOTCOLL,EFFCOLL,SPREADMARGIN,NONSPREADMARGIN,MTOMMARGIN,EFFNONCASH,REC_TYPE)
	--SELECT       
			--CLIENT_CODE,

	UPDATE	#CLIENTSUMMARY
	SET		MARGINDATE = @FROMDATE,       
			LEDBALANCE = C.LEDBALANCE,
			PAYREC = C.PAYREC,
			MINLEDBAL = C.MINLEDBAL,
			MINMARGIN = (C.SPREADMARGIN + C.NONSPREADMARGIN + C.VARMARGIN),
			MARGIN = C.MARGIN,
			AVLCOLL = C.AVLCOLL,
			SPANMAR = C.SPANMAR,
			VARMARGIN = C.VARMARGIN,
			TOTCASH = C.TOTCASH,
			TOTCOLLNONCASH = C.TOTNONCASH,      
			TOTNONCASH = C.TOTNONCASH,
			TOTCOLL = C.TOTCOLL,
			EFFCOLL = (
			CASE 
				WHEN C.LEDBALANCE + C.PAYREC + C.TOTCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN 
					CASE 
						WHEN (C.TOTNONCASH > C.LEDBALANCE + C.PAYREC + C.TOTCASH) THEN C.LEDBALANCE + C.TOTCASH      
						ELSE C.TOTNONCASH       
					END      
				ELSE      
					CASE 
						WHEN C.TOTNONCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100)
						ELSE C.TOTNONCASH       
					END       
			END) + C.TOTCASH,
			SPREADMARGIN = C.SPREADMARGIN, 
			NONSPREADMARGIN = C.NONSPREADMARGIN,
			MTOMMARGIN = C.MTOMMARGIN,
			EFFNONCASH = C.EFFNONCASH
			--REC_TYPE = 2
	FROM	#CL_LEDGER C
	WHERE	--(LEDBALANCE+PAYREC+MINLEDBAL+SPREADMARGIN+NONSPREADMARGIN+VARMARGIN+MARGIN+AVLCOLL+SPANMAR+TOTCASH+TOTNONCASH+TOTCOLL+MTOMMARGIN+EFFNONCASH) <> 0
			C.CLIENT_CODE = #CLIENTSUMMARY.CLIENT_CODE
			AND REC_TYPE = 1


	IF @RPT_TYPE = 0
	BEGIN
		SELECT	CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE,
				NET_BILL_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES),2)),
				NET_SETT_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES) ELSE 0 END),2)),
				NET_REC_PAYABLE = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES-ISNULL(NONSPREADMARGIN,0)) ELSE 0 END)
									+ SUM(ISNULL(AVLCOLL,0)+ISNULL(SPANMAR,0)+ISNULL(VARMARGIN,0)),2))
		FROM	#CLIENTSUMMARY
		GROUP BY
				CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE
		ORDER BY
				CLIENT_CODE		
		RETURN		
	END
	

	IF @NETPOS_FLAG = 1
	BEGIN
		INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,OPENPOSITION,PROFITORLOSS,REC_TYPE)
		SELECT
			CLIENT_CODE=PARTY_CODE,
			INST_TYPE, SYMBOL, 
			EXPIRYDATE = LEFT(EXPIRYDATE,11), 
			STRIKE_PRICE, 
			OPTION_TYPE, 
			OPENPOSITION = SUM(PQTY-SQTY),
			PROFITORLOSS = SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),
			REC_TYPE = 2
		FROM
			#FOBILLVALAN (NOLOCK)
		GROUP BY
			PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
		HAVING SUM(PQTY-SQTY) <> 0
	END
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,SYMBOL,S_SPANMARGIN,S_PREMIUM,S_ADDMARGINPERC,S_TOTALMARGIN,E_MARGINPERC,E_MARGINAMT,REC_TYPE)
	SELECT
		CLIENT_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
		--PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
		SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
		S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
		S_PREMIUM = ISNULL(S_PREMIUM,0),
		S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
		S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
		E_MARGINPERC = ISNULL(E_MARGINPERC,0),
		E_MARGINAMT = ISNULL(E_MARGINAMT,0),
		REC_TYPE = 3
	FROM 
		(
		SELECT
			S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
			--S_PARTYNAME = LONG_NAME,
			S_SYMBOL = REPLACE(FOMARGIN_SPAN.SYMBOL,'&AMP;','&'),
			S_SPANMARGIN = SPANMARGIN,
			S_PREMIUM = PREMIUM,
			S_ADDMARGINPERC = PMARGINRATE,
			S_TOTALMARGIN = TOTALMARGIN
		FROM
			FOMARGIN_SPAN (NOLOCK) 
		WHERE
			MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_SPAN.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND FOMARGIN_SPAN.CL_TYPE ='CL'
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_SPAN.PARTY_CODE)
		) FOMRG

	FULL OUTER JOIN 
		(
		SELECT
			E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
			--E_PARTYNAME = LONG_NAME,
			E_SYMBOL = SYMBOL,
			E_MARGINPERC = MARGIN_PERC,
			E_MARGINAMT = MARGINAMT
		FROM
			FOMARGIN_EXP_DETAILS (NOLOCK)
		WHERE
			SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_EXP_DETAILS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE)
		) EXPMRG
		ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
	ORDER BY 1,3
	
	SELECT * FROM #CLIENTSUMMARY
	ORDER BY CLIENT_CODE, REC_TYPE
	
	DROP TABLE #FOBILLVALAN
	DROP TABLE #CLIENTSUMMARY
	DROP TABLE #CL_LEDGER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWM2M
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWM2M]
	(
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@DISPDIFFONLY VARCHAR(10),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@M2MTYPE VARCHAR(50),
	@M2MFOR VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
	)

	AS
/*
EXEC CLS_RPT_PROC_FO_NEWM2M 'M2MREPORT','BROKER','BROKER','PARTY','PARTY','','','DEC  1 2014','DEC  1 2014','CLIENT','0','ZZZ','','','DIFF','','',-1,'','','','','PRICE','MKTRATE','','','ALL','PARTY','','','','','','','',''  
exec cls_rpt_proc_fo_newm2m 'M2MREPORT','BROKER','Broker','PARTY','PARTY','','','01/12/2014','01/12/2014','CLIENT','0','zz','','','DIFF','','',-1.0000,'','','','','PRICE','MKTRATE','','','ALL','PARTY','','','','','','','',''

*/
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
		BEGIN
			SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
		END
	IF LEN(@TODATE) = 10 AND CHARINDEX('/', @TODATE) > 0
		BEGIN
			SET @TODATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TODATE, 103), 109)
		END

	DECLARE @MEMBERCODE VARCHAR(15)
	DECLARE @NROUND INT
	SET		@NROUND = 2
	
	SELECT @MEMBERCODE = MEMBERCODE FROM FOOWNER (NOLOCK)
	
	IF @TOCODE='' SET @TOCODE = 'zzzzzzzzzz'
	
	CREATE TABLE #MTOM
		(	
		CLIENT_CODE		VARCHAR(20),
		CLIENT_NAME		VARCHAR(100),
		INST_TYPE		VARCHAR(7),
		SYMBOL			VARCHAR(30),
		EXPIRY_DATE		VARCHAR(11),
		OPTION_TYPE		VARCHAR(5),
		STRIKE_PRICE	VARCHAR(30),	
		EMAIL			VARCHAR(100),
		SAUDA_DATE		VARCHAR(11),		
		EXCH_EXER		NUMERIC(18,4),
		EXCH_PRE		NUMERIC(18,4),
		EXCH_M2M		NUMERIC(18,4),
		BO_EXER			NUMERIC(18,4),
		BO_PRE			NUMERIC(18,4),
		BO_M2M			NUMERIC(18,4),
		DIFF_EXE		NUMERIC(18,4),
		DIFF_PREM		NUMERIC(18,4),
		DIFF_M2M		NUMERIC(18,4)
		)

	IF @M2MFOR = 'SCRIP'
	BEGIN		
		INSERT INTO #MTOM (INST_TYPE,SYMBOL,EXPIRY_DATE,OPTION_TYPE,STRIKE_PRICE,EMAIL,SAUDA_DATE,EXCH_EXER,EXCH_PRE,EXCH_M2M,BO_EXER,BO_PRE,BO_M2M,DIFF_EXE,DIFF_PREM,DIFF_M2M)
		SELECT 
			INST_TYPE,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE = CONVERT(VARCHAR,STRIKE_PRICE),	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE,
			M_EXE,
			M_PREM,
			M_DAILY,
			F_EXE,
			F_PREM,
			F_DAILY,
			DIFF_EXE,
			DIFF_PREM,
			DIFF_DAILY
		FROM
			(
			SELECT
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (LEFT(INST_TYPE,3) = 'FUT') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN (NOLOCK)
				WHERE	
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					LEFT(INST_TYPE,3) = (
					CASE 
						WHEN @M2MTYPE = 'M2M' THEN 'FUT' 
						ELSE (CASE 
									WHEN @M2MTYPE = 'ALL' THEN LEFT(INST_TYPE,3)
									ELSE 'OPT' 
								END)
						END) AND
					AUCTIONPART = (
						CASE 
							WHEN @M2MTYPE = 'EXE' THEN 'EA' 
							ELSE AUCTIONPART
						END)
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND LEFT(FOEA_INST_TYPE,3) = (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN LEFT(FOEA_INST_TYPE,3)
								ELSE 'OPT' 
							   END )
					            END ) 
				GROUP BY 
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		ORDER BY 
			INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,STRIKE_PRICE

	END	/*IF @M2MFOR = 'SCRIP'*/
	IF @M2MFOR = 'PARTY'
	BEGIN
		INSERT INTO #MTOM (CLIENT_CODE,CLIENT_NAME,EMAIL,SAUDA_DATE,EXCH_EXER,EXCH_PRE,EXCH_M2M,BO_EXER,BO_PRE,BO_M2M,DIFF_EXE,DIFF_PREM,DIFF_M2M)
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE
				) FOEA
				
				ON ( FOEA_PARTY_CODE = PARTY_CODE )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME

	END	/*IF @M2MFOR = 'PARTY'*/
	IF @M2MFOR = 'BOTH'
	BEGIN
		INSERT INTO #MTOM (CLIENT_CODE,CLIENT_NAME,INST_TYPE,SYMBOL,EXPIRY_DATE,OPTION_TYPE,STRIKE_PRICE,EMAIL,SAUDA_DATE,EXCH_EXER,EXCH_PRE,EXCH_M2M,BO_EXER,BO_PRE,BO_M2M,DIFF_EXE,DIFF_PREM,DIFF_M2M)
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE = CONVERT(VARCHAR,STRIKE_PRICE),	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME,
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_PARTY_CODE = PARTY_CODE AND 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0		
		ORDER BY 
			PARTY_CODE,PARTY_NAME,INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,STRIKE_PRICE

	END
	
	ALTER TABLE #MTOM
	ADD ORDFLAG INT
	
	UPDATE	#MTOM SET ORDFLAG = 0
	
	IF (SELECT COUNT(1) FROM #MTOM) > 0
	BEGIN
	INSERT INTO #MTOM
	SELECT	CLIENT_CODE = '',
			CLIENT_NAME = '',
			INST_TYPE = '',
			SYMBOL = '',
			EXPIRY_DATE = '',
			OPTION_TYPE = '',
			STRIKE_PRICE = '',	
			EMAIL  = '',
			SAUDA_DATE  = '',
			EXCH_EXER = SUM(EXCH_EXER),
			EXCH_PRE = SUM(EXCH_PRE),
			EXCH_M2M = SUM(EXCH_M2M),
			BO_EXER = SUM(BO_EXER),
			BO_PRE = SUM(BO_PRE),
			BO_M2M = SUM(BO_M2M),
			DIFF_EXE = SUM(DIFF_EXE),
			DIFF_PREM = SUM(DIFF_PREM),
			DIFF_M2M = SUM(DIFF_M2M),
			ORDFLAG = 1
	FROM	#MTOM
	END

	IF (@M2MFOR = 'SCRIP')
	BEGIN
		UPDATE	#MTOM SET SYMBOL = 'TOTAL' WHERE ORDFLAG = 1
	END
	ELSE
	BEGIN
		UPDATE	#MTOM SET CLIENT_CODE = 'TOTAL' WHERE ORDFLAG = 1
	END

	DECLARE @SQLSELECT	VARCHAR(MAX)
	DECLARE @SQL		VARCHAR(MAX)
	SET		@SQLSELECT = ""
	SET		@SQL = ""		
	
	IF (@M2MTYPE = 'ALL')
	BEGIN
		SET	@SQLSELECT = "SELECT "
		IF (@M2MFOR = 'PARTY')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'SCRIP')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'BOTH')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		SET	@SQLSELECT = @SQLSELECT + "EXCH_EXER = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_EXER,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_EXER = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_EXER,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_EXE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_EXE,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "EXCH_PRE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_PRE,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_PRE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_PRE,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_PREM = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_PREM,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "EXCH_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_M2M,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_M2M,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_M2M,"+CONVERT(VARCHAR,@NROUND)+")) "		
	END	
	ELSE IF (@M2MTYPE = 'M2M')
	BEGIN
		SET	@SQLSELECT = "SELECT "
		IF (@M2MFOR = 'PARTY')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'SCRIP')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'BOTH')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		SET	@SQLSELECT = @SQLSELECT + "EXCH_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_M2M,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_M2M,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_M2M = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_M2M,"+CONVERT(VARCHAR,@NROUND)+")) "		
	END	
	ELSE IF (@M2MTYPE = 'PRE')
	BEGIN
		SET	@SQLSELECT = "SELECT "
		IF (@M2MFOR = 'PARTY')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'SCRIP')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'BOTH')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		SET	@SQLSELECT = @SQLSELECT + "EXCH_PRE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_PRE,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_PRE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_PRE,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_PREM = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_PREM,"+CONVERT(VARCHAR,@NROUND)+")) "		
	END
	ELSE IF (@M2MTYPE = 'EXE')
	BEGIN
		SET	@SQLSELECT = "SELECT "
		IF (@M2MFOR = 'PARTY')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'SCRIP')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		IF (@M2MFOR = 'BOTH')
		BEGIN
			SET	@SQLSELECT = @SQLSELECT + "CLIENT_CODE,CLIENT_NAME,SYMBOL,INST_TYPE,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE, "
		END
		SET	@SQLSELECT = @SQLSELECT + "EXCH_EXER = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(EXCH_EXER,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "BO_EXER = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(BO_EXER,"+CONVERT(VARCHAR,@NROUND)+")), "
		SET	@SQLSELECT = @SQLSELECT + "DIFF_EXE = CONVERT(NUMERIC(18,"+CONVERT(VARCHAR,@NROUND)+"),ROUND(DIFF_EXE,"+CONVERT(VARCHAR,@NROUND)+")) "
	END
	
	EXEC (@SQLSELECT + " FROM #MTOM ORDER BY ORDFLAG, 1, 2, 3")
	
	DROP TABLE #MTOM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWNETPOSITION
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWNETPOSITION] 
	(
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT    
	@GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS    
	@ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	@ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20), --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES    
	@TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20), --]    
	@OPTIONTYPE VARCHAR(20), --]    
	@STRIKEPRICE MONEY, --]--> PRIMARY SEARCH FIELDS.    
	@EXPIRYDATE VARCHAR(11), --]    
	@SYMBOL VARCHAR(20), --]    
	--REPORT SPECIFIC SEARCH FEILDS    
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
	@EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]    
	@EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]    
	@EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
	@EX_RATE VARCHAR(20), --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
	@EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]    
	@EX_POSITION VARCHAR(1), --(LONG/SHORT) - IN THE MONEY     ]    
	@CMCLOSING VARCHAR(2), --(LONG/SHORT) - IN THE MONEY     ]    
	--END REPORT SPECIFIC SEARCH FEILDS    
	@DUMMY001 VARCHAR(50)='', ---@POSITIONAS VARCHAR(50),  --ACTUAL/LOT  
	@DUMMY002 VARCHAR(50)='',    
	@DUMMY003 VARCHAR(50)='',    
	@DUMMY004 VARCHAR(50)='',    
	@DUMMY005 VARCHAR(50)='',    
	@DUMMY006 VARCHAR(50)='',    
	@DUMMY007 VARCHAR(50)='',    
	@DUMMY008 VARCHAR(50)='',    
	@DUMMY009 VARCHAR(50)='',    
	@DUMMY010 VARCHAR(1)='',
	@DUMMY011 VARCHAR(1)= ''
	)

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DECLARE @STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1),
	@POSITIONAS VARCHAR(50)

SET @POSITIONAS = @DUMMY001
SET @INSTTYPE = @INSTTYPE + "%"

IF @OPTIONTYPE = ''
BEGIN
	SET @OPTIONTYPE = "%"
END

--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE    
IF @EXPIRYDATE = ''
BEGIN
	SET @EXPIRYDATE = "%"
END

IF @SYMBOL = ''
BEGIN
	SET @SYMBOL = "%"
END

IF @EX_AUCTIONPART = ''
BEGIN
	SET @EX_AUCTIONPART = "%"
END

IF @EX_REPORTBY = ''
BEGIN
	SET @EX_REPORTBY = "%"
END

IF @EX_RATE = ''
BEGIN
	SET @EX_RATE = "%"
END

SET @STRSELECT = ''
SET @STRSELECTTEMP = ''
SET @STRFROM = ''
SET @STRWHERE = ''
SET @STRGROUPBY = ''
SET @STRORDERBY = ''
SET @STRCOMPUTE = ''
SET @STRCOMPUTE = ''
SET @STRCOMPUTESUB = ''
SET @ISSUBLEVEL = 'NO'

IF LEN(@FROMDATE) = 10 AND CHARINDEX('/',@FROMDATE) > 0    
SET @FROMDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @FROMDATE,103),109)

IF LEN(@TODATE) = 10 AND CHARINDEX('/',@TODATE) > 0
SET @TODATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @TODATE,103),109) 

IF LEN(@EXPIRYDATE) = 10 AND CHARINDEX('/',@EXPIRYDATE) > 0
SET @EXPIRYDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @EXPIRYDATE,103),109) 

IF (@FROMDATE = '' AND @TODATE = '')
BEGIN
	SELECT	@FROMDATE = LEFT(CONVERT(VARCHAR, MAX(SAUDA_DATE), 109), 11),
			@TODATE = LEFT(CONVERT(VARCHAR, MAX(SAUDA_DATE), 109), 11)
	FROM	FOBILLVALAN
END
ELSE
BEGIN
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR, MAX(SAUDA_DATE), 109), 11)
	FROM FOBILLVALAN(NOLOCK)
	WHERE SAUDA_DATE <= @FROMDATE + ' 23:59'
END

IF (@REPORTNAME = 'NETPOSITION')
BEGIN
	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
	BEGIN
		SET @CODEID = 'PARTY_CODE'
	END

	IF (@WHATCODE = 'REGION')
	BEGIN
		SET @CODEID = 'REGION'
	END

	IF (@WHATCODE = 'AREA')
	BEGIN
		SET @CODEID = 'AREA'
	END

	IF (@WHATCODE = 'BRANCH')
	BEGIN
		SET @CODEID = 'BRANCH_CODE'
	END

	IF (@WHATCODE = 'SUBBROKER')
	BEGIN
		SET @CODEID = 'SUB_BROKER'
	END

	IF (@WHATCODE = 'TRADER')
	BEGIN
		SET @CODEID = 'TRADER'
	END

	IF (@WHATCODE = 'FAMILY')
	BEGIN
		SET @CODEID = 'FAMILY'
	END

	IF @CMCLOSING <> ''
	BEGIN
		SET @STRSELECT = @STRSELECT + "SELECT CMCLOSING, "
	END
	ELSE
	BEGIN
		SET @STRSELECT = @STRSELECT + "SELECT "
	END

	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "

	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
	BEGIN
		SET @STRSELECTTEMP = ''

		IF (@GROUPLEVEL = 'PARTY')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				--SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL,"
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO), "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@ISSUBLEVEL = 'YES')
			BEGIN
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
			END
		END

		IF (@GROUPLEVEL = 'SCRIP')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO),"

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				--SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@ISSUBLEVEL = 'YES')
			BEGIN
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
			END
		END

		IF (@GROUPLEVEL = 'DATE')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO),"
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@ISSUBLEVEL = 'YES')
			BEGIN
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "
			END
		END

		IF (@GROUPLEVEL = 'INSTTYPE')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL,  CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END

			IF (@ISSUBLEVEL = 'YES')
			BEGIN
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "
			END
		END

		IF (@GROUPLEVEL = 'PSD')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, BILLNO=MAX(BILLNO),"
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,CONVERT(DATETIME,'" + @FROMDATE + "',103),103) AS SAUDA_DATE, "
			SET @ISSUBLEVEL = 'YES'
		END

		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		SET @STRSELECTTEMP = ''
	END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
	ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
	BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		IF (@WHATCODE = 'CLIENT')
		BEGIN
			SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) CLIENT_TYPE, MAX(EMAIL) EMAIL, "
		END

		IF (@WHATCODE = 'AREA')
		BEGIN
			SET @STRSELECT = @STRSELECT + " AREA, "
		END

		IF (@WHATCODE = 'REGION')
		BEGIN
			SET @STRSELECT = @STRSELECT + " REGION, "
		END

		IF (@WHATCODE = 'BRANCH')
		BEGIN
			SET @STRSELECT = @STRSELECT + " BRANCH_CODE, "
		END

		IF (@WHATCODE = 'SUBBROKER')
		BEGIN
			SET @STRSELECT = @STRSELECT + " SUB_BROKER, "
		END

		IF (@WHATCODE = 'TRADER')
		BEGIN
			SET @STRSELECT = @STRSELECT + " TRADER, "
		END

		IF (@WHATCODE = 'FAMILY')
		BEGIN
			SET @STRSELECT = @STRSELECT + " FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, "
		END
	END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/

	--PQTY    
	SET @STRSELECTTEMP = ''

	IF @POSITIONAS = 'ACTUAL'
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
	END
	ELSE
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) "
	END

	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ " --FOR THE SUB TOTAL    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--SQTY    
	SET @STRSELECTTEMP = ''

	IF @POSITIONAS = 'ACTUAL'
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
	END
	ELSE
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END) "
	END

	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ " --FOR THE SUB TOTAL    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

	--EX_REPORTBY IS ALYAYS 'PRICE' FOR THIS REPORT, SO THE CODE BLOCS FOR 'IF (@EX_REPORTBY = 'PRICE')' AND    
	IF (@EX_REPORTBY = 'STRIKE')
	BEGIN
		--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NETQTY - FOR THE NET POS REPORT    
		SET @STRSELECTTEMP = ''

		IF @POSITIONAS = 'ACTUAL'
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "
		END
		ELSE
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "
		END

		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NET VALUE- FOR THE NET POS REPORT    
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) - "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--AVG. PRICE - FOR THE NET POS REPORT    
		SET @STRSELECTTEMP = ''

		IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*) ELSE 0 END "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE) ELSE 0 END END)) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE) ELSE 0 END "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE) ELSE 0 END END)) ) /  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "
		END
		ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END

		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	END

	IF (@EX_RATE = 'MKTRATE')
	BEGIN
		--IF (@EX_REPORTBY = 'BOTH') ARE OMITED    
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF @POSITIONAS = 'ACTUAL'
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY ELSE 0 END))/ "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END

		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR ELSE 0 END) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF @POSITIONAS = 'ACTUAL'
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY ELSE 0 END))/ "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END /*IF (@EX_RATE = 'NETRATE')*/

	/*EX_RATE IS ALYAYS 'NETRATE' IN THIS REPORT, SO THE CODE BLOC FOR 'IF (@EX_RATE = 'NETRATE') IS OMITTED*/
	IF (@EX_RATE = 'NETRATE')
	BEGIN
		--IF (@EX_REPORTBY = 'BOTH') ARE OMITED    
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF @POSITIONAS = 'ACTUAL'
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE- FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT *DENOMINATOR/NUMERATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT *DENOMINATOR/NUMERATOR ELSE 0 END))/ "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END

		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT ELSE 0 END) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT ELSE 0 END) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF @POSITIONAS = 'ACTUAL'
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN  CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN  CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT    
			SET @STRSELECTTEMP = ''

			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY)+PAMT *DENOMINATOR/NUMERATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY)+SAMT *DENOMINATOR/NUMERATORELSE 0 END))/ "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END /*IF (@EX_RATE = 'NETRATE')*/

	--NET OPEN VALUE (CL. PRICE)    
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN (PQTY - SQTY) ELSE 0 END)*(CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN CL_RATE * NUMERATOR / DENOMINATOR ELSE 0 END))  "
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET OPEN VALUE (CL. PRICE) */ " --FOR THE SUB TOTAL    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETOPENVALUE, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--CL. PRICE    
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + "  (CASE WHEN SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN PQTY+SQTY ELSE 0 END)) <> 0 THEN ABS(SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN (PQTY + SQTY) ELSE 0 END)*(CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN CL_RATE ELSE 0 END)) / SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN PQTY + SQTY ELSE 0 END))) ELSE 0 END )"
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CL. PRICE */ " --FOR THE SUB TOTAL    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEPRICE "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	SET @STRSELECTTEMP = ""
	SET @STRFROM = @STRFROM + " INTO #FONETPOSITION "
	SET @STRFROM = @STRFROM + " FROM "
	SET @STRFROM = @STRFROM + " FOBILLVALAN (NOLOCK) "
	SET @STRWHERE = @STRWHERE + "WHERE "
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "

	IF (@STRIKEPRICE > - 1)
	BEGIN
		SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR, @STRIKEPRICE) + " AND "
	END

	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
	SET @STRWHERE = @STRWHERE + "EXPIRYDATE >= '" + @TODATE + "' AND "
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "

	IF (@FROMCODE = '' AND @TOCODE = '')
	BEGIN
		--SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') LIKE '%' AND "
		SET @STRWHERE = @STRWHERE + " "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') >= '" + @FROMCODE + "' AND "
		SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') <= '" + @TOCODE + "' AND "
	END

	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN
		--SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		SET @STRWHERE = @STRWHERE + " "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
	END

	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
	BEGIN
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
	END

	/*LOGIN CONDITIONS*/
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID + "' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "
	/*END - LOGIN CONDITIONS*/
	SET @COMMA = ''
	SET @STRGROUPBY = @STRGROUPBY + @COMMA

	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
	BEGIN
		IF (@GROUPLEVEL = 'PARTY')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "
			SET @COMMA = ', '

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE "
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE "
			END
		END

		IF (@GROUPLEVEL = 'SCRIP')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
			SET @COMMA = ', '

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE "
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE "
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY
			END
		END

		IF (@GROUPLEVEL = 'DATE')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "
			SET @COMMA = ', '

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE "
			END

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
			END

			IF (@GROUPSUBLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE "
			END
		END

		IF (@GROUPLEVEL = 'INSTTYPE')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "
			SET @COMMA = ', '

			IF (@GROUPSUBLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE "
			END

			IF (@GROUPSUBLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
			END

			IF (@GROUPSUBLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE "
			END
		END

		IF (@GROUPLEVEL = 'PSD')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE,  SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE "
				--    SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "    
		END
	END /*IF (@ONEORMANY = 'DETAIL')*/
	ELSE /*IF (@ONEORMANY = 'DETAIL')*/
	BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "
		END

		IF (@WHATCODE = 'AREA')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " AREA "
		END

		IF (@WHATCODE = 'REGION')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " REGION "
		END

		IF (@WHATCODE = 'BRANCH')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " BRANCH_CODE "
		END

		IF (@WHATCODE = 'SUBBROKER')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " SUB_BROKER "
		END

		IF (@WHATCODE = 'TRADER')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " TRADER "
		END

		IF (@WHATCODE = 'FAMILY')
		BEGIN
			SET @STRGROUPBY = @STRGROUPBY + " FAMILY "
		END
	END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/

	SET @STRORDERBY = @STRGROUPBY

	IF @CMCLOSING <> ''
	BEGIN
		SET @STRGROUPBY = @STRGROUPBY + ",CMCLOSING "
	END

	IF @STRGROUPBY = ''
	BEGIN
		SET @STRGROUPBY = " HAVING (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) <> 0 "
	END
	ELSE
	BEGIN
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) <> 0 "
	END

	SET @STRORDERBY = "ORDER BY " + @STRORDERBY
END /*IF (@REPORTNAME = "NETPOSITION")*/

IF @STRCOMPUTESUB <> ''
BEGIN
	SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB
	SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
END

IF LTRIM(RTRIM(@STRORDERBY)) = 'ORDER BY'
BEGIN
	SET @STRORDERBY = @STRORDERBY + " 1 "
END

IF LTRIM(RTRIM(@STRGROUPBY)) = 'GROUP BY'
BEGIN
	SET @STRGROUPBY = ''
END

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	DECLARE @SELECT VARCHAR(MAX)
	DECLARE @SELECT1 VARCHAR(MAX)
	DECLARE @SELECT_G VARCHAR(MAX)
	DECLARE @GROUPBY1 VARCHAR(MAX)
	DECLARE @ORDFLAG VARCHAR(MAX)
	DECLARE @ORDFLAG1 VARCHAR(MAX)

	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY
	END
	ELSE
	BEGIN
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY
	END

	SET @SELECT = ""
	SET @SELECT1 = ""
	SET @GROUPBY1 = ""
	SET @SELECT_G = ""
	SET @ORDFLAG = ""
	SET @ORDFLAG1 = ""
	
	--SET @STRSQL = "SELECT "

	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))    
	BEGIN    
		IF (@GROUPLEVEL = 'PARTY')  
		BEGIN    
			SET @STRSQL = @STRSQL + "SELECT CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"
			SET @SELECT = @SELECT + "CLIENT_CODE,CLIENT_NAME,CL_TYPE,"
			SET @SELECT1 = @SELECT1 + "CLIENT_CODE='',CLIENT_NAME='',CL_TYPE='',"
			SET @GROUPBY1 = @GROUPBY1 + "CLIENT_CODE"
			SET @SELECT_G = @SELECT_G + "CLIENT_CODE='',CLIENT_NAME='',CL_TYPE='',"
			IF (@GROUPSUBLEVEL = 'SCRIP')    
			BEGIN    
				SET @STRSQL = @STRSQL + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,LOT_SIZE=BILLNO,"
				SET @SELECT = @SELECT + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,LOT_SIZE,"
				SET @SELECT1 = @SELECT1 + "SYMBOL='',INST_TYPE='',EXPIRYDATE='',STRIKE_PRICE='',OPTION_TYPE='',LOT_SIZE=0,"
				SET @SELECT_G = @SELECT_G + "SYMBOL='',INST_TYPE='',EXPIRYDATE='',STRIKE_PRICE='',OPTION_TYPE='',LOT_SIZE=0,"
			END
			SET @ORDFLAG = "PARTY_CODE"
			SET @ORDFLAG1 = "CLIENT_CODE"
		END    
		IF (@GROUPLEVEL = 'SCRIP')    
		BEGIN    
			SET @STRSQL = @STRSQL + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,LOT_SIZE=BILLNO,"
			SET @SELECT = @SELECT + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,LOT_SIZE,"
			SET @SELECT1 = @SELECT1 + "SYMBOL='',INST_TYPE='',EXPIRYDATE='',STRIKE_PRICE='',OPTION_TYPE='',LOT_SIZE=0,"
			SET @GROUPBY1 = @GROUPBY1 + "SYMBOL='',INST_TYPE='',EXPIRYDATE='',STRIKE_PRICE='',OPTION_TYPE='',LOT_SIZE=0,"
			SET @SELECT_G = @SELECT_G + "SYMBOL='',INST_TYPE='',EXPIRYDATE='',STRIKE_PRICE='',OPTION_TYPE='',LOT_SIZE=0,"
			IF (@GROUPSUBLEVEL = 'PARTY')    
			BEGIN    
				SET @STRSQL = @STRSQL + "CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"
				SET @SELECT = @SELECT + "CLIENT_CODE,CLIENT_NAME,CL_TYPE,"
				SET @SELECT1 = @SELECT1 + "CLIENT_CODE='',CLIENT_NAME='',CL_TYPE='',"
				SET @SELECT_G = @SELECT_G + "CLIENT_CODE='',CLIENT_NAME='',CL_TYPE='',"
			END
			SET @ORDFLAG = "SYMBOL"
			SET @ORDFLAG1 = @ORDFLAG
		END    
	END 
	ELSE
	BEGIN 
		SET @ORDFLAG = @WHATCODE
		IF (@WHATCODE = 'CLIENT')		
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE," 
			SET @SELECT = @SELECT + "CLIENT_CODE,CLIENT_NAME,CL_TYPE," 
			SET @SELECT1 = @SELECT1 + "CLIENT_CODE='',CLIENT_NAME='',CL_TYPE='',"
			SET @ORDFLAG = "PARTY_CODE"
			SET @ORDFLAG1 = "CLIENT_CODE"
		END
		IF (@WHATCODE = 'AREA')			
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT AREA," 
			SET @SELECT = @SELECT + "AREA,"
			SET @SELECT1 = @SELECT1 + "AREA='',"
		END    
		IF (@WHATCODE = 'REGION')		
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT REGION," 
			SET @SELECT = @SELECT + "REGION,"
			SET @SELECT1 = @SELECT1 + "REGION='',"
		END    
		IF (@WHATCODE = 'BRANCH')		
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT BRANCH_CODE," 
			SET @SELECT = @SELECT + "BRANCH_CODE,"
			SET @SELECT1 = @SELECT1 + "BRANCH_CODE='',"
			SET @ORDFLAG = "BRANCH_CODE"
			SET @ORDFLAG1 = @ORDFLAG
		END
		IF (@WHATCODE = 'SUBBROKER')	
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT SUB_BROKER," 
			SET @SELECT = @SELECT + "SUB_BROKER,"
			SET @SELECT1 = @SELECT1 + "SUB_BROKER='',"
			SET @ORDFLAG = "SUB_BROKER"
			SET @ORDFLAG1 = @ORDFLAG
		END    
		IF (@WHATCODE = 'TRADER')		
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT TRADER," 
			SET @SELECT = @SELECT + "TRADER,"
			SET @SELECT1 = @SELECT1 + "TRADER='',"
		END    
		IF (@WHATCODE = 'FAMILY')		
		BEGIN 
			SET @STRSQL = @STRSQL + " SELECT FAMILY,FAMILY_NAME=FAMILYNAME," 
			SET @SELECT = @SELECT + "FAMILY,FAMILY_NAME,"
			SET @SELECT1 = @SELECT1 + "FAMILY='',FAMILY_NAME='',"
			SET @ORDFLAG = "FAMILY"
			SET @ORDFLAG1 = @ORDFLAG
		END
		SET @SELECT_G = @SELECT1
	END 

	SET @STRSQL = @STRSQL + " BUY_QTY=PQTY,"
	SET @STRSQL = @STRSQL + " BUY_VALUE=CONVERT(NUMERIC(18,2),ROUND(PAMT,2)),"
	SET @STRSQL = @STRSQL + " SELL_QTY=SQTY,"
	SET @STRSQL = @STRSQL + " SELL_VALUE=CONVERT(NUMERIC(18,2),ROUND(SAMT,2)),"
	SET @STRSQL = @STRSQL + " NET_QTY=NETQTY,"
	SET @STRSQL = @STRSQL + " NET_VALUE=CONVERT(NUMERIC(18,2),ROUND(NETVALUE,2)),"
	SET @STRSQL = @STRSQL + " AVG_PRICE=CONVERT(NUMERIC(18,2),ROUND(AVGPRICE,2)),"
	SET @STRSQL = @STRSQL + " NET_CL_VALUE=CONVERT(NUMERIC(18,2),ROUND(NETOPENVALUE,2)),"
	SET @STRSQL = @STRSQL + " CL_PRICE=CONVERT(NUMERIC(18,2),ROUND(CLOSEPRICE,2)),"
	SET @STRSQL = @STRSQL + " ORDFLAG=1,TOTAL_FLAG=CONVERT(VARCHAR(15),''),ORDFIELD="+@ORDFLAG
	SET @STRSQL = @STRSQL + " INTO #FONETPOSITION_NEW "
	SET @STRSQL = @STRSQL + " FROM #FONETPOSITION "
	SET @STRSQL = @STRSQL + " DROP TABLE #FONETPOSITION "

	IF (@GROUPLEVEL = "SCRIP" OR @GROUPSUBLEVEL = 'SCRIP')
	BEGIN
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN INST_TYPE VARCHAR(6)  NULL " 
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN SYMBOL VARCHAR(12) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN OPTION_TYPE VARCHAR(2)  NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN STRIKE_PRICE MONEY  NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN LOT_SIZE INT  NULL "
	END
	IF ((@GROUPLEVEL = "PARTY" OR @GROUPSUBLEVEL = 'PARTY') AND @WHATCODE = 'CLIENT')
	BEGIN      
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN CLIENT_CODE VARCHAR(20) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN CLIENT_NAME VARCHAR(100) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN CL_TYPE VARCHAR(5) NULL "
	END  
	
	SET @STRSQL = @STRSQL + " IF (SELECT COUNT(1) FROM #FONETPOSITION_NEW) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " ALTER TABLE #FONETPOSITION_NEW ALTER COLUMN "+@ORDFLAG1+" VARCHAR(30) "
	SET @STRSQL = @STRSQL + " INSERT INTO #FONETPOSITION_NEW ("+ @ORDFLAG1 +",BUY_QTY,BUY_VALUE,SELL_QTY,SELL_VALUE,NET_QTY,NET_VALUE,AVG_PRICE,NET_CL_VALUE,CL_PRICE,ORDFLAG,TOTAL_FLAG,ORDFIELD) "
	SET @STRSQL = @STRSQL + " SELECT 'SUB TOTAL',"
	SET @STRSQL = @STRSQL + " BUY_QTY=SUM(BUY_QTY),"
	SET @STRSQL = @STRSQL + " BUY_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(BUY_VALUE),2)),"
	SET @STRSQL = @STRSQL + " SELL_QTY=SUM(SELL_QTY),"
	SET @STRSQL = @STRSQL + " SELL_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(SELL_VALUE),2)),"
	SET @STRSQL = @STRSQL + " NET_QTY=SUM(NET_QTY),"
	SET @STRSQL = @STRSQL + " NET_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(NET_VALUE),2)),"
	SET @STRSQL = @STRSQL + " AVG_PRICE=CONVERT(NUMERIC(18,2),ROUND(SUM(0),2)),"
	SET @STRSQL = @STRSQL + " NET_CL_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(NET_CL_VALUE),2)),"
	SET @STRSQL = @STRSQL + " CL_PRICE=CONVERT(NUMERIC(18,2),ROUND(SUM(0),2)),"
	SET @STRSQL = @STRSQL + " ORDFLAG=2,TOTAL_FLAG='SUB TOTAL',ORDFIELD=MAX("+@ORDFLAG1+")"
	SET @STRSQL = @STRSQL + " FROM #FONETPOSITION_NEW WHERE ORDFLAG = 1 "
	IF (@GROUPLEVEL <> @GROUPSUBLEVEL)
	BEGIN
		SET @STRSQL = @STRSQL + " GROUP BY "+ @ORDFLAG1
	END

	SET @STRSQL = @STRSQL + " INSERT INTO #FONETPOSITION_NEW ("+ @ORDFLAG1 +",BUY_QTY,BUY_VALUE,SELL_QTY,SELL_VALUE,NET_QTY,NET_VALUE,AVG_PRICE,NET_CL_VALUE,CL_PRICE,ORDFLAG,TOTAL_FLAG,ORDFIELD) "
	SET @STRSQL = @STRSQL + " SELECT 'GRAND TOTAL',"
	SET @STRSQL = @STRSQL + " BUY_QTY=SUM(BUY_QTY),"
	SET @STRSQL = @STRSQL + " BUY_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(BUY_VALUE),2)),"
	SET @STRSQL = @STRSQL + " SELL_QTY=SUM(SELL_QTY),"
	SET @STRSQL = @STRSQL + " SELL_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(SELL_VALUE),2)),"
	SET @STRSQL = @STRSQL + " NET_QTY=SUM(NET_QTY),"
	SET @STRSQL = @STRSQL + " NET_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(NET_VALUE),2)),"
	SET @STRSQL = @STRSQL + " AVG_PRICE=CONVERT(NUMERIC(18,2),ROUND(SUM(0),2)),"
	SET @STRSQL = @STRSQL + " NET_CL_VALUE=CONVERT(NUMERIC(18,2),ROUND(SUM(NET_CL_VALUE),2)),"
	SET @STRSQL = @STRSQL + " CL_PRICE=CONVERT(NUMERIC(18,2),ROUND(SUM(0),2)),"
	SET @STRSQL = @STRSQL + " ORDFLAG=3,TOTAL_FLAG='GRAND TOTAL',"
	SET @STRSQL = @STRSQL + " ORDFIELD=MAX("+@ORDFLAG1+")"
	SET @STRSQL = @STRSQL + " FROM #FONETPOSITION_NEW WHERE ORDFLAG = 1 "
	SET @STRSQL = @STRSQL + " END "
	
	SET @STRSQL = @STRSQL + " SELECT " + @SELECT
	SET @STRSQL = @STRSQL + " BUY_QTY,BUY_VALUE,SELL_QTY,SELL_VALUE,NET_QTY,NET_VALUE,AVG_PRICE,NET_CL_VALUE,CL_PRICE,TOTAL_FLAG "
	SET @STRSQL = @STRSQL + " FROM #FONETPOSITION_NEW "
	IF (LEN(@ORDFLAG1) > 0)
	BEGIN
		SET @STRSQL = @STRSQL + " ORDER BY ORDFIELD,ORDFLAG"
	END
	ELSE
	BEGIN
		SET @STRSQL = @STRSQL + " ORDER BY ORDFIELD,ORDFLAG "
	END

	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWREPORTS
-- --------------------------------------------------


CREATE   PROCEDURE [dbo].[CLS_RPT_PROC_FO_NEWREPORTS]
(
	 @REPORTNAME VARCHAR(50),      
	 @STATUSID VARCHAR(20),      
	 @STATUSNAME VARCHAR(50),      
	 @GROUPLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT      
	 @GROUPSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS      
	 @ORDERLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @ORDERSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @FROMDATE VARCHAR(11),      
	 @TODATE VARCHAR(11),      
	 @WHATCODE VARCHAR(20),  		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	 @FROMCODE VARCHAR(20),      
	 @TOCODE VARCHAR(20),      
	 @FROMPARTYCODE VARCHAR(20), 		--]--> FOR THE FROM AND TO PARTY CODES      
	 @TOPARTYCODE VARCHAR(20), 		--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	 @ONEORMANY VARCHAR(20),      
	 @INSTTYPE VARCHAR(20),  		--]      
	 @OPTIONTYPE VARCHAR(20), 		--]      
	 @STRIKEPRICE MONEY,  			--]--> PRIMARY SEARCH FIELDS.      
	 @EXPIRYDATE VARCHAR(11), 		--]      
	 @SYMBOL VARCHAR(20), 			 --]      
	 @EX_BILLTYPE VARCHAR(1), 		--(SINGLE/MULTIPLE) - BILL      ]      
	 @EX_AUCTIONPART VARCHAR(20), 		--SAUDASUMMARY       ]      
	 @EX_REPORTBY VARCHAR(20), 		--(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	 @EX_RATE VARCHAR(20), 			--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	 @EX_MONEYTYPE VARCHAR(1), 		--(IN/AT/OUT) - IN THE MONEY      ]      
	 @EX_POSITION VARCHAR (1), 		--(LONG/SHORT) - IN THE MONEY     ]      
	 --END REPORT SPECIFIC SEARCH FEILDS      
	 @DUMMY001 VARCHAR(50)='',      
	 @DUMMY002 VARCHAR(50)='',      
	 @DUMMY003 VARCHAR(50)='',      
	 @DUMMY004 VARCHAR(50)='',      
	 @DUMMY005 VARCHAR(50)='',      
	 @DUMMY006 VARCHAR(50)='',      
	 @DUMMY007 VARCHAR(50)='',      
	 @DUMMY008 VARCHAR(50)='',      
	 @DUMMY009 VARCHAR(50)='',      
	 @DUMMY010 VARCHAR(50)=''      
)
AS      

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE      
	@STRSELECT VARCHAR(8000),      
	@STRSELECTTEMP VARCHAR(8000),      
	@STRSELECTAVRGRT VARCHAR(8000),      
	@STRSELECTCLOSEQTY VARCHAR(8000),      
	@STRFROM VARCHAR(8000),      
	@STRWHERE VARCHAR(8000),      
	@STRGROUPBY VARCHAR(8000),      
	@STRORDERBY VARCHAR(8000),      
	@STRCOMPUTE VARCHAR(8000),      
	@STRCOMPUTESUB VARCHAR(8000),      
	@STRHAVING VARCHAR(2000),      
	@ISSUBLEVEL VARCHAR(3),      
	@CODEID VARCHAR(20),      
	@COMMA VARCHAR(1)      
	SET @INSTTYPE = @INSTTYPE
	SET @STRSELECT = ''      
	SET @STRSELECTTEMP = ''
	SET @STRSELECTAVRGRT = '' 
	SET @STRSELECTCLOSEQTY = ''     
	SET @STRFROM = ''      
	SET @STRWHERE = ''      
	SET @STRGROUPBY = ''      
	SET @STRORDERBY = ''      
	SET @STRCOMPUTE = ''      
	SET @STRCOMPUTESUB = ''      
	SET @ISSUBLEVEL = 'NO'      
	
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END     
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      

	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/',@FROMDATE) > 0    
	SET @FROMDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @FROMDATE,103),109)

	IF LEN(@TODATE) = 10 AND CHARINDEX('/',@TODATE) > 0
	SET @TODATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @TODATE,103),109) 

	IF LEN(@EXPIRYDATE) = 10 AND CHARINDEX('/',@EXPIRYDATE) > 0
	SET @EXPIRYDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @EXPIRYDATE,103),109) 

	IF @TODATE = ''
	BEGIN       
		SELECT @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK)
	END 
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,ISNULL(MIN(SAUDA_DATE),@FROMDATE),109),11) FROM FOBILLVALAN  (NOLOCK) WHERE SAUDA_DATE >=  @FROMDATE 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
	SET @STRSELECT = @STRSELECT + "SELECT "      
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YY = YEAR(SAUDA_DATE), MM = MONTH(SAUDA_DATE), DD = DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      	
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
			END      
		END      
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YY = YEAR(SAUDA_DATE), MM = MONTH(SAUDA_DATE), DD = DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,112), EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			END      
		END       
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YY = YEAR(SAUDA_DATE), MM = MONTH(SAUDA_DATE), DD = DAY(SAUDA_DATE), "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS  EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "      
			END      
		END             
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YY = YEAR(SAUDA_DATE), MM = MONTH(SAUDA_DATE), DD = DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
			END
		END       
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YY = YEAR(SAUDA_DATE), MM = MONTH(SAUDA_DATE), DD = DAY(SAUDA_DATE), "      
			SET @ISSUBLEVEL = 'YES'      
		END      
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		SET @STRSELECTTEMP = ''      
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END      
	END 
	--OPENQTY      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--PQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--SQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

	IF (@EX_RATE = 'MKTRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "    
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END 	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) )/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
	END 
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP         
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END  	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP     
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
	END

	--CLOSEQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''  

   
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END

	--PROFIT/LOSS      

	/*SET @STRSELECTTEMP = 'CONVERT (NUMERIC(36, 12),' 
	SET @STRSELECTTEMP = @STRSELECTTEMP + @STRSELECTAVRGRT + ')* CONVERT(INT,'+  @STRSELECTCLOSEQTY  + ') * MAX(NUMERATOR)/MAX(DENOMINATOR)'
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "  */    
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
	SET @STRSELECTTEMP = ''   
     

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  AND (@FROMDATE  = @TODATE )  
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),0 "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0 "       
	END      
	--SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0)  "       

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " , EXPIRYORD = CONVERT(VARCHAR,EXPIRYDATE,112) "       
	END

	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ""   

	SET @STRFROM = @STRFROM + " INTO #FOSAUDASUMMARY "
	SET @STRFROM = @STRFROM + " FROM "      
	SET @STRFROM = @STRFROM + " FOBILLVALAN (NOLOCK) "
	
	SET @STRWHERE = @STRWHERE + " WHERE "       
	IF (LEN(@INSTTYPE) > 3)
	BEGIN
		SET @STRWHERE = @STRWHERE + "INST_TYPE = (CASE WHEN '" + @INSTTYPE + "' = '' THEN INST_TYPE ELSE '" + @INSTTYPE + "' END) AND "      
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + "LEFT(INST_TYPE,3) = (CASE WHEN '" + @INSTTYPE + "' = '' THEN LEFT(INST_TYPE,3) ELSE '" + @INSTTYPE + "' END) AND "      
	END	
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE = (CASE WHEN '" + @OPTIONTYPE + "' = '%' THEN OPTION_TYPE ELSE '" + @OPTIONTYPE + "' END) AND "      
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = (CASE WHEN '" + @EXPIRYDATE + "' = '%' THEN LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) ELSE '" + @EXPIRYDATE + "' END) AND "      
	SET @STRWHERE = @STRWHERE + "SYMBOL = (CASE WHEN '" + @SYMBOL + "' = '%' THEN SYMBOL ELSE '" + @SYMBOL + "' END) AND "      
	SET @STRWHERE = @STRWHERE + "AUCTIONPART = (CASE WHEN '" + @EX_AUCTIONPART + "' = '%' THEN AUCTIONPART ELSE '" + @EX_AUCTIONPART + "' END) AND  "      
	SET @STRWHERE = @STRWHERE + "PQTY +SQTY > 0 AND "        

	IF (@FROMCODE = '' AND @TOCODE = '')      
	BEGIN      
		--SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "
		SET @STRWHERE = @STRWHERE + " "
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
	END  
	IF (@FROMDATE = '' AND @TODATE = '')      
	BEGIN      
		--SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
		SET @STRWHERE = @STRWHERE + " "
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
	END      
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
	END      
        
	/*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	/*END - LOGIN CONDITIONS*/
	
	SET @COMMA = ''      
	SET @STRGROUPBY = @STRGROUPBY + @COMMA      
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBY =   + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
		END      	
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
		END      	
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "      
		END      
	END 
	ELSE
	BEGIN 
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY " END      
	END 

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")

		IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
		BEGIN
			SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "      
		END	
	END

	SET @STRORDERBY = @STRGROUPBY      
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY      
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY      
       
	SET @STRHAVING = ' HAVING '       
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' THEN PQTY ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' THEN SQTY ELSE 0 END) > 0"
    
	 IF @STRCOMPUTESUB <> ''       
	 BEGIN       
		  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	 END           

	SET @STRCOMPUTE = REPLACE(@STRCOMPUTE,'SUM()','SUM(0)')
	SET @STRCOMPUTESUB = REPLACE(@STRCOMPUTESUB,'SUM()','SUM(0)')

	SET @STRSELECT = REPLACE(@STRSELECT,'SYMBOL' , 'REPLACE(SYMBOL,''&'',''_'') AS SYMBOL')
	SET @STRSELECT = REPLACE(@STRSELECT,'PARTY_CODE','CLIENT_CODE=PARTY_CODE')
	
	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	DECLARE @SELECT VARCHAR(MAX)
	DECLARE @SELECT1 VARCHAR(MAX)
	DECLARE @SELECT_G VARCHAR(MAX)
	DECLARE @GROUPBY1 VARCHAR(MAX)
	DECLARE @ORDFLAG VARCHAR(MAX)
	DECLARE @ORDFLAG1 VARCHAR(MAX)

	IF (@ISSUBLEVEL = 'YES')
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY
	END      
	ELSE      
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY
	END

	--EXEC (@STRSQL)
	--RETURN
	

	SET @SELECT = ""
	SET @SELECT1 = ""
	SET @GROUPBY1 = ""
	SET @SELECT_G = ""
	SET @ORDFLAG = ""
	SET @ORDFLAG1 = ""

	IF (@ONEORMANY = "DETAIL" OR @WHATCODE = 'CLIENT')   
	BEGIN
		IF (@GROUPLEVEL = "PARTY")
		BEGIN
			SET @STRSQL = @STRSQL + "SELECT CLIENT_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE, "
			SET @SELECT = @SELECT + "SELECT CLIENT_CODE,CLIENT_NAME,CL_TYPE, "
			SET @SELECT1 = @SELECT1 + "CLIENT_CODE,MAX(CLIENT_NAME),MAX(CL_TYPE),"
			SET @SELECT_G = @SELECT_G + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
			SET @GROUPBY1 = @GROUPBY1 + "CLIENT_CODE,"
			SET @ORDFLAG1 = "CLIENT_CODE"
		END
		ELSE IF(@GROUPLEVEL = "SCRIP")
		BEGIN
			SET @STRSQL = @STRSQL + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE=OPTION_TYPE, "
			SET @SELECT = @SELECT + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE, "
			SET @SELECT1 = @SELECT1 + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE,"
			SET @SELECT_G = @SELECT_G + "MAX(SYMBOL),MAX(INST_TYPE),MAX(EXPIRYDATE),MAX(STRIKE_PRICE),MAX(OPT_TYPE),"
			SET @GROUPBY1 = @GROUPBY1 + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE,"
			SET @ORDFLAG1 = "SYMBOL"
		END
		ELSE IF(@GROUPLEVEL = "DATE")
		BEGIN
			SET @STRSQL = @STRSQL + "SELECT SAUDA_DATE, "
			SET @SELECT = @SELECT + "SELECT SAUDA_DATE, "
			SET @SELECT1 = @SELECT1 + "SAUDA_DATE,"
			SET @SELECT_G = @SELECT_G + "MAX(SAUDA_DATE),"
			SET @GROUPBY1 = @GROUPBY1 + "CONVERT(DATETIME,SAUDA_DATE,103),SAUDA_DATE,"
			SET @ORDFLAG1 = "SAUDA_DATE"
		END
		ELSE IF(@GROUPLEVEL = "INSTTYPE")
		BEGIN
			IF (@GROUPSUBLEVEL = "SCRIP")
			BEGIN
				SET @STRSQL = @STRSQL + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE=OPTION_TYPE, "
				SET @SELECT = @SELECT + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE, "
				SET @SELECT1 = @SELECT1 + "MAX(SYMBOL),INST_TYPE,MAX(EXPIRYDATE),MAX(STRIKE_PRICE),MAX(OPT_TYPE),"
				SET @SELECT_G = @SELECT_G + "MAX(SYMBOL),MAX(INST_TYPE),MAX(EXPIRYDATE),MAX(STRIKE_PRICE),MAX(OPT_TYPE),"
				SET @GROUPBY1 = @GROUPBY1 + "INST_TYPE,"
				SET @ORDFLAG1 = "SYMBOL"
			END
			ELSE
			BEGIN
				SET @STRSQL = @STRSQL + "SELECT INST_TYPE, "
				SET @SELECT = @SELECT + "SELECT INST_TYPE, "
				SET @SELECT1 = @SELECT1 + "INST_TYPE,"
				SET @SELECT_G = @SELECT_G + "MAX(INST_TYPE),"
				SET @GROUPBY1 = @GROUPBY1 + "INST_TYPE,"
				SET @ORDFLAG1 = "INST_TYPE"
			END
		END
		IF (@GROUPLEVEL <> "PARTY" AND @GROUPSUBLEVEL = "PARTY")
		BEGIN
			SET @STRSQL = @STRSQL + "CLIENT_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE, "
			SET @SELECT = @SELECT + "CLIENT_CODE,CLIENT_NAME,CL_TYPE, "
			SET @SELECT1 = @SELECT1 + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
			SET @SELECT_G = @SELECT_G + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
		END
		ELSE IF (@GROUPLEVEL <> "SCRIP" AND @GROUPSUBLEVEL = "SCRIP")
		BEGIN
			IF (@GROUPLEVEL = "INSTTYPE")
			BEGIN
				SET @STRSQL = @STRSQL + ""
			END
			ELSE
			BEGIN
				SET @STRSQL = @STRSQL + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE=OPTION_TYPE, "
				SET @SELECT = @SELECT + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPT_TYPE, "
				SET @SELECT1 = @SELECT1 + "MAX(SYMBOL),MAX(INST_TYPE),MAX(EXPIRYDATE),MAX(STRIKE_PRICE),MAX(OPT_TYPE),"
				SET @SELECT_G = @SELECT_G + "MAX(SYMBOL),MAX(INST_TYPE),MAX(EXPIRYDATE),MAX(STRIKE_PRICE),MAX(OPT_TYPE),"
			END
		END
		ELSE IF(@GROUPLEVEL <> "DATE" AND @GROUPSUBLEVEL = "DATE")
		BEGIN
			SET @STRSQL = @STRSQL + "SAUDA_DATE, "
			SET @SELECT = @SELECT + "SAUDA_DATE, "
			SET @SELECT1 = @SELECT1 + "MAX(SAUDA_DATE),"
			SET @SELECT_G = @SELECT_G + "MAX(SAUDA_DATE),"
		END
		ELSE IF(@GROUPLEVEL <> "INSTTYPE" AND @GROUPSUBLEVEL = "INSTTYPE")
		BEGIN
			IF (@GROUPLEVEL = "SCRIP")
			BEGIN
				SET @STRSQL = @STRSQL + ""
			END
			ELSE
			BEGIN
				SET @STRSQL = @STRSQL + "INST_TYPE, "
				SET @SELECT = @SELECT + "INST_TYPE, "
				SET @SELECT1 = @SELECT1 + "MAX(INST_TYPE),"
				SET @SELECT_G = @SELECT_G + "MAX(INST_TYPE),"
			END
		END
	END	
	ELSE
	BEGIN
		SET @ORDFLAG1 = @WHATCODE
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) 
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT CLIENT_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE," 
			SET @SELECT = @SELECT + "SELECT CLIENT_CODE,CLIENT_NAME,CL_TYPE," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
				SET @SELECT_G = @SELECT_G + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "CLIENT_CODE,MAX(CLIENT_NAME),MAX(CL_TYPE),"
				SET @SELECT_G = @SELECT_G + "MAX(CLIENT_CODE),MAX(CLIENT_NAME),MAX(CL_TYPE),"
				SET @GROUPBY1 = @GROUPBY1 + "CLIENT_CODE,"
			END
			SET @ORDFLAG1 = "CLIENT_CODE"
      	END
		IF (@WHATCODE = 'AREA')			
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT AREA,"
			SET @SELECT = @SELECT + "SELECT AREA,"
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(AREA)," 
				SET @SELECT_G = @SELECT_G + "MAX(AREA),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "AREA," 
				SET @SELECT_G = @SELECT_G + "MAX(AREA),"
				SET @GROUPBY1 = @GROUPBY1 + "AREA,"
			END
		END
		IF (@WHATCODE = 'REGION')		
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT REGION," 
			SET @SELECT = @SELECT + "SELECT REGION," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(REGION),"
				SET @SELECT_G = @SELECT_G + "MAX(REGION),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "REGION,"
				SET @SELECT_G = @SELECT_G + "MAX(REGION),"
				SET @GROUPBY1 = @GROUPBY1 + "REGION,"
			END			
		END      
		IF (@WHATCODE = 'BRANCH')		
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT BRANCH_CODE," 
			SET @SELECT = @SELECT + "SELECT BRANCH_CODE," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(BRANCH_CODE),"
				SET @SELECT_G = @SELECT_G + "MAX(BRANCH_CODE),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "BRANCH_CODE,"
				SET @SELECT_G = @SELECT_G + "MAX(BRANCH_CODE),"
				SET @GROUPBY1 = @GROUPBY1 + "BRANCH_CODE,"
			END			
			SET @ORDFLAG1 = "BRANCH_CODE"
		END
		IF (@WHATCODE = 'SUBBROKER')	
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT SUB_BROKER," 
			SET @SELECT = @SELECT + "SELECT SUB_BROKER," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(SUB_BROKER),"
				SET @SELECT_G = @SELECT_G + "'',"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "SUB_BROKER,"
				SET @SELECT_G = @SELECT_G + "MAX(SUB_BROKER),"
				SET @GROUPBY1 = @GROUPBY1 + "SUB_BROKER,"
			END			
			SET @ORDFLAG1 = "SUB_BROKER"
		END
		IF (@WHATCODE = 'TRADER')		
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT TRADER," 
			SET @SELECT = @SELECT + "SELECT TRADER," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(TRADER),"
				SET @SELECT_G = @SELECT_G + "MAX(TRADER),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "TRADER,"
				SET @SELECT_G = @SELECT_G + "MAX(TRADER),"
				SET @GROUPBY1 = @GROUPBY1 + "TRADER,"
			END			
		END      
		IF (@WHATCODE = 'FAMILY')		
		BEGIN 
			SET @STRSQL = @STRSQL + "SELECT FAMILY,FAMILY_NAME," 
			SET @SELECT = @SELECT + "SELECT FAMILY,FAMILY_NAME," 
			IF (@GROUPLEVEL = @GROUPSUBLEVEL)
			BEGIN
				SET @SELECT1 = @SELECT1 + "MAX(FAMILY),MAX(FAMILY_NAME),"
				SET @SELECT_G = @SELECT_G + "MAX(FAMILY),MAX(FAMILY_NAME),"
			END
			ELSE
			BEGIN
				SET @SELECT1 = @SELECT1 + "FAMILY,MAX(FAMILY_NAME),"
				SET @SELECT_G = @SELECT_G + "MAX(FAMILY),MAX(FAMILY_NAME),"
				SET @GROUPBY1 = @GROUPBY1 + "FAMILY,"
			END
		END		
	END
	
	SET @STRSQL = @STRSQL + " OPEN_QTY=OPENQTY,BUY_QTY=PQTY,BUY_RATE=CONVERT(NUMERIC(18,2),ROUND(PRATE,2)),"
	SET @STRSQL = @STRSQL + " BUY_AMT=CONVERT(NUMERIC(18,2),ROUND(PAMT,2)),"
	SET @STRSQL = @STRSQL + " SELL_QTY=SQTY,SELL_RATE=CONVERT(NUMERIC(18,2),ROUND(SRATE,2)),"
	SET @STRSQL = @STRSQL + " SELL_AMT=CONVERT(NUMERIC(18,2),ROUND(SAMT,2)),NET_QTY=NETQTY,"
	SET @STRSQL = @STRSQL + " AVG_PRICE=CONVERT(NUMERIC(18,2),ROUND(AVGPRICE,2)),NET_AMT=CONVERT(NUMERIC(18,2),ROUND(NETAMT,2)),"
	SET @STRSQL = @STRSQL + " CL_QTY=CLOSEQTY,CL_RATE=CONVERT(NUMERIC(18,2),ROUND(CL_RATE,2)),"
	SET @STRSQL = @STRSQL + " PNL_AMT=CONVERT(NUMERIC(18,2),ROUND(PROFITORLOSS,2)),ORDFLAG=1,TOTAL_FLAG=CONVERT(VARCHAR(15),''),ORDFIELD="+@ORDFLAG1+" "
	SET @STRSQL = @STRSQL + " INTO #FOSAUDASUMMARY_NEW "
	SET @STRSQL = @STRSQL + " FROM #FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE #FOSAUDASUMMARY "

	SET @STRSQL = @STRSQL + " IF (SELECT COUNT(1) FROM #FOSAUDASUMMARY_NEW) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " ALTER TABLE #FOSAUDASUMMARY_NEW ALTER COLUMN "+@ORDFLAG1+" VARCHAR(30) "
	SET @STRSQL = @STRSQL + " INSERT INTO #FOSAUDASUMMARY_NEW ("+@ORDFLAG1+",OPEN_QTY,BUY_QTY,BUY_RATE,BUY_AMT,SELL_QTY,SELL_RATE,SELL_AMT,NET_QTY,AVG_PRICE,NET_AMT,CL_QTY,CL_RATE,PNL_AMT,ORDFLAG,TOTAL_FLAG,ORDFIELD) "
	SET @STRSQL = @STRSQL + " SELECT 'SUB TOTAL',"
	SET @STRSQL = @STRSQL + " OPEN_QTY=SUM(OPEN_QTY), "
	SET @STRSQL = @STRSQL + " BUY_QTY=SUM(BUY_QTY), "
	SET @STRSQL = @STRSQL + " BUY_RATE=(CASE WHEN SUM(BUY_QTY) > 0 THEN SUM(BUY_RATE*BUY_QTY)/SUM(BUY_QTY) ELSE 0 END), "
	SET @STRSQL = @STRSQL + " BUY_AMT=SUM(BUY_AMT), "
	SET @STRSQL = @STRSQL + " SELL_QTY=SUM(SELL_QTY), "
	SET @STRSQL = @STRSQL + " SELL_RATE=(CASE WHEN SUM(SELL_QTY) > 0 THEN SUM(SELL_RATE*SELL_QTY)/SUM(SELL_QTY) ELSE 0 END), "
	SET @STRSQL = @STRSQL + " SELL_AMT=SUM(SELL_AMT), "
	SET @STRSQL = @STRSQL + " NET_QTY=SUM(NET_QTY), "
	SET @STRSQL = @STRSQL + " AVG_PRICE=0, "
	SET @STRSQL = @STRSQL + " NET_AMT=SUM(NET_AMT), "
	SET @STRSQL = @STRSQL + " CL_QTY=0, "
	SET @STRSQL = @STRSQL + " CL_RATE=0, "
	SET @STRSQL = @STRSQL + " PNL_AMT=SUM(PNL_AMT),ORDFLAG=2,TOTAL_FLAG='SUB TOTAL',ORDFIELD=MAX("+@ORDFLAG1+")"
	SET @STRSQL = @STRSQL + " FROM #FOSAUDASUMMARY_NEW "
	IF (@GROUPLEVEL <> @GROUPSUBLEVEL)
	BEGIN
	IF (LEN(@GROUPBY1) > 0)
	BEGIN
		SET @STRSQL = @STRSQL + " GROUP BY "+ LEFT(@GROUPBY1,LEN(@GROUPBY1)-1)
		--SET @STRSQL = @STRSQL + " ORDER BY "+ LEFT(@GROUPBY1,LEN(@GROUPBY1)-1)
	END
	END

	SET @STRSQL = @STRSQL + " INSERT INTO #FOSAUDASUMMARY_NEW ("+@ORDFLAG1+",OPEN_QTY,BUY_QTY,BUY_RATE,BUY_AMT,SELL_QTY,SELL_RATE,SELL_AMT,NET_QTY,AVG_PRICE,NET_AMT,CL_QTY,CL_RATE,PNL_AMT,ORDFLAG,TOTAL_FLAG,ORDFIELD) "
	SET @STRSQL = @STRSQL + " SELECT 'GRAND TOTAL',"
	SET @STRSQL = @STRSQL + " OPEN_QTY=SUM(OPEN_QTY), "
	SET @STRSQL = @STRSQL + " BUY_QTY=SUM(BUY_QTY), "
	SET @STRSQL = @STRSQL + " BUY_RATE=(CASE WHEN SUM(BUY_QTY) > 0 THEN SUM(BUY_RATE*BUY_QTY)/SUM(BUY_QTY) ELSE 0 END), "
	SET @STRSQL = @STRSQL + " BUY_AMT=SUM(BUY_AMT), "
	SET @STRSQL = @STRSQL + " SELL_QTY=SUM(SELL_QTY), "
	SET @STRSQL = @STRSQL + " SELL_RATE=(CASE WHEN SUM(SELL_QTY) > 0 THEN SUM(SELL_RATE*SELL_QTY)/SUM(SELL_QTY) ELSE 0 END), "
	SET @STRSQL = @STRSQL + " SELL_AMT=SUM(SELL_AMT), "
	SET @STRSQL = @STRSQL + " NET_QTY=SUM(NET_QTY), "
	SET @STRSQL = @STRSQL + " AVG_PRICE=0, "
	SET @STRSQL = @STRSQL + " NET_AMT=SUM(NET_AMT), "
	SET @STRSQL = @STRSQL + " CL_QTY=0, "
	SET @STRSQL = @STRSQL + " CL_RATE=0, "
	SET @STRSQL = @STRSQL + " PNL_AMT=SUM(PNL_AMT),ORDFLAG=3,TOTAL_FLAG='GRAND TOTAL',ORDFIELD=MAX("+@ORDFLAG1+")"
	SET @STRSQL = @STRSQL + " FROM #FOSAUDASUMMARY_NEW WHERE ORDFLAG = 1"
	SET @STRSQL = @STRSQL + " END "

	SET @STRSQL = @STRSQL + " " + @SELECT
	SET @STRSQL = @STRSQL + " OPEN_QTY,BUY_QTY,BUY_RATE,BUY_AMT,SELL_QTY,SELL_RATE,SELL_AMT,NET_QTY,AVG_PRICE,NET_AMT,CL_QTY,CL_RATE,PNL_AMT,TOTAL_FLAG "
	SET @STRSQL = @STRSQL + " FROM #FOSAUDASUMMARY_NEW "
	SET @STRSQL = @STRSQL + " ORDER BY "
	IF (@GROUPLEVEL = "DATE" AND @GROUPSUBLEVEL = "DATE")
	BEGIN
		SET @STRSQL = @STRSQL + "ORDFLAG,CONVERT(DATETIME,ORDFIELD,103) "
	END
	ELSE IF (@GROUPLEVEL = "DATE")
	BEGIN
		SET @STRSQL = @STRSQL + "CONVERT(DATETIME,ORDFIELD,103),ORDFLAG "
	END
	ELSE
	BEGIN
		SET @STRSQL = @STRSQL + "ORDFIELD,ORDFLAG "
	END

	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWTURNOVER
-- --------------------------------------------------


CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWTURNOVER]      
	@REPORTNAME VARCHAR(50),      
	@STATUSID VARCHAR(20),      
	@STATUSNAME VARCHAR(50),      
	@GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT      
	@GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS      
	@ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	@ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	@FROMDATE VARCHAR(11),      
	@TODATE VARCHAR(11),      
	@WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	@FROMCODE VARCHAR(50),      
	@TOCODE VARCHAR(50),      
	@FROMPARTYCODE VARCHAR(50), --]--> FOR THE FROM AND TO PARTY CODES      
	@TOPARTYCODE VARCHAR(50), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	@ONEORMANY VARCHAR(20),      
	@INSTTYPE VARCHAR(20),  --]      
	@OPTIONTYPE VARCHAR(20), --]      
	@STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.      
	@EXPIRYDATE VARCHAR(11), --]      
	@SYMBOL VARCHAR(20),  --]      
	--REPORT SPECIFIC SEARCH FEILDS      
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)          
	@EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]      
	@EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]      
	@EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	@EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	@EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]      
	@EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]      
	--END REPORT SPECIFIC SEARCH FEILDS      
	@ULCLRATE VARCHAR(50),      
	@CLTRANSACTIONS VARCHAR(50),      
	@CLTYPE VARCHAR(50),		-- (FOR CLIENT TYPE)
	@DUMMY004 VARCHAR(50) = '',      
	@DUMMY005 VARCHAR(50) = '',      
	@DUMMY006 VARCHAR(50) = '',      
	@DUMMY007 VARCHAR(50) = '',      
	@DUMMY008 VARCHAR(50) = '',      
	@DUMMY009 VARCHAR(50) = '',      
	@DUMMY010 VARCHAR(50) = ''      

AS      

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE      
 @STRSELECT VARCHAR(8000),      
 @STRSELECTTEMP VARCHAR(8000),      
 @STRFROM VARCHAR(8000),      
 @STRWHERE VARCHAR(8000),      
 @STRGROUPBY VARCHAR(8000),      
 @STRORDERBY VARCHAR(8000),      
 @STRCOMPUTE VARCHAR(8000),      
 @STRCOMPUTESUB VARCHAR(8000),      
 @ISSUBLEVEL VARCHAR(3),      
 @CODEID VARCHAR(20),      
 @COMMA VARCHAR(1)
       
 SET @INSTTYPE = @INSTTYPE+"%"
 SET @EX_RATE = "MKTRATE"
 IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE      
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END      
 IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
       
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      
 SET @STRSELECT = ''      
 SET @STRSELECTTEMP = ''      
 SET @STRFROM = ''      
 SET @STRWHERE = ''      
 SET @STRGROUPBY = ''      
 SET @STRORDERBY = ''      
 SET @STRCOMPUTE = ''      
 SET @STRCOMPUTE = ''      
 SET @STRCOMPUTESUB = ''      
 SET @ISSUBLEVEL = 'NO'      

 IF LEN(@FROMDATE) = 10 AND CHARINDEX('/',@FROMDATE) > 0    
 SET @FROMDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @FROMDATE,103),109)

 IF LEN(@TODATE) = 10 AND CHARINDEX('/',@TODATE) > 0
 SET @TODATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @TODATE,103),109) 

 IF LEN(@EXPIRYDATE) = 10 AND CHARINDEX('/',@EXPIRYDATE) > 0
 SET @EXPIRYDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @EXPIRYDATE,103),109) 
 
 IF (UPPER(@CLTYPE) = 'ALL')
 BEGIN
	SET @CLTYPE = ''
 END

 IF (@FROMDATE = '' AND @TODATE = '')      
 BEGIN       
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN       
 END       
 IF (@REPORTNAME = 'TURNOVER')      
 BEGIN      
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
  SET @STRSELECT = @STRSELECT + "SELECT "      
  SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
  BEGIN      
   SET @STRSELECTTEMP = ''      
   IF (@GROUPLEVEL = 'PARTY')      
   BEGIN      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
    IF (@GROUPSUBLEVEL = 'SCRIP')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'DATE')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
          
    IF (@ISSUBLEVEL = 'YES')      
    BEGIN      
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
    END      
   END      
   IF (@GROUPLEVEL = 'SCRIP')      
   BEGIN      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
    IF (@GROUPSUBLEVEL = 'PARTY')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'DATE')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE')      
    BEGIN      
     --SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@ISSUBLEVEL = 'YES')      
    BEGIN      
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
    END      
   END      
       
   IF (@GROUPLEVEL = 'DATE')      
   BEGIN      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "      
    IF (@GROUPSUBLEVEL = 'PARTY')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'SCRIP')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@ISSUBLEVEL = 'YES')      
    BEGIN      
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "      
    END      
   END      
       
   IF (@GROUPLEVEL = 'INSTTYPE')      
   BEGIN      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
    IF (@GROUPSUBLEVEL = 'PARTY')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
  SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'SCRIP')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL,  CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,"      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@GROUPSUBLEVEL = 'DATE')      
    BEGIN      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "      
     SET @ISSUBLEVEL = 'YES'      
    END      
    IF (@ISSUBLEVEL = 'YES')      
    BEGIN      
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
    END      
   END      
       
   IF (@GROUPLEVEL = 'PSD')      
   BEGIN      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "      
    SET @ISSUBLEVEL = 'YES'      
   END      
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   SET @STRSELECTTEMP = ''      
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/      
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/      
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/      
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END      
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/      
        
  IF (@EX_RATE = 'MKTRATE')      
  BEGIN      
   --FUTURES TRADED VALUE - MKTRATE - COMMON      
   SET @STRSELECTTEMP = ''      
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA' AND AUCTIONPART <> 'CA' "      
   SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) "      
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUTURESTRADEDVALUE, "      
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   IF (@EX_REPORTBY = 'STRIKE')      
   BEGIN      
    --OPTIONS TRADED AMT - MKTRATE + STRIKE      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((PQTY+SQTY)*STRIKE_PRICE) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    --EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE      
    IF (@ULCLRATE = 'EX')      
    BEGIN      
     SET @STRSELECTTEMP = ''      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "  
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     SET @STRSELECTTEMP = '0 '      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    END      
    ELSE /*OF IF (@ULCLRATE = 'EX')*/      
    BEGIN      
     --ASSIGNED AMT - ASG/BOTH + STRIKE      
     IF (@ULCLRATE = 'ASG')      
     BEGIN      
      SET @STRSELECTTEMP = '0 '      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
       
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END      
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/      
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE      
       
     BEGIN      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/      
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) + "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PQTY+SQTY)*STRIKE_PRICE,0) ELSE 0 END))  "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   END    
   IF (@EX_REPORTBY = 'PRICE')      
   BEGIN      
    --OPTIONS TRADED AMT - MKTRATE + PRICE      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    --EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE      
    IF (@ULCLRATE = 'EX')      
    BEGIN      
     SET @STRSELECTTEMP = ''      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE) ELSE 0 END)) "      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     SET @STRSELECTTEMP = '0 '      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    END      
    ELSE /*OF IF (@ULCLRATE = 'EX')*/      
    BEGIN      
     --ASSIGNED AMT - ASG/BOTH + PRICE      
     IF (@ULCLRATE = 'ASG')      
     BEGIN      
      SET @STRSELECTTEMP = '0 '      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
       
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END      
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/      
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE      
       
     BEGIN      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/      
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) + "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))  "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   END      
   IF (@EX_REPORTBY = 'BOTH')      
   BEGIN      
    --OPTIONS TRADED AMT - MKTRATE + BOTH      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY+SQTY)*STRIKE_PRICE) + (PQTY*PRATE)+(SQTY*SRATE)) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH      
    IF (@ULCLRATE = 'EX')      
    BEGIN      
     SET @STRSELECTTEMP = ''      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)) "      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     SET @STRSELECTTEMP = '0 '      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    END      
    ELSE /*OF IF (@ULCLRATE = 'EX')*/      
    BEGIN      
     --ASSIGNED AMT - ASG/BOTH + BOTH      
     IF (@ULCLRATE = 'ASG')      
     BEGIN      
      SET @STRSELECTTEMP = '0 '      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
       
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END      
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/      
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE      
  
     BEGIN      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/      
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) + "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PRATE+STRIKE_PRICE)*PQTY + (SRATE+STRIKE_PRICE)*SQTY,0) ELSE 0 END))  "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   END      
   IF (@EX_REPORTBY = 'EXCHG')      
   BEGIN      
    --OPTIONS TRADED AMT - MKTRATE + BOTH      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    --EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH      
    IF (@ULCLRATE = 'EX')      
    BEGIN      
     SET @STRSELECTTEMP = ''      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     SET @STRSELECTTEMP = '0 '      
     SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
     SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
     SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
    END     
    ELSE /*OF IF (@ULCLRATE = 'EX')*/      
    BEGIN      
     --ASSIGNED AMT - ASG/BOTH + BOTH      
     IF (@ULCLRATE = 'ASG')      
     BEGIN      
      SET @STRSELECTTEMP = '0 '      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
       
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END      
     ELSE /*OF IF (@ULCLRATE = 'ASG')*/      
     --CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE      
       
     BEGIN      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
      SET @STRSELECTTEMP = ''      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "      
      SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ " --FOR THE SUB TOTAL      
      SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "      
      SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
     END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/      
    END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
    SET @STRSELECTTEMP = ''      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) + "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) + "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))  "      
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL      
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "      
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
   END      
  END /*IF (@EX_RATE = 'NETRATE')*/      
  --BROKERAGE      
  --SET @STRSELECTTEMP = ''      
  --SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(PBROKAMT + SBROKAMT) "      
  --SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ " --FOR THE SUB TOTAL      
  --SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKERAGE, "      
  --SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUT_BROKERAGE, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPT_BROKERAGE, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  --SERVICE TAX      
  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(TOT_SERVICETAX) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SERVICETAX, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
  --INS_CHRG     

  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(INS_CHRG) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS INS_CHRG, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
        
  --TURNOVER TAX      
  --SET @STRSELECTTEMP = ''      
  --SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(TURN_TAX) "      
  --SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ " --FOR THE SUB TOTAL      
  --SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TURNOVERTAX, "      
  --SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (TURN_TAX) ELSE 0 END) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUT_TURNOVERTAX, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN (TURN_TAX) ELSE 0 END) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPT_TURNOVERTAX, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

  --SEBI TAX      
  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SEBI_TAX) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SEBI TAX */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SEBITAX, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
  --STAMP DUTY      
  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(BROKER_NOTE) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* STAMP DUTY */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS STAMPDUTY, "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
  --CLEARING CHARGES      
  SET @STRSELECTTEMP = ''      
	-- SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CL_CHRG - EXCL_CHRG) "      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(OTHER_CHRG) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CLEARING CHARGES */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "      
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
  
  IF (@GROUPLEVEL = 'SCRIP' OR @GROUPSUBLEVEL = 'SCRIP')
  BEGIN
	  SET @STRSELECTTEMP = ''      
	  SET @STRSELECTTEMP = @STRSELECTTEMP + ",(CASE WHEN SUM(PQTY+SQTY) <> 0 OR MAX(BILLNO) <> 0 THEN SUM(PQTY+SQTY)/MAX(BILLNO) ELSE 0 END)"      
	  --SET @STRCOMPUTE = @STRCOMPUTE + ",SUM(" + REPLACE(@STRSELECTTEMP,',','') + ") /* CLEARING CHARGES */ " --FOR THE SUB TOTAL      
	  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS LOTSIZE "      
	  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
  END

   --SBC CHRG      
  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(SBC_CHRG) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "," + " SUM(" + @STRSELECTTEMP + ") /* SBC CHRG */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + " AS SBC_CHRG "      
  SET @STRSELECT = @STRSELECT + "," + @STRSELECTTEMP
 
   --KKC CHRG      
  SET @STRSELECTTEMP = ''      
  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(KRISHI_CHRG) "      
  SET @STRCOMPUTE = @STRCOMPUTE + "," + " SUM(" + @STRSELECTTEMP + ") /* KKC CHRG */ " --FOR THE SUB TOTAL      
  SET @STRSELECTTEMP = @STRSELECTTEMP + " AS KKC_CHRG "      
  SET @STRSELECT = @STRSELECT + "," + @STRSELECTTEMP

  SET @STRFROM = @STRFROM + "INTO #FOTURNOVER "
  SET @STRFROM = @STRFROM + "FROM "      
  SET @STRFROM = @STRFROM + "CLS_FOBILLVALAN_CHRG (NOLOCK)"      
       
  SET @STRWHERE = @STRWHERE + "WHERE "      
  SET @STRWHERE = @STRWHERE + "TRADETYPE = 'BT' AND "      
       
  SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "      
  SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "      
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "      
  SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "      
  IF (@FROMCODE = '' AND @TOCODE = '')      
  BEGIN      
   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
  END      
  ELSE      
  BEGIN      
   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
  END      
  IF (@FROMDATE = '' AND @TODATE = '')      
  BEGIN      
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
  END      
  ELSE      
  BEGIN      
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
  END      
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
  BEGIN      
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
  END
  IF (@CLTYPE <> '')
  BEGIN 
	SET @STRWHERE = @STRWHERE + "CLIENT_TYPE = '" + @CLTYPE + "' AND "
  END	

 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''      
  SET @STRGROUPBY = @STRGROUPBY + @COMMA      
        
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
  BEGIN      
   IF (@GROUPLEVEL = 'PARTY')      
   BEGIN      
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
    SET @COMMA = ', '      
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
   END      
         
   IF (@GROUPLEVEL = 'SCRIP')      
   BEGIN      
    SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
    SET @COMMA = ', '      
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
   END      
       
   IF (@GROUPLEVEL = 'DATE')      
   BEGIN      
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "      
    SET @COMMA = ', '      
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
   END      
       
   IF (@GROUPLEVEL = 'INSTTYPE')      
   BEGIN      
    SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
    SET @COMMA = ', '      
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE" END      
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END      
   END      
       
   IF (@GROUPLEVEL = 'PSD')      
   BEGIN      
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
    SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "      
   END      
  END /*IF (@ONEORMANY = 'DETAIL')*/      
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/      
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/      
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME "  END
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/      
  
	IF (CHARINDEX('SAUDA_DATE',RTRIM(LTRIM(@STRSELECT))) > 0)
	BEGIN
		SET @STRSELECT = @STRSELECT + "," + "ORDDATE=CONVERT(VARCHAR,SAUDA_DATE,112) "
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")
		SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,SAUDA_DATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1))) + " "      
	END	
  
  SET @STRORDERBY = @STRGROUPBY      
  SET @STRGROUPBY = " GROUP BY " + @STRGROUPBY      
  SET @STRORDERBY = " ORDER BY " + @STRORDERBY      
 END/*IF (@REPORTNAME = "NETPOSITION")*/      

	 IF @STRCOMPUTESUB <> ''       
	 BEGIN       
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	 END      

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	DECLARE @SELECT VARCHAR(MAX)
	DECLARE @SELECT1 VARCHAR(MAX)
	DECLARE @SELECT_G VARCHAR(MAX)
	DECLARE @GROUPBY1 VARCHAR(MAX)
	DECLARE @ORDFLAG VARCHAR(MAX)
	DECLARE @ORDFLAG1 VARCHAR(MAX)
	DECLARE @STRGROUPBYGRANDTOTAL VARCHAR(MAX)
	DECLARE @STRGROUPBYSUBTOTAL VARCHAR(MAX)

	SET @STRSELECT = REPLACE(@STRSELECT,'MAX(EMAIL) AS EMAIL,','')
	SET @SELECT = ""
	SET @SELECT1 = ""
	SET @STRGROUPBYSUBTOTAL = ""
	SET @STRGROUPBYGRANDTOTAL = ""

	IF (@ISSUBLEVEL = 'YES')      
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
		--EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY
	END      
	ELSE      
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
		--EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
		SET @STRSQL = @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY
	END      


	SET @SELECT = ''
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "PARTY_CODE"
			SET @SELECT = @SELECT + "SELECT CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @SELECT = @SELECT + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,"
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @SELECT = @SELECT + "SAUDA_DATE,"
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @SELECT = @SELECT + "INST_TYPE,"      
			END      
		END      

		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "SYMBOL"
			SET @SELECT = @SELECT + "SELECT SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,"
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @SELECT = @SELECT + "CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @SELECT = @SELECT + "SAUDA_DATE,"
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @SELECT = @SELECT + "INST_TYPE,"      
			END      
		END      

		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "SAUDA_DATE"
			SET @SELECT = @SELECT + "SELECT SAUDA_DATE,"
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @SELECT = @SELECT + "CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @SELECT = @SELECT + "SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,"      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @SELECT = @SELECT + "INST_TYPE,"
			END      
		END      

		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "INST_TYPE"
			SET @SELECT = @SELECT + "SELECT INST_TYPE,"
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @SELECT = @SELECT + "CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE,"
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @SELECT = @SELECT + "SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,"
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @SELECT = @SELECT + "SAUDA_DATE,"
			END      
		END      
	END 
	ELSE
	BEGIN
		IF (@WHATCODE = 'CLIENT')		
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "PARTY_CODE"
			SET @SELECT = @SELECT + "SELECT CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,CL_TYPE=CLIENT_TYPE," 
		END
		IF (@WHATCODE = 'AREA')			
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "AREA"
			SET @SELECT = @SELECT + "SELECT AREA," 
		END
		IF (@WHATCODE = 'REGION')		
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "REGION"
			SET @SELECT = @SELECT + "SELECT REGION," 
		END
		IF (@WHATCODE = 'BRANCH')		
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "BRANCH_CODE"
			SET @SELECT = @SELECT + "SELECT BRANCH_CODE," 
		END
		IF (@WHATCODE = 'SUBBROKER')	
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "SUB_BROKER"
			SET @SELECT = @SELECT + "SELECT SUB_BROKER," 
		END      
		IF (@WHATCODE = 'TRADER')		
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "TRADER"
			SET @SELECT = @SELECT + "SELECT TRADER," 
		END
		IF (@WHATCODE = 'FAMILY')		
		BEGIN 
			SET @STRGROUPBYSUBTOTAL = @STRGROUPBYSUBTOTAL + "FAMILY"
			SET @SELECT = @SELECT + "SELECT FAMILY,FAMILYNAME," 
		END  
	END
  
  	SET @STRGROUPBYGRANDTOTAL = @STRGROUPBYSUBTOTAL
  	
	SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ADD TOTAL_FLAG VARCHAR(20) "
	SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ADD ORDFLAG INT "
	SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ADD ORDFIELD VARCHAR(100) "
	SET @STRSQL = @STRSQL + " UPDATE #FOTURNOVER SET ORDFLAG = 1, ORDFIELD = "+ @STRGROUPBYSUBTOTAL + " "

	IF (@GROUPLEVEL = "SCRIP" OR @GROUPSUBLEVEL = 'SCRIP')
	BEGIN
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN INST_TYPE VARCHAR(6)  NULL " 
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN SYMBOL VARCHAR(12) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN OPTION_TYPE VARCHAR(2)  NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN STRIKE_PRICE MONEY  NULL "
	END
	IF ((@GROUPLEVEL = "PARTY" OR @GROUPSUBLEVEL = 'PARTY') AND @WHATCODE = 'CLIENT')
	BEGIN      
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN PARTY_CODE VARCHAR(20) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN PARTY_NAME VARCHAR(100) NULL "
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN CLIENT_TYPE VARCHAR(5) NULL "
	END      
	IF (@GROUPLEVEL = "INSTTYPE" OR @GROUPSUBLEVEL = 'INSTTYPE')
	BEGIN      
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN INST_TYPE VARCHAR(10) NULL "
	END
	IF (@GROUPLEVEL = "DATE" OR @GROUPSUBLEVEL = 'DATE')
	BEGIN      
		SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN SAUDA_DATE VARCHAR(11) NULL "
	END
	
	SET @STRSQL = @STRSQL + " ALTER TABLE #FOTURNOVER ALTER COLUMN "+@STRGROUPBYGRANDTOTAL+" VARCHAR(30) "

	SET @STRSQL = @STRSQL + "IF (SELECT COUNT(1) FROM #FOTURNOVER) > 0 BEGIN "
	SET @STRSQL = @STRSQL + "INSERT INTO #FOTURNOVER ("+@STRGROUPBYSUBTOTAL+",FUTURESTRADEDVALUE,OPTIONSTRADEDVALUE,EXCERCISEVALUE,ASSIGNMENTVALUE,CLOSEOUTVALUE,TOTAL,FUT_BROKERAGE,OPT_BROKERAGE,SERVICETAX,SBC_CHRG,KKC_CHRG,INS_CHRG,FUT_TURNOVERTAX,OPT_TURNOVERTAX,SEBITAX,STAMPDUTY,CLEARINGCHARGES,ORDFLAG,ORDFIELD,TOTAL_FLAG) "
	IF (@GROUPLEVEL = @GROUPSUBLEVEL)
	BEGIN
		SET @STRGROUPBYSUBTOTAL = "MAX("+ @STRGROUPBYSUBTOTAL +")"
	END
	SET @STRSQL = @STRSQL + "SELECT 'SUB TOTAL',"
	SET @STRSQL = @STRSQL + "SUM(FUTURESTRADEDVALUE),SUM(OPTIONSTRADEDVALUE),SUM(ISNULL(EXCERCISEVALUE,0)),SUM(ISNULL(ASSIGNMENTVALUE,0)),SUM(ISNULL(CLOSEOUTVALUE,0)),SUM(TOTAL),SUM(FUT_BROKERAGE),SUM(OPT_BROKERAGE),SUM(SERVICETAX),SUM(SBC_CHRG),SUM(KKC_CHRG),SUM(INS_CHRG),SUM(FUT_TURNOVERTAX),SUM(OPT_TURNOVERTAX),SUM(SEBITAX),SUM(STAMPDUTY),SUM(CLEARINGCHARGES), "
	SET @STRSQL = @STRSQL + "ORDFLAG=2,ORDFIELD="+ @STRGROUPBYSUBTOTAL +",TOTAL_FLAG='SUB TOTAL' "
	SET @STRSQL = @STRSQL + "FROM #FOTURNOVER "
	IF (@GROUPLEVEL <> @GROUPSUBLEVEL)
	BEGIN
		SET @STRSQL = @STRSQL + "GROUP BY " + @STRGROUPBYSUBTOTAL +" "
	END
      
	SET @STRSQL = @STRSQL + "INSERT INTO #FOTURNOVER ("+@STRGROUPBYGRANDTOTAL+",FUTURESTRADEDVALUE,OPTIONSTRADEDVALUE,EXCERCISEVALUE,ASSIGNMENTVALUE,CLOSEOUTVALUE,TOTAL,FUT_BROKERAGE,OPT_BROKERAGE,SERVICETAX,SBC_CHRG,KKC_CHRG,INS_CHRG,FUT_TURNOVERTAX,OPT_TURNOVERTAX,SEBITAX,STAMPDUTY,CLEARINGCHARGES,ORDFLAG,ORDFIELD,TOTAL_FLAG) "
	SET @STRSQL = @STRSQL + "SELECT 'GRAND TOTAL',"
	SET @STRSQL = @STRSQL + "SUM(FUTURESTRADEDVALUE),SUM(OPTIONSTRADEDVALUE),SUM(ISNULL(EXCERCISEVALUE,0)),SUM(ISNULL(ASSIGNMENTVALUE,0)),SUM(ISNULL(CLOSEOUTVALUE,0)),SUM(TOTAL),SUM(FUT_BROKERAGE),SUM(OPT_BROKERAGE),SUM(SERVICETAX),SUM(SBC_CHRG),SUM(KKC_CHRG),SUM(INS_CHRG),SUM(FUT_TURNOVERTAX),SUM(OPT_TURNOVERTAX),SUM(SEBITAX),SUM(STAMPDUTY),SUM(CLEARINGCHARGES), "
	SET @STRSQL = @STRSQL + "ORDFLAG=3,ORDFIELD=MAX("+ @STRGROUPBYGRANDTOTAL +"),TOTAL_FLAG='GRAND TOTAL' "
	SET @STRSQL = @STRSQL + "FROM #FOTURNOVER WHERE ORDFLAG=1 "
	SET @STRSQL = @STRSQL + "END "

	SET @STRSQL = @STRSQL + @SELECT
	IF (@CLTRANSACTIONS = "TURNOVER")
	BEGIN
		SET @STRSQL = @STRSQL + "FUT_TRD_VAL=CONVERT(NUMERIC(18,2),ROUND(FUTURESTRADEDVALUE,2)),"
		SET @STRSQL = @STRSQL + "OPT_TRD_VAL=CONVERT(NUMERIC(18,2),ROUND(OPTIONSTRADEDVALUE,2)),"
		SET @STRSQL = @STRSQL + "EXER_VAL=CONVERT(NUMERIC(18,2),ROUND(EXCERCISEVALUE,2)),"
		SET @STRSQL = @STRSQL + "ASSG_VAL=CONVERT(NUMERIC(18,2),ROUND(ASSIGNMENTVALUE,2)),"
		SET @STRSQL = @STRSQL + "CLOSE_OUT_VAL=CONVERT(NUMERIC(18,2),ROUND(CLOSEOUTVALUE,2)),"
		SET @STRSQL = @STRSQL + "TOTAL=CONVERT(NUMERIC(18,2),ROUND(TOTAL,2)),"
		SET @STRSQL = @STRSQL + "FUT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(FUT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "OPT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(OPT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "SERVICE_TAX=CONVERT(NUMERIC(18,2),ROUND(SERVICETAX,2)),"
		SET @STRSQL = @STRSQL + "SBC_CHRG=CONVERT(NUMERIC(18,2),ROUND(SBC_CHRG,2)),"
		SET @STRSQL = @STRSQL + "KKC_CHRG=CONVERT(NUMERIC(18,2),ROUND(KKC_CHRG,2)),"
		SET @STRSQL = @STRSQL + "STT=CONVERT(NUMERIC(18,2),ROUND(INS_CHRG,2))"
	END
	IF (@CLTRANSACTIONS = "LEVIES")
	BEGIN
		SET @STRSQL = @STRSQL + "TOTAL=CONVERT(NUMERIC(18,2),ROUND(TOTAL,2)),"
		SET @STRSQL = @STRSQL + "FUT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(FUT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "OPT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(OPT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "SERVICE_TAX=CONVERT(NUMERIC(18,2),ROUND(SERVICETAX,2)),"
		SET @STRSQL = @STRSQL + "SBC_CHRG=CONVERT(NUMERIC(18,2),ROUND(SBC_CHRG,2)),"
		SET @STRSQL = @STRSQL + "KKC_CHRG=CONVERT(NUMERIC(18,2),ROUND(KKC_CHRG,2)),"
		SET @STRSQL = @STRSQL + "STT=CONVERT(NUMERIC(18,2),ROUND(INS_CHRG,2)),"
		SET @STRSQL = @STRSQL + "FUT_TURN_TAX=CONVERT(NUMERIC(18,2),ROUND(FUT_TURNOVERTAX,2)),"
		SET @STRSQL = @STRSQL + "OPT_TURN_TAX=CONVERT(NUMERIC(18,2),ROUND(OPT_TURNOVERTAX,2)),"
		SET @STRSQL = @STRSQL + "SEBI_TAX=CONVERT(NUMERIC(18,2),ROUND(SEBITAX,2)),"
		SET @STRSQL = @STRSQL + "STAMP_DUTY=CONVERT(NUMERIC(18,2),ROUND(STAMPDUTY,2)),"
		SET @STRSQL = @STRSQL + "OTHER_CHRG=CONVERT(NUMERIC(18,2),ROUND(CLEARINGCHARGES,2))"
	END
	IF (@CLTRANSACTIONS = "BOTH")
	BEGIN
		SET @STRSQL = @STRSQL + "FUT_TRD_VAL=CONVERT(NUMERIC(18,2),ROUND(FUTURESTRADEDVALUE,2)),"
		SET @STRSQL = @STRSQL + "OPT_TRD_VAL=CONVERT(NUMERIC(18,2),ROUND(OPTIONSTRADEDVALUE,2)),"
		SET @STRSQL = @STRSQL + "EXER_VAL=CONVERT(NUMERIC(18,2),ROUND(EXCERCISEVALUE,2)),"
		SET @STRSQL = @STRSQL + "ASSG_VAL=CONVERT(NUMERIC(18,2),ROUND(ASSIGNMENTVALUE,2)),"
		SET @STRSQL = @STRSQL + "CLOSE_OUT_VAL=CONVERT(NUMERIC(18,2),ROUND(CLOSEOUTVALUE,2)),"
		SET @STRSQL = @STRSQL + "TOTAL=CONVERT(NUMERIC(18,2),ROUND(TOTAL,2)),"
		SET @STRSQL = @STRSQL + "FUT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(FUT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "OPT_BROKERAGE=CONVERT(NUMERIC(18,2),ROUND(OPT_BROKERAGE,2)),"
		SET @STRSQL = @STRSQL + "SERVICE_TAX=CONVERT(NUMERIC(18,2),ROUND(SERVICETAX,2)),"
		SET @STRSQL = @STRSQL + "SBC_CHRG=CONVERT(NUMERIC(18,2),ROUND(SBC_CHRG,2)),"		
		SET @STRSQL = @STRSQL + "KKC_CHRG=CONVERT(NUMERIC(18,2),ROUND(KKC_CHRG,2)),"		
		SET @STRSQL = @STRSQL + "STT=CONVERT(NUMERIC(18,2),ROUND(INS_CHRG,2)),"
		SET @STRSQL = @STRSQL + "FUT_TURN_TAX=CONVERT(NUMERIC(18,2),ROUND(FUT_TURNOVERTAX,2)),"
		SET @STRSQL = @STRSQL + "OPT_TURN_TAX=CONVERT(NUMERIC(18,2),ROUND(OPT_TURNOVERTAX,2)),"
		SET @STRSQL = @STRSQL + "SEBI_TAX=CONVERT(NUMERIC(18,2),ROUND(SEBITAX,2)),"
		SET @STRSQL = @STRSQL + "STAMP_DUTY=CONVERT(NUMERIC(18,2),ROUND(STAMPDUTY,2)),"
		SET @STRSQL = @STRSQL + "OTHER_CHRG=CONVERT(NUMERIC(18,2),ROUND(CLEARINGCHARGES,2))"
	END
	SET @STRSQL = @STRSQL + ",TOTAL_FLAG "
	SET @STRSQL = @STRSQL + " FROM #FOTURNOVER "
	SET @STRSQL = @STRSQL + " ORDER BY "
	IF (@GROUPLEVEL = "DATE" AND @GROUPSUBLEVEL = "DATE")
	BEGIN
		SET @STRSQL = @STRSQL + "ORDFLAG,ORDDATE,ORDFIELD "
	END
	ELSE IF (@GROUPLEVEL = "DATE" OR @GROUPSUBLEVEL = "DATE")
	BEGIN
		SET @STRSQL = @STRSQL + "ORDFIELD,ORDFLAG,ORDDATE "
	END
	ELSE
	BEGIN
		SET @STRSQL = @STRSQL + "ORDFIELD,ORDFLAG "
	END
	SET @STRSQL = @STRSQL + " DROP TABLE #FOTURNOVER "


	IF (CONVERT(DATETIME,@FROMDATE,109) >= CONVERT(DATETIME,'JUL  1 2017',109))
	BEGIN
		SET @STRSQL = REPLACE(@STRSQL,'SERVICE_TAX=','GST=')
	END

	
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_SPCONFMEM0_DATA
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_SPCONFMEM0_DATA]  
(  
@PARTY_CODE VARCHAR(25),  
@CTYPE VARCHAR(5)  
)  
AS  
--EXEC CLS_SPCONFMEM0_DATA '0A141','F'  
DECLARE @COMPANY VARCHAR(100)  
DECLARE @WEBSITE_ID VARCHAR(100)  
DECLARE @EMAIL VARCHAR(100)  
DECLARE @PHONE VARCHAR(100)  
DECLARE @UID VARCHAR(50)  
DECLARE @PAWD VARCHAR(50) 
DECLARE @GLBPARAM VARCHAR(1) 
  
--SELECT COMPANY,WEBSITE_ID,EMAIL,PHONE FROM OWNER  
  
SET @COMPANY=(select COMPANY FROM OWNER)  
SET @WEBSITE_ID=(select WEBSITE_ID FROM OWNER)  
SET @EMAIL=(select EMAIL FROM OWNER)  
SET @PHONE=(select PHONE FROM OWNER)  
  
SET @UID  = (SELECT FLDUSERNAME FROM TBLPRADNYAUSERS WHERE FLDUSERNAME =@PARTY_CODE)  
SET @PAWD = (SELECT FLDPASSWORD FROM TBLPRADNYAUSERS WHERE FLDUSERNAME =@PARTY_CODE) 
  
  
SELECT * INTO #CLS_CONFMEM0_DIGITAL_DATA   
FROM CLS_CONFMEM0_DIGITAL_DATA
  
  
UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#COMPANY#',@COMPANY)

  
UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#WWW#',@WEBSITE_ID) 
  
UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#EMAIL#',@EMAIL)  
  
UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#PHONE#',@PHONE) 

SELECT @GLBPARAM = FLDENCRYPTION FROM TBLGLOBALPARAMS 

IF @GLBPARAM = 'Y'
 BEGIN 
	SET @PAWD=PRADNYA.dbo.CLASS_PWDENCRY(@PAWD)  
 END
ELSE
 BEGIN
	SET @PAWD=@PAWD 
END
  
UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#PW#',@PAWD)
WHERE C_TEXT LIKE '%#PW#%' 

UPDATE #CLS_CONFMEM0_DIGITAL_DATA  
SET C_TEXT = REPLACE(C_TEXT,'#UID#',@UID) 
WHERE C_TEXT LIKE '%#UID#%'  
  
  
SELECT * FROM #CLS_CONFMEM0_DIGITAL_DATA  
WHERE C_type=@CTYPE
AND C_TEXT IS NOT  NULL 
  
  
DROP TABLE #CLS_CONFMEM0_DIGITAL_DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_STT_CERTIFICATE
-- --------------------------------------------------




create PROCEDURE [dbo].[CLS_STT_CERTIFICATE] (
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@PARTYFROM VARCHAR(25),
	@PARTYTO VARCHAR(25),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@STRBRANCH VARCHAR(25),
	@STRBRANCHTO VARCHAR(25),
	@STRSUBBROKFROM VARCHAR(25),
	@STRSUBBROKTO VARCHAR(25),
	@DIGIFLAG VARCHAR(2)
	)
AS

--- EXEC CLS_STT_CERTIFICATE 'JAN  1 2010','DEC 31 2019','','ZZZZZZ','BROKER','BROKER','','ZZZZZZ','','ZZZZZ',0


IF LEN(LTRIM(RTRIM(@PARTYTO))) = 0
BEGIN
	SET @PARTYTO = 'ZZZZZZZZZ'
END

IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''
BEGIN
	SET @STRBRANCHTO = 'ZZZZZZZZZZZZZZ'
END

IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''
BEGIN
	SET @STRSUBBROKTO = 'ZZZZZZZZZZZ'
END

IF LEN(@DATEFROM) = 10 AND CHARINDEX('/',@DATEFROM) > 0    
  SET @DATEFROM=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATEFROM,103),109)
  
  IF LEN(@DATETO) = 10 AND CHARINDEX('/',@DATETO) > 0    
  SET @DATETO=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATETO,103),109) 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


SELECT	RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT
INTO	#STTCERT
FROM	STT_CLIENTDETAIL (NOLOCK)
WHERE	SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO


SELECT PARTY_CODE,
	TRANSACTIONCODE = '04',
	TURNOVER = SUM(TURNOVER),
	STT = SUM(STT)
INTO #STT04
FROM (
	SELECT SAUDA_DATE = LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		TURNOVER = SUM(SAMTTRD),
		STT = ROUND(SUM(SSTTTRD), 0)
	FROM #STTCERT(NOLOCK)
	WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
		AND LEFT(INST_TYPE, 3) = 'OPT'
	GROUP BY LEFT(SAUDA_DATE, 11),
		PARTY_CODE
		
	) STTDETAIL
GROUP BY PARTY_CODE
ORDER BY PARTY_CODE

SELECT PARTY_CODE,
	TRANSACTIONCODE = '05',
	TURNOVER = SUM(TURNOVER),
	STT = SUM(STT)
INTO #STT05
FROM (
	SELECT SAUDA_DATE = LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		TURNOVER = SUM(CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN SAMTTRD ELSE 0 END),
		STT = ROUND(ROUND(SUM(CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN SSTTTRD ELSE 0 END), 0) - (ROUND(SUM(CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN SSTTTRD ELSE 0 END), 0) + ROUND(SUM(CASE WHEN LEFT(INST_TYPE, 3) = 'OPT' THEN SSTTTRD ELSE 0 END), 0) - ROUND(SUM(SSTTTRD), 2)), 0)
	FROM #STTCERT(NOLOCK)
	WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
	GROUP BY LEFT(SAUDA_DATE, 11),
		PARTY_CODE
	HAVING ROUND(SUM(CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN SSTTTRD ELSE 0 END), 0) > 0
	) STTDETAIL
GROUP BY PARTY_CODE
ORDER BY PARTY_CODE

SELECT COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	'MCX COMM' EXCHANGECODE,
	MEMBERCODE,
	C2.PARTY_CODE,
	LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_ZIP,
	PAN_GIR_NO,
	' ' MAPIDID
INTO #CLIENT
FROM CLIENT1 C1(NOLOCK),
	CLIENT2 C2(NOLOCK),
	FOOWNER(NOLOCK),
	CLIENT_PRINT_SETTINGS CP(NOLOCK)
WHERE C1.CL_CODE = C2.CL_CODE
	AND PARTY_CODE >= @PARTYFROM
	AND PARTY_CODE <= @PARTYTO
	AND BRANCH_CD >= @STRBRANCH
	AND BRANCH_CD <= @STRBRANCHTO
	AND SUB_BROKER >= @STRSUBBROKFROM
	AND SUB_BROKER <= @STRSUBBROKTO
	AND C2.PRINTF = CP.PRINT_FLAG
	AND CP.VALID_REPORT LIKE (CASE WHEN @DIGIFLAG = 0 THEN '%' WHEN @DIGIFLAG = 1 THEN '%CONTRACT%' WHEN @DIGIFLAG = 2 THEN '%DIGITAL%' ELSE CP.VALID_REPORT END)
	AND BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)
	AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)
	AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)
	AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)
	AND C1.CL_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)

CREATE INDEX [PARTYCD] ON [DBO].[#CLIENT] ([PARTY_CODE])

SELECT PARTY_CODE,
	'01' TRANSACTIONCODE,
	0 TURNOVER,
	0 STT
INTO #STT01
FROM #CLIENT

SELECT PARTY_CODE,
	'02' TRANSACTIONCODE,
	0 TURNOVER,
	0 STT
INTO #STT02
FROM #CLIENT

SELECT PARTY_CODE,
	'03' TRANSACTIONCODE,
	0 TURNOVER,
	0 STT
INTO #STT03
FROM #CLIENT

CREATE INDEX [PARTYCD] ON [DBO].[#STT04] ([PARTY_CODE])

CREATE INDEX [PARTYCD] ON [DBO].[#STT05] ([PARTY_CODE])

INSERT INTO #STT04
SELECT PARTY_CODE,
	'04',
	0,
	0
FROM #CLIENT
WHERE PARTY_CODE NOT IN (
		SELECT PARTY_CODE
		FROM #STT04
		)

INSERT INTO #STT05
SELECT PARTY_CODE,
	'05',
	0,
	0
FROM #CLIENT
WHERE PARTY_CODE NOT IN (
		SELECT PARTY_CODE
		FROM #STT05
		)

SELECT S.PARTY_CODE,
	TRANSACTIONCODE,
	TURNOVER,
	STT
INTO #STT00
FROM (
	SELECT PARTY_CODE,
		TRANSACTIONCODE,
		TURNOVER,
		STT
	FROM #STT01
	
	UNION
	
	SELECT PARTY_CODE,
		TRANSACTIONCODE,
		TURNOVER,
		STT
	FROM #STT02
	
	UNION
	
	SELECT PARTY_CODE,
		TRANSACTIONCODE,
		TURNOVER,
		STT
	FROM #STT03
	
	UNION
	
	SELECT PARTY_CODE,
		TRANSACTIONCODE,
		TURNOVER,
		STT
	FROM #STT04
	
	UNION
	
	SELECT PARTY_CODE,
		TRANSACTIONCODE,
		TURNOVER,
		STT
	FROM #STT05
	) S
ORDER BY S.PARTY_CODE,
	TRANSACTIONCODE

DROP TABLE #STT01

DROP TABLE #STT02

DROP TABLE #STT03

DROP TABLE #STT04

DROP TABLE #STT05

CREATE INDEX [PARTYCD] ON [DBO].[#STT00] ([PARTY_CODE])

SELECT COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	EXCHANGECODE,
	MEMBERCODE,
	LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_ZIP,
	PAN_GIR_NO,
	ISNULL(U.MAPIDID, '') MAPINID,
	S.PARTY_CODE,
	TRANSACTIONCODE,
	TURNOVER,
	STT,
	CONVERT(VARCHAR, GETDATE(), 103) CURDATE,
	CONVERT(VARCHAR, GETDATE(), 103) TODATE,
	REC_TYPE = 1
INTO #STTCER
FROM #CLIENT C,
	#STT00 S
LEFT JOIN UCC_CLIENT U
	ON (U.PARTY_CODE = S.PARTY_CODE)
WHERE S.PARTY_CODE = C.PARTY_CODE
	AND S.PARTY_CODE IN (
		SELECT PARTY_CODE
		FROM #STT00
		GROUP BY PARTY_CODE
		HAVING SUM(STT) > 0
		)
ORDER BY UPPER(S.PARTY_CODE),
	TRANSACTIONCODE
	
SELECT COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	EXCHANGECODE,
	MEMBERCODE,
	LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_ZIP,
	PAN_GIR_NO,
	MAPINID,
	PARTY_CODE = UPPER(LTRIM(RTRIM(PARTY_CODE))),
	TRANSACTIONCODE,
	TURNOVER=CONVERT(NUMERIC(18,2),ROUND(TURNOVER,2)),
	STT=CONVERT(NUMERIC(18,2),ROUND(STT,2)),
	CURDATE,
	TODATE,
	REC_TYPE,
	ORD_PARTYCODE = UPPER(LTRIM(RTRIM(PARTY_CODE))),
	FILENAME = UPPER(LTRIM(RTRIM(PARTY_CODE))) + '_' + CONVERT(VARCHAR,GETDATE(),112) +'_MCXCOMM_STTCERTIFICATE'
FROM #STTCER

UNION ALL

SELECT COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	EXCHANGECODE,
	MEMBERCODE,
	LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_ZIP,
	PAN_GIR_NO,
	MAPINID,
	PARTY_CODE = UPPER(LTRIM(RTRIM(PARTY_CODE))),
	TRANSACTIONCODE = 'TOTAL',
	TURNOVER=CONVERT(NUMERIC(18,2),ROUND(SUM(TURNOVER),2)),
	STT=CONVERT(NUMERIC(18,2),ROUND(SUM(STT),2)),
	CURDATE,
	TODATE,
	REC_TYPE = 2,
	ORD_PARTYCODE = '',
	FILENAME = ''
FROM #STTCER
GROUP BY COMPANY,
	ADDR1,
	ADDR2,
	CITY,
	ZIP,
	PHONE,
	EXCHANGECODE,
	MEMBERCODE,
	LONG_NAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_ZIP,
	PAN_GIR_NO,
	MAPINID,
	PARTY_CODE,
	CURDATE,
	TODATE
ORDER BY 
	PARTY_CODE,
	REC_TYPE

	
		

DROP TABLE #STT00
DROP TABLE #STTCER
DROP TABLE #STTCERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_STTANNEXURE
-- --------------------------------------------------



create PROC [dbo].[CLS_STTANNEXURE]
	(  
	@FROMDATE	VARCHAR(11),   
	@TODATE		VARCHAR(11),
	@FROMPARTY	VARCHAR(20),   
	@TOPARTY	VARCHAR(20),
	@STATUSID	VARCHAR(15),   
	@STATUSNAME VARCHAR(25),
	@OUT_FLAG	VARCHAR(1) = 'D',
	@RPT_TYPE	INT = 0,
	@CONTRACTNO	VARCHAR(10) = ''
	)  

	AS  
  
	/*
	EXEC mcdx..CLS_STTANNEXURE '11/03/2015','11/03/2015','','ZZZZZZZ','BROKER','BROKER'
	EXEC .[CLS_STTANNEXURE] @FROMDATE='22/07/2011',@TODATE='22/07/2014',@FROMPARTY='',@TOPARTY='',@STATUSID='BROKER',@STATUSNAME='BROKER',@OUT_FLAG='P',@RPT_TYPE=1
	*/
	
	SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
	SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZZ'
	END

	SELECT	*, ORD_FLAG=1 
	INTO	#STT_CLIENTDETAIL
	FROM	STT_CLIENTDETAIL (NOLOCK)
	WHERE	PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND	SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
			AND CONTRACTNO = (CASE WHEN @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END)
			AND	SQTYTRD > 0 
			AND	LEN(LTRIM(RTRIM(CONTRACTNO))) > 0
			AND	TOTALSTT > 0

	CREATE INDEX [INDXSTT] ON #STT_CLIENTDETAIL ([PARTY_CODE],[SAUDA_DATE],[CONTRACTNO])
	
	SELECT	PARTY_CODE, COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, COMP_FAX = O.FAX, COMP_EMAIL = O.EMAIL, EXCHANGECODE = 'NCX', MEMBERCODE,
			LONG_NAME, PAN_GIR_NO,BRANCH_CD, SUB_BROKER, L_ADDRESS1,L_ADDRESS2, L_ADDRESS3, L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,EMAIL=C1.EMAIL,
			MAPIDID = CONVERT(VARCHAR(20),'')
	INTO	#CLIENTMASTER
	FROM	CLIENT1 C1 (NOLOCK),
			CLIENT2 C2 (NOLOCK),
			FOOWNER O (NOLOCK)		
	WHERE	C1.CL_CODE = C2.CL_CODE
			AND	EXISTS (SELECT DISTINCT PARTY_CODE FROM #STT_CLIENTDETAIL S WHERE S.PARTY_CODE = C2.PARTY_CODE)
			AND	C2.INSURANCE_CHRG = 1 
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'	THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'	THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'	THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'		THEN C1.AREA
				WHEN @STATUSID = 'REGION'	THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'	THEN C2.PARTY_CODE
				ELSE 'BROKER'
			END)

	CREATE INDEX [INDXCLIENT] ON #CLIENTMASTER ([PARTY_CODE])

	IF @RPT_TYPE = 0
	BEGIN
		
		SELECT
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTALSTT),2)),
			ORD_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,112)
		FROM
			#STT_CLIENTDETAIL S,
			#CLIENTMASTER C
		WHERE
			S.PARTY_CODE = C.PARTY_CODE
		GROUP BY
			LTRIM(RTRIM(S.PARTY_CODE)),
			ISNULL(LONG_NAME,''),
			CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACTNO
		ORDER BY
			LTRIM(RTRIM(S.PARTY_CODE)),	
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACT_NO
			
	END
	ELSE
	BEGIN

		UPDATE	#CLIENTMASTER
		SET		MAPIDID = ISNULL(U.MAPIDID, '')
		FROM	UCC_CLIENT U (NOLOCK)
		WHERE	U.PARTY_CODE = #CLIENTMASTER.PARTY_CODE		
		
		/*
		ALTER TABLE #STT_CLIENTDETAIL_NEW
		ALTER COLUMN TRADE_DATE VARCHAR(11)	

		UPDATE #STT_CLIENTDETAIL	
		SET  SAUDA_DATE = (CASE WHEN ORD_FLAG=1 THEN CONVERT(VARCHAR,'TOTAL') ELSE CONVERT(VARCHAR,CONVERT(DATETIME,SAUDA_DATE, 109),103) END)
		*/		

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
		SELECT  
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			SCRIP_CODE = INST_TYPE + ' ' + SYMBOL + ' ' + LEFT(EXPIRYDATE,11) 
						+ (CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN  ' ' + CAST(CAST(STRIKE_PRICE AS NUMERIC(18,2)) AS VARCHAR) + ' ' + OPTION_TYPE ELSE '' END),
			SELL_QTY = CONVERT(NUMERIC(18,2),ROUND(SQTYTRD,2)), 
			--TRD_SELL_PRICE = CONVERT(NUMERIC(18,2),ROUND(TRDPRICE,2)), 
			FUT_SELL_AMOUNT = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN CONVERT(NUMERIC(18,2),ROUND(SAMTTRD,2)) ELSE 0 END), 
			FUT_SELL_STT = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN CONVERT(NUMERIC(18,2),ROUND(SSTTTRD,2)) ELSE 0 END), 
			OPT_SELL_AMOUNT = (CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN CONVERT(NUMERIC(18,2),ROUND(SAMTTRD,2)) ELSE 0 END), 
			OPT_SELL_STT = (CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN CONVERT(NUMERIC(18,2),ROUND(SSTTTRD,2)) ELSE 0 END), 
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(TOTALSTT,2)),
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1 = ADDR1, COMP_ADDRES2 = ADDR2, 
			COMP_CITY = CITY, COMP_ZIP = ZIP, COMP_PHONE = PHONE, COMP_FAX, 
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = CONVERT(VARCHAR,SAUDA_DATE,112),
			ORD_FLAG
		INTO
			#STT_CLIENTDETAIL_NEW
		FROM  
			#STT_CLIENTDETAIL S (NOLOCK),
			#CLIENTMASTER C (NOLOCK)
		WHERE  
			S.PARTY_CODE = C.PARTY_CODE 


		INSERT INTO #STT_CLIENTDETAIL_NEW
		SELECT
			TRADE_DATE = 'TOTAL',
			CONTRACT_NO = '',
			SCRIP_CODE = '',
			TRD_SELL_QTY = 0, 
			--TRD_SELL_PRICE = 0, 
			--TRD_SELL_AMOUNT = 0, 
			--TRD_SELL_STT = 0, 
			FUT_SELL_AMOUNT = 0, 
			FUT_SELL_STT = 0, 
			OPT_SELL_AMOUNT = 0, 
			OPT_SELL_STT = 0,
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTAL_STT),2)),
			CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
			CLIENT_NAME = '',
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
			COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = '',
			ORD_FLAG=2
		FROM	
			#STT_CLIENTDETAIL_NEW
		GROUP BY	
				LTRIM(RTRIM(CLIENT_CODE)),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE

		IF @OUT_FLAG NOT IN ('P','D')
		BEGIN
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN CONTRACT_NO VARCHAR(100)	

  			/*
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN SCRIP_CODE VARCHAR(100)	
			*/	

  			INSERT INTO #STT_CLIENTDETAIL_NEW
			SELECT
				DISTINCT
				TRADE_DATE = LTRIM(RTRIM(CLIENT_CODE)),
				CONTRACT_NO = ISNULL(CLIENT_NAME,''),
				SCRIP_CODE = '',
				TRD_SELL_QTY = 0, 
				--TRD_SELL_PRICE = 0, 
				--TRD_SELL_AMOUNT = 0, 
				--TRD_SELL_STT = 0, 
				FUT_SELL_AMOUNT = 0, 
				FUT_SELL_STT = 0, 
				OPT_SELL_AMOUNT = 0, 
				OPT_SELL_STT = 0,
				TOTAL_STT = 0,
				CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
				CLIENT_NAME = ISNULL(CLIENT_NAME,''),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE,
				ORDDATE = 'HEADER',
				ORD_FLAG=0
			FROM	
				#STT_CLIENTDETAIL_NEW
			WHERE 
				TRADE_DATE <> 'TOTAL'
		END	
		
			
		SELECT 
			TRADE_DATE,
			CONTRACT_NO,
			SRNO = ROW_NUMBER() OVER (PARTITION BY CLIENT_CODE ORDER BY CLIENT_CODE, ORD_FLAG ASC, CONTRACT_NO, ORDDATE, SCRIP_CODE),			
			SCRIP_CODE,
			SELL_QTY, 
			FUT_SELL_AMOUNT, 
			FUT_SELL_STT, 
			OPT_SELL_AMOUNT,
			OPT_SELL_STT,
			TOTAL_STT,
			CLIENT_CODE,
			CLIENT_NAME,
			PAN_GIR_NO,
			L_ADDRESS1,
			L_ADDRESS2,
			L_CITY,
			L_STATE,
			L_NATION,
			L_ZIP,
			RES_PHONE1,
			RES_PHONE2,
			MAPIDID,
			BRANCH_CD,
			SUB_BROKER,
			COMPANY,
			COMP_ADDRES1,
			COMP_ADDRES2,
			COMP_CITY,
			COMP_ZIP,
			COMP_PHONE,
			COMP_FAX, 
			COMP_EMAIL, 
			EXCHANGECODE, 
			MEMBERCODE,
			ORDDATE,
			ORD_FLAG,
			REPORT_PERIOD = @FROMDATE + ' - ' + @TODATE 
		FROM #STT_CLIENTDETAIL_NEW
		WHERE ORD_FLAG<>0
		ORDER BY  
			CLIENT_CODE, 
			ORD_FLAG ASC,
			CONTRACT_NO, 
			ORDDATE, 
			SCRIP_CODE
		
		DROP TABLE #STT_CLIENTDETAIL_NEW
		
	END	

	DROP TABLE #STT_CLIENTDETAIL
	DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRADE_IMPORT
-- --------------------------------------------------





CREATE  PROC [dbo].[CLS_TRADE_IMPORT]
(          
 @FILETYPE  VARCHAR(20),          
 @SAUDA_DATE  VARCHAR(11),          
 @FILEPATH  VARCHAR(2000),
 @STEP VARCHAR(25), 
 @PROCESS_FOR VARCHAR(100) = 'IMPORT_TRADE',  
 @IMPORTTYPE  VARCHAR(10)       
) 
/*
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='SECURITY',@SAUDA_DATE='26/06/2019',@FILEPATH='D:\BACKOFFICE\TRADE\NSEEQ$SCRIP_260619.TXT|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='CP',@SAUDA_DATE='27/06/2019',@FILEPATH='D:\BACKOFFICE\TRADE\NSECASHFILEUPLOADED$27060000.MD|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='C_STT',@SAUDA_DATE='28/06/2019',@FILEPATH='D:\BACKOFFICE\TRADE\NSECASHFILEUPLOADED$C_STT_26062019.CSV|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='MWST',@SAUDA_DATE='28/06/2019',@FILEPATH='D:\BACKOFFICE\TRADE\NSECASHFILEUPLOADED$MWST_06769_T_27062019.CSV|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='C_VAR',@SAUDA_DATE='28/06/2019',@FILEPATH='D:\BACKOFFICE\TRADE\NSEEQ$C_VAR1_14062019_6.DAT|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
	EXEC DBO.[CLS_TRADE_IMPORT] @FILETYPE='C_STT',@SAUDA_DATE='28/06/2019',@FILEPATH='D:\BACKOFFICE\TRADEFILES\NSE$C_STC_MAR2018_26032018.CSV|',@STEP='1',@PROCESS_FOR='IMPORT_EXCHANGE_FILE',@IMPORTTYPE='BULK'
*/           
AS
	DECLARE 
		@FILESINGLE VARCHAR(1000),
		@LOOPID INT,
		@DEFPATH VARCHAR(500),
		@IMPFILE VARCHAR(500),
		@SQL VARCHAR(8000),
		@PROCID VARCHAR(50),
		@MESSAGE VARCHAR(100)
		SET @MESSAGE = 'FILE UPLOADED SUCCESSFULLY'

IF LEN(@SAUDA_DATE) = 10 AND CHARINDEX('/', @SAUDA_DATE) > 0  
 BEGIN  
  SET @SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)  
 END 

DECLARE		
	@SNO   NUMERIC(18,0),          
	@SUBPROCESSID INT          

SELECT @SNO = SNO, @SUBPROCESSID = SUB_PROCESS_ID FROM CLS_TBL_PROCESS_DETAIL WHERE PROCESS_FOR = @PROCESS_FOR  
   
IF @PROCESS_FOR = 'IMPORT_TRADE'
BEGIN
   IF @STEP = 'START_IMP'
   BEGIN
	TRUNCATE TABLE FOFTTRADE_1_IMP    
	TRUNCATE TABLE FOFTTRADE_2_IMP    
	TRUNCATE TABLE FOFTTRADE_3_IMP    
	TRUNCATE TABLE FOFTTRADE_4_IMP     
	TRUNCATE TABLE FOFTTRADE
	TRUNCATE TABLE FOTRADE

    DELETE CLS_TBL_PROCESS_DETAIL WHERE PROCESS_TYPE = 'TRADE' 
    INSERT INTO CLS_TBL_PROCESS_DETAIL (PROCESS_DATE, BUSINESS_DATE,EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,SUB_PROCESS_ID,PROCESS_START_DATE,PROCESS_STARTED_DATE,PROCESS_END_DATE,PROCESS_ENDED_DATE,PROCESS_STATUS,PROCESS_HALTED_AT,INTERNAL_PROCESS_ID) VALUES 
	( @SAUDA_DATE, @SAUDA_DATE, 'NCE','FUTURES','TRADE', @PROCESS_FOR,0,0,GETDATE(),GETDATE(),GETDATE(),GETDATE(),99,'','START_IMP')
	SET @SUBPROCESSID = 0
	SET @SNO = @@IDENTITY
	
	IF @IMPORTTYPE = 'NORMAL'
	 BEGIN
		EXEC CLS_IMPORT_TRADE_FILE @FILEPATH, 'SYSTEM', @SAUDA_DATE, 1, @FILETYPE
		EXEC CLS_PROC_TRADE_NSEFURFO_UP @SNO, @SUBPROCESSID, @FILETYPE, @SAUDA_DATE ,@FILESINGLE, @STEP,@IMPORTTYPE
	 END
	ELSE IF @IMPORTTYPE = 'BULK'
	 BEGIN
	    TRUNCATE TABLE FOFTTRADE_1_IMP
		TRUNCATE TABLE FOFTTRADE_2_IMP
		TRUNCATE TABLE FOFTTRADE_3_IMP
		TRUNCATE TABLE FOFTTRADE_4_IMP	
		TRUNCATE TABLE FOFTTRADE
		IF @FILETYPE = 'EXCHANGE'
		 BEGIN
			--EXEC CLS_IMPORT_TRADE_FILE @FILEPATH, 'SYSTEM', @SAUDA_DATE, 1, @FILETYPE	
			EXEC PROC_TRADE_UP @SNO, @SUBPROCESSID, @FILETYPE, @SAUDA_DATE ,@FILESINGLE--, @STEP,@IMPORTTYPE
		 END
        ELSE
		BEGIN
		    SET @LOOPID = 1
			SET @DEFPATH = .DBO.PIECE(@FILEPATH, '$', 1)
			SET @FILEPATH = .DBO.PIECE(@FILEPATH, '$', 2)
			WHILE 1 = 1
			BEGIN
			
				SET @FILESINGLE = .DBO.PIECE(@FILEPATH, '|', @LOOPID)
				IF @FILESINGLE = '' OR @FILESINGLE IS NULL
					BEGIN
						BREAK
					END
				SET @FILESINGLE = @DEFPATH + '\' + @FILESINGLE
				PRINT @FILESINGLE
				EXEC CLS_IMPORT_TRADE_FILE @FILESINGLE, 'SYSTEM', @SAUDA_DATE, 2, @FILETYPE
				SET @LOOPID = @LOOPID + 1
			END
			EXEC CLS_PROC_TRADE_NSEFURFO_UP @SNO, @SUBPROCESSID, @FILETYPE, @SAUDA_DATE ,@FILESINGLE, @STEP,@IMPORTTYPE
		END
		
	 END
	END
   ELSE -- NEXT STEP 
    BEGIN
		EXEC CLS_PROC_TRADE_NSEFURFO_UP @SNO, @SUBPROCESSID, @FILETYPE, @SAUDA_DATE ,@FILESINGLE, @STEP,@IMPORTTYPE
	END
	SELECT * FROM CLS_TBL_PROCESS_DETAIL WHERE PROCESS_FOR = @PROCESS_FOR --AND PROCESS_STATUS <> 100 
END
ELSE
 BEGIN

	SET @IMPFILE = @FILETYPE

	IF @IMPFILE <> 'TRADE'
	BEGIN
		SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
	END
	
    
	DELETE CLS_TBL_PROCESS_DETAIL WHERE PROCESS_TYPE <> 'TRADE' 
    INSERT INTO CLS_TBL_PROCESS_DETAIL (PROCESS_DATE, BUSINESS_DATE,EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,SUB_PROCESS_ID,PROCESS_START_DATE,PROCESS_STARTED_DATE,PROCESS_END_DATE,PROCESS_ENDED_DATE,PROCESS_STATUS,PROCESS_HALTED_AT) VALUES ( @SAUDA_DATE, @SAUDA_DATE, 'NSE','CAPITAL','IMPORT_EXCHANGE_FILE', @PROCESS_FOR,0,0,GETDATE(),GETDATE(),GETDATE(),GETDATE(),0,'')
	SELECT @SNO = SNO, @SUBPROCESSID = SUB_PROCESS_ID FROM CLS_TBL_PROCESS_DETAIL WHERE PROCESS_FOR = @PROCESS_FOR  
	SET @SUBPROCESSID = 0
	
	SET @LOOPID = 1
	SET @FILEPATH = .DBO.PIECE(REPLACE(@FILEPATH,'|',''), '$', 1)
	--SET @FILEPATH = .DBO.PIECE(@FILEPATH, '$', 2)
	WHILE 1 = 1
		BEGIN
			
			SET @FILESINGLE = .DBO.PIECE(@FILEPATH, '|', @LOOPID)
			IF @FILESINGLE = '' OR @FILESINGLE IS NULL
			BEGIN
				BREAK
			END
			IF @IMPORTTYPE = 'NORMAL'
			BEGIN
				SET @PROCID = @FILEPATH
				IF @IMPFILE ='CLOSING'
				BEGIN
					SET @FILEPATH = @SAUDA_DATE
				END
			END

			SET @FILESINGLE = @FILEPATH  --@DEFPATH+ '\' + @FILESINGLE
			PRINT @FILESINGLE

			IF @IMPFILE = 'CONTRACT'
			BEGIN
				BEGIN TRY
					EXEC PROC_CONTRACT_MST @FILESINGLE, @SAUDA_DATE,@PROCID
				END TRY
				BEGIN CATCH
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END
			IF @IMPFILE = 'CLOSING'
			BEGIN
				BEGIN TRY
					EXEC PROC_FOCLOSING_MD_UP @FILESINGLE, @SAUDA_DATE ,@PROCID
				END TRY
				BEGIN CATCH
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END
			IF @IMPFILE = 'POSITION'
			BEGIN
				BEGIN TRY
					EXEC PROC_POSITION_PS04_UP  @FILESINGLE, @SAUDA_DATE ,@PROCID
				END TRY
				BEGIN CATCH
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END
			IF @IMPFILE = 'MARGIN'
			BEGIN
				BEGIN TRY
					EXEC PROC_MARGIN_MG13_UP  @FILESINGLE, @SAUDA_DATE ,@PROCID
				END TRY
				BEGIN CATCH
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END

					IF @IMPFILE = 'CTT'
			BEGIN
				BEGIN TRY
					EXEC PROC_STT_STT01_UP  @FILESINGLE, @SAUDA_DATE ,@PROCID
				END TRY
				BEGIN CATCH
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END
			  

				IF @IMPFILE = 'MRG_INTRADAY'
			BEGIN
				BEGIN TRY
					EXEC CLS_BULK_MARGINUPLOAD_INTRADAY  @FILESINGLE, @SAUDA_DATE, @PROCID
				END TRY
				BEGIN CATCH 
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END

			IF @IMPFILE = 'POS_UDIFF' 
			BEGIN
			BEGIN TRY
			EXEC PROC_POSITION_PS04_UP_UDIFF  @FILESINGLE, @SAUDA_DATE, @PROCID
			END TRY
			BEGIN CATCH
			SELECT @MESSAGE = ERROR_MESSAGE()
			END CATCH
			END

			IF @IMPFILE = 'MRG_UDIFFEOD'
			BEGIN
				BEGIN TRY
					EXEC PROC_MARGIN_MG13_UP_UDIFF_EOD  @FILESINGLE, @SAUDA_DATE, @PROCID
				END TRY
				BEGIN CATCH 
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END

			IF @IMPFILE = 'MRGPEAKUDIFF'
			BEGIN
				BEGIN TRY
					EXEC PROC_MARGIN_MG13_UP_UDIFF_PEAK  @FILESINGLE, @SAUDA_DATE, @PROCID
				END TRY
				BEGIN CATCH 
					SELECT @MESSAGE = ERROR_MESSAGE() 
				END CATCH
			END


			SET @LOOPID = @LOOPID + 1
		END
	
	IF @IMPFILE = 'CONTRACT'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOSCRIP_IMP ) A "
	END
	IF @IMPFILE = 'CLOSING'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOEXERCISEALLOCATION WHERE LEFT(FOEA_POSITION_DATE,11) = '" + @SAUDA_DATE + "'  ) A "
	END
	IF @IMPFILE = 'POSITION'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOEXERCISEALLOCATION_TEMP ) A "
	END
	IF @IMPFILE = 'MARGIN'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS : ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOMARGINNEW_IMP) A "
	END

	IF @IMPFILE = 'MRG_INTRADAY'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS : ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOMARGINNEW_INTRADAY_IMP) A "
		
		
	END

		IF @IMPFILE = 'CTT'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM STT_EXCHG WHERE LEFT(STT_DATE,11) = '" + @SAUDA_DATE + "'  ) A "
	END
	
	
	
	IF @IMPFILE = 'POSITION_STD'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOEXERCISEALLOCATION_TEMP_STD ) A "
	END
	IF @IMPFILE = 'MARGIN_STD' OR @IMPFILE = 'MARGIN_EOD'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS : ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOMARGINNEW_IMP_STD ) A "
	END
	IF @IMPFILE = 'CONTRACT_STD'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOSCRIP_IMP_STD ) A "
	END
	IF @IMPFILE = 'POS_UDIFF' 
	BEGIN
	SET @SQL = ""
	SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 1 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS - ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM FOEXERCISEALLOCATION_TEMP ) A "
	END

	IF @IMPFILE = 'MRG_UDIFFEOD'
	BEGIN
		SET @SQL = ""
		SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS : ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM TBL_FOMARGINNEW_UDIFF_EOD WHERE LEFT(MARGINDATE,11) = '" + @SAUDA_DATE + "') A "
	END

	IF @IMPFILE = 'MRGPEAKUDIFF'
			BEGIN
				SET @SQL = ""
				SET @SQL = " SELECT *  FROM ( SELECT FLAG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE -1 END), MSG = (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 'FILE UPLOADED SUCCESSFULLY WITH NO OF ROWS : ' + CONVERT(VARCHAR,ISNULL(COUNT(1),0)) ELSE 'NO DATA FOUND IN THE FILE OR FILE IS NOT CORRECT.' END) FROM TBL_FOMARGINNEW_UDIFF_EOD WHERE LEFT(MARGINDATE,11) = '" + @SAUDA_DATE + "') A "
			END



	print @sql

	UPDATE [CLS_TBL_PROCESS_DETAIL] SET SUB_PROCESS_ID = 0,          
	PROCESS_HALTED_REASON = @MESSAGE,          
	PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE(),          
	PROCESS_OUTPUT_QUERY = @SQL, PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'          
	WHERE SNO = @SNO 

	SELECT * FROM CLS_TBL_PROCESS_DETAIL WHERE PROCESS_FOR = @PROCESS_FOR --AND PROCESS_STATUS <> 100 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_V2_GETMARGINREQ
-- --------------------------------------------------




--EXEC CLS_V2_GETMARGINREQ 'JUL  1 2016' ,'sep 30 2016', 'IIFLCAOF', 'IIFLCAOF', 'BROKER', 'BROKER', ''


CREATE PROCEDURE [dbo].[CLS_V2_GETMARGINREQ]
	@FROM_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@FROM_CODE VARCHAR(10),
	@TO_CODE VARCHAR(10),
	@STATUSID VARCHAR(10),
	@STATUSNAME VARCHAR(10),
	@STRBRANCH VARCHAR(10)
AS	

DECLARE
	@BACKDATE VARCHAR(11),
	@EXCHANGE VARCHAR(20)

SET @EXCHANGE = 'NSEFO'

IF LEN(@FROM_DATE) = 10
BEGIN
	SELECT @FROM_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 103), 109)
	SELECT @TO_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TO_DATE, 103), 109)
END

SELECT @BACKDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 109), 109)

CREATE TABLE #GET_MARGIN_REQ
 (VOUDT DATETIME,        
               EFFDT DATETIME,        
               SHORTDESC VARCHAR(100),        
               DRAMT MONEY,        
               CRAMT MONEY,        
               VNO VARCHAR(12),        
               DDNO VARCHAR(20),        
               NARRATION VARCHAR(200),        
               CLTCODE VARCHAR(10),        
               VTYP INT,        
               VDT VARCHAr(10),        
             EDT VARCHAr(10)) 


CREATE TABLE #CL_LIST
(
	PARTY_CODE VARCHAR(10),
	FROMDATE DATETIME,
	TODATE DATETIME,
	CHARGED INT
)

--SELECT * FROM MSAJAG..CLIENT_MDATEWISE CD (NOLOCK)

INSERT INTO #CL_LIST
SELECT PARTY_CODE,FROM_DATE = @FROM_DATE,TO_DATE = @TO_DATE,MARGIN = 0 FROM MSAJAG..CLIENT_DETAILS C/*, (SELECT * FROM MSAJAG..CLIENT_MDATEWISE (NOLOCK) WHERE EXCHANGE = 'NSE' AND SEGMENT = 'FUTURES') CD*/ 
WHERE 
 C.PARTY_CODE BETWEEN @FROM_CODE AND @TO_CODE
AND BRANCH_CD LIKE CASE WHEN @STRBRANCH <> '' THEN @STRBRANCH ELSE BRANCH_CD END
AND @STATUSNAME = (CASE 
                    WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                    WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                    WHEN @STATUSID = 'TRADER' THEN TRADER
                    WHEN @STATUSID = 'FAMILY' THEN FAMILY
                    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE
                    ELSE 'BROKER'
                END)
--AND (@FROM_DATE BETWEEN FROM_DATE And TO_DATE Or @TO_DATE BETWEEN FROM_DATE And TO_DATE)
--AND ((@FROM_DATE BETWEEN FROM_DATE And TO_DATE Or @TO_DATE BETWEEN FROM_DATE And TO_DATE) or (FROM_DATE > @FROM_DATE and TO_DATE < @TO_DATE))



INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = MDATE, 
	EFFDT = MDATE, 
	SHORTDESC = '0IM', DRAMT = INITIALMARGIN,  CRAMT = 0, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-INITIAL MARGIN AS ON'+CONVERT(VARCHAR(11), MDATE, 109),
	CLTCODE = C.PARTY_CODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), MDATE, 103),
    EDT = CONVERT(VARCHAR(10), MDATE, 103)
FROM GET_MARGIN_REQ_LEDGER F, #CL_LIST C
WHERE MDATE BETWEEN @FROM_DATE AND @TO_DATE
AND MDATE BETWEEN FROMDATE AND TODATE
AND F.PARTY_CODE = C.PARTY_CODE
AND INITIALMARGIN > 0



INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = MDATE, 
	EFFDT = MDATE, 
	SHORTDESC = '0EX', DRAMT = CASE WHEN CHARGED = 0 THEN Mtom ELSE 0 END,  CRAMT = 0, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-EXPOSURE MARGIN AS ON'+CONVERT(VARCHAR(11), MDATE, 109),
	CLTCODE = C.PARTY_CODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), MDATE, 103),
    EDT = CONVERT(VARCHAR(10), MDATE, 103)
FROM GET_MARGIN_REQ_LEDGER F, #CL_LIST C
WHERE MDATE BETWEEN @FROM_DATE AND @TO_DATE
AND MDATE BETWEEN FROMDATE AND TODATE
AND F.PARTY_CODE = C.PARTY_CODE
AND CASE WHEN CHARGED = 0 THEN Mtom ELSE 0 END > 0

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = MDATE, 
	EFFDT = MDATE, 
	SHORTDESC = '0DL', DRAMT = CASE WHEN CHARGED = 0 THEN DEL_MARGIN ELSE 0 END,  CRAMT = 0, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-DELIVERY MARGIN AS ON'+CONVERT(VARCHAR(11), MDATE, 109),
	CLTCODE = C.PARTY_CODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), MDATE, 103),
    EDT = CONVERT(VARCHAR(10), MDATE, 103)
FROM GET_MARGIN_REQ_LEDGER F, #CL_LIST C
WHERE MDATE BETWEEN @FROM_DATE AND @TO_DATE
AND MDATE BETWEEN FROMDATE AND TODATE
AND F.PARTY_CODE = C.PARTY_CODE
AND CASE WHEN CHARGED = 0 THEN DEL_MARGIN ELSE 0 END > 0


 SELECT ID = (ROW_NUMBER() OVER(ORDER BY START_DATE ASC)), SETT_DATE=START_DATE INTO #TEMP_SETTMST_MARGINCOLL  FROM MSAJAG..SETT_MST WHERE SETT_TYPE = 'N' AND START_DATE>=@FROM_DATE AND START_DATE <= dateadd(D, 5, convert(datetime, @TO_DATE, 109)) +' 23:59' ORDER BY START_DATE ASC 

ALTER TABLE #TEMP_SETTMST_MARGINCOLL
ADD NEW_DATE DATETIME

UPDATE A SET NEW_DATE = (SELECT SETT_DATE FROM #TEMP_SETTMST_MARGINCOLL A1 WHERE A1.ID = A.ID+1)
FROM #TEMP_SETTMST_MARGINCOLL A


INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0IM R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-INITIAL MARGIN REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0IM'

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0EX R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-EXPOSURE MARGIN REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0EX'

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0DL R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-DELIVERY MARGIN REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0DL'

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0AM R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-ASM REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0AM'

DECLARE
	@MDATE DATETIME

SELECT @MDATE = MAX(MDATE) FROM GET_MARGIN_REQ_LEDGER WHERE MDATE <= @TO_DATE

SELECT * FROM #GET_MARGIN_REQ WHERE EFFDT <= @MDATE AND (DRAMT <> 0 OR CRAMT <> 0)  ORDER BY CLTCODE, VDT, SHORTDESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Console_Log
-- --------------------------------------------------


CREATE Proc Console_Log 
(
	@Party_Code varchar (10) ,
	@New_Party_Code varchar (10) ,
	@Sauda_Date varchar(11) ,
	@Inst_Type varchar (6)  ,
	@Symbol varchar (12)  ,
	@Expirydate Varchar(11)  ,
	@Strike_Price money  ,
	@Option_Type varchar (2)  ,
	@Order_No varchar (20)  ,
	@Trade_No varchar (20)  ,
	@Sell_Buy varchar (1)  ,
	@Contract_No varchar (20)  ,
	@New_Contract_No varchar (20)  ,
	@Brokerage numeric(18, 4)  ,
	@New_Brokerage numeric(18, 4)  ,
	@Market_Rate numeric(18, 4)  ,
	@New_Market_Rate numeric(18, 4)  ,
	@Net_Rate numeric(18, 4)  ,
	@New_net_rate numeric(18, 4)  ,
	@Qty bigint  ,
	@New_Qty bigint  ,
	@RoundTo int  ,
	@Participant_Code varchar (20)  ,
	@New_Participant_Code varchar (20)  ,
	@Username varchar (25)  ,
	@Module varchar (50)  ,
	@Called_From varchar (100)  
)
As
if @Sauda_Date <>'' and PATINDEX('%/%',@Sauda_Date) >0
Begin
	Select @Sauda_Date= Left(Convert(datetime,@Sauda_Date,103),11)
End

if @Expirydate <> ''  and PATINDEX('%/%',@Expirydate) >0
Begin
	Select @Expirydate=Left(Convert(datetime,@Expirydate,103),11)
End
if @Expirydate = '%'  Set @Expirydate = ''

Insert Into Inst_Log Values 
(
	@Party_Code,@New_Party_Code,@Sauda_Date,@Inst_Type,@Symbol,@Expirydate,@Strike_Price,@Option_Type,
	@Order_No,@Trade_No,@Sell_Buy,@Contract_No,@New_Contract_No,@Brokerage,@New_Brokerage,@Market_Rate,
	@New_Market_Rate,@Net_Rate,@New_net_rate,@Qty,@New_Qty,@RoundTo,@Participant_Code,@New_Participant_Code,
	@UserName,@Module,@Called_From,GetDate(),'','',''
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ContractDetailNCDX
-- --------------------------------------------------
CREATE  proc [dbo].[ContractDetailNCDX](  
@sdate varchar(11),  
@contractno varchar(7),  
@party_code varchar(10))  
As  
select f.order_no, f.Trade_no, fos2.Qty_Unit, fos2.PriceUnit,LEFT(CONVERT(VARCHAR,f.SAUDA_DATE,108),11) as tradetime,  
security = f.Symbol + f.Inst_type + left(f.Expirydate,11) + convert(varchar,f.Strike_price) + f.Option_type,  
pqty = (case when sell_buy = 1 then tradeqty else 0 end),  
sqty = (case when sell_buy = 2 then tradeqty else 0 end),  
prate = (case when sell_buy = 1 then isnull(price,0) else 0 end),  
srate = (case when sell_buy = 2 then isnull(price,0) else 0 end),  
pbrok =(case when sell_buy = 1 then  isnull((brokapplied + (case when c2.service_chrg=1 then isnull(f.SERVICE_TAX/tradeqty,0) Else 0 end )),0) else 0 end),  
sbrok =(case when sell_buy = 2 then  isnull((brokapplied + (case when c2.service_chrg=1 then isnull(f.SERVICE_TAX/tradeqty,0) Else 0 end )),0) else 0 end),  
 isnull(netrate,0) netrate, isnull(amount,0) amount ,inst_type = (case when f.auctionpart = 'EA' then stuff(f.inst_type,1,3,'EA-')   
          else f.inst_type end ),  
 f.symbol,  
 pAmt=(case when sell_buy = 1 then (tradeqty * netrate) * (booktype/instrument)  
            else 0   
            end),  
sAmt=(case when sell_buy = 2 then(tradeqty * netrate) * (booktype/instrument)else 0 end) ,
LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,  
f.party_code,sell_buy,contractno,convert(varchar,sauda_date,103) as sauda_date,  
isnull(f.strike_price,0), f.strike_price, f.option_type,  
pservice_Tax=  (case when sell_buy = 1 then  (cASE WHEN c2.service_chrg=0 THEN (f.service_tax) ELSE  
                  (CASE WHEN c2.service_chrg=1  THEN 0 ELSE  
                   (cASE WHEN c2.service_chrg=2 THEN  0  END) END) END) else 0 end),  
sservice_Tax=  (case when sell_buy = 2 then  (cASE WHEN c2.service_chrg=0 THEN (f.service_tax) ELSE  
                  (CASE WHEN c2.service_chrg=1  THEN 0 ELSE  
                   (cASE WHEN c2.service_chrg=2 THEN  0 END) END) END) else 0 end),  
 year(sauda_date),month(sauda_date),day(sauda_date),DFlag = 1  
 From fosettlement f, client1 c1 , client2 c2, FOSCRIP2 fos2  
   
 where f.party_code >= @party_code and f.party_code <= @party_code and convert(Varchar,sauda_date,103) = @sdate  
and contractno = @contractno  and tradeqty <> 0 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code   
and f.auctionpart NOT IN ('CA')  
and f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type AND   
f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price AND   
f.Option_type = fos2.Option_type  
  
 order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type, f.symbol, f.expirydate,f.option_type,   
f.strike_price, sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER
-- --------------------------------------------------


CREATE PROC [dbo].[CREATE_CLASS_USER]  
(
 @FLDAUTO VARCHAR(50),	  
 @USERNAME VARCHAR(25),  
 @PASSWORD VARCHAR(50),  
 @FIRSTNAME VARCHAR(25),  
 @MIDDLENAME VARCHAR(25),  
 @LASTNAME VARCHAR(25),  
 @SEX  VARCHAR(8),  
 @ADD1  VARCHAR(100),  
 @MAILADD2 VARCHAR(100),  
 @PHONE1  VARCHAR(10),  
 @PHONE2  VARCHAR(10),   
 @CATEGORY VARCHAR(10),  
 @ADMIN_AUTO INT,  
 @STNAME  VARCHAR(50),  
 @ADMIN_NAME VARCHAR(30),  
 @IPADD  VARCHAR(20),  
 @PWDEXPIRYDAYS SMALLINT,  
 @USERSTATUS SMALLINT,  
 @ATTEMPTCOUNT SMALLINT,  
 @MAXATTEMPTCOUNT SMALLINT,  
 @ACCESSLEVEL CHAR(1),  
 @LOGINSTATUS SMALLINT,
 @FIRSTLOGIN CHAR(1),	
 @USERIPADDRESS VARCHAR(2000),
 @USERTYPE VARCHAR(25), 	
 @EXCHANGE VARCHAR(3),
 @SEGMENT VARCHAR(20),
 @CREATION_FLAG VARCHAR(3), --All or Single segment
 @ACTION_FLAG VARCHAR(20), -- EDIT OR REGISTER 
 @FLD_MAC_ID VARCHAR(200)
)  
  
AS
DECLARE   
 @@EDIT_FLAG  CHAR(1),  
 @@NEWDATE  VARCHAR(11), 
 @@EXPDATE  VARCHAR(11), 	 
 @@FLDLOG_DATA VARCHAR(8000),  
 @@FLDAUTO  INT,  
 @@FLDAUTO_NEW INT,
 @@FLDADMINAUTO INT,	
 @@ERROR_COUNT BIGINT,  
 @MESSAGE  VARCHAR(200),
 @MOB_ACCESS SMALLINT,
 @RESULT VARCHAR(MAX)


 --CREATE TABLE #RESULT (UNAME VARCHAR(100),FIRSTNAME VARCHAR(100),RESULT  VARCHAR(100), EXCHANGE  VARCHAR(100), SEGMENT  VARCHAR(100))  

BEGIN TRAN   
/*SELECT top 1 FLDUSERNAME = '12',FLDFIRSTNAME = '54',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '54', SEGMENT = '54'
from tblpradnyausers
ROLLBACK 
RETURN	*/

SET @@NEWDATE = CONVERT(VARCHAR,GETDATE(),109)  
SET @@EXPDATE = CONVERT(VARCHAR,GETDATE() + @PWDEXPIRYDAYS,109)  
/*SELECT 
	@MOB_ACCESS = MOB_ACCESS 
FROM 
	PRADNYA.DBO.ADMIN_INFO*/

IF UPPER(@ACTION_FLAG) = 'EDIT' 
 BEGIN
	SET @@EDIT_FLAG = 'E' 
	SET @@FLDLOG_DATA = '' 
 END
ELSE
 IF UPPER(@ACTION_FLAG) = 'REGISTER' 
  BEGIN
	SET @@EDIT_FLAG = 'A' 
	SET @@FLDLOG_DATA = 'ADDENTRY' 
  END	
ELSE
 IF UPPER(@ACTION_FLAG) = 'DELETE'
  BEGIN
	SET @@EDIT_FLAG = 'D' 
	SET @@FLDLOG_DATA = ''   
  END 

--BEGIN TRY
	IF UPPER(@ACTION_FLAG) = 'EDIT' 
     BEGIN
		
		SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
	
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME = @USERNAME 
		
		IF @@ERROR_COUNT <> 0    
		BEGIN 
		
		SELECT 
			@@FLDLOG_DATA = FLDPASSWORD +'~'+ 
			CASE WHEN FLDFIRSTNAME = '' THEN '$' ELSE FLDFIRSTNAME END +'~'+
			CASE WHEN FLDMIDDLENAME = '' THEN '$' ELSE FLDMIDDLENAME END +'~'+
			CASE WHEN FLDLASTNAME = '' THEN '$' ELSE FLDLASTNAME END +'~'+
			CASE WHEN FLDSEX = '' THEN '$' ELSE FLDSEX END +'~'+
			CASE WHEN FLDADDRESS1 = '' THEN '$' ELSE FLDADDRESS1 END +'~'+
			CASE WHEN FLDADDRESS2 = '' THEN '$' ELSE FLDADDRESS2 END  +'~'+
			CASE WHEN FLDPHONE1 = '' THEN '$' ELSE FLDPHONE1 END +'~'+
			CASE WHEN FLDPHONE2 = '' THEN '$' ELSE FLDPHONE2 END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDCATEGORY) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDCATEGORY) END+'~'+
			CASE WHEN CONVERT(VARCHAR,PWD_EXPIRY_DATE) = '' THEN '$' ELSE CONVERT(VARCHAR,PWD_EXPIRY_DATE) END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDATTEMPTCNT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDATTEMPTCNT) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDSTATUS) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDSTATUS) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDLOGINFLAG) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDLOGINFLAG) END +'~'+
			CASE WHEN FLDACCESSLVL = '' THEN '$' ELSE FLDACCESSLVL END +'~'+
			CASE WHEN FLDIPADD  = '' THEN '$' ELSE FLDIPADD END+'~'+
			CASE WHEN CONVERT(VARCHAR,FLDTIMEOUT) = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+
			CASE WHEN FLDFIRSTLOGIN = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDFORCELOGOUT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDFORCELOGOUT) END +'~'+
			CASE WHEN FLD_MAC_ID = '' THEN '$' ELSE FLD_MAC_ID END
		FROM 
			TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU 
		WHERE 
			TP.FLDAUTO = FLDUSERID
			AND FLDUSERNAME = @USERNAME 
		
		-- CLASS USER LOG TABLE ------------------------------  
		INSERT INTO   
		TBLPRADNYAUSERS_LOG  
		(  
		FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
		FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
		)  
		SELECT  
			FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
		FROM   
			TBLPRADNYAUSERS  
		WHERE   
			FLDUSERNAME =@USERNAME  

		INSERT INTO   
			TBLUSERCONTROLMASTER_JRNL   
		SELECT   
			*,@@FLDADMINAUTO,@@NEWDATE   
		FROM   
			TBLUSERCONTROLMASTER  
		WHERE   
			FLDUSERID = @FLDAUTO  
		
		UPDATE 
			TBLPRADNYAUSERS 
		SET 
			FLDUSERNAME = @USERNAME, FLDPASSWORD = @PASSWORD, FLDFIRSTNAME = @FIRSTNAME, FLDMIDDLENAME = @MIDDLENAME,
			FLDLASTNAME = @LASTNAME, FLDSEX = @SEX,	FLDADDRESS1 = @ADD1, FLDADDRESS2 = @MAILADD2, FLDPHONE1 = @PHONE1,
			FLDPHONE2 = @PHONE2, FLDCATEGORY = @CATEGORY, FLDSTNAME = @STNAME, PWD_EXPIRY_DATE = @@EXPDATE, EDIT_FLAG = @@EDIT_FLAG 
		WHERE 
			FLDAUTO = @FLDAUTO
		
		
		UPDATE 
			TBLUSERCONTROLMASTER
		SET
			FLDPWDEXPIRY = @PWDEXPIRYDAYS, FLDMAXATTEMPT = @MAXATTEMPTCOUNT, FLDATTEMPTCNT = @ATTEMPTCOUNT, FLDSTATUS = @USERSTATUS,
			FLDLOGINFLAG = @LOGINSTATUS, FLDACCESSLVL = @ACCESSLEVEL, FLDIPADD = @USERIPADDRESS, FLDFIRSTLOGIN = @FIRSTLOGIN, FLD_MAC_ID = @FLD_MAC_ID
		WHERE 
			FLDUSERID = @FLDAUTO

		SET @RESULT = 'EDITED SUCCESSFULLY'
	  	
		IF @@ERROR = 0
		 BEGIN
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @RESULT ,'',''
		 END
		END
 		ELSE
		 BEGIN
			SET @MESSAGE = 'USER DOST NOT EXIST IN SYSTEM!'    
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @MESSAGE ,'','' 
		 END 
	 END
   	ELSE	
	 BEGIN
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME =@USERNAME 
		
		IF @@ERROR_COUNT = 0    
		 BEGIN   
				--MAIN CLASS USER TABLE------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS  
			(  
			 FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, 
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE,EDIT_FLAG, CREATED_BY, MODIFIED_BY  
			)  
			VALUES  
			(  
			 @USERNAME, @PASSWORD, @FIRSTNAME, @MIDDLENAME, @LASTNAME, @SEX, @ADD1, @MAILADD2, @PHONE1, @PHONE2, @CATEGORY,   
			 @ADMIN_AUTO, @STNAME, @@EXPDATE, @@EDIT_FLAG, @ADMIN_NAME, @ADMIN_NAME   
			)  
		  
			-- CLASS USER LOG TABLE ------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS_LOG  
			(  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
			 FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
			)  
			SELECT  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
			FROM   
			 TBLPRADNYAUSERS  
			WHERE   
			 FLDUSERNAME =@USERNAME  
		 
		 
			SELECT @@FLDAUTO_NEW = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
			
			-- USER CONTROL MASTER TABLE -----------------------------  
			INSERT INTO TBLUSERCONTROLMASTER 
				(
				FLDUSERID,
				FLDPWDEXPIRY,
				FLDMAXATTEMPT,
				FLDATTEMPTCNT,
				FLDSTATUS,
				FLDLOGINFLAG,
				FLDACCESSLVL,
				FLDIPADD,
				FLDTIMEOUT,
				FLDFIRSTLOGIN,
				FLDFORCELOGOUT,
				FLD_MAC_ID
				)  
			SELECT   
				A.FLDAUTO, 
				@PWDEXPIRYDAYS, 
				@MAXATTEMPTCOUNT,
				@ATTEMPTCOUNT, 
				@USERSTATUS, 
				0, 
				@ACCESSLEVEL, 
				@USERIPADDRESS, 
				B.FLDTIMEOUT,  
				B.FLDFIRSTLOGIN, 
				B.FLDFORCELOGOUT, 
				@FLD_MAC_ID  
			FROM   
				TBLPRADNYAUSERS A LEFT OUTER JOIN TBLUSERCONTROLMASTER X  
			ON   
				(A.FLDAUTO = X.FLDUSERID), TBLUSERCONTROLGLOBALS B  
			WHERE   
				B.FLDCATEGORYID = A.FLDCATEGORY  
				AND ISNULL(A.FLDAUTO,0) = @@FLDAUTO_NEW  
		   
			--LOG USER CONTROL MASTER TABLE -----------------------------  
			  
			INSERT INTO   
			 TBLUSERCONTROLMASTER_JRNL   
			SELECT   
			 *,@@FLDADMINAUTO,@@NEWDATE   
			FROM   
			 TBLUSERCONTROLMASTER  
			WHERE   
			 FLDUSERID = @FLDAUTO  
		  
			--FOR MOBILE USER 
			/*IF @MOB_ACCESS = 1 AND @USERTYPE = 'CLIENT'
			  BEGIN
				INSERT INTO PRADNYA.DBO.USER_INFO (CLIENTID,USERNAME,LASTNAME,MAILID,STATUS_FLAG,EXCHANGE,SEGMENT,LOGIN_FLAG)
				SELECT 
					FLDUSERNAME, FLDFIRSTNAME, FLDLASTNAME, FLDADDRESS2, 1, EXCHANGE = @EXCHANGE+'', SEGMENT = '|'+@SEGMENT, LOGIN_FLAG = 0 
				FROM 
					TBLPRADNYAUSERS 
				WHERE
					 FLDUSERNAME = @USERNAME  
			  END */  		
			
			SET @RESULT = 'CREATED SUCCESSFULLY..'

	  	
			IF @@ERROR = 0
			 BEGIN
				SELECT  
					FLDUSERNAME, FLDFIRSTNAME, RESULT = @RESULT, EXCHANGE='', SEGMENT = '' INTO #RES 
				FROM 
					TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU
				WHERE
					 FLDUSERNAME = @USERNAME 
					 AND TP.FLDAUTO = TU.FLDUSERID
				
				IF @@ROWCOUNT = 0 
				 BEGIN
					ROLLBACK TRAN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT FLDUSERNAME = '',FLDFIRSTNAME = '',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '', SEGMENT = ''
					RETURN	
				 END
				ELSE
				 BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT * FROM #RES
				 END	
			 END 
		  END
		ELSE 
		 BEGIN
			SET @MESSAGE = 'USER ALREADY EXIST IN SYSTEM!'
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)    
			SELECT @USERNAME,'', @MESSAGE ,'','' 
		 END 
	END			
/*END TRY
BEGIN CATCH
	SELECT 
        ERROR_MESSAGE() AS MESSAGE;
		ROLLBACK
END CATCH*/
IF @@ERROR = 0
 BEGIN
	COMMIT TRAN
 END
ELSE
 BEGIN
	ROLLBACK TRAN	
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER_ALL
-- --------------------------------------------------


CREATE PROC [dbo].[CREATE_CLASS_USER_ALL]
(
	 @FLDAUTO		VARCHAR(50),	  
	 @USERNAME		VARCHAR(25),  
	 @PASSWORD		VARCHAR(50),  
	 @FIRSTNAME		VARCHAR(25),  
	 @MIDDLENAME	VARCHAR(25),  
	 @LASTNAME		VARCHAR(25),  
	 @SEX			VARCHAR(8),  
	 @ADD1			VARCHAR(100),  
	 @MAILADD2		VARCHAR(100),  
	 @PHONE1		VARCHAR(10),  
	 @PHONE2		VARCHAR(10),   
	 @CATEGORY		VARCHAR(10),  
	 @ADMIN_AUTO	INT,  
	 @STNAME		VARCHAR(50),  
	 @ADMIN_NAME	VARCHAR(30),  
	 @IPADD			VARCHAR(20),  
	 @PWDEXPIRYDAYS SMALLINT,  
	 @USERSTATUS	SMALLINT,  
	 @ATTEMPTCOUNT	SMALLINT,  
	 @MAXATTEMPTCOUNT SMALLINT,  
	 @ACCESSLEVEL	CHAR(1),  
	 @LOGINSTATUS	SMALLINT,
	 @FIRSTLOGIN	CHAR(1),	
	 @USERIPADDRESS VARCHAR(2000),
	 @USERTYPE		VARCHAR(25), 	
	 @EXCHANGE		VARCHAR(3),
	 @SEGMENT		VARCHAR(20),
	 @EXCSEG		VARCHAR(MAX),
	 @CREATION_FLAG VARCHAR(10), --All or Single segment
	 @ACTION_FLAG	VARCHAR(20), -- EDIT OR REGISTER 
	 @FLD_MAC_ID	VARCHAR(200)	
)

AS
/*
BEGIN TRAN
[CREATE_CLASS_USER_ALL]  '80662',  'AJAY',  'A8EE7FDD1FA67206',  'Ajay',  'n',  'Sengar',  'MALE',  'mumbai',  'a@c.c',  '46454',  '',  '400',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '30',  2,  0,  6,  'F',  0,  'N',  '10.11.12.74',  'Broker',  
'NSE',  'CAPITAL',  '',  'MULTI',  'Edit',
'10.11.12.74'  

ROLLBACK	
SELECT FLDAUTO_ADMIN FROM [MTSRVR06\DEV].NSEFO.DBO.TBLADMIN WHERE FLDNAME = 'Broker' 
INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) 
select * from nsefo..tblpradnyausers where fldusername = 'ajay'
EXECUTE CREATE_CLASS_USER_ALL  '',  'All',  'B5A07E53E1EF805D',  'bhrt',  'bhrt',  'bhrt',  'MALE',  'mum',  'a@c.n',  '9898989898',  '9989889898',  '388',  '2',  'Broker',  'Administrator',  '10.11.12.74',  '31',  2,  0,  6,  'F',  0,  'Y',  '',  'Broker',  'NSE',  'CAPITAL',  'BSE~CAPITAL,NSE~CAPITAL,BSE~FUTURES,NSE~FUTURES,',  'Choose',  'Register',  '' 
*/
BEGIN TRY
 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].[#RESULT]  
 (  
	UNAME VARCHAR(50),
	FIRSTNAME VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	RESULT VARCHAR(MAX)
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#ADMIN_AUTO
 (
	ADMIN_AUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#MKCK
 (
	MKCKFLAG INT	
 )
	
 CREATE TABLE [DBO].#CATEGORY
 (
	CATEGORY VARCHAR(50),
	CATEGORYCODE INT
 ) ON [PRIMARY]
 CREATE TABLE [DBO].#PRADNYA
 (
	FLDAUTO	INT,
	FLDADMINAUTO INT
 )

DECLARE  
 @@SHAREDB VARCHAR(20),	  
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@ORDERFLAG VARCHAR(1),  
 @@SQL VARCHAR(5000),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDNAME VARCHAR(30),	
 @@CATFLAG INT,	  
 @@CATNAME VARCHAR(50),
 @@MKCKFLAG INT,
 @@FLDAUTO	INT,
 @@FLDADMINAUTO INT,	 	
 @@MAINREC AS CURSOR  
 

	SELECT @@FLDNAME = FLDNAME FROM TBLADMIN WHERE FLDAUTO_ADMIN = @ADMIN_AUTO
	SELECT @@CATNAME = FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @CATEGORY
	
	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	IF UPPER(@CREATION_FLAG) = 'CHOOSE'
	 BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	 END
	ELSE
	 IF UPPER(@CREATION_FLAG) = 'SIN'
	  BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ( '"+@EXCHANGE+"' +'~'+ '"+@SEGMENT+"' ) "
      END 
	 		
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  

	PRINT @@DB
	EXEC(@@DB)  

	SET @@MAINREC = CURSOR FOR  
	
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  
	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME AND 1 <> 1 
				BEGIN
					
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME + "' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
			 ELSE
				BEGIN	
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
		
			PRINT @@SQL	
			EXEC(@@SQL)

			SELECT @@MKCKFLAG = MKCKFLAG FROM #MKCK
			--SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #PRADNYA	 				
			SELECT @CATEGORY = CATEGORYCODE FROM #CATEGORY 
			SELECT @ADMIN_AUTO = ADMIN_AUTO FROM #ADMIN_AUTO
			
						
			IF @@ROWCOUNT = 0 
			 BEGIN
				INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','ADMINISTRATOR IS NOT AVAILABLE IN THIS EXCH - SEG','','')
			 END
			ELSE
			 IF (SELECT COUNT(1) FROM #CATEGORY ) = 0
				BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','USER CATEGORY IS NOT AVAILABLE IN THIS EXCH - SEG','','')		
				END			
			ELSE
			 BEGIN	
			 --SET @@SQL = " INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) "
			 IF @@SHARESVR <> @@SERVERNAME AND 1 <> 1 
				BEGIN
					SET @@SQL = @@SQL + " EXEC " + @@SHARESVR + "." + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			 ELSE
				BEGIN	
					SET @@SQL = @@SQL + " EXEC " + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			SET @@SQL = @@SQL + "  '" + @FLDAUTO + "' "
			SET @@SQL = @@SQL + ", '" + @USERNAME + "' "
			SET @@SQL = @@SQL + ", '" + @PASSWORD + "' "
			SET @@SQL = @@SQL + ", '" + @FIRSTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @MIDDLENAME + "' "
			SET @@SQL = @@SQL + ", '" + @LASTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @SEX + "' "
			SET @@SQL = @@SQL + ", '" + @ADD1 + "' "
			SET @@SQL = @@SQL + ", '" + @MAILADD2 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE1 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE2 + "' "
			SET @@SQL = @@SQL + ", '" + @CATEGORY + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ADMIN_AUTO) + " "
			SET @@SQL = @@SQL + ", '" + @STNAME + "' "
			SET @@SQL = @@SQL + ", '" + @ADMIN_NAME + "' "
			SET @@SQL = @@SQL + ", '" + @IPADD + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@PWDEXPIRYDAYS) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,CASE WHEN @@MKCKFLAG = 0 THEN 0 ELSE @USERSTATUS END) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@MAXATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ", '" + @ACCESSLEVEL + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@LOGINSTATUS) + " "
			SET @@SQL = @@SQL + ", '" + @FIRSTLOGIN + "' "
			SET @@SQL = @@SQL + ", '" + @USERIPADDRESS + "' "
			SET @@SQL = @@SQL + ", '" + @USERTYPE + "' "
			SET @@SQL = @@SQL + ", '" + @EXCHANGE + "' " 
			SET @@SQL = @@SQL + ", '" + @SEGMENT + "' " 
			SET @@SQL = @@SQL + ", '" + @CREATION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @ACTION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @FLD_MAC_ID + "' " 
			PRINT (@@SQL)
			EXEC(@@SQL)
		   END	

			UPDATE 
				#RESULT
			SET 
				EXCHANGE = @@EXCHANGE,
				SEGMENT = @@SEGMENT
			WHERE 
				EXCHANGE = '' AND SEGMENT = ''
			
			TRUNCATE TABLE #ADMIN_AUTO
			TRUNCATE TABLE #MKCK
			TRUNCATE TABLE #CATEGORY		
	SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

	SELECT * FROM #RESULT
	TRUNCATE TABLE #DBNAME  
	DROP TABLE #DBNAME
END TRY
BEGIN CATCH
	INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
	SELECT '','',
        ERROR_MESSAGE() AS MESSAGE,'','';
        
        SELECT * FROM #RESULT
		ROLLBACK
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEMENU
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CREATEMENU]   
(  
 @FLDREPORTNAME VARCHAR (35),  
 @FLDPATH VARCHAR (500)  
)  AS
  
SET @FLDPATH = UPPER(REPLACE(@FLDPATH,'\','/'))  
   
IF (SELECT COUNT(1) FROM TBLREPORTS (NOLOCK) WHERE FLDPATH =@FLDPATH) = 0  
BEGIN  
 DECLARE @INTMNUGRP INT  
 DECLARE @INTREPORTGRP INT  
   
 SET @INTMNUGRP = 7  
 SET @INTREPORTGRP = 0  
   
 SELECT @INTMNUGRP = FLDMENUCODE FROM TBLMENUHEAD (NOLOCK) WHERE FLDMENUNAME ='UTILITIES'  
 SELECT @INTREPORTGRP = MAX(FLDREPORTGRP) FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP  
 SELECT TOP 1 @INTREPORTGRP= FLDREPORTGRP FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP AND FLDGRPNAME LIKE '%UTILITIES%'  
   
 INSERT INTO TBLREPORTS  
 SELECT   
  FLDREPORTNAME=@FLDREPORTNAME,  
  FLDPATH=@FLDPATH,  
  FLDTARGET= LOWER('FRA') +'T' + LOWER('OPIC'),  
  FLDDESC =@FLDREPORTNAME,  
  FLDREPORTGRP=@INTREPORTGRP,  
  FLDMENUGRP=@INTMNUGRP,  
  FLDSTATUS='A'+ LOWER('LL'),  
  FLDORDER=0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DataToHistoryNCDX
-- --------------------------------------------------

CREATE Proc [dbo].[DataToHistoryNCDX] (@CutOffDate varchar(11))
AS

Begin Tran
        Insert into Pradnya.dbo.History_Foclosing_NCDX
        Select * from Foclosing where Trade_date <= @CutOffDate + ' 23:59:59' 
        Delete from Foclosing where Trade_date <= @CutOffDate +  ' 23:59:59' 
        
        Insert into Pradnya.dbo.History_Foclosing_billreport_NCDX
        Select * from Foclosing_billreport where Trade_date <= @CutOffDate +  ' 23:59:59' 
        Delete from Foclosing_billreport where Trade_date <= @CutOffDate +  ' 23:59:59' 
        
        Insert into Pradnya.dbo.History_Foexerciseallocation_NCDX
        Select * from Foexerciseallocation where Foea_position_date <= @CutOffDate +  ' 23:59:59' 
        Delete from Foexerciseallocation where Foea_position_date <= @CutOffDate +  ' 23:59:59' 
        
        Insert into Pradnya.dbo.History_Fosettlement_NCDX
        Select Contractno,Billno,Trade_No,Party_Code,Inst_Type,Symbol,Sec_Name,Expirydate,Strike_Price,
        Option_Type,User_Id,Pro_Cli,O_C_Flag,C_U_Flag,Tradeqty,Auctionpart,Markettype,Series,
        Order_No,Price,Sauda_Date,Table_No,Line_No,Val_Perc,Normal,Day_Puc,Day_Sales,
        Sett_Purch,Sett_Sales,Sell_Buy,Settflag,Brokapplied,Netrate,Amount,Ins_Chrg,
        Turn_Tax,Other_Chrg,Sebi_Tax,Broker_Chrg,Service_Tax,Trade_Amount,Billflag,
        Sett_No,Nbrokapp,Nsertax,N_Netrate,Sett_Type,Cl_Rate,Participantcode,Status,
        Cpid,Instrument,Booktype,Branch_Id,Tmark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
        from Fosettlement where Expirydate <= @CutOffDate +  ' 23:59:59' 

	Insert Into Pradnya.Dbo.DataIn_History_Fosettlement_NCDX
	Select distinct Left(Sauda_date,11), ExpiryDate  
	from Fosettlement where Expirydate <= @CutOffDate +  ' 23:59:59'   

        Delete from Fosettlement where Expirydate <= @CutOffDate +  ' 23:59:59' 
Commit

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELETE_CLASS_USER_ALL
-- --------------------------------------------------

CREATE PROC [dbo].[DELETE_CLASS_USER_ALL]
(
	@UNAME		VARCHAR(30),
	@EXCSEG		VARCHAR(MAX),
	@IPADD		VARCHAR(20),
	@ADMIN_NAME VARCHAR(50)    

)
AS
/*
SELECT * FROM TBLPRADNYAUSERS
select * from TBLUSERCONTROLMASTER_JRNL
MXM~FUTURES,NMC~FUTURES,NSE~CAPITAL,
EXEC DELETE_CLASS_USER_ALL 'ASASD', 'BCM~FUTURES,BSE~CAPITAL,NSE~CAPITAL,NXM~FUTURES,', '10.11.12.74', 'Administrator'
SP_HELPTEXT ADMIN_DELUSER
INSERT INTO #USER_AUTO 
SELECT FLDAUTO FROM [MTSRVR06\DEV].MCDXCDSPCM.DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DS' 
*/
DECLARE  
 @@SHAREDB VARCHAR(20),
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@SQL VARCHAR(MAX),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDAUTO INT,
 @ADMINID INT,
 @GLOBALDATE DATETIME,  
 @@MAINREC AS CURSOR  

 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].#USER_AUTO
 (
	FLDAUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#RESULT
 (
	UNAME VARCHAR(30),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	MSG VARCHAR(100)	
 )	
	SET @GLOBALDATE = GETDATE()  

	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  
	PRINT @@DB
	EXEC(@@DB) 

	SET @@MAINREC = CURSOR FOR  
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  

	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
				
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO	
					
					SET @@SQL = " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM "
					SET @@SQL = @@SQL + " 	" + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE  "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
					
					SET @@SQL = @@SQL + " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TBC  "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
    
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			 ELSE
				BEGIN
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "	
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO

					SET @@SQL = " INSERT INTO " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + " 	" + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE   "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " INSERT INTO " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER   "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			--PRINT @@SQL	
			EXEC(@@SQL)
			IF @@ERROR = 0
			BEGIN
				INSERT INTO #RESULT VALUES (@UNAME,@@EXCHANGE,@@SEGMENT,'DELETED SUCCESSFULLY')
			END	

 SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

IF @@ERROR = 0
 BEGIN
	SELECT * FROM #RESULT
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Bill_NCDX
-- --------------------------------------------------


CREATE proc [dbo].[Delivery_Bill_NCDX]    
 (    
  @datefrom varchar(11),     
  @dateto varchar(11),     
    
  @partyfrom varchar(10),     
  @partyto varchar(10),      
    
  @statusid varchar(15),     
  @statusname varchar(25),    
  @strbranch varchar(12),    
  @strsubbrokfrom varchar(12),    
  @strsubbrokto varchar(12)    
 )    
    
as    
    
if @partyto=''    
  begin    
 set @partyto='ZZZZZZZZZZ'    
  end    
    
if @strsubbrokto=''    
  begin    
      SET @strsubbrokto='ZZZZZZZZZZ'    
  end    
    
select    
 company, addr1, addr2, city, zip, phone,    
 f.party_code, long_name, pan_gir_no,     
 billno,    
 left (convert(varchar, sauda_date, 103),13) sauda_date,     
 fos2.Sec_name,    
 LEFT(CONVERT(VARCHAR,f.expirydate,109),11) as expirydate,     
 TYPE = (Case When Sell_Buy = 1 Then 'BUY'  Else 'SELL' End),     
 TradeQty,    
 Price,    
 Delivery_Unit,    
 PriceUnit,    
 (Price*TradeQty*BookType/Instrument) Amount,f.Service_Tax,foglobals.Service_Tax SrTaxPer,    
 BrokApplied,Broker_Chrg,  
 Sett_Type,SETT_NO=Sett_No+'-'+ORDER_NO   
from    
 foowner, foglobals, client1 c1, client2 c2,     
 Delivery_FoSett f , foscrip2 fos2      
where      
 f.party_code = c2.party_code and     
 c1.cl_code = c2.cl_code and     
 f.party_code >= @partyfrom and    
 f.party_code <= @partyto and     
 f.sauda_date >= @datefrom and     
 f.sauda_date <= @dateto and     
 f.Symbol = fos2.Symbol AND    
 f.Inst_type = fos2.Inst_Type and     
 f.Expirydate = fos2.Expirydate AND    
 f.Strike_price = fos2.Strike_price and     
 f.Option_type = fos2.Option_type and    
 branch_cd like @strbranch +'%' and    
 sub_broker between  @strsubbrokfrom  and  @strsubbrokto and    
 sauda_date between year_start_dt and year_end_dt and            
   
 branch_cd like (case when @statusid = 'branch' then @statusname else '%' end) and     
 sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end) and     
 trader like (case when @statusid = 'trader' then @statusname else '%' end) and     
 c1.family like (case when @statusid = 'family' then @statusname else '%' end)  and     
 c1.cl_code like (case when @statusid = 'client' then @statusname else '%' end)    
    
order by Sett_Type,Sett_No ,Sauda_Date, f.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_BILL_REPORT
-- --------------------------------------------------

  
CREATE PROC [dbo].[DELIVERY_BILL_REPORT]     
 (      
   @DATEFROM VARCHAR(11),       
   @DATETO VARCHAR(11),  
   @PARTYFROM VARCHAR(10),       
   @PARTYTO VARCHAR(10),   
   @STATUSID VARCHAR(15),       
   @STATUSNAME VARCHAR(25),      
   @STRBRANCH VARCHAR(12),      
   @STRSUBBROKFROM VARCHAR(12),      
   @STRSUBBROKTO VARCHAR(12),  
   @SETTTYPE VARCHAR(2)=''      
 )      
      
AS  

--exec DELIVERY_BILL_REPORT 'Sep 3 2009','Sep 3 2012','00','zzz','broker','broker','','','',''    
      
IF @PARTYTO=''      
  BEGIN      
 SET @PARTYTO='ZZZZZZZZZZ'      
  END      
      
IF @STRSUBBROKTO=''      
  BEGIN      
      SET @STRSUBBROKTO='ZZZZZZZZZZ'      
  END 
  
  DECLARE @CHARGES INT    
SET @CHARGES = 0        
      
  
SELECT      
  COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE,      
  --F.PARTY_CODE, 
  --LONG_NAME, 
  --PAN_GIR_NO,       
  BILLNO,      
  LEFT (CONVERT(VARCHAR, SAUDA_DATE, 103),13) SAUDA_DATE,
  SAUDADATEORD=replace(convert(varchar,convert(datetime,SAUDA_DATE ,103),111),'/',''),                  
  FOS2.SEC_NAME,      
  LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),11) AS EXPIRYDATE,       
  TYPE = (CASE WHEN SELL_BUY = 1 THEN 'BUY'  ELSE 'SELL' END),       
  TRADEQTY,      
  PRICE,      
  DELIVERY_UNIT,      
  PRICEUNIT,      
  (PRICE*TRADEQTY*BOOKTYPE/INSTRUMENT) AMOUNT,F.SERVICE_TAX,FOGLOBALS.SERVICE_TAX SRTAXPER,      
  BROKAPPLIED,BROKER_CHRG, F.OTHER_CHRG,   
  SETT_TYPE,SETT_NO=SETT_NO + CASE WHEN @SETTTYPE ='N' THEN '' ELSE '-' + ORDER_NO END,  
  F.PARTY_CODE,     
 ISNULL(LONG_NAME,'') AS LONG_NAME,    
 ISNULL(L_ADDRESS1,'') AS L_ADDRESS1,     
 ISNULL(L_ADDRESS2,'') AS L_ADDRESS2,    
 ISNULL(L_ADDRESS3,'') AS L_ADDRESS3,    
 ISNULL(L_CITY,'') AS L_CITY, L_STATE,ISNULL(L_ZIP,'') AS L_ZIP,     
 ISNULL(PAN_GIR_NO,'') AS PAN_GIR_NO  ,    
 ISNULL(RES_PHONE1,'') AS RES_PHONE1,    
 ISNULL(OFF_PHONE1,'') AS OFF_PHONE1,    
  BRANCH_CD,     
  SUB_BROKER,  
  ROW_P_COUNT = CONVERT(NUMERIC(18,0),0),          
  ROW_S_COUNT = CONVERT(NUMERIC(18,0),0)    
INTO #BILL                  
FROM      
 FOOWNER (NOLOCK), FOGLOBALS (NOLOCK), CLIENT1 C1 (NOLOCK), CLIENT2 C2 (NOLOCK),       
 DELIVERY_FOSETT F (NOLOCK), FOSCRIP2 FOS2 (NOLOCK)  
WHERE        
  F.PARTY_CODE = C2.PARTY_CODE AND       
  C1.CL_CODE = C2.CL_CODE AND       
  F.PARTY_CODE >= @PARTYFROM AND      
  F.PARTY_CODE <= @PARTYTO AND       
  F.SAUDA_DATE >= @DATEFROM AND       
  F.SAUDA_DATE <= @DATETO AND       
  F.SYMBOL = FOS2.SYMBOL AND      
  F.INST_TYPE = FOS2.INST_TYPE AND       
  F.EXPIRYDATE = FOS2.EXPIRYDATE AND      
  F.STRIKE_PRICE = FOS2.STRIKE_PRICE AND       
  F.OPTION_TYPE = FOS2.OPTION_TYPE AND      
  BRANCH_CD LIKE @STRBRANCH +'%' AND      
  SUB_BROKER BETWEEN  @STRSUBBROKFROM  AND  @STRSUBBROKTO AND      
  SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND              
      
  1 = CASE WHEN @SETTTYPE ='N' THEN CASE WHEN SETT_TYPE NOT IN ('A','B') THEN 1 ELSE 0 END  
     WHEN @SETTTYPE ='A' THEN CASE WHEN SETT_TYPE IN ('A','B') THEN 1 ELSE 0 END  
     ELSE 1 END AND  
      
  BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END) AND       
  SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END) AND       
  TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END) AND       
  C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)  AND       
  C1.CL_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)      
      
ORDER BY F.PARTY_CODE,SAUDA_DATE,SETT_TYPE,SETT_NO     

 SELECT         
  PARTY_CODE,SAUDA_DATE,SETT_TYPE,SETT_NO,           
  PARTY_COUNT = COUNT(PARTY_CODE),        
  SCRIP_COUNT = COUNT(DISTINCT(SEC_NAME)) + @CHARGES   
  + (CASE WHEN SUM(SERVICE_TAX) > 0 THEN 1 ELSE 0 END)    
     + (CASE WHEN SUM(BROKAPPLIED) > 0 THEN 1 ELSE 0 END)  
     + (CASE WHEN SUM(BROKER_CHRG) > 0 THEN 1 ELSE 0 END)   
     + 3
     
            
 INTO        
  #ROWCOUNT        
 FROM        
  #BILL     
 GROUP BY        
  SAUDA_DATE,            
 PARTY_CODE,
 SETT_TYPE,SETT_NO     
 ORDER BY    
 PARTY_CODE,SAUDA_DATE,SETT_TYPE,SETT_NO  
    
      
UPDATE #BILL SET        
  ROW_P_COUNT = PARTY_COUNT,          
  ROW_S_COUNT = SCRIP_COUNT         
 FROM        
  #ROWCOUNT         
 WHERE        
  #ROWCOUNT.PARTY_CODE = #BILL.PARTY_CODE    
 AND #ROWCOUNT.SAUDA_DATE  = #BILL.SAUDA_DATE 
 AND #ROWCOUNT.SETT_TYPE  = #BILL.SETT_TYPE   
 AND #ROWCOUNT.SETT_NO  = #BILL.SETT_NO     
       
  
SELECT * FROM  #BILL   
ORDER BY PARTY_CODE,SAUDA_DATE,SETT_TYPE,SETT_NO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_CalculateMargin
-- --------------------------------------------------




CREATE   Procedure Delivery_CalculateMargin (@@Sett_No varchar(12),@@Sett_Type varchar(3),@StatusName varchar(12)) AS 
/*      
  Procedure for Calculating delivery margin 
  Calling from Delivery_CalculateMargin       
  Author : Sinulal      
  Date   : 18 Jul 2005
	Calculation Logic : Intial Margin Percentage of (Price * Squre Root of Settlement_Look_Ahead_Period * TradeQty * Numerator / Denominator )

  Modification Log  :
*/      

Delete From Delivery_Party_Margin Where Sett_type =@@Sett_Type And Sett_no =@@Sett_No

Insert  into Delivery_Party_Margin

Select Left(Convert(varchar,Expiry_Date,109),11) +' 00:00:00',Sec_PayOut,Party_Code,D.Sett_Type,D.Sett_No,D.Symbol,
Sum(D.Price * Sqrt(P.Look_Ahead_Period) * D.TradeQty * D.BookType * (M.Int_Margin+P.Add_Margin) * 0.01 / D.Instrument),
@StatusName,GetDate()
From Delivery_FoSett D, Delivery_Margin M,Delivery_Sett_Mst S, Delivery_Look_Ahead_Period P
Where 
D.Symbol = P.Symbol
And D.Sauda_Date Between P.From_Date and P.To_Date
And D.Symbol = M.Symbol
And Left(Convert(datetime,D.Expirydate,103),11) =  Left(Convert(datetime,M.Expirydate,103),11) 
--And D.Symbol = S.Symbol
And D.Sett_Type = S.Sett_Type
And D.Sett_No = S.Sett_No
And D.Sett_type =@@Sett_Type And D.Sett_no =@@Sett_No
Group by Sec_PayOut,Party_Code,D.Sett_Type,D.Sett_No,D.Symbol,Expiry_Date
Order By Party_Code,D.Symbol



select * from Delivery_Margin

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_CloseOut
-- --------------------------------------------------
CREATE PROC  [dbo].[Delivery_CloseOut]      
(               
 @@SETT_NO VARCHAR(12),              
 @@SETT_TYPE VARCHAR(3),              
 @@MODE VARCHAR(10)              
) AS              
                          
/*                          
  PROCEDURE FOR FETCHING DATA FOR SHORTAGE              
  AUTHOR : SINULAL                          
  DATE   : 13 JUN 05              
  MODIFICATION LOG :              
*/                        
              
              
DECLARE                       
@ORGSETTTYPE    VARCHAR(3) ,              
@ORGSETTNO    VARCHAR(12) ,              
@PARTY_CODE VARCHAR(10),              
@SYMBOL         VARCHAR(12),                  
@WAREHOUSE  VARCHAR(20),              
@ISIN  VARCHAR(12),              
@DRCR  CHAR(1),              
@QTYCLT  NUMERIC (18,4),              
@PAYINQTY NUMERIC (18,4),              
@PAYOUTQTY NUMERIC (18,4),              
@DELNETCUR  CURSOR ,                 
@DELCLTCUR  CURSOR               
              
              
IF @@MODE ='NEW'              
BEGIN              
 DELETE DELIVERY_CLOSEOUT_TEMP WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO              
 AND CLOSEOUT_TYPE  IN ('S','G','L')              
              
 INSERT INTO DELIVERY_CLOSEOUT_TEMP               
 SELECT               
  '01/01/1900',@@SETT_TYPE,@@SETT_NO,              
  DELNET.SETT_TYPE,DELNET.SETT_NO,DELIVERY_OBL_CLT.PARTY_CODE,              
  INST_TYPE,DELNET.SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,              
  DELNET.WAREHOUSE,ISIN = DELNET.ISIN,'L',              
  DRCR = (CASE WHEN (SUM(CASE WHEN SELL_BUY = 'B' THEN -TOTAL_ALLOCATED_QTY ELSE TOTAL_ALLOCATED_QTY END)-SUM(ISNULL(TRANSQTY,0))) > 0 THEN   'C' ELSE 'D' END),              
  --DRCR = CASE WHEN SELL_BUY = 'B' THEN 'C' ELSE 'D' END,              
  OBLQTY = ABS(SUM(CASE WHEN SELL_BUY = 'B' THEN -TOTAL_ALLOCATED_QTY ELSE TOTAL_ALLOCATED_QTY END)-SUM(ISNULL(TRANSQTY,0))),              
  --OBLQTY = ABS(SUM(CASE WHEN SELL_BUY = 'B' THEN -TOTAL_ALLOCATED_QTY ELSE TOTAL_ALLOCATED_QTY END)),              
  0,0,'N',0               
 FROM               
  (              
  SELECT              
   SETT_TYPE,SETT_NO,SYMBOL,WAREHOUSE,ISIN               
  FROM              
   DELIVERY_OBL_NET              
  WHERE              
   SETT_TYPE IN (              
     SELECT              
      D_SETT_TYPE              
     FROM              
      DELIVERY_OBL_CLOSEOUT_VIEW               
     WHERE              
      DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_OBL_NET.SETT_NO              
      AND CLOSE_TYPE IN ('S','G','L')              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE               
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO               
     )              
   AND ISIN IN (              
     SELECT              
      D_ISIN FROM DELIVERY_OBL_CLOSEOUT_VIEW               
     WHERE              
      DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_TYPE = DELIVERY_OBL_NET.SETT_TYPE              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_OBL_NET.SETT_NO              
      AND CLOSE_TYPE IN ('S','G','L')              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE               
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO               
     )              
  GROUP BY              
   SETT_TYPE,SETT_NO,SYMBOL,WAREHOUSE,ISIN               
  ) DELNET ,              
                
  DELIVERY_OBL_CLT              
               
  LEFT OUTER JOIN              
               
  (              
  SELECT              
   SETT_TYPE,SETT_NO,PARTY_CODE,              
   SYMBOL,WAREHOUSE,              
   TRANSQTY = SUM(CASE WHEN DRCR = 'C' THEN QTY ELSE -QTY END)              
  FROM              
   DELIVERY_TRANSACTION                
  WHERE              
   PARTY_CODE NOT IN ('BROKER','EXE')              
   AND SETT_TYPE IN (              
    SELECT              
       D_SETT_TYPE              
      FROM              
       DELIVERY_OBL_CLOSEOUT_VIEW               
       WHERE              
       DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_TRANSACTION.SETT_NO              
       AND CLOSE_TYPE IN ('S','G','L')              
       AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE               
       AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO               
     )              
   AND SYMBOL IN (              
     SELECT              
      SYMBOL              
     FROM              
      DELIVERY_OBL_CLOSEOUT_VIEW        
     WHERE                
      DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_TYPE = DELIVERY_TRANSACTION.SETT_TYPE              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_TRANSACTION.SETT_NO              
      AND CLOSE_TYPE IN ('S','G','L')              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE               
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO               
     )              
   AND ACTIVE = 1              
   AND TRTYPE <> 906              
  GROUP BY SETT_TYPE,SETT_NO,PARTY_CODE,SYMBOL,WAREHOUSE              
  ) DELTRANS              
               
  ON                
   (              
    DELTRANS.SETT_TYPE  = DELIVERY_OBL_CLT.SETT_TYPE              
    AND DELTRANS.SETT_NO = DELIVERY_OBL_CLT.SETT_NO              
    AND DELTRANS.PARTY_CODE = DELIVERY_OBL_CLT.PARTY_CODE              
    AND DELTRANS.SYMBOL = DELIVERY_OBL_CLT.SYMBOL              
    AND DELTRANS.WAREHOUSE = DELIVERY_OBL_CLT.WAREHOUSE              
   )              
                
 WHERE              
  DELNET.SETT_TYPE = DELIVERY_OBL_CLT.SETT_TYPE              
  AND DELNET.SETT_NO = DELIVERY_OBL_CLT.SETT_NO              
  AND DELNET.SYMBOL = DELIVERY_OBL_CLT.SYMBOL              
  AND DELNET.WAREHOUSE = DELIVERY_OBL_CLT.WAREHOUSE              
  AND DELIVERY_OBL_CLT.SETT_TYPE IN              
    (              
     SELECT D_SETT_TYPE FROM DELIVERY_OBL_CLOSEOUT_VIEW               
     WHERE               
      DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_OBL_CLT.SETT_NO              
      AND CLOSE_TYPE IN ('S','G','L')              
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE               
      AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO               
               
    )              
 GROUP BY              
  DELNET.SETT_TYPE,DELNET.SETT_NO,DELIVERY_OBL_CLT.PARTY_CODE,              
  INST_TYPE,DELNET.SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,              
  DELNET.WAREHOUSE,SELL_BUY,DELNET.ISIN              
              
 UPDATE              
   DELIVERY_CLOSEOUT_TEMP               
 SET              
  PRICE = ABS((C.PAYIN_VALUE-PAYOUT_VALUE)/(C.PAYIN_QTY-c.PayOut_Qty)*DENOMINATOR/NUMERATOR),              
  PAYIN_QTY = C.PAYIN_QTY,              
  PAYOUT_QTY =  C.PAYOUT_QTY ,              
  REPORTDATE = C.REPORT_DATE              
 FROM              
  (              
              
  SELECT REPORT_DATE,SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO,              
   PAYIN_QTY = SUM(PAYIN_QTY),              
   PAYOUT_QTY = SUM(PAYOUT_QTY),              
   PAYIN_VALUE = abs(SUM(PAYIN_VALUE)),              
   PAYOUT_VALUE = abs(SUM(PAYOUT_VALUE))              
  FROM (SELECT               
   REPORT_DATE=MAX(REPORT_DATE),              
   SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO,              
   PAYIN_QTY = SUM(PAYIN_QTY),              
   PAYOUT_QTY = SUM(PAYOUT_QTY),              
   PAYIN_VALUE = SUM(PAYIN_VALUE),              
   PAYOUT_VALUE = SUM(PAYOUT_VALUE)              
  FROM              
   DELIVERY_OBL_CLOSEOUT_VIEW               
  WHERE              
   CLOSE_TYPE IN ('S','G','L')              
   AND SETT_TYPE = @@SETT_TYPE               
   AND SETT_NO = @@SETT_NO               
  GROUP BY              
SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO --,CLOSE_TYPE,PAYIN_QTY,PAYOUT_QTY              
  ) TRDDEL              
  GROUP BY              
   REPORT_DATE,SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO              
  ) C,              
  (SELECT SYMBOL,DENOMINATOR=MAX(DENOMINATOR),NUMERATOR=MAX(NUMERATOR)              
  FROM FOSCRIP2 (NOLOCK) GROUP BY SYMBOL) SCRP               
                 
 WHERE              
  SCRP.SYMBOL=C.SYMBOL              
  AND C.SYMBOL = DELIVERY_CLOSEOUT_TEMP.SYMBOL              
  AND C.WAREHOUSE = DELIVERY_CLOSEOUT_TEMP.WAREHOUSE              
  AND DELIVERY_CLOSEOUT_TEMP.D_SETT_TYPE = C.D_SETT_TYPE              
  AND DELIVERY_CLOSEOUT_TEMP.D_SETT_NO = C.D_SETT_NO              
  AND CLOSEOUT_TYPE IN ('S','G','L')              
  AND C.SETT_TYPE = @@SETT_TYPE               
  AND C.SETT_NO = @@SETT_NO               
  AND  QTY_CLT > 0              
 --AND DRCR = 'C'            
AND (C.PAYIN_QTY+c.payout_qty) <> 0          
            
/*            
 UPDATE              
   DELIVERY_CLOSEOUT_TEMP               
 SET              
  PRICE = ABS(C.PAYOUT_VALUE/C.PAYOUT_QTY*DENOMINATOR/NUMERATOR),              
  PAYIN_QTY = C.PAYIN_QTY,              
  PAYOUT_QTY =  C.PAYOUT_QTY ,              
  REPORTDATE = C.REPORT_DATE              
 FROM              
  (              
              
  SELECT REPORT_DATE,SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO,              
   PAYIN_QTY = SUM(PAYIN_QTY),              
   PAYOUT_QTY = SUM(PAYOUT_QTY),              
   PAYIN_VALUE = abs(SUM(PAYIN_VALUE)),              
   PAYOUT_VALUE = abs(SUM(PAYOUT_VALUE))              
  FROM (SELECT               
   REPORT_DATE=MAX(REPORT_DATE),              
   SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO,              
   PAYIN_QTY = SUM(PAYIN_QTY),              
   PAYOUT_QTY = SUM(PAYOUT_QTY),              
   PAYIN_VALUE = SUM(PAYIN_VALUE),              
   PAYOUT_VALUE = SUM(PAYOUT_VALUE)              
  FROM              
   DELIVERY_OBL_CLOSEOUT_VIEW               
  WHERE              
   CLOSE_TYPE IN ('S','G','L')              
   AND SETT_TYPE = @@SETT_TYPE               
   AND SETT_NO = @@SETT_NO               
  GROUP BY              
   SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO --,CLOSE_TYPE,PAYIN_QTY,PAYOUT_QTY              
  ) TRDDEL              
  GROUP BY              
   REPORT_DATE,SYMBOL,WAREHOUSE,D_SETT_TYPE,D_SETT_NO,SETT_TYPE,SETT_NO              
  ) C,              
  (SELECT SYMBOL,DENOMINATOR=MAX(DENOMINATOR),NUMERATOR=MAX(NUMERATOR)              
  FROM FOSCRIP2 (NOLOCK) GROUP BY SYMBOL) SCRP               
                 
 WHERE              
  SCRP.SYMBOL=C.SYMBOL              
  AND C.SYMBOL = DELIVERY_CLOSEOUT_TEMP.SYMBOL              
  AND C.WAREHOUSE = DELIVERY_CLOSEOUT_TEMP.WAREHOUSE              
  AND DELIVERY_CLOSEOUT_TEMP.D_SETT_TYPE = C.D_SETT_TYPE              
  AND DELIVERY_CLOSEOUT_TEMP.D_SETT_NO = C.D_SETT_NO              
  AND CLOSEOUT_TYPE IN ('S','G','L')              
  AND C.SETT_TYPE = @@SETT_TYPE               
  AND C.SETT_NO = @@SETT_NO               
  AND  QTY_CLT > 0              
 AND DRCR = 'D'            
AND C.PAYOUT_QTY <> 0        
*/      
/*-----------------*/      
      
UPDATE DELIVERY_CLOSEOUT_TEMP SET CLOSEOUT_TYPE = CLOSE_TYPE      
FROM DELIVERY_OBL_CLOSEOUT_VIEW      
WHERE DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE =@@SETT_TYPE       
AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO =@@SETT_NO      
AND CLOSE_TYPE NOT IN ('P','D')      
AND DELIVERY_OBL_CLOSEOUT_VIEW.ISIN = DELIVERY_CLOSEOUT_TEMP.ISIN      
/*      
UPDATE DELIVERY_CLOSEOUT_TEMP SET DRCR = CASE WHEN DRCR= 'D' THEN 'C' ELSE 'D' END      
FROM DELIVERY_OBL_CLOSEOUT_VIEW      
WHERE DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE =@@SETT_TYPE      
AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO =@@SETT_NO      
AND CLOSE_TYPE  IN ('G','L')         
AND CLOSE_TYPE = CLOSEOUT_TYPE      
AND DELIVERY_OBL_CLOSEOUT_VIEW.ISIN = DELIVERY_CLOSEOUT_TEMP.ISIN      
AND PAYIN_VALUE < 0      
AND DRCR= 'C'      
*/      
/*-----------------*/      
      
      
          
END              
ELSE IF @@MODE ='FETCH'              
BEGIN              
 SELECT INTSRNO,PARTY_CODE,SYMBOL,WAREHOUSE,ISIN,              
 CASE WHEN CLOSEOUT_TYPE='G' THEN 'SHORTAGE GAIN'              
    ELSE              
     CASE WHEN CLOSEOUT_TYPE='L' THEN 'SHORTAGE LOSSES'               
        ELSE              
        'GENUINE SHORTAGE'              
        END              
    END CLOSE_TYPE,              
 CASE WHEN DRCR ='C' THEN              
   'PAYIN'               
   ELSE              
   'PAYOUT'              
   END SELLBUY,QTY_CLT QTY,              
 CLOSEOUT_FLAG ,PRICE, D_SETT_TYPE, D_SETT_NO              
 FROM DELIVERY_CLOSEOUT_TEMP               
 WHERE              
  SETT_TYPE = @@SETT_TYPE               
  AND SETT_NO = @@SETT_NO              
  AND CLOSEOUT_TYPE  IN ('S','G','L')              
  AND PRICE > 0              
 ORDER BY D_SETT_TYPE, D_SETT_NO,SYMBOL,WAREHOUSE,ISIN,CLOSEOUT_TYPE,CLOSEOUT_FLAG DESC,PARTY_CODE              
END              
ELSE IF @@MODE = 'UPDATE'              
BEGIN              
 DELETE DELIVERY_OBL_CLT WHERE  SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DEL_REC_NO = '88888'              
              
 DELETE DELIVERY_OBL_NET WHERE  SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DEL_REC_NO = '88888'              
              
 DELETE DELIVERY_TRANSACTION WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO  AND FILLER1 ='C'              
               
 INSERT INTO DELIVERY_OBL_CLT              
 SELECT               
  REPORTDATE,REPORTDATE,MEMBERCODE,SETT_TYPE,SETT_NO,              
  INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,              
  0 CRA_LEVEL,WAREHOUSE, MEMBERCODE,'' MEMBER_AC_TYPE,PARTY_CODE,              
  SELL_BUY = CASE WHEN DRCR ='C' THEN 'B' ELSE 'S' END,              
  QTY_CLT, 0 ,QTY_CLT,'Y',QTY_CLT,0,88888              
 FROM  DELIVERY_CLOSEOUT_TEMP , FOOWNER              
 WHERE               
  SETT_TYPE = @@SETT_TYPE               
  AND SETT_NO = @@SETT_NO              
  AND PRICE <> 0              
  AND CLOSEOUT_TYPE  IN ('S','G','L')              
              
               
 INSERT INTO  DELIVERY_OBL_NET              
 SELECT 88888,REPORTDATE,SETT_TYPE,SETT_NO,              
 T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,              
 WAREHOUSE,              
 SUM(CASE WHEN DRCR = 'C'               
  THEN              
    QTY_CLT            
  ELSE              
   0              
  END) PAYIN_QTY,              
 SUM(CASE WHEN DRCR = 'D'               
  THEN       
    QTY_CLT               
  ELSE              
   0              
  END) PAYOUT_QTY,              
 SUM(CASE WHEN DRCR = 'C'               
  THEN              
    QTY_CLT * PRICE  * NUMERATOR / DENOMINATOR              
  ELSE              
    0              
  END) PAYIN_VALUE,              
 SUM(CASE WHEN DRCR = 'D'               
  THEN              
    QTY_CLT * PRICE * NUMERATOR / DENOMINATOR              
  ELSE              
   0              
  END) PAYOUT_VALUE,              
 ISIN              
 FROM  DELIVERY_CLOSEOUT_TEMP T , FOSCRIP2 F              
 WHERE              
  T.INST_TYPE = F.INST_TYPE              
  AND T.SYMBOL = F.SYMBOL              
  AND T.EXPIRY_DATE = F.EXPIRYDATE              
  AND T.OPTION_TYPE = F.OPTION_TYPE              
  AND T.STRIKE_PRICE = F.STRIKE_PRICE              
  AND T.SETT_TYPE =@@SETT_TYPE               
  AND T.SETT_NO = @@SETT_NO              
  AND T.PRICE <> 0              
  AND T.CLOSEOUT_TYPE  IN ('S','G','L')              
 GROUP BY               
  T.SETT_TYPE,T.SETT_NO,T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,              
  T.STRIKE_PRICE,T.OPTION_TYPE,T.WAREHOUSE,T.ISIN,T.REPORTDATE              
               
               
               
 INSERT INTO DELIVERY_TRANSACTION              
 SELECT               
  T.SETT_NO,T.SETT_TYPE,(SELECT ISNULL(MAX(REFNO),1) REFNO  FROM DELIVERY_DELCODE) REFNO,1 TCODE, 904 TRTYPE,              
  T.PARTY_CODE,T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,              
  TOTAL_ALLOCATED_QTY,0 TRANSNO,1 FROMNO,'' TONO, 'AUCTION' ISIN,'' FOLIONO,'' HOLDERNAME,              
  'AUCTION @ ' + CONVERT(VARCHAR,PRICE)  REASON,              
  DRCR,0 DELIVERED, TOTAL_ALLOCATED_QTY ORGQTY, '' DPTYPE, '' DPID, '' CLTDPID,               
  C1.BRANCH_CD, MEMBERCODE PARTIPANTCODE, '' COUNTERPARTY, T.WAREHOUSE, 0 SLIPNO, ''BATCHNO,               
  '' ISETT_NO, '' ISETT_TYPE,              
  'AUCTION' SHARETYPE,C.REPORT_DATE TRANSDATE, '' BDPTYPE, '' BDPID, '' BCLTDPID, 1 ACTIVE, 'C' FILLER1,              
  '' FILLER2,'' FILLER3, '' FILLER4, '' FILLER5              
 FROM              
  DELIVERY_CLOSEOUT_TEMP T, CLIENT1 C1, CLIENT2 C2, DELIVERY_OBL_CLT C              
 WHERE               
  T.PARTY_CODE = C2.PARTY_CODE              
  AND C1.CL_CODE = C2.CL_CODE              
  AND T.SETT_TYPE = C.SETT_TYPE              
  AND T.SETT_NO = C.SETT_NO              
  AND T.PARTY_CODE = C.PARTY_CODE              
  AND T.SYMBOL = C.SYMBOL              
  AND T.WAREHOUSE = C.WAREHOUSE              
  AND T.SETT_TYPE = @@SETT_TYPE              
  AND T.SETT_NO = @@SETT_NO              
  AND T.CLOSEOUT_TYPE  IN ('S','G','L')              
  AND T.PRICE <> 0              
              
 INSERT INTO DELIVERY_TRANSACTION              
 SELECT               
  T.SETT_NO,T.SETT_TYPE,(SELECT ISNULL(MAX(REFNO),1) REFNO  FROM DELIVERY_DELCODE) REFNO,1 TCODE, 906 TRTYPE,              
  'NCE',T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,              
  TOTAL_ALLOCATED_QTY,0 TRANSNO,1 FROMNO,'' TONO, 'AUCTION' ISIN,'' FOLIONO,'' HOLDERNAME,              
  'AUCTION @ ' + CONVERT(VARCHAR,PRICE)  REASON,              
  DRCR=(CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END),0 DELIVERED, TOTAL_ALLOCATED_QTY ORGQTY, '' DPTYPE, '' DPID, '' CLTDPID,               
  C1.BRANCH_CD, MEMBERCODE PARTIPANTCODE, '' COUNTERPARTY, T.WAREHOUSE, 0 SLIPNO, ''BATCHNO,               
  '' ISETT_NO, '' ISETT_TYPE,            
  'AUCTION' SHARETYPE,C.REPORT_DATE TRANSDATE, '' BDPTYPE, '' BDPID, '' BCLTDPID, 1 ACTIVE, 'C' FILLER1,              
  '' FILLER2,'' FILLER3, '' FILLER4, '' FILLER5              
 FROM              
  DELIVERY_CLOSEOUT_TEMP T, CLIENT1 C1, CLIENT2 C2, DELIVERY_OBL_CLT C              
 WHERE          
  T.PARTY_CODE = C2.PARTY_CODE              
  AND C1.CL_CODE = C2.CL_CODE              
  AND T.SETT_TYPE = C.SETT_TYPE              
  AND T.SETT_NO = C.SETT_NO              
  AND T.PARTY_CODE = C.PARTY_CODE              
  AND T.SYMBOL = C.SYMBOL              
  AND T.WAREHOUSE = C.WAREHOUSE              
  AND T.SETT_TYPE = @@SETT_TYPE              
  AND T.SETT_NO = @@SETT_NO              
  AND T.CLOSEOUT_TYPE  IN ('S','G','L')    AND T.PRICE <> 0              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_CloseOut_Upd
-- --------------------------------------------------




CREATE   Procedure Delivery_CloseOut_Upd (@@Sett_No varchar(12),@@Sett_Type varchar(3)) AS      
      
/*      
  Procedure for Updating Client obligation for shortage
  Author : Sinulal      
  Date   : 14 Jun 2005
  Modification Log : 
*/      
      
Declare
	@ReportDate 	DateTime,
	@OrgSettType   	Varchar(3) ,
	@OrgSettNo   	Varchar(12) 
	

  
Set @OrgSettNo = @@Sett_No
Set @OrgSettType  = @@Sett_Type


Select Top 1 @@Sett_Type=Sett_Type,@@Sett_No=Sett_No  from Delivery_Obl_CloseOut 
Where D_Sett_no = @OrgSettNo  and D_Sett_Type = @OrgSettType

Select Top 1 @ReportDate=Sec_PayIn  from Delivery_Sett_Mst Where Sett_no = @@Sett_No  and Sett_Type = @@Sett_Type

Delete Delivery_Obl_Clt  
 Where Sett_no = @@Sett_No
	and Sett_Type = @@Sett_Type
	and Del_Rec_No = '88888'

Insert into Delivery_Obl_Clt
Select @ReportDate,@ReportDate,D.PartipantCode,T.Sett_Type,T.Sett_No,D.Inst_Type,D.Symbol,D.Expiry_Date,D.Strike_Price,
D.Option_Type,0 CRA_Level,D.WareHouse,D.Sett_No + D.Sett_Type Membercode,'' Member_Ac_Type,D.Party_Code,
Sell_Buy = Case When D.DrCr ='C' Then 'B' else 'S' End,
T.Qty_Clt, 0 ,T.Qty_Clt,'Y',T.Qty_Clt,0,88888
From Delivery_Transaction D, Delivery_CloseOut_Temp T
Where D.Party_Code not in ('BROKER','EXE')
And D.Sett_Type = T.D_Sett_Type
And D.Sett_No = T.D_Sett_No
And D.Party_Code = T.Party_Code
And D.Symbol = T.Symbol
And D.WareHouse = T.WareHouse
And D.ISIN = T.ISIN
And D.DrCr = T.DrCr
And D.OrgQty  = T.Qty_Clt  
And T.Sett_Type =@@Sett_Type 
And T.Sett_No = @@Sett_No
And T.Price <> 0
and trtype <> 906
And T.CloseOut_Type  in ('S','G','L')

Delete Delivery_Obl_Net  
 Where Sett_no = @@Sett_No
	and Sett_Type = @@Sett_Type
	and Del_Rec_No = '88888'

Insert into  Delivery_Obl_Net
Select 88888,@ReportDate,T.Sett_Type,T.Sett_no,D.Inst_Type,D.Symbol,D.Expiry_Date,D.Strike_Price,D.Option_Type,
D.WareHouse,
Sum(Case When D.DrCr = 'C' 
				Then
				 	Qty_Clt 
				Else
					0
				End) PayIn_Qty,
Sum(Case When D.DrCr = 'D' 
				Then
				 	Qty_Clt 
				Else
					0
				End) PayOut_Qty,
Sum(Case When D.DrCr = 'C' 
				Then
				 	Qty_Clt * Price  * Numerator / Denominator
				Else
						0
				End) PayIn_Value,
Sum(Case When D.DrCr = 'D' 
				Then
				 	Qty_Clt * Price * Numerator / Denominator
				Else
					0
				End) PayOut_Value,
D.IsIn
From Delivery_Transaction D, Delivery_CloseOut_Temp T , FoScrip2 F
Where D.Party_Code not in ('BROKER','EXE')
And D.Sett_Type = T.D_Sett_Type
And D.Sett_No = T.D_Sett_No
And D.Party_Code = T.Party_Code
And D.Symbol = T.Symbol
And D.WareHouse = T.WareHouse
And D.ISIN = T.ISIN
And D.DrCr = T.DrCr
And D.OrgQty  = T.Qty_Clt  
And D.Inst_Type = F.Inst_Type
And D.Symbol = F.Symbol
And D.Expiry_Date = F.ExpiryDate
And D.Option_Type = F.Option_Type
And D.Strike_Price = F.Strike_Price
And T.Sett_Type =@@Sett_Type 
And T.Sett_No = @@Sett_No
And T.Price <> 0
And T.CloseOut_Type  in ('S','G','L')
Group By T.Sett_Type,T.Sett_no,D.Inst_Type,D.Symbol,D.Expiry_Date,D.Strike_Price,D.Option_Type,D.WareHouse,D.IsIn


Delete Delivery_Transaction Where Sett_Type = @@Sett_Type and Sett_No = @@Sett_No and Filler1 = 'C'

Insert into Delivery_Transaction

Select T.Sett_No,T.Sett_type,(Select Max(RefNo) RefNo  From Delivery_Delcode) Refno,1 TCode, 904 TrType,
T.Party_Code,C.Inst_Type,T.Symbol,C.Expiry_Date,C.Strike_Price,C.Option_Type,
Total_Allocated_Qty,0 TransNo,1 FromNo,'' ToNo, 'Auction' IsIn,'' FolioNo,'' HolderName,
'Auction @ ' + convert(varchar,Price)  Reason,
DrCr,0 Delivered, Total_Allocated_Qty OrgQty, '' DpType, '' DpId, '' CltDpId, 
C1.Branch_Cd, MemberCode PartipantCode, '' CounterParty, T.WareHouse, 0 SlipNo, ''BatchNo, '' ISett_No, '' ISett_Type,
'Auction' ShareType,C.Report_Date TransDate, '' BDpType, '' BDpId, '' BCltDpId, 1 Active, 'C' Filler1,
'' Filler2,'' Filler3, '' Filler4, '' Filler5

From Delivery_CloseOut_Temp T, Client1 C1, Client2 C2, Delivery_Obl_Clt C
Where 
T.Party_Code = C2.Party_Code
And C1.Cl_Code = C2.Cl_Code
And T.Sett_Type = C.Sett_Type
And T.Sett_No = C.Sett_No
And T.Party_Code = C.Party_Code
And T.Symbol = C.Symbol
And T.WareHouse = C.WareHouse
And T.Sett_Type = @@Sett_Type
And T.Sett_No = @@Sett_No
And T.CloseOut_Type  in ('S','G','L')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_DematTransInsert
-- --------------------------------------------------

CREATE PROC [DBO].[DELIVERY_DEMATTRANSINSERT]   
 (                
   @TCODE INT,                 
   @REFNO INT   
 )  
AS                 
         
         
UPDATE DELIVERY_DEMAT_TRANS_TMP SET SETT_TYPE = M.SETT_TYPE
FROM DELIVERY_MARKET_TYPE M WHERE MARKETTYPE = DELIVERY_DEMAT_TRANS_TMP.SETT_TYPE
AND DELIVERY_DEMAT_TRANS_TMP.DPTYPE = M.DPTYPE

UPDATE DELIVERY_DEMAT_TRANS_TMP
SET INST_TYPE = M.INST_TYPE, SYMBOL = M.SYMBOL, WAREHOUSE = M.WAREHOUSE
FROM DELIVERY_MULTIISIN M
WHERE M.ISIN = DELIVERY_DEMAT_TRANS_TMP.ISIN AND EFFDATE <= TRDATE

UPDATE DELIVERY_DEMAT_TRANS_TMP SET SETT_NO = S.SETT_NO, SETT_TYPE = S.SETT_TYPE, EXPIRY_DATE = S.EXPIRY_DATE
FROM DELIVERY_SETT_MST S, DELIVERY_OBL_CLT O
WHERE DELIVERY_DEMAT_TRANS_TMP.TRDATE BETWEEN LEFT(S.EXPIRY_DATE,11) AND LEFT(SEC_PAYIN,11) + ' 23:59'
AND DELIVERY_DEMAT_TRANS_TMP.SYMBOL = O.SYMBOL AND O.SETT_NO = S.SETT_NO AND O.SETT_TYPE = S.SETT_TYPE


UPDATE DELIVERY_DELCODE SET TCODE = @TCODE WHERE REFNO = @REFNO                
            
UPDATE  
 DELIVERY_DEMAT_TRANS  
SET  
 SETT_TYPE = DELIVERY_MARKET_TYPE.SETT_TYPE  
FROM  
 DELIVERY_MARKET_TYPE  
WHERE  
 DELIVERY_MARKET_TYPE.DPTYPE = DELIVERY_DEMAT_TRANS.BDPTYPE  
 AND DELIVERY_MARKET_TYPE.MARKETTYPE = DELIVERY_DEMAT_TRANS.SETT_TYPE  
 
DELETE FROM DELIVERY_DEMAT_TRANS_TMP   
WHERE EXISTS   
(  
 SELECT D.SNO             
 FROM DELIVERY_TRANSACTION D  
 WHERE DELIVERY_DEMAT_TRANS_TMP.SETT_NO = D.SETT_NO            
 AND D.ISIN = DELIVERY_DEMAT_TRANS_TMP.ISIN            
 AND D.FILLER2 = 1 AND D.DRCR = 'C'  
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = D.TRANSDATE           
 AND D.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE            
 AND D.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID            
 AND D.BCLTDPID = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO            
 AND D.FROMNO = DELIVERY_DEMAT_TRANS_TMP.TRANSNO
 AND D.BDPTYPE = 'NSDL'  
 AND DELIVERY_DEMAT_TRANS_TMP.BDPTYPE = 'NSDL'
)  
  
/* TILL HERE */            
                
DELETE FROM DELIVERY_DEMAT_TRANS_TMP  
WHERE EXISTS   
(  
 SELECT DT.SNO FROM DELIVERY_DEMAT_TRANS DT             
 WHERE DELIVERY_DEMAT_TRANS_TMP.SETT_NO = DT.SETT_NO            
 AND DELIVERY_DEMAT_TRANS_TMP.ISIN = DT.ISIN                   
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = DT.TRDATE               
 AND DELIVERY_DEMAT_TRANS_TMP.DRCR = DT.DRCR 
 AND DT.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE            
 AND DT.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID            
 AND DT.BCLTACCNO = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO                 
 AND DT.BDPTYPE = 'NSDL'               
 AND DELIVERY_DEMAT_TRANS_TMP.TRANSNO = DT.TRANSNO  
)  

DELETE FROM DELIVERY_DEMAT_TRANS_TMP  
WHERE EXISTS   
(  
 SELECT DT.SNO FROM DELIVERY_DEMATTRANSOUT DT             
 WHERE DELIVERY_DEMAT_TRANS_TMP.SETT_NO = DT.SETT_NO            
 AND DELIVERY_DEMAT_TRANS_TMP.ISIN = DT.ISIN                   
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = DT.TRDATE               
 AND DELIVERY_DEMAT_TRANS_TMP.DRCR = DT.DRCR 
 AND DT.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE            
 AND DT.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID            
 AND DT.BCLTACCNO = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO                 
 AND DT.BDPTYPE = 'NSDL'               
 AND DELIVERY_DEMAT_TRANS_TMP.TRANSNO = DT.TRANSNO  
)  

DELETE FROM DELIVERY_DEMAT_TRANS_TMP   
WHERE EXISTS   
(  
 SELECT D.SNO             
 FROM DELIVERY_TRANSACTION D  
 WHERE D.ISIN = DELIVERY_DEMAT_TRANS_TMP.ISIN            
 AND D.FILLER2 = 1 AND D.DRCR = 'C'             
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = D.TRANSDATE               
 AND D.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE            
 AND D.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID            
 AND D.BCLTDPID = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO            
 AND D.BDPTYPE = 'CDSL'  
 AND D.FILLER1 = DELIVERY_DEMAT_TRANS_TMP.FILLER1
)  

/* TILL HERE */            
                
DELETE FROM DELIVERY_DEMAT_TRANS_TMP  
WHERE EXISTS   
(  
 SELECT DT.SNO FROM DELIVERY_DEMAT_TRANS DT             
 WHERE DELIVERY_DEMAT_TRANS_TMP.ISIN = DT.ISIN                   
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = DT.TRDATE               
 AND DELIVERY_DEMAT_TRANS_TMP.DRCR = DT.DRCR               
 AND DT.BDPTYPE = 'CDSL'               
 AND DT.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE
 AND DT.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID
 AND DT.BCLTACCNO = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO
 AND DT.FILLER1 = DELIVERY_DEMAT_TRANS_TMP.FILLER1
)  
         
DELETE FROM DELIVERY_DEMAT_TRANS_TMP  
WHERE EXISTS   
(  
 SELECT DT.SNO FROM DELIVERY_DEMATTRANSOUT DT             
 WHERE DELIVERY_DEMAT_TRANS_TMP.ISIN = DT.ISIN                   
 AND DELIVERY_DEMAT_TRANS_TMP.TRDATE = DT.TRDATE              
 AND DELIVERY_DEMAT_TRANS_TMP.DRCR = DT.DRCR               
 AND DT.BDPTYPE = 'CDSL'               
 AND DT.BDPTYPE = DELIVERY_DEMAT_TRANS_TMP.BDPTYPE
 AND DT.BDPID = DELIVERY_DEMAT_TRANS_TMP.BDPID
 AND DT.BCLTACCNO = DELIVERY_DEMAT_TRANS_TMP.BCLTACCNO
 AND DT.FILLER1 = DELIVERY_DEMAT_TRANS_TMP.FILLER1
)  

INSERT INTO DELIVERY_DEMAT_TRANS  
(  
 SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,  
 INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,CLTACCNO,DPID,DPNAME,  
 ISIN,BRANCH_CD,PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,BDPTYPE,BDPID,BCLTACCNO,  
 FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,WAREHOUSE  
)  
SELECT  
 SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,  
 INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,CLTACCNO,DPID,DPNAME,  
 ISIN,BRANCH_CD,PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,BDPTYPE,BDPID,BCLTACCNO,  
 FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,WAREHOUSE  
FROM  
 DELIVERY_DEMAT_TRANS_TMP  
                
UPDATE DELIVERY_DEMAT_TRANS 
SET SETT_NO = '9999999', SETT_TYPE = 'NO'
WHERE SETT_NO NOT IN (SELECT SETT_NO FROM DELIVERY_OBL_CLT)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Entry_Fetch
-- --------------------------------------------------

CREATE Proc Delivery_Entry_Fetch
        (
        @Sett_Type varchar(2),
        @Sett_No varchar(8),
        @Sell_Buy char(1),
        @RefNo int,
        @PartyCode varchar(10),
        @Symbol varchar(12),
        @WareHouse varchar(20),
        @Exchange varchar(3),
        @strFlag varchar(8)
        ) AS

Set Transaction isolation level read uncommitted


CREATE TABLE [#DelObl] 
(
        [Branch_Cd] [varchar] (10)  ,
        [MemberCode] [varchar] (15)  ,
        [Party_Code] [varchar] (10)  ,
        [Inst_Type] [varchar] (6)  ,
        [Symbol] [varchar] (12)  ,
        [ExpiryDate] [datetime]  ,
        [WareHouse] [varchar] (20)  ,
        [Sell_Buy] [varchar] (1)  ,
        [Isin] [varchar] (12)  ,
        [TotQty] [numeric](18, 4) ,
        [RecvQty] [numeric](18, 4),
        [TransQty] [numeric](18, 4)
)



CREATE INDEX [index1] ON [dbo].[#DelObl] ([Party_Code], [Inst_Type],[Symbol],[ExpiryDate],[WareHouse])


Insert into #DelObl
Select
        Branch_Cd = Case When @Sell_Buy= 'B' Then 'HO' Else C1.Branch_Cd End,C.MemberCode,
        Case When @Sell_Buy= 'B' Then @Exchange Else C.Party_Code End Party_Code  ,
        C.Inst_Type, C.Symbol,C.Expiry_Date,
        C.WareHouse,Sell_Buy,'',Sum(ToTal_Allocated_Qty) , 0 ,0
From 
        Delivery_Obl_Clt C, Client1 C1, Client2 C2 
Where C.Sett_type = @Sett_Type And C.Sett_no = @Sett_No
        and c1.Cl_Code = c2.Cl_Code and c2.Party_Code = C.Party_Code 
        And Sell_Buy = @Sell_Buy
        And C.Party_Code like @PartyCode +'%'
        And C.Symbol like @Symbol +'%'
        And C.WareHouse like @WareHouse +'%'

Group By 
        C.MemberCode,C1.Branch_Cd,
        Case When @Sell_Buy= 'B' Then @Exchange Else C.Party_Code End,
        C.Inst_Type,C.Symbol,
        C.Expiry_Date,C.WareHouse,Sell_Buy

Update #DelObl Set Isin = N.IsIn
From
        (
                Select
                        Distinct Inst_Type,Symbol,Expiry_Date,WareHouse,IsIn
                From
                        Delivery_Obl_Net 
                Where
                        Sett_type = @Sett_Type And Sett_no = @Sett_No
        ) N
Where  #DelObl.Inst_Type = N.Inst_Type
and #DelObl.Symbol = N.Symbol
and Convert(varchar,#DelObl.ExpiryDate,103) = Convert(varchar,N.Expiry_Date,103)
and #DelObl.WareHouse = N.WareHouse


Update #DelObl Set RecvQty = T.RecvQty 
From 
(
        Select Party_Code,Inst_Type,Symbol,Expiry_Date,WareHouse,Sum(Qty) RecvQty From Delivery_Demat_Trans 
        Where  Sett_type = @Sett_Type And Sett_no = @Sett_No
        and refno = @RefNo 
        And Party_Code like @PartyCode +'%'
        And Symbol like @Symbol +'%'
        And WareHouse like @WareHouse +'%'
        Group By  Party_Code,Inst_Type,Symbol,Expiry_Date,WareHouse
) T
Where 
        #DelObl.Party_Code = T.Party_Code
        And #DelObl.Inst_Type = T.Inst_Type
        And #DelObl.Symbol = T.Symbol
        And Convert(varchar,#DelObl.ExpiryDate,103) = convert(varchar,T.Expiry_Date,103)
        And #DelObl.WareHouse = T.WareHouse



Update #DelObl Set TransQty = T.TransQty 
From 
(
        Select Party_Code,Inst_Type,Symbol,Expiry_Date,WareHouse,Sum(Qty) TransQty From Delivery_Transaction 
        Where  Sett_type = @Sett_Type And Sett_no = @Sett_No
        and DrCr = Case When @Sell_Buy ='S' then 'C' else 'D' End and refno = 1 and Active = @RefNo
        And Party_Code like @PartyCode +'%'
        And Symbol like @Symbol +'%'
        And WareHouse like @WareHouse +'%'
        Group By  Party_Code,Inst_Type,Symbol,Expiry_Date,WareHouse
) T
Where 
        #DelObl.Party_Code = T.Party_Code
        And #DelObl.Inst_Type = T.Inst_Type
        And #DelObl.Symbol = T.Symbol
        And Convert(varchar,#DelObl.ExpiryDate,103) = convert(varchar,T.Expiry_Date,103)
        And #DelObl.WareHouse = T.WareHouse



if @strFlag='ALL'
        Begin                
                Select Case When Branch_Cd ='' Then 'HO' else Branch_Cd End Branch_Cd ,MemberCode,Party_Code,Inst_Type,
                        Symbol,Convert(varchar,ExpiryDate,103) ExpiryDate ,WareHouse,
                        Sell_Buy,Isin,TotQty,RecvQty,TransQty, AvailQty = TotQty-TransQty-RecvQty 
                From #DelObl
                Order By 
                      Party_Code,Inst_Type,Symbol,ExpiryDate,WareHouse,Sell_Buy
        End
Else
        Begin
                
                Select Case When Branch_Cd ='' Then 'HO' else Branch_Cd End Branch_Cd ,MemberCode,Party_Code,Inst_Type,
                        Symbol,Convert(varchar,ExpiryDate,103) ExpiryDate ,WareHouse,
                        Sell_Buy,Isin,TotQty,RecvQty,TransQty, AvailQty = TotQty-TransQty-RecvQty 
                From #DelObl
                Where
                      TotQty-TransQty-RecvQty > 0
                Order By 
                      Party_Code,Inst_Type,Symbol,ExpiryDate,WareHouse,Sell_Buy        
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_FOSETT_UPD
-- --------------------------------------------------

CREATE PROC [dbo].[DELIVERY_FOSETT_UPD] (@SETT_NO VARCHAR(12),@SETT_TYPE VARCHAR(3)) AS          
          
/*          
  PROCEDURE FOR GETTING DELIVERY BILL DATA AND STORING IN DELIVERY_FOSETT TABLE FOR FURTHER PROCESS          
  CALLING FROM DELIVERY_VALANGENERATE           
  AUTHOR : SINULAL          
  DATE   : 20 OCT 2004          
  MODIFICATION LOG : 15 JUN 2005 - INCLUDED PREMIUM/DISC/SHORTAGE    
			5 FEB 08 SALES TAX      
*/          
          
DECLARE @INTCOUNT INT    
    
DELETE FROM DELIVERY_FOSETT WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
          
INSERT INTO DELIVERY_FOSETT          
SELECT CONTRACTNO=0,BILLNO=0,TRADE_NO=CASE WHEN LEN(MEMBER_AC_TYPE)=12 THEN MEMBER_AC_TYPE ELSE '0' END,D.PARTY_CODE,D.INST_TYPE,D.SYMBOL,F.SEC_NAME,          
 EXPIRYDATE=F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,          
 USERID=' ',PRO_CLI=' ',O_C_FLAG=' ',C_U_FLAG=' ',D.TOTAL_ALLOCATED_QTY,AUCTIONPART=' ',          
 MARKETTYPE=DELIVERY_LOT,SERIES=' ',  
 ORDER_NO=CASE WHEN DEL_REC_NO = '99999' THEN 'PRMDISC' WHEN DEL_REC_NO = '88888' THEN 'CLOSEOUT' ELSE '' END,  
 PRICE=0,SAUDA_DATE=REQUEST_DATE,          
 TABLE_NO=0,LINE_NO=0,VAL_PERC=' ',NORMAL=0,DAY_PUC=0,DAY_SALES=0,          
 SETT_PURCH=0,SETT_SALES=0,SELL_BUY=CASE WHEN D.SELL_BUY='S' THEN 2 ELSE 1 END,SETTFLAG=0,BROKAPPLIED=0,          
 NETRATE=0,AMOUNT = 0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,SERVICE_TAX=0,          
 TRADE_AMOUNT= 0,BILLFLAG=0,SETT_NO=D.SETT_NO,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,          
 SETT_TYPE=D.SETT_TYPE,CL_RATE=0,PARTICIPANTCODE=' ',STATUS=' ',CPID=' ',INSTRUMENT=F.DENOMINATOR,          
 BOOKTYPE=NUMERATOR,BRANCH_ID=' ',TMARK=' ',SCHEME=0,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=WAREHOUSE          
          
FROM DELIVERY_OBL_CLT D,FOSCRIP2 F WHERE D.SYMBOL=F.SYMBOL AND F.INST_TYPE = D.INST_TYPE          
     AND F.EXPIRYDATE = D.EXPIRY_DATE           
     AND D.SETT_NO = @SETT_NO           
     AND D.SETT_TYPE = @SETT_TYPE    
     AND TOTAL_ALLOCATED_QTY > 0      

	SELECT *
	INTO #DELIVERY_OBL_NET 
	FROM DELIVERY_OBL_NET (NOLOCK) WHERE 1 = 2
	
	IF @SETT_TYPE = 'A'
	BEGIN
		INSERT INTO #DELIVERY_OBL_NET 
		SELECT *		
		FROM DELIVERY_OBL_NET (NOLOCK)
		WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
	END
	ELSE
	BEGIN
		INSERT INTO #DELIVERY_OBL_NET
		SELECT DEL_REC_NO,REPORT_DATE,SETT_TYPE,SETT_NO,INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,
		OPTION_TYPE,WAREHOUSE,PAYIN_QTY=PAYOUT_QTY,PAYOUT_QTY=PAYIN_QTY,
		PAYIN_VALUE,PAYOUT_VALUE,ISIN		 
		FROM DELIVERY_OBL_NET (NOLOCK)
		WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
	END

              
    UPDATE D SET PRICE=C.CL_RATE, CL_RATE=C.CL_RATE , TRADE_NO = ISIN   
       FROM DELIVERY_FOSETT D,     
      (    
       SELECT DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE EXPIRYDATE,ISIN, 
       ABS((SUM(PAYIN_VALUE)*DENOMINATOR/NUMERATOR) / SUM(PAYIN_QTY))  CL_RATE    
       FROM #DELIVERY_OBL_NET D ,FOSCRIP2 F    
       WHERE D.INST_TYPE= F.INST_TYPE    
       AND D.SYMBOL= F.SYMBOL    
       AND D.EXPIRY_DATE = F.EXPIRYDATE    
       AND D.OPTION_TYPE = F.OPTION_TYPE    
       AND D.STRIKE_PRICE = F.STRIKE_PRICE    
       AND SETT_NO = @SETT_NO           
       AND SETT_TYPE = @SETT_TYPE
       AND PAYIN_QTY > 0
       GROUP BY DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE,NUMERATOR,DENOMINATOR,ISIN        
      ) C     
     WHERE    
	D.SETT_TYPE = @SETT_TYPE    
	AND D.SETT_NO = @SETT_NO    
	AND D.SYMBOL=C.SYMBOL AND C.INST_TYPE = D.INST_TYPE    
	AND C.EXPIRYDATE = D.EXPIRYDATE    
	AND D.RESERVED2 = C.WAREHOUSE    
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND ORDER_NO = (CASE WHEN DEL_REC_NO = '99999' THEN 'PRMDISC' WHEN DEL_REC_NO = '88888' 
			THEN 'CLOSEOUT' ELSE '' END)
	AND SETT_TYPE <> 'B'
	AND TRADE_NO = '0'
	AND SELL_BUY = 1
	
              
    UPDATE D SET PRICE=C.CL_RATE, CL_RATE=C.CL_RATE , TRADE_NO = ISIN   
       FROM DELIVERY_FOSETT D,     
      (    
       SELECT DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE EXPIRYDATE,ISIN, 
       ABS((SUM(PAYOUT_VALUE)*DENOMINATOR/NUMERATOR) / SUM(PAYOUT_QTY))  CL_RATE    
       FROM #DELIVERY_OBL_NET D ,FOSCRIP2 F    
       WHERE D.INST_TYPE= F.INST_TYPE    
       AND D.SYMBOL= F.SYMBOL    
       AND D.EXPIRY_DATE = F.EXPIRYDATE    
       AND D.OPTION_TYPE = F.OPTION_TYPE    
       AND D.STRIKE_PRICE = F.STRIKE_PRICE    
       AND SETT_NO = @SETT_NO           
       AND SETT_TYPE = @SETT_TYPE
   AND PAYOUT_QTY > 0
       GROUP BY DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE,NUMERATOR,DENOMINATOR,ISIN        
      ) C     
     WHERE    
	D.SETT_TYPE = @SETT_TYPE    
	AND D.SETT_NO = @SETT_NO    
	AND D.SYMBOL=C.SYMBOL AND C.INST_TYPE = D.INST_TYPE    
	AND C.EXPIRYDATE = D.EXPIRYDATE    
	AND D.RESERVED2 = C.WAREHOUSE    
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND ORDER_NO = (CASE WHEN DEL_REC_NO = '99999' THEN 'PRMDISC' WHEN DEL_REC_NO = '88888' 
			THEN 'CLOSEOUT' ELSE '' END)
	AND SETT_TYPE <> 'B'
	AND TRADE_NO = '0'
	AND SELL_BUY = 2

    UPDATE D SET PRICE=C.CL_RATE, CL_RATE=C.CL_RATE   
       FROM DELIVERY_FOSETT D,     
      (    
       SELECT DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE EXPIRYDATE,ISIN, 
       ABS((SUM(PAYIN_VALUE)*DENOMINATOR/NUMERATOR) / SUM(PAYIN_QTY))  CL_RATE    
       FROM #DELIVERY_OBL_NET D ,FOSCRIP2 F    
       WHERE D.INST_TYPE= F.INST_TYPE    
       AND D.SYMBOL= F.SYMBOL    
       AND D.EXPIRY_DATE = F.EXPIRYDATE    
       AND D.OPTION_TYPE = F.OPTION_TYPE    
       AND D.STRIKE_PRICE = F.STRIKE_PRICE    
       AND SETT_NO = @SETT_NO           
       AND SETT_TYPE = @SETT_TYPE
       AND PAYIN_QTY > 0
       GROUP BY DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE,NUMERATOR,DENOMINATOR,ISIN        
      ) C     
     WHERE    
	D.SETT_TYPE = @SETT_TYPE    
	AND D.SETT_NO = @SETT_NO    
	AND D.SYMBOL=C.SYMBOL AND C.INST_TYPE = D.INST_TYPE    
	AND C.EXPIRYDATE = D.EXPIRYDATE    
	AND D.RESERVED2 = C.WAREHOUSE    
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND ORDER_NO = (CASE WHEN DEL_REC_NO = '99999' THEN 'PRMDISC' WHEN DEL_REC_NO = '88888' 
			THEN 'CLOSEOUT' ELSE '' END)
	AND SETT_TYPE <> 'B'
	AND TRADE_NO <> '0'
	AND TRADE_NO = ISIN
	AND SELL_BUY = 1


    UPDATE D SET PRICE=C.CL_RATE, CL_RATE=C.CL_RATE   
       FROM DELIVERY_FOSETT D,     
      (    
       SELECT DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE EXPIRYDATE,ISIN, 
       ABS((SUM(PAYOUT_VALUE)*DENOMINATOR/NUMERATOR) / SUM(PAYOUT_QTY))  CL_RATE    
       FROM #DELIVERY_OBL_NET D ,FOSCRIP2 F    
       WHERE D.INST_TYPE= F.INST_TYPE    
       AND D.SYMBOL= F.SYMBOL    
       AND D.EXPIRY_DATE = F.EXPIRYDATE    
       AND D.OPTION_TYPE = F.OPTION_TYPE    
       AND D.STRIKE_PRICE = F.STRIKE_PRICE    
       AND SETT_NO = @SETT_NO           
       AND SETT_TYPE = @SETT_TYPE
       AND PAYOUT_QTY > 0
       GROUP BY DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE,NUMERATOR,DENOMINATOR,ISIN        
      ) C     
     WHERE    
	D.SETT_TYPE = @SETT_TYPE    
	AND D.SETT_NO = @SETT_NO    
	AND D.SYMBOL=C.SYMBOL AND C.INST_TYPE = D.INST_TYPE    
	AND C.EXPIRYDATE = D.EXPIRYDATE    
	AND D.RESERVED2 = C.WAREHOUSE    
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND ORDER_NO = (CASE WHEN DEL_REC_NO = '99999' THEN 'PRMDISC' WHEN DEL_REC_NO = '88888' 
			THEN 'CLOSEOUT' ELSE '' END)
	AND SETT_TYPE <> 'B'
	AND TRADE_NO <> '0'
	AND TRADE_NO = ISIN
	AND SELL_BUY = 2

    UPDATE D SET PRICE=C.CL_RATE, CL_RATE=C.CL_RATE , TRADE_NO = ISIN   
       FROM DELIVERY_FOSETT D,     
      (    
       SELECT DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE EXPIRYDATE,ISIN, 
       ABS((SUM(PAYIN_VALUE+PAYOUT_VALUE)*DENOMINATOR/NUMERATOR) / SUM(PAYIN_QTY+ PAYOUT_QTY)) CL_RATE    
       FROM #DELIVERY_OBL_NET D ,FOSCRIP2 F    
       WHERE D.INST_TYPE= F.INST_TYPE    
       AND D.SYMBOL= F.SYMBOL    
       AND D.EXPIRY_DATE = F.EXPIRYDATE    
       AND D.OPTION_TYPE = F.OPTION_TYPE    
       AND D.STRIKE_PRICE = F.STRIKE_PRICE    
       AND SETT_NO = @SETT_NO           
       AND SETT_TYPE = @SETT_TYPE
       GROUP BY DEL_REC_NO, D.INST_TYPE,D.SYMBOL,WAREHOUSE,EXPIRY_DATE,NUMERATOR,DENOMINATOR,ISIN        
      ) C     
     WHERE    
	D.SETT_TYPE = @SETT_TYPE    
	AND D.SETT_NO = @SETT_NO    
	AND D.SYMBOL=C.SYMBOL AND C.INST_TYPE = D.INST_TYPE    
	AND C.EXPIRYDATE = D.EXPIRYDATE    
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND SETT_TYPE = 'B' /*SALES TAX*/
	AND ISIN = RESERVED2
	
          
UPDATE DELIVERY_FOSETT  SET PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER) WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
    
UPDATE D SET    
  BROKAPPLIED= (CASE WHEN D.SELL_BUY = 1 THEN          
                 ((FLOOR(( ((B.DAY_SALES * D.PRICE*BOOKTYPE/INSTRUMENT)/100) *          
                 POWER(10,B.ROUND_TO)+B.ROFIG + B.ERRNUM ) /                
                (B.ROFIG + B.NOZERO )) * (B.ROFIG +B.NOZERO ) )  /               
                POWER(10,B.ROUND_TO))            
                ELSE          
                ((FLOOR(( ((B.DAY_PUC * D.PRICE*BOOKTYPE/INSTRUMENT)/100) *          
                POWER(10,B.ROUND_TO)+B.ROFIG + B.ERRNUM ) /                
                (B.ROFIG + B.NOZERO )) * (B.ROFIG +B.NOZERO ) )  /               
               POWER(10,B.ROUND_TO))            
            END),    
 TABLE_NO = B.TABLE_NO,    
 DAY_SALES = B.DAY_SALES ,    
 DAY_PUC = B.DAY_PUC,    
 LINE_NO = B.LINE_NO    
 FROM 
	BROKTABLE B,DELIVERY_FOSETT D, CLIENT1 C1, FOCLIENTBROKSCHEME, CLIENT2  C2          
 WHERE
	C1.CL_CODE=C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE AND    
	D.SAUDA_DATE BETWEEN  DATE_FROM AND DATE_TO AND   
	D.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND   
	B.TABLE_NO = COMM_DEL_BROKTABLE AND          
	B.LINE_NO  =   
   (  
	SELECT MIN(LINE_NO) FROM BROKTABLE          
	WHERE TRD_DEL <> 'D'  AND TABLE_NO = COMM_DEL_BROKTABLE  
	AND PRICE <= BROKTABLE.UPPER_LIM  
   )          
	AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
	AND SETT_TYPE NOT IN ('B','A')
	
	/*AND 1 = (CASE 
		WHEN SETT_TYPE = 'A' 
		THEN 
			CASE WHEN ORDER_NO ='CLOSEOUT' AND SELL_BUY = 1 THEN 1 ELSE 2 END
		ELSE 1 END)*/
		
UPDATE D SET    
   SERVICE_TAX =          
      CASE WHEN C2.SERVICE_CHRG = 1 AND C2.SERTAXMETHOD = 1 THEN 0 ELSE           
           ((FLOOR ( (BROKAPPLIED * TRADEQTY *  F.SERVICE_TAX/100 * POWER(10,B.ROUND_TO) +              
           B.ROFIG + B.ERRNUM  ) /  (B.ROFIG +               
           B.NOZERO)) * (B.ROFIG +             
           B.NOZERO) )  / POWER(10,B.ROUND_TO))    
         END           
   FROM BROKTABLE B,DELIVERY_FOSETT D,FOGLOBALS F, CLIENT1 C1, FOCLIENTBROKSCHEME, CLIENT2 C2          
   WHERE 
	C1.CL_CODE=C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE AND          
	D.SAUDA_DATE BETWEEN F.YEAR_START_DT AND YEAR_END_DT AND          
	D.SAUDA_DATE BETWEEN  DATE_FROM AND DATE_TO AND   
	D.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND   
	B.TABLE_NO = COMM_DEL_BROKTABLE AND          
	B.LINE_NO  =   
   (  
	SELECT MIN(LINE_NO) FROM BROKTABLE          
	WHERE TRD_DEL <> 'D'  AND TABLE_NO = COMM_DEL_BROKTABLE  
	AND PRICE <= BROKTABLE.UPPER_LIM  
   )          
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
   AND SETT_TYPE NOT IN ('B','A')
   /*
   AND 1 = (CASE 
		WHEN SETT_TYPE = 'A' 
		THEN 
			CASE WHEN ORDER_NO ='CLOSEOUT' AND SELL_BUY = 1 THEN 1 ELSE 2 END
		ELSE 1 END)*/
          
UPDATE DELIVERY_FOSETT SET NETRATE=PRICE + (BROKAPPLIED * INSTRUMENT/BOOKTYPE)     
WHERE SELL_BUY = 1 AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
      
UPDATE DELIVERY_FOSETT SET NETRATE=PRICE - (BROKAPPLIED * INSTRUMENT/BOOKTYPE)     
WHERE SELL_BUY = 2  AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
          
UPDATE DELIVERY_FOSETT SET BROKAPPLIED = BROKAPPLIED * TRADEQTY ,  
 AMOUNT = NETRATE * TRADEQTY * BOOKTYPE / INSTRUMENT,          
 TRADE_AMOUNT = NETRATE * TRADEQTY * BOOKTYPE / INSTRUMENT          
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE     
          
UPDATE D SET BRANCH_ID = BRANCH_CD FROM DELIVERY_FOSETT D, CLIENT1 C1 , CLIENT2 C2            
WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE     
AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE                 

DECLARE @SAUDA_DATE VARCHAR(11)

SELECT TOP 1 @SAUDA_DATE = SAUDA_DATE FROM DELIVERY_FOSETT
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE


IF @SETT_TYPE <> 'A'
BEGIN     
	UPDATE DELIVERY_FOSETT     
	SET OTHER_CHRG= ROUND((PRICE * TRADEQTY * BOOKTYPE/INSTRUMENT) * DELIVERY_CHRG /100,4)    
	FROM FOTAXES    
	WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE    
	--AND DELIVERY_FOSETT.SYMBOL = FOTAXES.SYMBOL    
	AND SETT_TYPE NOT IN ('B','A')    
	AND NOT EXISTS (SELECT PARTY_CODE FROM DELIVERY_CHRG_PARTY_EXCEPTION E WHERE    
		E.PARTY_CODE = DELIVERY_FOSETT.PARTY_CODE    
		AND @SAUDA_DATE BETWEEN E.DATE_FROM AND E.DATE_TO)      
END
ELSE
BEGIN

	 DECLARE @D_SETT_TYPE VARCHAR(2)  -- DELIVERY ORGINAL SETTLEMENT  
	 DECLARE @D_SETT_NO VARCHAR(7)  


	 SELECT  TOP 1 @D_SETT_TYPE=D_SETT_TYPE, @D_SETT_NO=D_SETT_NO FROM DELIVERY_OBL_CLOSEOUT  
	 WHERE SETT_TYPE = @SETT_TYPE AND SETT_NO = @SETT_NO  

		  
	 /*UPDATE DELIVERY_FOSETT SET OTHER_CHRG=DEL_CHRG_DIFF
	 FROM
		(SELECT 
			SRNO,PARTY_CODE, SYMBOL,DEL_CHRG_ORG,DEl_CHRG_NEW,DEL_CHRG_DIFF=(DEl_CHRG_NEW-DEl_CHRG_ORG)
			FROM 
			( 
				 SELECT   
				  SRNO = MAX( CASE WHEN B.ORDER_NO ='CLOSEOUT' THEN B.SRNO ELSE 0 END ),
				  B.PARTY_CODE,   
				  B.SYMBOL,   
				  DEL_CHRG_ORG = A.OTHER_CHRG ,
				  DEl_CHRG_NEW  = ROUND(SUM(ROUND(ABS(CASE WHEN ((A.SELL_BUY=1 AND B.SELL_BUY=2) OR (A.SELL_BUY=2 AND B.SELL_BUY=1)) 
									THEN(A.PRICE -B.PRICE) ELSE (A.PRICE + B.PRICE) END)*A.BOOKTYPE /A.INSTRUMENT * B.TRADEQTY,2) * DELIVERY_CHRG/100),4)
				 FROM    
				  DELIVERY_FOSETT B (NOLOCK),   
				  DELIVERY_FOSETT A  (NOLOCK),
				  FOTAXES (NOLOCK) 
				 WHERE   
				  A.SETT_TYPE = @D_SETT_TYPE  
				  AND A.SETT_NO =  @D_SETT_NO  
				  AND B.SETT_TYPE = @SETT_TYPE  
				  AND B.SETT_NO =  @SETT_NO  
				  AND A.PARTY_CODE = B.PARTY_CODE  
				  AND A.SYMBOL = B.SYMBOL  
				  AND A.EXPIRYDATE = B.EXPIRYDATE  
				  AND A.RESERVED2 = B.RESERVED2  
				  AND B.ORDER_NO IN ('PRMDISC','CLOSEOUT')  
				 -- AND A.SYMBOL = FOTAXES.SYMBOL
				  AND A.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE
				 GROUP BY B.PARTY_CODE,B.SYMBOL,A.OTHER_CHRG
			 ) D 
			WHERE (DEl_CHRG_NEW-DEl_CHRG_ORG) <> 0
	 ) DCHRG
	 WHERE DCHRG.SRNO = DELIVERY_FOSETT.SRNO
	 AND DELIVERY_FOSETT.ORDER_NO NOT IN ('PRMDISC')  */
		 
	  UPDATE DELIVERY_FOSETT SET OTHER_CHRG=-DEL_CHRG_DIFF        
	  FROM        
	  (SELECT         
	   SRNO,PARTY_CODE, SYMBOL,DEL_CHRG_ORG,DEl_CHRG_NEW,DEL_CHRG_DIFF=(DEl_CHRG_NEW-DEl_CHRG_ORG)        
	   FROM         
	   (         
		 SELECT           
		  SRNO = MAX( CASE WHEN B.ORDER_NO ='CLOSEOUT' THEN B.SRNO ELSE 0 END ),
		  B.PARTY_CODE,           
		  B.SYMBOL,           
		  DEL_CHRG_ORG = 0 ,        
		  DEl_CHRG_NEW  = ROUND(SUM(ROUND((A.PRICE)*A.BOOKTYPE /A.INSTRUMENT * B.TRADEQTY,2) * DELIVERY_CHRG/100),4)        
		 FROM            
		  DELIVERY_FOSETT B (NOLOCK),           
		  DELIVERY_FOSETT A  (NOLOCK),        
		  FOTAXES (NOLOCK)         
		 WHERE           
		  A.SETT_TYPE = @D_SETT_TYPE          
		  AND A.SETT_NO =  @D_SETT_NO          
		  AND B.SETT_TYPE = @SETT_TYPE          
		  AND B.SETT_NO =  @SETT_NO          
		  AND A.PARTY_CODE = B.PARTY_CODE          
		 AND A.SYMBOL = B.SYMBOL          
		  AND A.EXPIRYDATE = B.EXPIRYDATE          
		  AND A.RESERVED2 = B.RESERVED2               
		  AND B.SETT_TYPE <> 'B'         
		  AND B.ORDER_NO IN ('CLOSEOUT')          
		  AND A.SYMBOL = FOTAXES.SYMBOL        
		  AND A.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE        
		 GROUP BY B.PARTY_CODE,B.SYMBOL,A.OTHER_CHRG        
		) D         
	   WHERE (DEl_CHRG_NEW-DEl_CHRG_ORG) <> 0        
	  ) DCHRG        
	  WHERE DCHRG.SRNO = DELIVERY_FOSETT.SRNO        
	 AND DELIVERY_FOSETT.ORDER_NO NOT IN ('PRMDISC') 
	  
	
END      


   UPDATE DELIVERY_FOSETT SET          
   SERVICE_TAX =   D.SERVICE_TAX +                              
          ROUND(ABS(D.OTHER_CHRG) *  F.SERVICE_TAX/100,2)          
   FROM DELIVERY_FOSETT D,FOGLOBALS F, CLIENT1 C1, CLIENT2 C2           
   WHERE       
	C1.CL_CODE=C2.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE AND                
	D.SAUDA_DATE BETWEEN F.YEAR_START_DT AND YEAR_END_DT AND
	SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE 
	AND SETT_TYPE NOT IN ('B')       
	AND NOT EXISTS (SELECT PARTY_CODE FROM DELIVERY_CHRG_PARTY_EXCEPTION E WHERE    
	E.PARTY_CODE = D.PARTY_CODE    
	AND @SAUDA_DATE BETWEEN E.DATE_FROM AND E.DATE_TO) 


UPDATE DELIVERY_FOSETT
   SET SERVICE_TAX = 0,
       NSERTAX = 0
  FROM CLIENT1 C1 (NOLOCK),
       CLIENT2 C2 (NOLOCK)
 WHERE C1.CL_CODE = C2.CL_CODE
   AND C2.PARTY_CODE = DELIVERY_FOSETT.PARTY_CODE
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
   AND L_STATE = 'JAMMU AND KASHMIR'
   AND SERVICE_CHRG = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsDelCheckPos
-- --------------------------------------------------

CREATE  PROC DELIVERY_INSDELCHECKPOS (@REFNO INT) AS  
DECLARE  
@@SNO NUMERIC(18,0),  
@@SETT_NO VARCHAR(7),  
@@SETT_TYPE VARCHAR(2),  
@@PARTY_CODE VARCHAR(10),  
@@SYMBOL VARCHAR(12),  
@@EXPIRY_DATE VARCHAR(20),  
@@WAREHOUSE VARCHAR(20),  
@@DEMATQTY NUMERIC(18,4) ,  
@@CERTQTY NUMERIC(18,4) ,  
@@DELQTY NUMERIC(18,4) ,  
@@DQTY NUMERIC(18,4) ,  
@@REMQTY NUMERIC(18,4) ,  
@@CLTACCNO VARCHAR(16),  
@@BANKCODE VARCHAR(16),  
@@TRANSNO VARCHAR(16),  
@@DEMATCUR CURSOR,  
@@DELCUR CURSOR,  
@@MCUR CURSOR,  
@@DCUR CURSOR,  
@@CERTCUR CURSOR  
  
  
UPDATE DELIVERY_DEMAT_TRANS     
SET    
 INST_TYPE = M.INST_TYPE,     
 SYMBOL = M.SYMBOL,    
 WAREHOUSE = M.WAREHOUSE    
FROM    
 DELIVERY_MULTIISIN M    
WHERE    
 M.ISIN = DELIVERY_DEMAT_TRANS.ISIN                   
 AND EFFDATE <= TRDATE    

    
/*UPDATE    
 DELIVERY_DEMAT_TRANS    
SET    
 EXPIRY_DATE = D.EXPIRY_DATE,    
 SETT_TYPE = D.SETT_TYPE    
FROM    
 DELIVERY_OBL_CLT D    
WHERE    
 D.SETT_NO = DELIVERY_DEMAT_TRANS.SETT_NO    
 AND D.INST_TYPE = DELIVERY_DEMAT_TRANS.INST_TYPE    
 AND D.SYMBOL = DELIVERY_DEMAT_TRANS.SYMBOL    
 AND TRTYPE <> 906    
*/

UPDATE DELIVERY_DEMAT_TRANS SET SETT_NO = S.SETT_NO, SETT_TYPE = S.SETT_TYPE, EXPIRY_DATE = S.EXPIRY_DATE
FROM DELIVERY_SETT_MST S, DELIVERY_OBL_CLT O
WHERE DELIVERY_DEMAT_TRANS.TRDATE BETWEEN S.EXPIRY_DATE AND SEC_PAYIN
AND DELIVERY_DEMAT_TRANS.SYMBOL = O.SYMBOL AND O.SETT_NO = S.SETT_NO AND O.SETT_TYPE = S.SETT_TYPE

UPDATE DELIVERY_DEMAT_TRANS SET                   
PARTY_CODE = 'EXE'                  
WHERE TRTYPE = 906                   
                    
DELETE FROM DELIVERY_DEMAT_TRANS WHERE DRCR = 'D' AND TRTYPE <> 906  
  
UPDATE DELIVERY_DEMAT_TRANS SET DPID = LEFT(CLTACCNO,8) WHERE DPID = '' AND DPTYPE = 'CDSL'  
  
SET @@DEMATCUR = CURSOR FOR  
SELECT SETT_NO,SETT_TYPE,CLTACCNO,DPID,QTY,SYMBOL,EXPIRY_DATE,WAREHOUSE,TRANSNO,SNO FROM DELIVERY_DEMAT_TRANS  
WHERE PARTY_CODE = 'PARTY' AND DRCR = 'C' AND DPID <> '' AND REFNO = @REFNO AND TRTYPE <> 906  
OPEN @@DEMATCUR  
FETCH NEXT FROM @@DEMATCUR INTO @@SETT_NO,@@SETT_TYPE,@@CLTACCNO,@@BANKCODE,@@DEMATQTY,@@SYMBOL,@@EXPIRY_DATE,@@WAREHOUSE,@@TRANSNO,@@SNO   
IF @@FETCH_STATUS = 0   
BEGIN  
 WHILE @@FETCH_STATUS = 0   
 BEGIN   
  SET @@MCUR = CURSOR FOR  
  SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = @@BANKCODE AND CLTDPNO = @@CLTACCNO  
  OPEN @@MCUR   
  FETCH NEXT FROM @@MCUR INTO @@PARTY_CODE   
  IF @@FETCH_STATUS = 0   
  BEGIN   
   WHILE @@FETCH_STATUS = 0 AND @@DEMATQTY > 0   
   BEGIN  
    SET @@DELCUR = CURSOR FOR  
    SELECT ISNULL(SUM(TOTAL_ALLOCATED_QTY),0) FROM DELIVERY_OBL_CLT WHERE SETT_NO = @@SETT_NO   
    AND SETT_TYPE = @@SETT_TYPE AND PARTY_CODE = @@PARTY_CODE   
    AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE   
    AND WAREHOUSE = @@WAREHOUSE  
    AND SELL_BUY = 'S'  
    OPEN @@DELCUR  
    FETCH NEXT FROM @@DELCUR INTO @@DELQTY  
    CLOSE @@DELCUR  
      
    SET @@CERTCUR = CURSOR FOR        
    SELECT ISNULL(SUM(QTY),0) FROM DELIVERY_TRANSACTION WHERE PARTY_CODE = @@PARTY_CODE   
    AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE AND   
    WAREHOUSE = @@WAREHOUSE AND  
    SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DRCR = 'C' AND REFNO = @REFNO   
    OPEN @@CERTCUR  
    FETCH NEXT FROM @@CERTCUR INTO @@CERTQTY  
    CLOSE @@CERTCUR    
      
      
    SET @@DCUR = CURSOR FOR        
    SELECT ISNULL(SUM(QTY),0) FROM DELIVERY_DEMAT_TRANS WHERE PARTY_CODE = @@PARTY_CODE   
    AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE AND   
    WAREHOUSE = @@WAREHOUSE AND  
    SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DRCR = 'C' AND REFNO = @REFNO   
    OPEN @@DCUR  
    FETCH NEXT FROM @@DCUR INTO @@DQTY  
    CLOSE @@DCUR    
  
    SELECT @@REMQTY = @@DELQTY - @@CERTQTY - @@DQTY   
   
    IF @@DEMATQTY <= @@REMQTY AND @@REMQTY > 0  
    BEGIN  
     UPDATE DELIVERY_DEMAT_TRANS SET PARTY_CODE = @@PARTY_CODE   
     WHERE SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND PARTY_CODE = 'PARTY'   
     AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE AND DRCR = 'C' AND SNO = @@SNO  
     AND WAREHOUSE = @@WAREHOUSE  
     AND TRANSNO = @@TRANSNO AND CLTACCNO = @@CLTACCNO AND DPID = @@BANKCODE AND REFNO = @REFNO   
             AND QTY = @@DEMATQTY  
     SELECT @@DEMATQTY = 0   
    END  
    ELSE IF @@DEMATQTY > @@REMQTY AND @@REMQTY > 0  
    BEGIN  
  
  
  
     INSERT INTO DELIVERY_DEMAT_TRANS (SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,  
     PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,  
     CLTACCNO,DPID,DPNAME,ISIN,BRANCH_CD,PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,  
     BDPTYPE,BDPID,BCLTACCNO,FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,WAREHOUSE )  
     SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,  
     PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY=@@DEMATQTY-@@REMQTY,TRDATE,  
     CLTACCNO,DPID,DPNAME,ISIN,BRANCH_CD,PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,  
     BDPTYPE,BDPID,BCLTACCNO,FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,WAREHOUSE  
     FROM DELIVERY_DEMAT_TRANS WHERE SETT_NO = @@SETT_NO AND  
     SETT_TYPE = @@SETT_TYPE AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE AND  
     WAREHOUSE = @@WAREHOUSE AND   
     PARTY_CODE = 'PARTY' AND DRCR = 'C' AND SNO = @@SNO AND TRANSNO = @@TRANSNO  
       AND CLTACCNO = @@CLTACCNO AND DPID = @@BANKCODE AND QTY = @@DEMATQTY AND REFNO = @REFNO   
        
     UPDATE DELIVERY_DEMAT_TRANS SET PARTY_CODE = @@PARTY_CODE,QTY = @@REMQTY    
     WHERE SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND   
     PARTY_CODE = 'PARTY' AND SYMBOL = @@SYMBOL AND EXPIRY_DATE = @@EXPIRY_DATE   
     AND WAREHOUSE = @@WAREHOUSE  
     AND DRCR = 'C' AND SNO = @@SNO AND TRANSNO = @@TRANSNO AND CLTACCNO = @@CLTACCNO AND   
     DPID = @@BANKCODE AND QTY = @@DEMATQTY AND REFNO = @REFNO   
     SELECT @@DEMATQTY = @@DEMATQTY-@@REMQTY  
    END  
    FETCH NEXT FROM @@MCUR INTO @@PARTY_CODE   
   END       
  END  
  CLOSE @@MCUR  
    
  FETCH NEXT FROM @@DEMATCUR INTO @@SETT_NO,@@SETT_TYPE,@@CLTACCNO,@@BANKCODE,@@DEMATQTY,@@SYMBOL,@@EXPIRY_DATE,@@WAREHOUSE,@@TRANSNO,@@SNO   
 END  
END  
CLOSE @@DEMATCUR        
  
  
UPDATE DELIVERY_DEMAT_TRANS SET PARTY_CODE = MULTICLTID.PARTY_CODE FROM MULTICLTID WHERE MULTICLTID.DPID = DELIVERY_DEMAT_TRANS.DPID   
AND MULTICLTID.CLTDPNO = DELIVERY_DEMAT_TRANS.CLTACCNO AND DELIVERY_DEMAT_TRANS.PARTY_CODE = 'PARTY' AND TRTYPE <> 906

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_INSDEMATALLOCATECURSOR
-- --------------------------------------------------

CREATE   PROC [dbo].[DELIVERY_INSDEMATALLOCATECURSOR] (@REFNO INT=1) AS  
DECLARE  
 @@SERIALNO NUMERIC(18,0),   
 @@SNO VARCHAR(7),  
 @@STYPE VARCHAR(2),  
 @@PARTYCD VARCHAR(10),  
 @@SYMBOL VARCHAR(12),  
 @@EXPIRY_DATE VARCHAR(12),  
 @@BANKCODE VARCHAR(30),  
 @@ISIN VARCHAR(12),  
 @@CLTACCNO VARCHAR(16),  
 @@TRANSNO VARCHAR(15),  
 @@INOUT VARCHAR(1),  
 @@DEMATQTY  NUMERIC(18,4),  
 @@EXECDATE VARCHAR(20),  
 @@CERTQTY  NUMERIC(18,4),  
 @@DELIVERQTY  NUMERIC(18,4),  
 @@REMQTY  NUMERIC(18,4),  
 @@EXCESSQTY  NUMERIC(18,4),  
 @@BRANCHCD VARCHAR(10),           
 @@PARTIPANTCODE VARCHAR(10),    
 @@TCODE NUMERIC(18,0),  
 @@TRTYPE NUMERIC(18,0),  
 @@DPTYPE VARCHAR(10),  
 @@DPNAME VARCHAR(25),  
 @@DEMATCUR CURSOR,   
 @@DEMATMOV CURSOR,  
 @@BDPTYPE VARCHAR(5),  
 @@BDPID VARCHAR(16),  
 @@BCLTDPID VARCHAR(16),  
 @@FILLER1 VARCHAR(100),  
 @@WAREHOUSE VARCHAR(20)  
  
DELETE FROM DELIVERY_DEMAT_TRANS WHERE DRCR = 'D' AND TRTYPE <> 906 AND DPID <> 'PAY-OUT' AND REFNO = @REFNO  
  
UPDATE DELIVERY_DEMAT_TRANS SET DPID = LEFT(CLTACCNO,8) FROM DELIVERY_DEMAT_TRANS WHERE LEN(CLTACCNO) = 16  
AND DPID <> LEFT(CLTACCNO,8)  
  
UPDATE DELIVERY_DEMAT_TRANS SET DPNAME = '' WHERE DPNAME IS NULL  
  
SET @@DEMATCUR = CURSOR FOR  
  SELECT DISTINCT SNO,D.SETT_NO ,D.SETT_TYPE,D.PARTY_CODE , D.SYMBOL , LEFT(D.EXPIRY_DATE,11) EXPIRY_DATE ,D.QTY ,  
 D.DPID ,D.ISIN,D.DRCR ,D.CLTACCNO, D.TRANSNO , D.TRDATE,D.BRANCH_CD,D.PARTIPANTCODE,TCODE,TRTYPE,  
 DPTYPE,BDPTYPE,BDPID,BCLTACCNO,FILLER1,DPNAME,WAREHOUSE FROM DELIVERY_DEMAT_TRANS D   
 WHERE D.PARTY_CODE NOT IN ('PARTY','NCE') AND REFNO = @REFNO   
 AND ISIN IN ( SELECT ISIN FROM DELIVERY_MULTIISIN M WHERE D.ISIN = M.ISIN AND D.SYMBOL = M.SYMBOL  
    AND EFFDATE <= D.EXPIRY_DATE )  
 ORDER BY D.SETT_NO , D.SETT_TYPE ,D.SYMBOL   
OPEN @@DEMATCUR  
FETCH NEXT FROM @@DEMATCUR INTO @@SERIALNO,@@SNO,@@STYPE,@@PARTYCD,@@SYMBOL,@@EXPIRY_DATE,@@DEMATQTY,  
@@BANKCODE,@@ISIN,@@INOUT,@@CLTACCNO,@@TRANSNO,@@EXECDATE,@@BRANCHCD,@@PARTIPANTCODE,@@TCODE,@@TRTYPE,  
@@DPTYPE,@@BDPTYPE,@@BDPID,@@BCLTDPID,@@FILLER1,@@DPNAME,@@WAREHOUSE  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
  SET @@DEMATMOV = CURSOR FOR  
   SELECT ISNULL(SUM(QTY),0) FROM DELIVERY_TRANSACTION   
   WHERE  PARTY_CODE  = @@PARTYCD AND SYMBOL = @@SYMBOL   
   AND EXPIRY_DATE LIKE  @@EXPIRY_DATE + '%' AND SETT_NO = @@SNO   
   AND SETT_TYPE = @@STYPE AND REFNO = @REFNO AND DRCR = 'C'  
   AND PARTIPANTCODE = @@PARTIPANTCODE AND ACTIVE = 1  
   AND WAREHOUSE = @@WAREHOUSE
 OPEN @@DEMATMOV  
 FETCH NEXT FROM @@DEMATMOV INTO @@CERTQTY  
  
 CLOSE @@DEMATMOV  
 DEALLOCATE @@DEMATMOV  
 SET @@DEMATMOV = CURSOR FOR  
   SELECT ISNULL(SUM(TOTAL_ALLOCATED_QTY),0) FROM DELIVERY_OBL_CLT   
 WHERE  PARTY_CODE  = @@PARTYCD AND SYMBOL = @@SYMBOL   
 AND EXPIRY_DATE LIKE  @@EXPIRY_DATE +'%' AND SETT_NO = @@SNO  
 AND SETT_TYPE = @@STYPE AND SELL_BUY = 'S'  
 AND MEMBERCODE = @@PARTIPANTCODE  
 AND WAREHOUSE = @@WAREHOUSE
 OPEN @@DEMATMOV  
 FETCH NEXT FROM @@DEMATMOV INTO @@DELIVERQTY  
 CLOSE @@DEMATMOV  
 DEALLOCATE @@DEMATMOV  
  
  
 SELECT @@REMQTY = @@DELIVERQTY - @@CERTQTY  
 IF @@REMQTY >= @@DEMATQTY  
  BEGIN   
  
  INSERT INTO DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SYMBOL,EXPIRY_DATE,QTY,FROMNO,TONO,ISIN,FOLIONO,  
  HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,  
  TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5,ACTIVE,  
  STRIKE_PRICE,INST_TYPE,OPTION_TYPE,TRANSNO,COUNTERPARTY,WAREHOUSE)  
  SELECT @@SNO,@@STYPE,@REFNO,@@TCODE,@@TRTYPE,@@PARTYCD,@@SYMBOL,@@EXPIRY_DATE+' 23:59:00',@@DEMATQTY,@@TRANSNO,'',@@ISIN,@@TRANSNO,  
   @@DPNAME,'DEMAT','C','0',@@DEMATQTY,@@DPTYPE,@@BANKCODE,@@CLTACCNO,@@BRANCHCD,@@PARTIPANTCODE,0,'','','','DEMAT',  
   @@EXECDATE,@@FILLER1,1,0,@@BDPTYPE,@@BDPID,@@BCLTDPID,0,0,1,0,'FUTCOM','',0,'',@@WAREHOUSE  
   
  INSERT INTO DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SYMBOL,EXPIRY_DATE,QTY,  
  FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,  
  SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,BDPID,  
  BCLTDPID,FILLER4,FILLER5,ACTIVE,STRIKE_PRICE,INST_TYPE,OPTION_TYPE,TRANSNO,COUNTERPARTY,WAREHOUSE)  
  SELECT @@SNO,@@STYPE,@REFNO,@@TCODE,904,'BROKER',@@SYMBOL,@@EXPIRY_DATE + ' 23:59:00',@@DEMATQTY,@@TRANSNO,'',@@ISIN,@@TRANSNO,  
  '','DEMAT','D','0',@@DEMATQTY,@@DPTYPE,@@BANKCODE,@@CLTACCNO,@@BRANCHCD,@@PARTIPANTCODE,0,'','','','DEMAT',  
  @@EXECDATE,@@FILLER1,1,0,@@BDPTYPE,@@BDPID,@@BCLTDPID,0,0,1,0,'FUTCOM','',0,'',@@WAREHOUSE    
  
  DELETE FROM DELIVERY_DEMAT_TRANS WHERE   
  SNO = @@SERIALNO AND PARTY_CODE = @@PARTYCD AND SYMBOL = @@SYMBOL  
                AND EXPIRY_DATE LIKE @@EXPIRY_DATE +'%' AND SETT_NO = @@SNO AND TRANSNO = @@TRANSNO AND ISIN = @@ISIN AND REFNO = @REFNO  
  AND TCODE = @@TCODE AND TRTYPE = @@TRTYPE AND BRANCH_CD = @@BRANCHCD AND PARTIPANTCODE = @@PARTIPANTCODE  
  END  
 /* ELSE IF (@@REMQTY <= @@DEMATQTY AND @@REMQTY > 0) */  
 ELSE IF (@@REMQTY < @@DEMATQTY AND @@REMQTY > 0)   
  BEGIN  
  
  SELECT @@EXCESSQTY = @@DEMATQTY - @@REMQTY  
  
  INSERT INTO DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SYMBOL,EXPIRY_DATE,  
  QTY,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,  
  PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,  
  BDPID,BCLTDPID,FILLER4,FILLER5,ACTIVE,STRIKE_PRICE,INST_TYPE,  
  OPTION_TYPE,TRANSNO,COUNTERPARTY,WAREHOUSE)  
  SELECT @@SNO,@@STYPE,@REFNO,@@TCODE,@@TRTYPE,@@PARTYCD,@@SYMBOL,@@EXPIRY_DATE + ' 23:59:00',@@REMQTY,@@TRANSNO,'',  
  @@ISIN,@@TRANSNO,@@DPNAME,'DEMAT','C','0',@@DEMATQTY,@@DPTYPE,@@BANKCODE,@@CLTACCNO,@@BRANCHCD,  
  @@PARTIPANTCODE,0,'','','','DEMAT',@@EXECDATE,@@FILLER1,1,0,  
  @@BDPTYPE,@@BDPID,@@BCLTDPID,0,0,1,0,'FUTCOM','',0,'',@@WAREHOUSE  
  
  INSERT INTO DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SYMBOL,EXPIRY_DATE,  
  QTY,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,  
  PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,  
  BDPID,BCLTDPID,FILLER4,FILLER5,ACTIVE,STRIKE_PRICE,INST_TYPE,  
  OPTION_TYPE,TRANSNO,COUNTERPARTY,WAREHOUSE)  
  SELECT @@SNO,@@STYPE,@REFNO,@@TCODE,904,'BROKER',@@SYMBOL,@@EXPIRY_DATE + ' 23:59:00',@@REMQTY,@@TRANSNO,'',@@ISIN,  
  @@TRANSNO,'','DEMAT','D','0',@@DEMATQTY,@@DPTYPE,@@BANKCODE,@@CLTACCNO,@@BRANCHCD,@@PARTIPANTCODE,0,  
  '','','','DEMAT',@@EXECDATE,@@FILLER1,1,0,@@BDPTYPE,  
  @@BDPID,@@BCLTDPID,0,0,1,0,'FUTCOM','',0,'',@@WAREHOUSE  
   
   UPDATE DELIVERY_DEMAT_TRANS SET QTY = @@EXCESSQTY WHERE PARTY_CODE = @@PARTYCD   
  AND SYMBOL = @@SYMBOL AND EXPIRY_DATE LIKE @@EXPIRY_DATE +'%' AND SETT_NO = @@SNO   
  AND ISIN = @@ISIN AND REFNO = @REFNO  
  AND TCODE = @@TCODE AND TRTYPE = @@TRTYPE   AND PARTIPANTCODE = @@PARTIPANTCODE  
  END  
 FETCH NEXT FROM @@DEMATCUR INTO @@SERIALNO,@@SNO,@@STYPE,@@PARTYCD,@@SYMBOL,@@EXPIRY_DATE,@@DEMATQTY,@@BANKCODE,  
 @@ISIN,@@INOUT,@@CLTACCNO,@@TRANSNO,@@EXECDATE,@@BRANCHCD,@@PARTIPANTCODE,@@TCODE,@@TRTYPE,@@DPTYPE,  
 @@BDPTYPE,@@BDPID,@@BCLTDPID,@@FILLER1,@@DPNAME,@@WAREHOUSE  
  
END  
CLOSE @@DEMATCUR  
DEALLOCATE @@DEMATCUR  
  
UPDATE DELIVERY_TRANSACTION SET DPTYPE = C.DEPOSITORY,DPID = C.BANKID, CLTDPID = C.CLTDPID FROM CLIENT4 C , DELIVERYDP DP  
WHERE C.PARTY_CODE = DELIVERY_TRANSACTION.PARTY_CODE AND DEFDP = 1 AND ACTIVE = 1 AND DRCR = 'D' AND DELIVERED = '0'   
AND TRTYPE IN (904,905) AND DP.DPID = DELIVERY_TRANSACTION.BDPID AND DP.DPCLTNO = DELIVERY_TRANSACTION.BCLTDPID 
AND DP.DPTYPE = DELIVERY_TRANSACTION.BDPTYPE AND DP.DESCRIPTION NOT LIKE '%POOL%'
AND C.DEPOSITORY = DELIVERY_TRANSACTION.BDPTYPE
  
  

/*-----------------------------------------------------------------------------------*/
IF (SELECT ALLOCATIONTYPE FROM DELIVERY_MASTER ) > 0
BEGIN  	
	IF (SELECT  COUNT(1) FROM DELIVERY_DEMAT_TRANS
		WHERE TRTYPE = '906' AND SETT_NO <> '9999999') > 0 
	BEGIN
		
		INSERT INTO DELIVERY_DEMATTRANSOUT 
		(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE,
		STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,CLTACCNO,DPID,DPNAME,ISIN,BRANCH_CD,
		PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,BDPTYPE,BDPID,BCLTACCNO,FILLER1,FILLER2,
		FILLER3,FILLER4,FILLER5,WAREHOUSE)
		SELECT 
			SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE,
			STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,CLTACCNO,DPID,DPNAME,ISIN,BRANCH_CD,
			PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,BDPTYPE,BDPID,BCLTACCNO,FILLER1,FILLER2,
			FILLER3,FILLER4,FILLER5,WAREHOUSE 
		FROM 
			DELIVERY_DEMAT_TRANS
		WHERE
			TRTYPE = '906'
			AND SETT_NO <> '9999999'
			AND DRCR = 'D'
		
		DELETE  
			DELIVERY_DEMAT_TRANS
		WHERE
			TRTYPE = '906'
			AND SETT_NO <> '9999999'
			AND DRCR = 'D'
	END
END
/*-----------------------------------------------------------------------------------*/

EXEC DELIVERY_INSDEMATOUTCURSOR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsDematNCDXCursor
-- --------------------------------------------------
CREATE Proc [dbo].[Delivery_InsDematNCDXCursor] ( @RefNo int) As

Insert Into Delivery_Transaction 
(Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Symbol,Expiry_Date,Qty,FromNo,ToNo,ISIN,FolioNo,HolderName,
Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,
ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Active,
Strike_Price,Inst_Type,Option_Type,TransNo,CounterParty,WareHouse)

Select Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,D.Symbol,D.Expiry_Date,Qty,TransNo,TransNo,D.IsIn,TransNo,'',
'Pay-Out','C','0',Qty,DpType,DpId,CltAccNo,Branch_Cd,PartipantCode,0,'','','','DEMAT',
TrDate,Filler1,1,Filler3,BDpType,BDpId,BCltAccNo,filler4,filler5,1,
Strike_Price,Inst_Type,Option_Type,TransNo,'',WareHouse
From Delivery_Demat_Trans D Where TrType = 906 And DrCr = 'C' 
AND D.Symbol IN ( Select Distinct Symbol From Delivery_Obl_Clt DE 
	                      WHERE DE.Symbol = D.Symbol AND left(DE.Expiry_date,11) = left(D.Expiry_Date,11) 
								and De.WareHouse = D.WareHouse)
AND IsIn IN ( Select IsIn From Delivery_MultiIsIn Where Symbol = D.Symbol And EffDate <= D.Expiry_Date
And IsIn = D.IsIn ) 

Insert Into Delivery_Transaction
(Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Symbol,Expiry_Date,Qty,FromNo,ToNo,ISIN,FolioNo,HolderName,
Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,
ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Active,
Strike_Price,Inst_Type,Option_Type,TransNo,CounterParty,WareHouse)

Select Sett_No,Sett_type,RefNo,TCode,904,'BROKER',D.Symbol,D.Expiry_Date,Qty,TransNo,TransNo,D.IsIn,TransNo,'',
'Pay-Out','D','0',Qty,DpType,DpId,CltAccNo,Branch_Cd,PartipantCode,0,'','','','DEMAT',
TrDate,Filler1,1,Filler3,BDpType,BDpId,BCltAccNo,filler4,filler5,1,
Strike_Price,Inst_Type,Option_Type,TransNo,'',WareHouse
From Delivery_Demat_Trans D Where TrType = 906 And DrCr = 'C' 
AND D.Symbol IN ( SELECT DISTINCT Symbol FROM Delivery_Obl_Clt DE 
	                      WHERE DE.Symbol = D.Symbol AND left(DE.Expiry_Date,11) = lefT(D.Expiry_Date,11) 
							and De.WareHouse = D.WareHouse)
AND IsIn IN ( Select IsIn From Delivery_MultiIsIn Where Symbol = D.Symbol And EffDate <= D.Expiry_Date
And IsIn = D.IsIn ) 

Delete from Delivery_Demat_Trans Where TrType = 906 And DrCr = 'C' 
AND Symbol IN ( SELECT DISTINCT Symbol FROM Delivery_Obl_Clt DE 
	                      WHERE DE.Symbol = Delivery_Demat_Trans.Symbol AND left(DE.Expiry_Date,11) = left(Delivery_Demat_Trans.Expiry_Date,11)
							and De.WareHouse = Delivery_Demat_Trans.WareHouse )
AND IsIn IN  ( Select IsIn From Delivery_MultiIsIn Where Symbol = Delivery_Demat_Trans.Symbol And EffDate <= Delivery_Demat_Trans.Expiry_Date
And IsIn = Delivery_Demat_Trans.IsIn )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsDematOutCursor
-- --------------------------------------------------
CREATE    Proc Delivery_InsDematOutCursor  As  
Declare   
	@@SNo int,  
	@@DelSNo int,  
	@@Party_Code Varchar(10),  
	@@ISIN Varchar(16),
	@@WareHouse Varchar(20),
	@@Qty NUMERIC(18,4),  
	@@TCode int,  
	@@TransNo Varchar(15),  
	@@TrDate Varchar(11),  
	@@Sett_No Varchar(7),  
	@@Sett_Type Varchar(2), 
	@@BDpType varchar(4) ,
	@@SettDelQty NUMERIC(18,4),  
	@@SettDelTransQty NUMERIC(18,4),  
	@@DematCur Cursor,  
	@@SettDel Cursor,  
	@@SettDelTrans Cursor  

Select @@SettDelQty = 0   
Select @@SettDelTransQty = 0  

IF (SELECT ALLOCATIONTYPE FROM Delivery_Master ) > 0
begin  
	Update Delivery_DematTransOut   
	Set  
		Inst_Type = M.Inst_Type,   
		Symbol = M.Symbol,  
		WareHouse = M.WareHouse  
	From  
		Delivery_MultiIsIn M  
	Where  
		M.isin = Delivery_DematTransOut.isin                 
		AND EFFDATE <= TrDate  

	Set @@DematCur = Cursor For  
		Select 
			SNo,ISIN,WareHouse,
			Qty,TCode,TrDate=Left(Convert(Varchar,TrDate,109),11),
			D.Sett_No,D.sett_Type,TransNo,BDpType  
		From 
			Delivery_DematTransOut D
		Where 
			TrType = 906 
		Order By isin,WareHouse,Qty Desc,D.Sett_No,D.sett_Type  

	Open @@DematCur   
		Fetch Next From @@DematCur 
			Into @@SNo,@@ISIN,@@WareHouse,@@Qty,@@TCode,@@TrDate,@@Sett_No,
				@@Sett_Type,@@TransNo,@@BDpType
	While @@Fetch_Status = 0  
	Begin   
		Set @@SettDel = Cursor For  
			Select 
				SNO,Qty,Party_Code 
			From 
				Delivery_Transaction 
			Where 
				Sett_No = @@Sett_No And Sett_Type = @@Sett_Type And 
				ISIN = @@ISIN And WareHouse = @@WareHouse And  ACTIVE = 1 And DrCr = 'D' 
				and Delivered = 'G' And TrType = 906 And BDpType = @@BDpType
			Order By Qty Desc  
		Open @@SettDel  
		Fetch Next From @@SettDel into @@DelSno,@@SettDelQty,@@Party_Code  
		While @@Fetch_Status = 0 And @@Qty > 0    
			Begin     
			If @@SettDelQty > 0 and @@Qty > 0   
				Begin  
				If @@SettDelQty >= @@Qty   
				Begin  
					Update 
						Delivery_DematTransOut 
					Set 
						TrType = 909 
					Where 
						SNo = @@SNo And Sett_No = @@Sett_No  
						And Sett_Type = @@Sett_Type 
						And isin = @@ISIN And WareHouse = @@WareHouse 
						And SNo = @@SNo And DrCr = 'D' And TrType = 906   
					if @@SettDelQty > @@Qty   
					Begin  
						insert into Delivery_Transaction   
						Select 
							Sett_No,Sett_type,RefNo,TCode,906,'EXE',Inst_Type,
							Symbol,Expiry_Date,Strike_Price,Option_Type,
							@@Qty,@@TransNo,0,ToNo,IsIn,@@TransNo,HolderName,Reason,
							DrCr,'D',OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,'',
							WareHouse,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,@@TrDate,
							BDpType,BDpId,BCltDpId,Active,
							Filler1,ACTIVE,Filler3,Filler4,Filler5
						From 
							Delivery_Transaction 
						Where 
							SNo = @@DelSNo And Sett_No = @@Sett_No  
							And Sett_Type = @@Sett_Type 
							And isin = @@ISIN
							And WareHouse = @@WareHouse   
							And Party_Code = @@Party_Code and ACTIVE = 1 And DrCr = 'D'   

						Update 
							Delivery_Transaction 
						Set 
							Qty=@@SettDelQty-@@Qty 
						Where 
							SNo = @@DelSNo And Sett_No = @@Sett_No  
							And Sett_Type = @@Sett_Type And isin = @@ISIN
							And WareHouse = @@WareHouse  
							And Party_Code = @@Party_Code And ACTIVE = 1 
							And DrCr = 'D'        
						Select @@Qty = 0  
					End  
					Else   
						Begin   
							Update 
								Delivery_Transaction 
							Set 
								Delivered = 'D',Party_Code='EXE',TrType=906,
								FromNo=@@TransNo,FolioNo=@@TransNo,TransDate=@@TrDate 
							Where 
								SNo = @@DelSNo And Sett_No = @@Sett_No  
								And Sett_Type = @@Sett_Type  And isin = @@ISIN
								And  WareHouse = @@WareHouse   
								And Party_Code = @@Party_Code and ACTIVE = 1 
								And DrCr = 'D'   
	
							Select @@Qty = 0  
						End       
						Select @@SettDelQty = 0    
					End  
				Else  
					Begin  
					Insert Into Delivery_DematTransOut 
					Select 
						Sett_No,Sett_Type,RefNo,TCode,909,Party_Code,
						Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
						@@SettDelQty,TrDate,CltAccNo,DpId,DpName,IsIn,Branch_Cd,PartiPantCode,
						DpType,TransNo, DrCr,BDpType,BDpId,BCltAccNo,Filler1,FILLER2,Filler3,
						Filler4,Filler5,WareHouse
					From 
						Delivery_DematTransOut   
					Where
						SNo = @@SNo And Sett_No = @@Sett_No And Sett_Type = @@Sett_Type    
						And isin = @@ISIN And WareHouse = @@WareHouse  
						And DrCr = 'D' And TrType = 906   
	
					Update 
						Delivery_DematTransOut 
					Set 
						Qty = @@Qty-@@SettDelQty  
					Where 
						SNo = @@SNo And Sett_No = @@Sett_No And Sett_Type = @@Sett_Type    
						And isin = @@ISIN And WareHouse = @@WareHouse  
						And SNo = @@SNo And DrCr = 'D' And TrType = 906   
	
					Update
						Delivery_Transaction 
					Set
						Delivered = 'D',Party_Code='EXE',TrType=906,FromNo=@@TransNo,
						FolioNo=@@TransNo,TransDate=@@TrDate 
					Where 
						SNo = @@DelSNo And Sett_No = @@Sett_No  
						And Sett_Type = @@Sett_Type  And isin = @@ISIN
						And WareHouse = @@WareHouse
						And Party_Code = @@Party_Code And ACTIVE = 1 And DrCr = 'D'      
	
					Select @@Qty = @@Qty-@@SettDelQty  
					Select @@SettDelQty = 0    
				End  
			End  
			Fetch Next From @@SettDel into @@DelSno,@@SettDelQty,@@Party_Code   
		End  
		Close @@SettDel   
		DeAllocate @@SettDel  
		Fetch Next From @@DematCur Into 
			@@SNo,@@ISIN,@@WareHouse,@@Qty,@@TCode,@@TrDate,@@Sett_No,
			@@Sett_Type,@@TransNo,@@BDpType
	End  
	Close @@DematCur  
	DeAllocate @@DematCur  

	Set @@DematCur = Cursor For  
	Select 
		SNo,ISIN,WareHouse,Qty,TCode,TrDate=Left(Convert(Varchar,TrDate,109),11),
		D.Sett_No,D.sett_Type,TransNo ,BDpType 
	From 
		Delivery_DematTransOut D 
	Where 
		TrType = 906 
	Order By 
		ISIN,WareHouse,Qty Desc,D.Sett_No,D.sett_Type  

	Open @@DematCur   
	Fetch Next From @@DematCur Into @@SNo,@@isin,@@warehouse,@@Qty,@@TCode,@@TrDate,
				@@Sett_No,@@Sett_Type,@@TransNo,@@BDpType
	While @@Fetch_Status = 0  
	Begin   
		Set @@SettDel = Cursor For  
		Select 
			SNO,Qty,Party_Code 
		From 
			Delivery_Transaction 
		Where 
			Sett_No = @@Sett_No  
			And Sett_Type = @@Sett_Type And isin = @@isin And warehouse = @@warehouse And   
			ACTIVE = 1 And DrCr = 'D' and Delivered = '0' 
			And Party_Code = 'BROKER' And BDpType = @@BDpType
		Order By Qty Desc  
		Open @@SettDel  
		Fetch Next From @@SettDel into @@DelSno,@@SettDelQty,@@Party_Code  
		While @@Fetch_Status = 0 And @@Qty > 0    
			Begin     
				If @@SettDelQty > 0 and @@Qty > 0   
				Begin  
					If @@SettDelQty >= @@Qty   
					Begin  
						Update 
							Delivery_DematTransOut 
						Set 
							TrType = 909 
						Where 
							SNo = @@SNo And Sett_No = @@Sett_No  
							And Sett_Type = @@Sett_Type And isin = @@isin 
							And warehouse = @@warehouse
							And SNo = @@SNo And DrCr = 'D' And TrType = 906   

						if @@SettDelQty > @@Qty   
						Begin  
							insert into Delivery_Transaction   
							Select 
								Sett_No,Sett_type,RefNo,TCode,906,'EXE',Inst_Type,
								Symbol,Expiry_Date,Strike_Price,Option_Type,
								@@Qty,@@TransNo,0,ToNo,IsIn,@@TransNo,HolderName,Reason,
								DrCr,'D',OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,'',
								WareHouse,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,@@TrDate,
								BDpType,BDpId,BCltDpId,Active,
								Filler1,ACTIVE,Filler3,Filler4,Filler5
							From 
								Delivery_Transaction 
							Where 
								SNo = @@DelSNo And Sett_No = @@Sett_No  
								And Sett_Type = @@Sett_Type 
								And isin = @@ISIN
								And WareHouse = @@WareHouse   
								And Party_Code = @@Party_Code and ACTIVE = 1 
								And DrCr = 'D'

							Update 
								Delivery_Transaction 
							Set 
								Qty=@@SettDelQty-@@Qty 
							Where 
								SNo = @@DelSNo And Sett_No = @@Sett_No  
								And Sett_Type = @@Sett_Type And isin = @@isin and warehouse = @@warehouse   
								And Party_Code = @@Party_Code And ACTIVE = 1 And DrCr = 'D'        

							Select @@Qty = 0  
						End  
					Else   
						Begin   
							Update 
								Delivery_Transaction 
							Set 
								Delivered = 'D',Party_Code='EXE',TrType=906,FromNo=@@TransNo,
								FolioNo=@@TransNo,TransDate=@@TrDate 
							Where 
								SNo = @@DelSNo And Sett_No = @@Sett_No  
								And Sett_Type = @@Sett_Type And isin = @@isin and warehouse = @@warehouse   
								And Party_Code = @@Party_Code and ACTIVE = 1 And DrCr = 'D'   

							Select @@Qty = 0  
						End       
						Select @@SettDelQty = 0    
					End  
				Else  
					Begin  

						Insert Into Delivery_DematTransOut 
						Select 
							Sett_No,Sett_Type,RefNo,TCode,909,Party_Code,
							Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
							@@SettDelQty,TrDate,CltAccNo,DpId,DpName,IsIn,Branch_Cd,PartiPantCode,DpType,TransNo,  
							DrCr,BDpType,BDpId,BCltAccNo,Filler1,FILLER2,Filler3,Filler4,Filler5,WareHouse
						From 
							Delivery_DematTransOut   
						Where
							SNo = @@SNo And Sett_No = @@Sett_No And Sett_Type = @@Sett_Type    
							And isin = @@ISIN And WareHouse = @@WareHouse  
							And DrCr = 'D' And TrType = 906   

						Update 
							Delivery_DematTransOut 
						Set 
							Qty = @@Qty-@@SettDelQty  
						Where 
							SNo = @@SNo And Sett_No = @@Sett_No And Sett_Type = @@Sett_Type And   
							isin = @@isin and warehouse = @@warehouse And SNo = @@SNo And DrCr = 'D'   
							And TrType = 906   

						Update 
							Delivery_Transaction 
						Set 
							Delivered = 'D',Party_Code='EXE',TrType=906,
							FromNo=@@TransNo,FolioNo=@@TransNo,TransDate=@@TrDate 
						Where 
							SNo = @@DelSNo And Sett_No = @@Sett_No  
							And Sett_Type = @@Sett_Type And isin = @@isin and warehouse = @@warehouse   
							And Party_Code = @@Party_Code And ACTIVE = 1 And DrCr = 'D'      

						Select @@Qty = @@Qty-@@SettDelQty 
						Select @@SettDelQty = 0    
					End  
				End  
			Fetch Next From @@SettDel into @@DelSno,@@SettDelQty,@@Party_Code   
		End  
		Close @@SettDel   
		DeAllocate @@SettDel  
		Fetch Next From @@DematCur Into 
			@@SNo,@@isin,@@warehouse,@@Qty,@@TCode,@@TrDate,@@Sett_No,
			@@Sett_Type,@@TransNo,@@BDpType
	End  
	Close @@DematCur  
	DeAllocate @@DematCur  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsertDemat
-- --------------------------------------------------



CREATE procedure Delivery_InsertDemat    
    
       @Sett_No                  varchar(7)          ,             
       @Sett_Type                varchar(2)          ,             
       @RefNo                    int                 ,             
       @TCode                    numeric(18,0)       ,             
       @TrType                   numeric(18,0)       ,             
       @Party_Code               varchar(10)         ,             
       @Inst_type   varchar(6)       ,    
       @Scrip_Cd                 varchar(12)         = null,       
       @Expiry_date              datetime      ,     
       @Qty                      numeric(18,4)       ,             
       @TrDate                   datetime            ,             
       @CltAccNo                 varchar(16)         = null,       
       @DpId                     varchar(16)         = null,       
       @DpName                   varchar(50)         = null,       
       @IsIn                     varchar(12)         = null,       
       @Branch_Cd                varchar(10)         = null,       
       @PartiPantCode            varchar(10)         = null,       
       @DpType                varchar(4)         = null,       
       @TransNo            varchar(15)         ,             
       @DrCr                     varchar(1)    ,    
       @BDpType                 varchar(4)         = null,       
       @BDpId                    varchar(16)         = null,       
       @BCltAccNo                varchar(50)         = null,    
       @Filler1  varchar(100),           
       @Filler2  Int,    
       @Filler3  Int,    
       @Filler4  Int,    
       @Filler5  Int,    
       @WareHouse       varchar(20)    
    
as    
    
       declare @procname varchar(50)    
       select @procname = object_name(@@procid)    
    
       begin transaction trnInsans    
    
              begin    
   Insert into  Delivery_Demat_Trans    
    (Sett_No,Sett_Type,RefNo,TCode,TrType,Party_Code,Inst_Type,Symbol,    
    Expiry_Date,Strike_Price,Option_Type,Qty,TrDate,CltAccNo,DpId,DpName,    
    IsIn,Branch_Cd,PartiPantCode,DpType,TransNo,DrCr,BDpType,BDpId,BCltAccNo,    
    Filler1,Filler2,Filler3,Filler4,Filler5,WareHouse)    
   Values     
    (    
    @Sett_No,@Sett_Type,@RefNo,@TCode,@TrType,@Party_Code,@Inst_Type,@Scrip_Cd,    
    @Expiry_date,0,'',@Qty,@TrDate,@CltAccNo,@DpId,@DpName,@IsIn,@Branch_Cd,    
    @PartiPantCode,@DpType,@TransNo,@DrCr,@BDpType,@BDpId,@BCltAccNo,@Filler1,    
    @Filler2,@Filler3,@Filler4,@Filler5,@WareHouse    
    )    
                     if @@error != 0    
                            begin    
                                   rollback transaction trnInsans    
                                   raiserror('Error inserting into table DematTrans.  Error occurred in procedure %s.  Rolling back transaction...', 16, 1, @procname)    
                                   return    
                            end    
                     else    
                            begin    
                                   commit transaction trnInsans    
                            end    
              end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_INSERTDEMAT_TMP
-- --------------------------------------------------

CREATE PROCEDURE DELIVERY_INSERTDEMAT_TMP    
    
       @SETT_NO                  VARCHAR(7)          ,             
       @SETT_TYPE                VARCHAR(2)          ,             
       @REFNO                    INT                 ,             
       @TCODE                    NUMERIC(18,0)       ,             
       @TRTYPE                   NUMERIC(18,0)       ,             
       @PARTY_CODE               VARCHAR(10)         ,             
       @INST_TYPE   				VARCHAR(6)       ,    
       @SCRIP_CD                 VARCHAR(12)         = NULL,       
       @EXPIRY_DATE              DATETIME      ,     
       @QTY                      NUMERIC(18,4)       ,             
       @TRDATE                   DATETIME            ,             
       @CLTACCNO                 VARCHAR(16)         = NULL,       
       @DPID                     VARCHAR(16)         = NULL,       
       @DPNAME                   VARCHAR(50)         = NULL,       
       @ISIN                     VARCHAR(12)         = NULL,       
       @BRANCH_CD                VARCHAR(10)         = NULL,       
       @PARTIPANTCODE            VARCHAR(10)         = NULL,       
       @DPTYPE                VARCHAR(4)         = NULL,       
       @TRANSNO            VARCHAR(15)         ,             
       @DRCR                     VARCHAR(1)    ,    
       @BDPTYPE                 VARCHAR(4)         = NULL,       
       @BDPID                    VARCHAR(16)         = NULL,       
       @BCLTACCNO                VARCHAR(50)         = NULL,    
       @FILLER1  VARCHAR(100),           
       @FILLER2  INT,    
       @FILLER3  INT,    
       @FILLER4  INT,    
       @FILLER5  INT,    
       @WAREHOUSE       VARCHAR(20)    
    
AS    
    
       DECLARE @PROCNAME VARCHAR(50)    
       SELECT @PROCNAME = OBJECT_NAME(@@PROCID)    
    
       BEGIN TRANSACTION TRNINSANS    
    
              BEGIN    
   INSERT INTO  DELIVERY_DEMAT_TRANS_TMP    
    (SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,    
    EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRDATE,CLTACCNO,DPID,DPNAME,    
    ISIN,BRANCH_CD,PARTIPANTCODE,DPTYPE,TRANSNO,DRCR,BDPTYPE,BDPID,BCLTACCNO,    
    FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,WAREHOUSE)    
   VALUES     
    (    
    @SETT_NO,@SETT_TYPE,@REFNO,@TCODE,@TRTYPE,@PARTY_CODE,@INST_TYPE,@SCRIP_CD,    
    @EXPIRY_DATE,0,'',@QTY,@TRDATE,@CLTACCNO,@DPID,@DPNAME,@ISIN,@BRANCH_CD,    
    @PARTIPANTCODE,@DPTYPE,@TRANSNO,@DRCR,@BDPTYPE,@BDPID,@BCLTACCNO,@FILLER1,    
    1,@FILLER3,@FILLER4,@FILLER5,@WAREHOUSE    
    )    
 IF @@ERROR != 0    
        BEGIN    
               ROLLBACK TRANSACTION TRNINSANS    
               RAISERROR('ERROR INSERTING INTO TABLE DEMATTRANS.  ERROR OCCURRED IN PROCEDURE %S.  ROLLING BACK TRANSACTION...', 16, 1, @PROCNAME)    
               RETURN    
        END    
 ELSE    
        BEGIN    
               COMMIT TRANSACTION TRNINSANS    
        END    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_INSNCDXCLTDELWISE
-- --------------------------------------------------
CREATE PROC [dbo].[DELIVERY_INSNCDXCLTDELWISE] ( @SETT_NO VARCHAR(7),@SETT_TYPE VARCHAR(2),@REFNO INT) AS    
DECLARE @@SYMBOL VARCHAR(12),    
 @@INST_TYPE VARCHAR(6),    
 @@EXPIRY_DATE DATETIME , 
 @@WAREHOUSE VARCHAR(20), 
 @@PARTY_CODE VARCHAR(10),    
 @@DELQTY NUMERIC(18,4) ,    
 @@QTY NUMERIC(18,4),    
 @@NEWQTY NUMERIC(18,4),    
 @@TRADEQTY NUMERIC(18,4) ,    
 @@ISIN VARCHAR(15),    
 @@FROMNO VARCHAR(15),    
 @@FOLIONO VARCHAR(15),    
 @@REASON VARCHAR(25),    
 @@TCODE NUMERIC(18,0),    
 @@CERTPARTY VARCHAR(10),    
 @@ORGQTY NUMERIC(18,4) ,    
 @@SDATE VARCHAR(11),    
 @@SNO NUMERIC(18,0),    
 @@FLAG VARCHAR(1),    
 @@PRIORITY VARCHAR(1),    
 @@PCOUNT NUMERIC(18,4) ,    
 @@REMQTY NUMERIC(18,4) ,    
 @@OLDQTY NUMERIC(18,4),    
 @@TRADENEWQTY NUMERIC(18,4),    
 @@DPTYPE VARCHAR(4),
 @@VARIATION NUMERIC(18,4),  
 @@DELLOT NUMERIC(18,4),  
 @@DPFLAG INT,
 @@QTYCUR CURSOR,    
 @@DELCLT CURSOR,    
 @@CERTCUR CURSOR    

 SELECT *, NEWQTY=CONVERT(NUMERIC(18,4),QTY), VARIATION=CONVERT(NUMERIC(18,4),0), DELLOT = CONVERT(NUMERIC(18,4),1)
 INTO #DELIVERY_TRANSACTION
 FROM DELIVERY_TRANSACTION
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
 
 DELETE FROM DELIVERY_TRANSACTION
 WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
 
 UPDATE #DELIVERY_TRANSACTION SET 
 NEWQTY = (CASE WHEN QTY BETWEEN CEILING(QTY/DELIVERY_LOT) AND CEILING(QTY/DELIVERY_LOT)+CEILING(QTY/DELIVERY_LOT)*V.VARIATION/100
			    THEN CEILING(QTY/DELIVERY_LOT)
				WHEN QTY BETWEEN CEILING(QTY/DELIVERY_LOT) AND CEILING(QTY/DELIVERY_LOT)-CEILING(QTY/DELIVERY_LOT)*V.VARIATION/100
				THEN CEILING(QTY/DELIVERY_LOT)
				WHEN QTY BETWEEN FLOOR(QTY/DELIVERY_LOT) AND FLOOR(QTY/DELIVERY_LOT)+FLOOR(QTY/DELIVERY_LOT)*V.VARIATION/100
				THEN FLOOR(QTY/DELIVERY_LOT)
				WHEN QTY BETWEEN FLOOR(QTY/DELIVERY_LOT) AND FLOOR(QTY/DELIVERY_LOT)-FLOOR(QTY/DELIVERY_LOT)*V.VARIATION/100
				THEN FLOOR(QTY/DELIVERY_LOT)
				ELSE QTY 
		   END), 
 VARIATION = V.VARIATION,
 DELLOT = DELIVERY_LOT
 FROM VARIATION_DETAILS V
 WHERE V.SYMBOL = #DELIVERY_TRANSACTION.SYMBOL
  
 SELECT DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,DT.PARTY_CODE,QTY=ISNULL(SUM(DT.NEWQTY),0)+  
 ISNULL((CASE WHEN SELL_BUY = 'B' THEN D.TOTAL_ALLOCATED_QTY ELSE 0 END),0)-ISNULL((CASE WHEN SELL_BUY='S' THEN D.TOTAL_ALLOCATED_QTY ELSE 0 END),0),  
 FLAG='E', PRIORITY = 0, DPTYPE = 'XXXX', DPFLAG = 4  INTO #DELALLOCATE FROM       
 CLIENT2 C2,#DELIVERY_TRANSACTION DT LEFT OUTER JOIN DELIVERY_OBL_CLT D     
 ON ( D.SETT_NO = DT.SETT_NO AND D.SETT_TYPE = DT.SETT_TYPE AND     
 D.SYMBOL = DT.SYMBOL AND D.INST_TYPE = DT.INST_TYPE AND D.PARTY_CODE = DT.PARTY_CODE  
 AND D.EXPIRY_DATE = DT.EXPIRY_DATE AND D.WAREHOUSE=DT.WAREHOUSE)    
 WHERE DT.SETT_NO = @SETT_NO AND DT.SETT_TYPE = @SETT_TYPE 
 AND DT.ACTIVE = 1 AND DRCR = 'C'  AND C2.PARTY_CODE = DT.PARTY_CODE      
 GROUP BY DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,D.TOTAL_ALLOCATED_QTY,DT.PARTY_CODE,D.SELL_BUY    
   
 INSERT INTO #DELALLOCATE  
 SELECT DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,DT.PARTY_CODE,QTY=TOTAL_ALLOCATED_QTY,FLAG='R', PRIORITY=1, DPTYPE = 'XXXX', DPFLAG = 4 FROM  
 DELIVERY_OBL_CLT DT , CLIENT1 C1, CLIENT2 C2
 WHERE SELL_BUY = 'B'    
 AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
 AND C1.CL_CODE = C2.CL_CODE     
 AND C2.PARTY_CODE = DT.PARTY_CODE    
 AND DT.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM #DELALLOCATE A 
 WHERE A.SYMBOL = DT.SYMBOL AND A.INST_TYPE = DT.INST_TYPE AND A.PARTY_CODE = DT.PARTY_CODE  
 AND A.EXPIRY_DATE = DT.EXPIRY_DATE AND A.WAREHOUSE=DT.WAREHOUSE )
 
 UPDATE #DELALLOCATE SET DPTYPE = 'CDSL', DPFLAG = 1 FROM MULTICLTID M
 WHERE M.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M.DPTYPE = 'CDSL' AND DEF = 1 
 AND #DELALLOCATE.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID M1 
 WHERE M1.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M1.DPTYPE = 'NSDL' AND DEF = 1 )
 
 UPDATE #DELALLOCATE SET DPTYPE = 'NSDL', DPFLAG = 2 FROM MULTICLTID M
 WHERE M.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M.DPTYPE = 'NSDL' AND DEF = 1 
 AND #DELALLOCATE.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID M1 
 WHERE M1.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M1.DPTYPE = 'CDSL' AND DEF = 1 )

 UPDATE #DELALLOCATE SET DPTYPE = 'BOTH', DPFLAG = 3 FROM MULTICLTID M
 WHERE M.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M.DPTYPE = 'NSDL' AND DEF = 1 
 AND #DELALLOCATE.PARTY_CODE IN (SELECT PARTY_CODE FROM MULTICLTID M1 
 WHERE M1.PARTY_CODE = #DELALLOCATE.PARTY_CODE AND M1.DPTYPE = 'CDSL' AND DEF = 1 )


 SET @@DELCLT = CURSOR FOR
     SELECT * FROM #DELALLOCATE WHERE QTY > 0 
     ORDER BY SYMBOL, INST_TYPE, EXPIRY_DATE, WAREHOUSE, FLAG, DPFLAG, QTY DESC, PARTY_CODE DESC
OPEN @@DELCLT    
FETCH NEXT FROM @@DELCLT INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@PARTY_CODE,@@DELQTY,@@FLAG,@@PRIORITY, @@DPTYPE, @@DPFLAG
WHILE @@FETCH_STATUS = 0     
BEGIN    
       SET @@QTYCUR = CURSOR FOR     
       SELECT ISNULL(SUM(NEWQTY),0), ISNULL(SUM(QTY),0) FROM #DELIVERY_TRANSACTION     
       WHERE SETT_NO = @SETT_NO     
       AND SETT_TYPE = @SETT_TYPE     
       AND REFNO = @REFNO    
       AND PARTY_CODE = @@PARTY_CODE    
       AND SYMBOL  = @@SYMBOL     
       AND INST_TYPE = @@INST_TYPE  
       AND EXPIRY_DATE = @@EXPIRY_DATE  
       AND WAREHOUSE = @@WAREHOUSE
       AND DRCR = 'D' AND ACTIVE = 1
       GROUP BY VARIATION, DELLOT
       OPEN @@QTYCUR     
       FETCH NEXT FROM @@QTYCUR INTO @@NEWQTY,@@QTY
       IF @@DELQTY > ISNULL(@@NEWQTY,0)
       BEGIN             
			SET @@NEWQTY = ISNULL(@@NEWQTY,0)
			
			  SELECT @@DELQTY = @@DELQTY - @@NEWQTY    
			  SET @@CERTCUR = CURSOR FOR    
			  SELECT QTY,ISIN,FROMNO,FOLIONO,TDATE=LEFT(CONVERT(VARCHAR,TRANSDATE,109),11),ORGQTY,SNO,TCODE,NEWQTY, VARIATION, DELLOT     
			  FROM #DELIVERY_TRANSACTION     
			  WHERE SETT_NO = @SETT_NO     
        		  AND SETT_TYPE = @SETT_TYPE     
        		  AND REFNO = @REFNO    
        		  AND PARTY_CODE = 'BROKER'    
        		  AND SYMBOL  = @@SYMBOL     
        		  AND INST_TYPE = @@INST_TYPE  
        		  AND EXPIRY_DATE  = @@EXPIRY_DATE  
        		  AND WAREHOUSE = @@WAREHOUSE
        		  AND DRCR = 'D'  AND TRTYPE <> 1000  AND ACTIVE = 1
                  AND BDPTYPE LIKE (CASE WHEN @@DPFLAG >= 3 THEN '%' ELSE @@DPTYPE END) 
			  ORDER BY TRANSDATE ASC, QTY DESC     
   OPEN @@CERTCUR    
   FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@ISIN,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE,@@TRADENEWQTY,@@VARIATION, @@DELLOT    
   IF @@FETCH_STATUS = 0     
   BEGIN    

     SELECT @@PCOUNT = 0    
     WHILE @@PCOUNT < @@DELQTY AND @@FETCH_STATUS = 0          
     BEGIN    
     
     
     SELECT @@PCOUNT = @@PCOUNT + @@TRADENEWQTY    
       IF @@PCOUNT <= @@DELQTY     
     BEGIN        
     
     INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	 DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	  
	 SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,904,@@PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,  
	 REASON=(CASE WHEN @@FLAG = 'E' THEN 'EXCESS RECEIVED TRANSFERED' ELSE 'PAY-OUT' END ),  
	 'D',DELIVERED,ORGQTY,DPTYPE,'','',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT  
  
    FROM #DELIVERY_TRANSACTION WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE     
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1         
  
     UPDATE #DELIVERY_TRANSACTION SET ACTIVE = 0,FILLER2 = 0   
          WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
			AND REFNO = @REFNO     
			AND SNO = @@SNO AND TCODE = @@TCODE     
			AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
			AND EXPIRY_DATE = @@EXPIRY_DATE  
			AND WAREHOUSE = @@WAREHOUSE
			AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
			AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
			AND PARTY_CODE = 'BROKER'      
			AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1        
    END        
       ELSE      
       BEGIN    
          SELECT @@PCOUNT = @@PCOUNT - @@TRADENEWQTY    
          SELECT @@REMQTY = @@DELQTY - @@PCOUNT    
          SELECT @@PCOUNT = @@PCOUNT + @@REMQTY
          
		  SELECT @@REMQTY = (CASE WHEN @@TRADEQTY = @@TRADENEWQTY THEN @@REMQTY ELSE 
				 (CASE WHEN @@TRADEQTY BETWEEN CEILING(@@TRADEQTY/@@DELLOT) AND CEILING(@@TRADEQTY/@@DELLOT)+CEILING(@@TRADEQTY/@@DELLOT)*@@VARIATION/100
					   THEN @@REMQTY + CEILING(@@REMQTY/@@DELLOT)*@@VARIATION/100
					   WHEN @@TRADEQTY BETWEEN CEILING(@@TRADEQTY/@@DELLOT) AND CEILING(@@TRADEQTY/@@DELLOT)-CEILING(@@TRADEQTY/@@DELLOT)*@@VARIATION/100
					   THEN @@REMQTY - CEILING(@@REMQTY/@@DELLOT)*@@VARIATION/100					   
					   ELSE @@REMQTY
				  END) END)
					   
          SELECT @@OLDQTY = @@TRADEQTY - @@REMQTY    
                
         
	 INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	 DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	
	SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY=@@OLDQTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	'D',DELIVERED,ORGQTY,'', '', '',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,
	(CASE WHEN @@OLDQTY BETWEEN CEILING(@@OLDQTY/DELLOT) AND CEILING(@@OLDQTY/DELLOT)+CEILING(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN CEILING(@@OLDQTY/DELLOT) AND CEILING(@@OLDQTY/DELLOT)-CEILING(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN FLOOR(@@OLDQTY/DELLOT) AND FLOOR(@@OLDQTY/DELLOT)+FLOOR(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN FLOOR(@@OLDQTY/DELLOT) AND FLOOR(@@OLDQTY/DELLOT)-FLOOR(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@OLDQTY/DELLOT)
					   ELSE @@OLDQTY 
				  END), VARIATION,DELLOT    
        FROM #DELIVERY_TRANSACTION WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
  	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE     
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1    
  
   
	INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	
	SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,904,@@PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY=@@REMQTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,  
	REASON=(CASE WHEN @@FLAG = 'E' THEN 'EXCESS RECEIVED TRANSFERED' ELSE 'PAY-OUT' END ),  
	DRCR,DELIVERED,ORGQTY,DPTYPE,'','',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,
	(CASE WHEN @@REMQTY BETWEEN CEILING(@@REMQTY/DELLOT) AND CEILING(@@REMQTY/DELLOT)+CEILING(@@REMQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN CEILING(@@REMQTY/DELLOT) AND CEILING(@@REMQTY/DELLOT)-CEILING(@@REMQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN FLOOR(@@REMQTY/DELLOT) AND FLOOR(@@REMQTY/DELLOT)+FLOOR(@@REMQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN FLOOR(@@REMQTY/DELLOT) AND FLOOR(@@REMQTY/DELLOT)-FLOOR(@@REMQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@REMQTY/DELLOT)
					   ELSE @@REMQTY 
				  END), VARIATION,DELLOT     
        FROM #DELIVERY_TRANSACTION    
        WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'    
	AND PARTY_CODE = 'BROKER'     
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY     
       
        UPDATE #DELIVERY_TRANSACTION SET FILLER2 = 0  , FILLER3 = 40, ACTIVE = 0   
        WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
	AND WAREHOUSE = @@WAREHOUSE
	AND EXPIRY_DATE = @@EXPIRY_DATE     
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1    
      
    END    
    FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@ISIN,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE,@@TRADENEWQTY, @@VARIATION, @@DELLOT     
     END    
   END    
   CLOSE @@CERTCUR    
   DEALLOCATE @@CERTCUR     
      END    
      CLOSE @@QTYCUR    
      DEALLOCATE @@QTYCUR    
      FETCH NEXT FROM @@DELCLT INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@PARTY_CODE,@@DELQTY,@@FLAG,@@PRIORITY, @@DPTYPE, @@DPFLAG
END    
CLOSE @@DELCLT    
DEALLOCATE @@DELCLT    

DROP TABLE #DELALLOCATE

 SELECT DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,DT.PARTY_CODE,QTY=ISNULL(SUM(DT.NEWQTY),0)+  
 ISNULL((CASE WHEN SELL_BUY = 'B' THEN D.TOTAL_ALLOCATED_QTY ELSE 0 END),0)-ISNULL((CASE WHEN SELL_BUY='S' THEN D.TOTAL_ALLOCATED_QTY ELSE 0 END),0),  
 FLAG='E', PRIORITY = 0, DPTYPE = 'XXXX', DPFLAG = 4  INTO #DELALLOCATE1 FROM       
 CLIENT2 C2,#DELIVERY_TRANSACTION DT LEFT OUTER JOIN DELIVERY_OBL_CLT D     
 ON ( D.SETT_NO = DT.SETT_NO AND D.SETT_TYPE = DT.SETT_TYPE AND     
 D.SYMBOL = DT.SYMBOL AND D.INST_TYPE = DT.INST_TYPE AND D.PARTY_CODE = DT.PARTY_CODE  
 AND D.EXPIRY_DATE = DT.EXPIRY_DATE AND D.WAREHOUSE=DT.WAREHOUSE)    
 WHERE DT.SETT_NO = @SETT_NO AND DT.SETT_TYPE = @SETT_TYPE 
 AND DT.ACTIVE = 1 AND DRCR = 'C'  AND C2.PARTY_CODE = DT.PARTY_CODE      
 GROUP BY DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,D.TOTAL_ALLOCATED_QTY,DT.PARTY_CODE,D.SELL_BUY    

 INSERT INTO #DELALLOCATE1  
 SELECT DT.SYMBOL,DT.INST_TYPE,DT.EXPIRY_DATE,DT.WAREHOUSE,DT.PARTY_CODE,QTY=TOTAL_ALLOCATED_QTY,FLAG='R', PRIORITY=1, DPTYPE = 'XXXX', DPFLAG = 4 FROM  
 DELIVERY_OBL_CLT DT , CLIENT1 C1, CLIENT2 C2
 WHERE SELL_BUY = 'B'    
 AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
 AND C1.CL_CODE = C2.CL_CODE     
 AND C2.PARTY_CODE = DT.PARTY_CODE    
 AND DT.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM #DELALLOCATE1 A 
 WHERE A.SYMBOL = DT.SYMBOL AND A.INST_TYPE = DT.INST_TYPE AND A.PARTY_CODE = DT.PARTY_CODE  
 AND A.EXPIRY_DATE = DT.EXPIRY_DATE AND A.WAREHOUSE=DT.WAREHOUSE )

 SET @@DELCLT = CURSOR FOR
     SELECT * FROM #DELALLOCATE1 WHERE QTY > 0 
     ORDER BY SYMBOL, INST_TYPE, EXPIRY_DATE, WAREHOUSE, FLAG, DPFLAG, QTY DESC, PARTY_CODE DESC
OPEN @@DELCLT    
FETCH NEXT FROM @@DELCLT INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@PARTY_CODE,@@DELQTY,@@FLAG,@@PRIORITY, @@DPTYPE, @@DPFLAG
WHILE @@FETCH_STATUS = 0     
BEGIN    
       SET @@QTYCUR = CURSOR FOR     
       SELECT ISNULL(SUM(NEWQTY),0), ISNULL(SUM(QTY),0) FROM #DELIVERY_TRANSACTION     
       WHERE SETT_NO = @SETT_NO     
       AND SETT_TYPE = @SETT_TYPE     
       AND REFNO = @REFNO    
       AND PARTY_CODE = @@PARTY_CODE    
       AND SYMBOL  = @@SYMBOL     
       AND INST_TYPE = @@INST_TYPE  
       AND EXPIRY_DATE = @@EXPIRY_DATE  
       AND WAREHOUSE = @@WAREHOUSE
       AND DRCR = 'D' AND ACTIVE = 1 
       GROUP BY VARIATION, DELLOT    
       OPEN @@QTYCUR     
       FETCH NEXT FROM @@QTYCUR INTO @@NEWQTY,@@QTY       
       IF @@DELQTY > ISNULL(@@NEWQTY,0)    
       BEGIN      
			SET @@NEWQTY = ISNULL(@@NEWQTY,0)
			  SELECT @@DELQTY = @@DELQTY - @@NEWQTY    
			  SET @@CERTCUR = CURSOR FOR    
			  SELECT QTY,ISIN, FROMNO,FOLIONO,TDATE=LEFT(CONVERT(VARCHAR,TRANSDATE,109),11),ORGQTY,SNO,TCODE,NEWQTY, VARIATION, DELLOT     
			  FROM #DELIVERY_TRANSACTION     
			  WHERE SETT_NO = @SETT_NO     
        		  AND SETT_TYPE = @SETT_TYPE     
        		  AND REFNO = @REFNO    
        		  AND PARTY_CODE = 'BROKER'    
        		  AND SYMBOL  = @@SYMBOL     
        		  AND INST_TYPE = @@INST_TYPE  
        		  AND EXPIRY_DATE  = @@EXPIRY_DATE  
        		  AND WAREHOUSE = @@WAREHOUSE
        		  AND DRCR = 'D'  AND TRTYPE <> 1000  AND ACTIVE = 1
			  ORDER BY TRANSDATE ASC,QTY DESC     
   OPEN @@CERTCUR    
   FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@ISIN,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE,@@TRADENEWQTY, @@VARIATION, @@DELLOT     
   IF @@FETCH_STATUS = 0     
   BEGIN    
     SELECT @@PCOUNT = 0    
     WHILE @@PCOUNT < @@DELQTY AND @@FETCH_STATUS = 0     
     BEGIN    
     SELECT @@PCOUNT = @@PCOUNT + @@TRADENEWQTY    
       IF @@PCOUNT <= @@DELQTY     
     BEGIN        
    
	 INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	 DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	  
	 SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,904,@@PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,  
	 REASON=(CASE WHEN @@FLAG = 'E' THEN 'EXCESS RECEIVED TRANSFERED' ELSE 'PAY-OUT' END ),  
	 'D',DELIVERED,ORGQTY,DPTYPE,'','',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT  
  
    FROM #DELIVERY_TRANSACTION WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE     
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1         
  
     UPDATE #DELIVERY_TRANSACTION SET ACTIVE = 0  ,FILLER2 = 0   
          WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
			AND REFNO = @REFNO     
			AND SNO = @@SNO AND TCODE = @@TCODE     
			AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
			AND EXPIRY_DATE = @@EXPIRY_DATE  
			AND WAREHOUSE = @@WAREHOUSE
			AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
			AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
			AND PARTY_CODE = 'BROKER'      
			AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1        
    END        
       ELSE      
       BEGIN    
		  SELECT @@PCOUNT = @@PCOUNT - @@TRADENEWQTY    
          SELECT @@REMQTY = @@DELQTY - @@PCOUNT    
          SELECT @@PCOUNT = @@PCOUNT + @@REMQTY
          
		  SELECT @@REMQTY = (CASE WHEN @@TRADEQTY = @@TRADENEWQTY THEN @@REMQTY ELSE 
				 (CASE WHEN @@TRADEQTY BETWEEN CEILING(@@TRADEQTY/@@DELLOT) AND CEILING(@@TRADEQTY/@@DELLOT)+CEILING(@@TRADEQTY/@@DELLOT)*@@VARIATION/100
					   THEN @@REMQTY + CEILING(@@REMQTY/@@DELLOT)*@@VARIATION/100
					   WHEN @@TRADEQTY BETWEEN CEILING(@@TRADEQTY/@@DELLOT) AND CEILING(@@TRADEQTY/@@DELLOT)-CEILING(@@TRADEQTY/@@DELLOT)*@@VARIATION/100
					   THEN @@REMQTY - CEILING(@@REMQTY/@@DELLOT)*@@VARIATION/100					   
					   ELSE @@REMQTY
				  END) END)
					   
          SELECT @@OLDQTY = @@TRADEQTY - @@REMQTY      
         
	 INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	 EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	 DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	 BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	 FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	
	SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY=@@OLDQTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	'D',DELIVERED,ORGQTY,'', '', '',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,
	(CASE WHEN @@OLDQTY BETWEEN CEILING(@@OLDQTY/DELLOT) AND CEILING(@@OLDQTY/DELLOT)+CEILING(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN CEILING(@@OLDQTY/DELLOT) AND CEILING(@@OLDQTY/DELLOT)-CEILING(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN FLOOR(@@OLDQTY/DELIVERY_LOT) AND FLOOR(@@OLDQTY/DELLOT)+FLOOR(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@OLDQTY/DELLOT)
					   WHEN @@OLDQTY BETWEEN FLOOR(@@OLDQTY/DELLOT) AND FLOOR(@@OLDQTY/DELLOT)-FLOOR(@@OLDQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@OLDQTY/DELLOT)
					   ELSE @@OLDQTY 
				  END), VARIATION,DELLOT    
        FROM #DELIVERY_TRANSACTION WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
  	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE     
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1    
  
   
	INSERT INTO #DELIVERY_TRANSACTION(SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,  
	DRCR,DELIVERED,ORGQTY,DPTYPE, DPID, CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,NEWQTY,VARIATION,DELLOT)  
	
	SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,904,@@PARTY_CODE,INST_TYPE,SYMBOL,  
	EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,QTY=@@REMQTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,  
	REASON=(CASE WHEN @@FLAG = 'E' THEN 'EXCESS RECEIVED TRANSFERED' ELSE 'PAY-OUT' END ),  
	DRCR,DELIVERED,ORGQTY,DPTYPE,'','',BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,  
	BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,  
	FILLER3,FILLER4,FILLER5,
	(CASE WHEN @@REMQTY BETWEEN CEILING(@@REMQTY/DELLOT) AND CEILING(@@REMQTY/DELLOT)+CEILING(@@REMQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN CEILING(@@REMQTY/DELLOT) AND CEILING(@@REMQTY/DELLOT)-CEILING(@@REMQTY/DELLOT)*VARIATION/100
					   THEN CEILING(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN FLOOR(@@REMQTY/DELLOT) AND FLOOR(@@REMQTY/DELLOT)+FLOOR(@@REMQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@REMQTY/DELLOT)
					   WHEN @@REMQTY BETWEEN FLOOR(@@REMQTY/DELLOT) AND FLOOR(@@REMQTY/DELLOT)-FLOOR(@@REMQTY/DELLOT)*VARIATION/100
					   THEN FLOOR(@@REMQTY/DELLOT)
					   ELSE @@REMQTY 
				  END), VARIATION,DELLOT    
        FROM #DELIVERY_TRANSACTION    
        WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
	AND EXPIRY_DATE = @@EXPIRY_DATE  
	AND WAREHOUSE = @@WAREHOUSE
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'    
	AND PARTY_CODE = 'BROKER'     
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY     
       
    UPDATE #DELIVERY_TRANSACTION SET FILLER2 = 0, FILLER3 = 40, ACTIVE = 0   
    WHERE SETT_NO  = @SETT_NO AND SETT_TYPE = @SETT_TYPE    
	AND REFNO = @REFNO     
	AND SNO = @@SNO AND TCODE = @@TCODE     
	AND SYMBOL = @@SYMBOL AND INST_TYPE = @@INST_TYPE  
	AND WAREHOUSE = @@WAREHOUSE
	AND EXPIRY_DATE = @@EXPIRY_DATE     
	AND ISIN  = @@ISIN AND FROMNO = @@FROMNO     
	AND FOLIONO = @@FOLIONO AND TRANSDATE LIKE @@SDATE + '%'     
	AND PARTY_CODE = 'BROKER'      
	AND DRCR = 'D' AND ORGQTY = @@ORGQTY AND ACTIVE = 1    
      
    END    
    FETCH NEXT FROM @@CERTCUR INTO @@TRADEQTY,@@ISIN,@@FROMNO,@@FOLIONO,@@SDATE,@@ORGQTY,@@SNO,@@TCODE,@@TRADENEWQTY, @@VARIATION, @@DELLOT     
     END    
   END    
   CLOSE @@CERTCUR    
   DEALLOCATE @@CERTCUR     
      END    
      CLOSE @@QTYCUR    
      DEALLOCATE @@QTYCUR    
      FETCH NEXT FROM @@DELCLT INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@PARTY_CODE,@@DELQTY,@@FLAG,@@PRIORITY, @@DPTYPE, @@DPFLAG
END    
CLOSE @@DELCLT    
DEALLOCATE @@DELCLT    
    
DROP TABLE #DELALLOCATE1 

/*UPDATE #DELIVERY_TRANSACTION SET  DPTYPE = C.DPTYPE, DPID = C.DPID, CLTDPID = C.CLTDPNO  
FROM MULTICLTID C WHERE C.PARTY_CODE = #DELIVERY_TRANSACTION.PARTY_CODE    
AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE AND DEF = 1 AND #DELIVERY_TRANSACTION.DPID = '' 
AND FILLER2 = 1 AND DRCR = 'D'    
AND DELIVERED = '0' AND TRTYPE = 904
AND BDPTYPE = C.DPTYPE*/


UPDATE #DELIVERY_TRANSACTION SET DPTYPE = C.DEPOSITORY,DPID = C.BANKID, CLTDPID = C.CLTDPID 
FROM CLIENT4 C (NOLOCK), DELIVERYDP DP  (NOLOCK)
WHERE C.PARTY_CODE = #DELIVERY_TRANSACTION.PARTY_CODE AND DEFDP = 1 AND ACTIVE = 1 AND DRCR = 'D' AND DELIVERED = '0' 
AND FILLER2 = 1 AND TRTYPE =904 AND DP.DPID = #DELIVERY_TRANSACTION.BDPID AND DP.DPCLTNO = #DELIVERY_TRANSACTION.BCLTDPID 
AND DP.DPTYPE = #DELIVERY_TRANSACTION.BDPTYPE AND C.DEPOSITORY = #DELIVERY_TRANSACTION.BDPTYPE
AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
  
INSERT INTO DELIVERY_TRANSACTION
SELECT SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,
       OPTION_TYPE,QTY,TRANSNO,FROMNO,TONO,ISIN,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY=NEWQTY,DPTYPE,
       DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,COUNTERPARTY,WAREHOUSE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,
       SHARETYPE,TRANSDATE,BDPTYPE,BDPID,BCLTDPID,ACTIVE,FILLER1,FILLER2,FILLER3,FILLER4,FILLER5 
FROM #DELIVERY_TRANSACTION
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsNCDXDelAllocate
-- --------------------------------------------------




CREATE  Proc [dbo].[Delivery_InsNCDXDelAllocate] (@Sett_No Varchar(7),@Sett_Type Varchar(2),@RefNo int,@ScripCd Varchar(12),@Inst_Type Varchar(7),@Expiry_Date datetime,@@WareHouse Varchar(20),@EntityCode Varchar(10),@DelQty numeric(18,4),@CQty numeric(18,4),@TrType int) As  
Declare @@Qty int,  
 @@ISIN Varchar(15),  
 @@FromNo Varchar(15),  
 @@FolioNo Varchar(15),  
 @@Date Varchar(11),  
 @@SNo numeric(18,0),  
 @@TCode numeric(18,0),  
 @@OrgQty numeric(18,4) ,  
 @@PCount numeric(18,4) ,  
 @@DelMov Cursor  

 Set @@DelMov = Cursor For     
 Select Qty,IsIn,FolioNo,TDate=left(convert(varchar,TransDate,109),11),orgqty,Sno,TCode  from Delivery_Transaction
 Where 
	Sett_No = @sett_no and
	Sett_Type = @sett_type and
	RefNo = @RefNo and
	TrType = @TrType and
	Symbol = @ScripCd and
	Expiry_Date = @Expiry_Date  and
	WareHouse = @@WareHouse and
	Inst_Type = @Inst_Type and
	Party_code ='BROKER' and
	DrCr = 'D' and
	Active = 1 and
	TCode not in ( Select TCode from Delivery_Transaction where
		Sett_No = @sett_no and
		Sett_Type = @sett_type and
		RefNo = @RefNo and
		TrType = 906 and
		Symbol = @ScripCd and
		Expiry_Date = @Expiry_Date and
		WareHouse = @@WareHouse and 
		Inst_Type = @Inst_Type and
		DrCr = 'C' and
		Active = 1)

Open @@DelMov    
  Fetch Next From @@DelMov into @@Qty,@@ISIN,@@FolioNo,@@Date,@@OrgQty,@@SNo,@@TCode    

      if @@Fetch_Status = 0   
          Begin  
          Select @@PCount = 0    
          while @@PCount < @DelQty and @@Fetch_Status = 0   
             Begin  
             Select @@PCount = @@PCount + @@Qty  
             if @@PCount > @DelQty   
              Begin  

		Insert into Delivery_Transaction (Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Inst_Type,Symbol,
		Expiry_Date,Strike_Price,Option_Type,Qty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,DrCr,
		Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
		ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,Active,Filler1,Filler2,Filler3,
		Filler4,Filler5)
		Select Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Inst_Type,Symbol,
		Expiry_Date,Strike_Price,Option_Type,Qty=@@PCount-@DelQty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,'D',
		Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
		ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,1,0,1,Filler3,
		Filler4,Filler5 from Delivery_Transaction
		where sett_no  = @sett_no and sett_type = @sett_type  
		and RefNo = @RefNo and TrType = @TrType  
		AND SNO = @@SNo and TCode = @@TCode   
		and Symbol = @ScripCd and expiry_date = @expiry_date
		and WareHouse = @@WareHouse
		and inst_type = @Inst_Type
		and ISIN  = @@ISIN 	and FolioNo = @@foliono and TransDate Like @@Date + '%'  
		and Party_Code = 'BROKER'   
		and DrCr = 'D' and orgqty = @@orgqty  

		Insert into Delivery_Transaction (Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Inst_Type,Symbol,
		Expiry_Date,Strike_Price,Option_Type,Qty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,DrCr,
		Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
		ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,Active,Filler1,Filler2,Filler3,
		Filler4,Filler5)
		Select Sett_No,Sett_type,RefNo,TCode,906,@EntityCode,Inst_Type,Symbol,
		Expiry_Date,Strike_Price,Option_Type,Qty=@@qty-@@PCount+@DelQty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,'D',
		Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
		ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,1,0,1,Filler3,
		Filler4,Filler5 from Delivery_Transaction
		where sett_no  = @sett_no and sett_type = @sett_type  
		and RefNo = @RefNo and TrType = @TrType  
		AND SNO = @@SNo and TCode = @@TCode   
		and Symbol = @ScripCd and expiry_date = @expiry_date
		and WareHouse = @@WareHouse
		and inst_type = @Inst_Type
		and ISIN  = @@ISIN 	and FolioNo = @@foliono and TransDate Like @@Date + '%'  
		and Party_Code = 'BROKER'   
		and DrCr = 'D' and orgqty = @@orgqty  
	
		update Delivery_Transaction set Filler2 = 0 ,Filler3 = 40 , Active =0 
		where sett_no  = @sett_no and sett_type = @sett_type  
		and RefNo = @RefNo and TrType = @TrType  
		AND SNO = @@SNo and TCode = @@TCode   
		and Symbol = @ScripCd and expiry_date = @expiry_date
		and WareHouse = @@WareHouse
		and ISIN  = @@ISIN and inst_Type = @Inst_Type   
		and FolioNo = @@foliono and TransDate Like @@Date + '%'  
		and Party_Code = 'BROKER'   
		and DrCr = 'D' and orgqty = @@orgqty  
		
		update Delivery_Transaction set Filler3 = 30  
		where sett_no  = @sett_no and sett_type = @sett_type  
		and RefNo = @RefNo and TrType = @TrType  
		AND SNO = @@SNo and TCode = @@TCode   
		and Symbol = @ScripCd and expiry_date = @expiry_date 
		and WareHouse = @@WareHouse
		and ISIN  = @@ISIN and inst_Type = @Inst_Type  
		and FolioNo = @@foliono and TransDate Like @@Date + '%'      
		and DrCr = 'D' and orgqty = @@orgqty and Filler2 = 1  
	   end 
	else  
          Begin  

						Insert into Delivery_Transaction (Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,Inst_Type,Symbol,
						Expiry_Date,Strike_Price,Option_Type,Qty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,DrCr,
						Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
						ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,Active,Filler1,Filler2,Filler3,
						Filler4,Filler5)
						Select Sett_No,Sett_type,RefNo,TCode,906,@EntityCode,Inst_Type,Symbol,
						Expiry_Date,Strike_Price,Option_Type,Qty,TransNo,FromNo,ToNo,IsIn,FolioNo,HolderName,Reason,'D',
						Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,
						ISett_No,ISett_Type,ShareType,TransDate,BDpType,BDpId,BCltDpId,1,0,1,Filler3,
						Filler4,Filler5 from Delivery_Transaction
						where sett_no  = @sett_no and sett_type = @sett_type  
						and RefNo = @RefNo and TrType = @TrType  
						AND SNO = @@SNo and TCode = @@TCode   
						and Symbol = @ScripCd and expiry_date = @expiry_date
						and WareHouse = @@WareHouse
						and inst_type = @Inst_Type
						and ISIN  = @@ISIN 	and FolioNo = @@foliono and TransDate Like @@Date + '%'  
						and Party_Code = 'BROKER'   
						and DrCr = 'D' and orgqty = @@orgqty  
					
						
						update Delivery_Transaction set Filler2 = 0 , Active = 0
						where sett_no  = @sett_no and sett_type = @sett_type  
						and RefNo = @RefNo and TrType = @TrType  
						AND SNO = @@SNo and TCode = @@TCode   
						and Symbol = @ScripCd and expiry_date = @expiry_date  
						and WareHouse = @@WareHouse
						and ISIN  = @@ISIN and inst_Type = @Inst_Type  
						and FolioNo = @@foliono and TransDate Like @@Date + '%'  
						and Party_Code = 'BROKER'   
						and DrCr = 'D' and orgqty = @@orgqty  

           End  
          Fetch Next From @@DelMov into @@Qty,@@ISIN,@@FolioNo,@@Date,@@OrgQty,@@SNo,@@TCode  
      end  
      Close @@DelMov  
      DeAllocate @@DelMov  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsNCDXDelCursor
-- --------------------------------------------------


CREATE  PROC [dbo].[Delivery_InsNCDXDelCursor] (@SETT_NO VARCHAR(7),@SETT_TYPE VARCHAR(2),@REFNO INT) AS    
  
DECLARE @@SYMBOL VARCHAR(12),    
	@@INST_TYPE VARCHAR(7),    
	@@EXPIRY_DATE DATETIME,  
	@@WAREHOUSE VARCHAR(20),
	@@ENTITYCODE VARCHAR(10),    
	@@DELQTY NUMERIC(18,4) ,    
	@@CQTY NUMERIC(18,4) ,    
	@@TRTYPE NUMERIC(18,4) ,    
	@@DELCUR CURSOR    


EXECUTE DELIVERY_INSDELCHECKPOS @REFNO
EXECUTE DELIVERY_INSDEMATALLOCATECURSOR @REFNO
EXECUTE DELIVERY_INSDEMATNCDXCURSOR @REFNO


IF (SELECT ISNULL(ALLOCATIONTYPE,0) FROM DELIVERY_MASTER ) = 0 
BEGIN
   
	SET @@DELCUR = CURSOR FOR    
	  
	SELECT D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE,D.WAREHOUSE,PAYIN_QTY=SUM(CASE WHEN DRCR ='C' THEN QTY ELSE -QTY END),
		'EXE',CQTY=0,TRTYPE=904    
	FROM
		DELIVERY_TRANSACTION D
	WHERE
		D.SETT_NO = @SETT_NO AND D.SETT_TYPE = @SETT_TYPE
		AND FILLER2 = 1 AND REFNO = @REFNO AND TRTYPE = 906 
		AND SETT_NO NOT IN (SELECT SETT_NO FROM DELIVERY_OBL_NET C
		WHERE  
		C.SETT_NO = D.SETT_NO AND C.SETT_TYPE = D.SETT_TYPE  AND    
		D.ISIN LIKE (CASE WHEN D.SETT_TYPE = 'A' THEN '%' ELSE 'IN%' END)    
		AND C.SYMBOL = D.SYMBOL AND C.INST_TYPE = D.INST_TYPE AND C.EXPIRY_DATE = D.EXPIRY_DATE 
		AND C.WAREHOUSE=D.WAREHOUSE
		)
	GROUP BY
		D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE,D.WAREHOUSE
	HAVING SUM(CASE WHEN DRCR ='C' THEN QTY ELSE -QTY END) > 0
	
	UNION ALL 
	
	SELECT D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE,D.WAREHOUSE,PAYIN_QTY=PAYIN_QTY,'EXE',CQTY=0,TRTYPE=904    
	FROM DELIVERY_OBL_NET D LEFT OUTER JOIN DELIVERY_TRANSACTION C ON   
		( C.SETT_NO = D.SETT_NO AND C.SETT_TYPE = D.SETT_TYPE     
		AND FILLER2 = 1 AND REFNO = @REFNO AND TRTYPE = 906 AND     
		D.ISIN LIKE (CASE WHEN D.SETT_TYPE = 'A' THEN '%' ELSE 'IN%' END)    
		AND C.SYMBOL = D.SYMBOL AND C.INST_TYPE = D.INST_TYPE AND C.EXPIRY_DATE = D.EXPIRY_DATE AND C.WAREHOUSE=D.WAREHOUSE)    
		WHERE  D.SETT_NO = @SETT_NO AND D.SETT_TYPE = @SETT_TYPE  
		AND (PAYIN_QTY) > 0     
	GROUP BY D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE,D.WAREHOUSE,PAYIN_QTY,PAYOUT_QTY     
	ORDER BY D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE,D.WAREHOUSE
	    
	OPEN @@DELCUR    
	FETCH NEXT FROM @@DELCUR INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@DELQTY,@@ENTITYCODE,@@CQTY,@@TRTYPE    
	  
	  
	    
	WHILE @@FETCH_STATUS = 0    
	BEGIN    
	  
	  
	 EXECUTE DELIVERY_INSNCDXDELALLOCATE @SETT_NO,@SETT_TYPE,@REFNO,@@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@ENTITYCODE,@@DELQTY,@@CQTY,@@TRTYPE  
	  
	 FETCH NEXT FROM @@DELCUR INTO @@SYMBOL,@@INST_TYPE,@@EXPIRY_DATE,@@WAREHOUSE,@@DELQTY,@@ENTITYCODE,@@CQTY,@@TRTYPE    
	    
	END    
	  
	  
	  
	CLOSE @@DELCUR    
	DEALLOCATE @@DELCUR    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_InsPrintPool
-- --------------------------------------------------

CREATE  Proc [dbo].[Delivery_InsPrintPool] 
	(
		@OptFlag Int, 
		@BDpType Varchar(4), 
		@BDpId Varchar(8), 
		@BCltDpID Varchar(16)
	)   
As  
Declare   
	@Sett_no Varchar(7),  
	@Sett_Type Varchar(2),  
	@SNo Numeric,  
	@Qty numeric(18, 4),  
	@diffQty numeric(18, 4),  
	@SlipNo Int,  
	@BatchNo int,  
	@TransDate Varchar(11),  
	@HolderName Varchar(30),  
	@FolioNo Varchar(20),  
	@Party_Code Varchar(10),  
	@CertNo Varchar(12),  
	@TrType Int,  
	@DpId Varchar(8),  
	@CltDpId Varchar(16),  
	@DelBDpId Varchar(8),  
	@DelBCltDpId Varchar(16),  
	@AllQty numeric(18, 4),  
	@DelCur Cursor,  
	@BenCur Cursor  
  
If @OptFlag = 1   
Begin  
	Update 
		Delivery_Transaction 
	Set 
		Delivered = 'G', SlipNo = D.SlipNo,   
		BatchNo = D.BatchNo, FolioNo = D.FolioNo,  
		TransDate = D.TransDate, HolderName = d.HolderName  
	From 
		Delivery_TransPrintPool D  
	Where 
		Delivery_Transaction.Sett_No = D.Sett_No  
		And Delivery_Transaction.Sett_Type = D.Sett_Type  
		And Delivery_Transaction.Party_Code >= D.FromParty  
		And Delivery_Transaction.Party_Code <= D.ToParty  
		And Delivery_Transaction.isin = D.CertNo  
		And Delivery_Transaction.TrType = D.TrType  
		And Active = 1  
		And DrCr = 'D'  
		And Delivery_Transaction.BDpType = D.BDpType  
		And Delivery_Transaction.BDpId = D.BDpId  
		And Delivery_Transaction.BCltDpId = D.BCltDpId  
		And Delivered = '0'  
		And Delivery_Transaction.ISett_No = D.ISett_No  
		And Delivery_Transaction.ISett_Type = D.ISett_Type  
		And OptionFlag = 1  And Delivery_Transaction.Party_Code <> 'BROKER'  
End  
  
If @OptFlag = 3  
Begin  
	Update
		Delivery_Transaction
	Set
		Delivered = 'G', SlipNo = D.SlipNo,   
		BatchNo = D.BatchNo, FolioNo = D.FolioNo,  
		TransDate = D.TransDate, HolderName = d.HolderName  
	From
		Delivery_TransPrintPool D  
	Where
		Delivery_Transaction.Sett_No = D.Sett_No  
		And Delivery_Transaction.Sett_Type = D.Sett_Type  
		And Delivery_Transaction.Party_Code >= D.FromParty  
		And Delivery_Transaction.Party_Code <= D.ToParty  
		And Delivery_Transaction.Party_Code = D.Party_Code  
		And Delivery_Transaction.isin = D.CertNo  
		And Delivery_Transaction.TrType = D.TrType  
		And Active = 1  
		And DrCr = 'D'  
		And Delivery_Transaction.BDpType = D.BDpType  
		And Delivery_Transaction.BDpId = D.BDpId  
		And Delivery_Transaction.BCltDpId = D.BCltDpId  
		And Delivered = '0'  
		And Delivery_Transaction.DpId = D.DpId  
		And Delivery_Transaction.CltDpId = D.CltDpId  
		And OptionFlag = 3  
		And D.Qty = NewQty   
		And Delivery_Transaction.Party_Code <> 'BROKER'  

		Insert Into Delivery_TransactionTemp  
		Select 
			Dt.Sett_No,Dt.Sett_type,Dt.RefNo,Dt.TCode,Dt.TrType,  
			Dt.Party_Code,Dt.inst_type,Dt.Symbol,Dt.Expiry_Date,Dt.Strike_price,dt.option_type,
			Dt.Qty,Dt.TransNo,Dt.FromNo,Dt.ToNo,  
			Dt.isin,Dt.FolioNo,Dt.HolderName,Dt.Reason,Dt.DrCr,'D',Dt.OrgQty,  
			Dt.DpType,Dt.DpId,Dt.CltDpId,Dt.BranchCd,Dt.PartipantCode,dt.CounterParty,
			dt.warehouse,Dt.SlipNo, Dt.BatchNo,Dt.ISett_No,Dt.ISett_Type,Dt.ShareType,
			Dt.TransDate,Dt.BDpType,Dt.BDpId,Dt.BCltDpId,
			dt.Active,Dt.Filler1,Dt.Filler2,Dt.Filler3,Dt.Filler4,Dt.Filler5  
		From 
			Delivery_Transaction Dt, Delivery_TransPrintPool D  
		Where 
			Dt.Sett_No = D.Sett_No  
			And Dt.Sett_Type = D.Sett_Type  
			And Dt.Party_Code >= D.FromParty  
			And Dt.Party_Code <= D.ToParty  
			And Dt.Party_Code = D.Party_Code  
			And Dt.isin = D.CertNo  
			And Dt.TrType = D.TrType  
			And Active = 1  
			And DrCr = 'D'  
			And Dt.BDpType = D.BDpType  
			And Dt.BDpId = D.BDpId  
			And Dt.BCltDpId = D.BCltDpId  
			And Delivered = 'G'  
			And Dt.DpId = D.DpId  
			And Dt.CltDpId = D.CltDpId  
			And Dt.FolioNo = D.FolioNo  
			And Dt.SlipNo = D.SlipNo  
			And Dt.BatchNo = D.BatchNo  
			And OptionFlag = 3  
			And D.Qty = NewQty   
			And Dt.Party_Code <> 'BROKER'  
		  
	Set @BenCur = Cursor For  
	Select 
		Sett_No, Sett_Type, Party_Code, CertNo, TrType, DpId, CltDpId, SlipNo, BatchNo, FolioNo,   
		HolderName, Qty , TransDate = Left(Convert(Varchar,TransDate,109),11), BDpId, BCltDpId  
	From 
		Delivery_TransPrintPool Where OptionFlag = 3 And Qty <> NewQty   
	Order BY Party_Code, CertNo  
	Open @BenCur  
	Fetch Next From @BenCur into 
		@Sett_No, @Sett_Type, @Party_Code, @CertNo, @TrType, @DpId, @CltDpId, @SlipNo, @BatchNo, @FolioNo,   
		@HolderName, @AllQty , @TransDate, @DelBDpId, @DelBCltDpId  

		While @@Fetch_Status = 0   
		Begin  
			 Select @DiffQty = @AllQty  
			 Set @DelCur = Cursor For  
				 Select Sno, Qty From Delivery_Transaction  
				 Where 
					Party_Code = @Party_Code  
					And isin = @CertNo  
					And TrType = @TrType  
					And DrCr = 'D'  
					And Delivered = '0'  
					And Active = 1   
					And DpId = @DpId  
					And CltDpId = @CltDpId  
					And BDpId = @DelBDpId  
					And BCltDpId = @DelBCltDpId  
					Order By Sett_No, Sett_Type, Qty Desc  
				 Open @DelCur  
				 Fetch Next From @DelCur into @Sno, @Qty   
				 While @@Fetch_Status = 0 And @DiffQty > 0   
					 Begin  
						  If @DiffQty >= @Qty  
						  Begin  
							Update 
								Delivery_Transaction 
							Set 
								SlipNo = @Slipno, BatchNo = @BatchNo, FolioNo = @Foliono,  
								HolderName = @HolderName, TransDate = @TransDate, Delivered = 'G'  
							Where 
								Sett_no = @Sett_No  
								And Sett_Type = @Sett_Type  
								And Sno = @Sno  

							Select @DiffQty = @DiffQty - @Qty  
						  End  
					  Else  
						  Begin  
				Insert Into Delivery_Transaction  
				Select 
					Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,inst_type,symbol,expiry_date,strike_price,option_type,
					@Qty-@DiffQty,TransNo,FromNo,ToNo,isin,FolioNo,HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,  
					PartipantCode,CounterParty,WareHouse,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,
					TransDate,BDpType,BDpId,BCltDpId,Active,Filler1,Filler2,  
					Filler3,Filler4,Filler5 
				From
					Delivery_Transaction  
				Where
					Sett_no = @Sett_No  
					And Sett_Type = @Sett_Type  
					And Sno = @Sno  
			  
				Update 
					Delivery_Transaction 
				Set 
					SlipNo = @Slipno, BatchNo = @BatchNo, FolioNo = @Foliono,  
					HolderName = @HolderName, TransDate = @TransDate, Delivered = 'G', 
					Qty = @DiffQty  
				Where 
					Sett_no = @Sett_No  
					And Sett_Type = @Sett_Type  
					And Sno = @Sno  
  
  				 Select @DiffQty = 0   
  			End  
		  Fetch Next From @DelCur into @Sno, @Qty   
		 End  
		 Fetch Next From @BenCur into 
				@Sett_No, @Sett_Type,@Party_Code, @CertNo, @TrType, @DpId, @CltDpId, 
				@SlipNo, @BatchNo, @FolioNo,  @HolderName, @AllQty , @TransDate, 
				@DelBDpId, @DelBCltDpId  
		End  
		  
		Insert Into Delivery_TransactionTemp  
		Select 
			Dt.Sett_No,Dt.Sett_type,Dt.RefNo,Dt.TCode,Dt.TrType,  
			Dt.Party_Code,Dt.inst_type,Dt.Symbol,Dt.Expiry_Date,Dt.Strike_price,dt.option_type,
			Dt.Qty,Dt.TransNo,Dt.FromNo,Dt.ToNo,  
			Dt.isin,Dt.FolioNo,Dt.HolderName,Dt.Reason,Dt.DrCr,'D',Dt.OrgQty,  
			Dt.DpType,Dt.DpId,Dt.CltDpId,Dt.BranchCd,Dt.PartipantCode,dt.CounterParty,dt.warehouse,Dt.SlipNo,  
			Dt.BatchNo,Dt.ISett_No,Dt.ISett_Type,Dt.ShareType,Dt.TransDate,Dt.BDpType,Dt.BDpId,Dt.BCltDpId,
			dt.Active,Dt.Filler1,Dt.Filler2,Dt.Filler3,Dt.Filler4,Dt.Filler5  
		From 
			Delivery_Transaction Dt, Delivery_TransPrintPool D  
		Where 
			Dt.Sett_No = D.Sett_No  
			And Dt.Sett_Type = D.Sett_Type  
			And Dt.Party_Code >= D.FromParty  
			And Dt.Party_Code <= D.ToParty  
			And Dt.Party_Code = D.Party_Code  
			And Dt.isin = D.CertNo  
			And Dt.TrType = D.TrType  
			And Active = 1  
			And DrCr = 'D'  
			And Dt.BDpType = D.BDpType  
			And Dt.BDpId = D.BDpId  
			And Dt.BCltDpId = D.BCltDpId  
			And Delivered = 'G'  
			And Dt.DpId = D.DpId  
			And Dt.CltDpId = D.CltDpId  
			And Dt.FolioNo = D.FolioNo  
			And Dt.SlipNo = D.SlipNo  
			And Dt.BatchNo = D.BatchNo  
			And OptionFlag = 3  
			And D.Qty <> NewQty  
		  
End  
  
If @OptFlag = 2  
Begin  
	Update 
		Delivery_Transaction 
	Set 
		Delivered = 'G', SlipNo = D.SlipNo,   
		BatchNo = D.BatchNo, FolioNo = D.FolioNo,  
		TransDate = D.TransDate, HolderName = d.HolderName  
	From 
		Delivery_TransPrintPool D  
	Where 
		Delivery_Transaction.Sett_No = D.Sett_No  
		And Delivery_Transaction.Sett_Type = D.Sett_Type  
		And Delivery_Transaction.Party_Code >= D.FromParty  
		And Delivery_Transaction.Party_Code <= D.ToParty  
		And Delivery_Transaction.isin = D.CertNo  
		And Delivery_Transaction.TrType = D.TrType  
		And Active = 1  
		And DrCr = 'D'  
		And Delivery_Transaction.BDpType = D.BDpType  
		And Delivery_Transaction.BDpId = D.BDpId  
		And Delivery_Transaction.BCltDpId = D.BCltDpId  
		And Delivered = '0'  
		And OptionFlag = 2  
		And Delivery_Transaction.Party_Code <> 'BROKER'  	
	  
	Insert Into Delivery_TransactionTemp  
	Select
		Dt.Sett_No,Dt.Sett_type,Dt.RefNo,Dt.TCode,Dt.TrType,  
		Dt.Party_Code,Dt.inst_type,Dt.Symbol,Dt.Expiry_Date,Dt.Strike_price,dt.option_type,
		Dt.Qty,Dt.TransNo,Dt.FromNo,Dt.ToNo,  
		Dt.isin,Dt.FolioNo,Dt.HolderName,Dt.Reason,Dt.DrCr,'0',Dt.OrgQty,  
		Dt.DpType,Dt.DpId,Dt.CltDpId,Dt.BranchCd,Dt.PartipantCode,dt.CounterParty,dt.warehouse,Dt.SlipNo,  
		Dt.BatchNo,Dt.ISett_No,Dt.ISett_Type,Dt.ShareType,Dt.TransDate,@BDpType,@BDpId,@BCltDpId,
		dt.Active,Dt.Filler1,Dt.Filler2,Dt.Filler3,Dt.Filler4,Dt.Filler5 
	From 
		Delivery_Transaction DT, Delivery_TransPrintPool D  
	Where 
		Dt.Sett_No = D.Sett_No  
		And Dt.Sett_Type = D.Sett_Type  
		And Dt.Party_Code >= D.FromParty  
		And Dt.Party_Code <= D.ToParty  
		And Dt.isin = D.CertNo  
		And Dt.TrType = D.TrType  
		And Active = 1  
		And DrCr = 'D'  
		And Dt.BDpType = D.BDpType  
		And Dt.BDpId = D.BDpId  
		And Dt.BCltDpId = D.BCltDpId  
		And Delivered = 'G'  
		And OptionFlag = 2  
		And Dt.FolioNo = D.FolioNo  
		And Dt.SlipNo = D.SlipNo  
		And Dt.BatchNo = D.BatchNo  
		And Dt.Party_Code <> 'BROKER'  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_IntDel_Upd
-- --------------------------------------------------



CREATE  Procedure Delivery_IntDel_Upd (@@Sett_No varchar(12),@@Sett_Type varchar(3)) AS      
      
/*      
  Procedure for Updating Client obligation for Internal delivery
  Author : Sinulal      
  Date   : 14 Jun 2005
  Modification Log : 
*/      

/*
--------------------------------------------------------
 The Following Unwanted Code is remarked. Sinu 29 Sep 05 - From Here
--------------------------------------------------------
Delete  Delivery_Transaction 
where Sett_Type =@@Sett_Type  And Sett_No = @@Sett_No 
And Reason ='Auction' 
And Party_Code in (
									Select Party_Code From Delivery_Obl_Clt 
									Where Del_Rec_No = 99999 
									And sett_type =@@Sett_Type
									And Sett_no = @@Sett_No
									)

Insert into Delivery_Transaction

Select C.Sett_No,C.Sett_type,(Select Max(RefNo) RefNo  From Delivery_Delcode) Refno,1 TCode, 904 TrType,
C.Party_Code,C.Inst_Type,C.Symbol,C.Expiry_Date,C.Strike_Price,C.Option_Type,
Total_Allocated_Qty,0 TransNo,1 FromNo,'' ToNo, IsIn,'' FolioNo,'' HolderName,
'Auction'  Reason,
Case When Sell_Buy='S' Then 'D' Else 'C' End DrCr,0 Delivered, Total_Allocated_Qty OrgQty, '' DpType, '' DpId, '' CltDpId, 
C1.Branch_Cd, MemberCode PartipantCode, '' CounterParty, C.WareHouse, 0 SlipNo, ''BatchNo, '' ISett_No, '' ISett_Type,
'Auction' ShareType,C.Report_Date TransDate, '' BDpType, '' BDpId, '' BCltDpId, 1 Active, '' Filler1,
'' Filler2,'' Filler3, '' Filler4, '' Filler5

From Client1 C1, Client2 C2, Delivery_Obl_Clt C,Delivery_Obl_Net N
Where
C.Inst_Type = N.Inst_Type
And C.Symbol = N.Symbol
And C.Expiry_Date = N.Expiry_Date
And C.Option_Type = N.Option_Type
And C.Strike_Price = N.Strike_Price
And C.WareHouse = N.WareHouse
And C.Party_Code = C2.Party_Code
And C1.Cl_Code = C2.Cl_Code
And C.Del_Rec_No = N.Del_Rec_No
And C.Del_Rec_No = 99999  
And C.Sett_Type = @@Sett_Type
And C.Sett_No = @@Sett_No

--------------------------------------------------------
 The Above Unwanted Code is remarked. Sinu 29 Sep 05 - Up To
--------------------------------------------------------
*/

/*
 Included the following for keeping cumilative party - commodity - warehouse - sell buy - obligation 
*/




Select
	Report_Date,
	Request_Date,
	CM_Primary_Code,
	Sett_Type,
	Sett_No,
	Inst_Type,
	Symbol,
	Expiry_Date,
	Strike_Price,
	Option_Type,
	CRA_Level,
	WareHouse,
	MemberCode,
	Member_Ac_Type,
	Party_Code,
	Sell_Buy,
	Sum(Tot_Req_Qty) Tot_Req_Qty,
	Sum(Qty_Req_Demat) Qty_Req_Demat,
	Sum(Qty_Req_Non_Demat) Qty_Req_Non_Demat,
	Accept_Flag,
	Sum(Total_Allocated_Qty) Total_Allocated_Qty,
	Sum(Total_Rej_Qty) Total_Rej_Qty,Del_Rec_No
into #Delivery_Obl_Clt
From 
	Delivery_Obl_Clt
Where
	Sett_Type =@@Sett_Type
	And Sett_No =@@Sett_No
Group By 
	Report_Date,
	Request_Date,
	CM_Primary_Code,
	Sett_Type,
	Sett_No,
	Inst_Type,
	Symbol,
	Expiry_Date,
	Strike_Price,
	Option_Type,
	CRA_Level,
	WareHouse,
	MemberCode,
	Member_Ac_Type,
	Party_Code,
	Sell_Buy,
	Accept_Flag,
	Del_Rec_No
	
Delete
	 Delivery_Obl_Clt 
Where	
	Sett_Type =@@Sett_Type
	And Sett_No =@@Sett_No

Insert Into 
	Delivery_Obl_Clt 
Select 
	*
From 
	#Delivery_Obl_Clt


Drop Table 	#Delivery_Obl_Clt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_MultiClientID
-- --------------------------------------------------
--EXEC Delivery_MultiClientID '0','zzz'    
CREATE PROC Delivery_MultiClientID      
(    
 @Del_CodeFROM VARCHAR(10),    
 @Del_CodeTO   VARCHAR(10)    
     
)    
AS    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
IF @Del_CodeFROM = '' BEGIN SET @Del_CodeFROM = '0' END    
IF @Del_CodeTO = '' BEGIN SET @Del_CodeTO = 'ZZZ' END    
    
BEGIN    
 Select     
   Party_Code,Cltdpno,Dpid,Introducer,Dptype,(Case When Def = 1 Then 'Default' Else null End) as Def  
 From     
  MultiCltId (nolock)    
 Where     
  Party_Code >= @Del_CodeFROM   
  And Party_Code <= @Del_CodeTO    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_MULTIISIN_RPT
-- --------------------------------------------------
CREATE proceDURE [dbo].[Delivery_MULTIISIN_RPT]

	@sym_frm varchar(12),
	@sym_to varchar(12)

AS

if @sym_frm = '' begin set @sym_frm = '0' end
if @sym_to = '' begin set @sym_to = 'zzzzzzzz' end

set transaction isolation level read uncommitted

Select
  Inst_Type,
  Symbol,
  IsIn,
  Perc,
  Status,
  EffDate = convert(datetime,EffDate),
  WareHouse

From 
   Delivery_MultiIsIn

Where
	Symbol BETWEEN @sym_frm AND @sym_to 

Order By
   EffDate Desc,
   Symbol,
   WareHouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_PostDelPos
-- --------------------------------------------------

CREATE PROC [dbo].[DELIVERY_POSTDELPOS]    
(    
    
 @TRADEDATE VARCHAR(11),    
 @INST_TYPE VARCHAR(6),    
 @OLDPARTY VARCHAR(15),    
 @NEWPARTY VARCHAR(15),    
 @OLDDELPOS INT,    
 @NEWDELPOS INT,    
 @UDINST_TYPE VARCHAR(6),    
 @UDSYMBOL VARCHAR(15),    
 @UDEXPIRY_DATE VARCHAR(11),    
 @MODE VARCHAR(10),    
 @INTBROKFLAG INT    
)    
    
AS    
    
IF @MODE = 'POST'    
 BEGIN    
      
  DELETE FOSETTLEMENT WHERE SAUDA_DATE LIKE  @TRADEDATE + '%'     
   AND INST_TYPE LIKE 'FUT%'    
   AND AUCTIONPART ='CA'    
   AND CONTRACTNO = '0000000'     
   AND ORDER_NO = '000000000000000'     
      
  INSERT INTO FOSETTLEMENT    
      
  SELECT     
   CONTRACTNO = '0000000',     
   BILLNO = C_REGULAR_LOT,     
   TRADE_NO = '1',     
   PARTY_CODE ,    
   INST_TYPE = FOSCRIP2.INST_TYPE,     
   SYMBOL = FOSCRIP2.SYMBOL,     
   SEC_NAME = FOSCRIP2.SYMBOL,     
   EXPIRYDATE = FOSCRIP2.EXPIRYDATE,     
   STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE,     
   OPTION_TYPE = FOSCRIP2.OPTION_TYPE,    
   USER_ID = '1',     
   PRO_CLI = '1',    
   O_C_FLAG = 10,     
   C_U_FLAG = 'COVER',    
   TRADEQTY = DEL_POS ,     
   AUCTIONPART = 'CA',    
   MARKETTYPE = 1,    
   SERIES = 0,     
   ORDER_NO = '000000000000000',     
   SETTLEMENTPRICE,    
   SAUDA_DATE = TRADE_DATE,     
   TABLE_NO = DELIVERY_CLOSEPOS.TABLE_NO,     
   LINE_NO = DELIVERY_CLOSEPOS.LINE_NO,    
   VAL_PERC = DELIVERY_CLOSEPOS.VAL_PERC,    
   NORMAL = DELIVERY_CLOSEPOS.NORMAL,     
   DAY_PUC = DELIVERY_CLOSEPOS.DAY_PUC,     
   DAY_SALES = DELIVERY_CLOSEPOS.DAY_SALES,     
   SETT_PURCH = DELIVERY_CLOSEPOS.SETT_PURCH,     
   SETT_SALES = DELIVERY_CLOSEPOS.SETT_SALES,    
   SELL_BUY = SELL_BUY,    
   SETTFLAG = 4,    
   BROKAPPLIED = DELIVERY_CLOSEPOS.BROKAPPLIED,    
   NETRATE = DELIVERY_CLOSEPOS.NETRATE,    
   AMOUNT = SETTLEMENTPRICE * DEL_POS,    
   INS_CHRG = DELIVERY_CLOSEPOS.INS_CHRG,    
   TURN_TAX = DELIVERY_CLOSEPOS.TURN_TAX,    
   OTHER_CHRG = DELIVERY_CLOSEPOS.OTHER_CHRG,    
   SEBI_TAX = DELIVERY_CLOSEPOS.SEBI_TAX,    
   BROKER_CHRG = DELIVERY_CLOSEPOS.BROKER_CHRG,    
   SERVICE_TAX = DELIVERY_CLOSEPOS.SERVICE_TAX,    
   TRADE_AMOUNT = 0,    
   BILLFLAG = 1,    
   SETT_NO = 0,    
   NBROKAPP = 0,    
   NSERTAX = 0,    
   N_NETRATE = 0,    
   SETT_TYPE = 'F',    
   CL_RATE = SETTLEMENTPRICE,    
   PARTICIPANTCODE = '',    
   STATUS = 'E',    
   CPID = 0,    
   INSTRUMENT=DENOMINATOR,    
   BOOKTYPE=NUMERATOR,    
   BRANCH_ID = 1,    
   TMARK = 0,    
   SCHEME = 0,    
   DUMMY1 = 0,    
   DUMMY2 = 0,    
   RESERVED1 = 0,    
   RESERVED2 = 0    
  FROM    
          DELIVERY_CLOSEPOS, FOOWNER ,FOSCRIP2    
  WHERE    
          TRADE_DATE LIKE @TRADEDATE + '%'     
   AND DEL_POS > 0    
   AND DELIVERY_CLOSEPOS.INST_TYPE = FOSCRIP2.INST_TYPE    
   AND DELIVERY_CLOSEPOS.SYMBOL = FOSCRIP2.SYMBOL    
   AND CONVERT(VARCHAR,DELIVERY_CLOSEPOS.EXPIRY_DATE,103) = CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103)    
   AND FOSCRIP2.MATURITYDATE NOT LIKE @TRADEDATE + '%'    



       
  TRUNCATE TABLE DELIVERY_CLOSEPOS    
    
  RETURN    
 END    
ELSE IF @MODE = 'NEW'    
 BEGIN    
    
  DECLARE @@NET_POS NUMERIC(18,6)    
  SET @@NET_POS = 0    
      
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  SET NOCOUNT ON    
      
  TRUNCATE TABLE DELIVERY_CLOSEPOS      
      
  /*----------------------------------------------------------------------    
    FETCHING AVAILABLE DELIVERY MARKING POISIONS    
  ----------------------------------------------------------------------*/    
  INSERT INTO DELIVERY_CLOSEPOS    
  SELECT    
   PARTY_CODE,    
   REPORT_DATE,    
   INST_TYPE,    
    
   SYMBOL,    
   EXPIRY_DATE,    
   OPTION_TYPE,    
   STRIKE_PRICE,    
   OPEN_POS = 0,    
   TOTAL_ALLOCATED_QTY,    
   SELL_BUY = (CASE WHEN SELL_BUY = 'S' THEN 1 ELSE 2 END),    
   NET_POS  = 0,    
   0,    
   TABLE_NO = 0,    
   LINE_NO = 0,    
   VAL_PERC =0,    
   NORML = 0,    
   DAY_PUC = 0,    
   DAY_SALES = 0,    
   SETT_PURCH = 0,    
   SETT_SALES = 0,    
   BROKAPPLIED = 0,    
   SERVICE_TAX = 0,    
   NETRATE = 0,    
   INS_CHRG = 0,    
   TURN_TAX = 0 ,    
   OTHER_CHRG = 0,    
   SEBI_TAX = 0,    
   BROKER_CHRG =0,    
   PARTYFLAG = 0,  
   WAREHOUSE    
 FROM     
  DELIVERY_OBL_CLT     
 WHERE     
  REPORT_DATE LIKE @TRADEDATE +'%'    
     
 UPDATE DELIVERY_CLOSEPOS SET SETTLEMENTPRICE = ISNULL(DELNET.SETTLEMENTPRICE,0)     
 FROM     
 (     
  SELECT D.INST_TYPE,D.SYMBOL, EXPIRYDATE,      
  ABS(SUM(PAYOUT_VALUE) / SUM(PAYIN_QTY)*DENOMINATOR/NUMERATOR)  SETTLEMENTPRICE      
  FROM DELIVERY_OBL_NET D ,FOSCRIP2 F      
  WHERE D.INST_TYPE= F.INST_TYPE      
  AND D.SYMBOL= F.SYMBOL      
  AND D.EXPIRY_DATE = F.EXPIRYDATE      
  AND D.OPTION_TYPE = F.OPTION_TYPE      
  AND D.STRIKE_PRICE = F.STRIKE_PRICE      
  AND REPORT_DATE LIKE @TRADEDATE + '%'           
  AND PAYIN_QTY > 0    
  GROUP BY D.INST_TYPE,D.SYMBOL,EXPIRYDATE,NUMERATOR,DENOMINATOR      
 ) DELNET    
 WHERE    
  DELNET.INST_TYPE = DELIVERY_CLOSEPOS.INST_TYPE    
  AND DELNET.SYMBOL = DELIVERY_CLOSEPOS.SYMBOL    
  AND SELL_BUY = 1    
    
 UPDATE DELIVERY_CLOSEPOS SET SETTLEMENTPRICE = ISNULL(DELNET.SETTLEMENTPRICE,0)     
 FROM     
 (     
  SELECT D.INST_TYPE,D.SYMBOL, EXPIRYDATE,      
  ABS(SUM(PAYIN_VALUE) / SUM(PAYOUT_QTY)*DENOMINATOR/NUMERATOR)  SETTLEMENTPRICE      
  FROM DELIVERY_OBL_NET D ,FOSCRIP2 F    
  WHERE D.INST_TYPE= F.INST_TYPE      
  AND D.SYMBOL= F.SYMBOL      
  AND D.EXPIRY_DATE = F.EXPIRYDATE      
  AND D.OPTION_TYPE = F.OPTION_TYPE      
  AND D.STRIKE_PRICE = F.STRIKE_PRICE      
  AND REPORT_DATE LIKE @TRADEDATE + '%'           
  AND PAYOUT_QTY > 0    
  GROUP BY D.INST_TYPE,D.SYMBOL,EXPIRYDATE,NUMERATOR,DENOMINATOR      
 ) DELNET    
 WHERE    
  DELNET.INST_TYPE = DELIVERY_CLOSEPOS.INST_TYPE    
  AND DELNET.SYMBOL = DELIVERY_CLOSEPOS.SYMBOL    
  AND SELL_BUY = 2   
  
  
 UPDATE DELIVERY_CLOSEPOS SET NETRATE= SETTLEMENTPRICE    
  
 /*DO NOT DERIVE THE PRICE IF TRADED ON DELIVEY DAY FOR STAGGERED DELIVERY*/  
 /*UPDATE DELIVERY_CLOSEPOS SET SETTLEMENTPRICE = 0, NETRATE = 0  
 FROM  
 (  
 SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
 FROM FOSETTLEMENT (NOLOCK)   
 WHERE SAUDA_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'  
 AND AUCTIONPART =''  
 AND PRICE > 0  
 AND TRADEQTY > 0  
 AND EXPIRYDATE NOT LIKE @TRADEDATE + '%'  
 GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
 ) TRD  
 WHERE  
 DELIVERY_CLOSEPOS.PARTY_CODE = TRD.PARTY_CODE AND  
 DELIVERY_CLOSEPOS.INST_TYPE = TRD.INST_TYPE AND  
 DELIVERY_CLOSEPOS.SYMBOL = TRD.SYMBOL AND   
 DELIVERY_CLOSEPOS.EXPIRY_DATE = TRD.EXPIRYDATE AND  
 DELIVERY_CLOSEPOS.STRIKE_PRICE = TRD.STRIKE_PRICE AND  
 DELIVERY_CLOSEPOS.OPTION_TYPE = TRD.OPTION_TYPE  */
  
      
 END    
ELSE IF @MODE = 'UPDATE'    
   BEGIN    
 IF @UDINST_TYPE =''    
  BEGIN    
   /*----------------------------------------------------------------------    
      FULLY PARTY TRANSFER FOR THE SCRIPT    
   ----------------------------------------------------------------------*/    
   UPDATE    
    DELIVERY_CLOSEPOS    
     
   SET  PARTY_CODE = @NEWPARTY,    
    PARTYFLAG = 2,    
    OPEN_POS=0,    
    NET_POS=0    
   WHERE     
    PARTY_CODE = @OLDPARTY    
  END    
 ELSE IF @OLDDELPOS = @NEWDELPOS    
  BEGIN    
   /*----------------------------------------------------------------------    
      FULLY PARTY TRANSFER FOR THE SCRIPT    
   ----------------------------------------------------------------------*/    
   UPDATE    
    DELIVERY_CLOSEPOS    
     
   SET  PARTY_CODE = @NEWPARTY,    
    PARTYFLAG = 2,    
    OPEN_POS=0,    
    NET_POS=0    
   WHERE     
    PARTY_CODE = @OLDPARTY    
    AND INST_TYPE = @UDINST_TYPE    
    AND SYMBOL = @UDSYMBOL    
    AND EXPIRY_DATE LIKE @UDEXPIRY_DATE +'%'    
  END    
 ELSE    
  BEGIN    
      
   /*----------------------------------------------------------------------    
      PARTIAL PARTY TRANSFER     
   ----------------------------------------------------------------------*/    
    
   UPDATE    
    DELIVERY_CLOSEPOS    
     
   SET      
    DEL_POS = (DEL_POS - @NEWDELPOS),    
    PARTYFLAG = 2,    
    OPEN_POS=0,    
    NET_POS=0    
   WHERE     
    PARTY_CODE = @OLDPARTY    
    AND INST_TYPE = @UDINST_TYPE    
    AND SYMBOL = @UDSYMBOL    
    AND EXPIRY_DATE LIKE @UDEXPIRY_DATE +'%'    
    
    
   INSERT INTO DELIVERY_CLOSEPOS    
   SELECT  PARTY_CODE=@NEWPARTY,    
    TRADE_DATE,    
    INST_TYPE,    
    SYMBOL,    
    EXPIRY_DATE,    
    OPTION_TYPE,    
    STRIKE_PRICE,    
    OPEN_POS=0,    
    DEL_POS = @NEWDELPOS,    
    SELL_BUY,    
    NET_POS = 0,    
    SETTLEMENTPRICE,    
    TABLE_NO = 0,    
    LINE_NO = 0,    
    VAL_PERC =0,    
    NORML = 0,    
    DAY_PUC = 0,    
    DAY_SALES = 0,    
    SETT_PURCH = 0,    
    SETT_SALES = 0,    
    BROKAPPLIED = 0,    
    SERVICE_TAX = 0,    
    NETRATE = 0,    
    INS_CHRG = 0,    
    TURN_TAX = 0 ,    
    OTHER_CHRG = 0,    
    SEBI_TAX = 0,    
    BROKER_CHRG =0,    
 PARTYFLAG=2,  
 WAREHOUSE  
   FROM    
    DELIVERY_CLOSEPOS    
   WHERE     
    PARTY_CODE = @OLDPARTY    
    AND INST_TYPE = @UDINST_TYPE    
    AND SYMBOL = @UDSYMBOL    
    AND EXPIRY_DATE LIKE @UDEXPIRY_DATE +'%'    
   END    
 END    
    
    
/*-----------------------------------------------------------    
  CHECKING CLIENT VALIDITY    
  SETTING FLAG = 2 FOR BROK COMPUTATION    
-------------------------------------------------------------*/    
    
UPDATE    
 DELIVERY_CLOSEPOS     
SET    
 PARTYFLAG = 2    
FROM    
 CLIENT1, CLIENT2    
WHERE    
 DELIVERY_CLOSEPOS.PARTY_CODE = CLIENT2.PARTY_CODE    
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE    
 AND PARTYFLAG = 0    
   
 UPDATE DELIVERY_CLOSEPOS SET NETRATE= SETTLEMENTPRICE    
/*-----------------------------------------------------------   
  FETCHING BROKERAGE & CHARGES   
*/  
IF @INTBROKFLAG = 1  
BEGIN  
   UPDATE      
    DELIVERY_CLOSEPOS      
   SET        
    BROKAPPLIED= (CASE WHEN SELL_BUY = 1 THEN              
    ((FLOOR(( ((BROKTABLE.DAY_SALES * SETTLEMENTPRICE)/100) *      
    POWER(10,ROUND_TO)+ROFIG + ERRNUM ) /      
    (ROFIG + NOZERO )) * (ROFIG +NOZERO ) )  /      
    POWER(10,ROUND_TO))      
   ELSE      
    ((FLOOR(( ((BROKTABLE.DAY_PUC * SETTLEMENTPRICE)/100) *      
    POWER(10,ROUND_TO)+ROFIG + ERRNUM ) /      
    (ROFIG + NOZERO )) * (ROFIG +NOZERO ) )  /      
    POWER(10,ROUND_TO))      
   END),      
    SERVICE_TAX =   CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE      
   ((FLOOR ( (      
    (CASE WHEN SELL_BUY = 1 THEN      
   ((FLOOR(( ((BROKTABLE.DAY_SALES * SETTLEMENTPRICE)/100) *      
   POWER(10,ROUND_TO)+ROFIG + ERRNUM ) /      
   (ROFIG + NOZERO )) * (ROFIG +NOZERO ) )  /      
   POWER(10,ROUND_TO))      
     ELSE      
   ((FLOOR(( ((BROKTABLE.DAY_PUC * SETTLEMENTPRICE)/100) *      
   POWER(10,ROUND_TO)+ROFIG + ERRNUM ) /      
   (ROFIG + NOZERO )) * (ROFIG +NOZERO ) )  /      
   POWER(10,ROUND_TO))      
     END)  * DEL_POS *  FOGLOBALS.SERVICE_TAX / 100 *       
     POWER(10,ROUND_TO) +      
     ROFIG + ERRNUM  ) /  (ROFIG +       
     NOZERO)) * (ROFIG +      
     NOZERO) )  / POWER(10,ROUND_TO))      
    END ,            
    TABLE_NO = BROKTABLE.TABLE_NO,      
    DAY_SALES = BROKTABLE.DAY_SALES ,      
    DAY_PUC = BROKTABLE.DAY_PUC,      
    LINE_NO = BROKTABLE.LINE_NO,    
    VAL_PERC = BROKTABLE.VAL_PERC  
   FROM       
    BROKTABLE,CLIENT1,CLIENT2,FOGLOBALS      
   WHERE      
    CLIENT1.CL_CODE = CLIENT2.CL_CODE      
    AND CLIENT2.PARTY_CODE = DELIVERY_CLOSEPOS.PARTY_CODE      
    AND TRADE_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT       
    AND BROKTABLE.TABLE_NO = CLIENT2.BROK1_TABLENO      
    AND BROKTABLE.LINE_NO  =       
    (      
   SELECT MIN(LINE_NO) FROM BROKTABLE      
   WHERE      
   TABLE_NO = CLIENT2.BROK1_TABLENO      
   AND SETTLEMENTPRICE <= BROKTABLE.UPPER_LIM      
    )      
    AND PARTYFLAG = 2    
      
      
    UPDATE DELIVERY_CLOSEPOS   
    SET NETRATE = SETTLEMENTPRICE + CASE WHEN SELL_BUY = 1 THEN BROKAPPLIED ELSE - BROKAPPLIED END  
    WHERE PARTYFLAG = 2   
END    
    
/*----------------------------------------------------------------------    
   UPDATING OPEN POSTION    
----------------------------------------------------------------------*/    
UPDATE    
 DELIVERY_CLOSEPOS     
SET    
 OPEN_POS = NETPOS    
FROM    
(    
 SELECT    
  F.PARTY_CODE,    
  F.INST_TYPE,    
  F.SYMBOL,    
  F.EXPIRYDATE,    
  NETPOS = SUM(SQTY-PQTY)    
 FROM     
  FOBILLVALAN F, DELIVERY_CLOSEPOS FE    
 WHERE     
  F.SAUDA_DATE LIKE LEFT(FE.TRADE_DATE,11) + '%'    
  AND F.PARTY_CODE = FE.PARTY_CODE    
  AND F.INST_TYPE = FE.INST_TYPE    
  AND F.SYMBOL = FE.SYMBOL    
  AND F.EXPIRYDATE LIKE LEFT(FE.EXPIRY_DATE,11) + '%'    
  AND PARTYFLAG = 2     
 GROUP BY    
  F.PARTY_CODE,    
  F.INST_TYPE,    
  F.SYMBOL,    
  F.EXPIRYDATE    
) BILLPOS    
WHERE    
 BILLPOS.PARTY_CODE = DELIVERY_CLOSEPOS.PARTY_CODE    
 AND BILLPOS.INST_TYPE = DELIVERY_CLOSEPOS.INST_TYPE    
 AND BILLPOS.SYMBOL = DELIVERY_CLOSEPOS.SYMBOL    
 AND CONVERT(VARCHAR,BILLPOS.EXPIRYDATE,103) = CONVERT(VARCHAR,DELIVERY_CLOSEPOS.EXPIRY_DATE,103)    
 AND PARTYFLAG = 2     
    
    
    
/*---------------------------------------------------------------    
   UPATING NET POSTION    
---------------------------------------------------------------*/    
UPDATE  DELIVERY_CLOSEPOS     
 SET NET_POS = OPEN_POS + DEL_POS    
WHERE  TRADE_DATE LIKE @TRADEDATE + '%'    
 AND INST_TYPE LIKE @INST_TYPE + '%'    
 AND PARTYFLAG = 2     
    
    
/*-----------------------------------------------------------    
  CHECKING CLIENT VALIDITY    
-------------------------------------------------------------*/    
    
UPDATE    
 DELIVERY_CLOSEPOS     
SET    
 PARTYFLAG = 1    
FROM    
 CLIENT1, CLIENT2    
WHERE    
 DELIVERY_CLOSEPOS.PARTY_CODE = CLIENT2.PARTY_CODE    
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE    
    
/*-------------------------------------------------------------------    
  FETCHING FINAL OUTPUT    
----------------------------------------------------------------------*/    
SELECT    
 PARTY_CODE,    
 TRADE_DATE = LEFT(CONVERT(VARCHAR,TRADE_DATE,109),11),    
 INST_TYPE,    
 SYMBOL,     
 EXPIRY_DATE = CONVERT(VARCHAR,EXPIRY_DATE,103),    
 OPEN_POS,    
 DEL_POS,     
 SELL_BUY = (CASE WHEN SELL_BUY=1 THEN 'BUY' ELSE 'SELL' END),     
 NET_POS,    
 BROKTOT = BROKAPPLIED * DEL_POS,    
 CHARGESTOT = SERVICE_TAX+INS_CHRG+TURN_TAX+OTHER_CHRG+SEBI_TAX+BROKER_CHRG,    
 PARTYFLAG ,  
 WAREHOUSE,  
 SETTLEMENTPRICE,  
 SRNO  
FROM    
 DELIVERY_CLOSEPOS     
ORDER BY    
 SYMBOL, EXPIRY_DATE , WAREHOUSE, PARTY_CODE  
    
/*---------------------------------------------  END OF PROC ----------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_PrmDisc
-- --------------------------------------------------
CREATE PROC  DELIVERY_PRMDISC             
(            
 @@SETT_NO VARCHAR(12),            
 @@SETT_TYPE VARCHAR(3),            
 @@MODE VARCHAR(10)            
) AS            
                        
/*                        
  PROCEDURE FOR FETCHING DATA FOR PREMIUM DISCOUNT            
  AUTHOR : SINULAL                        
  DATE   : 13 JUN 05            
  MODIFICATION LOG :            
*/                      
            
DECLARE                     
 @ORGSETTTYPE    VARCHAR(3) ,            
 @ORGSETTNO    VARCHAR(12) ,            
 @PARTY_CODE VARCHAR(10),            
 @SYMBOL         VARCHAR(12),                
 @WAREHOUSE  VARCHAR(20),            
 @ISIN  VARCHAR(12),            
 @DRCR  CHAR(1),            
 @QTYCLT  NUMERIC (18,4),            
 @PAYINQTY NUMERIC (18,4),            
 @PAYOUTQTY NUMERIC (18,4),            
 @DELNETCUR  CURSOR ,               
 @DELCLTCUR  CURSOR             
            
IF @@MODE = 'NEW'            
BEGIN            
             
 /*-------------------------------------------------------------------------------------------------------            
   FETCHING POSTIONS FROM DELIVERY TRANSACTION ON BASIS OF SS04            
 -------------------------------------------------------------------------------------------------------*/            
 DELETE DELIVERY_CLOSEOUT_TEMP WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO            
 AND CLOSEOUT_TYPE IN ('D','P')            
             
 INSERT INTO DELIVERY_CLOSEOUT_TEMP             
 SELECT             
  '01/01/1900',@@SETT_TYPE,@@SETT_NO,SETT_TYPE,SETT_NO,PARTY_CODE,            
  INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,WAREHOUSE,ISIN,'D',          
 DRCR=(CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN QTY ELSE -QTY END) > 0 THEN 'C' ELSE 'D' END),          
 ABS(SUM(CASE WHEN DRCR = 'C' THEN QTY ELSE -QTY END)),0,0,'N',0             
 FROM DELIVERY_TRANSACTION              
 WHERE             
  PARTY_CODE NOT IN ('BROKER','EXE')            
  AND SETT_TYPE IN (SELECT D_SETT_TYPE FROM DELIVERY_OBL_CLOSEOUT_VIEW             
     WHERE DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_TRANSACTION.SETT_NO)            
  AND ISIN IN (SELECT D_ISIN FROM DELIVERY_OBL_CLOSEOUT_VIEW             
     WHERE DELIVERY_OBL_CLOSEOUT_VIEW.SETT_TYPE = @@SETT_TYPE AND DELIVERY_OBL_CLOSEOUT_VIEW.SETT_NO = @@SETT_NO AND DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_TYPE = DELIVERY_TRANSACTION.SETT_TYPE            
     AND DELIVERY_OBL_CLOSEOUT_VIEW.D_SETT_NO = DELIVERY_TRANSACTION.SETT_NO)            
  AND ACTIVE = 1            
  AND TRTYPE <> 906           
 GROUP BY             
  SETT_TYPE,SETT_NO,PARTY_CODE,            
  INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,WAREHOUSE,ISIN          
  HAVING SUM(CASE WHEN DRCR = 'C' THEN QTY ELSE -QTY END) <> 0           
           
 UPDATE             
   DELIVERY_CLOSEOUT_TEMP             
 SET             
 PRICE = C.PRICE*C.MARKUP/100,            
 PAYIN_QTY = (CASE WHEN DRCR = 'C' THEN C.PAYIN_QTY ELSE 0 END),            
 PAYOUT_QTY =  (CASE WHEN DRCR = 'D' THEN C.PAYOUT_QTY ELSE 0 END),             
 CLOSEOUT_TYPE = C.CLOSE_TYPE,            
 REPORTDATE = C.REPORT_DATE            
 FROM            
 (        
 SELECT         
  SYMBOL,WAREHOUSE,CLOSE_TYPE,D_ISIN,D_SETT_TYPE,D_SETT_NO,          
  MARKUP,PRICE,PAYOUT_QTY=SUM(PAYOUT_QTY),PAYIN_QTY=SUM(PAYIN_QTY),          
  SETT_TYPE,SETT_NO,REPORT_DATE          
 FROM             
  DELIVERY_OBL_CLOSEOUT_VIEW          
 WHERE         
  SETT_TYPE =@@SETT_TYPE           
  AND SETT_NO = @@SETT_NO           
 GROUP BY         
  SYMBOL,WAREHOUSE,CLOSE_TYPE,D_ISIN,D_SETT_TYPE,D_SETT_NO,          
  MARKUP,PRICE,SETT_TYPE,SETT_NO,REPORT_DATE          
 ) C            
 WHERE            
 C.SYMBOL = DELIVERY_CLOSEOUT_TEMP.SYMBOL            
 AND C.WAREHOUSE = DELIVERY_CLOSEOUT_TEMP.WAREHOUSE            
 AND C.CLOSE_TYPE IN ('D','P')  
 AND CLOSEOUT_TYPE IN ('D','P')            
 AND C.D_ISIN = DELIVERY_CLOSEOUT_TEMP.ISIN            
 AND DELIVERY_CLOSEOUT_TEMP.D_SETT_TYPE = C.D_SETT_TYPE            
 AND DELIVERY_CLOSEOUT_TEMP.D_SETT_NO = C.D_SETT_NO            
 AND C.SETT_TYPE =@@SETT_TYPE AND C.SETT_NO = @@SETT_NO             
  
        
 UPDATE             
   DELIVERY_CLOSEOUT_TEMP             
 SET             
 PRICE = ABS((CASE WHEN DRCR ='D' THEN CASE WHEN CLOSE_TYPE ='D' and C.PAYIN_VALUE > 0 THEN C.PAYIN_VALUE  ELSE C.PAYOUT_VALUE END / CASE WHEN c.PAYIN_QTY > 0 THEN C.PAYIN_QTY  ELSE C.PAYOUT_QTY END    
    ELSE  CASE WHEN CLOSE_TYPE ='D' and C.PAYIN_VALUE > 0 THEN C.PAYIN_VALUE  ELSE C.PAYOUT_VALUE END / CASE WHEN c.PAYIN_QTY > 0 THEN C.PAYIN_QTY  ELSE C.PAYOUT_QTY END END) / NUMERATOR * DENOMINATOR),      

 PAYIN_QTY = (CASE WHEN DRCR = 'C' THEN CASE WHEN CLOSE_TYPE ='D' THEN C.PAYIN_QTY  ELSE C.PAYOUT_QTY END ELSE 0 END),            
 PAYOUT_QTY =  (CASE WHEN DRCR = 'D' THEN CASE WHEN CLOSE_TYPE ='P' THEN C.PAYIN_QTY  ELSE C.PAYOUT_QTY END ELSE 0 END),             
 CLOSEOUT_TYPE = C.CLOSE_TYPE,            
 REPORTDATE = C.REPORT_DATE            
 FROM            
 (        
 SELECT         
  SYMBOL,WAREHOUSE,CLOSE_TYPE,D_ISIN,D_SETT_TYPE,D_SETT_NO,          
  MARKUP,PRICE,PAYOUT_QTY=SUM(PAYOUT_QTY),PAYIN_QTY=SUM(PAYIN_QTY),          
  SETT_TYPE,SETT_NO,REPORT_DATE  , PAYIN_VALUE = abs(SUM(PAYIN_VALUE)),        
  PAYOUT_VALUE = abs(SUM(PAYOUT_VALUE))        
 FROM             
  DELIVERY_OBL_CLOSEOUT_VIEW          
 WHERE         
  SETT_TYPE =@@SETT_TYPE           
  AND SETT_NO = @@SETT_NO         
  AND MARKUP = 0         
  AND (ABS(PAYIN_VALUE) + ABS(PAYOUT_VALUE)) <> 0          
 GROUP BY         
  SYMBOL,WAREHOUSE,CLOSE_TYPE,D_ISIN,D_SETT_TYPE,D_SETT_NO,          
  MARKUP,PRICE,SETT_TYPE,SETT_NO,REPORT_DATE          
 ) C ,        
        
(        
   SELECT SYMBOL,NUMERATOR,DENOMINATOR FROM FOSCRIP2 (NOLOCK)        
   WHERE SYMBOL IN (SELECT SYMBOL FROM DELIVERY_OBL_CLOSEOUT_VIEW        
    WHERE SETT_TYPE =@@SETT_TYPE           
    AND SETT_NO = @@SETT_NO          
    AND MARKUP = 0 AND (ABS(PAYIN_VALUE) + ABS(PAYOUT_VALUE)) <> 0 )        
)   F        
 WHERE            
 C.SYMBOL = DELIVERY_CLOSEOUT_TEMP.SYMBOL            
 AND C.WAREHOUSE = DELIVERY_CLOSEOUT_TEMP.WAREHOUSE            
 AND C.CLOSE_TYPE IN ('D','P')            
 AND CLOSEOUT_TYPE IN ('D','P')            
 AND C.D_ISIN = DELIVERY_CLOSEOUT_TEMP.ISIN            
 AND DELIVERY_CLOSEOUT_TEMP.D_SETT_TYPE = C.D_SETT_TYPE            
 AND DELIVERY_CLOSEOUT_TEMP.D_SETT_NO = C.D_SETT_NO            
 AND C.SETT_TYPE =@@SETT_TYPE AND C.SETT_NO = @@SETT_NO          
 AND F.SYMBOL = C.SYMBOL        
  
        
        
        
 SET @DELNETCUR = CURSOR FOR                
 SELECT D_SETT_TYPE,D_SETT_NO,SYMBOL,WAREHOUSE,ISIN,PAYIN_QTY=SUM(PAYIN_QTY),PAYOUT_QTY=SUM(PAYOUT_QTY) FROM            
 DELIVERY_CLOSEOUT_TEMP            
 WHERE CLOSEOUT_TYPE IN ('D','P')            
 AND SETT_TYPE =@@SETT_TYPE             
 AND SETT_NO = @@SETT_NO             
 AND PRICE > 0            
 GROUP BY D_SETT_TYPE,D_SETT_NO,SYMBOL,WAREHOUSE,ISIN        
             
 OPEN @DELNETCUR                
                 
 FETCH NEXT FROM @DELNETCUR INTO @ORGSETTTYPE,@ORGSETTNO,@SYMBOL,@WAREHOUSE,@ISIN,@PAYINQTY,@PAYOUTQTY            
 WHILE @@FETCH_STATUS = 0                 
 BEGIN                
             
  SET @DELCLTCUR = CURSOR FOR            
  SELECT PARTY_CODE,DRCR,QTY_CLT FROM            
  DELIVERY_CLOSEOUT_TEMP WHERE SYMBOL = @SYMBOL AND WAREHOUSE = @WAREHOUSE AND ISIN = @ISIN            
  AND CLOSEOUT_TYPE IN ('D','P')            
  AND SETT_TYPE =@@SETT_TYPE AND SETT_NO = @@SETT_NO            
  AND D_SETT_TYPE =@ORGSETTTYPE AND D_SETT_NO = @ORGSETTNO           
             
  OPEN @DELCLTCUR                
             
  FETCH NEXT FROM @DELCLTCUR INTO @PARTY_CODE,@DRCR,@QTYCLT 
  WHILE @@FETCH_STATUS = 0                 
  BEGIN   
    IF @DRCR = 'C'            
     BEGIN           
      IF @PAYINQTY - @QTYCLT >= 0            
       BEGIN            
        SET @PAYINQTY = @PAYINQTY - @QTYCLT            
        UPDATE DELIVERY_CLOSEOUT_TEMP SET PAYIN_QTY  = @QTYCLT, CLOSEOUT_FLAG = 'Y'            
        WHERE PARTY_CODE = @PARTY_CODE AND SYMBOL=@SYMBOL AND WAREHOUSE=@WAREHOUSE              
        AND ISIN =@ISIN AND DRCR=@DRCR AND QTY_CLT= @QTYCLT            
        AND CLOSEOUT_TYPE IN ('D','P')            
        AND SETT_TYPE =@@SETT_TYPE            
        AND SETT_NO = @@SETT_NO             
        AND D_SETT_TYPE =@ORGSETTTYPE            
AND D_SETT_NO = @ORGSETTNO             
       END   
 ELSE          
 BEGIN                  
        UPDATE DELIVERY_CLOSEOUT_TEMP SET PAYIN_QTY  = @PAYINQTY, CLOSEOUT_FLAG = 'Y'            
        WHERE PARTY_CODE = @PARTY_CODE AND SYMBOL=@SYMBOL AND WAREHOUSE=@WAREHOUSE              
        AND ISIN =@ISIN AND DRCR=@DRCR AND QTY_CLT= @QTYCLT            
        AND CLOSEOUT_TYPE IN ('D','P')            
        AND SETT_TYPE =@@SETT_TYPE            
        AND SETT_NO = @@SETT_NO             
        AND D_SETT_TYPE =@ORGSETTTYPE            
        AND D_SETT_NO = @ORGSETTNO             
 SET @PAYINQTY = 0           
 END          
     END            
    ELSE                
     BEGIN            
      IF @PAYOUTQTY - @QTYCLT >= 0            
       BEGIN            
        SET @PAYOUTQTY = @PAYOUTQTY - @QTYCLT            
        UPDATE DELIVERY_CLOSEOUT_TEMP SET PAYOUT_QTY  = @QTYCLT, CLOSEOUT_FLAG = 'Y'            
        WHERE PARTY_CODE = @PARTY_CODE AND SYMBOL=@SYMBOL AND WAREHOUSE=@WAREHOUSE              
        AND ISIN =@ISIN AND DRCR=@DRCR AND QTY_CLT= @QTYCLT            
        AND CLOSEOUT_TYPE IN ('D','P')            
        AND SETT_TYPE =@@SETT_TYPE            
        AND SETT_NO = @@SETT_NO             
        AND D_SETT_TYPE =@ORGSETTTYPE            
 AND D_SETT_NO = @ORGSETTNO             
END            
 ELSE          
       BEGIN            
        UPDATE DELIVERY_CLOSEOUT_TEMP SET PAYOUT_QTY  = @PAYOUTQTY, CLOSEOUT_FLAG = 'Y'            
        WHERE PARTY_CODE = @PARTY_CODE AND SYMBOL=@SYMBOL AND WAREHOUSE=@WAREHOUSE              
        AND ISIN =@ISIN AND DRCR=@DRCR AND QTY_CLT= @QTYCLT            
        AND CLOSEOUT_TYPE IN ('D','P')            
        AND SETT_TYPE =@@SETT_TYPE            
        AND SETT_NO = @@SETT_NO             
        AND D_SETT_TYPE =@ORGSETTTYPE            
        AND D_SETT_NO = @ORGSETTNO             
        SET @PAYOUTQTY = 0          
       END             
     END              
   FETCH NEXT FROM @DELCLTCUR INTO @PARTY_CODE,@DRCR,@QTYCLT            
   END            
  CLOSE @DELCLTCUR            
  DEALLOCATE @DELCLTCUR             
             
  FETCH NEXT FROM @DELNETCUR INTO @ORGSETTTYPE,@ORGSETTNO,@SYMBOL,@WAREHOUSE,@ISIN,@PAYINQTY,@PAYOUTQTY            
 END                
 CLOSE @DELNETCUR                
 DEALLOCATE @DELNETCUR                
 /*            
 UPDATE            
  DELIVERY_CLOSEOUT_TEMP             
 SET             
  PAYIN_QTY = C.PAYIN_QTY,            
  PAYOUT_QTY =  C.PAYOUT_QTY             
 FROM  DELIVERY_OBL_CLOSEOUT_VIEW C            
 WHERE            
 C.SYMBOL = DELIVERY_CLOSEOUT_TEMP.SYMBOL            
 AND C.WAREHOUSE = DELIVERY_CLOSEOUT_TEMP.WAREHOUSE            
 AND C.D_ISIN = DELIVERY_CLOSEOUT_TEMP.ISIN            
 AND C.CLOSE_TYPE IN ('D','P')            
 AND C.SETT_TYPE = @@SETT_TYPE             
 AND C.SETT_NO = @@SETT_NO             
   */          
END            
ELSE IF @@MODE = 'FETCH'            
BEGIN            
 SELECT INTSRNO,PARTY_CODE,SYMBOL,WAREHOUSE,ISIN,            
 CASE WHEN CLOSEOUT_TYPE='D' THEN 'DISCOUNT'            
    ELSE            
     CASE WHEN CLOSEOUT_TYPE='P' THEN 'PREMIUM'             
 ELSE        
        ''        
   END 
    END CLOSE_TYPE,            
CASE WHEN DRCR ='C' THEN            
   'PAYIN'             
   ELSE            
'PAYOUT'            
   END SELLBUY,QTY_CLT QTY,            
 CLOSEOUT_FLAG ,PRICE, D_SETT_TYPE,D_SETT_NO            
 FROM DELIVERY_CLOSEOUT_TEMP             
 WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO            
  AND CLOSEOUT_TYPE IN ('D','P')            
 -- AND PRICE > 0            
 ORDER BY D_SETT_TYPE,D_SETT_NO,SYMBOL,WAREHOUSE,ISIN,CLOSEOUT_TYPE,CLOSEOUT_FLAG DESC,PARTY_CODE            
END            
ELSE IF @@MODE = 'UPDATE'            
BEGIN            
 DELETE DELIVERY_OBL_CLT WHERE  SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DEL_REC_NO = '99999'            
            
 DELETE DELIVERY_OBL_NET WHERE  SETT_NO = @@SETT_NO AND SETT_TYPE = @@SETT_TYPE AND DEL_REC_NO = '99999'            
            
 DELETE DELIVERY_TRANSACTION WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO  AND FILLER1 ='P'            
            
            
 INSERT INTO DELIVERY_OBL_CLT            
 SELECT             
  REPORTDATE,REPORTDATE,MEMBERCODE,SETT_TYPE,SETT_NO,            
  INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,            
  OPTION_TYPE,0 CRA_LEVEL,WAREHOUSE,MEMBERCODE,ISIN MEMBER_AC_TYPE,PARTY_CODE,            
              
  SELL_BUY = CASE WHEN T.CLOSEOUT_TYPE ='D' THEN            
    CASE WHEN DRCR = 'C' THEN 'B' ELSE 'S' END            
   ELSE            
    CASE WHEN DRCR = 'C' THEN 'S' ELSE 'B' END            
   END ,            
  PAYIN_QTY+PAYOUT_QTY, 0 ,PAYIN_QTY+PAYOUT_QTY,'Y',PAYIN_QTY+PAYOUT_QTY,0,99999            
 FROM  DELIVERY_CLOSEOUT_TEMP T, FOOWNER            
 WHERE             
  SETT_TYPE = @@SETT_TYPE            
  AND SETT_NO = @@SETT_NO            
  AND ABS(PAYIN_QTY)+ABS(PAYOUT_QTY) <> 0           
  AND CLOSEOUT_TYPE IN ('D','P')            
            
            
 INSERT INTO  DELIVERY_OBL_NET            
 SELECT 99999,REPORTDATE,SETT_TYPE,SETT_NO,T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,            
 WAREHOUSE,            
 SUM(CASE WHEN CLOSEOUT_TYPE ='D' AND  DRCR = 'C'        
     THEN            
       (PAYIN_QTY + PAYOUT_QTY)  
     ELSE            
      CASE WHEN CLOSEOUT_TYPE ='P' AND  DRCR = 'D'             
     THEN            
      (PAYIN_QTY + PAYOUT_QTY)  
     ELSE            
      0            
     END            
     END) PAYIN_QTY,            
 SUM(CASE WHEN CLOSEOUT_TYPE ='P' AND  DRCR = 'C'             
     THEN            
       (PAYIN_QTY + PAYOUT_QTY)  
     ELSE            
      CASE WHEN CLOSEOUT_TYPE ='D' AND  DRCR = 'D'             
     THEN            
      (PAYIN_QTY + PAYOUT_QTY)  
     ELSE            
      0            
     END            
     END) PAYOUT_QTY,            
 SUM(CASE WHEN CLOSEOUT_TYPE ='D' AND  DRCR = 'C'             
     THEN            
       (PAYIN_QTY + PAYOUT_QTY) * PRICE * NUMERATOR / DENOMINATOR          
     ELSE            
      CASE WHEN CLOSEOUT_TYPE ='P' AND  DRCR = 'D'             
      THEN            
       (PAYIN_QTY + PAYOUT_QTY) * PRICE * NUMERATOR / DENOMINATOR          
      ELSE            
       0            
      END            
     END) PAYIN_VALUE,            
 SUM(CASE WHEN T.CLOSEOUT_TYPE ='P' AND  DRCR = 'C'             
     THEN            
       (PAYIN_QTY + PAYOUT_QTY) * PRICE * NUMERATOR / DENOMINATOR          
     ELSE            
      CASE WHEN CLOSEOUT_TYPE ='D' AND  DRCR = 'D'             
      THEN            
       (PAYIN_QTY + PAYOUT_QTY) * PRICE * NUMERATOR / DENOMINATOR          
      ELSE            
       0            
      END            
     END) PAYOUT_VALUE,            
 ISIN            
 FROM DELIVERY_CLOSEOUT_TEMP T , FOSCRIP2 F            
 WHERE             
  T.INST_TYPE = F.INST_TYPE            
  AND T.SYMBOL = F.SYMBOL            
  AND CONVERT(VARCHAR,T.EXPIRY_DATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)            
  AND T.OPTION_TYPE = F.OPTION_TYPE           
  AND T.STRIKE_PRICE = F.STRIKE_PRICE            
  AND T.SETT_TYPE =@@SETT_TYPE             
  AND T.SETT_NO = @@SETT_NO            
  AND ABS(PAYIN_QTY)+ABS(PAYOUT_QTY) <> 0
  AND T.CLOSEOUT_TYPE IN ('D','P')            
 GROUP BY             
  T.REPORTDATE,T.SETT_TYPE,T.SETT_NO,            
  T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,            
  T.WAREHOUSE,T.ISIN            
            
            
 INSERT INTO DELIVERY_TRANSACTION            
 SELECT             
  T.SETT_NO,T.SETT_TYPE,(SELECT ISNULL(MAX(REFNO),1) REFNO  FROM DELIVERY_DELCODE) REFNO,1 TCODE, 904 TRTYPE,            
  T.PARTY_CODE,T.INST_TYPE,T.SYMBOL,T.EXPIRY_DATE,T.STRIKE_PRICE,T.OPTION_TYPE,            
  PAYIN_QTY+PAYOUT_QTY,0 TRANSNO,1 FROMNO,'' TONO, T.ISIN,'' FOLIONO,'' HOLDERNAME,            
  CASE WHEN CLOSEOUT_TYPE ='D' THEN 'PREMIUM @ ' ELSE 'DISCOUNT @ ' END + CONVERT(VARCHAR,PRICE)  REASON,            
  DRCR,0 DELIVERED, PAYIN_QTY+PAYOUT_QTY ORGQTY, '' DPTYPE, '' DPID, '' CLTDPID,             
  C1.BRANCH_CD, '' PARTIPANTCODE, '' COUNTERPARTY, T.WAREHOUSE, 0 SLIPNO,            
  ''BATCHNO, '' ISETT_NO, '' ISETT_TYPE,            
  CASE WHEN CLOSEOUT_TYPE ='D' THEN 'PREMIUM' ELSE 'DISCOUNT' END SHARETYPE,            
  REPORTDATE TRANSDATE, '' BDPTYPE, '' BDPID, '' BCLTDPID, 1 ACTIVE, 'P' FILLER1,            
  '' FILLER2,'' FILLER3, '' FILLER4, '' FILLER5             
 FROM            
  DELIVERY_CLOSEOUT_TEMP T, CLIENT1 C1, CLIENT2 C2             
 WHERE             
  T.PARTY_CODE = C2.PARTY_CODE            
  AND C1.CL_CODE = C2.CL_CODE            
  AND T.SETT_TYPE = @@SETT_TYPE            
  AND T.SETT_NO = @@SETT_NO            
  AND T.CLOSEOUT_TYPE IN ('D','P')            
  AND ABS(PAYIN_QTY)+ABS(PAYOUT_QTY) <> 0
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_ReAllocate
-- --------------------------------------------------
CREATE Proc [dbo].[Delivery_ReAllocate] (@SettType Varchar(3),@SettNo Varchar(10))
As

Update
	 Delivery_Transaction 
Set
	Party_Code ='BROKER',
	TrType ='904',
	DPId ='',
	CltDpId = ''
where 
	Sett_No = @SettNo
	And Sett_Type = @SettType
	And DrCr = 'D'
	And Active = 1


/*Exchange Allocation*/

Exec Delivery_InsNCDXDelCursor @SettNo , @SettType , 1



/*Client Allication*/

Exec Delivery_InsNCDXCltDelWise @SettNo, @SettType , 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_branchDelGet
-- --------------------------------------------------
CREATE      PROCEDURE [dbo].[Delivery_rpt_branchDelGet]  
  
@dematid varchar(2),  
@settno varchar(7),  
@settype varchar(3),  
@branch varchar(15)  
  
AS  

select sett_no,sett_type,contract,warehouse,inst_type,symbol,expiry_date,getfromncx=sum(getfromncx),
givenncx=sum(givenncx),RecievedNcx=sum(RecievedNcx),branch 
from
(  
select   d.sett_no,d.sett_type, d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,      
  d.WareHouse,d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,GetFromNcx=d.Total_Allocated_Qty,  
  givenNcx= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),  
  RecievedNcx=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0), Branch=C1.Branch_Cd  
  from Client1 C1,Client2 C2,Delivery_Obl_Clt d Left Outer Join DELIVERY_TRANSACTION DT  
  On (DT.sett_no = d.sett_no and Dt.sett_type = d.sett_type  
  And active = 1 and Dt.Inst_type = d.inst_type  and d.WareHouse=Dt.WareHouse 
  and Dt.symbol = d.symbol and left(Dt.expiry_date,11) like  left(d.expiry_date,11) + '%' 
and dt.party_code = d.party_code)
     
  where c2.cl_code = c1.cl_code  
 and d.party_code = c2.party_code 
  and d.sett_no = @settno and d.sett_type = @settype and c1.branch_cd like ltrim(@branch)+'%'    
  and sell_buy = 'S'
  group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.Total_Allocated_Qty ,C1.Branch_Cd,
   d.WareHouse
)  sett

Group by sett_no,sett_type,contract,warehouse,inst_type,symbol,expiry_date,branch

Order By symbol,warehouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_branchDelGive
-- --------------------------------------------------
CREATE      PROCEDURE [dbo].[Delivery_rpt_branchDelGive]    
    
@settno varchar(7),    
@settype varchar(3),    
@branch varchar(15)    
    
AS    
    

select sett_no,sett_type,contract,warehouse,inst_type,symbol,expiry_date,GiveNCDX=sum(GiveNCDX),
givenNCDX=sum(givenNCDX),RecievedNCDX=sum(RecievedNCDX),branch 
from
( 
select   d.sett_no,d.sett_type, d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,  
  d.WareHouse,d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,GiveNCDX=d.Total_Allocated_Qty,    
  givenNCDX= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),    
  RecievedNCDX=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0), Branch=C1.Branch_Cd    
  from Client1 C1,Client2 C2,Delivery_Obl_Clt d Left Outer Join DELIVERY_TRANSACTION DT    
  On (DT.sett_no = d.sett_no and Dt.sett_type = d.sett_type   
  And active = 1 and Dt.Inst_type = d.inst_type   and Dt.WareHouse = d.WareHouse         
  and Dt.symbol = d.symbol and left(Dt.expiry_date,11) like left(d.expiry_date,11) + '%'
and dt.party_code = d.party_code)    
       
  where c2.cl_code = c1.cl_code    
  and d.Party_code = c2.Party_code  
  and d.sett_no = @settno and d.sett_type = @settype and c1.branch_cd like ltrim(@branch)+'%'      
  and sell_buy ='B'
  group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.Total_Allocated_Qty ,C1.Branch_Cd,  
  d.WareHouse
   ) sett

Group by sett_no,sett_type,contract,warehouse,inst_type,symbol,expiry_date,branch

Order By symbol,warehouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_branchDelScripClients
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[Delivery_rpt_branchDelScripClients]  
  
@dematid varchar(2),  
@settno varchar(7),  
@settype varchar(3),  
@branch varchar(15),  
@symbol varchar(11),  
@insttype varchar(12),  
@expirydate varchar(11),
@WareHouse varchar(20)  
  
AS  
  
select   d.sett_no,d.sett_type, d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,      
  d.Inst_Type,d.Symbol,convert(varchar(11),d.Expiry_Date,9) Expiry_Date, d.Total_Allocated_Qty Qty,
  Case when Sell_Buy ='S' then 'D' else 'C' end DrCr,d.party_code,  
  GivenQty= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),  
  RecQty=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0), Branch=C1.Branch_Cd  
  from Client1 C1,Client2 C2,Delivery_Obl_Clt d Left Outer Join DELIVERY_TRANSACTION DT  
  On (DT.sett_no = d.sett_no and Dt.sett_type = d.sett_type 
  And active = 1 and Dt.Inst_type = d.inst_type  and d.WareHouse = Dt.WareHouse
  and Dt.symbol = d.symbol and left(Dt.expiry_date,11) like left(d.expiry_date,11) + '%')
  where c2.cl_code = c1.cl_code  
  and d.sett_no = @settno 
  and d.sett_type like @settype + '%'   
  and c1.branch_cd like ltrim(@branch)+'%' 
  and d.inst_type = @insttype 
  and d.symbol=@symbol  
  and  left(d.expiry_date,11) = @expirydate  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.Total_Allocated_Qty ,C1.Branch_Cd ,d.Sell_Buy,
  d.party_code    
  Order By d.sett_no,d.sett_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_DATALIST
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[DELIVERY_RPT_DATALIST]
(
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@SETT_NO VARCHAR(7),      
	@SETT_TYPE VARCHAR(2),
	@PARTYCODE VARCHAR(10),
	@LISTFOR VARCHAR(10) -- PARTY / SCRIP

)

AS

IF @LISTFOR ='PARTY'
BEGIN
	SELECT 
		DISTINCT D.PARTY_CODE,C1.SHORT_NAME 
	FROM 
		DELIVERY_OBL_CLT D (NOLOCK),CLIENT1 C1 (NOLOCK),CLIENT2 C2 (NOLOCK)         
	WHERE 
		D.PARTY_CODE = C2.PARTY_CODE 
		AND C1.CL_CODE = C2.CL_CODE         
		AND D.SETT_NO = @SETT_NO 
		AND D.SETT_TYPE = @SETT_TYPE 
	        AND @STATUSNAME = (       
	        CASE       
	                WHEN @STATUSID = 'BRANCH'       
	                THEN C1.BRANCH_CD       
	                WHEN @STATUSID = 'SUBBROKER'       
	                THEN C1.SUB_BROKER       
	                WHEN @STATUSID = 'TRADER'       
	                THEN C1.TRADER       
	                WHEN @STATUSID = 'FAMILY'       
	                THEN C1.FAMILY       
	                WHEN @STATUSID = 'AREA'       
	                THEN C1.AREA       
	                WHEN @STATUSID = 'REGION'       
	                THEN C1.REGION       
	                WHEN @STATUSID = 'CLIENT'       
	  		THEN C2.PARTY_CODE       
	                ELSE 'BROKER' END)   
	ORDER BY C1.SHORT_NAME    
END 
ELSE
BEGIN
	IF @PARTYCODE<>''
	BEGIN

		SELECT 
			DISTINCT D.SYMBOL,D.WAREHOUSE 
		FROM 
			DELIVERY_OBL_CLT D (NOLOCK),CLIENT1 C1 (NOLOCK),CLIENT2 C2 (NOLOCK)         
		WHERE 
			D.PARTY_CODE = C2.PARTY_CODE 
			AND C1.CL_CODE = C2.CL_CODE         
			AND D.PARTY_CODE = @PARTYCODE 
		        AND @STATUSNAME = (       
		        CASE       
		                WHEN @STATUSID = 'BRANCH'       
		                THEN C1.BRANCH_CD       
		                WHEN @STATUSID = 'SUBBROKER'       
		                THEN C1.SUB_BROKER       
		                WHEN @STATUSID = 'TRADER'       
		                THEN C1.TRADER       
		                WHEN @STATUSID = 'FAMILY'       
		                THEN C1.FAMILY       
		                WHEN @STATUSID = 'AREA'       
		                THEN C1.AREA       
		                WHEN @STATUSID = 'REGION'       
		                THEN C1.REGION       
		                WHEN @STATUSID = 'CLIENT'       
		  		THEN C2.PARTY_CODE       
		                ELSE 'BROKER' END)   
		ORDER BY 1,2
	END 
	ELSE
	BEGIN
	print 'gg'
		SELECT 
			DISTINCT D.SYMBOL,D.WAREHOUSE 
		FROM 
			DELIVERY_OBL_CLT D (NOLOCK)     
		WHERE 
			SETT_TYPE = @SETT_TYPE	
			AND SETT_NO = @SETT_NO
		ORDER BY 1,2
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_DELCERTINFO
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[DELIVERY_RPT_DELCERTINFO] 
(   
	@TARGETID VARCHAR(2),    
	@SETTNO VARCHAR(7),    
	@SETTYPE VARCHAR(3),    
	@PARTYCODE VARCHAR(20),    
	@SYMBOL VARCHAR(12),    
	@WAREHOUSE VARCHAR(20)  
)
AS    
    
IF @TARGETID = 1    
    
BEGIN    
	SELECT SETT_NO,SETT_TYPE,PARTY_CODE,QTY,TRANSDATE,HOLDERNAME,FOLIONO,TRTYPE,REASON,    
	CLTDPID,DPID,DPTYPE,DELIVERED,ISETT_NO,ISETT_TYPE,BDPID,BCLTDPID,FOLIONO,TRANSNO,ISIN    
	FROM DELIVERY_TRANSACTION (NOLOCK) WHERE SETT_NO = @SETTNO AND SETT_TYPE = @SETTYPE    
	AND SYMBOL = @SYMBOL     
	AND WAREHOUSE = @WAREHOUSE  
	AND DRCR = 'C'     
	AND PARTY_CODE = @PARTYCODE AND ACTIVE = 1     
END    
    
IF @TARGETID = 2    
    
BEGIN    
	SELECT SETT_NO,SETT_TYPE,PARTY_CODE,QTY,TRANSDATE,HOLDERNAME,FOLIONO,TRTYPE,REASON,    
	CLTDPID,DPID,DPTYPE,DELIVERED,ISETT_NO,ISETT_TYPE,BDPID,BCLTDPID,FOLIONO,TRANSNO,ISIN    
	FROM DELIVERY_TRANSACTION (NOLOCK) WHERE SETT_NO = @SETTNO AND SETT_TYPE = @SETTYPE    
	AND SYMBOL = @SYMBOL     
	AND WAREHOUSE = @WAREHOUSE  
	AND DRCR = 'D'     
	AND PARTY_CODE = @PARTYCODE AND ACTIVE = 1     
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_MISSING
-- --------------------------------------------------
CREATE PROC [dbo].[DELIVERY_RPT_MISSING]
(
	@STATUSID	VARCHAR(25),
	@STATUSNAME	VARCHAR(50),
	@SETT_NO	VARCHAR(7),
	@SETT_TYPE	VARCHAR(2)
)
AS

SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE=CONVERT(VARCHAR,EXPIRY_DATE,103),STRIKE_PRICE,OPTION_TYPE,WAREHOUSE,ISIN,
QTY,TRDATE=CONVERT(VARCHAR,TRDATE,103), CLTACCNO, DPID,TRANSNO,BDPID,BCLTACCNO
FROM DELIVERY_DEMAT_TRANS (NOLOCK)
WHERE SETT_NO = @SETT_NO 
AND	  SETT_TYPE = @SETT_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDX_DelCertinfo
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[Delivery_rpt_NCDX_DelCertinfo]  
@targetid varchar(2),  
@settno varchar(7),  
@settype varchar(3),  
@partycode varchar(20),  
@inst_type varchar(6),  
@symbol varchar(12),  
@expirydate varchar(11) ,
@WareHouse varchar(20)
AS  
  
if @targetid = 1  
  
begin  
 select Sett_no,Sett_Type,Party_Code,Qty,TransDate,HolderName,FolioNo,TrType,Reason,  
 CltDpId,DpId,DpType,Delivered,ISett_no,ISett_Type,BDpID,BcltDpId,FolioNo,TransNo,isin  
 from delivery_transaction where sett_no = @SettNo and sett_type = @Settype  
 and inst_type = @inst_type and symbol = @symbol   
 and WareHouse = @WareHouse
 and left(convert(varchar,expiry_date,9),11) like @expirydate + '%'  
 and DrCr = 'C'   
 and party_code = @partycode and Active = 1   
end  
  
if @targetid = 2  
  
begin  
 select Sett_no,Sett_Type,Party_Code,Qty,TransDate,HolderName,FolioNo,TrType,Reason,  
 CltDpId,DpId,DpType,Delivered,ISett_no,ISett_Type,BDpID,BcltDpId,FolioNo,TransNo,isin  
 from delivery_transaction where sett_no = @SettNo and sett_type = @Settype  
 and inst_type = @inst_type and symbol = @symbol   
 and WareHouse = @WareHouse
 and left(convert(varchar,expiry_date,9),11) like @expirydate + '%'  
 and DrCr = 'D'   
 and party_code = @partycode and Active = 1   
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Rpt_NCDXDelAllScripList
-- --------------------------------------------------
CREATE Proc [dbo].[Delivery_Rpt_NCDXDelAllScripList]       
(        
@StatusId Varchar(15),      
@StatusName Varchar(25),      
@Party_Code Varchar(10),      
@settno varchar(7),      
@settype varchar(3),        
@inst_type varchar(6),        
@symbol varchar(12),        
@expirydate varchar(11))      
        
      
        
as         
      
  select DISTINCT 
	d.WareHouse,
	d.Symbol
  from
	delivery_obl_clt D, Client2 C2, Client1 C1        
  where 
	D.Party_Code like  @Party_Code  + '%'      
	and d.Party_code = c2.Party_code  
	And C1.Cl_Code = C2.Cl_Code         
	AND @STATUSNAME = (   
	CASE   
	        WHEN @STATUSID = 'BRANCH'   
	        THEN C1.BRANCH_CD   
	        WHEN @STATUSID = 'SUBBROKER'   
	        THEN C1.SUB_BROKER   
	        WHEN @STATUSID = 'TRADER'   
	        THEN C1.TRADER   
	        WHEN @STATUSID = 'FAMILY'   
	        THEN C1.FAMILY   
	        WHEN @STATUSID = 'AREA'   
	        THEN C1.AREA   
	        WHEN @STATUSID = 'REGION'   
	        THEN C1.REGION   
	        WHEN @STATUSID = 'CLIENT'   
	  THEN C2.PARTY_CODE   
	        ELSE 'BROKER' END)   
  Group by d.Symbol, d.WareHouse
  Order by d.Symbol, d.WareHouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Rpt_NCDXDelClientList
-- --------------------------------------------------




CREATE   Proc [dbo].[Delivery_Rpt_NCDXDelClientList]       
(@StatusId Varchar(15),      
@StatusName Varchar(25),      
@SettNo varchar(7),      
@Sett_Type Varchar(2),      
@Party_Code Varchar(10) )        
as         
If @statusid = 'broker'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2          
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 order by c1.short_name         
End        
If @statusid = 'branch'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2, branches br          
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 and br.short_name = c1.trader and br.branch_cd = @statusname        
 order by c1.short_name         
End        
If @statusid = 'subbroker'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2, subbrokers sb        
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 and sb.sub_broker = c1.sub_broker and sb.sub_broker = @statusname        
 order by c1.short_name         
End        
If @statusid = 'trader'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2        
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 and c1.trader = @statusname        
 order by c1.short_name         
End        
If @statusid = 'client'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2        
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 and c2.party_code = @statusname        
 order by c1.short_name         
End        
If @statusid = 'family'        
Begin         
 select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type from delivery_obl_clt d,client1 c1,client2 c2        
 where d.party_code = c2.party_code and c1.cl_code = c2.cl_code         
 and d.sett_no like @settno and d.sett_type like @Sett_Type and d.party_code like @Party_Code + '%'        
 and c1.family = @statusname        
 order by c1.short_name         
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXDelClientSettScrip
-- --------------------------------------------------
CREATE   PROCEDURE  [dbo].[Delivery_rpt_NCDXDelClientSettScrip]  
@symbol varchar(12),  
@inst_type varchar(6),  
@partycode varchar(10),
@expirydate varchar(11),
@WareHouse varchar(20)

AS  
Select d.sett_no,d.sett_type,d.party_code,c1.short_name,d.inst_type,d.symbol,
	Qty = Total_Allocated_Qty,  
	RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),  
	GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
	Demat_Date = 'Jan 30 2079', left(d.expiry_date,11)  expirydate
	from client1 c1,client2 c2, 
(
	select
		Sett_Type,Sett_No,Inst_Type,
		Symbol,Expiry_Date,WareHouse,
		Party_Code,
		Total_Allocated_Qty = sum((Case When Sell_buy = 'S' Then  Total_Allocated_qty else - Total_Allocated_qty End))
	from
		Delivery_obl_clt
	where
	 	party_code like  @partycode + '%' 
		And symbol = @symbol 
		and inst_type like @inst_type   + '%'
		and expiry_date like @expirydate + '%' 
		and WareHouse = @WareHouse
	group by
		Sett_Type,Sett_No,Inst_Type,
		Symbol,Expiry_Date,WareHouse,
		Party_Code
)

 d Left Outer Join Delivery_Transaction De  
On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.symbol = De.Symbol  
And De.Party_Code = D.Party_Code And De.Active = 1 And De.inst_type = D.inst_Type 
and de.expiry_date like left(d.expiry_date,11) + '%' and d.WareHouse = De.WareHouse)   
 where d.party_code = c2.party_code and c1.cl_code =c2.cl_code  
 and d.party_code like  @partycode + '%' And d.symbol = @symbol and d.inst_type like @inst_type   + '%'
 and d.expiry_date like @expirydate + '%' and d.WareHouse = @WareHouse
 group by d.sett_no,d.sett_type,d.inst_type,d.symbol,c1.short_name,d.party_code,left(d.expiry_date,11),
Total_Allocated_Qty
 Order By d.sett_no,d.sett_type,d.inst_type,d.symbol

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXDelGet
-- --------------------------------------------------




/* Displays position wrt to nse for delivery reports */      
CREATE      PROCEDURE [dbo].[Delivery_rpt_NCDXDelGet]    
@settno varchar(7),      
@settype varchar(3)      
AS       

 select d.sett_no,d.sett_type, d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,    
 d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,    
 GetFromNcx=d.PayOut_Qty,    
 givenNCX= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),      
 ReceivedNCX=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0),
 D.WareHouse      
 from Delivery_Rpt_NCDXDelGetView d Left Outer Join DELIVERY_TRANSACTION DT      
 On (DT.sett_no = d.sett_no and Dt.Inst_type = d.inst_type        
 and Dt.symbol = d.symbol and Dt.expiry_date = d.expiry_date   
 and Dt.sett_type = d.sett_type      
 and TrType = 906       
 And Active = 1 And ShareType <> 'Auction' AND DRCR = 'C' and d.warehouse = dt.warehouse)       
 where D.sett_no = @settno and d.sett_type = @settype  and d.PayOut_Qty > 0
 group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.PayOut_Qty,D.WareHouse    
 Order By d.sett_no,d.sett_type,D.WareHouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXDelGive
-- --------------------------------------------------






--Delivery_rpt_NCDXDelGive '4','2004005','R'

CREATE     PROCEDURE [dbo].[Delivery_rpt_NCDXDelGive]                       
@settno varchar(7),              
@settype varchar(3)              
AS               
   select d.sett_no,d.sett_type, d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,            
   d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,D.WareHouse,            
   giveNcx=d.Payin_Qty ,            
   givenNCX= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),              
   ReceivedNCX=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0)              
   from Delivery_Rpt_NCDXDelGiveView d Left Outer Join DELIVERY_TRANSACTION DT              
   On (DT.sett_no = d.sett_no and Dt.Inst_type = d.inst_type                
   and Dt.symbol = d.symbol and Dt.expiry_date = d.expiry_date and Dt.sett_type = d.sett_type              
   and TrType = 906               
   And Active = 1 And ShareType <> 'Auction' AND DRCR = 'D' and d.warehouse = dt.warehouse)               
   where D.sett_no = @settno and d.sett_type = @settype  and Payin_Qty > 0             
   group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.Payin_Qty,D.WareHouse            
   Order By d.sett_no,d.sett_type,D.WareHouse

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXDelScripClients
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[Delivery_rpt_NCDXDelScripClients]                
@StatusId Varchar(15),@StatusName Varchar(25),                
@dematid varchar(2),                
@settno varchar(7),                
@settype varchar(3),              
@inst_type varchar(6),              
@symbol varchar(12),              
@expirydate varchar(10),  
@WareHouse Varchar(10) ='',
@PartyCode  Varchar(12) =''
              
AS                
  
  select   
 d.sett_no,d.sett_type,d.party_code,c1.short_name,  
 (Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End) Qty,  
 RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),                
 GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)) ,        
 d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate,d.WareHouse       
  from  
 client1 c1,  
 client2 c2,   
 delivery_obl_clt d Left Outer Join delivery_transaction De                
   On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type                
    and D.symbol=de.symbol  and D.expiry_date like left(De.expiry_date,11) + '%'              
    And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse )                 
  where  
 D.party_code = c2.party_code and c1.cl_code =c2.cl_code                
 and d.sett_no = @settno and d.sett_type = @settype                
 and d.inst_type like @inst_type +'%'   
 and d.symbol like @symbol +'%'   
 and D.Expiry_date like @expirydate + '%'  
 and D.WareHouse Like @WareHouse + '%' 
 and C2.Party_code like case when @PartyCode <>'' then @PartyCode else '%' end 
 AND @STATUSNAME = (     
 CASE     
         WHEN @STATUSID = 'BRANCH'     
         THEN C1.BRANCH_CD     
         WHEN @STATUSID = 'SUBBROKER'     
         THEN C1.SUB_BROKER     
         WHEN @STATUSID = 'TRADER'     
         THEN C1.TRADER     
         WHEN @STATUSID = 'FAMILY'     
         THEN C1.FAMILY     
         WHEN @STATUSID = 'AREA'     
         THEN C1.AREA     
         WHEN @STATUSID = 'REGION'     
         THEN C1.REGION     
         WHEN @STATUSID = 'CLIENT'     
   THEN C2.PARTY_CODE     
         ELSE 'BROKER' END)     
  
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol,d.Expiry_Date,d.WareHouse,Sell_buy  
              
  Union All  
  
  select   
 d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,                
 RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),                
 GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),      
 Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate,d.WareHouse      
  from  
 client1 c1,client2 c2,delivery_transaction D                
  where  
 D.party_code = c2.party_code and c1.cl_code =c2.cl_code                
 And Active = 1 and d.sett_no = @settno and d.sett_type = @settype                 
 And d.Party_code Not In   
   (  
    Select   
     Party_Code  
    From  
     delivery_obl_clt De                 
    Where  
     De.Sett_no = D.Sett_No  And D.sett_Type = De.SetT_Type                 
     And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse  
    )                 
       
 and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%'   
 and D.Expiry_date like @expirydate + '%'              
 and D.WareHouse Like @WareHouse + '%'  
 AND @STATUSNAME = (     
 CASE     
         WHEN @STATUSID = 'BRANCH'     
         THEN C1.BRANCH_CD     
         WHEN @STATUSID = 'SUBBROKER'     
         THEN C1.SUB_BROKER     
         WHEN @STATUSID = 'TRADER'     
         THEN C1.TRADER     
         WHEN @STATUSID = 'FAMILY'     
         THEN C1.FAMILY     
         WHEN @STATUSID = 'AREA'     
         THEN C1.AREA     
         WHEN @STATUSID = 'REGION'     
         THEN C1.REGION     
         WHEN @STATUSID = 'CLIENT'     
   THEN C2.PARTY_CODE     
         ELSE 'BROKER' END)     
  
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date, d.WareHouse      
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Rpt_NCDXDelScripList
-- --------------------------------------------------


CREATE  Proc [dbo].[Delivery_Rpt_NCDXDelScripList](    
@StatusId Varchar(15),  
@StatusName Varchar(25),  
@SettNo varchar(7),  
@Sett_Type Varchar(2),  
@symbol Varchar(12))    
  
as     
If @statusid = 'broker'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End)
from delivery_obl_clt D, Client2 C2, Client1 C1    
where d.sett_no like @settno and d.sett_type like @Sett_Type  and d.symbol like @symbol    
And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code     
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End    
If @statusid = 'branch'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End) 
from delivery_obl_clt D, Client2 C2, Client1 C1, branches br      
where d.sett_no like @settno and d.sett_type like @Sett_Type  and d.symbol like @symbol    
And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code     
and br.short_name = c1.trader and br.branch_cd = @statusname    
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End    
If @statusid = 'subbroker'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End)
 from delivery_obl_clt D, Client2 C2, Client1 C1, subbrokers sb    
where d.sett_no like @settno and d.sett_type like @Sett_Type  and d.symbol like @symbol    

And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code     
and sb.sub_broker = c1.sub_broker and sb.sub_broker = @statusname    
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End    
If @statusid = 'trader'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End)
from delivery_obl_clt D, Client2 C2, Client1 C1    
where d.sett_no = @settno and d.sett_type= @Sett_Type  and d.symbol like @symbol    
And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code and c1.trader = @statusname    
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End    
If @statusid = 'client'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End) 
from delivery_obl_clt D, Client2 C2, Client1 C1    
where d.sett_no = @settno and d.sett_type= @Sett_Type  and d.symbol like @symbol    
And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code and c2.party_code = @statusname    
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End    
If @statusid = 'family'    
Begin     
select distinct d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11) expiry_date,d.inst_type,
tot_req_qty=Sum(Case When Sell_buy = 'S' Then  D.Total_Allocated_qty else - D.Total_Allocated_qty End)
 from delivery_obl_clt D, Client2 C2, Client1 C1    
where d.sett_no = @settno and d.sett_type= @Sett_Type  and d.symbol like @symbol    
And D.Party_Code = C2.Party_Code And C1.Cl_Code = C2.Cl_Code and c1.family = @statusname     
Group by d.party_code,c1.short_name,d.symbol,left(D.expiry_date,11),d.inst_type     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXDelScripWareHouse
-- --------------------------------------------------







CREATE     PROCEDURE [dbo].[Delivery_rpt_NCDXDelScripWareHouse]            
@StatusId Varchar(15),@StatusName Varchar(25),            
@dematid varchar(2),            
@settno varchar(7),            
@settype varchar(3),          
@inst_type varchar(6),          
@symbol varchar(12),          
@expirydate varchar(10),
@WareHouse varchar(20)          
          
AS            
If @statusid = 'broker'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,D.Total_Allocated_qty Qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),    
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2, delivery_obl_clt d Left Outer Join delivery_transaction De            
  On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date like left(De.expiry_date,11) + '%'          
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse )             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype            
  and d.WareHouse = @WareHouse
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          	
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol,d.Expiry_Date,d.WareHouse  
          
  Union All            
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2,delivery_transaction D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  And Active = 1 and d.sett_no = @settno and d.sett_type = @settype             
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De             
  Where De.Sett_no = D.Sett_No  And D.sett_Type = De.SetT_Type             
  And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse )             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date, d.WareHouse  
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code            
end            
If @statusid = 'branch'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Total_Allocated_qty qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2 , branches br , delivery_obl_clt d Left Outer Join  delivery_transaction De            
  On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date=De.expiry_date            
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse )             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno             
  and d.sett_type = @settype              
  and br.short_name = c1.trader             
  and br.branch_cd = @statusname            
  and d.WareHouse = @WareHouse
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol, d.Expiry_Date,d.WareHouse  
  Union All            
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2, branches br ,delivery_transaction D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  And Active = 1 and br.short_name = c1.trader             
  and br.branch_cd = @statusname            
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De             
  Where De.Sett_no = D.Sett_No  And D.sett_Type = De.SetT_Type            
  And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse)             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date,d.WareHouse  
end            
        
If @statusid = 'subbroker'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Total_Allocated_qty qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2, subbrokers sb , delivery_obl_clt d Left Outer Join              
  delivery_transaction De            
  On (  De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date=De.expiry_date            
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse)             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  and  sb.sub_broker = c1.sub_broker             
  and sb.sub_broker = @statusname            
  and d.WareHouse = @WareHouse
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol, d.Expiry_Date,d.WareHouse  
          
  Union All            
          
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate ,d.WareHouse 
  from client1 c1,client2 c2, subbrokers sb , delivery_transaction D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  And Active = 1 and  sb.sub_broker = c1.sub_broker             
  and sb.sub_broker = @statusname            
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De            
  Where De.Sett_no = D.Sett_No              
  And D.sett_Type = De.SetT_Type             
  And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse )             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date,d.WareHouse  
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code            
 end                   
If @statusid = 'trader'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Total_Allocated_qty Qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  ivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2, delivery_obl_clt d Left Outer Join delivery_transaction De            
  On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date=De.expiry_date            
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse)             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype            
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'           
  and c1.trader = @statusname and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol, d.Expiry_Date,d.WareHouse  
  Union All            
          
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2 ,delivery_transaction D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno             
  and d.sett_type = @settype             
  And Active = 1             
  and c1.trader = @statusname            
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De Where De.Sett_no = D.Sett_No And              
  D.sett_Type = De.SetT_Type             
  And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse )             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date,d.WareHouse  
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code          
end            
If @statusid = 'client'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Total_Allocated_qty Qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate ,d.WareHouse 
  from client1 c1,client2 c2, delivery_obl_clt d Left Outer Join Delivery_Transaction De            
  On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date=De.expiry_date            
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse)             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  and c2.party_code = @statusname  and d.WareHouse = @WareHouse
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol, d.Expiry_Date,d.WareHouse  
          
  Union All            
          
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate ,d.WareHouse 
  from client1 c1,client2 c2, Delivery_Transaction D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  And Active = 1 and c2.party_code = @statusname            
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De Where De.Sett_no = D.Sett_No And              
  D.sett_Type = De.SetT_Type And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse)             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, d.Expiry_Date,d.WareHouse  
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code            
  end            
If @statusid = 'family'            
Begin             
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Total_Allocated_qty Qty,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(De.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(De.Qty,0) Else 0 End)),  
  d.Inst_Type,d.Symbol,Left(d.Expiry_Date,11) ExpiryDate ,d.WareHouse 
  from client1 c1,client2 c2, delivery_obl_clt d Left Outer Join Delivery_Transaction De            
  On ( De.Sett_no = D.Sett_No And D.sett_Type = De.SetT_Type and D.Inst_Type = De.Inst_Type            
  and D.symbol=de.symbol  and D.expiry_date=De.expiry_date            
  And De.Party_Code = D.Party_Code And De.Active = 1 And d.WareHouse = De.WareHouse )             
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  and c1.family = @statusname  and d.WareHouse = @WareHouse
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,d.Inst_Type,Total_Allocated_qty,d.Symbol, d.Expiry_Date ,d.WareHouse 
  Union All            
  select d.sett_no,d.sett_type,d.party_code,c1.short_name,Qty=0,            
  RecQty = Sum((Case When DrCr = 'C' Then IsNull(D.Qty,0) Else 0 End)),            
  GivenQty = Sum((Case When DrCr = 'D' Then IsNull(D.Qty,0) Else 0 End)),  
  Inst_Type,Symbol,Left(Expiry_Date,11) ExpiryDate,d.WareHouse  
  from client1 c1,client2 c2 ,Delivery_Transaction  D            
  where  D.party_code = c2.party_code and c1.cl_code =c2.cl_code            
  and d.sett_no = @settno and d.sett_type = @settype             
  And Active = 1  and c1.family = @statusname            
  And d.Party_code Not In ( Select Party_Code From delivery_obl_clt De Where De.Sett_no = D.Sett_No And              
  D.sett_Type = De.SetT_Type             
  And De.Party_Code = D.Party_Code And d.WareHouse = De.WareHouse)             
  and d.inst_type like @inst_type +'%' and d.symbol like @symbol +'%' and D.Expiry_date like @expirydate + '%'          
  and d.WareHouse = @WareHouse
  group by d.sett_no,d.sett_type,c1.short_name,d.party_code,Inst_Type,Symbol, Expiry_Date ,d.WareHouse 
  order by d.sett_no,d.sett_type,c1.short_name,d.party_code            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXshortagepayin
-- --------------------------------------------------






CREATE  procedure [dbo].[Delivery_rpt_NCDXshortagepayin]
@StatusId Varchar(15),
@StatusName Varchar(25),  
@settno varchar(7),  
@settype varchar(3)  
as  

If @statusid = 'broker'  
Begin  
 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION'
	and d.WareHouse = de.WareHouse )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
End  
If @statusid = 'branch'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , branches br,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  AND  br.branch_cd = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
 
End  
If @statusid = 'subbroker'  
Begin 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , subbrokers sb,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  AND  sb.sub_broker = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End  
If @statusid = 'trader' 

Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL, D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c1.trader = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL ,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
  
End  
If @statusid = 'client'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c2.party_code = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code


End  
If @statusid = 'family'  
Begin   

	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c1.family = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty ,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXshortagepayin1
-- --------------------------------------------------


CREATE procedure [dbo].[Delivery_rpt_NCDXshortagepayin1]  
@StatusId Varchar(15),
@StatusName Varchar(25),  
@settno varchar(7),  
@settype varchar(3)  
as  

If @statusid = 'broker'  
Begin  
 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
End  
If @statusid = 'branch'  
Begin   


	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , branches br,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  br.branch_cd = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
 
End  
If @statusid = 'subbroker'  
Begin 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , subbrokers sb,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  sb.sub_broker = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End  
If @statusid = 'trader' 

 
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL, D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.trader = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL ,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
  
End  
If @statusid = 'client'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c2.party_code = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code


End  
If @statusid = 'family'  
Begin   

	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.family = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty ,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXshortagepayout
-- --------------------------------------------------



CREATE procedure [dbo].[Delivery_rpt_NCDXshortagepayout]
@StatusId Varchar(15),
@StatusName Varchar(25),  
@settno varchar(7),  
@settype varchar(3)  
as  

If @statusid = 'broker'  
Begin  
 
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0), d.WareHouse   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
End  
If @statusid = 'branch'  
Begin   


	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0),d.WareHouse   
 	from Client2 C2,Client1 C1  , branches br,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  AND  br.branch_cd = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0) 
	order by d.sett_no,d.sett_type,d.Party_Code
 
End  
If @statusid = 'subbroker'  
Begin 
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0),d.WareHouse   
 	from Client2 C2,Client1 C1  , subbrokers sb,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  AND  sb.sub_broker = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE   ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)
	order by d.sett_no,d.sett_type,d.Party_Code

End  
If @statusid = 'trader' 

 
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL, D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,  
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0),d.WareHouse   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c1.trader = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL ,D.INST_TYPE,D.EXPIRY_DATE    ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0) 
	order by d.sett_no,d.sett_type,d.Party_Code
  
End  
If @statusid = 'client'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0) ,d.WareHouse     
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION'
	and d.WareHouse = de.WareHouse )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c2.party_code = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE    ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0) 
	order by d.sett_no,d.sett_type,d.Party_Code


End  
If @statusid = 'family'  
Begin   

	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE,  
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   ,d.WareHouse   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' 
	and d.WareHouse = de.WareHouse)  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
	And d.sett_type like @settype +'%'  and c1.family = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty ,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE   ,d.WareHouse   
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)
	order by d.sett_no,d.sett_type,d.Party_Code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NCDXshortagepayout1
-- --------------------------------------------------


CREATE procedure [dbo].[Delivery_rpt_NCDXshortagepayout1]  
@StatusId Varchar(15),
@StatusName Varchar(25),  
@settno varchar(7),  
@settype varchar(3)  
as  

If @statusid = 'broker'  
Begin  
 
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
End  
If @statusid = 'branch'  
Begin   


	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , branches br,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  br.branch_cd = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
 
End  
If @statusid = 'subbroker'  
Begin 
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,   
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , subbrokers sb,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  sb.sub_broker = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End  
If @statusid = 'trader' 

 
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL, D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE ,  
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.trader = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL ,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
  
End  
If @statusid = 'client'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE , 
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c2.party_code = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code


End  
If @statusid = 'family'  
Begin   

	select d.sett_no,d.sett_type,d.Party_Code,ToGive=d.TOT_REQ_Qty,D.SYMBOL,D.INST_TYPE,CONVERT(VARCHAR(11),D.EXPIRY_DATE,9) EXPIRY_DATE,  
 	Given = isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.family = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty ,D.SYMBOL,D.INST_TYPE,D.EXPIRY_DATE 
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'D' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End  
  
  
  
  
  
  
  
  

















select * from delivery_obl_clt
select * from delivery_transaction

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NSDX_DelCertinfo
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Delivery_rpt_NSDX_DelCertinfo]  
@targetid varchar(2),  
@settno varchar(7),  
@settype varchar(3),  
@partycode varchar(20),  
@inst_type varchar(6),  
@symbol varchar(12),  
@expirydate varchar(11)  
AS  
  
if @targetid = 1  
  
begin  
 select Sett_no,Sett_Type,Party_Code,Qty,TransDate,HolderName,FolioNo,TrType,Reason,  
 CltDpId,DpId,DpType,Delivered,ISett_no,ISett_Type,BDpID,BcltDpId,FolioNo,TransNo  
 from delivery_transaction where sett_no = @SettNo and sett_type = @Settype  
 and inst_type = @inst_type and symbol = @symbol   
 and left(convert(varchar,expiry_date,9),11) like @expirydate + '%'  
 and DrCr = 'C'   
 and party_code = @partycode and Active = 1   
end  
  
if @targetid = 2  
  
begin  
 select Sett_no,Sett_Type,Party_Code,Qty,TransDate,HolderName,FolioNo,TrType,Reason,  
 CltDpId,DpId,DpType,Delivered,ISett_no,ISett_Type,BDpID,BcltDpId,FolioNo,TransNo  
 from delivery_transaction where sett_no = @SettNo and sett_type = @Settype  
 and inst_type = @inst_type and symbol = @symbol   
 and left(convert(varchar,expiry_date,9),11) like @expirydate + '%'  
 and DrCr = 'D'   
 and party_code = @partycode and Active = 1   
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_NSEDelGet
-- --------------------------------------------------



/* Displays position wrt to nse for delivery reports */      
CREATE  PROCEDURE [dbo].[Delivery_rpt_NSEDelGet]    
@dematid varchar(2),      
@settno varchar(7),      
@settype varchar(3)      
AS       
If @dematid = 4       
Begin      
 select d.sett_no,d.sett_type, d.Inst_Type + ' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,    
 d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,    
 GetFromNcx=d.PayOut_Qty,    
 givenNCX= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),      
 ReceivedNCX=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0)      
 from DELIVERY_OBL_NET d Left Outer Join DELIVERY_TRANSACTION DT      
 On (DT.sett_no = d.sett_no and Dt.Inst_type = d.inst_type        
 and Dt.symbol = d.symbol and Dt.expiry_date = d.expiry_date   
 and Dt.sett_type = d.sett_type      
 and TrType = 906       
 And filler2 = 1 And ShareType <> 'Auction' AND DRCR = 'D')       
 where D.sett_no = @settno and d.sett_type = @settype  and d.PayOut_Qty > 0
 group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date ,d.PayOut_Qty    
 Order By d.sett_no,d.sett_type      
      
End      
Else      
Begin      
 select d.sett_no,d.sett_type,  d.Inst_Type +' '+ d.Symbol + ' ' + left(d.Expiry_Date,11) contract,    
 d.Inst_Type,d.Symbol,left(d.Expiry_Date,11) Expiry_Date,    
 GetFromNcx=d.PayOut_Qty,    
 givenNCX= isnull(Sum(Case When DrCr = 'D' Then DT.qty Else 0 End),0),      
 ReceivedNCX=isnull(Sum(Case When DrCr = 'C' Then DT.qty Else 0 End),0)      
 from DELIVERY_OBL_NET d Left Outer Join DELIVERY_TRANSACTION DT      
 On (DT.sett_no = d.sett_no and Dt.Inst_type = d.inst_type        
 and Dt.symbol = d.symbol and Dt.expiry_date = d.expiry_date and Dt.sett_type = d.sett_type      
 and TrType = 906       
 And filler2 = 1 AND DRCR = 'D')       
 where D.sett_no = @settno and d.sett_type = @settype    and d.PayOut_Qty > 0  
 group by d.sett_no,d.sett_type,d.Inst_Type ,d.Symbol, d.Expiry_Date,d.PayOut_Qty    
 Order By d.sett_no,d.sett_type      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_PENDING
-- --------------------------------------------------
CREATE PROC DELIVERY_RPT_PENDING
(
	@STATUSID	VARCHAR(25),
	@STATUSNAME	VARCHAR(50),
	@SETT_NO	VARCHAR(7),
	@SETT_TYPE	VARCHAR(2)
)
AS

SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRY_DATE=CONVERT(VARCHAR,EXPIRY_DATE,103),STRIKE_PRICE,OPTION_TYPE,WAREHOUSE,ISIN,
QTY,TRDATE=CONVERT(VARCHAR,TRANSDATE,103), CLTACCNO='', DPID,TRANSNO,BDPID,BCLTACCNO=CLTDPID
FROM DELIVERY_TRANSACTION (NOLOCK)
WHERE SETT_NO = @SETT_NO 
AND	  SETT_TYPE = @SETT_TYPE
AND ACTIVE = 1 AND DRCR = 'D'
AND PARTY_CODE = 'BROKER'
ORDER BY SYMBOL,CONVERT(VARCHAR,EXPIRY_DATE,103),STRIKE_PRICE,OPTION_TYPE,ISIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_POSITION
-- --------------------------------------------------
CREATE  PROC DELIVERY_RPT_POSITION
	(
		@STATUSID VARCHAR(15),
		@STATUSNAME VARCHAR(25),
		@SETTNO VARCHAR(7),
		@SETT_TYPE VARCHAR(2),
		@STRORDER VARCHAR(10) = 'PARTY'
	)  
AS  


IF @STRORDER = 'PARTY'
BEGIN
	SELECT 
		D.PARTY_CODE,
		LONG_NAME,
		D.SYMBOL,
		EXPIRYDATE = LEFT(D.EXPIRY_DATE,11),
		WAREHOUSE ,
		TODELQTY=(CASE WHEN SELL_BUY = 'S' THEN TOTAL_ALLOCATED_QTY ELSE 0 END ), 
		TORECQTY=(CASE WHEN SELL_BUY = 'B' THEN TOTAL_ALLOCATED_QTY ELSE 0 END )   
	FROM
		DELIVERY_OBL_CLT D, CLIENT1, CLIENT2
	WHERE
		SETT_NO = @SETTNO AND SETT_TYPE = @SETT_TYPE   
		AND D.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND @STATUSNAME =   
		  (CASE   
			   WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD  
			   WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER  
			   WHEN @STATUSID = 'TRADER' THEN TRADER  
			   WHEN @STATUSID = 'FAMILY' THEN FAMILY  
			   WHEN @STATUSID = 'AREA' THEN AREA  
			   WHEN @STATUSID = 'REGION' THEN REGION  
			   WHEN @STATUSID = 'CLIENT' THEN D.PARTY_CODE  
		   ELSE   
		  'BROKER'  
		  END)   
	ORDER BY
		 D.PARTY_CODE,LONG_NAME,D.SYMBOL,WAREHOUSE
		
END
ELSE
BEGIN
	SELECT 
		D.PARTY_CODE,
		LONG_NAME,
		D.SYMBOL,
		EXPIRYDATE = LEFT(D.EXPIRY_DATE,11),
		WAREHOUSE ,
		TODELQTY=(CASE WHEN SELL_BUY = 'S' THEN TOTAL_ALLOCATED_QTY ELSE 0 END ), 
		TORECQTY=(CASE WHEN SELL_BUY = 'B' THEN TOTAL_ALLOCATED_QTY ELSE 0 END )   
	FROM
		DELIVERY_OBL_CLT D, CLIENT1, CLIENT2
	WHERE
		SETT_NO = @SETTNO AND SETT_TYPE = @SETT_TYPE   
		AND D.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND @STATUSNAME =   
		  (CASE   
			   WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD  
			   WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER  
			   WHEN @STATUSID = 'TRADER' THEN TRADER  
			   WHEN @STATUSID = 'FAMILY' THEN FAMILY  
			   WHEN @STATUSID = 'AREA' THEN AREA  
			   WHEN @STATUSID = 'REGION' THEN REGION  
			   WHEN @STATUSID = 'CLIENT' THEN D.PARTY_CODE  
		   ELSE   
		  'BROKER'  
		  END)   
	ORDER BY
		 D.SYMBOL,WAREHOUSE,D.PARTY_CODE,LONG_NAME

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_rpt_shortagepayin1
-- --------------------------------------------------







CREATE procedure Delivery_rpt_shortagepayin1  
@StatusId Varchar(15),
@StatusName Varchar(25),  
@settno varchar(7),  
@settype varchar(3)  
as  

If @statusid = 'broker'  
Begin  
 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
End  
If @statusid = 'branch'  
Begin   


	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , branches br,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  br.branch_cd = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
 
End  
If @statusid = 'subbroker'  
Begin 
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  , subbrokers sb,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  AND  sb.sub_broker = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End  
If @statusid = 'trader' 

 
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.trader = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code
  
End  
If @statusid = 'client'  
Begin   
	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c2.party_code = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code


End  
If @statusid = 'family'  
Begin   

	select d.sett_no,d.sett_type,d.Party_Code,ToRecive=d.TOT_REQ_Qty,  
 	Recieved = isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
 	from Client2 C2,Client1 C1  ,delivery_obl_Clt d Left Outer Join Delivery_Transaction de  
 	On ( de.sett_no = d.sett_no and de.sett_type = d.sett_type and de.inst_type = d.inst_type   
        and de.symbol = d.symbol and de.party_code = d.party_code and ACTIVE = 1 And ShareType <> 'AUCTION' )  
	 where  d.TOT_REQ_Qty > 0   
	 and D.Party_Code = C2.Party_Code and C1.Cl_Code = C2.Cl_Code  
 	and d.sett_no LIKE  @settno +'%'
 --And D.Sett_no <= @ToSettNo 
	And d.sett_type like @settype +'%'  and c1.family = @statusname
 	group by d.sett_no,d.sett_type,d.Party_Code,d.TOT_REQ_Qty  
	Having d.TOT_REQ_Qty > isnull(Sum(Case when DrCr = 'C' Then IsNull(De.Qty,0) else -IsNull(De.Qty,0) End),0)   
	order by d.sett_no,d.sett_type,d.Party_Code

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_STATUS
-- --------------------------------------------------

CREATE PROCEDURE DELIVERY_RPT_STATUS 
(
	@SETT_TYPE VARCHAR(2),
	@SETT_NO VARCHAR(7),
	@STATUSID VARCHAR(15), 
	@STATUSNAME VARCHAR(25),
	@REPORTBY VARCHAR (10),  -- CLIENT / EXCHANGE,
	@SYMBOL VARCHAR(12),
	@WAREHOUSE VARCHAR(20),
	@PARTYCODE VARCHAR(10),
	@SHORT_TYPE VARCHAR(6)  -- PAYIN / PAYOUT
)



AS

IF @REPORTBY = 'CLIENT'
BEGIN
	SELECT * FROM
	(
		SELECT D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,
		D.SYMBOL,EXPIRY_DATE = CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,  
		BUYTRADEQTY = BUYQTY, 

		BUYRECQTY=SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END  THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
		SELLTRADEQTY = SELLQTY , SELLRECQTY=SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
		BUYSHORTAGE = (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END) > 0     
		          THEN BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END)    
		          ELSE 0 END )     
			 + (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) < 0 THEN     
			  ABS(SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END),    
		SELLSHORTAGE = (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) > 0 THEN     
			  ABS(SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END) +    
			  (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR =CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D'END THEN ISNULL(DE.QTY,0) ELSE 0 END) < 0     
			           THEN ABS(BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END))    
			          ELSE 0 END )    

		FROM CLIENT2 C2 (NOLOCK),CLIENT1 C1 (NOLOCK), 
		(
			SELECT SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,
			PARTY_CODE,    
			BUYQTY=SUM(CASE WHEN SELL_BUY = 'B' THEN TOTAL_ALLOCATED_QTY ELSE 0 END),    
			SELLQTY=SUM(CASE WHEN SELL_BUY = 'S' THEN TOTAL_ALLOCATED_QTY ELSE 0 END)    
			FROM DELIVERY_OBL_CLT (NOLOCK) 
			WHERE SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN SETT_TYPE ELSE @SETT_TYPE END
			AND SETT_NO =CASE WHEN @SETT_NO ='' THEN SETT_NO ELSE @SETT_NO END  
			AND SYMBOL = CASE WHEN @SYMBOL='' THEN SYMBOL ELSE @SYMBOL END 
			AND WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN WAREHOUSE ELSE @WAREHOUSE END
			AND PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN PARTY_CODE ELSE @PARTYCODE END 
			GROUP BY SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,PARTY_CODE
		) D
		 LEFT OUTER JOIN DELIVERY_TRANSACTION DE (NOLOCK)     
		ON ( DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE AND DE.SYMBOL = D.SYMBOL    
		AND DE.EXPIRY_DATE = D.EXPIRY_DATE AND DE.WAREHOUSE=D.WAREHOUSE AND DE.PARTY_CODE = D.PARTY_CODE AND ACTIVE = 1 )    
		WHERE 
			D.PARTY_CODE = C2.PARTY_CODE 
			AND C1.CL_CODE = C2.CL_CODE 
			AND D.SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN D.SETT_TYPE ELSE @SETT_TYPE END
			AND D.SETT_NO =CASE WHEN @SETT_NO ='' THEN D.SETT_NO ELSE @SETT_NO END     
			AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
			AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
			AND D.PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN D.PARTY_CODE ELSE @PARTYCODE END 
		        AND @STATUSNAME = (       
		        CASE       
		                WHEN @STATUSID = 'BRANCH'       
		                THEN C1.BRANCH_CD       
		                WHEN @STATUSID = 'SUBBROKER'       
		                THEN C1.SUB_BROKER       
		                WHEN @STATUSID = 'TRADER'       
		                THEN C1.TRADER       
		                WHEN @STATUSID = 'FAMILY'       
		                THEN C1.FAMILY       
		                WHEN @STATUSID = 'AREA'       
		                THEN C1.AREA       
		                WHEN @STATUSID = 'REGION'       
		                THEN C1.REGION       
		                WHEN @STATUSID = 'CLIENT'       
		  		THEN C2.PARTY_CODE       
		                ELSE 'BROKER' END) 
		
		GROUP BY D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE,D.BUYQTY,SELLQTY 
		
		UNION ALL    
		    
		SELECT D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,EXPIRY_DATE = CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,    
		BUYTRADEQTY = 0, BUYRECQTY=SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
		SELLTRADEQTY = 0, SELLRECQTY=SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
		BUYSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
		  SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END),    
		SELLSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
		  SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END)    
		FROM CLIENT2 C2 (NOLOCK),CLIENT1 C1 (NOLOCK), DELIVERY_TRANSACTION D  (NOLOCK)  
		WHERE 
			D.PARTY_CODE = C2.PARTY_CODE 
			AND C1.CL_CODE = C2.CL_CODE 
			AND D.SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN D.SETT_TYPE ELSE @SETT_TYPE END
			AND D.SETT_NO =CASE WHEN @SETT_NO ='' THEN D.SETT_NO ELSE @SETT_NO END    
			AND ACTIVE = 1 AND TRTYPE <> 906
			AND D.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM DELIVERY_OBL_CLT DE (NOLOCK)      
						WHERE DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE 
						AND DE.SYMBOL = D.SYMBOL AND DE.EXPIRY_DATE = D.EXPIRY_DATE 
						AND DE.WAREHOUSE=D.WAREHOUSE 
						AND DE.PARTY_CODE = D.PARTY_CODE )   
			AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
			AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
			AND C2.PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN C2.PARTY_CODE ELSE @PARTYCODE END 
		        AND @STATUSNAME = (       
		        CASE       
		                WHEN @STATUSID = 'BRANCH'       
		                THEN C1.BRANCH_CD       
		                WHEN @STATUSID = 'SUBBROKER'       
		                THEN C1.SUB_BROKER       
		                WHEN @STATUSID = 'TRADER'       
		                THEN C1.TRADER       
		                WHEN @STATUSID = 'FAMILY'       
		                THEN C1.FAMILY       
		                WHEN @STATUSID = 'AREA'       
		                THEN C1.AREA       
		                WHEN @STATUSID = 'REGION'       
		                THEN C1.REGION       
		                WHEN @STATUSID = 'CLIENT'       
		  		THEN C2.PARTY_CODE       
		                ELSE 'BROKER' END) 
						 
		GROUP BY D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE  
	) SETT_DATA  
	WHERE
		1 = CASE 
			WHEN @SHORT_TYPE ='' 
			THEN 1
			ELSE
				CASE 
					WHEN @SHORT_TYPE ='PAYIN'
					THEN CASE WHEN SELLSHORTAGE >0 THEN 1 ELSE 0 END							
					ELSE
					     CASE WHEN BUYSHORTAGE >0 THEN 1 ELSE 0 END
					END
			END

	ORDER BY 1,2,3,4   
END
IF @REPORTBY = 'EXCHANGE' 
BEGIN

	/*SELECT D.SETT_NO,D.SETT_TYPE,
	D.SYMBOL,EXPIRY_DATE=CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,  
	BUYTRADEQTY = BUYQTY, 
	BUYRECQTY=SUM(CASE WHEN DRCR = 'D' THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
	SELLTRADEQTY = SELLQTY , SELLRECQTY=SUM(CASE WHEN DRCR = 'C' THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
	BUYSHORTAGE = (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(DE.QTY,0) ELSE 0 END) > 0     
	    THEN BUYQTY - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(DE.QTY,0) ELSE 0 END)    
	          ELSE 0 END )     
		 + (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(DE.QTY,0) ELSE 0 END)) < 0 THEN     
		  ABS(SELLQTY - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END),    
	SELLSHORTAGE = (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(DE.QTY,0) ELSE 0 END)) > 0 THEN     
		  ABS(SELLQTY - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END) +    
		  (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(DE.QTY,0) ELSE 0 END) < 0     
		           THEN ABS(BUYQTY - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(DE.QTY,0) ELSE 0 END))    
		          ELSE 0 END )    
	FROM 
	(
		SELECT SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,
		BUYQTY=SUM(PAYIN_QTY),    
		SELLQTY=SUM(PAYOUT_QTY)    
		FROM DELIVERY_OBL_NET (NOLOCK) 
		WHERE SETT_TYPE =@SETT_TYPE
		AND SETT_NO =@SETT_NO   
		AND SYMBOL = CASE WHEN @SYMBOL='' THEN SYMBOL ELSE @SYMBOL END
		AND WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN WAREHOUSE ELSE @WAREHOUSE END
		GROUP BY SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE
	) D
	 LEFT OUTER JOIN DELIVERY_TRANSACTION DE (NOLOCK)     
	ON ( DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE AND DE.SYMBOL = D.SYMBOL    
	AND DE.EXPIRY_DATE = D.EXPIRY_DATE AND DE.WAREHOUSE=D.WAREHOUSE 
	AND ACTIVE = 1 AND TRTYPE = 906)    
	WHERE 
		D.SETT_TYPE =@SETT_TYPE
		AND D.SETT_NO =@SETT_NO   
		AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
	 	AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
	
	GROUP BY D.SETT_NO,D.SETT_TYPE,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE,D.BUYQTY,SELLQTY 
	
	UNION ALL    
	    
	SELECT D.SETT_NO,D.SETT_TYPE,D.SYMBOL,EXPIRY_DATE=CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,    
	BUYTRADEQTY = 0, BUYRECQTY=SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
	SELLTRADEQTY = 0, SELLRECQTY=SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
	BUYSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
	  SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END),    
	SELLSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
	  SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END)    
	FROM DELIVERY_TRANSACTION D  (NOLOCK)  
	WHERE 
		D.SETT_NO = @SETT_TYPE
		AND D.SETT_TYPE = @SETT_NO    
		AND ACTIVE = 1 AND TRTYPE = 906
		AND D.WAREHOUSE NOT IN ( SELECT WAREHOUSE FROM DELIVERY_OBL_NET DE (NOLOCK)      
					WHERE DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE 
					AND DE.SYMBOL = D.SYMBOL AND DE.EXPIRY_DATE = D.EXPIRY_DATE 
					AND DE.WAREHOUSE=D.WAREHOUSE )   
		AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
		AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
					 
	GROUP BY D.SETT_NO,D.SETT_TYPE,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE    
	ORDER BY D.SETT_NO,D.SETT_TYPE,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE    
	*/
	SELECT SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,
	BUYTRADEQTY=SUM(BUYTRADEQTY),BUYRECQTY =SUM(BUYRECQTY),SELLTRADEQTY=SUM(SELLTRADEQTY),
	SELLRECQTY=SUM(SELLRECQTY),
	BUYSHORTAGE=SUM(CASE WHEN BUYSHORTAGE = SELLSHORTAGE THEN 0 ELSE BUYSHORTAGE END),
	SELLSHORTAGE=SUM(CASE WHEN BUYSHORTAGE = SELLSHORTAGE THEN 0 ELSE SELLSHORTAGE END)
	FROM
	(
		SELECT D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,
		D.SYMBOL,EXPIRY_DATE = CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,  
		BUYTRADEQTY = BUYQTY, 

		BUYRECQTY=SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END  THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
		SELLTRADEQTY = SELLQTY , SELLRECQTY=SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END) ,    
		BUYSHORTAGE = (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END) > 0     
		          THEN BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END)    
		          ELSE 0 END )     
			 + (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) < 0 THEN     
			  ABS(SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END),    
		SELLSHORTAGE = (CASE WHEN (SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) > 0 THEN     
			  ABS(SELLQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN  'D' ELSE 'C' END THEN ISNULL(DE.QTY,0) ELSE 0 END)) ELSE 0 END) +    
			  (CASE WHEN BUYQTY - SUM(CASE WHEN DRCR =CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D'END THEN ISNULL(DE.QTY,0) ELSE 0 END) < 0     
			           THEN ABS(BUYQTY - SUM(CASE WHEN DRCR = CASE WHEN DE.SETT_TYPE ='A' THEN 'C' ELSE 'D' END THEN ISNULL(DE.QTY,0) ELSE 0 END))    
			          ELSE 0 END )    

		FROM CLIENT2 C2 (NOLOCK),CLIENT1 C1 (NOLOCK), 
		(
			SELECT SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,
			PARTY_CODE,    
			BUYQTY=SUM(CASE WHEN SELL_BUY = 'B' THEN TOTAL_ALLOCATED_QTY ELSE 0 END),    
			SELLQTY=SUM(CASE WHEN SELL_BUY = 'S' THEN TOTAL_ALLOCATED_QTY ELSE 0 END)    
			FROM DELIVERY_OBL_CLT (NOLOCK) 
			WHERE SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN SETT_TYPE ELSE @SETT_TYPE END
			AND SETT_NO =CASE WHEN @SETT_NO ='' THEN SETT_NO ELSE @SETT_NO END  
			AND SYMBOL = CASE WHEN @SYMBOL='' THEN SYMBOL ELSE @SYMBOL END 
			AND WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN WAREHOUSE ELSE @WAREHOUSE END
			AND PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN PARTY_CODE ELSE @PARTYCODE END 
			GROUP BY SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE,PARTY_CODE
		) D
		 LEFT OUTER JOIN DELIVERY_TRANSACTION DE (NOLOCK)     
		ON ( DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE AND DE.SYMBOL = D.SYMBOL    
		AND DE.EXPIRY_DATE = D.EXPIRY_DATE AND DE.WAREHOUSE=D.WAREHOUSE AND DE.PARTY_CODE = D.PARTY_CODE AND ACTIVE = 1 )    
		WHERE 
			D.PARTY_CODE = C2.PARTY_CODE 
			AND C1.CL_CODE = C2.CL_CODE 
			AND D.SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN D.SETT_TYPE ELSE @SETT_TYPE END
			AND D.SETT_NO =CASE WHEN @SETT_NO ='' THEN D.SETT_NO ELSE @SETT_NO END     
			AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
			AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
			AND D.PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN D.PARTY_CODE ELSE @PARTYCODE END 
		        AND @STATUSNAME = (       
		        CASE       
		                WHEN @STATUSID = 'BRANCH'       
		                THEN C1.BRANCH_CD       
		                WHEN @STATUSID = 'SUBBROKER'       
		                THEN C1.SUB_BROKER       
		                WHEN @STATUSID = 'TRADER'       
		                THEN C1.TRADER       
		                WHEN @STATUSID = 'FAMILY'       
		                THEN C1.FAMILY       
		                WHEN @STATUSID = 'AREA'       
		                THEN C1.AREA       
		                WHEN @STATUSID = 'REGION'       
		                THEN C1.REGION       
		                WHEN @STATUSID = 'CLIENT'       
		  		THEN C2.PARTY_CODE       
		                ELSE 'BROKER' END) 
		
		GROUP BY D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE,D.BUYQTY,SELLQTY 
		
		UNION ALL    
		    
		SELECT D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,EXPIRY_DATE = CONVERT(VARCHAR,D.EXPIRY_DATE,103),D.WAREHOUSE,    
		BUYTRADEQTY = 0, BUYRECQTY=SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
		SELLTRADEQTY = 0, SELLRECQTY=SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ,    
		BUYSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
		  SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END),    
		SELLSHORTAGE = (CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) > 0 THEN    
		  SUM(CASE WHEN DRCR = 'D' THEN ISNULL(D.QTY,0) ELSE 0 END) - SUM(CASE WHEN DRCR = 'C' THEN ISNULL(D.QTY,0) ELSE 0 END) ELSE 0 END)    
		FROM CLIENT2 C2 (NOLOCK),CLIENT1 C1 (NOLOCK), DELIVERY_TRANSACTION D  (NOLOCK)  
		WHERE 
			D.PARTY_CODE = C2.PARTY_CODE 
			AND C1.CL_CODE = C2.CL_CODE 
			AND D.SETT_TYPE = CASE WHEN @SETT_TYPE='' THEN D.SETT_TYPE ELSE @SETT_TYPE END
			AND D.SETT_NO =CASE WHEN @SETT_NO ='' THEN D.SETT_NO ELSE @SETT_NO END    
			AND ACTIVE = 1 AND TRTYPE <> 906
			AND D.PARTY_CODE NOT IN ( SELECT PARTY_CODE FROM DELIVERY_OBL_CLT DE (NOLOCK)      
						WHERE DE.SETT_NO = D.SETT_NO AND DE.SETT_TYPE = D.SETT_TYPE 
						AND DE.SYMBOL = D.SYMBOL AND DE.EXPIRY_DATE = D.EXPIRY_DATE 
						AND DE.WAREHOUSE=D.WAREHOUSE 
						AND DE.PARTY_CODE = D.PARTY_CODE )   
			AND D.SYMBOL = CASE WHEN @SYMBOL='' THEN D.SYMBOL ELSE @SYMBOL END 
			AND D.WAREHOUSE = CASE WHEN @WAREHOUSE='' THEN D.WAREHOUSE ELSE @WAREHOUSE END
			AND C2.PARTY_CODE = CASE WHEN @PARTYCODE ='' THEN C2.PARTY_CODE ELSE @PARTYCODE END 
		        AND @STATUSNAME = (       
		        CASE       
		                WHEN @STATUSID = 'BRANCH'       
		                THEN C1.BRANCH_CD       
		                WHEN @STATUSID = 'SUBBROKER'       
		                THEN C1.SUB_BROKER       
		                WHEN @STATUSID = 'TRADER'       
		                THEN C1.TRADER       
		                WHEN @STATUSID = 'FAMILY'       
		                THEN C1.FAMILY       
		                WHEN @STATUSID = 'AREA'       
		                THEN C1.AREA       
		                WHEN @STATUSID = 'REGION'       
		                THEN C1.REGION       
		                WHEN @STATUSID = 'CLIENT'       
		  		THEN C2.PARTY_CODE       
		                ELSE 'BROKER' END) 
						 
		GROUP BY D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,C1.SHORT_NAME,D.SYMBOL,D.EXPIRY_DATE,D.WAREHOUSE  
	) SETT_DATA  
	WHERE
		1 = CASE 
			WHEN @SHORT_TYPE ='' 
			THEN 1
			ELSE
				CASE 
					WHEN @SHORT_TYPE ='PAYIN'
					THEN CASE WHEN SELLSHORTAGE >0 THEN 1 ELSE 0 END							
					ELSE
					     CASE WHEN BUYSHORTAGE >0 THEN 1 ELSE 0 END
					END
			END
	GROUP BY SETT_NO,SETT_TYPE,SYMBOL,EXPIRY_DATE,WAREHOUSE
	
	ORDER BY 1,2,3,4 	
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_RPT_TRANSSTATEMENT
-- --------------------------------------------------
CREATE  PROCEDURE DELIVERY_RPT_TRANSSTATEMENT       
(
	@FROMDATE VARCHAR(11), 
	@TODATE VARCHAR(11), 
	@FROMPARTY VARCHAR(10), 
	@TOPARTY VARCHAR(10), 
	@FROMSCRIP VARCHAR(12), 
	@TOSCRIP VARCHAR(12),            
	@CLTDPID VARCHAR(16), 
	@DPID VARCHAR(10),
	@FLAG INT, 
	@STATUSID VARCHAR(50), 
	@STATUSNAME VARCHAR(50) 
)            
AS             



IF LEN(@DPID) < 8       
 SELECT @DPID = '%'      
      
IF LEN(@CLTDPID) < 8       
 SELECT @CLTDPID = '%'      


SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED  

SELECT *
INTO   #DEL_TRANSSTAT
FROM   DELIVERY_TRANSACTION WITH (NOLOCK)
WHERE  PARTY_CODE >= @FROMPARTY
       AND PARTY_CODE <= @TOPARTY
       AND SYMBOL >= @FROMSCRIP
       AND SYMBOL <= @TOSCRIP
       AND TRANSDATE >= @FROMDATE
       AND TRANSDATE <= @TODATE
                        
CREATE INDEX [DELHOLD] ON [DBO].[#DEL_TRANSSTAT] (
      [TRANSDATE],
      [PARTY_CODE],
      [SYMBOL],
      [HOLDERNAME],
      [DRCR],
      [BDPTYPE],
      [BDPID],
      [BCLTDPID])

IF @FLAG = 1
  BEGIN
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO,
             DPID = BDPID,
             CLTDPID = BCLTDPID,
             TRTYPE,
             REASON = (CASE 
                         WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'
                         ELSE 'TRANS TO BEN'
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 1
    INTO     #DEL_TRANSSTAT_1
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    DRCR = 'D'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = 'G'
             AND FILLER2 = 0
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@CLTDPID)) + '%'
             AND HOLDERNAME NOT LIKE 'MARGIN%'
             --AND SETT_NO <> '2000000'
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,HOLDERNAME
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO,
             DPID = DPID,
             CLTDPID = CLTDPID,
             TRTYPE,
             REASON,
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 2
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             
             CLIENT1 C1
    WHERE    DRCR = 'C'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             /*AND DELIVERED = '0'*/
             AND FILLER2 = 1
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND FILLER1 NOT IN ('SPLIT','BONUS')
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,REASON
             
    UNION ALL
    
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO = 0,
             DPID = '',
             CLTDPID = '',
             TRTYPE,
             REASON,
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 3
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    DRCR = 'C'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = '0'
             AND FILLER2 = 1
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND FILLER1 IN ('SPLIT','BONUS')
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,REASON
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = 0,
             DQTY = SUM(QTY),
             SLIPNO = (CASE 
                         WHEN FILLER1 = 'SPLIT' THEN 0
                         ELSE SLIPNO
                       END),
             DPID = (CASE 
                       WHEN TRTYPE IN (1000,907,908) THEN ''
                       WHEN FILLER1 = 'SPLIT' THEN ''
                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''
                       ELSE DPID
                     END),
             CLTDPID = (CASE 
                          WHEN TRTYPE IN (1000,907,908) THEN ''
                          WHEN FILLER1 = 'SPLIT' THEN ''
                          WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''
                          ELSE CLTDPID
                        END),
             TRTYPE,
             REASON = (CASE 
                         WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE
                         ELSE (CASE 
                                 WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'
                                 WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1
                                 ELSE (CASE 
                                         WHEN REASON = 'DEMAT' THEN 'PAY-OUT'
                                         ELSE REASON
                                       END)
                               END)
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 4
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    FILLER2 = 1
             AND DRCR = 'D'
             AND DELIVERED <> '0'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND HOLDERNAME NOT LIKE 'MARGIN%'
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,FILLER1,
             REASON
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = 0,
             DQTY = SUM(QTY),
             SLIPNO,
             DPID = DP.DPID,
             CLTDPID = DP.DPCLTNO,
             TRTYPE,
             REASON = (CASE 
                         WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'
                         ELSE 'TRANS TO BEN'
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 1
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1,
             DELIVERYDP DP
    WHERE    DRCR = 'D'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = 'G'
             AND FILLER2 = 0
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND DESCRIPTION NOT LIKE '%POOL%'
             AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO
                   OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             TRTYPE,DP.DPID,DPCLTNO,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,HOLDERNAME
    
    SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),
             SETT_NO = '',
             SETT_TYPE = '',
             PARTY_CODE,
             LONG_NAME,
             L_ADDRESS1,
             L_ADDRESS2,
             L_ADDRESS3,
             L_CITY,
             L_STATE,
             L_ZIP,
             FAMILY,
             SYMBOL,
             SCRIP_NAME,
             ISIN,
             CQTY = (CASE 
                       WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)
                       ELSE 0
                     END),
             DQTY = (CASE 
                       WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)
                       ELSE 0
                     END),
             SLIPNO = '0',
             DPID = '',
             CLTDPID = '',
             TRTYPE = '0',
             REASON = 'OPENING BALANCE',
             BDPID = '',
             BCLTDPID = '',
             TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),
             FLAG = 0
    FROM     #DEL_TRANSSTAT_1
    WHERE    TRANSDATE1 < @FROMDATE
    GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,
             L_ADDRESS3,L_CITY,L_STATE,L_ZIP,
             FAMILY,SYMBOL,SCRIP_NAME,ISIN
    UNION ALL
    SELECT *
    FROM   #DEL_TRANSSTAT_1
    WHERE  TRANSDATE1 >= @FROMDATE
           AND TRANSDATE1 <= @TODATE
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),
             SETT_NO = '',
             SETT_TYPE = '',
             PARTY_CODE,
             LONG_NAME,
             L_ADDRESS1,
             L_ADDRESS2,
             L_ADDRESS3,
             L_CITY,
             L_STATE,
             L_ZIP,
             FAMILY,
             SYMBOL,
             SCRIP_NAME,
             ISIN,
             CQTY = (CASE 
                       WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)
                       ELSE 0
                     END),
             DQTY = (CASE 
                       WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)
                       ELSE 0
                     END),
             SLIPNO = '0',
             DPID = '',
             CLTDPID = '',
             TRTYPE = '0',
             REASON = 'CLOSING BALANCE',
             BDPID = '',
             BCLTDPID = '',
             TRANSDATE1 = CONVERT(DATETIME,@TODATE),
             FLAG = 6
    FROM     #DEL_TRANSSTAT_1
    WHERE    TRANSDATE1 <= @TODATE
    GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,
             L_ADDRESS3,L_CITY,L_STATE,L_ZIP,
             FAMILY,SYMBOL,SCRIP_NAME,ISIN
    ORDER BY PARTY_CODE,
             SYMBOL,
             ISIN,
             TRANSDATE1,
             FLAG,
             SETT_NO,
             SETT_TYPE
  END
ELSE
  BEGIN
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO,
             DPID = BDPID,
             CLTDPID = BCLTDPID,
             TRTYPE,
             REASON = (CASE 
                         WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'
                         ELSE 'TRANS TO BEN'
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 1
    INTO     #DEL_TRANSSTAT_2
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    DRCR = 'D'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = 'G'
             AND FILLER2 = 0
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@CLTDPID)) + '%'
             AND HOLDERNAME NOT LIKE 'MARGIN%'
             --AND SETT_NO <> '2000000'
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
                                    
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,HOLDERNAME
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO,
             DPID = DPID,
             CLTDPID = CLTDPID,
             TRTYPE,
             REASON,
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 2
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    DRCR = 'C'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND FILLER2 = 1
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND FILLER1 NOT IN ('SPLIT','BONUS')
                                
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
                                    
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,REASON
             
    UNION ALL
    
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = SUM(QTY),
             DQTY = 0,
             SLIPNO = 0,
             DPID = '',
             CLTDPID = '',
             TRTYPE,
             REASON,
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 3
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    DRCR = 'C'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = '0'
             AND FILLER2 = 1
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND FILLER1 IN ('SPLIT','BONUS')
                            
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
                                    
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,REASON
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = 0,
             DQTY = SUM(QTY),
             SLIPNO = (CASE 
                         WHEN FILLER1 = 'SPLIT' THEN 0
                         ELSE SLIPNO
                       END),
             DPID = (CASE 
                       WHEN TRTYPE IN (1000,907,908) THEN ''
                       WHEN FILLER1 = 'SPLIT' THEN ''
                       WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''
                       ELSE DPID
                     END),
             CLTDPID = (CASE 
                          WHEN TRTYPE IN (1000,907,908) THEN ''
                          WHEN FILLER1 = 'SPLIT' THEN ''
                          WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''
                          ELSE CLTDPID
                        END),
             TRTYPE,
             REASON = (CASE 
                         WHEN TRTYPE IN (1000,907,908) THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE
                         ELSE (CASE 
                                 WHEN FILLER1 = 'SPLIT' THEN 'CORPORATE ACTION'
                                 WHEN FILLER1 LIKE 'CHANGE TO%' THEN FILLER1
                                 /*WHEN FILLER1 LIKE 'CHANGE FROM%'            
              THEN 'PAY-OUT'   */
                               ELSE (CASE 
                                         WHEN REASON = 'DEMAT' THEN 'PAY-OUT'
                                         ELSE REASON
                                       END)
                               END)
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 4
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1
    WHERE    FILLER2 = 1
             AND DRCR = 'D'
             AND DELIVERED <> '0'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND HOLDERNAME NOT LIKE 'MARGIN%'
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             DPID,CLTDPID,TRTYPE,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,FILLER1,
             REASON
             
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,TRANSDATE,103),
             SETT_NO,
             SETT_TYPE,
             D.PARTY_CODE,
             C1.LONG_NAME,
             C1.L_ADDRESS1,
             C1.L_ADDRESS2,
             C1.L_ADDRESS3,
             C1.L_CITY,
             C1.L_STATE,
             C1.L_ZIP,
             C1.FAMILY,
             D.SYMBOL,
             SCRIP_NAME = D.WAREHOUSE + '( ' + ISIN + ')',
             ISIN,
             CQTY = 0,
             DQTY = SUM(QTY),
             SLIPNO,
             DPID = DP.DPID,
             CLTDPID = DP.DPCLTNO,
             TRTYPE,
             REASON = (CASE 
                         WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN'
                         ELSE 'TRANS TO BEN'
                       END),
             BDPID,
             BCLTDPID,
             TRANSDATE1 = TRANSDATE,
             FLAG = 1
    FROM     #DEL_TRANSSTAT D,
             CLIENT2 C2,
             CLIENT1 C1,
             DELIVERYDP DP
    WHERE    DRCR = 'D'
             AND SHARETYPE <> 'AUCTION'
             AND ISIN LIKE 'IN%'
             AND DELIVERED = 'G'
             AND FILLER2 = 0
             AND C2.CL_CODE = C1.CL_CODE
             AND C2.PARTY_CODE = D.PARTY_CODE
             AND TRANSDATE >= @FROMDATE
             AND TRANSDATE <= @TODATE
             AND D.PARTY_CODE >= @FROMPARTY
             AND D.PARTY_CODE <= @TOPARTY
             AND D.SYMBOL >= @FROMSCRIP
             AND D.SYMBOL <= @TOSCRIP
             AND BDPID LIKE @DPID
             AND BCLTDPID LIKE @CLTDPID
             AND (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO
                   OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)
             AND C1.BRANCH_CD LIKE (CASE 
                                      WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME
                                      ELSE '%'
                                    END)
             AND C1.SUB_BROKER LIKE (CASE 
                                       WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
             AND C1.TRADER LIKE (CASE 
                                   WHEN @STATUSID = 'TRADER' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C1.FAMILY LIKE (CASE 
                                   WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME
                                   ELSE '%'
                                 END)
             AND C2.PARTY_CODE LIKE (CASE 
                                       WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME
                                       ELSE '%'
                                     END)
    GROUP BY TRANSDATE,WAREHOUSE,SETT_NO,SETT_TYPE,
             D.PARTY_CODE,C1.LONG_NAME,C1.L_ADDRESS1,C1.L_ADDRESS2,
             C1.L_ADDRESS3,C1.L_CITY,C1.L_STATE,C1.L_ZIP,
             C1.FAMILY,D.SYMBOL,ISIN,SLIPNO,
             TRTYPE,DP.DPID,DPCLTNO,ISETT_NO,
             ISETT_TYPE,BDPID,BCLTDPID,HOLDERNAME
    
    SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),
             SETT_NO = '',
             SETT_TYPE = '',
             PARTY_CODE = '',
             LONG_NAME = '',
             L_ADDRESS1 = '',
             L_ADDRESS2 = '',
             L_ADDRESS3 = '',
             L_CITY = '',
             L_STATE = '',
             L_ZIP = '',
             FAMILY = '',
             SYMBOL,
             SCRIP_NAME,
             ISIN,
             CQTY = (CASE 
                       WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)
                       ELSE 0
                     END),
             DQTY = (CASE 
                       WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)
                       ELSE 0
                     END),
             SLIPNO = '0',
             DPID = '',
             CLTDPID = '',
             TRTYPE = '0',
             REASON = 'OPENING BALANCE',
             BDPID = '',
             BCLTDPID = '',
             TRANSDATE1 = CONVERT(DATETIME,@FROMDATE),
             FLAG = 0
    FROM     #DEL_TRANSSTAT_2
    WHERE    TRANSDATE1 < @FROMDATE
    GROUP BY SYMBOL,SCRIP_NAME,ISIN
    UNION ALL
    SELECT *
    FROM   #DEL_TRANSSTAT_2
    WHERE  TRANSDATE1 >= @FROMDATE
           AND TRANSDATE1 <= @TODATE
    UNION ALL
    SELECT   TRANSDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),
             SETT_NO = '',
             SETT_TYPE = '',
             PARTY_CODE = '',
             LONG_NAME = '',
             L_ADDRESS1 = '',
             L_ADDRESS2 = '',
             L_ADDRESS3 = '',
             L_CITY = '',
             L_STATE = '',
             L_ZIP = '',
             FAMILY = '',
             SYMBOL,
             SCRIP_NAME,
             ISIN,
             CQTY = (CASE 
                       WHEN SUM(CQTY - DQTY) > 0 THEN SUM(CQTY - DQTY)
                       ELSE 0
                     END),
             DQTY = (CASE 
                       WHEN SUM(DQTY - CQTY) > 0 THEN SUM(DQTY - CQTY)
                       ELSE 0
                     END),
             SLIPNO = '0',
             DPID = '',
             CLTDPID = '',
             TRTYPE = '0',
             REASON = 'CLOSING BALANCE',
             BDPID = '',
             BCLTDPID = '',
             TRANSDATE1 = CONVERT(DATETIME,@TODATE),
             FLAG = 6
    FROM     #DEL_TRANSSTAT_2
    WHERE    TRANSDATE1 <= @TODATE
    GROUP BY SYMBOL,SCRIP_NAME,ISIN
    ORDER BY SYMBOL,
             ISIN,
             TRANSDATE1,
             FLAG,
             SETT_NO,
             SETT_TYPE,
             PARTY_CODE
  END
  
DROP TABLE #DEL_TRANSSTAT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_RptPayout
-- --------------------------------------------------
 CREATE Proc [dbo].[Delivery_RptPayout]    
(  
 @Sett_No Varchar(7),        
 @Sett_Type Varchar(2),        
 @FromParty Varchar(10),        
 @ToParty Varchar(10),        
 @FromScrip Varchar(12),        
 @ToScrip Varchar(12),        
 @DpType Varchar(4),        
 @DpId Varchar(8),        
 @CltDpId Varchar(16)   
)        
AS        
        
Set Transaction Isolation Level Read Uncommitted        
    
Select A.Cltcode, Amount = Sum(A.Credit)-Sum(A.Debit), Payflag = 0 Into #delaccbalance From     
(        
 Select     
  A.Cltcode,     
  Debit = (Case When L.Drcr = 'D' Then Sum(Vamt) Else 0 End),           
  Credit = (Case When L.Drcr = 'C' Then Sum(Vamt) Else 0 End)    
 From     
  ACCOUNTNCE.DBO.Ledger L with(nolock),    
  (Select CltCode From ACCOUNTNCE.DBO.Acmast with(nolock) Where AcCat = '4') A,    
  ACCOUNTNCE.DBO.Parameter P with(nolock)    
 where     
  a.cltcode >= @Fromparty     
  and a.cltcode <= @Toparty    
  and a.cltcode = l.cltcode     
  and Edt <= Left(Getdate(),11) + ' 23:59:59'          
  And EDT >= SdtCur                 
  And EDT <= Ldtcur                 
  And CurYear = 1    
 Group By A.Cltcode, L.Drcr    
 Union All    
 Select     
  A.Cltcode,     
  Debit = (Case When L.Drcr = 'D' Then Sum(Vamt) Else 0 End),           
  Credit = (Case When L.Drcr = 'C' Then Sum(Vamt) Else 0 End)    
 From     
  ACCOUNTNCE.DBO.Ledger L with(nolock),    
  (Select CltCode From ACCOUNTNCE.DBO.Acmast with(nolock) Where AcCat = '4') A,    
  ACCOUNTNCE.DBO.Parameter P with(nolock)    
 where     
  a.cltcode >= @Fromparty     
  and a.cltcode <= @Toparty    
  and a.cltcode = l.cltcode     
  and Edt <= Left(Getdate(),11) + ' 23:59:59'          
  And EDT >= SdtCur                 
  And VDT < Sdtcur                 
  And CurYear = 1    
 Group By A.Cltcode, L.Drcr    
) A           
Group By A.Cltcode          
        
Update #DelAccBalance Set Amount = 0, PayFlag=1 Where CltCode in ( Select Party_Code From Delivery_PartyFlag Where DebitFlag = 1 )        
Update #DelAccBalance Set Amount = -1, PayFlag=2 Where CltCode in ( Select Party_Code From Delivery_PartyFlag Where DebitFlag = 2 )        
        
select   
 D.Symbol,Series=D.Symbol,  
 D.Party_Code,Long_Name=IsNull(Introducer,''),TrType,D.DpType,CltDpId,        
 D.DpId,ISIN,Qty=sum(qty),bdptype,bdpid,bcltdpid,Amount=IsNull(Amount,0),        
 ISett_No,Isett_Type,  
 Flag=(Case When TrType = 907 Then 1 When TrType = 908 Then 2 Else 3 End),        
 InExc=0,   
 PayFlag = IsNull(A.PayFlag,0)   
From  
 MultiCltId M, Delivery_Transaction D Left Outer Join #DelAccBalance A         
 On ( A.CltCode = D.Party_Code )         
Where  
 Sett_no = @Sett_No and sett_type = @Sett_Type And TrType <> 906        
 and D.Party_code = M.Party_code and M.DpId = D.DpId   
 And M.CltDpNo = D.CltDpId And M.DpType = D.DpType        
 And Delivered = '0' And D.Party_Code <> 'BROKER'         
 And BDpType = @DpType And BDpId = @DpId   
 and BCltDpId = @CltDpId And DrCr = 'D' And Active = 1         
 And D.Party_Code >= @FromParty And D.Party_Code <= @ToParty        
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip And TrType in (904,905)         
Group by   
 D.Symbol,D.Party_Code,Introducer,TrType,CltDpId,D.DpId,         
 ISIN, bdptype,bdpid,bcltdpid,Amount,ISett_No,Isett_Type,D.DpType,PayFlag   
Order by         
 Flag,ISett_No,ISett_Type,D.DpType,D.Party_Code,D.Symbol

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Sales_Tax_Pop
-- --------------------------------------------------

CREATE   PROC DELIVERY_SALES_TAX_POP
	(
		@SETTTYPE VARCHAR(2),
		@SETTNO VARCHAR(7),	
		@SELL_BUY VARCHAR(1),
		@MODE VARCHAR(10)='',
		@SALES_TAX_SETT_TYPE VARCHAR(2)='',
	 	@SALES_TAX_SETT_NO VARCHAR(7)=''
	) AS


IF  @MODE ='FILEGEN'
BEGIN

	SELECT 

		DT.MEMBERCODE,DS.SETT_TYPE,DS.SETT_NO,DS.SELL_BUY,
		CUT_OFF_DATE = REPLACE(LEFT(CONVERT(VARCHAR,DT.CUT_OFF_DATE,113),11),' ','-'),
		DT.DELIVERY_ID,DS.SETT_TYPE,DS.SETT_NO,DS.SYMBOL,DS.WAREHOUSE,
		DS.ISIN, DT.QTY,BUYCLIENTNAME,BUYCLIENTADDR,BUYCLIENTFORMNO,BUYCLIENTQTY,
		BUYCLIENTVALUE,
		SALES_TAX_AMT,
		DT.QTY AS PAYOUTQTY,
		C1.LONG_NAME,C1.ADDRESS
	FROM
		DELIVERY_SALES_TAX_CLT DS, DELIVERY_SALES_TAX DT,
		(
			SELECT
				W.PARTY_CODE,W.WAREHOUSE,A.LONG_NAME,A.ADDRESS 
			FROM
				DELIVERY_SALES_TAX_CL_ADDRESS A,
				DELIVERY_SALES_TAX_CL_WAREHOUSE W
			WHERE
				A.ADD_SRNO = W.ADD_SRNO
		) C1
	WHERE
		DS.SETT_TYPE = DT.SETT_TYPE
		AND DS.SETT_NO = DT.SETT_NO
		AND DS.SYMBOL = DT.SYMBOL
		AND DS.ISIN = DT.ISIN
		AND DS.WAREHOUSE = DT.WAREHOUSE
		AND C1.PARTY_CODE = DS.PARTY_CODE
		AND C1.WAREHOUSE = DT.WAREHOUSE
		AND DS.SETT_TYPE =@SETTTYPE 
		AND DS.SETT_NO = @SETTNO 
		AND DS.SELL_BUY  = @SELL_BUY
		AND DS.SELL_BUY  = DT.SELL_BUY
	ORDER BY DT.DELIVERY_ID,DS.ISIN,DS.PARTY_CODE

	
END
ELSE IF  @MODE ='CHECK'
BEGIN
	SELECT 
		DS.DELIVERY_ID,
		DS.SYMBOL,
		DS.ISIN,
		BUYCLIENTQTY=SUM(BUYCLIENTQTY),
		PAYOUTQTY=SUM(PAYOUTQTY)
	FROM
		(SELECT 
			SETT_TYPE,SETT_NO,WAREHOUSE,SELL_BUY,
			DELIVERY_ID=MAX(DELIVERY_ID),SYMBOL,
			ISIN,PAYOUTQTY=SUM(PAYOUTQTY)
			FROM DELIVERY_SALES_TAX_CLT
		WHERE 
			SETT_TYPE =@SETTTYPE 
			AND SETT_NO = @SETTNO 
			AND SELL_BUY  = @SELL_BUY
		GROUP BY
			SETT_TYPE,SETT_NO,WAREHOUSE,
			SYMBOL,ISIN,SELL_BUY
			) DS, 
			(
			SELECT 
				SETT_TYPE,SETT_NO,SYMBOL,ISIN,WAREHOUSE,
				BUYCLIENTQTY = SUM(BUYCLIENTQTY)
			FROM
				DELIVERY_SALES_TAX
			WHERE 
				SETT_TYPE = @SETTTYPE
				AND SETT_NO = @SETTNO
				AND SELL_BUY  = @SELL_BUY
			GROUP BY SETT_TYPE,SETT_NO,SYMBOL,ISIN,WAREHOUSE
			) DT
	WHERE
		DS.SETT_TYPE = DT.SETT_TYPE
		AND DS.SETT_NO = DT.SETT_NO
		AND DS.SYMBOL = DT.SYMBOL
		AND DS.ISIN = DT.ISIN
		AND DS.WAREHOUSE = DT.WAREHOUSE
		AND DS.SETT_TYPE =@SETTTYPE 
		AND DS.SETT_NO = @SETTNO 
		AND DS.SELL_BUY  = @SELL_BUY
	GROUP BY
		DS.SYMBOL,
		DS.ISIN,
		DS.DELIVERY_ID
	HAVING SUM(PAYOUTQTY)  <> SUM(BUYCLIENTQTY)

END
ELSE IF  @MODE ='NEW'
BEGIN
	DELETE DELIVERY_SALES_TAX_CLT WHERE SETT_TYPE =@SETTTYPE AND SETT_NO = @SETTNO AND SELL_BUY  = @SELL_BUY


	INSERT INTO DELIVERY_SALES_TAX_CLT
	SELECT 
		D.DELIVERY_ID,
		D.CUT_OFF_DATE,
		D.MEMBERCODE,
		D.SETT_TYPE,
		D.SETT_NO,
		DT.PARTY_CODE,
		D.SYMBOL,
		D.WAREHOUSE,
		D.ISIN,
		SELL_BUY,
		EXEMP_FORM_NO='',
		PAYOUTQTY = SUM(CASE
				WHEN @SELL_BUY = 'S' AND DRCR ='C' THEN DT.QTY 
				WHEN @SELL_BUY = 'B' AND DRCR ='D' THEN DT.QTY 
				ELSE 0 END
				),
		DELIVERY_VAL = 0,
		SALES_TAX_AMT =0
	FROM 
		DELIVERY_TRANSACTION DT , 
		(SELECT 
			DELIVERY_ID = MAX(DELIVERY_ID),CUT_OFF_DATE,MEMBERCODE,
			SETT_TYPE,SETT_NO,SYMBOL,WAREHOUSE,ISIN,SELL_BUY
		FROM 
			DELIVERY_SALES_TAX
		WHERE	
			SETT_TYPE = @SETTTYPE AND SETT_NO = @SETTNO
			AND SELL_BUY = @SELL_BUY
		GROUP BY
			CUT_OFF_DATE,MEMBERCODE,
			SETT_TYPE,SETT_NO,SYMBOL,WAREHOUSE,ISIN,SELL_BUY
		) D
	WHERE  
		DT.SETT_TYPE = D.SETT_TYPE
		AND DT.SETT_NO = D.SETT_NO
		AND DT.ISIN = D.ISIN
		AND DT.SETT_TYPE = @SETTTYPE AND DT.SETT_NO = @SETTNO
		AND ACTIVE = 1
		AND PARTY_CODE NOT IN ('BROKER','EXE')
	GROUP BY
		D.DELIVERY_ID,
		D.MEMBERCODE,
		D.CUT_OFF_DATE,
		D.SETT_TYPE,
		D.SETT_NO,
		DT.PARTY_CODE,
		D.SYMBOL,
		D.WAREHOUSE,
		D.ISIN,
		SELL_BUY
	HAVING 
		SUM(CASE
			WHEN @SELL_BUY = 'S' AND DRCR ='C' THEN DT.QTY 
			WHEN @SELL_BUY = 'B' AND DRCR ='D' THEN DT.QTY 
			ELSE 0 END
			) > 0


	IF @SELL_BUY='B'
	BEGIN
		UPDATE 
			DELIVERY_SALES_TAX_CLT 
		SET
			DELIVERY_VAL = PAYOUTQTY * PRICE * BOOKTYPE / INSTRUMENT
		FROM
			(
				SELECT
					PRICE,BOOKTYPE,INSTRUMENT,RESERVED2,SYMBOL 
				FROM 
					DELIVERY_FOSETT 
				WHERE 
					SETT_TYPE = @SETTTYPE 
					AND SETT_NO = @SETTNO
					AND SELL_BUY = 1
				GROUP BY
					PRICE,BOOKTYPE,INSTRUMENT,RESERVED2,SYMBOL
			) DELIVERY_FOSETT 
		WHERE
			DELIVERY_FOSETT.SYMBOL = DELIVERY_SALES_TAX_CLT.SYMBOL
			AND DELIVERY_FOSETT.RESERVED2 = DELIVERY_SALES_TAX_CLT.WAREHOUSE
			AND DELIVERY_SALES_TAX_CLT.SELL_BUY = 'B'
			AND SETT_TYPE = @SETTTYPE 
			AND SETT_NO = @SETTNO
	END
	ELSE
	BEGIN
		UPDATE 
			DELIVERY_SALES_TAX_CLT 
		SET
			DELIVERY_VAL = PAYOUTQTY * SPRICE 
		FROM
		(
			SELECT ISIN,SYMBOL,WAREHOUSE,SPRICE = STAXPRICE
			FROM
			(	
				SELECT 
					ISIN,WAREHOUSE,SYMBOL,STAXPRICE = CONVERT(MONEY,SUM(BUYCLIENTVALUE) / SUM(BUYCLIENTQTY)) 
				FROM 
					DELIVERY_SALES_TAX 
				WHERE 
					BUYCLIENTQTY > 0
					AND SETT_TYPE =@SETTTYPE 
					AND SETT_NO = @SETTNO 
					AND SELL_BUY  = @SELL_BUY 
				GROUP BY ISIN,SYMBOL,WAREHOUSE
			) STAX
		) STAXPRICE	
		WHERE
			STAXPRICE.ISIN = DELIVERY_SALES_TAX_CLT.ISIN
			AND STAXPRICE.SYMBOL = DELIVERY_SALES_TAX_CLT.SYMBOL
			AND STAXPRICE.WAREHOUSE = DELIVERY_SALES_TAX_CLT.WAREHOUSE
	END
	
	UPDATE 
		DELIVERY_SALES_TAX_CLT 
	SET
		SALES_TAX_AMT = DELIVERY_VAL * STAX_PER / 100
	FROM
		DELIVERY_SALES_TAX_PERC
	WHERE 
		CUT_OFF_DATE BETWEEN DATE_FROM AND DATE_TO
		AND DELIVERY_SALES_TAX_PERC.SYMBOL = ''
		AND DELIVERY_VAL > 0
		AND DELIVERY_SALES_TAX_CLT.SELL_BUY = @SELL_BUY
		AND SETT_TYPE = @SETTTYPE 
		AND SETT_NO = @SETTNO
	
	UPDATE 
		DELIVERY_SALES_TAX_CLT 
	SET
		SALES_TAX_AMT = DELIVERY_VAL * STAX_PER / 100
	FROM
		DELIVERY_SALES_TAX_PERC
	WHERE 
		CUT_OFF_DATE BETWEEN DATE_FROM AND DATE_TO
		AND DELIVERY_SALES_TAX_PERC.SYMBOL = DELIVERY_SALES_TAX_CLT.SYMBOL
		AND DELIVERY_VAL > 0
		AND DELIVERY_SALES_TAX_CLT.SELL_BUY = @SELL_BUY
		AND SETT_TYPE = @SETTTYPE 
		AND SETT_NO = @SETTNO
	

	SELECT 
		PRI_KEY,DT.DELIVERY_ID,PARTY_CODE,
		DS.SYMBOL,DS.WAREHOUSE,DS.ISIN,DS.SELL_BUY,EXEMP_FORM_NO,
		BUYCLIENTQTY,BUYCLIENTVALUE,
		PAYOUTQTY=DT.QTY,
		DELIVERY_VAL,
		SALES_TAX_AMT
	FROM
		DELIVERY_SALES_TAX_CLT DS, DELIVERY_SALES_TAX DT
	WHERE
		DS.SETT_TYPE = DT.SETT_TYPE
		AND DS.SETT_NO = DT.SETT_NO
		AND DS.SYMBOL = DT.SYMBOL
		AND DS.ISIN = DT.ISIN
		AND DS.WAREHOUSE = DT.WAREHOUSE
		AND DS.SETT_TYPE =@SETTTYPE 
		AND DS.SETT_NO = @SETTNO 
		AND DS.SELL_BUY  = @SELL_BUY
	ORDER BY DS.ISIN,PARTY_CODE

END
ELSE IF  @MODE ='POSTVAT'
BEGIN
	SELECT
		SYMBOL,EXPIRYDATE,NUMERATOR,DENOMINATOR 
	INTO #FOSCRIP22
	FROM 
		FOSCRIP2
	WHERE
		EXPIRYDATE = (SELECT MAX(EXPIRYDATE) FROM FOSCRIP2
			WHERE 
				SYMBOL IN (
					SELECT DISTINCT SYMBOL FROM DELIVERY_SALES_TAX_CLT
					WHERE
						SETT_TYPE =@SETTTYPE 
						AND SETT_NO = @SETTNO 
						AND SELL_BUY  = @SELL_BUY)
				AND EXPIRYDATE < (SELECT MIN(CUT_OFF_DATE) FROM DELIVERY_SALES_TAX_CLT
					WHERE
						SETT_TYPE =@SETTTYPE 
						AND SETT_NO = @SETTNO 
						AND SELL_BUY  = @SELL_BUY)
				)	
	DELETE FROM DELIVERY_OBL_CLT WHERE 
			SETT_TYPE = @SALES_TAX_SETT_TYPE 
			AND SETT_NO = @SALES_TAX_SETT_NO
			AND SELL_BUY = @SELL_BUY

	INSERT INTO DELIVERY_OBL_CLT
	SELECT
		'','',FOOWNER.MEMBERCODE,@SALES_TAX_SETT_TYPE,@SALES_TAX_SETT_NO,
		'FUTCOM',DELIVERY_SALES_TAX_CLT.SYMBOL,EXPIRYDATE,0,'',0,ISIN,'','C',PARTY_CODE,
		SELL_BUY,PAYOUTQTY,0,PAYOUTQTY,'Y',PAYOUTQTY,0,DELIVERY_ID
	FROM 
		DELIVERY_SALES_TAX_CLT, FOOWNER, #FOSCRIP22
	
	WHERE
		DELIVERY_SALES_TAX_CLT.SYMBOL = #FOSCRIP22.SYMBOL
		AND SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 
	
	DELETE FROM DELIVERY_OBL_NET WHERE 
			SETT_TYPE = @SALES_TAX_SETT_TYPE 
			AND SETT_NO = @SALES_TAX_SETT_NO
			AND REPORT_DATE = ''

	INSERT INTO DELIVERY_OBL_NET	
	SELECT
		DELIVERY_ID,'',@SALES_TAX_SETT_TYPE,@SALES_TAX_SETT_NO,'FUTCOM',
		DELIVERY_SALES_TAX_CLT.SYMBOL,EXPIRYDATE,0,'',
		WAREHOUSE,
		CASE WHEN SELL_BUY = 'B' THEN PAYOUTQTY ELSE 0 END,CASE WHEN SELL_BUY = 'S' THEN PAYOUTQTY ELSE 0 END,
		CASE WHEN SELL_BUY = 'B' THEN SALES_TAX_AMT ELSE 0 END,
		CASE WHEN SELL_BUY = 'S' THEN SALES_TAX_AMT ELSE 0 END,ISIN
	FROM
		DELIVERY_SALES_TAX_CLT , #FOSCRIP22
	WHERE
		DELIVERY_SALES_TAX_CLT.SYMBOL = #FOSCRIP22.SYMBOL
		AND SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 

END
ELSE IF  @MODE ='FETCH'
BEGIN

	SELECT 
		PRI_KEY,DS.DELIVERY_ID,PARTY_CODE,
		DS.SYMBOL,DS.WAREHOUSE,DS.ISIN,DS.SELL_BUY,EXEMP_FORM_NO,
		BUYCLIENTQTY,BUYCLIENTVALUE,
		PAYOUTQTY,DELIVERY_VAL,SALES_TAX_AMT
	FROM
		DELIVERY_SALES_TAX_CLT DS, DELIVERY_SALES_TAX DT
	WHERE
		DS.SETT_TYPE = DT.SETT_TYPE
		AND DS.SETT_NO = DT.SETT_NO
		AND DS.SYMBOL = DT.SYMBOL
		AND DS.ISIN = DT.ISIN
		AND DS.WAREHOUSE = DT.WAREHOUSE
		AND DS.SETT_TYPE =@SETTTYPE 
		AND DS.SETT_NO = @SETTNO 
		AND DS.SELL_BUY  = @SELL_BUY
	ORDER BY DS.ISIN,PARTY_CODE
END
ELSE IF  @MODE ='UPDATE' /*EXECUTING FROM DEL IMPORT SALES TAX RTN FILE*/
BEGIN
	UPDATE
		DELIVERY_SALES_TAX_FINAL 
	SET 
		PARTY_CODE = C2.PARTY_CODE
	FROM
		DELIVERY_SALES_TAX_FINAL DT, 
		CLIENT1 C1, CLIENT2 C2
	WHERE
		DT.PARTYNAME = C1.LONG_NAME
		AND C1.CL_CODE = C2.CL_CODE
		AND DT.SETT_TYPE =@SETTTYPE 
		AND DT.SETT_NO = @SETTNO 
		AND DT.SELL_BUY  = @SELL_BUY



	SELECT
		SYMBOL,EXPIRYDATE,NUMERATOR,DENOMINATOR 
	INTO #FOSCRIP2
	FROM 
		FOSCRIP2
	WHERE
		EXPIRYDATE = (SELECT MAX(EXPIRYDATE) FROM FOSCRIP2
			WHERE 
				SYMBOL IN (
					SELECT DISTINCT SYMBOL FROM DELIVERY_SALES_TAX_FINAL
					WHERE
						SETT_TYPE =@SETTTYPE 
						AND SETT_NO = @SETTNO 
						AND SELL_BUY  = @SELL_BUY)
				AND EXPIRYDATE < (SELECT MIN(SALES_SETT_DATE) FROM DELIVERY_SALES_TAX_FINAL
					WHERE
						SETT_TYPE =@SETTTYPE 
						AND SETT_NO = @SETTNO 
						AND SELL_BUY  = @SELL_BUY)
				)	
	
	
	SELECT
		 TOP 1 @SALES_TAX_SETT_TYPE = SALES_SETT_TYPE
	FROM 
		DELIVERY_SALES_TAX_FINAL
	WHERE
		SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 
		AND SELL_BUY  = @SELL_BUY

	SELECT
		TOP 1 @SALES_TAX_SETT_NO =  SALES_SETT_NO
	FROM 
		DELIVERY_SALES_TAX_FINAL
	WHERE
		SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 
		AND SELL_BUY  = @SELL_BUY

	DELETE FROM DELIVERY_OBL_CLT WHERE 
			SETT_TYPE = @SALES_TAX_SETT_TYPE 
			AND SETT_NO = @SALES_TAX_SETT_NO
			AND SELL_BUY = @SELL_BUY

	INSERT INTO DELIVERY_OBL_CLT
	SELECT
		SALES_SETT_DATE,SALES_SETT_DATE,MEMBERCODE,SALES_SETT_TYPE,SALES_SETT_NO,
		'FUTCOM',DELIVERY_SALES_TAX_FINAL.SYMBOL,EXPIRYDATE,0,'',0,ISIN,MEMBERCODE,'C',PARTY_CODE,
		SELL_BUY,QTY,0,QTY,'Y',QTY,0,DELIVERY_ID
	FROM 
		DELIVERY_SALES_TAX_FINAL, FOOWNER, #FOSCRIP2
	
	WHERE
		DELIVERY_SALES_TAX_FINAL.SYMBOL = #FOSCRIP2.SYMBOL
		AND SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 
	
	DELETE FROM DELIVERY_OBL_NET WHERE 
			SETT_TYPE = @SALES_TAX_SETT_TYPE 
			AND SETT_NO = @SALES_TAX_SETT_NO
			AND REPORT_DATE <> ''

	INSERT INTO DELIVERY_OBL_NET	
	SELECT
		DELIVERY_ID,SALES_SETT_DATE,SALES_SETT_TYPE,SALES_SETT_NO,'FUTCOM',
		DELIVERY_SALES_TAX_FINAL.SYMBOL,EXPIRYDATE,0,'',
		WAREHOUSE,CASE WHEN SELL_BUY = 'B' THEN QTY ELSE 0 END,CASE WHEN SELL_BUY = 'S' THEN QTY ELSE 0 END,
		CASE WHEN SELL_BUY = 'B' THEN SALESTAXAMT ELSE 0 END,
		CASE WHEN SELL_BUY = 'S' THEN SALESTAXAMT ELSE 0 END,ISIN
	FROM
		DELIVERY_SALES_TAX_FINAL , #FOSCRIP2
	WHERE
		DELIVERY_SALES_TAX_FINAL.SYMBOL = #FOSCRIP2.SYMBOL
		AND SETT_TYPE =@SETTTYPE 
		AND SETT_NO = @SETTNO 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_SALESTAX
-- --------------------------------------------------



CREATE PROC DELIVERY_SALESTAX 
(
	@S_SETT_NO VARCHAR(7) ,
	@S_SETT_TYPE VARCHAR(2), 
	@MODE VARCHAR(10)            
)
AS

IF @MODE = 'NEW'            
BEGIN
	DECLARE @D_SETT_TYPE VARCHAR(2)  -- DELIVERY ORGINAL SETTLEMENT
	DECLARE @D_SETT_NO VARCHAR(7)
	DECLARE @A_SETT_TYPE VARCHAR(2)  -- PREMIUM DISCOUNT SETTLEMENT
	DECLARE @A_SETT_NO VARCHAR(7)

	SELECT  TOP 1 @D_SETT_TYPE=SETT_TYPE, @D_SETT_NO=SETT_NO FROM DELIVERY_SALES_TAX_FINAL
	WHERE SALES_SETT_TYPE = @S_SETT_TYPE AND SALES_SETT_NO = @S_SETT_NO
			
	SELECT  TOP 1 @A_SETT_TYPE=SETT_TYPE, @A_SETT_NO=SETT_NO FROM DELIVERY_OBL_CLOSEOUT
	WHERE D_SETT_TYPE = @D_SETT_TYPE AND D_SETT_NO = @D_SETT_NO

	DELETE DELIVERY_SALESTAX_OBL_CLT WHERE SETT_TYPE = @S_SETT_TYPE AND SETT_NO = @S_SETT_NO
	
	INSERT INTO DELIVERY_SALESTAX_OBL_CLT
	SELECT 
		DEL_SETT_TYPE = @D_SETT_TYPE,
		DEL_SETT_NO = @D_SETT_NO,
		STAX_SETT_TYPE = @S_SETT_TYPE,
		STAX_SETT_NO = @S_SETT_NO,
		B.PARTY_CODE, 
		B.SYMBOL, 
		EXPIRYDATE = B.EXPIRYDATE,
		ISIN = B.TRADE_NO,
		WAREHOUSE = B.RESERVED2,
		A.SELL_BUY,  /*IF A.SELL_BUY =1 THEN -AMT ELSE AMT*/
		DEl_QTY = SUM(B.TRADEQTY),
		DEl_VALUE = SUM(ROUND(ABS(A.PRICE -B.PRICE)*A.BOOKTYPE /A.INSTRUMENT * B.TRADEQTY,2)),
		STAX_PERC =  ISNULL(C.STAX_PER,0),
		STAX_AMT = ROUND(SUM( ROUND(ABS(A.PRICE -B.PRICE)*A.BOOKTYPE /A.INSTRUMENT * B.TRADEQTY,2) * ISNULL(C.STAX_PER,0) /100),2)
	FROM  
		DELIVERY_FOSETT B (NOLOCK), 
		DELIVERY_FOSETT A  (NOLOCK) 
		LEFT OUTER JOIN  DELIVERY_SALES_TAX_PERC C  (NOLOCK)
		ON (
			A.SYMBOL = C.SYMBOL
			AND C.SELL_BUY = CASE WHEN A.SELL_BUY =1 THEN 'B' ELSE 'S' END
			AND A.SAUDA_DATE BETWEEN C.DATE_FROM AND C.DATE_TO 
		)
	WHERE 
		A.SETT_TYPE = @D_SETT_TYPE
		AND A.SETT_NO =  @D_SETT_NO
		AND B.SETT_TYPE = @A_SETT_TYPE
		AND B.SETT_NO =  @A_SETT_NO
		AND A.PARTY_CODE = B.PARTY_CODE
		AND A.SYMBOL = B.SYMBOL
		AND A.EXPIRYDATE = B.EXPIRYDATE
		AND A.RESERVED2 = B.RESERVED2
		AND B.ORDER_NO ='PRMDISC'
		AND EXISTS (SELECT ISIN FROM DELIVERY_SALES_TAX_FINAL WHERE SETT_NO = @D_SETT_NO AND SETT_TYPE = @D_SETT_TYPE )
	GROUP BY B.PARTY_CODE,B.SYMBOL,B.EXPIRYDATE,B.TRADE_NO,B.RESERVED2, ISNULL(C.STAX_PER,0),A.SELL_BUY
	HAVING SUM((A.PRICE -B.PRICE)*A.BOOKTYPE /A.INSTRUMENT * B.TRADEQTY) >= 1


	SELECT
		SRNO,
		D_SETT_TYPE,
		D_SETT_NO,
		SETT_TYPE,
		SETT_NO,
		PARTY_CODE,
		SYMBOL,
		EXPIRYDATE= LEFT(EXPIRYDATE,11),
		ISIN,
		WAREHOUSE,
		SELL_BUY = CASE WHEN SELL_BUY = 1 THEN 'BUY' ELSE 'SELL' END,
		DEL_QTY,
		DEL_VALUE,
		STAX_PERC,
		STAX_AMT
	FROM DELIVERY_SALESTAX_OBL_CLT
	WHERE SETT_TYPE = @S_SETT_TYPE AND SETT_NO = @S_SETT_NO
	ORDER BY 5,6
END

ELSE IF @MODE = 'FETCH'            
BEGIN 

	SELECT
		SRNO,
		D_SETT_TYPE,
		D_SETT_NO,
		SETT_TYPE,
		SETT_NO,
		PARTY_CODE,
		SYMBOL,
		EXPIRYDATE= LEFT(EXPIRYDATE,11),
		ISIN,
		WAREHOUSE,
		SELL_BUY = CASE WHEN SELL_BUY = 1 THEN 'BUY' ELSE 'SELL' END,
		DEL_QTY,
		DEL_VALUE,
		STAX_PERC,
		STAX_AMT
	FROM DELIVERY_SALESTAX_OBL_CLT
	WHERE SETT_TYPE = @S_SETT_TYPE AND SETT_NO = @S_SETT_NO
	ORDER BY 5,6

END
ELSE IF @MODE = 'UPDATE'
BEGIN 

	SELECT
		DISTINCT SYMBOL,NUMERATOR,DENOMINATOR 
	INTO #FOSCRIP2
	FROM 
		FOSCRIP2 B
	WHERE
		EXPIRYDATE = (SELECT MAX(EXPIRYDATE) FROM FOSCRIP2 A
					WHERE A.SYMBOL = B.SYMBOL)

	DECLARE @TRDATE DATETIME
	SELECT TOP 1 @TRDATE = SALES_SETT_DATE FROM DELIVERY_SALES_TAX_FINAL
	WHERE SALES_SETT_NO = @S_SETT_NO AND SALES_SETT_TYPE = @S_SETT_TYPE

	DELETE FROM DELIVERY_OBL_CLT WHERE 
		SETT_TYPE = @S_SETT_TYPE 
		AND SETT_NO = @S_SETT_NO

	INSERT INTO DELIVERY_OBL_CLT
	SELECT
		@TRDATE,@TRDATE,MEMBERCODE,@S_SETT_TYPE,@S_SETT_NO,
		'FUTCOM',D.SYMBOL,EXPIRYDATE,0,'',0,ISIN,MEMBERCODE,'C',PARTY_CODE,
		SELL_BUY= CASE WHEN SELL_BUY = 2 THEN 'S' ELSE 'B' END ,DEL_QTY,0,DEL_QTY,'Y',DEL_QTY,0,SRNO
	FROM 
		DELIVERY_SALESTAX_OBL_CLT D, FOOWNER, #FOSCRIP2
	WHERE
		D.SYMBOL = #FOSCRIP2.SYMBOL
		AND SETT_TYPE =@S_SETT_TYPE 
		AND SETT_NO = @S_SETT_NO 
		AND STAX_AMT > 0

	DELETE FROM DELIVERY_OBL_NET WHERE 
		SETT_TYPE = @S_SETT_TYPE 
		AND SETT_NO = @S_SETT_NO

	INSERT INTO DELIVERY_OBL_NET	
	SELECT
		MAX(SRNO),@TRDATE,@S_SETT_TYPE,@S_SETT_NO,'FUTCOM',
		D.SYMBOL,EXPIRYDATE,0,'',
		WAREHOUSE,
		SUM(CASE WHEN SELL_BUY = 1 THEN DEL_QTY ELSE 0 END),
		SUM(CASE WHEN SELL_BUY = 2 THEN DEL_QTY ELSE 0 END),
		SUM(CASE WHEN SELL_BUY = 1 THEN STAX_AMT ELSE 0 END),
		SUM(CASE WHEN SELL_BUY = 2 THEN STAX_AMT ELSE 0 END),
		ISIN
	FROM
		DELIVERY_SALESTAX_OBL_CLT D , #FOSCRIP2
	WHERE
		D.SYMBOL = #FOSCRIP2.SYMBOL
		AND SETT_TYPE =@S_SETT_TYPE 
		AND SETT_NO = @S_SETT_NO 
		AND STAX_AMT > 0
	GROUP BY D.SYMBOL,EXPIRYDATE,WAREHOUSE,ISIN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_TurnOver_Report
-- --------------------------------------------------


CREATE   PROC [dbo].[Delivery_TurnOver_Report]  
            (  
            @FROMDATE VARCHAR(11),  
            @TODATE VARCHAR(11),  
            @FROMPARTY VARCHAR(15),  
            @TOPARTY VARCHAR(15),
            @ReportType VARCHAR(10) 
          )  
 AS  

  IF @FROMPARTY = '' BEGIN SET @FROMPARTY = '0' END
  IF @TOPARTY = '' BEGIN SET @TOPARTY = 'ZZZZZZ'END  

Set Transaction Isolation Level read uncommitted
if @ReportType = 'Detail'
BEGIN
Select  
            Sauda_date= Convert(Varchar,Sauda_date,103),
            Party_Code,
            Inst_Type,
            Symbol,
            ExpiryDate= Convert(Varchar,ExpiryDate,103),
            Strike_Price,
            Option_Type,
            PurTurnOver=
	    		CASE 
		            WHEN Sell_Buy = 1
		            THEN TradeQty*Price*BookType/Instrument
		            ELSE 0 
		   	    END,
            SellTurnOver=
 	    		CASE 
		            WHEN Sell_Buy = 2 
		            THEN TradeQty*Price*BookType/Instrument
		            ELSE 0 
		   	    END,
	  
            
	    brokapplied, 
	    service_tax,
	Convert(Varchar,Sauda_date,112)		
           
From
	Delivery_Fosett D,
	Client1 C1

Where 
	D.Party_code = C1.CL_Code  	
	And Party_Code between @FROMPARTY And @TOPARTY
	And Sauda_date >= @FROMDATE And Sauda_date <= @TODATE


Order By
	Convert(Varchar,Sauda_date,112),
	Party_Code
     	
END 
ELSE 
Begin
Select  
	Sauda_date = Left(Convert(Varchar,Sauda_date,103),11),
	Party_Code,
	PurTurnOver=
			sum(CASE 
	            WHEN Sell_Buy = 1
	            THEN TradeQty*Price*BookType/Instrument
	            ELSE 0 
	   	    END),
	SellTurnOver=
	    		sum(CASE 
	            WHEN Sell_Buy = 2 
	            THEN TradeQty*Price*BookType/Instrument
	            ELSE 0 
	   	    END),
	  
	brokapplied = sum(brokapplied),
	service_tax = sum(service_tax),
	Convert(Varchar,Sauda_date,112)         
            
                 
From
      	Delivery_Fosett D,
	Client1 C1
Where 
	D.Party_Code = C1.Cl_Code
	And Party_Code between @FROMPARTY and @TOPARTY
	And Sauda_date >= @FROMDATE And Sauda_date <= @TODATE
group by
	Left(Convert(Varchar,Sauda_date,103),11),
	Party_Code,
	Convert(Varchar,Sauda_date,112)
Order By
     	Convert(Varchar,Sauda_date,112),
        Party_Code
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_Upd_BillNo
-- --------------------------------------------------


Create Proc Delivery_Upd_BillNo ( @@Sett_No varchar(12),@@Sett_Type varchar(3)) AS

/*
  Procedure for updating bill number for Delivery Bills 9Delivery_FoSett table)
  Calling from Delivery_ValanGenerate sp 
  Author : Sinulal
  Date   : 20 Oct 2004
  Modification Log : 
*/
Declare @@Party_Code varchar(12),  
	@@BillNo int ,
	@@BillCur Cursor

Set @@BillCur = Cursor For 
	Select Distinct Party_Code From Delivery_FoSett where Sett_Type=@@Sett_Type and Sett_No=@@Sett_No
Open @@BillCur
Fetch Next From @@BillCur into @@Party_Code
Select @@BillNo = 1
While @@FETCH_STATUS = 0
Begin
   Update Delivery_FoSett set BillNo = @@BillNo where Sett_Type=@@Sett_Type and Sett_No=@@Sett_No
   and Party_Code = @@Party_Code
   Set @@BillNo = @@BillNo + 1
   Fetch Next From @@BillCur into @@Party_Code
End
Close @@BillCur
DeAllocate  @@BillCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_VALAN_GST_BILLPOST
-- --------------------------------------------------


CREATE PROC [dbo].[DELIVERY_VALAN_GST_BILLPOST]
(
	@SETT_NO		VARCHAR(7),
	@SETT_TYPE		VARCHAR(2)	
)
AS


DECLARE @NARRATION VARCHAR(100),
		@START_DATE SMALLDATETIME,
		@END_DATE SMALLDATETIME,
		@FUNDS_PAYIN SMALLDATETIME,
		@FUNDS_PAYOUT SMALLDATETIME


SELECT @NARRATION = ISNULL(MAX(NARRATION),'BILL POSTED'),
	   @START_DATE = MAX(START_DATE),
	   @END_DATE =  MAX(END_DATE),
	   @FUNDS_PAYIN =  MAX(PayIn_Date), 
	   @FUNDS_PAYOUT =  MAX(PayOut_Date)
 FROM ACCBILL 
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

SELECT N.PARTY_CODE, g.BRANCH_CD,Trdtype='N',
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = 0,
TARGETSTATE=L_STATE, SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0), 
Start_Date = CONVERT(DATETIME, LEFT(SAUDA_DATE,11))
INTO #GSTDATA
FROM TBL_CLIENT_GST_DATA G, TBL_GST_LOCATION L, DELIVERY_FOSETT N 
WHERE N.SETT_NO = @SETT_NO
AND N.SETT_TYPE = @SETT_TYPE
AND N.Party_Code = G.PARTY_CODE
AND GST_LOCATION = LOC_CODE
AND sauda_date BETWEEN G.EFF_FROM_DATE AND G.EFF_TO_DATE 
GROUP BY N.PARTY_CODE,g.BRANCH_CD,L_STATE,STATE,CONVERT(DATETIME, LEFT(SAUDA_DATE,11)) 

INSERT INTO #GSTDATA
SELECT N.PARTY_CODE, G.BRANCH_CD,Trdtype='N',
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = 0,
TARGETSTATE=L_STATE, SOURCESTATE=FOOWNER.STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0), 
Start_Date=CONVERT(DATETIME, LEFT(SAUDA_DATE,11))
FROM CLIENT1 G, DELIVERY_FOSETT N, FOOWNER,
TBL_STATE_GST_DATA T
WHERE N.SETT_NO = @SETT_NO
AND N.SETT_TYPE = @SETT_TYPE
AND N.Party_Code = G.Cl_Code
AND FOOWNER.State = STATE_NAME
AND Sauda_date BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE 
AND G.Cl_Code NOT IN (SELECT PARTY_CODE FROM #GSTDATA WHERE G.Cl_Code = #GSTDATA.Party_Code)
GROUP BY N.PARTY_CODE,CONVERT(DATETIME, LEFT(SAUDA_DATE,11)),G.BRANCH_CD,L_STATE,FOOWNER.STATE 

UPDATE #GSTDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM STATE_MASTER)

UPDATE #GSTDATA SET 
STATE_CODE=D.STATE_CODE,
GST_PER=D.GST_PER,
CGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.CGST_PER ELSE 0 END),
IGST_PER=(CASE WHEN SOURCESTATE <> TARGETSTATE THEN D.IGST_PER ELSE 0 END),
SGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 0 THEN D.SGST_PER ELSE 0 END),
UGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 1 THEN D.UGST_PER ELSE 0 END),
AGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.AGST_PER ELSE 0 END)
FROM TBL_STATE_GST_DATA D
WHERE D.STATE_NAME = SOURCESTATE
AND Start_Date BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

UPDATE #GSTDATA SET 
CGST_PER = SERVICE_TAX * CGST_PER / GST_PER,
SGST_PER = SERVICE_TAX * SGST_PER / GST_PER,
IGST_PER = SERVICE_TAX * IGST_PER / GST_PER,
UGST_PER = SERVICE_TAX * UGST_PER / GST_PER,
AGST_PER = SERVICE_TAX * AGST_PER / GST_PER

UPDATE #GSTDATA SET SGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + UGST_PER + AGST_PER)
WHERE SGST_PER > 0 
UPDATE #GSTDATA SET UGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + SGST_PER + AGST_PER)
WHERE UGST_PER > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) <= 0 
BEGIN
	RETURN
END

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA	WHERE GST_PER > 0) > 0 
BEGIN
	DELETE FROM ACCBILL 
	WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
	AND Party_Code IN (SELECT ACCODE FROM Valanaccount
	WHERE ACNAME = 'SERVICE TAX')

	DELETE FROM ACCBILL 
	WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
	AND Party_Code IN (SELECT ACCODE FROM Valanaccount
	WHERE ACNAME = 'SERVICE TAX PAYABLE')

	DELETE FROM ACCBILL 
	WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
	AND PARTY_CODE IN (SELECT ACCODE FROM VALANACCOUNT WHERE ACNAME = 'ROUNDING OFF')

	UPDATE ACCBILL SET AMOUNT = ROUND(AMOUNT,2)
	WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE

END

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(CGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST'
AND Trdtype = 'N'
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST'
AND Trdtype = 'N'
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(IGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST'
AND Trdtype = 'N'
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(UGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST'
AND Trdtype = 'N'
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(UGST_PER),2) > 0 


INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(AGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST'
AND Trdtype = 'N'
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(CGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST'
AND Trdtype = 'N'
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST'
AND Trdtype = 'N'
GROUP BY ACCODE 
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(IGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE  ACNAME = STATE_CODE + '_IGST'
AND Trdtype = 'N'
GROUP BY ACCODE  
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(UGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST'
AND Trdtype = 'N'
GROUP BY ACCODE 
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(AGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST'
AND Trdtype = 'N'
GROUP BY ACCODE 
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(CGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(IGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(UGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(AGST_PER),2),BRANCH_CD,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE,BRANCH_CD 
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(CGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE 
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(SGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE  ACNAME = STATE_CODE + '_P_SGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE 
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(IGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE 
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(UGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE 
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,@SETT_NO,@SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ROUND(SUM(AGST_PER),2),BRANCH_CD='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST'
AND Trdtype = 'N'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE 
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
g.SETT_NO,g.SETT_TYPE,@START_DATE,@END_DATE,@FUNDS_PAYIN,
@FUNDS_PAYOUT,AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
BRANCHCD,NARRATION=@NARRATION
FROM ACCBILL G, VALANACCOUNT 
WHERE G.SETT_NO = @SETT_NO
AND G.SETT_TYPE = @SETT_TYPE
AND ACNAME = 'ROUNDING OFF'
AND BRANCHCD <> 'ZZZ' 
GROUP BY ACCODE,g.SETT_NO,g.SETT_TYPE,BRANCHCD 
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0 
ORDER BY BRANCHCD 

INSERT INTO ACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
g.SETT_NO,g.SETT_TYPE,@START_DATE,@END_DATE,PAYIN_DATE=@FUNDS_PAYIN,
PAYOUT_DATE=@FUNDS_PAYOUT,AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),
BRANCHCD='ZZZ',NARRATION=@NARRATION
FROM ACCBILL G, VALANACCOUNT, ACCOUNTNCE.DBO.ACMAST 
WHERE G.SETT_NO = @SETT_NO
AND G.SETT_TYPE = @SETT_TYPE
AND VALANACCOUNT.ACNAME = 'ROUNDING OFF' 
AND G.Party_Code = CLTCODE 
AND (BRANCHCD = 'ZZZ' OR ACCAT = 4)
GROUP BY ACCODE,g.SETT_NO,g.SETT_TYPE
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Delivery_ValanGenerate
-- --------------------------------------------------
CREATE PROC [dbo].[Delivery_ValanGenerate] ( @@SETT_NO VARCHAR(12),@@SETT_TYPE VARCHAR(3)) AS      
     
DECLARE      
@@ACNAME VARCHAR(50),      
@@ACCODE VARCHAR(50),      
@@CLRHSGPARTY VARCHAR(10),      
@@RNDOFFPARTY VARCHAR(10),      
@@SERTAXPARTY VARCHAR(10),      
@@BRKRELPARTY VARCHAR(10),      
@@INSSERTAXPARTY VARCHAR(10),      
@@CESSTAXPARTY VARCHAR(10),      
@@CESSTAXPAYPARTY VARCHAR(10),      
@@EDUCESSTAXPARTY VARCHAR(10),      
@@EDUCESSTAXPAYPARTY VARCHAR(10),      
@@BRKNOTEPARTY VARCHAR(10),  
@@DELCHRGPARTY VARCHAR(10),  
@@BRANCH_CD VARCHAR(10),              
@@SAUDA_DATE DATETIME,      
@@SELL_BUY INT ,      
@@MTOM NUMERIC(18,6),      
@@BROKAMT NUMERIC(18,6),         
@@SERTAX NUMERIC(18,6),      
@@EXSERTAX  NUMERIC(18,6),      
@@NETMTOM NUMERIC(18,6),      
@@NETBROKAMT NUMERIC(18,6),         
@@NETSERTAX NUMERIC(18,6),      
@@NETEXSERTAX  NUMERIC(18,6),      
@@TCESS_TAX NUMERIC(18,6),      
@@TEDUCESS_TAX NUMERIC(18,6),      
@@TEXSERVICE_TAX NUMERIC(18,6),      
@@TEXCESS_TAX NUMERIC(18,6),      
@@TEXEDUCESS_TAX NUMERIC(18,6),      
@@NETCESS_TAX NUMERIC(18,6),      
@@NETEDUCESS_TAX NUMERIC(18,6),      
@@NETEXCESS_TAX NUMERIC(18,6),      
@@NETEXEDUCESS_TAX NUMERIC(18,6),      
@@SERVICE_CHRG NUMERIC(18,6),      
@@CESS_CHRG NUMERIC(18,6),      
@@EDUCESS_CHRG NUMERIC(18,6),      
@@GROSSDIFFAMT NUMERIC(18,6),      
@@TSERVICE_TAX NUMERIC (18,9),      
@@DIFFAMT NUMERIC(18,6),      
@@BROKER_CHRG NUMERIC(18,6),  
@@NETBROKER_CHRG NUMERIC(18,6),  
@@DEL_CHRG NUMERIC(18,6),  
@@NETDEL_CHRG NUMERIC(18,6),  
@@EXPIRYDATE DATETIME,      
@@PAYINDATE DATETIME,      
@@PAYOUTDATE DATETIME,      
@@VALANACCCUR CURSOR,      
@@VALANAMTCUR CURSOR ,      
@@SETMSTCUR CURSOR 
      
/*GETTING DELIVERY BILL DATA TO DELIVERY_FOSETT TABLE*/      
EXEC DELIVERY_FOSETT_UPD @@SETT_NO,@@SETT_TYPE      
      
/*UPDATING DELIVERY_FOSETT TABLE FOR BILL NUMBER */      
EXEC DELIVERY_UPD_BILLNO @@SETT_NO,@@SETT_TYPE      
      
DELETE ACCBILL WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO      
      
      
SELECT TOP 1 @@EXPIRYDATE=EXPIRYDATE,@@PAYINDATE=EXPIRYDATE,@@PAYOUTDATE=EXPIRYDATE FROM DELIVERY_FOSETT
WHERE SETT_TYPE = @@SETT_TYPE AND SETT_NO = @@SETT_NO      
      
  
SET @@SETMSTCUR = CURSOR FOR                  
SELECT SERVICE_TAX, CESS_TAX,EDUCESS_TAX FROM FOGLOBALS  WHERE @@EXPIRYDATE >= YEAR_START_DT AND @@EXPIRYDATE <=  YEAR_END_DT                 
OPEN @@SETMSTCUR                   
FETCH NEXT FROM @@SETMSTCUR INTO @@SERVICE_CHRG, @@CESS_CHRG, @@EDUCESS_CHRG
CLOSE @@SETMSTCUR                  
DEALLOCATE @@SETMSTCUR        
      
      
INSERT INTO ACCBILL      
 SELECT PARTY_CODE,BILLNO,      
 SELL_BUY = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN (AMOUNT+SERVICE_TAX+BROKER_CHRG+OTHER_CHRG) ELSE -(AMOUNT-SERVICE_TAX-BROKER_CHRG-OTHER_CHRG) END) > 0 THEN 1 ELSE 2 END,      
 SETT_NO,SETT_TYPE,SAUDA_DATE,SAUDA_DATE,SAUDA_DATE,SAUDA_DATE,      
 ABS(ROUND(SUM(CASE WHEN SELL_BUY=1 THEN (AMOUNT+SERVICE_TAX+BROKER_CHRG+OTHER_CHRG) ELSE -(AMOUNT-SERVICE_TAX-BROKER_CHRG-OTHER_CHRG) END),2)), 
 BRANCH_ID,'BILL POSTED' FROM DELIVERY_FOSETT       
 WHERE SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO      
 GROUP BY PARTY_CODE,BRANCH_ID,BILLNO,SETT_NO,SETT_TYPE,SAUDA_DATE      
      
SET @@VALANACCCUR = CURSOR FOR SELECT ACNAME,ACCODE FROM VALANACCOUNT ORDER BY ACNAME      
OPEN @@VALANACCCUR      
FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE                
WHILE @@FETCH_STATUS = 0                 
 BEGIN      
   IF @@ACNAME = 'CLEARING HOUSE - COMM DEL'      
    SELECT @@CLRHSGPARTY = @@ACCODE      
   IF @@ACNAME = 'ROUNDING OFF'      
     SELECT @@RNDOFFPARTY = @@ACCODE      
   IF @@ACNAME = 'SERVICE TAX'      
     SELECT @@SERTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'INCLUSIVE SERVICE TAX'      
     SELECT @@INSSERTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'BROKERAGE REALISED'    
		SELECT @@BRKRELPARTY = @@ACCODE      
   IF @@ACNAME = 'CESS TAX'      
     SELECT @@CESSTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'EDU CESS TAX'      
     SELECT @@EDUCESSTAXPARTY = @@ACCODE      
   IF @@ACNAME = 'CESS TAX PAYABLE'       
      SELECT @@CESSTAXPAYPARTY = @@ACCODE      
   IF @@ACNAME = 'EDU CESS TAX PAYABLE'       
      SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE      
   IF @@ACNAME = 'STAMP DUTY'  
      SELECT @@BRKNOTEPARTY = @@ACCODE  
   IF @@ACNAME = 'DELIVERY CHARGES'  
      SELECT @@DELCHRGPARTY = @@ACCODE  
      
   FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE                
 END      
CLOSE @@VALANACCCUR                
DEALLOCATE @@VALANACCCUR     
      
SELECT @@NETMTOM = 0      
SELECT @@NETBROKAMT = 0      
SELECT @@NETSERTAX = 0      
SELECT @@NETEXSERTAX = 0      
SELECT @@NETCESS_TAX = 0      
SELECT @@NETEDUCESS_TAX = 0      
SELECT @@TCESS_TAX = 0       
SELECT @@TEDUCESS_TAX = 0       
SELECT @@TEXCESS_TAX = 0      
SELECT @@TEXEDUCESS_TAX = 0      
SELECT @@NETEXCESS_TAX = 0       
SELECT @@NETEXEDUCESS_TAX = 0       
SELECT @@NETBROKER_CHRG = 0  
SELECT @@NETDEL_CHRG = 0  
  
SET @@VALANAMTCUR = CURSOR FOR      
 SELECT SAUDA_DATE,BRANCH_ID,      
 SUM((CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE - TRADEQTY END)* PRICE * BOOKTYPE / INSTRUMENT  ),      
 SUM(BROKAPPLIED),SUM(SERVICE_TAX),SUM(NSERTAX),SUM(BROKER_CHRG),SUM(OTHER_CHRG) FROM DELIVERY_FOSETT       
 WHERE SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO      
 GROUP BY SAUDA_DATE,BRANCH_ID      
      
OPEN @@VALANAMTCUR      
      
FETCH NEXT FROM @@VALANAMTCUR INTO @@SAUDA_DATE,@@BRANCH_CD,@@MTOM,@@BROKAMT,@@SERTAX,@@EXSERTAX,@@BROKER_CHRG ,@@DEL_CHRG
 WHILE @@FETCH_STATUS = 0               
 BEGIN      
   IF @@MTOM > 0               
     SELECT @@SELL_BUY = 2                
   ELSE              
	SELECT @@SELL_BUY = 1      

	SELECT @@NETMTOM = @@NETMTOM + @@MTOM      
	SELECT @@NETBROKAMT = @@BROKAMT + @@NETBROKAMT      
	
	
    IF 	@@CESS_CHRG <> 0 AND @@EDUCESS_CHRG <> 0
	BEGIN
	SELECT @@TCESS_TAX = @@SERTAX - ROUND(( @@SERTAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)          
	SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)          
	END
	ELSE 
	BEGIN 
	SELECT @@TCESS_TAX = 0
	SELECT @@TEDUCESS_TAX = 0
	END 

	SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX         
	SELECT @@TSERVICE_TAX = @@SERTAX - @@TCESS_TAX - @@TEDUCESS_TAX       
	
	SELECT @@TEXCESS_TAX = 0
	SELECT @@TEXEDUCESS_TAX = 0
	SELECT @@TEXCESS_TAX = 0
	SELECT @@TEXSERVICE_TAX = 0
	
	SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX          
	SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX          
	SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX           
	SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX           
	
	
	SELECT @@NETSERTAX = @@TSERVICE_TAX + @@NETSERTAX      
	SELECT @@NETEXSERTAX = @@TEXSERVICE_TAX + @@NETEXSERTAX      


   SELECT @@NETBROKER_CHRG = @@NETBROKER_CHRG + @@BROKER_CHRG  
    SET @@NETDEL_CHRG = @@NETDEL_CHRG + @@DEL_CHRG  
  
  
   INSERT INTO ACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@MTOM),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@BROKAMT),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@TSERVICE_TAX),2),@@BRANCH_CD,'BILL POSTED')                         
      
   INSERT INTO ACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@TEXSERVICE_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      
   INSERT INTO ACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@BROKER_CHRG),2),@@BRANCH_CD,'BILL POSTED')      

	IF @@DEL_CHRG > 0
	BEGIN
		SET @@SELL_BUY = 2
	END
	ELSE
	BEGIN
		SET @@SELL_BUY = 1
	END
	
   INSERT INTO ACCBILL VALUES ( @@DELCHRGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@DEL_CHRG),2),@@BRANCH_CD,'BILL POSTED')      
      
      
  
   IF ROUND(@@TCESS_TAX,2) <> 0                 
   BEGIN          
    INSERT INTO ACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
   END      
   IF ROUND(@@TEXCESS_TAX,2) <> 0                
      BEGIN      
    INSERT INTO ACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEXCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      END      


   IF ROUND(@@TEDUCESS_TAX,2) <> 0                 
   BEGIN          
    INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEDUCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
   END      
   IF ROUND(@@TEXEDUCESS_TAX,2) <> 0                
      BEGIN      
    INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
           ROUND(ABS(@@TEXEDUCESS_TAX),2),@@BRANCH_CD,'BILL POSTED')      
      END      


  FETCH NEXT FROM @@VALANAMTCUR INTO @@SAUDA_DATE,@@BRANCH_CD,@@MTOM,@@BROKAMT,@@SERTAX,@@EXSERTAX,@@BROKER_CHRG,@@DEL_CHRG      
 END      
CLOSE @@VALANAMTCUR      
DEALLOCATE @@VALANAMTCUR      
      
 IF @@NETMTOM > 0               
  SELECT @@SELL_BUY = 2                
 ELSE              
  SELECT @@SELL_BUY = 1              
 INSERT INTO ACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
         ROUND(ABS(@@NETMTOM),2),'ZZZ','BILL POSTED')      
      
 INSERT INTO ACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETBROKAMT),2),'ZZZ','BILL POSTED')                         
      
 INSERT INTO ACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETSERTAX),2),'ZZZ','BILL POSTED')                         
      
 INSERT INTO ACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETEXSERTAX),2),'ZZZ','BILL POSTED')                         
      
 IF ROUND(@@NETCESS_TAX,2) <> 0                 
  BEGIN          
   INSERT INTO ACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@NETCESS_TAX),2),'ZZZ','BILL POSTED')      
  END      
 IF ROUND(@@NETEXCESS_TAX,2) <> 0                
 BEGIN      
   INSERT INTO ACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
   ROUND(ABS(@@NETEXCESS_TAX),2),'ZZZ','BILL POSTED')      
 END      

 IF ROUND(@@NETEDUCESS_TAX,2) <> 0                 
  BEGIN          
   INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
          ROUND(ABS(@@NETEDUCESS_TAX),2),'ZZZ','BILL POSTED')      
  END      
 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0                
 BEGIN      
   INSERT INTO ACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
   ROUND(ABS(@@NETEXEDUCESS_TAX),2),'ZZZ','BILL POSTED')      
 END      

  
 INSERT INTO ACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
 ROUND(ABS(@@NETBROKER_CHRG),2),'ZZZ','BILL POSTED')      

IF @@NETDEL_CHRG > 0
BEGIN
	SET @@SELL_BUY = 2
END
ELSE
BEGIN
	SET @@SELL_BUY = 1
END

INSERT INTO ACCBILL VALUES ( @@DELCHRGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@EXPIRYDATE,@@PAYINDATE,@@PAYOUTDATE,      
      ROUND(ABS(@@NETDEL_CHRG),2),'ZZZ','BILL POSTED')
      
SELECT @@GROSSDIFFAMT = 0      
SELECT @@DIFFAMT = 0      
 
SET @@VALANAMTCUR = CURSOR FOR      
      
SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM ACCBILL A,ACCOUNTNCE.DBO.ACMAST M               
WHERE SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO      
AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )              
GROUP BY SELL_BUY      
      
OPEN @@VALANAMTCUR               
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
WHILE @@FETCH_STATUS = 0                
BEGIN              
 BEGIN              
  IF @@SELL_BUY = 1               
  BEGIN                
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT              
  END               
  ELSE              
  BEGIN                                  
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                       
  END              
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY              
 END              
END              
CLOSE @@VALANAMTCUR              
DEALLOCATE @@VALANAMTCUR              
              
IF @@GROSSDIFFAMT > 0               
 INSERT INTO ACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,              
        ROUND(ABS(@@GROSSDIFFAMT),2),'ZZZ','BILL POSTED')      
ELSE               
 INSERT INTO ACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,@@SAUDA_DATE,              
        ROUND(ABS(@@GROSSDIFFAMT),2),'ZZZ','BILL POSTED')              
      
DELETE FROM ACCBILL WHERE AMOUNT = 0 AND SETT_TYPE=@@SETT_TYPE AND SETT_NO=@@SETT_NO      

EXEC VALAN_ADDITIONAL_PROCESS @@SAUDA_DATE

Exec [DELIVERY_VALAN_GST_BILLPOST] @@SETT_NO,@@SETT_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELPROBABLESHORTAGE
-- --------------------------------------------------

CREATE PROC [DBO].[DELPROBABLESHORTAGE] ( @OPTIONFLAG  INT = 0) AS                                   
DECLARE                                   
@SETT_NO VARCHAR(7),                                  
@SETT_TYPE VARCHAR(2),          
@PARTY_CODE VARCHAR(10),                                  
@SCRIP_CD VARCHAR(12),                                  
@SCRIPCODE VARCHAR(12),                                  
@SERIES VARCHAR(3),                                  
@SCRIPNAME VARCHAR(50),                                  
@ISIN VARCHAR(12),                                  
@EXCHG VARCHAR(3),                                  
@QTY NUMERIC(18,4),                                  
@PQTY  NUMERIC(18,4),                                  
@DQTY  NUMERIC(18,4),                                  
@CQTY  NUMERIC(18,4),                                  
@IQTY  NUMERIC(18,4),                                  
@DPTYPE VARCHAR(4),                                  
@DPID VARCHAR(8),                                  
@CLTDPID VARCHAR(16),                                  
@POAFLAG INT,                                   
@Sec_PayIn DATETIME,                                  
@STATUS VARCHAR(10),                                  
@SETTCUR CURSOR,                                  
@DELCUR CURSOR,            
@NSECURSETTNO VARCHAR(7) ,          
@DUMMY1 VARCHAR(1),          
@DUMMY2 INT          
          
SELECT @DQTY = 0                                   
SELECT @CQTY = 0                                   
SELECT @IQTY = 0                                   
SELECT @SCRIP_CD = '0'                                  
                                  
SELECT @DPTYPE = ''                                  
SELECT @DPID = ''                                  
SELECT @CLTDPID = ''                                  
SELECT @POAFLAG = 0                                  
    
--SELECT @OPTIONFLAG = 0    
        
SELECT *, P_FLAG = 1 INTO #DELCDSLBALANCE FROM DELCDSLBALANCE            
WHERE 1 = 2            
          
IF @OPTIONFLAG = 0          
BEGIN                          
 UPDATE DELCDSLBALANCE SET PARTY_CODE = 'PARTY', TOTALBALANCE = FREEBAL                           
                         
 UPDATE DELCDSLBALANCE SET PARTY_CODE = M.PARTY_CODE FROM MULTICLTID M                          
 WHERE M.CLTDPNO = CLTDPID                           
 AND DELCDSLBALANCE.DPID = M.DPID                          
 AND DEF = 1                                   
                         
 DELETE FROM DELCDSLBALANCE WHERE PARTY_CODE = 'PARTY'                        
          
 INSERT INTO  #DELCDSLBALANCE          
 SELECT *, P_FLAG = 1 FROM DELCDSLBALANCE          
          
 UPDATE #DELCDSLBALANCE SET P_FLAG = 0            
 FROM CLIENT4 C4            
 WHERE C4.PARTY_CODE = #DELCDSLBALANCE.PARTY_CODE            
 AND C4.BANKID = #DELCDSLBALANCE.DPID            
 AND C4.CLTDPID = #DELCDSLBALANCE.CLTDPID            
 AND DEFDP = 1            
END          
              
TRUNCATE TABLE DELPOASHORTAGE            
TRUNCATE TABLE DELPOATEMP_NEW                                  
              
SELECT * INTO #NSESETT_MST              
FROM SETT_MST              
WHERE Expiry_Date <= GETDATE() + 1 AND Sec_PayIn + 1 >= GETDATE()                                 
AND SETT_TYPE = 'G'           
            
SELECT @NSECURSETTNO = SETT_NO FROM #NSESETT_MST           
WHERE TRD_START_DATE = (SELECT MAX(TRD_START_DATE) FROM #NSESETT_MST WHERE TRD_START_DATE <= LEFT(GETDATE(), 11))          
AND SETT_TYPE = 'G'          
      
SELECT D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,D.SCRIP_CD,DELQTY=D.QTY,RECQTY=SUM(ISNULL(C.QTY,0)),                
ISETTQTY = 0,IBENQTY=0                      
INTO #NSE_DELPAYINMATCH FROM #NSESETT_MST N, DELIVERYCLT D LEFT OUTER JOIN DELTRANS C                      
ON ( D.SETT_NO = C.SETT_NO AND D.SETT_TYPE = C.SETT_TYPE                      
AND D.SCRIP_CD = C.SCRIP_CD AND D.SERIES = C.SERIES                       
AND D.PARTY_CODE = C.PARTY_CODE AND DRCR = 'C'                       
AND FILLER2 = 1 AND SHARETYPE <> 'AUCTION' )                  
WHERE INOUT = 'I'          
AND N.SETT_NO = D.SETT_NO              
AND N.SETT_TYPE = D.SETT_TYPE              
GROUP BY D.SETT_NO,D.SETT_TYPE,D.PARTY_CODE,D.QTY,D.SCRIP_CD      
HAVING D.QTY > 0               
            
INSERT INTO #NSE_DELPAYINMATCH            
SELECT SETT_NO=@NSECURSETTNO,D.SETT_TYPE,D.PARTY_CODE,SCRIP_CD,DELQTY=0,RECQTY=D.QTY,                
ISETTQTY = 0,IBENQTY=0           
FROM DELIVERYCLT D, (    SELECT SETT_NO, SETT_TYPE FROM #NSESETT_MST            
WHERE Sec_PayIn = (SELECT MAX(Sec_PayIn)            
FROM #NSESETT_MST WHERE TRD_START_DATE < LEFT(GETDATE(), 11) )) N            
WHERE N.SETT_NO = D.SETT_NO              
AND N.SETT_TYPE = D.SETT_TYPE            
AND INOUT = 'O'             
              
INSERT INTO #NSE_DELPAYINMATCH              
SELECT ISETT_NO,ISETT_TYPE,PARTY_CODE,SCRIP_CD,QTY=0,RECQTY=0,                
ISETTQTY=SUM(CASE WHEN TRTYPE <> 1000 THEN QTY ELSE 0 END),                
IBENQTY=SUM(CASE WHEN TRTYPE = 1000 THEN QTY ELSE 0 END)              
FROM DELTRANS D, #NSESETT_MST S              
WHERE FILLER2 = 1 AND DRCR = 'D' AND DELIVERED <> 'D' AND TRTYPE IN (907,908,1000) AND CERTNO <> 'AUCTION'                      
AND D.ISETT_NO = S.SETT_NO              
AND D.ISETT_TYPE = S.SETT_TYPE              
GROUP BY ISETT_NO,ISETT_TYPE,PARTY_CODE,SCRIP_CD          
          
          
INSERT INTO DELPOATEMP_NEW                                  
SELECT R.SETT_NO,R.SETT_TYPE,R.PARTY_CODE,SCRIPNAME=SCRIP_CD,SCRIP_CD,SERIES='',QTY=SUM(DELQTY-RECQTY-ISETTQTY-IBENQTY),ISIN='',                                  
EXCHG='NSP',Sec_PayIn,STATUS = ( CASE WHEN PAYOUT_DATE < GETDATE() THEN 'CONFIRM' ELSE 'PROBABLE' END ), '', ''                        
FROM #NSE_DELPAYINMATCH R, #NSESETT_MST S                              
WHERE S.SETT_NO = R.SETT_NO AND S.SETT_TYPE = R.SETT_TYPE                                   
AND Expiry_Date <= GETDATE() + 1 AND Sec_PayIn + 1 >= GETDATE()                                   
AND S.SETT_TYPE NOT IN ('A','X')                                  
GROUP BY R.SETT_NO,R.SETT_TYPE,R.PARTY_CODE,SCRIP_CD,Sec_PayIn, PAYOUT_DATE                                  
HAVING SUM(DELQTY-RECQTY-ISETTQTY-IBENQTY) > 0                                                              
          
UPDATE DELPOATEMP_NEW SET CLTDPID = M.CLTDPNO,                        
DPID = M.DPID FROM MULTICLTID M                          
WHERE DELPOATEMP_NEW.PARTY_CODE = M.PARTY_CODE                     
AND DEF = 1                        
		

UPDATE DELPOATEMP_NEW SET ISIN = M.ISIN
FROM DELIVERY_MULTIISIN M 
WHERE DELPOATEMP_NEW.SCRIP_CD = M.SYMBOL  
AND M.STATUS = 'P'                        

IF @OPTIONFLAG = 0                   
BEGIN                  
 SET @SETTCUR = CURSOR FOR                                  
 SELECT SETT_NO,SETT_TYPE,PARTY_CODE,SCRIPNAME,SCRIP_CD,SERIES,QTY,EXCHG,START_DATE,STATUS, DPID, CLTDPID FROM DELPOATEMP_NEW                                  
 ORDER BY DPID, CLTDPID, ISIN, START_DATE, EXCHG                  
 OPEN @SETTCUR                                  
 FETCH NEXT FROM @SETTCUR INTO @SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIPNAME,@SCRIP_CD,@SERIES,          
          @QTY,@EXCHG,@Sec_PayIn,@STATUS,@DPID,@CLTDPID                        
 WHILE @@FETCH_STATUS = 0                                   
 BEGIN                                  
                                   
  SELECT @PQTY = @QTY                                   
  IF @PQTY > 0                                  
  BEGIN                                  
   SELECT @DQTY = 0                                   
   SET @DELCUR = CURSOR FOR                                  
             
   SELECT TOTALBALANCE,DPID,CLTDPID,ISIN_FLAG=M.STATUS,P_FLAG,M.ISIN FROM #DELCDSLBALANCE D, DELIVERY_MULTIISIN  M          
   WHERE D.ISIN = M.ISIN    
   AND PARTY_CODE = @PARTY_CODE AND @STATUS <> 'CONFIRM'            
   AND TOTALBALANCE > 0 AND M.SYMBOL = @SCRIP_CD           
   ORDER BY P_FLAG,M.STATUS                                  
      
   OPEN @DELCUR                                  
   FETCH NEXT FROM @DELCUR INTO @DQTY,@DPID,@CLTDPID,@DUMMY1,@DUMMY2,@ISIN                                 
   WHILE @@FETCH_STATUS = 0 AND @PQTY > 0            
             
    BEGIN                                 
  IF @DQTY >= @PQTY                                   
  BEGIN                                  
  INSERT INTO DELPOASHORTAGE VALUES (@SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIPNAME,@SCRIP_CD,@SERIES,          
           @QTY,@ISIN,@EXCHG,'0',@PQTY,@DQTY,@DPTYPE,@DPID,@CLTDPID,@POAFLAG,@Sec_PayIn,@STATUS)            
                                 
  UPDATE #DELCDSLBALANCE SET TOTALBALANCE = @DQTY - @PQTY             
  WHERE PARTY_CODE = @PARTY_CODE AND ISIN = @ISIN                                   
  AND DPID = @DPID AND CLTDPID = @CLTDPID            
          
  UPDATE DELCDSLBALANCE SET TOTALBALANCE = @DQTY - @PQTY             
  WHERE PARTY_CODE = @PARTY_CODE AND ISIN = @ISIN                                   
  AND DPID = @DPID AND CLTDPID = @CLTDPID          
          
    SET @PQTY = 0                                 
    END                                  
    ELSE                                  
    BEGIN                                  
   INSERT INTO DELPOASHORTAGE VALUES (@SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIPNAME,@SCRIP_CD,@SERIES,          
           @QTY,@ISIN,@EXCHG,'0',@PQTY,@DQTY,@DPTYPE,@DPID,@CLTDPID,@POAFLAG,@Sec_PayIn,@STATUS)          
                                   
   UPDATE #DELCDSLBALANCE SET TOTALBALANCE = 0           
   WHERE PARTY_CODE = @PARTY_CODE AND ISIN = @ISIN                                   
   AND DPID = @DPID AND CLTDPID = @CLTDPID           
          
   UPDATE DELCDSLBALANCE SET TOTALBALANCE = 0           
   WHERE PARTY_CODE = @PARTY_CODE AND ISIN = @ISIN                                   
   AND DPID = @DPID AND CLTDPID = @CLTDPID           
             
   SET @PQTY = @PQTY - @DQTY                               
    END             
  FETCH NEXT FROM @DELCUR INTO @DQTY,@DPID,@CLTDPID,@DUMMY1,@DUMMY2,@ISIN                  
   END                                  
   CLOSE @DELCUR                                    
  END                                   
  FETCH NEXT FROM @SETTCUR INTO @SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIPNAME,@SCRIP_CD,@SERIES,          
        @QTY,@EXCHG,@Sec_PayIn,@STATUS,@DPID,@CLTDPID                                  
 END                                  
END                  
ELSE                  
BEGIN                  
 INSERT INTO DELPOASHORTAGE                  
 SELECT SETT_NO,SETT_TYPE,PARTY_CODE,SCRIPNAME,SCRIP_CD,SERIES='',QTY,ISIN,EXCHG,SCRIPCODE='0',                  
 TORECQTY=QTY,BALANCE=QTY,DPTYPE='',DPID,CLTDPID,POAFLAG=0,START_DATE,STATUS                  
 FROM DELPOATEMP_NEW                  
 WHERE STATUS = 'PROBABLE'                  
 AND DPID <> ''                  
END                

UPDATE DELPOASHORTAGE SET POAFLAG = 1, DPTYPE = M.DPTYPE FROM MULTICLTID M           
WHERE DEF = 1 AND DELPOASHORTAGE.PARTY_CODE = M.PARTY_CODE                                   
AND DELPOASHORTAGE.DPID = M.DPID AND DELPOASHORTAGE.CLTDPID = M.CLTDPNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EMail_GetParty_NSEFO
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.EMail_GetParty_NSEFO    Script Date: 1/17/2004 11:42:37 PM ******/





CREATE  PROCEDURE [dbo].[EMail_GetParty_NSEFO]

@ReportFlag VarChar (50),
@PartyFrom VarChar(50),
@PartyTo VarChar (50),
@ReportDate VarChar(20),
@SettType VarChar (20),
@DateFrom VarChar (20),
@DateTo VarChar (20),
@SettNo VarChar (20)

AS
If @ReportFlag='Confirmation'
Begin/*CONFIRMATION REPORT*/
	Select Distinct S.Party_Code,EMail From FoSettlement S,Client1 C1, Client2 C2, Email_PartyReport E
		Where C1.Cl_Code = C2.Cl_Code and S.Party_Code = C2.Party_Code And E.EMail_Party_Code = S.Party_Code And Sauda_Date Like @ReportDate + '%' And S.Party_Code >= @PartyFrom
		And S.Party_Code <= @PartyTo Order By S.Party_Code
End/*CONFIRMATION REPORT*/
Else
Begin
	If @ReportFlag='Bill'
	Begin/*BILL REPORT*/
		Select Distinct S.Party_Code,EMail From FoAccBill S,Client1 C1, Client2 C2, Email_PartyReport E
			Where C1.Cl_Code = C2.Cl_Code and S.Party_Code = C2.Party_Code And E.EMail_Party_Code = S.Party_Code And Convert(Varchar,BillDate,106) = @ReportDate
			And S.Party_Code >= @PartyFrom And S.Party_Code <= @PartyTo Order By S.Party_Code
	End/*BILL REPORT*/
	Else
	Begin
		If @ReportFlag='NetPosition'
		Begin/*NET POS REPORT*/
			Select Distinct C2.Party_Code,EMail From Client1 C1, Client2 C2,Email_PartyReport E
				Where C1.Cl_Code = C2.Cl_Code and E.EMail_Party_Code = C2.Party_Code And C2.Party_Code >= @PartyFrom And C2.Party_Code <= @PartyTo Order By C2.Party_Code  
		End/*NET POS REPORT*/
		Else
		Begin
			If @ReportFlag='ClientSummary'
			Begin/*CLIENT SUMMARY*/
				Select Distinct C2.Party_Code,EMail From Client1 C1, Client2 C2,Email_PartyReport E
					Where C1.Cl_Code = C2.Cl_Code and E.EMail_Party_Code = C2.Party_Code And C2.Party_Code >= @PartyFrom And C2.Party_Code <= @PartyTo Order By C2.Party_Code  
			End/*CLIENT SUMMARY*/
			Else
			Begin
				If @ReportFlag='Ledger'
				Begin/*LEDGER*/
					Select Distinct C2.Party_Code,EMail From Client1 C1, Client2 C2,Email_PartyReport E, ACCOUNTNCE.DBO.Ledger L
						Where C1.Cl_Code = C2.Cl_Code and E.EMail_Party_Code = C2.Party_Code And C2.Party_Code >= @PartyFrom And C2.Party_Code <= @PartyTo 
						And L.CltCode = C2.Party_Code and L.Vamt > 0 
						Order By C2.Party_Code  
				End/*LEDGER*/
				Else
				Begin
					If @ReportFlag='ClientMargin'
					Begin/*CLIENT MARGIN*/
						Select Distinct C2.Party_Code,EMail From Client1 C1, Client2 C2,Email_PartyReport E
							Where C1.Cl_Code = C2.Cl_Code and E.EMail_Party_Code = C2.Party_Code And C2.Party_Code >= @PartyFrom And C2.Party_Code <= @PartyTo Order By C2.Party_Code  
					End/*CLIENT MARGIN*/
					Else
					Begin
						Begin/*DEFAULT*/
							Select Distinct C2.Party_Code,EMail From Client1 C1, Client2 C2,Email_PartyReport E
								Where C1.Cl_Code = C2.Cl_Code and E.EMail_Party_Code = C2.Party_Code And C2.Party_Code >= @PartyFrom And C2.Party_Code <= @PartyTo Order By C2.Party_Code  
						End/*DEFAULT*/
					End
				End
			End
		End
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ExecuteSQL_ByAgentJob_usp
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[ExecuteSQL_ByAgentJob_usp](
    @SqlStatemet            VARCHAR(4000),
    @SPNameOrStmntTitle     VARCHAR(100),
    @JobRunningUser         VARCHAR(100) = NULL,
    @JobIdOut               UNIQUEIDENTIFIER OUTPUT
)
AS
BEGIN
	
	SET NOCOUNT ON
	
	DECLARE @JobId          UNIQUEIDENTIFIER,
			@JobName        VARCHAR(250),
			@DBName         VARCHAR(100),
			@ServerName     VARCHAR(100) 
	
	SET @JOBNAME = NULL
	SET @DBName = DB_NAME()
	SET @ServerName = @@SERVERNAME

	--Creating Unique Job Name by combining @SPNameOrStmntTitle and a GUID.		
	SET @JobName = @SPNameOrStmntTitle + '_' + CONVERT(VARCHAR(64), NEWID()) 
	
	--Currently logged user name will be used to execute the job if not provided one.
	IF @JobRunningUser IS NULL
		SET @JobRunningUser = SUSER_NAME()
	
	--Adds a new job executed by the SQLServerAgent service
	EXECUTE msdb..sp_add_job @job_name = @JobName, @owner_login_name = @JobRunningUser, 
	@job_id = @JobId OUTPUT 
	
	--Targets the specified job at the specified server 
	EXECUTE msdb..sp_add_jobserver @job_id = @JobId, @server_name = @ServerName 
	
	--Tell job for its about its first step.
	EXECUTE msdb..sp_add_jobstep @job_id = @JobId, @step_name = 'Step1', @command 
	= @SqlStatemet,@database_name = @DBName, @on_success_action = 3 
	
	--Preparing the command to delete the job immediately after executing the statements 
	DECLARE @sql VARCHAR(250) 
	
	SET @SQL = 'execute msdb..sp_delete_job @job_name=''' + @JobName + ''''
	
	EXECUTE msdb..sp_add_jobstep @job_id = @JobId, @step_name = 'Step2', @command = @sql 
	
	--Run the job
	EXECUTE msdb..sp_start_job @job_id = @JobId
	
	--Return the Job via output param.
	SET @JobIdOut = @JobId
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_AGTS_DATA_EXTRA
-- --------------------------------------------------


CREATE	PROC [dbo].[FETCH_AGTS_DATA_EXTRA]
		(
		@FROMDATE		VARCHAR(11),
		@TODATE			VARCHAR(11),
		@FNOBILL_FLAG	INT = 0 -- 1 : CONTRACT CUM BILL , 0 - CONTRACT ONLY
		)
		
		AS


		DECLARE @EXCHANGECODE	VARCHAR(3)		
		SELECT  TOP 1 @EXCHANGECODE= EXCHANGE FROM FOGLOBALS (NOLOCK)


		IF @FNOBILL_FLAG = 1 -- CONTRACT CUM BILL ENABLED
		BEGIN	
			SELECT 
				CONTRACTNO,
				CONTRACTNO_NEW = CONTRACTNO,
				SAUDA_DATE,
				SETT_NO = '',
				SETT_TYPE = '',
				SETT_DATE = '',
				EXCHANGE = @EXCHANGECODE ,
				SEGMENT = 'FUTURES',
				ORDER_NO = '',
				ORDER_TIME = '',
				TRADE_NO = '',
				TRADE_TIME='',
				SCRIPNAME = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
								ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
								+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 	END),
				QTY=ABS(SUM(PQTY-SQTY)),
				TMARK= '0',
				SELL_BUY=(CASE WHEN SUM(PQTY-SQTY) > 0 THEN 1 ELSE 2 END),
				--MARKETRATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PAMT+SAMT)/SUM(PQTY+SQTY) ELSE 0 END),
				--MARKETAMT = SUM(PAMT+SAMT),
				MARKETRATE = (SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END))/ 
							(CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PQTY-SQTY) ELSE 1 END),
				MARKETAMT = SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END),
				
				BROKERAGE = SUM(PBROKAMT-SBROKAMT),
				SERVICE_TAX = SUM(SERVICE_TAX),
				INS_CHRG = SUM(INS_CHRG),
				NETAMOUNT	= SUM(SBILLAMT-PBILLAMT),
				SEBI_TAX = SUM(SEBI_TAX),
				TURN_TAX = SUM(TURN_TAX),
				BROKER_CHRG = SUM(BROKER_NOTE),
				OTHER_CHRG = SUM(D.OTHER_CHRG),
				NETAMOUNTALL= 0,
				BROK  = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PBROKAMT-SBROKAMT)/SUM(PQTY-SQTY) ELSE 0 END),
				NETRATE = 0,
				CL_RATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN  ABS(SUM((PQTY-SQTY)*CL_RATE) / SUM(PQTY-SQTY)) ELSE 0 END), 
				BROKERSEBIREGNO = O.BROKERSEBIREGNO,
				MEMBERCODE = O.MEMBERCODE,
				CINNO = O.CIN,
				SETTTYPE_DESC='',
				BFCF_FLAG = 'BF_'+LEFT(INST_TYPE,1), 
				CONTRACT_HEADER_DET = '', 
				REMARK = '', 
				COMPANYNAME = O.COMPANY, USER_ID='', 
				REMARK_ID	= '', 
				REMARK_DESC = '', 
				NETOBLIGATION = 0,
				M.BRANCH_CD, 
				M.SUB_BROKER, 
				M.TRADER, 
				M.AREA, 
				M.REGION, 
				M.FAMILY, 
				PARTY_CODE= D.PARTY_CODE,
				PARTYNAME = LONG_NAME,
				M.L_ADDRESS1,
				M.L_ADDRESS2,
				M.L_ADDRESS3,
				M.L_STATE,
				M.L_CITY,
				M.L_ZIP,
				M.OFF_PHONE1,
				M.OFF_PHONE2,
				M.PAN_GIR_NO,
				MAPIDID = '',
				UCC_CODE= '',
				SEBI_NO = FD_CODE,
				PARTICIPANT_CODE = BANKID,
				M.CL_TYPE,
				SERVICE_CHRG,
				PRINTF,
				M.CL_STATUS,
				ISIN = '',
				PRICEUNIT = NUMERATOR,
				QTY_UNIT = DENOMINATOR
			FROM 
				 FOBILLVALAN D WITH (NOLOCK),
				 DBO.CLIENT1 M WITH (NOLOCK),
				 DBO.FOOWNER O WITH (NOLOCK),
				 DBO.CLIENT2 C2 WITH (NOLOCK)
			WHERE
				M.CL_CODE = C2.PARTY_CODE
				AND M.CL_CODE = D.PARTY_CODE
				AND M.CL_TYPE <> 'INS'
				AND LEFT(INST_TYPE,3) = 'FUT' 
				AND D.SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
				AND (TRADETYPE = 'BF' OR (TRADETYPE = 'BT' AND (PQTY-SQTY) <> 0 AND AUCTIONPART='CA' ))
			GROUP BY 
				CONTRACTNO, SAUDA_DATE, M.BRANCH_CD,  M.SUB_BROKER, 
				M.TRADER, M.AREA,  M.REGION,  M.FAMILY,  D.PARTY_CODE,
				LONG_NAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3, M.L_STATE,
				M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2, M.PAN_GIR_NO,
				FD_CODE, BANKID, M.CL_TYPE, SERVICE_CHRG, PRINTF, 
				CASE 
					WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
					ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
					+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
				END,LEFT(INST_TYPE,1),
				O.BROKERSEBIREGNO,O.MEMBERCODE,
				O.CIN,BRANCH_CD,M.SUB_BROKER,
				O.COMPANY,M.CL_STATUS,
				NUMERATOR,
				DENOMINATOR
			HAVING 
				SUM(PQTY-SQTY) <> 0 
		
			UNION ALL
			
			SELECT 
				CONTRACTNO,
				CONTRACTNO_NEW = CONTRACTNO,
				SAUDA_DATE,
				SETT_NO = '',
				SETT_TYPE = '',
				SETT_DATE = '',
				EXCHANGE = @EXCHANGECODE ,
				SEGMENT = 'FUTURES',
				ORDER_NO,
				ORDER_TIME,
				TRADE_NO,
				TRADE_TIME=TRADETIME,
				SCRIPNAME = (
				CASE 
					WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
					ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
					+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
				END),
				QTY	=PQTY+SQTY,
				--TMARK	= ORDFLG,
				TMARK = '0',
				SELL_BUY ,
				MARKETRATE = PRATE+SRATE,
				MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
				BROKERAGE,
				SERVICE_TAX,
				INS_CHRG,
				NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
							THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
							ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
				SEBI_TAX,
				TURN_TAX,
				BROKER_CHRG,
				D.OTHER_CHRG,
				NETAMOUNTALL = (
				CASE 
					WHEN SELL_BUY = 1 THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
					ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
				END),
				BROK = BROKERAGE,
				/*NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PNETRATE ELSE 0 END) 
						ELSE (CASE WHEN SQTY >0 THEN SNETRATE ELSE 0 END) END),*/
				NETRATE = (
				CASE
					WHEN SELL_BUY = 1 THEN (CASE WHEN PQTY > 0 THEN (PRATE+(BROKERAGE/PQTY))ELSE PRATE END)
					ELSE (CASE WHEN SQTY > 0 THEN (SRATE-(BROKERAGE/SQTY)) ELSE SRATE END)
				END),
				CL_RATE = CONT_CL_RATE, 
				BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
				CONTRACT_HEADER_DET = '', REMARK = '', 
				COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
				REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
				NETOBLIGATION = 0, 
				M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
				M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
				M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
				M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
				M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
				PARTICIPANT_CODE = '',
				CL_TYPE,
				M.SERVICE_CHRG,
				M.PRINTF,CL_STATUS,
				ISIN = '',
				PRICEUNIT = 1,
				QTY_UNIT = 1
			FROM 
				CONTRACT_DATA D WITH (NOLOCK),
				CONTRACT_MASTER M WITH (NOLOCK),
				DBO.FOOWNER O WITH (NOLOCK)
			WHERE
				M.TRADE_DATE  = D.SAUDA_DATE
				AND M.PARTY_CODE = D.PARTY_CODE
				AND D.SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
			ORDER BY
				SAUDA_DATE,D.PARTY_CODE
		END
		ELSE
		BEGIN
			SELECT 
				CONTRACTNO,
				CONTRACTNO_NEW = CONTRACTNO,
				SAUDA_DATE,
				SETT_NO = '',
				SETT_TYPE = '',
				SETT_DATE = '',
				EXCHANGE = @EXCHANGECODE ,
				SEGMENT = 'FUTURES',
				ORDER_NO,
				ORDER_TIME,
				TRADE_NO,
				TRADE_TIME=TRADETIME,
				SCRIPNAME = (
				CASE 
				WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
				ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
				+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
				END),
				QTY	=PQTY+SQTY,
				TMARK	= ORDFLG,
				SELL_BUY ,
				MARKETRATE = PRATE+SRATE,
				MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
				BROKERAGE,
				SERVICE_TAX,
				INS_CHRG,
				NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
							THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
							ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
				SEBI_TAX,
				TURN_TAX,
				BROKER_CHRG,
				D.OTHER_CHRG,
				NETAMOUNTALL = (CASE WHEN SELL_BUY = 1
							THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
							ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
							END),
				BROK = BROKERAGE,
				/*NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END) 
						ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),*/
				NETRATE = (PNETRATE+SNETRATE),		
				CL_RATE = CONT_CL_RATE, 
				BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
				CONTRACT_HEADER_DET = '', REMARK = '', 
				COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
				REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
				NETOBLIGATION = 0, 
				M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
				M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
				M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
				M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
				M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
				PARTICIPANT_CODE = '',
				CL_TYPE,
				M.SERVICE_CHRG,
				M.PRINTF,CL_STATUS,
				ISIN = '',
				PRICEUNIT = 1,
				QTY_UNIT = 1
			FROM 
				CONTRACT_DATA D WITH (NOLOCK),
				CONTRACT_MASTER M WITH (NOLOCK),
				DBO.FOOWNER O WITH (NOLOCK)
			WHERE
				M.TRADE_DATE  = D.SAUDA_DATE
				AND M.PARTY_CODE = D.PARTY_CODE
				AND D.SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
			ORDER BY
				SAUDA_DATE,D.PARTY_CODE
		
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_GST_INVOICE
-- --------------------------------------------------

CREATE PROC [dbo].[FETCH_GST_INVOICE] 
(
	@FORTHEDAY	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7)
)
AS

SELECT INVOICE_DATE = CONVERT(DATETIME, LEFT(SAUDA_DATE,11)),EXCHANGE=@EXCHANGE, SEGMENT=@SEGMENT, RECORDFOR='SETTLEMENT',
SUBRECORDFOR=CONVERT(VARCHAR(20),'CONTRACT'),INV_DESC = CONVERT(VARCHAR(500),'TOWARDS BROKERAGE AND CHARGES AGAINST THE TRADES EXECUTION'),
SETT_NO='', SETT_TYPE='', PARTY_CODE, CONTRACTNO, INT_REF_NO = CONVERT(VARCHAR(50), @EXCHANGE + '_' + @SEGMENT + '_' + CONTRACTNO),
TAXABLE_AMT = SUM(PBROKAMT+SBROKAMT)
			+ SUM(CASE WHEN TURNOVER_AC = 1 THEN TURN_TAX ELSE 0 END)
			+ SUM(CASE WHEN SEBI_TURN_AC = 1 THEN SEBI_TAX ELSE 0 END)
			+ SUM(CASE WHEN BROKER_NOTE_AC = 1 THEN BROKER_NOTE ELSE 0 END)
			+ SUM(CASE WHEN OTHER_CHRG_AC = 1 THEN OTHER_CHRG ELSE 0 END)
			+ SUM(CASE WHEN INSURANCE_CHRG_AC = 1 THEN INS_CHRG ELSE 0 END),
TAX_AMT = SUM(C.SERVICE_TAX),
INVOICE_TYPE = CONVERT(VARCHAR(20),'DEBIT'),
INVOICE_SUBTYPE = CONVERT(VARCHAR(20),''),
INVOICE_CATEGORY = CONVERT(VARCHAR(20),''),
REV_INT_REF_NO = CONVERT(VARCHAR(50),''),
LOCATION_CODE = CONVERT(VARCHAR(50),''),
SOURCESTATE=CONVERT(VARCHAR(50),''),
TARGETSTATE=CONVERT(VARCHAR(50),''),
STATE_CODE=CONVERT(VARCHAR(2),''),
INV_NO=CONVERT(VARCHAR(50),''),
SACCODE=CONVERT(VARCHAR(50),''),
SAC_DESC=CONVERT(VARCHAR(500),''),
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
TOTCHRG = SUM(PBROKAMT+SBROKAMT)
		+ SUM(TURN_TAX)
		+ SUM(SEBI_TAX)
		+ SUM(BROKER_NOTE)
		+ SUM(OTHER_CHRG)
		+ SUM(INS_CHRG)
INTO #DATA 
FROM FOBILLVALAN C, FOGLOBALS G, FOOWNER O
WHERE  SAUDA_DATE BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
AND C.SERVICE_TAX > 0 AND TRADETYPE = 'BT'
GROUP BY PARTY_CODE, CONTRACTNO, LEFT(SAUDA_DATE,11)

-----------changes done below from 10.253.33.233 (NSEFO)
INSERT INTO #DATA 
SELECT INVOICE_DATE = CONVERT(DATETIME, LEFT(SAUDA_DATE,11)),EXCHANGE=@EXCHANGE, SEGMENT=@SEGMENT, RECORDFOR='SETTLEMENT',
SUBRECORDFOR=CONVERT(VARCHAR(20),'CONTRACT'),INV_DESC = CONVERT(VARCHAR(500),'TOWORDS BROKERAGE AND CHARGES AGAINST THE DELIVERY POSITION'),
SETT_NO='', SETT_TYPE='', PARTY_CODE, CONTRACTNO, INT_REF_NO = CONVERT(VARCHAR(50), @EXCHANGE + '_' + @SEGMENT + '_' + CONTRACTNO),
TAXABLE_AMT = SUM(brokapplied*Tradeqty)
			+ SUM(CASE WHEN TURNOVER_AC = 1 THEN TURN_TAX ELSE 0 END)
			+ SUM(CASE WHEN SEBI_TURN_AC = 1 THEN SEBI_TAX ELSE 0 END)
			+ SUM(CASE WHEN BROKER_NOTE_AC = 1 THEN BROKER_CHRG ELSE 0 END)
			+ SUM(CASE WHEN OTHER_CHRG_AC = 1 THEN OTHER_CHRG ELSE 0 END)
			+ SUM(CASE WHEN INSURANCE_CHRG_AC = 1 THEN INS_CHRG ELSE 0 END),
TAX_AMT = SUM(C.SERVICE_TAX),
INVOICE_TYPE = CONVERT(VARCHAR(20),'DEBIT'),
INVOICE_SUBTYPE = CONVERT(VARCHAR(20),''),
INVOICE_CATEGORY = CONVERT(VARCHAR(20),''),
REV_INT_REF_NO = CONVERT(VARCHAR(50),''),
LOCATION_CODE = CONVERT(VARCHAR(50),''),
SOURCESTATE=CONVERT(VARCHAR(50),''),
TARGETSTATE=CONVERT(VARCHAR(50),''),
STATE_CODE=CONVERT(VARCHAR(2),''),
INV_NO=CONVERT(VARCHAR(50),''),
SACCODE=CONVERT(VARCHAR(50),''),
SAC_DESC=CONVERT(VARCHAR(500),''),
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
TOTCHRG = SUM(brokapplied*Tradeqty)
		+ SUM(TURN_TAX)
		+ SUM(SEBI_TAX)
		+ SUM(BROKER_CHRG)
		+ SUM(OTHER_CHRG)
		+ SUM(INS_CHRG)
FROM DELIVERY_FOSETT C, FOGLOBALS G, FOOWNER O
WHERE  SAUDA_DATE BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
AND C.SERVICE_TAX > 0 -- AND TRADETYPE = 'BT'
GROUP BY PARTY_CODE, CONTRACTNO, LEFT(SAUDA_DATE,11)
------------------------------------------------------------------------------------------
SELECT * FROM #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FileListProc
-- --------------------------------------------------
CREATE  Proc FileListProc (@FilePath Varchar(100) )      
As       
    
Declare @NewFilePath Varchar(100)    
    
Set @NewFilePath = Replace(@FilePath, '*.txt', '*.*')    
Create Table #FileList       
( FileNameList Varchar(100))      
Insert into #FileList       
Exec master.dbo.xp_cmdshell @NewFilePath      

Select * from #FileList where @NewFilePath is not null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.fo_getsecname
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 1/17/2004 11:42:41 PM ******/








/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 09/10/2001 6:27:18 PM ******/

/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 09/07/2001 10:36:01 PM ******/

/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 9/7/01 5:07:19 PM ******/

/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 9/7/2001 4:10:02 PM ******/

/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 08/10/2001 4:53:38 PM ******/


/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 8/7/01 4:29:04 PM ******/

/****** Object:  Stored Procedure dbo.fo_getsecname    Script Date: 7/25/01 10:05:57 PM ******/



CREATE  procedure fo_getsecname

@inst as varchar(6),
@symbol as varchar(12),
@expdt as varchar(20),
@strikepr as money,
@opttype as varchar(2)

as

select sec_name from foscrip2
where inst_type = @inst
and symbol = @symbol
and expirydate like @expdt+'%'
and strike_price = @strikepr
and option_type = @opttype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOAfterconSettOffflag
-- --------------------------------------------------

CREATE PROCEDURE FOAfterconSettOffflag 
@ADate Varchar(11),
@AParty_code Varchar(20),
@AInst_Type Varchar(20), 
@ASymbol Varchar(20),
@AAEXPIRYDATE Varchar(30),
@AStrike_Price Money,
@AOption_type Varchar(20)


AS 

declare @AEXPIRYDATE datetime

set @AEXPIRYDATE = left(convert(datetime,@AAEXPIRYDATE),11) + ' 23:59'

 Declare 
 @@FoSettLoop As Cursor,
 @@Trade_no varchar(14),
 @@TodayQty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),

/* T Prefix stands for Today and P stands for Previous */

 @@TPosCur cursor,
 @@TParty_code Varchar(20),
 @@TNetqty numeric(9),
 @@TInst_Type Varchar(20), 
 @@TSymbol Varchar(20),
 @@TEXPIRYDATE Datetime,
 @@TStrike_Price Money,
 @@TOption_type Varchar(20),

 
 @@PPosCur Cursor,
 @@PParty_code Varchar(20),
 @@PNetQty Numeric(9),
 @@PInst_Type Varchar(20), 
 @@PSymbol Varchar(20),
 @@PEXPIRYDATE Datetime,
 @@PStrike_Price Money,
 @@POption_type Varchar(20),

 @@DiffQty  Numeric(9),
 
 @@PYes As Char(2) 

Update fosettlement set settflag = '8' from fosettlement  where sauda_date like @Adate + '%' 
and fosettlement.party_code = @AParty_code And 
fosettlement.Inst_type = @AInst_type and fosettlement.Symbol = @ASymbol
and fosettlement.Expirydate = @AExpirydate + ' 23:59:00' 
and Fosettlement.Option_type = @AOption_type 
and fosettlement.Strike_price = @AStrike_Price
and sell_buy = 1 and settflag = '4'

Update fosettlement set settflag = '9' from fosettlement  where sauda_date like @Adate + '%' 
and fosettlement.party_code = @AParty_code And 
fosettlement.Inst_type = @AInst_type and fosettlement.Symbol = @ASymbol
and fosettlement.Expirydate = @AExpirydate + ' 23:59:00' 
and Fosettlement.Option_type = @AOption_type 
and fosettlement.Strike_price = @AStrike_Price
and sell_buy = 2 and settflag = '5'

Select @@Pyes = 'F'

Set @@TPosCur = cursor for

/* The view BBGFosettBfView selects only those clients whose brok_scheme = 20 '*/

Select Party_Code, Inst_Type, Symbol,EXPIRYDATE,NetQty = sum(Pqty - Sqty),  /* sell_buy = (case when sum(Pqty - Sqty) < 0 Then '2' Else '1' End),   Pqty,Sqty, */ strike_price,option_type  
From BbgFoSettBfView F where expirydate >= @Adate + ' 23:59:00'
And sauda_date Like @Adate + '%' And Settflag in(8,9) 
and party_code = @AParty_code 
and Symbol = @ASymbol 
and Inst_type = @AInst_type 
and Option_type = @AOption_type
and Expirydate =@AExpirydate + ' 23:59:00' 
Group by Party_Code, Inst_Type, Symbol,EXPIRYDATE,Strike_Price,Option_Type
Order by Party_code ,Inst_type,Symbol 

Open @@TPosCur
Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type

If @@fetch_status = 0   
Begin
     While @@fetch_status = 0 
     Begin
          Set @@PPosCur = Cursor For
 
          Select Party_Code, NetQty = (sum(Pqty - Sqty)),Inst_Type, Symbol,EXPIRYDATE, strike_price,option_type   
          From bbgfosettbfview where  
          expirydate >= @Adate +  ' 23:59:59'
          And party_code = @@TParty_code and sauda_date < Convert(Smalldatetime,@Adate + ' 00:00:00') and expirydate >= @Adate + ' 23:59:59'
          And Inst_type = @@TInst_type And Symbol = @@TSymbol And Expirydate = @@TExpiryDate
          And Strike_Price = @@TStrike_price And Option_type = @@TOption_type
          Group by Party_Code, Inst_Type, Symbol,EXPIRYDATE,strike_price,option_type
       
          Open @@PPosCur
          Fetch Next From @@PPosCur into @@PParty_code, @@PNetQty,@@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type                
   
          If @@Fetch_Status = 0
                   
          While @@fetch_status = 0 
                Begin
                               
                     If  Abs(@@PNetQty) <  Abs(@@TNetqty)
                     Begin
                          select @@Diffqty = Abs(@@PNetQty)
                     End
                     If  Abs(@@PNetQty) >  Abs(@@TNetqty)
                     Begin
                          select @@Diffqty = Abs(@@TNetQty)
               End
 
                     If ((@@PNetQty + @@TNetQty ) = 0 )   
                     Begin

                           If @@TNetqty > 0 
                           Begin

                                Update fosettlement set settflag = '6' 
                                where
                                expirydate >= @Adate +  ' 23:59:59'
                                And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate = @@TExpiryDate
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(8)
                           End 
                           
                           If @@TNetQty < 0 
                           Begin

                                Update fosettlement set settflag = '6' 
                                where
                                expirydate >= @Adate +  ' 23:59:59'
                                And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate = @@TExpiryDate
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(9)
                           End
                     End 


                     /* If Position till Yesterday and Position for Today are + Then */ 
                     If ( (@@PNetQty >= 0 ) And (@@TNetQty > 0))   
                     Begin

                          Update fosettlement set settflag = '8' 
                          Where
                                expirydate >= @Adate +  ' 23:59:59'
                                And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate = @@TExpiryDate
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(8)
                     End 

                     /* If Position till Yesterday and Position for Today are - Then */
                     If ( (@@PNetQty <= 0 ) And (@@TNetQty < 0))   
                     Begin

                         Update fosettlement set settflag = '9' 
                         Where
          expirydate >= @Adate +  ' 23:59:59'
                                And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate = @@TExpiryDate
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(9)
                     End   

                     /* Now we will take the case where Cumulative Position till yesterday is + and Todays is Negative */  
                     If ( (@@PNetQty > 0 ) And (@@TNetQty < 0))   
                     Begin
                          /* If Position till Yesterday is greater than Absolute of Today or Equal then the SettSettoff will apply */  
                          If (@@PNetQty) >= Abs(@@TNetqty)
                          Begin 

    Update fosettlement set settflag = '7' 
                                Where
          expirydate >= @Adate +  ' 23:59:59'
                                     And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                     And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                     And Expirydate = @@TExpiryDate
                                     And Strike_Price = @@TStrike_price 
                                     And Option_type = @@TOption_type
                                     And SettFlag in(9)

                           End
                          /* If Position till Yesterday is greater than Absolute of Today then We
                             Will Split The trade Which are sell side  or sett_flag = 5  */   

                          If ((@@PNetQty) < Abs(@@TNetqty)) 
                          Begin
                               Exec FOAfterSettArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@Adate,@@DiffQty,'S'
                          End
/*
                          If Abs(@@Diffqty) = Abs(@@TNetqty) 
                          Begin
                               Print    ' @@DiffQty = TNetQty  Update settlement Se Settflag = 7  ' + Convert (Varchar,@@Diffqty)
                          
                          End
*/  
                          
                     End 

                     
                     If ( (@@PNetQty < 0 ) And (@@TNetQty > 0))   
                     Begin
                          /* If Position till Yesterday is greater than Absolute of Today or equal then the SettSettoff will apply */  
                          If Abs(@@PNetQty) >= (@@TNetqty)
                          Begin 

                             Update fosettlement set settflag = '6' 
                             Where
                                  expirydate >= @Adate +  ' 23:59:59'
                                  And party_code = @@TParty_code and sauda_date Like @Adate +'%'  and expirydate >= @Adate + ' 23:59:59'
                                  And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                  And Expirydate = @@TExpiryDate
                                  And Strike_Price = @@TStrike_price 
                                  And Option_type = @@TOption_type
                                  And SettFlag in(8)
                          End

                          /* If Position till Yesterday is greater than Absolute of Today then We
                             Will Split The trade Which are sell side  or sett_flag = 5  */   
                          If Abs(@@PNetQty) < Abs(@@TNetqty) 
                          Begin

                               Exec FOAfterSettArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@Adate,@@DiffQty,'B'
                          End
/*                         
                          If Abs(@@Diffqty) = Abs(@@TNetqty) 
                          Begin
                               Print    ' @@DiffQty = TNetQty  Update settlement Se Settflag = 6  ' + Convert (Varchar,@@Diffqty)
                          End 
*/   
                     End 
                      
                     Fetch Next From @@PPosCur into @@PParty_code, @@PNetQty,@@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type
                           
                End
                Else
                Begin
                         Print 'Past Position is Zero '
                End
     Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type
     End  
End
If @@Pyes = 'T'
Begin 
     Close @@PPosCur
End
Close @@TPosCur

If @@Pyes = 'T'
Begin 
     Deallocate @@PPosCur
End

Deallocate @@TPosCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOAfterSettArrange
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.FOAfterSettArrange    Script Date: 1/17/2004 11:42:37 PM ******/





/* FINAL AS ON JAN 22 2002   7:45  p.m  */

/* Drop Procedure FOAfterSettArrange */

CREATE  PROCEDURE FOAfterSettArrange
@Party_code Varchar(10),
@option_type varchar(2),
@inst_type varchar(6),
@symbol varchar(12),
@expirydate varchar(11),
@strike_price money,
@TDate Varchar(11),
@Diffqty numeric(9),
@Sell_buy Char(2)

AS 
Declare 
 @@Trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@Loop cursor

 
 Print @Sell_buy

 If @Sell_buy = 'B' 
 Begin 
      Print   ' In Procedure sell_buy =  B ' 
      Select @@pdiff = Abs(@Diffqty)
      Print convert(varchar(20),@@Pdiff)
      Set @@Loop  = cursor for 
      Select trade_no,tradeqty from FOsettlement 
      Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
      and left(convert(varchar,sauda_date,109),11) = @Tdate   and sell_buy = 1 
      and Settflag in (4,8)
      Order by tradeqty Desc
      Open @@loop
      Fetch next from @@Loop into @@Ltrade_no,@@Lqty     
     
      While @@pdiff > 0       
      Begin
           If @@pdiff >= @@Lqty  
           Begin
                Update Fosettlement set settflag = 6   
                Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (4,8)
                Select @@pdiff = @@Pdiff - @@Lqty
                Print '@@PDiff = @@Pdiff - @@LQty ' + Convert(varchar(11),@@Pdiff)  
           End    
           Else If @@pdiff < @@Lqty 
           Begin
                insert into FoSettlement select ContractNo,BillNo,'U'+Trade_no,Party_Code,Inst_type,Symbol,Sec_name,Expirydate,
                Strike_price,Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@@Pdiff,AuctionPart,MarketType,Series,
                Order_no,Price,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,
                Sell_buy,6,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,
                Service_tax,@@Pdiff*price,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate
       /* Added By Animesh Cause of Added new fields in FoSettlement on Date 04/09/2001 12:25 PM. */
                ,ParticipantCode,Status,CpId,Instrument,BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
                 from FOSettlement where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                 and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                 and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty    
 
                update FOsettlement set settflag = 8,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*price    
                where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty 
                select @@Pdiff = 0   
             End 
             Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
        Close @@Loop
  End
      Else 
      Begin 
            Print   ' In Procedure sell_buy =  S ' 
            Select @@pdiff = Abs(@Diffqty)
           Set @@Loop  = cursor for 
           Select trade_no,tradeqty from FOsettlement 
           Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
           and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
           and left(convert(varchar,sauda_date,109),11) = @Tdate   and sell_buy = 2 
           and Settflag in (5,9)
           Order by tradeqty Desc
           Open @@loop
           Fetch next from @@Loop into @@Ltrade_no,@@Lqty     
           While @@pdiff > 0       
           Begin
                if @@pdiff >= @@Lqty  
                Begin
                     update Fosettlement set settflag = 7   
                     where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                     and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                     and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (4,8)
                     select @@pdiff = @@Pdiff - @@Lqty
                End    
                Else if @@pdiff < @@Lqty 
                Begin
                     insert into FoSettlement select ContractNo,BillNo,'S'+Trade_no,Party_Code,Inst_type,Symbol,
                     Sec_name,Expirydate,Strike_price,Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@@Pdiff,
                     AuctionPart,MarketType,Series,Order_no,Price,Sauda_date,Table_No,Line_No,Val_perc,Normal,
                     Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,7,Brokapplied,NetRate,Amount,Ins_chrg,
                     turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,@@Pdiff*price,Billflag,sett_no,
                     NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate
       /* Added By Animesh Cause of Added new fields in FoSettlement on Date 04/09/2001 12:25 PM. */
                     ,ParticipantCode,Status,CpId,Instrument,BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
                      from FOSettlement where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                      and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty    
 
                      update FOsettlement set settflag = 9,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*price    
                      where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
                      and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 
                      select @@Pdiff = 0   
                 End 
                 Fetch next from @@Loop into @@Ltrade_no,@@Lqty
           End
           Close @@Loop
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOBILLGENERATE
-- --------------------------------------------------

CREATE PROC FOBILLGENERATE 
	(
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(50) =''
	) AS

DECLARE  @@MATURITYDATE VARCHAR(17)        


SELECT TOP 1 @@MATURITYDATE = LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59'
FROM FOSCRIP2 (NOLOCK) WHERE  LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) = @SAUDA_DATE    
        
IF @@MATURITYDATE IS NOT NULL         
BEGIN        
 	EXEC FOREARRANGEBILLFLAG @@MATURITYDATE  
	EXEC CALCULATESTAMPDUTY @@MATURITYDATE 
END

UPDATE 
	V2_BUSINESS_PROCESS 
SET 
	BILLING = BILLING + 1 ,
	LASTUPDATEDATE = GETDATE()

WHERE 
	LEFT(BUSINESS_DATE,11) = @SAUDA_DATE


INSERT INTO V2_PROCESS_STATUS_LOG 
( 
	EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
	FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
)
SELECT
	EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
	SEGMENT='FUTURES',
	BUSINESSDATE=@SAUDA_DATE,
	PROCESSID = 'BILLGEN',
	PROCESSNAME = 'BILL GENERATION',
	FILENAME='',
	START_END_FLAG=1,
	PROCESSDATE=GETDATE(),
	PROCESSBY=@USERNAME,
	MACHINEIP=''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOClientTaxesPop
-- --------------------------------------------------

CREATE Procedure [dbo].[FOClientTaxesPop] 
	(
		@ImportDate Varchar(11)
	) AS

/*---------------------------------------------------------------------------------------------------------

Proc Name	: FOClientTaxesPop
Description	: Populating Data into FoClientTaxes & FoClientBrokScheme (for first time only)
Parameter 	: @ImportDate - Data Import Date
----------------------------------------------------------------------------------------------------------*/

TRUNCATE TABLE FoClientBrokScheme
TRUNCATE TABLE FoClientTaxes

/*----------------------------------------------------------------------------------------------------------
		Populating Client' Brokerage Details at FOCLIENTBROKSCHEME
-----------------------------------------------------------------------------------------------------------*/
Insert Into FoClientBrokScheme
Select
	Party_Code,
	Date_From 		= @ImportDate,
	Date_To			= 'Dec 31 2049 23:59',
	Fut_BrokTable		= Std_Rate,
	Opt_BrokTable		= Brok2_TableNo,
	Fut_Exp_BrokTable	= Brok1_TableNo,
	Opt_Exc_BrokTable	= Dummy2,
	Comm_Del_BrokTable	= MF_TableNo,
	Brok_Scheme		= Brok_Scheme,
	Opt_Brok_ComputeOn	= Case When Dummy1 = 0 
				Then 'PRICE' else Case 
				When Dummy1 = 1 Then 'SPRICE' 
				Else  'SSPRICE' End End
From
	Client2 
Where
	Party_Code Not In (Select Party_Code From foClientBrokScheme)


/*----------------------------------------------------------------------------------------------------------
		Populating Client' Taxes and Brokerage Rounding Details at FOCLIENTTAXES
-----------------------------------------------------------------------------------------------------------*/

Insert Into FoClientTaxes
Select 
	Party_Code,
	Date_From = @ImportDate,
	Date_To = 'Dec 31 2049 23:59',
	FUT_Insurance_Chrg = Max(Case When Insurance_Chrg =1 then Insurance_Chrg else 0 end),
	FUT_Turnover_Tax = Max(case when Turnover_Tax =1 then FUT_Turnover_Tax else 0 end),
	FUT_Other_Chrg=Max(case when Other_Chrg =1 then FUT_Other_Chrg else 0 end ),
	FUT_Sebiturn_Tax=Max(case when Sebi_Turn_Tax=1 then FUT_Sebiturn_Tax else 0 end),
	FUT_Broker_Note=Max(case when BrokerNote=1 then FUT_Broker_Note else 0 end),
	OPT_Insurance_Chrg=Max(case when Insurance_Chrg =1 then 1 else 0 end),
	OPT_Turnover_Tax=Max(case when Turnover_Tax =1 then OPT_Turnover_Tax else 0 end),
	OPT_Other_Chrg=Max(case when Other_Chrg = 1 then OPT_Other_Chrg else 0 end),
	OPT_Sebiturn_Tax=Max(case when Sebi_Turn_Tax =1 then OPT_Sebiturn_Tax else 0 end),
	OPT_Broker_Note =Max(case when BrokerNote =1 then OPT_Broker_Note else 0 end),
	Round_To,RoFig,ErrNum,NoZero
From
(
	Select 
		FUT_Insurance_Chrg 	= Insurance_Chrg,
		FUT_Turnover_Tax 	= Turnover_Tax,
		FUT_Other_Chrg 		= Other_Chrg,
		FUT_Sebiturn_Tax 	= Sebiturn_Tax,
		FUT_Broker_Note  	= 1,
		OPT_Insurance_Chrg 	= 0,
		OPT_Turnover_Tax 	= 0,
		OPT_Other_Chrg 		= 0,
		OPT_Sebiturn_Tax 	= 0,
		OPT_Broker_Note  	= 0
	From
		FoTaxes 
	Where
		Getdate() between From_Date and To_Date
	
) FoTax,
	Client2,
	BrokTable
Where
	Client2.Std_Rate = Broktable.Table_No
	And BrokTable.Line_No = 1
	And Party_Code Not In (Select Party_Code From FOClientTaxes)
Group By 
	Party_Code,
	Round_To,RoFig,ErrNum,NoZero


UPDATE CLIENT2 SET Insurance_Chrg = 1, Turnover_tax = 1, Other_chrg = 1, Sebi_Turn_tax = 1, BrokerNote = 1

UPDATE
	Msajag.dbo.Client_Brok_Details
Set
	Fut_Stt=1,Fut_Tran_Chrgs=1,Fut_Sebi_Fees=1,
	Fut_Stamp_Duty=1,Fut_Other_Chrgs=1,

	TRD_STT=Fut_Insurance_Chrg,Trd_Tran_Chrgs=Fut_Turnover_Tax,
	Trd_Sebi_Fees=Fut_Sebiturn_Tax,Trd_Stamp_Duty=Fut_Broker_Note,
	Trd_Other_Chrgs=Fut_Other_Chrg,

	Del_Stt=Opt_Insurance_Chrg,Del_Tran_Chrgs=Opt_Turnover_Tax,
	Del_SEBI_Fees=Opt_Sebiturn_Tax,Del_Stamp_Duty=Opt_Broker_Note,
	Del_Other_Chrgs=OPT_Other_Chrg
From
	FoClientTaxes
Where
	Exchange ='NCE'
	And Segment = 'FUTURES'
	And Cl_Code = FoClientTaxes.Party_Code

/*----------------------------------------------- End of File ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoDailyConfNCDX
-- --------------------------------------------------
CREATE Procedure [dbo].[FoDailyConfNCDX] (@sauda_date as varchar(11),@party_from as varchar(12),@party_to as varchar(12),
																	@family_from as varchar(12),@family_to as varchar(12)) 
AS

		SELECT short_name,family,s.party_code,CONVERT(VARCHAR,s.Sauda_date,105) Sauda_date,Inst_type,Symbol, Sec_name,
		CONVERT(VARCHAR,Expirydate,103) Expirydate, Strike_price, Option_type,s.price, s.tradeqty,
		AMT =round((s.NetRate*s.tradeqty*booktype/instrument),2),s.Sell_buy,
		Brokapplied=s.Brokapplied, NetRate=round((s.NetRate),2),S.Trade_no,s.Order_no,
		tm=convert(char,s.sauda_date,108),year(sauda_date),month(sauda_date),day(sauda_date)

		FROM foSETTLEMENT s, client1 c1, client2 c2 WHERE CONVERT(VARCHAR,s.Sauda_date,103) = @sauda_date
		and c1.cl_code = c2.cl_code and c2.party_code = s.party_code
		and s.tradeqty > 0 and s.party_code >= @party_from and s.party_code <= @party_to
		and c1.family >= @family_from and c1.family <= @family_to

		ORDER BY year(sauda_date),month(sauda_date),day(sauda_date),family,s.party_code,Inst_type,Symbol,
		 Sec_name,CONVERT(VARCHAR,Expirydate,103) , Option_type,Strike_price

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoDailySheet
-- --------------------------------------------------
CREATE Proc [dbo].[FoDailySheet]
(@SDate Varchar(11),@fParty Varchar(12),@tParty Varchar(12)) As  


select PQty=(Case When sum(s.Pqty)>sum(s.sqty)   
    Then sum(s.Pqty)-sum(s.sqty)  
    Else 0 End),  
SQty=(Case When sum(s.Pqty)<sum(s.sqty)   
    Then sum(s.Sqty)-sum(s.Pqty)  
    Else 0 End),  
netrate = isnull(( select FoClosing.cl_rate from FoClosing  
                   where FoClosing.trade_date = ( select max(trade_date) from FoClosing   
                   where FoClosing.trade_date < @SDate + ' 23:59' )   
                   and FoClosing.Inst_Type = s.inst_type  
                   and FoClosing.symbol=s.symbol                                      
                   and convert(varchar,FoClosing.expirydate,103) = convert(varchar,s.expirydate,103)  
                   and FoClosing.strike_price=s.strike_price  
                   and FoClosing.option_type=s.option_type  
                   ),0),  
Charges = 0,Brokerage=0,service_tax=0,broker_note=0,turn_tax=0,sebi_tax=0,  
Party_Code,s.Inst_Type,s.Symbol,foscrip2.maturitydate as expirydate,  
s.strike_price,s.option_type,Flag='BF',Sauda_Date = @SDate + ' 23:59' ,
numerator,Denominator
from foscrip2 ,       fodailysheetbfview s    
where   
     sauda_date <= ( select max(sauda_date)  
                                                   from fosettlement   
                                                   where sauda_date+1 <= @SDate + ' 23:59'  
                                                 )  
     and foscrip2.inst_type=s.inst_type  
     and foscrip2.symbol=s.symbol     
     and convert(varchar,s.expirydate,103) = convert(varchar,foscrip2.expirydate,103) and  
     foscrip2.strike_price=s.strike_price and  
     foscrip2.option_type=s.option_type  
     and foscrip2.maturitydate >= @SDate   
     And Party_Code between @fparty and @tparty  
group by party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,foscrip2.maturitydate,
numerator,Denominator
Having Sum(S.Pqty) <> Sum(S.SQty)  
/* Brought Forward Trades */  
Union All  
/* Todays Trade */  
select PQty=(Case When Sell_buy = 1  
           Then sum(s.TradeQty)  
    Else 0   
             End),  
SQty=(Case When Sell_buy = 2  
           Then sum(s.TradeQty)  
    Else 0   
             End),  
NetRate = Price,Charges=  
   Sum(BrokApplied*TradeQty)   
   + (Case When C2.Service_Chrg <> 2   
    Then Sum(Service_Tax)  
    Else 0   
             End)  
   + (Case When Turnover_tax = 1   
    Then Sum(turn_tax)    
    Else 0   
             End)    
   + (Case When Sebi_Turn_tax = 1   
    Then Sum(sebi_tax)    
    Else 0   
             End)    
   + (Case When BrokerNote = 1   
    Then Sum(Broker_chrg)  
    Else 0   
             End),  
Brokerage=Sum(BrokApplied*TradeQty),  
service_tax=(Case When C2.Service_Chrg <> 2   
    Then Sum(Service_Tax)  
    Else 0   
      End ),  
broker_note=(Case When BrokerNote = 1   
    Then Sum(Broker_chrg)  
    Else 0   
             End),  
turn_tax=(Case When Turnover_tax = 1   
    Then Sum(turn_tax)    
    Else 0   
             End),  
Sebi_tax=(Case When Sebi_Turn_tax = 1   
    Then Sum(sebi_tax)    
    Else 0   
             End),  
S.Party_Code,s.Inst_Type,s.Symbol,foscrip2.maturitydate as expirydate,  
s.strike_price,s.option_type,Flag='BT',Sauda_date = @SDate + ' 23:59' ,
s.BookType as numerator,s.Instrument as Denominator
from FoSettlement s, FoScrip2,Client2 C2 Where TradeQty > 0 And Sauda_Date >=  @SDate and sauda_date < @sdate + ' 23:59:00'
And C2.Party_code = S.Party_Code  
and foscrip2.inst_type=s.inst_type  
and foscrip2.symbol=s.symbol     
and convert(varchar,s.expirydate,103) = convert(varchar,foscrip2.expirydate,103) and  
foscrip2.strike_price=s.strike_price and  
foscrip2.option_type=s.option_type  
and foscrip2.maturitydate >= @SDate   
and S.Party_Code between @fparty and @tparty  
and s.AUCTIONPART <> 'ea'  
group by s.party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,  
 S.Sell_buy,Price,C2.Service_Chrg,Turnover_tax,Sebi_Turn_tax,Insurance_Chrg,BrokerNote,C2.Other_chrg,foscrip2.maturitydate ,
s.BookType,s.instrument
/* Todays Trade */  



Union All 

/* Carry Forward Trades */  
select  PQty=(Case When sum(s.Pqty)<sum(s.sqty)   
   Then sum(s.Sqty)-sum(s.Pqty)  
    Else 0 End),  
SQty=(Case When sum(s.Pqty)>sum(s.sqty)   
    Then sum(s.Pqty)-sum(s.sqty)  
    Else 0 End),  
netrate = isnull(( select FoClosing.cl_rate from FoClosing  
                   where FoClosing.trade_date = ( select max(trade_date) from FoClosing   
                   where FoClosing.trade_date = @SDate + ' 23:59' )   
                 and FoClosing.Inst_Type = s.inst_type  
                   and FoClosing.symbol=s.symbol                                      
                   and convert(varchar,FoClosing.expirydate,103) = convert(varchar,s.expirydate,103)  
                   and FoClosing.strike_price=s.strike_price  
                   and FoClosing.option_type=s.option_type  
                   ),0),  
Charges = 0,Brokerage=0,service_tax=0,broker_note=0,turn_tax=0,sebi_tax=0,  
Party_Code,s.Inst_Type,s.Symbol,foscrip2.maturitydate as expirydate,   
s.strike_price,s.option_type,Flag='CF',Sauda_date = @SDate + ' 23:59'  ,
numerator, Denominator
from foscrip2 ,   fodailysheetbfview_new s    
where   
     sauda_date <= @SDate + ' 23:59'                                                   
     and foscrip2.inst_type=s.inst_type  
     and foscrip2.symbol=s.symbol     
     and convert(varchar,s.expirydate,103) = convert(varchar,foscrip2.expirydate,103) and  
     foscrip2.strike_price=s.strike_price and  
     foscrip2.option_type=s.option_type  
     and foscrip2.maturitydate >= @SDate   
     And Party_Code between @fparty and @tparty  
group by party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,foscrip2.maturitydate,
numerator,Denominator
Having Sum(S.Pqty) <> Sum(S.SQty)  
/* Carry Forward Trades */  
Union All  
/* Future Final Exp. Trade */    
select PQty=(Case When Sell_buy = 1  
           Then sum(s.TradeQty)  
    Else 0   
             End),  
SQty=(Case When Sell_buy = 2  
           Then sum(s.TradeQty)  
    Else 0   
             End),  
NetRate = Price,Charges=  0, /*
   Sum(BrokApplied*TradeQty)   
   + (Case When C2.Service_Chrg <> 2   
    Then Sum(Service_Tax)  
    Else 0   
             End)  
   + (Case When Turnover_tax = 1   
    Then Sum(turn_tax)    
    Else 0   
             End)    
   + (Case When Sebi_Turn_tax = 1   
    Then Sum(sebi_tax)    
    Else 0   
             End)    
   + (Case When BrokerNote = 1   
    Then Sum(Broker_chrg)  
    Else 0   
             End),*/  
Brokerage=0,/*Sum(BrokApplied*TradeQty),  */
service_tax=0,/*(Case When C2.Service_Chrg <> 2   
    Then Sum(Service_Tax)  
    Else 0   
      End ), */ 
broker_note=0,/*(Case When BrokerNote = 1   
    Then Sum(Broker_chrg)  
    Else 0   
             End),  */
turn_tax=0,/*(Case When Turnover_tax = 1   
    Then Sum(turn_tax)    
    Else 0   
             End),*/
Sebi_tax=0,/*(Case When Sebi_Turn_tax = 1   
    Then Sum(sebi_tax)    
    Else 0   
             End),  */
S.Party_Code,s.Inst_Type,s.Symbol,foscrip2.maturitydate as expirydate,  
s.strike_price,s.option_type,Flag='FT',Sauda_date = @SDate + ' 23:59',
s.BookType as numerator,s.Instrument as Denominator
from FoSettlement s, FoScrip2,Client2 C2 Where TradeQty > 0 And Sauda_Date >=  @SDate and sauda_date < @sdate + ' 23:59:00'
And C2.Party_code = S.Party_Code  
and foscrip2.inst_type=s.inst_type  
and foscrip2.symbol=s.symbol     
/*and s.inst_type like 'FUT%'  */
and convert(varchar,s.expirydate,103) = convert(varchar,foscrip2.expirydate,103) and  
foscrip2.strike_price=s.strike_price and  
foscrip2.option_type=s.option_type  
and foscrip2.maturitydate >= @SDate   
and S.Party_Code between @fparty and @tparty  
and s.AUCTIONPART = 'EA' And S.Inst_Type Like 'FUT%'  
group by s.party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,  
S.Sell_buy,Price,C2.Service_Chrg,Turnover_tax,Sebi_Turn_tax,Insurance_Chrg,BrokerNote,
C2.Other_chrg,foscrip2.maturitydate,
s.BookType,s.instrument  
/* Future Final Exp. Trade */    

Union All

Select
	PQty=0,  
	SQty=0,  
	netrate = 0,  
	Charges = 0,Brokerage=0,service_tax=0,broker_note=0,turn_tax=0,sebi_tax=0,  
	Party_Code,Inst_Type='',Symbol='',expirydate='',  
	strike_price=0,option_type='',Flag='',Sauda_Date = @SDate + ' 23:59' ,
	numerator=1,Denominator=1
From
   	Msajag.dbo.Collateral 
Where
	Trans_Date Like Left(convert(datetime,@SDate,103),11) + '%'
	And Exchange ='NCE'
	And Segement = 'FUTURES'
	And Party_Code Not In (Select Party_Code From FoBillValan
				Where Sauda_Date Like Left(convert(datetime,@SDate,103),11) + '%')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODupRecCheck
-- --------------------------------------------------
CREATE PROC [dbo].[FODupRecCheck] AS       


UPDATE FOFTTRADE SET  
       PARTICIPANTCODE = CASE WHEN ISNULL(PARTICIPANTCODE,'') ='' THEN FOOWNER.MEMBERCODE ELSE PARTICIPANTCODE END,
       OPTION_TYPE = (CASE  WHEN INST_TYPE LIKE 'FUT%'  
                                      THEN ''  
                                      ELSE OPTION_TYPE  
                             END), 
       EXPIRYDATE = CASE WHEN CONVERT(VARCHAR,EXPIRYDATE,108) ='00:00:00' THEN
                     LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) + ' 23:59:00' 
                     ELSE EXPIRYDATE END
FROM FOOWNER

INSERT INTO FOTRADE
SELECT TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE=1,BOOKTYPENAME=1,MARKETTYPE,
USER_ID ,BRANCH_ID=PARTY_CODE,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,
ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1=PRICE,
RESERVED2=2,RESERVED3,RESERVED4,
RESERVED5  
 FROM FOFTTRADE WHERE BINARY_CHECKSUM(TRADE_NO) NOT IN
      (
       SELECT BINARY_CHECKSUM(TM.TRADE_NO) FROM FOTRADE TM
       WHERE CONVERT(VARCHAR,FOFTTRADE.ACTIVITYTIME,106) = CONVERT(VARCHAR,TM.ACTIVITYTIME,106)
       AND BINARY_CHECKSUM(FOFTTRADE.TRADE_NO) = BINARY_CHECKSUM(TM.TRADE_NO)
       AND BINARY_CHECKSUM(FOFTTRADE.ORDER_NO) = BINARY_CHECKSUM(TM.ORDER_NO)
       AND FOFTTRADE.INST_TYPE=TM.INST_TYPE
       AND FOFTTRADE.SYMBOL=TM.SYMBOL
       AND CONVERT(VARCHAR,FOFTTRADE.EXPIRYDATE,106)=CONVERT(VARCHAR,TM.EXPIRYDATE,106)
       AND FOFTTRADE.STRIKE_PRICE=TM.STRIKE_PRICE
       AND FOFTTRADE.OPTION_TYPE =TM.OPTION_TYPE       
       AND FOFTTRADE.TRADEQTY = TM.TRADEQTY
       AND FOFTTRADE.PRICE = TM.PRICE
       AND FOFTTRADE.SELL_BUY = TM.SELL_BUY
       )
UPDATE FOTRADE SET PARTY_CODE = NEWPARTY_CODE FROM PARTYMAPPING
WHERE PARTY_CODE = OLDPARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.foDupRecSettCheck
-- --------------------------------------------------

/****** Object:  Stored Procedure dbo.foDupRecSettCheck    Script Date: 1/17/2004 11:42:41 PM ******/  
  
  
  
/* Optimised by BBG  NOV 12 2002 */  
  
CREATE Proc [dbo].[foDupRecSettCheck] As  
delete FoTrade From fotrade,FoSettlement S where   
convert(varchar,fotrade.ActivityTime,106) = convert(varchar,s.sauda_date,106)  
and BINARY_CHECKSUM(fotrade.trade_no) = BINARY_CHECKSUM(s.trade_no)  
and BINARY_CHECKSUM(fotrade.order_no) =  BINARY_CHECKSUM(S.Order_no)  
and FOtrade.inst_type=s.inst_type  
and fotrade.symbol=s.symbol  
and  convert(varchar,fotrade.expirydate,106) = convert(varchar,s.expirydate,106)   
and fotrade.strike_price=s.strike_price   
and fotrade.option_type =s.option_type  
and fotrade.sell_buy = s.sell_buy  
--and fotrade.markettype = s.markettype   
  
/*  
delete from fotrade where replace(replace(REPLACE(replace(replace(replace(replace(replace(REPLACE(trade_no,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') in   
(select replace(replace(REPLACE(replace(replace(replace(replace(replace(REPLACE(s.trade_no,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') from foSettlement S  
where convert(varchar,fotrade.ActivityTime,106) = convert(varchar,s.sauda_date,106)  
and replace(replace(REPLACE(replace(replace(replace(replace(replace(REPLACE(fotrade.trade_no,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') = replace(replace(replace(replace(replace(replace(replace(replace(REPLACE(s.trade_no,'R','

  
'),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','')  
and fotrade.order_no =  S.Order_no  
and FOtrade.inst_type=s.inst_type  
and fotrade.symbol=s.symbol  
and  convert(varchar,fotrade.expirydate,106) = convert(varchar,s.expirydate,106)   
and fotrade.strike_price=s.strike_price   
and fotrade.option_type =s.option_type  
and fotrade.sell_buy = s.sell_buy  
and fotrade.markettype = s.markettype )  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoFutMatDaily
-- --------------------------------------------------

CREATE  Proc FoFutMatDaily  
@SDate Varchar(11),  
@Party Varchar(10),  
@symbol varchar(15)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
select Charges=(case when billflag > 3 then sum(s.nBrokApp*tradeqty*Booktype/Instrument)   
   + (Case When C2.Service_Chrg <> 2   
    Then sum(s.nsertax)  
    Else 0   
             End)  
   else 0 end),  
Brokerage=(case when billflag > 3 then sum(s.nBrokApp*tradeqty*Booktype/Instrument) else 0 end),  
service_tax=(case when billflag > 3 then (Case When C2.Service_Chrg <> 2   
    Then sum(s.nSertax)  
    Else 0   
      End ) else 0 end),  
broker_note=0,  
turn_tax=0,  
Sebi_tax=0  
from fosettlement s , client2 c2  
where s.party_code like @party + '%'  
and s.inst_type like 'Fut%'   
and s.symbol like @symbol + '%'  
and s.party_code = c2.party_code  
and left(convert(varchar,s.expirydate,109),11) = @sdate  
and nbrokapp <> 0  
group by  s.billflag,c2.service_chrg

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOGENBILLNO
-- --------------------------------------------------




CREATE  PROC FOGENBILLNO (@BILLDATE VARCHAR(11)) AS  
DECLARE @@BILLFLAG INT,  
@@PARTY_CODE VARCHAR(10),  
@@BILLNO INT,  
@@BILLCUR CURSOR  

  
UPDATE FOACCBILL SET BILL_NO = 0 WHERE BILLDATE LIKE @BILLDATE + '%'    
    
Truncate table BillNo     
Insert Into BillNo     
SELECT DISTINCT PARTY_CODE FROM FOACCBILL     
Where PARTY_CODE not in ( Select accode from valanaccount )    
AND BILLDATE LIKE @BILLDATE + '%'    
ORDER BY PARTY_CODE    
    
Update FoAccBill Set BILL_NO = B.BILL_NO    
From BillNo B    
WHERE BILLDATE LIKE @BILLDATE + '%'    
And B.Party_Code = FoAccBill.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOGENCONTRACT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOGENCONTRACT]  ( @UNAME VARCHAR(50) =''    )
AS         
DECLARE             
	@@INTCOUNT INT,
	@@MEMBERCODE VARCHAR(15),
	@@SAUDA_DATE VARCHAR(11),            
	@@STYLE INT,
	@@CONTNO INT,
	@@PARTYCONT CURSOR,
	@PARTY_CODE VARCHAR(10),
	@OPTION_TYPE VARCHAR(2),
	@INST_TYPE VARCHAR(6),    
	@SYMBOL VARCHAR(12),    
	@EXPIRYDATE VARCHAR(11),    
	@STRIKE_PRICE MONEY,    
	@TDATE VARCHAR(11)    
    

	UPDATE FOTRADE SET TradeQty = TradeQty*C_Regular_Lot
	FROM FOSCRIP2
	WHERE FOTRADE.Inst_Type = FOSCRIP2.Inst_Type
	AND FOTRADE.Symbol = FOSCRIP2.Symbol
	AND FOTRADE.Expirydate= FOSCRIP2.Expirydate
	AND FOTRADE.Strike_price= FOSCRIP2.Strike_price
	AND FOTRADE.Option_type = FOSCRIP2.Option_type
 
  SELECT DISTINCT PARTY_CODE, OPTION_TYPE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE   
  INTO #FOSETT FROM FOSETTLEMENT WITH(NOLOCK) 	
  WHERE SAUDA_DATE LIKE @@SAUDA_DATE + '%' AND AUCTIONPART <> 'CA'  
  AND TRADEQTY > 0
            
  SELECT TOP 1  @@SAUDA_DATE = LEFT(CONVERT(VARCHAR,ACTIVITYTIME,109),11) FROM  FOTRADE             
              
  SELECT @@MEMBERCODE=MEMBERCODE,@@STYLE=ISNULL(STYLE,0) FROM FOOWNER            
              
              
  TRUNCATE TABLE BBGFOSETTLEMENT            
            
  /*TAKING TRADES FORM FOCONFIRMVIEW*/              
  INSERT INTO BBGFOSETTLEMENT         
  
    SELECT '0000000',BILLNO = C_REGULAR_LOT, TRADE_NO, PARTY_CODE,            
    INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID ,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,            
    AUCTIONPART,MARKETTYPE=0,0, ORDER_NO,PRICE,            
    ACTIVITYTIME,TABLE_NO,LINE_NO,VAL_PERC, NORMAL ,DAY_PUC, DAY_SALES,            
    SETT_PURCH, SETT_SALES, SELL_BUY,SETTFLAG, BROKAPPLIED,NETRATE,            
    AMOUNT, INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX, BROKER_CHRG,SERVICE_TAX,            
    TRADE_AMOUNT , 1 ,'0',            
    0 ,0 ,0, 'F',0            
    ,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1=0,DUMMY2=RESERVED1,            
    RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN 
	(SELECT MEMBERCODE FROM FOOWNER) OR PARTICIPANTCODE = 'NCIT' OR  PARTICIPANTCODE ='') THEN 0            
    WHEN PARTICIPANTCODE IS NULL THEN 0            
    ELSE 1 END),RESERVED2,PARENTCODE = PARTY_CODE          
  FROM FOCONFIRMVIEW 
  
	UPDATE BBGFOSETTLEMENT SET PARENTCODE = C.PARENTCODE
	FROM CLIENT2_VIEW C (NOLOCK), CLIENT1 C1 (NOLOCK)
	WHERE C1.CL_CODE = C.CL_CODE
	AND C.PARTY_CODE = BBGFOSETTLEMENT.PARTY_CODE
	AND C1.CL_TYPE <> 'INS'         
              
  SELECT @@INTCOUNT = COUNT(PARTY_CODE) FROM FOSETTLEMENT WHERE SAUDA_DATE LIKE @@SAUDA_DATE +'%'  AND CONVERT(INT,CONTRACTNO) <> 0            
  /*INTRA DAY TRADES*/            
  IF @@INTCOUNT > 0             
   BEGIN            
            
	/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBER*/            
	 SELECT PARENTCODE,I.CONTRACTNO,I.ORDER_NO,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,INSCONT,SELL_BUY               
	 INTO #FOSETTLEMENT              
	 FROM FOSETTLEMENT I, CLIENT2_VIEW C2               
	 WHERE I.SAUDA_DATE LIKE @@SAUDA_DATE +'%'                
	 AND I.PARTY_CODE = C2.PARTY_CODE               
	 AND CONVERT(INT,I.CONTRACTNO) <> 0      
	 AND I.DUMMY1 <> 1          
	 GROUP BY PARENTCODE,INSCONT,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,I.ORDER_NO,I.CONTRACTNO,SELL_BUY        
	
	
	 /*CONTRACT NUMBERING STYLE - PARTY WISE*/              
	 UPDATE BBGFOSETTLEMENT SET CONTRACTNO = T.CONTRACTNO FROM BBGFOSETTLEMENT B,#FOSETTLEMENT T              
	 WHERE B.PARENTCODE = T.PARENTCODE              
	 AND ISNULL(T.INSCONT,'') NOT IN ('O','S')        
	   
	 /*CONTRACT NUMBERING STYLE - ORDER WISE*/ 
	 UPDATE BBGFOSETTLEMENT SET CONTRACTNO = T.CONTRACTNO FROM BBGFOSETTLEMENT B,#FOSETTLEMENT T              
	 WHERE B.PARENTCODE = T.PARENTCODE  AND B.ORDER_NO = T.ORDER_NO              
	 AND T.INSCONT = 'O'              
	    
	 /*CONTRACT NUMBERING STYLE - SCRIPT WISE*/              
	 UPDATE BBGFOSETTLEMENT SET CONTRACTNO = T.CONTRACTNO FROM BBGFOSETTLEMENT B,#FOSETTLEMENT T              
	 WHERE B.PARENTCODE = T.PARENTCODE AND B.INST_TYPE=T.INST_TYPE AND B.SYMBOL=T.SYMBOL AND              
	 B.EXPIRYDATE = T.EXPIRYDATE AND B.STRIKE_PRICE=T.STRIKE_PRICE AND B.OPTION_TYPE=T.OPTION_TYPE              
	 AND B.SELL_BUY = T.SELL_BUY  
	 AND T.INSCONT = 'S' 
   END
              
  /*GETTING THE MAX CONTRACT NUMBER*/            
  SET @@CONTNO = 1            
  IF @@STYLE = 1             
   BEGIN            
       SELECT @@CONTNO=ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN  WHERE @@SAUDA_DATE BETWEEN START_DATE AND END_DATE                 
   END            
  ELSE            
   BEGIN            
       SELECT @@CONTNO = ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM FOSETTLEMENT WITH(NOLOCK)            
       WHERE SAUDA_DATE LIKE  @@SAUDA_DATE +'%' AND CONVERT(INT,CONTRACTNO) <> 0            
   END            
              
TRUNCATE TABLE FOTRD_CONTRACTNO              
      
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - PARTY WISE*/              
INSERT INTO FOTRD_CONTRACTNO              
SELECT BBGFOSETTLEMENT.PARENTCODE,'','','','',0,'',INSCONT='N', 0     
FROM BBGFOSETTLEMENT, CLIENT2_VIEW CLIENT2, FOTRD_CLIENT1 CLIENT1               
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE         
AND ISNULL(INSCONT,'') NOT IN ('O','S')        
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'              
GROUP BY BBGFOSETTLEMENT.PARENTCODE
ORDER BY BBGFOSETTLEMENT.PARENTCODE              
        
  
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - ORDER WISE*/              
INSERT  INTO FOTRD_CONTRACTNO              
SELECT BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.ORDER_NO,'','','',0,'',INSCONT='O',0   
FROM BBGFOSETTLEMENT, CLIENT2_VIEW CLIENT2, FOTRD_CLIENT1 CLIENT1              
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE              
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'              
AND INSCONT  =  'O'              
GROUP BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.ORDER_NO                
ORDER BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.ORDER_NO                
        
  
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - SCRIP WISE*/              
INSERT  INTO FOTRD_CONTRACTNO              
SELECT BBGFOSETTLEMENT.PARENTCODE,'',BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,  
BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE,INSCONT='S',BBGFOSETTLEMENT.SELL_BUY
FROM BBGFOSETTLEMENT, CLIENT2_VIEW CLIENT2, FOTRD_CLIENT1 CLIENT1              
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'              
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'
GROUP BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,  
BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE,BBGFOSETTLEMENT.SELL_BUY          
ORDER BY BBGFOSETTLEMENT.PARENTCODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,  
BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE,BBGFOSETTLEMENT.SELL_BUY               
        
/*CONTRACT NUMBERING STYLE - PARTY WISE*/              
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)              
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T              
WHERE B.PARENTCODE = T.PARTY_CODE              
AND ISNULL(T.INSCONT,'') NOT IN ('O','S')        
  
      
/*CONTRACT NUMBERING STYLE - ORDER WISE*/              
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)              
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T              
WHERE B.PARENTCODE = T.PARTY_CODE  AND B.ORDER_NO = T.ORDER_NO              
AND T.INSCONT = 'O'              
  
     
/*CONTRACT NUMBERING STYLE - SCRIP WISE*/           
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)              
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T              
WHERE B.PARENTCODE = T.PARTY_CODE  AND B.INST_TYPE=T.INST_TYPE AND B.SYMBOL=T.SYMBOL AND              
B.EXPIRYDATE = T.EXPIRYDATE AND B.STRIKE_PRICE=T.STRIKE_PRICE AND B.OPTION_TYPE=T.OPTION_TYPE              
AND B.SELL_BUY = T.SELL_BUY  
AND T.INSCONT = 'S'          
    
/*GETTING LAST USED MAX CONTRACT NUMBER*/            
SELECT @@CONTNO = @@CONTNO + ISNULL(MAX(SNO),0) FROM FOTRD_CONTRACTNO            
      
UPDATE FOOWNER SET CONTNO = @@CONTNO             
      
IF @@STYLE = 1             
BEGIN             
	UPDATE CONTGEN SET CONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE BETWEEN START_DATE AND END_DATE             
END            
      

SET @@PARTYCONT = CURSOR FOR               
	SELECT DISTINCT PARTY_CODE, OPTION_TYPE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, LEFT(SAUDA_DATE,11)    
	FROM BBGFOSETTLEMENT B WITH(NOLOCK) WHERE SAUDA_DATE LIKE @@SAUDA_DATE + '%' AND AUCTIONPART <> 'CA'  
	AND PARTY_CODE IN ( SELECT S.PARTY_CODE FROM #FOSETT S
	WHERE B.PARTY_CODE = S.PARTY_CODE
	AND B.OPTION_TYPE = S.OPTION_TYPE
	AND B.INST_TYPE = S.INST_TYPE
	AND B.SYMBOL  = S.SYMBOL
	AND B.EXPIRYDATE = S.EXPIRYDATE
	AND B.STRIKE_PRICE = S.STRIKE_PRICE )
	OPEN @@PARTYCONT     
FETCH NEXT FROM @@PARTYCONT INTO @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE    


--UPDATE A SET A.RESERVED1 = 0, A.PARTICIPANTCODE = @@MEMBERCODE
--FROM BBGFOSETTLEMENT A, MSAJAG.DBO.SMC_SELF_CLEARING_CUSTODIAN_MASTER B
--WHERE LTRIM(RTRIM(A.PARTY_CODE))= LTRIM(RTRIM(B.UCC_CODE))
--AND LTRIM(RTRIM(A.PARTICIPANTCODE))=LTRIM(RTRIM(B.CP_CODE))
--AND LTRIM(RTRIM(B.EXCHANGE)) = 'NCE' AND LTRIM(RTRIM(B.SEGMENT)) = 'FUTURES' 
--AND LTRIM(RTRIM(B.SELFCLRG)) = 'YES'

INSERT INTO FOSETTLEMENT 
SELECT CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,
OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,
PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
FROM BBGFOSETTLEMENT     





WHILE @@FETCH_STATUS = 0     
BEGIN    
	EXEC FOREARRANGEAFTERCONTFLAG @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE    
FETCH NEXT FROM @@PARTYCONT INTO @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE    
END              

CLOSE @@PARTYCONT    
DEALLOCATE @@PARTYCONT    

/*CLEANING TMP FILE*/              
TRUNCATE TABLE  FOTRADE 

EXEC CALCULATESTAMPDUTY @@SAUDA_DATE
 
	

EXEC V2_PROCESS_STATUS_LOG_UPD @@SAUDA_DATE,'IMPTRD','',@UNAME,''  

/*--------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoImpTrdSelParty
-- --------------------------------------------------

CREATE PROC FOIMPTRDSELPARTY
AS

SELECT DISTINCT FT.PARTY_CODE,FT.PARTICIPANTCODE,FT.MEMBERCODE 
FROM FOTRADE FT WHERE NOT EXISTS 
( SELECT C2.PARTY_CODE FROM CLIENT2 C2 WHERE FT.PARTY_CODE=C2.PARTY_CODE)
OR FT.PARTY_CODE IS NULL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.foImpTrdSpChg
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 1/17/2004 11:42:41 PM ******/








/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 09/10/2001 6:27:19 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 09/07/2001 10:36:03 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 9/7/01 5:07:19 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 9/7/2001 4:10:03 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 08/10/2001 4:53:39 PM ******/


/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 8/7/01 4:29:05 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 7/25/01 10:05:57 PM ******/



/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 6/30/01 11:51:34 AM ******/



/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 5/26/01 4:17:00 PM ******/


/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 3/17/01 9:55:51 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 3/21/01 12:50:07 PM ******/

/****** Object:  Stored Procedure dbo.foImpTrdSpChg    Script Date: 20-Mar-01 11:38:50 PM ******/


/*Final sql - 07 feb 2001 */
/*Ranjeet Choudhary*/
/*used in nsefo segment*/

CREATE  proc  foImpTrdSpChg 
 (@partycode varchar(7),
  @userid int
  )

 as
 /*Used in NSE FO */ 
 /*Control Name :FoImportTrade Module Name :CmdPSave_Click()*/
 /*table used :write only foTrade*/
 /*Function:This used to missing client i.e the clients partycode prsernt in the fotrade table but not in client2 table*/            
 /*Written By :Ranjeet Choudhary */

 update fotrade set party_code = @partycode
 where user_id =@userid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGINNEW_CALC
-- --------------------------------------------------
  
CREATE PROC [dbo].[FOMARGINNEW_CALC] (@MARGINDATE VARCHAR(11), @VALIDATEWITH VARCHAR(30), @ACTOPT VARCHAR(30), @COLLOPT VARCHAR(30), @BATCHNO VARCHAR(10), @REFNO INT, @VALIDATIONDATE VARCHAR(11) = @MARGINDATE)  
AS  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DECLARE @MEMBERCODE VARCHAR(15)  
  
SELECT @MEMBERCODE = MEMBERCODE  
FROM FOOWNER  
  
SET @ACTOPT = 'WITHOUT BILL'  
  
TRUNCATE TABLE FOMARGINNEW_EFFCOLL  
  
DELETE  
FROM FOMARGINNEW  
WHERE MDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND PARTY_CODE = @membercode  
  
INSERT INTO FOMARGINNEW_EFFCOLL  
SELECT PARTY_CODE, 0,0,0,0
FROM FOMARGINNEW  
WHERE MDATE LIKE @MARGINDATE + '%'  
 AND CL_TYPE <> 'TM'  

IF @VALIDATEWITH = 'ONLY COLLATERAL'  
 OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'  
BEGIN  
 CREATE TABLE [#COLLATERAL] ([PARTY_CODE] [VARCHAR](12), [CASH] [MONEY], [NONCASH] [MONEY], [ACTCASH] [MONEY], [ACTNONCASH] [MONEY], [ORGCASH] [MONEY], [ORGNONCASH] [MONEY])  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 IF (  
   SELECT COUNT(1)  
   FROM FOMG13REFERENCE  
   WHERE SUBJECT = 'MRGOPTION'  
    AND HEADING = 'T -1 DAY VALUATION'  
    AND SUBMENUREFNO = 1  
   ) > 0  
 BEGIN  
  --EXEC TBL_COLLATERAL_MARGIN_UPD @VALIDATIONDATE  
  
  INSERT INTO #COLLATERAL  
  SELECT PARTY_CODE = PARENTCODE, SUM(CASE   
     WHEN CASH_NCASH = 'C'  
      THEN FINALAMOUNT  
     ELSE 0  
     END), SUM(CASE   
     WHEN CASH_NCASH = 'N'  
      THEN FINALAMOUNT  
     ELSE 0  
     END), CASH = MAX(CASH), NONCASH = MAX(NONCASH), SUM(CASE   
     WHEN CASH_NCASH = 'C'  
      THEN AMOUNT  
     ELSE 0  
     END), SUM(CASE   
     WHEN CASH_NCASH = 'N'  
      THEN AMOUNT  
     ELSE 0  
     END)  
  FROM TBL_COLLATERAL_MARGIN C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
  WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
   AND EFFDATE BETWEEN @VALIDATIONDATE  
    AND @VALIDATIONDATE + ' 23:59'  
   AND EXISTS (  
    SELECT PARTY_CODE  
    FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
    WHERE F.PARTY_CODE = PARENTCODE  
    )  
  GROUP BY PARENTCODE  
 END  
 ELSE  
 BEGIN  
  IF (  
    SELECT COUNT(1)  
    FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK)  
    WHERE C.EXCHANGE = (  
      SELECT TOP 1 EXCHANGE  
      FROM FOGLOBALS(NOLOCK)  
      )  
     AND SEGMENT LIKE 'FUT%'  
     AND TRANS_DATE BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
    ) > 0  
  BEGIN  
   INSERT INTO #COLLATERAL  
   SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
  
   FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
   WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
    AND C.EXCHANGE = (  
     SELECT TOP 1 EXCHANGE  
     FROM FOGLOBALS(NOLOCK)  
     )  
    AND SEGMENT LIKE 'FUT%'  
    AND TRANS_DATE BETWEEN @VALIDATIONDATE  
     AND @VALIDATIONDATE + ' 23:59'  
    AND EXISTS (  
     SELECT PARTY_CODE  
     FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
     WHERE F.PARTY_CODE = PARENTCODE  
     )  
   GROUP BY PARENTCODE  
  END  
  ELSE  
  BEGIN  
   INSERT INTO #COLLATERAL  
   SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
  
   FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
   WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
    AND C.EXCHANGE = (  
     SELECT TOP 1 EXCHANGE  
     FROM FOGLOBALS(NOLOCK)  
     )  
    AND SEGMENT LIKE 'FUT%'  
    AND TRANS_DATE BETWEEN @MARGINDATE  
     AND @MARGINDATE + ' 23:59'  
    AND EXISTS (  
     SELECT PARTY_CODE  
     FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
     WHERE F.PARTY_CODE = PARENTCODE  
     )  
   GROUP BY PARENTCODE  
  END  
 END  
  
 IF @COLLOPT = 'BEFORE HAIRCUT'  
 BEGIN  
  UPDATE FOMARGINNEW_EFFCOLL  
  SET EFFECTIVECOLL = ORGCASH + ORGNONCASH  
  FROM #COLLATERAL  
  WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
 END  
 ELSE  
  IF @COLLOPT = 'AFTER HAIRCUT'  
  BEGIN  
   UPDATE FOMARGINNEW_EFFCOLL  
   SET EFFECTIVECOLL = CASH + NONCASH  
   FROM #COLLATERAL  
   WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  END  
  ELSE  
  BEGIN  
   UPDATE FOMARGINNEW_EFFCOLL  
   SET EFFECTIVECOLL = ACTCASH + ACTNONCASH  
   FROM #COLLATERAL  
   WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  END  
END  
  
-- DROP TABLE #COLLATERAL  
IF @VALIDATEWITH = 'ONLY ACCOUNTS'  
 OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'  
BEGIN  
 CREATE TABLE [#CLOSEBAL] ([PARTY_CODE] [VARCHAR](12), [VAMT] [MONEY])  
  
 DECLARE @SDTCUR AS VARCHAR(11)  
  
 SELECT @SDTCUR = SDTCUR  
 FROM ACCOUNTNCE.DBO.PARAMETER(NOLOCK)  
 WHERE @MARGINDATE BETWEEN SDTCUR  
   AND LDTCUR  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 IF @ACTOPT = 'WITHOUT BILL'  
 BEGIN  
  IF (  
    SELECT COUNT(1)  
    FROM FOMG13REFERENCE(NOLOCK)  
    WHERE SUBJECT = 'ACTOPTION'  
     AND LEFT(HEADING, 16) = 'T+5 BASED LEDGER'  
     AND SUBMENUREFNO = 1  
    ) > 0  
  BEGIN  
   --EXEC PR_GET_LEDBAL_T5 @VALIDATIONDATE  
  
   INSERT INTO #CLOSEBAL  
   SELECT PARTY_CODE, LEDBAL  
   FROM FOMARGINNEW_LEDGERBAL  
   WHERE MARGINDATE = @MARGINDATE  
  END  
  
  DECLARE @INT_ACT_EDTVDT INT  
  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'VDT WISE LEDGER WITH EDT RECEIPTS LEDGER'  
  
  /*VDT WISE LEDGER BALANCE  WITH OUT BILL AND EDT WISE RECEIPTS BANK , RECEIPTS CASH ,MARGIN RECIEPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP <> '15'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('21', '1', '19', '2')  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT < (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'D'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT >= (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21', '1', '19', '2')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP IN ('1', '19', '2')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP IN ('1', '19', '2')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER'  
  
  /*EDT WISE LEDGER*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER'  
  
  /*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE + ' 23:59'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP IN ('1', '2', '19')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER VDT MARGIN LEDGER'  
  
  /*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE + ' 23:59'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
    --AND VTYP NOT IN ('1','2','19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND EDT > VDT  
     AND VTYP IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND EDT > VDT  
    --AND VTYP  IN ('1','2','19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE = M.PARTY_CODE, SUM(CASE   
       WHEN M.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.MARGINLEDGER M  
    LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP  
     AND M.BOOKTYPE = L.BOOKTYPE  
     AND M.VNO = L.VNO  
     AND M.LNO = L.LNO  
     AND L.VTYP IN ('19')  
    WHERE L.EDT >= @MARGINDATE  
    GROUP BY M.PARTY_CODE  
      
    UNION  
      
    SELECT CLTCODE = M.PARTY_CODE, SUM(CASE   
       WHEN M.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.MARGINLEDGER M  
    LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP  
     AND M.BOOKTYPE = L.BOOKTYPE  
     AND M.VNO = L.VNO  
     AND M.LNO = L.LNO  
     AND L.VTYP IN ('19')  
    WHERE L.EDT >= @VALIDATIONDATE  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY M.PARTY_CODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'VDT WISE LEDGER'  
  
  /*VDT WISE LEDGER BALANCE  WITH OUT BILL */  
  IF @INT_ACT_EDTVDT = 1  
   OR (  
    SELECT COUNT(1)  
    FROM FOMG13REFERENCE(NOLOCK)  
    WHERE SUBJECT = 'ACTOPTION'  
    ) = 0  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT <= @MARGINDATE + ' 23:59'  
     AND VTYP <> '15'  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT < (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'D'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT >= (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, /*CHEQUE CANCELED TILL T+5 OF VDT TILL T+1*/  
     SUM(CASE   
       WHEN A.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER A WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 B WITH (NOLOCK)  
    WHERE A.VTYP = '17'  
     AND A.VTYP = B.VTYP  
     AND A.VNO = B.VNO  
     AND A.BOOKTYPE = B.BOOKTYPE  
     AND A.LNO = B.LNO  
     AND A.VDT > @MARGINDATE + ' 23:59'  
     AND EXISTS (  
      SELECT L1.CLTCODE, L1.VAMT, L2.DDNO  
      FROM ACCOUNTNCE.DBO.LEDGER L1 WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 L2 WITH (NOLOCK)  
      WHERE L1.VTYP = '2' /*RECEIPTS VDT TILL T+1*/  
       AND L1.VTYP = L2.VTYP  
       AND L1.VNO = L2.VNO  
       AND L1.BOOKTYPE = L2.BOOKTYPE  
       AND L1.LNO = L2.LNO  
       AND L1.VDT >= @SDTCUR  
       AND L1.VDT <= @MARGINDATE + ' 23:59:58'  
       AND A.CLTCODE = L1.CLTCODE  
       AND A.VAMT = L1.VAMT  
       AND B.DDNO = L2.DDNO  
       AND L2.CLEAR_MODE = 'R'  
      )  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
    
  END  
    /*-----------------------------------------------------------------------------------------------*/  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #CLOSEBAL  
  SELECT CLTCODE, SUM(VAMT) VAMT  
  FROM (  
   SELECT CLTCODE, SUM(CASE   
      WHEN DRCR = 'C'  
       THEN VAMT  
      ELSE - VAMT  
      END) VAMT  
   FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
   WHERE VDT >= @SDTCUR  
    AND VDT <= @MARGINDATE + ' 23:59'  
   GROUP BY CLTCODE  
     
   UNION  
     
   SELECT CLTCODE, SUM(CASE   
      WHEN @VALIDATIONDATE <> @MARGINDATE  
       THEN CASE   
         WHEN DRCR = 'C'  
          THEN VAMT  
         ELSE - VAMT  
         END  
      ELSE 0  
      END) VAMT  
   FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
   WHERE VDT BETWEEN @VALIDATIONDATE  
     AND @VALIDATIONDATE + ' 23:59'  
    AND VTYP NOT IN ('15', '21')  
   GROUP BY CLTCODE  
   ) CLOSEBAL  
  GROUP BY CLTCODE  
 END  
  
 DECLARE @INT_ACT_CMLDGR INT  
  
 SET @INT_ACT_CMLDGR = 0  
  
 SELECT @INT_ACT_CMLDGR = SUBMENUREFNO  
 FROM FOMG13REFERENCE(NOLOCK)  
 WHERE SUBJECT = 'ACTOPTION'  
  AND HEADING = 'VDT WISE CM LEDGER' -- Capital Market Ledger Balance  
  
 IF @INT_ACT_CMLDGR = 1  
 BEGIN  
  INSERT INTO #CLOSEBAL  
  SELECT PARTY_CODE, 0  
  FROM FOMARGINNEW_EFFCOLL  
  WHERE NOT EXISTS (  
    SELECT PARTY_CODE  
    FROM #CLOSEBAL  
    WHERE #CLOSEBAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
    )  
  
  IF @ACTOPT = 'WITHOUT BILL'  
  BEGIN  
   UPDATE #CLOSEBAL  
   SET VAMT = VAMT + VAMT_CM  
   FROM (  
    SELECT CLTCODE, SUM(VAMT) VAMT_CM  
    FROM (  
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT <= @MARGINDATE + ' 23:59'  
      AND VTYP <> '15'  
     GROUP BY CLTCODE  
       
     UNION ALL  
       
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT < @MARGINDATE  
      AND VTYP = '15'  
      AND VDT < (  
       SELECT LEFT(MAX(SEC_PAYIN), 11)  
       FROM [ANAND1].MSAJAG.DBO.SETT_MST  
       WHERE SEC_PAYIN < @MARGINDATE  
        AND SETT_TYPE = 'N'  
       )  
     GROUP BY CLTCODE  
     ) CLOSEBAL  
    GROUP BY CLTCODE  
    ) CLOSEBAL_FINAL  
   WHERE CLTCODE = PARTY_CODE  
  END  
  ELSE  
  BEGIN  
   UPDATE #CLOSEBAL  
   SET VAMT = VAMT + VAMT_CM  
   FROM (  
    SELECT CLTCODE, SUM(VAMT) VAMT_CM  
    FROM (  
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT <= @MARGINDATE  
     GROUP BY CLTCODE  
       
     UNION  
       
     SELECT CLTCODE, SUM(CASE   
        WHEN @VALIDATIONDATE <> @MARGINDATE  
         THEN CASE   
           WHEN DRCR = 'C'  
            THEN VAMT  
           ELSE - VAMT  
           END  
        ELSE 0  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT BETWEEN @VALIDATIONDATE  
       AND @VALIDATIONDATE + ' 23:59'  
     GROUP BY CLTCODE  
     ) CLOSEBAL  
    GROUP BY CLTCODE  
    ) CLOSEBAL_FINAL  
   WHERE CLTCODE = PARTY_CODE  
  END  
 END  
  
 SELECT PARTY_CODE = PARENTCODE, VAMT = SUM(VAMT)  
 INTO #CLOSEBAL_FINAL  
 FROM #CLOSEBAL(NOLOCK), CLIENT2_VIEW(NOLOCK)  
 WHERE #CLOSEBAL.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
 GROUP BY PARENTCODE  
  
 UPDATE FOMARGINNEW_EFFCOLL  
 SET EFFECTIVECOLL = EFFECTIVECOLL + VAMT  
 FROM #CLOSEBAL_FINAL  
 WHERE #CLOSEBAL_FINAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  
 DROP TABLE #CLOSEBAL  
END  
  
IF CONVERT(DATETIME, @MarginDate) > CONVERT(DATETIME, 'JUL  1 2018')  
BEGIN  
 
 ------ Below condition committed on Dt 17JAN2025 SRE-33198 BY VAIBHAV K----- 
 /*
 TRUNCATE TABLE FoMarginNew_EffColl  
  
 INSERT INTO FoMarginNew_EffColl  
 SELECT PARTY_CODE, (  
   CASE   
    WHEN T_MARGINAVL > 0  
     THEN TDAY_MARGIN  
    ELSE TDAY_MARGIN + T_MARGINAVL  
    END  
   ) + (  
   CASE   
    WHEN T_MTMAVL > 0  
     THEN TDAY_MTM  
    ELSE TDAY_MTM + T_MTMAVL  
    END  
   ),0,0  
 FROM [ANAND1].MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL  
 WHERE MARGINDATE = @MarginDate  
  AND EXCHANGE = 'NCE'  
  AND SEGMENT = 'FUTURES'  
END  
  */
  -------------------------END ------------------------------

  ----- Added condition 17JAN2025 SRE-33198 ---------

  SELECT * INTO #FoMarginNew_EffColl FROM FoMarginNew_EffColl WHERE 1 = 2

	TRUNCATE TABLE FoMarginNew_EffColl

	INSERT INTO #FoMarginNew_EffColl
	SELECT PARTY_CODE, (
			CASE 
				WHEN T_MARGINAVL > 0
					THEN TDAY_MARGIN
				ELSE TDAY_MARGIN + T_MARGINAVL
				END
			) + (
			CASE 
				WHEN T_MTMAVL > 0
					THEN TDAY_MTM
				ELSE TDAY_MTM + T_MTMAVL
				END
			),0,0,0
	FROM [ANAND1].MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL
	WHERE MARGINDATE = @MarginDate
		AND EXCHANGE = 'NCE'
		AND SEGMENT = 'FUTURES'

	INSERT INTO #FoMarginNew_EffColl
	SELECT PARTY_CODE, 0,0,0,0
	FROM FOMARGINNEW WHERE MDATE BETWEEN  @MARGINDATE AND @MARGINDATE + ' 23:59' AND CL_TYPE <> 'TM' AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #FoMarginNew_EffColl)
 

	INSERT INTO FoMarginNew_EffColl
	SELECT PARTY_CODE, EffectiveColl = SUM(EffectiveColl), EFFECTIVECOLL_OTHER = sum(EFFECTIVECOLL_OTHER), EFFECTIVECOLL_MTOM = sum(EFFECTIVECOLL_MTOM), EffectiveColl_PEAK = sum(EffectiveColl_PEAK)
	from 
		(
		 select party_code, EffectiveColl,EFFECTIVECOLL_OTHER, EFFECTIVECOLL_MTOM,EffectiveColl_PEAK from #FoMarginNew_EffColl
		 union all
		 select party_code, EffectiveColl = convert(numeric(18,4),0),0,0, EffectiveColl_Peak = (case when t_marginavl > 0 then tday_margin else tday_margin + t_marginavl end)
		 from [ANAND1].MSAJAG.DBO.TBL_COMBINE_REPORTING_peak_DETAIL
	WHERE MARGINDATE = @MarginDate
		AND EXCHANGE = 'NCE'
		AND SEGMENT = 'FUTURES' ) A 
		group by party_code 

END

 

----- Added condition 17JAN2025 SRE-33198 ---------



UPDATE FoMarginNew_EffColl  
SET EFFECTIVECOLL = 0  
WHERE EFFECTIVECOLL < 0  
 SELECT * FROM FOMARGINNEW_EFFCOLL 
CREATE TABLE [#SHORTAGE] ([PARTY_CODE] [VARCHAR](12), [EFFECTIVECOLL] [MONEY], [BRKSHORT] [MONEY], [SLAB] [INT], [MINIMUMPERCENTAGE] [DECIMAL](18, 2), [BRKPENALITY] [MONEY])  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF @ACTOPT = 'WITHOUT BILL'  
BEGIN  
 INSERT INTO #SHORTAGE  
 SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - TOTALMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - TOTALMARGIN) * 100 / TOTALMARGIN) MINIMUMPERCENTAGE, 0  
 FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)  
 WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
   AND @MARGINDATE + ' 23:59'  
  AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
  AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.TOTALMARGIN  
  AND TOTALMARGIN > 0  
END  
ELSE  
BEGIN  
 IF @VALIDATEWITH = 'NONE'  
 BEGIN  
  UPDATE FOMARGINNEW_EFFCOLL  
  SET EFFECTIVECOLL = PSPANMARGIN  
  FROM FOMARGINNEW(NOLOCK)  
  WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
    AND @MARGINDATE + ' 23:59'  
   AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
   AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN  
   AND PSPANMARGIN > 0  
  
  INSERT INTO #SHORTAGE  
  SELECT PARTY_CODE, EFFECTIVECOLL, 0 BRKSHORT, 0, 0 MINIMUMPERCENTAGE, 0  
  FROM FOMARGINNEW_EFFCOLL(NOLOCK)  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #SHORTAGE  
  SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - PSPANMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - PSPANMARGIN) * 100 / PSPANMARGIN) MINIMUMPERCENTAGE, 0  
  FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)  
  WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
    AND @MARGINDATE + ' 23:59'  
   AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
   AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN  
   AND PSPANMARGIN > 0  
 END  
END  
  
UPDATE #SHORTAGE  
SET SLAB = FOMG13PENALTYMASTER.SLAB, MINIMUMPERCENTAGE = FOMG13PENALTYMASTER.MINIMUMPERCENTAGE, BRKPENALITY = CASE   
  WHEN CHARGEFLAG = 1  
   THEN CASE   
     WHEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100 > FOMG13PENALTYMASTER.MINIMUMAMT)  
      THEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100)  
     ELSE MINIMUMAMT  
     END  
  ELSE 0  
  END  
FROM FOMG13PENALTYMASTER(NOLOCK)  
WHERE TOPENALTYPERCENTAGE >= ABS(#SHORTAGE.MINIMUMPERCENTAGE)  
 AND FROMPENALTYPERCENTAGE <= ABS(#SHORTAGE.MINIMUMPERCENTAGE)  
 AND EFFECTIVEDATE = (  
  SELECT MAX(EFFECTIVEDATE)  
  FROM FOMG13PENALTYMASTER  
  WHERE EFFECTIVEDATE <= @MARGINDATE  
  )  
  
DELETE FOMG13SHORTAGE  
WHERE FILEDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND BATCH_NO = @BATCHNO  
 AND REFNO = @REFNO  
  
INSERT INTO FOMG13SHORTAGE  
SELECT @MARGINDATE, #SHORTAGE.PARTY_CODE, @BATCHNO, @REFNO, TOTALMARGIN, EFFECTIVECOLL, EFFECTIVECOLL, BRKSHORT, BRKSHORT, SLAB, SLAB, MINIMUMPERCENTAGE, BRKPENALITY, MINIMUMPERCENTAGE, BRKPENALITY, '', '', 0  
FROM #SHORTAGE(NOLOCK), FOMARGINNEW(NOLOCK)  
WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND #SHORTAGE.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
  
DROP TABLE #SHORTAGE  
  
INSERT INTO FOMARGIN_SHORTAGE_LOG  
VALUES (@MARGINDATE, @VALIDATEWITH, @ACTOPT, @COLLOPT, @BATCHNO, @REFNO, @VALIDATIONDATE, '', GETDATE())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGINNEW_CALC_BKUP_08Apr2024
-- --------------------------------------------------
CREATE PROC [dbo].[FOMARGINNEW_CALC] (@MARGINDATE VARCHAR(11), @VALIDATEWITH VARCHAR(30), @ACTOPT VARCHAR(30), @COLLOPT VARCHAR(30), @BATCHNO VARCHAR(10), @REFNO INT, @VALIDATIONDATE VARCHAR(11) = @MARGINDATE)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE @MEMBERCODE VARCHAR(15)

SELECT @MEMBERCODE = MEMBERCODE
FROM FOOWNER

SET @ACTOPT = 'WITHOUT BILL'

TRUNCATE TABLE FOMARGINNEW_EFFCOLL

DELETE
FROM FOMARGINNEW
WHERE MDATE BETWEEN @MARGINDATE
		AND @MARGINDATE + ' 23:59'
	AND PARTY_CODE = @membercode

INSERT INTO FOMARGINNEW_EFFCOLL
SELECT PARTY_CODE, 0
FROM FOMARGINNEW
WHERE MDATE LIKE @MARGINDATE + '%'
	AND CL_TYPE <> 'TM'

IF @VALIDATEWITH = 'ONLY COLLATERAL'
	OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'
BEGIN
	CREATE TABLE [#COLLATERAL] ([PARTY_CODE] [VARCHAR](12), [CASH] [MONEY], [NONCASH] [MONEY], [ACTCASH] [MONEY], [ACTNONCASH] [MONEY], [ORGCASH] [MONEY], [ORGNONCASH] [MONEY])

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (
			SELECT COUNT(1)
			FROM FOMG13REFERENCE
			WHERE SUBJECT = 'MRGOPTION'
				AND HEADING = 'T -1 DAY VALUATION'
				AND SUBMENUREFNO = 1
			) > 0
	BEGIN
		--EXEC TBL_COLLATERAL_MARGIN_UPD @VALIDATIONDATE

		INSERT INTO #COLLATERAL
		SELECT PARTY_CODE = PARENTCODE, SUM(CASE 
					WHEN CASH_NCASH = 'C'
						THEN FINALAMOUNT
					ELSE 0
					END), SUM(CASE 
					WHEN CASH_NCASH = 'N'
						THEN FINALAMOUNT
					ELSE 0
					END), CASH = MAX(CASH), NONCASH = MAX(NONCASH), SUM(CASE 
					WHEN CASH_NCASH = 'C'
						THEN AMOUNT
					ELSE 0
					END), SUM(CASE 
					WHEN CASH_NCASH = 'N'
						THEN AMOUNT
					ELSE 0
					END)
		FROM TBL_COLLATERAL_MARGIN C(NOLOCK), CLIENT2_VIEW(NOLOCK)
		WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
			AND EFFDATE BETWEEN @VALIDATIONDATE
				AND @VALIDATIONDATE + ' 23:59'
			AND EXISTS (
				SELECT PARTY_CODE
				FROM FOMARGINNEW_EFFCOLL F(NOLOCK)
				WHERE F.PARTY_CODE = PARENTCODE
				)
		GROUP BY PARENTCODE
	END
	ELSE
	BEGIN
		IF (
				SELECT COUNT(1)
				FROM MSAJAG.DBO.COLLATERAL C(NOLOCK)
				WHERE C.EXCHANGE = (
						SELECT TOP 1 EXCHANGE
						FROM FOGLOBALS(NOLOCK)
						)
					AND SEGMENT LIKE 'FUT%'
					AND TRANS_DATE BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
				) > 0
		BEGIN
			INSERT INTO #COLLATERAL
			SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
			FROM MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)
			WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
				AND C.EXCHANGE = (
					SELECT TOP 1 EXCHANGE
					FROM FOGLOBALS(NOLOCK)
					)
				AND SEGMENT LIKE 'FUT%'
				AND TRANS_DATE BETWEEN @VALIDATIONDATE
					AND @VALIDATIONDATE + ' 23:59'
				AND EXISTS (
					SELECT PARTY_CODE
					FROM FOMARGINNEW_EFFCOLL F(NOLOCK)
					WHERE F.PARTY_CODE = PARENTCODE
					)
			GROUP BY PARENTCODE
		END
		ELSE
		BEGIN
			INSERT INTO #COLLATERAL
			SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
			FROM MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)
			WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
				AND C.EXCHANGE = (
					SELECT TOP 1 EXCHANGE
					FROM FOGLOBALS(NOLOCK)
					)
				AND SEGMENT LIKE 'FUT%'
				AND TRANS_DATE BETWEEN @MARGINDATE
					AND @MARGINDATE + ' 23:59'
				AND EXISTS (
					SELECT PARTY_CODE
					FROM FOMARGINNEW_EFFCOLL F(NOLOCK)
					WHERE F.PARTY_CODE = PARENTCODE
					)
			GROUP BY PARENTCODE
		END
	END

	IF @COLLOPT = 'BEFORE HAIRCUT'
	BEGIN
		UPDATE FOMARGINNEW_EFFCOLL
		SET EFFECTIVECOLL = ORGCASH + ORGNONCASH
		FROM #COLLATERAL
		WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE
	END
	ELSE
		IF @COLLOPT = 'AFTER HAIRCUT'
		BEGIN
			UPDATE FOMARGINNEW_EFFCOLL
			SET EFFECTIVECOLL = CASH + NONCASH
			FROM #COLLATERAL
			WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE
		END
		ELSE
		BEGIN
			UPDATE FOMARGINNEW_EFFCOLL
			SET EFFECTIVECOLL = ACTCASH + ACTNONCASH
			FROM #COLLATERAL
			WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE
		END
END

-- DROP TABLE #COLLATERAL
IF @VALIDATEWITH = 'ONLY ACCOUNTS'
	OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'
BEGIN
	CREATE TABLE [#CLOSEBAL] ([PARTY_CODE] [VARCHAR](12), [VAMT] [MONEY])

	DECLARE @SDTCUR AS VARCHAR(11)

	SELECT @SDTCUR = SDTCUR
	FROM ACCOUNTNCE.DBO.PARAMETER(NOLOCK)
	WHERE @MARGINDATE BETWEEN SDTCUR
			AND LDTCUR

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF @ACTOPT = 'WITHOUT BILL'
	BEGIN
		IF (
				SELECT COUNT(1)
				FROM FOMG13REFERENCE(NOLOCK)
				WHERE SUBJECT = 'ACTOPTION'
					AND LEFT(HEADING, 16) = 'T+5 BASED LEDGER'
					AND SUBMENUREFNO = 1
				) > 0
		BEGIN
			--EXEC PR_GET_LEDBAL_T5 @VALIDATIONDATE

			INSERT INTO #CLOSEBAL
			SELECT PARTY_CODE, LEDBAL
			FROM FOMARGINNEW_LEDGERBAL
			WHERE MARGINDATE = @MARGINDATE
		END

		DECLARE @INT_ACT_EDTVDT INT

		SET @INT_ACT_EDTVDT = 0

		SELECT @INT_ACT_EDTVDT = SUBMENUREFNO
		FROM FOMG13REFERENCE(NOLOCK)
		WHERE SUBJECT = 'ACTOPTION'
			AND HEADING = 'VDT WISE LEDGER WITH EDT RECEIPTS LEDGER'

		/*VDT WISE LEDGER BALANCE  WITH OUT BILL AND EDT WISE RECEIPTS BANK , RECEIPTS CASH ,MARGIN RECIEPTS*/
		IF @INT_ACT_EDTVDT = 1
		BEGIN
			INSERT INTO #CLOSEBAL
			SELECT CLTCODE, SUM(VAMT) VAMT
			FROM (
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND VDT < @MARGINDATE
					AND VTYP <> '15'
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP NOT IN ('21', '1', '19', '2')
				GROUP BY CLTCODE
				
				UNION ALL
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND VDT < @MARGINDATE
					AND VTYP = '15'
					AND VDT < (
						SELECT LEFT(MAX(SEC_PAYIN), 11)
						FROM MSAJAG.DBO.SETT_MST
						WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'
						)
				GROUP BY CLTCODE
				
				UNION ALL
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT < @SDTCUR
					AND VDT < @MARGINDATE
					AND VTYP = '15'
					AND VDT >= (
						SELECT LEFT(MAX(SEC_PAYIN), 11)
						FROM MSAJAG.DBO.SETT_MST
						WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'
						)
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND VTYP NOT IN ('15', '21', '1', '19', '2')
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP IN ('1', '19', '2')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND VTYP IN ('1', '19', '2')
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY CLTCODE
				) CLOSEBAL
			GROUP BY CLTCODE
		END

		/*-----------------------------------------------------------------------------------------------*/
		SET @INT_ACT_EDTVDT = 0

		SELECT @INT_ACT_EDTVDT = SUBMENUREFNO
		FROM FOMG13REFERENCE(NOLOCK)
		WHERE SUBJECT = 'ACTOPTION'
			AND HEADING = 'EDT WISE LEDGER'

		/*EDT WISE LEDGER*/
		IF @INT_ACT_EDTVDT = 1
		BEGIN
			INSERT INTO #CLOSEBAL
			SELECT CLTCODE, SUM(VAMT) VAMT
			FROM (
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND EDT < @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN - VAMT
							ELSE VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT >= @SDTCUR
					AND VDT < @SDTCUR
					AND VDT < @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP NOT IN ('15', '21')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND VTYP NOT IN ('15', '21')
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY CLTCODE
				) CLOSEBAL
			GROUP BY CLTCODE
		END

		/*-----------------------------------------------------------------------------------------------*/
		SET @INT_ACT_EDTVDT = 0

		SELECT @INT_ACT_EDTVDT = SUBMENUREFNO
		FROM FOMG13REFERENCE(NOLOCK)
		WHERE SUBJECT = 'ACTOPTION'
			AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER'

		/*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/
		IF @INT_ACT_EDTVDT = 1
		BEGIN
			INSERT INTO #CLOSEBAL
			SELECT CLTCODE, SUM(VAMT) VAMT
			FROM (
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND EDT < @MARGINDATE + ' 23:59'
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN - VAMT
							ELSE VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT >= @SDTCUR
					AND VDT < @SDTCUR
					AND VDT < @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP NOT IN ('1', '2', '19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND VTYP NOT IN ('1', '2', '19')
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP IN ('1', '2', '19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND VTYP IN ('1', '2', '19')
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY CLTCODE
				) CLOSEBAL
			GROUP BY CLTCODE
		END

		/*-----------------------------------------------------------------------------------------------*/
		SET @INT_ACT_EDTVDT = 0

		SELECT @INT_ACT_EDTVDT = SUBMENUREFNO
		FROM FOMG13REFERENCE(NOLOCK)
		WHERE SUBJECT = 'ACTOPTION'
			AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER VDT MARGIN LEDGER'

		/*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/
		IF @INT_ACT_EDTVDT = 1
		BEGIN
			INSERT INTO #CLOSEBAL
			SELECT CLTCODE, SUM(VAMT) VAMT
			FROM (
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND EDT < @MARGINDATE + ' 23:59'
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN - VAMT
							ELSE VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT >= @SDTCUR
					AND VDT < @SDTCUR
					AND VDT < @MARGINDATE
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND VTYP NOT IN ('1', '2', '19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE EDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
				--AND VTYP NOT IN ('1','2','19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @MARGINDATE
						AND @MARGINDATE + ' 23:59'
					AND EDT > VDT
					AND VTYP IN ('1', '2', '19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE, SUM(CASE 
							WHEN @VALIDATIONDATE <> @MARGINDATE
								THEN CASE 
										WHEN DRCR = 'C'
											THEN VAMT
										ELSE - VAMT
										END
							ELSE 0
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT BETWEEN @VALIDATIONDATE
						AND @VALIDATIONDATE + ' 23:59'
					AND EDT > VDT
				--AND VTYP  IN ('1','2','19')
				GROUP BY CLTCODE
				
				UNION
				
				SELECT CLTCODE = M.PARTY_CODE, SUM(CASE 
							WHEN M.DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.MARGINLEDGER M
				LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP
					AND M.BOOKTYPE = L.BOOKTYPE
					AND M.VNO = L.VNO
					AND M.LNO = L.LNO
					AND L.VTYP IN ('19')
				WHERE L.EDT >= @MARGINDATE
				GROUP BY M.PARTY_CODE
				
				UNION
				
				SELECT CLTCODE = M.PARTY_CODE, SUM(CASE 
							WHEN M.DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.MARGINLEDGER M
				LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP
					AND M.BOOKTYPE = L.BOOKTYPE
					AND M.VNO = L.VNO
					AND M.LNO = L.LNO
					AND L.VTYP IN ('19')
				WHERE L.EDT >= @VALIDATIONDATE
					AND @VALIDATIONDATE <> @MARGINDATE
				GROUP BY M.PARTY_CODE
				) CLOSEBAL
			GROUP BY CLTCODE
		END

		/*-----------------------------------------------------------------------------------------------*/
		SET @INT_ACT_EDTVDT = 0

		SELECT @INT_ACT_EDTVDT = SUBMENUREFNO
		FROM FOMG13REFERENCE(NOLOCK)
		WHERE SUBJECT = 'ACTOPTION'
			AND HEADING = 'VDT WISE LEDGER'

		/*VDT WISE LEDGER BALANCE  WITH OUT BILL */
		IF @INT_ACT_EDTVDT = 1
			OR (
				SELECT COUNT(1)
				FROM FOMG13REFERENCE(NOLOCK)
				WHERE SUBJECT = 'ACTOPTION'
				) = 0
		BEGIN
			INSERT INTO #CLOSEBAL
			SELECT CLTCODE, SUM(VAMT) VAMT
			FROM (
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND VDT <= @MARGINDATE + ' 23:59'
					AND VTYP <> '15'
				GROUP BY CLTCODE
				
				UNION ALL
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT >= @SDTCUR
					AND VDT < @MARGINDATE
					AND VTYP = '15'
					AND VDT < (
						SELECT LEFT(MAX(SEC_PAYIN), 11)
						FROM MSAJAG.DBO.SETT_MST
						WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'
						)
				GROUP BY CLTCODE
				
				UNION ALL
				
				SELECT CLTCODE, SUM(CASE 
							WHEN DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
				WHERE VDT < @SDTCUR
					AND VDT < @MARGINDATE
					AND VTYP = '15'
					AND VDT >= (
						SELECT LEFT(MAX(SEC_PAYIN), 11)
						FROM MSAJAG.DBO.SETT_MST
						WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'
						)
				GROUP BY CLTCODE
				
				UNION ALL
				
				SELECT CLTCODE, /*CHEQUE CANCELED TILL T+5 OF VDT TILL T+1*/
					SUM(CASE 
							WHEN A.DRCR = 'C'
								THEN VAMT
							ELSE - VAMT
							END) VAMT
				FROM ACCOUNTNCE.DBO.LEDGER A WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 B WITH (NOLOCK)
				WHERE A.VTYP = '17'
					AND A.VTYP = B.VTYP
					AND A.VNO = B.VNO
					AND A.BOOKTYPE = B.BOOKTYPE
					AND A.LNO = B.LNO
					AND A.VDT > @MARGINDATE + ' 23:59'
					AND EXISTS (
						SELECT L1.CLTCODE, L1.VAMT, L2.DDNO
						FROM ACCOUNTNCE.DBO.LEDGER L1 WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 L2 WITH (NOLOCK)
						WHERE L1.VTYP = '2' /*RECEIPTS VDT TILL T+1*/
							AND L1.VTYP = L2.VTYP
							AND L1.VNO = L2.VNO
							AND L1.BOOKTYPE = L2.BOOKTYPE
							AND L1.LNO = L2.LNO
							AND L1.VDT >= @SDTCUR
							AND L1.VDT <= @MARGINDATE + ' 23:59:58'
							AND A.CLTCODE = L1.CLTCODE
							AND A.VAMT = L1.VAMT
							AND B.DDNO = L2.DDNO
							AND L2.CLEAR_MODE = 'R'
						)
				GROUP BY CLTCODE
				) CLOSEBAL
			GROUP BY CLTCODE
		
		END
				/*-----------------------------------------------------------------------------------------------*/
	END
	ELSE
	BEGIN
		INSERT INTO #CLOSEBAL
		SELECT CLTCODE, SUM(VAMT) VAMT
		FROM (
			SELECT CLTCODE, SUM(CASE 
						WHEN DRCR = 'C'
							THEN VAMT
						ELSE - VAMT
						END) VAMT
			FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
			WHERE VDT >= @SDTCUR
				AND VDT <= @MARGINDATE + ' 23:59'
			GROUP BY CLTCODE
			
			UNION
			
			SELECT CLTCODE, SUM(CASE 
						WHEN @VALIDATIONDATE <> @MARGINDATE
							THEN CASE 
									WHEN DRCR = 'C'
										THEN VAMT
									ELSE - VAMT
									END
						ELSE 0
						END) VAMT
			FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)
			WHERE VDT BETWEEN @VALIDATIONDATE
					AND @VALIDATIONDATE + ' 23:59'
				AND VTYP NOT IN ('15', '21')
			GROUP BY CLTCODE
			) CLOSEBAL
		GROUP BY CLTCODE
	END

	DECLARE @INT_ACT_CMLDGR INT

	SET @INT_ACT_CMLDGR = 0

	SELECT @INT_ACT_CMLDGR = SUBMENUREFNO
	FROM FOMG13REFERENCE(NOLOCK)
	WHERE SUBJECT = 'ACTOPTION'
		AND HEADING = 'VDT WISE CM LEDGER' -- Capital Market Ledger Balance

	IF @INT_ACT_CMLDGR = 1
	BEGIN
		INSERT INTO #CLOSEBAL
		SELECT PARTY_CODE, 0
		FROM FOMARGINNEW_EFFCOLL
		WHERE NOT EXISTS (
				SELECT PARTY_CODE
				FROM #CLOSEBAL
				WHERE #CLOSEBAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE
				)

		IF @ACTOPT = 'WITHOUT BILL'
		BEGIN
			UPDATE #CLOSEBAL
			SET VAMT = VAMT + VAMT_CM
			FROM (
				SELECT CLTCODE, SUM(VAMT) VAMT_CM
				FROM (
					SELECT CLTCODE, SUM(CASE 
								WHEN DRCR = 'C'
									THEN VAMT
								ELSE - VAMT
								END) VAMT
					FROM ACCOUNT.DBO.LEDGER(NOLOCK)
					WHERE VDT >= @SDTCUR
						AND VDT <= @MARGINDATE + ' 23:59'
						AND VTYP <> '15'
					GROUP BY CLTCODE
					
					UNION ALL
					
					SELECT CLTCODE, SUM(CASE 
								WHEN DRCR = 'C'
									THEN VAMT
								ELSE - VAMT
								END) VAMT
					FROM ACCOUNT.DBO.LEDGER(NOLOCK)
					WHERE VDT >= @SDTCUR
						AND VDT < @MARGINDATE
						AND VTYP = '15'
						AND VDT < (
							SELECT LEFT(MAX(SEC_PAYIN), 11)
							FROM MSAJAG.DBO.SETT_MST
							WHERE SEC_PAYIN < @MARGINDATE
								AND SETT_TYPE = 'N'
							)
					GROUP BY CLTCODE
					) CLOSEBAL
				GROUP BY CLTCODE
				) CLOSEBAL_FINAL
			WHERE CLTCODE = PARTY_CODE
		END
		ELSE
		BEGIN
			UPDATE #CLOSEBAL
			SET VAMT = VAMT + VAMT_CM
			FROM (
				SELECT CLTCODE, SUM(VAMT) VAMT_CM
				FROM (
					SELECT CLTCODE, SUM(CASE 
								WHEN DRCR = 'C'
									THEN VAMT
								ELSE - VAMT
								END) VAMT
					FROM ACCOUNT.DBO.LEDGER(NOLOCK)
					WHERE VDT >= @SDTCUR
						AND VDT <= @MARGINDATE
					GROUP BY CLTCODE
					
					UNION
					
					SELECT CLTCODE, SUM(CASE 
								WHEN @VALIDATIONDATE <> @MARGINDATE
									THEN CASE 
											WHEN DRCR = 'C'
												THEN VAMT
											ELSE - VAMT
											END
								ELSE 0
								END) VAMT
					FROM ACCOUNT.DBO.LEDGER(NOLOCK)
					WHERE VDT BETWEEN @VALIDATIONDATE
							AND @VALIDATIONDATE + ' 23:59'
					GROUP BY CLTCODE
					) CLOSEBAL
				GROUP BY CLTCODE
				) CLOSEBAL_FINAL
			WHERE CLTCODE = PARTY_CODE
		END
	END

	SELECT PARTY_CODE = PARENTCODE, VAMT = SUM(VAMT)
	INTO #CLOSEBAL_FINAL
	FROM #CLOSEBAL(NOLOCK), CLIENT2_VIEW(NOLOCK)
	WHERE #CLOSEBAL.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
	GROUP BY PARENTCODE

	UPDATE FOMARGINNEW_EFFCOLL
	SET EFFECTIVECOLL = EFFECTIVECOLL + VAMT
	FROM #CLOSEBAL_FINAL
	WHERE #CLOSEBAL_FINAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE

	DROP TABLE #CLOSEBAL
END

IF CONVERT(DATETIME, @MarginDate) > CONVERT(DATETIME, 'JUL  1 2018')
BEGIN
	TRUNCATE TABLE FoMarginNew_EffColl

	INSERT INTO FoMarginNew_EffColl
	SELECT PARTY_CODE, (
			CASE 
				WHEN T_MARGINAVL > 0
					THEN TDAY_MARGIN
				ELSE TDAY_MARGIN + T_MARGINAVL
				END
			) + (
			CASE 
				WHEN T_MTMAVL > 0
					THEN TDAY_MTM
				ELSE TDAY_MTM + T_MTMAVL
				END
			)
	FROM AngelNSECM.MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL
	WHERE MARGINDATE = @MarginDate
		AND EXCHANGE = 'NCE'
		AND SEGMENT = 'FUTURES'
END

UPDATE FoMarginNew_EffColl
SET EFFECTIVECOLL = 0
WHERE EFFECTIVECOLL < 0

CREATE TABLE [#SHORTAGE] ([PARTY_CODE] [VARCHAR](12), [EFFECTIVECOLL] [MONEY], [BRKSHORT] [MONEY], [SLAB] [INT], [MINIMUMPERCENTAGE] [DECIMAL](18, 2), [BRKPENALITY] [MONEY])

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @ACTOPT = 'WITHOUT BILL'
BEGIN
	INSERT INTO #SHORTAGE
	SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - TOTALMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - TOTALMARGIN) * 100 / TOTALMARGIN) MINIMUMPERCENTAGE, 0
	FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)
	WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE
			AND @MARGINDATE + ' 23:59'
		AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
		AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.TOTALMARGIN
		AND TOTALMARGIN > 0
END
ELSE
BEGIN
	IF @VALIDATEWITH = 'NONE'
	BEGIN
		UPDATE FOMARGINNEW_EFFCOLL
		SET EFFECTIVECOLL = PSPANMARGIN
		FROM FOMARGINNEW(NOLOCK)
		WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE
				AND @MARGINDATE + ' 23:59'
			AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
			AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN
			AND PSPANMARGIN > 0

		INSERT INTO #SHORTAGE
		SELECT PARTY_CODE, EFFECTIVECOLL, 0 BRKSHORT, 0, 0 MINIMUMPERCENTAGE, 0
		FROM FOMARGINNEW_EFFCOLL(NOLOCK)
	END
	ELSE
	BEGIN
		INSERT INTO #SHORTAGE
		SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - PSPANMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - PSPANMARGIN) * 100 / PSPANMARGIN) MINIMUMPERCENTAGE, 0
		FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)
		WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE
				AND @MARGINDATE + ' 23:59'
			AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
			AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN
			AND PSPANMARGIN > 0
	END
END

UPDATE #SHORTAGE
SET SLAB = FOMG13PENALTYMASTER.SLAB, MINIMUMPERCENTAGE = FOMG13PENALTYMASTER.MINIMUMPERCENTAGE, BRKPENALITY = CASE 
		WHEN CHARGEFLAG = 1
			THEN CASE 
					WHEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100 > FOMG13PENALTYMASTER.MINIMUMAMT)
						THEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100)
					ELSE MINIMUMAMT
					END
		ELSE 0
		END
FROM FOMG13PENALTYMASTER(NOLOCK)
WHERE TOPENALTYPERCENTAGE >= ABS(#SHORTAGE.MINIMUMPERCENTAGE)
	AND FROMPENALTYPERCENTAGE <= ABS(#SHORTAGE.MINIMUMPERCENTAGE)
	AND EFFECTIVEDATE = (
		SELECT MAX(EFFECTIVEDATE)
		FROM FOMG13PENALTYMASTER
		WHERE EFFECTIVEDATE <= @MARGINDATE
		)

DELETE FOMG13SHORTAGE
WHERE FILEDATE BETWEEN @MARGINDATE
		AND @MARGINDATE + ' 23:59'
	AND BATCH_NO = @BATCHNO
	AND REFNO = @REFNO

INSERT INTO FOMG13SHORTAGE
SELECT @MARGINDATE, #SHORTAGE.PARTY_CODE, @BATCHNO, @REFNO, 
TOTALMARGIN, EFFECTIVECOLL, EFFECTIVECOLL, BRKSHORT, BRKSHORT, SLAB, SLAB, MINIMUMPERCENTAGE, BRKPENALITY, MINIMUMPERCENTAGE, BRKPENALITY, '', '', 0
FROM #SHORTAGE(NOLOCK), FOMARGINNEW(NOLOCK)
WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE
		AND @MARGINDATE + ' 23:59'
	AND #SHORTAGE.PARTY_CODE = FOMARGINNEW.PARTY_CODE

DROP TABLE #SHORTAGE

INSERT INTO FOMARGIN_SHORTAGE_LOG
VALUES (@MARGINDATE, @VALIDATEWITH, @ACTOPT, @COLLOPT, @BATCHNO, @REFNO, @VALIDATIONDATE, '', GETDATE())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGINNEW_CALC_BKUP_17JAN2025
-- --------------------------------------------------
  
CREATE PROC [dbo].[FOMARGINNEW_CALC_BKUP_17JAN2025] (@MARGINDATE VARCHAR(11), @VALIDATEWITH VARCHAR(30), @ACTOPT VARCHAR(30), @COLLOPT VARCHAR(30), @BATCHNO VARCHAR(10), @REFNO INT, @VALIDATIONDATE VARCHAR(11) = @MARGINDATE)  
AS  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DECLARE @MEMBERCODE VARCHAR(15)  
  
SELECT @MEMBERCODE = MEMBERCODE  
FROM FOOWNER  
  
SET @ACTOPT = 'WITHOUT BILL'  
  
TRUNCATE TABLE FOMARGINNEW_EFFCOLL  
  
DELETE  
FROM FOMARGINNEW  
WHERE MDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND PARTY_CODE = @membercode  
  
INSERT INTO FOMARGINNEW_EFFCOLL  
SELECT PARTY_CODE, 0,0,0  
FROM FOMARGINNEW  
WHERE MDATE LIKE @MARGINDATE + '%'  
 AND CL_TYPE <> 'TM'  

IF @VALIDATEWITH = 'ONLY COLLATERAL'  
 OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'  
BEGIN  
 CREATE TABLE [#COLLATERAL] ([PARTY_CODE] [VARCHAR](12), [CASH] [MONEY], [NONCASH] [MONEY], [ACTCASH] [MONEY], [ACTNONCASH] [MONEY], [ORGCASH] [MONEY], [ORGNONCASH] [MONEY])  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 IF (  
   SELECT COUNT(1)  
   FROM FOMG13REFERENCE  
   WHERE SUBJECT = 'MRGOPTION'  
    AND HEADING = 'T -1 DAY VALUATION'  
    AND SUBMENUREFNO = 1  
   ) > 0  
 BEGIN  
  --EXEC TBL_COLLATERAL_MARGIN_UPD @VALIDATIONDATE  
  
  INSERT INTO #COLLATERAL  
  SELECT PARTY_CODE = PARENTCODE, SUM(CASE   
     WHEN CASH_NCASH = 'C'  
      THEN FINALAMOUNT  
     ELSE 0  
     END), SUM(CASE   
     WHEN CASH_NCASH = 'N'  
      THEN FINALAMOUNT  
     ELSE 0  
     END), CASH = MAX(CASH), NONCASH = MAX(NONCASH), SUM(CASE   
     WHEN CASH_NCASH = 'C'  
      THEN AMOUNT  
     ELSE 0  
     END), SUM(CASE   
     WHEN CASH_NCASH = 'N'  
      THEN AMOUNT  
     ELSE 0  
     END)  
  FROM TBL_COLLATERAL_MARGIN C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
  WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
   AND EFFDATE BETWEEN @VALIDATIONDATE  
    AND @VALIDATIONDATE + ' 23:59'  
   AND EXISTS (  
    SELECT PARTY_CODE  
    FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
    WHERE F.PARTY_CODE = PARENTCODE  
    )  
  GROUP BY PARENTCODE  
 END  
 ELSE  
 BEGIN  
  IF (  
    SELECT COUNT(1)  
    FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK)  
    WHERE C.EXCHANGE = (  
      SELECT TOP 1 EXCHANGE  
      FROM FOGLOBALS(NOLOCK)  
      )  
     AND SEGMENT LIKE 'FUT%'  
     AND TRANS_DATE BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
    ) > 0  
  BEGIN  
   INSERT INTO #COLLATERAL  
   SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
  
   FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
   WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
    AND C.EXCHANGE = (  
     SELECT TOP 1 EXCHANGE  
     FROM FOGLOBALS(NOLOCK)  
     )  
    AND SEGMENT LIKE 'FUT%'  
    AND TRANS_DATE BETWEEN @VALIDATIONDATE  
     AND @VALIDATIONDATE + ' 23:59'  
    AND EXISTS (  
     SELECT PARTY_CODE  
     FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
     WHERE F.PARTY_CODE = PARENTCODE  
     )  
   GROUP BY PARENTCODE  
  END  
  ELSE  
  BEGIN  
   INSERT INTO #COLLATERAL  
   SELECT PARTY_CODE = PARENTCODE, CASH = SUM(ISNULL(CASH, 0)), NONCASH = SUM(ISNULL(NONCASH, 0)), ACTCASH = SUM(ISNULL(ACTUALCASH, 0)), ACTNONCASH = SUM(ISNULL(ACTUALNONCASH, 0)), ORGCASH = SUM(ISNULL(ORGCASH, 0)), ORGNONCASH = SUM(ISNULL(ORGNONCASH, 0))
  
   FROM [ANAND1].MSAJAG.DBO.COLLATERAL C(NOLOCK), CLIENT2_VIEW(NOLOCK)  
   WHERE C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
    AND C.EXCHANGE = (  
     SELECT TOP 1 EXCHANGE  
     FROM FOGLOBALS(NOLOCK)  
     )  
    AND SEGMENT LIKE 'FUT%'  
    AND TRANS_DATE BETWEEN @MARGINDATE  
     AND @MARGINDATE + ' 23:59'  
    AND EXISTS (  
     SELECT PARTY_CODE  
     FROM FOMARGINNEW_EFFCOLL F(NOLOCK)  
     WHERE F.PARTY_CODE = PARENTCODE  
     )  
   GROUP BY PARENTCODE  
  END  
 END  
  
 IF @COLLOPT = 'BEFORE HAIRCUT'  
 BEGIN  
  UPDATE FOMARGINNEW_EFFCOLL  
  SET EFFECTIVECOLL = ORGCASH + ORGNONCASH  
  FROM #COLLATERAL  
  WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
 END  
 ELSE  
  IF @COLLOPT = 'AFTER HAIRCUT'  
  BEGIN  
   UPDATE FOMARGINNEW_EFFCOLL  
   SET EFFECTIVECOLL = CASH + NONCASH  
   FROM #COLLATERAL  
   WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  END  
  ELSE  
  BEGIN  
   UPDATE FOMARGINNEW_EFFCOLL  
   SET EFFECTIVECOLL = ACTCASH + ACTNONCASH  
   FROM #COLLATERAL  
   WHERE #COLLATERAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  END  
END  
  
-- DROP TABLE #COLLATERAL  
IF @VALIDATEWITH = 'ONLY ACCOUNTS'  
 OR @VALIDATEWITH = 'ACCOUNTS AND COLLATERAL'  
BEGIN  
 CREATE TABLE [#CLOSEBAL] ([PARTY_CODE] [VARCHAR](12), [VAMT] [MONEY])  
  
 DECLARE @SDTCUR AS VARCHAR(11)  
  
 SELECT @SDTCUR = SDTCUR  
 FROM ACCOUNTNCE.DBO.PARAMETER(NOLOCK)  
 WHERE @MARGINDATE BETWEEN SDTCUR  
   AND LDTCUR  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 IF @ACTOPT = 'WITHOUT BILL'  
 BEGIN  
  IF (  
    SELECT COUNT(1)  
    FROM FOMG13REFERENCE(NOLOCK)  
    WHERE SUBJECT = 'ACTOPTION'  
     AND LEFT(HEADING, 16) = 'T+5 BASED LEDGER'  
     AND SUBMENUREFNO = 1  
    ) > 0  
  BEGIN  
   --EXEC PR_GET_LEDBAL_T5 @VALIDATIONDATE  
  
   INSERT INTO #CLOSEBAL  
   SELECT PARTY_CODE, LEDBAL  
   FROM FOMARGINNEW_LEDGERBAL  
   WHERE MARGINDATE = @MARGINDATE  
  END  
  
  DECLARE @INT_ACT_EDTVDT INT  
  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'VDT WISE LEDGER WITH EDT RECEIPTS LEDGER'  
  
  /*VDT WISE LEDGER BALANCE  WITH OUT BILL AND EDT WISE RECEIPTS BANK , RECEIPTS CASH ,MARGIN RECIEPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP <> '15'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('21', '1', '19', '2')  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT < (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'D'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT >= (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21', '1', '19', '2')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP IN ('1', '19', '2')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP IN ('1', '19', '2')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER'  
  
  /*EDT WISE LEDGER*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('15', '21')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER'  
  
  /*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE + ' 23:59'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND VTYP IN ('1', '2', '19')  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'EDT WISE LEDGER WITH VDT RECEIPTS LEDGER VDT MARGIN LEDGER'  
  
  /*EDT WISE LEDGER WITH VDT WISE RECEIPTS BANK RECIEPTS CASH AND MARGIN RECEIPTS*/  
  IF @INT_ACT_EDTVDT = 1  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND EDT < @MARGINDATE + ' 23:59'  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN - VAMT  
       ELSE VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT >= @SDTCUR  
     AND VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND VTYP NOT IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE EDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
    --AND VTYP NOT IN ('1','2','19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @MARGINDATE  
      AND @MARGINDATE + ' 23:59'  
     AND EDT > VDT  
     AND VTYP IN ('1', '2', '19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN @VALIDATIONDATE <> @MARGINDATE  
        THEN CASE   
          WHEN DRCR = 'C'  
           THEN VAMT  
          ELSE - VAMT  
          END  
       ELSE 0  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT BETWEEN @VALIDATIONDATE  
      AND @VALIDATIONDATE + ' 23:59'  
     AND EDT > VDT  
    --AND VTYP  IN ('1','2','19')  
    GROUP BY CLTCODE  
      
    UNION  
      
    SELECT CLTCODE = M.PARTY_CODE, SUM(CASE   
       WHEN M.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.MARGINLEDGER M  
    LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP  
     AND M.BOOKTYPE = L.BOOKTYPE  
     AND M.VNO = L.VNO  
     AND M.LNO = L.LNO  
     AND L.VTYP IN ('19')  
    WHERE L.EDT >= @MARGINDATE  
    GROUP BY M.PARTY_CODE  
      
    UNION  
      
    SELECT CLTCODE = M.PARTY_CODE, SUM(CASE   
       WHEN M.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.MARGINLEDGER M  
    LEFT OUTER JOIN ACCOUNTNCE.DBO.LEDGER L ON M.VTYP = L.VTYP  
     AND M.BOOKTYPE = L.BOOKTYPE  
     AND M.VNO = L.VNO  
     AND M.LNO = L.LNO  
     AND L.VTYP IN ('19')  
    WHERE L.EDT >= @VALIDATIONDATE  
     AND @VALIDATIONDATE <> @MARGINDATE  
    GROUP BY M.PARTY_CODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
  END  
  
  /*-----------------------------------------------------------------------------------------------*/  
  SET @INT_ACT_EDTVDT = 0  
  
  SELECT @INT_ACT_EDTVDT = SUBMENUREFNO  
  FROM FOMG13REFERENCE(NOLOCK)  
  WHERE SUBJECT = 'ACTOPTION'  
   AND HEADING = 'VDT WISE LEDGER'  
  
  /*VDT WISE LEDGER BALANCE  WITH OUT BILL */  
  IF @INT_ACT_EDTVDT = 1  
   OR (  
    SELECT COUNT(1)  
    FROM FOMG13REFERENCE(NOLOCK)  
    WHERE SUBJECT = 'ACTOPTION'  
    ) = 0  
  BEGIN  
   INSERT INTO #CLOSEBAL  
   SELECT CLTCODE, SUM(VAMT) VAMT  
   FROM (  
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT <= @MARGINDATE + ' 23:59'  
     AND VTYP <> '15'  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT >= @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT < (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, SUM(CASE   
       WHEN DRCR = 'D'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
    WHERE VDT < @SDTCUR  
     AND VDT < @MARGINDATE  
     AND VTYP = '15'  
     AND VDT >= (  
      SELECT LEFT(MAX(SEC_PAYIN), 11)  
      FROM [ANAND1].MSAJAG.DBO.SETT_MST  
      WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59'  
      )  
    GROUP BY CLTCODE  
      
    UNION ALL  
      
    SELECT CLTCODE, /*CHEQUE CANCELED TILL T+5 OF VDT TILL T+1*/  
     SUM(CASE   
       WHEN A.DRCR = 'C'  
        THEN VAMT  
       ELSE - VAMT  
       END) VAMT  
    FROM ACCOUNTNCE.DBO.LEDGER A WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 B WITH (NOLOCK)  
    WHERE A.VTYP = '17'  
     AND A.VTYP = B.VTYP  
     AND A.VNO = B.VNO  
     AND A.BOOKTYPE = B.BOOKTYPE  
     AND A.LNO = B.LNO  
     AND A.VDT > @MARGINDATE + ' 23:59'  
     AND EXISTS (  
      SELECT L1.CLTCODE, L1.VAMT, L2.DDNO  
      FROM ACCOUNTNCE.DBO.LEDGER L1 WITH (NOLOCK), ACCOUNTNCE.DBO.LEDGER1 L2 WITH (NOLOCK)  
      WHERE L1.VTYP = '2' /*RECEIPTS VDT TILL T+1*/  
       AND L1.VTYP = L2.VTYP  
       AND L1.VNO = L2.VNO  
       AND L1.BOOKTYPE = L2.BOOKTYPE  
       AND L1.LNO = L2.LNO  
       AND L1.VDT >= @SDTCUR  
       AND L1.VDT <= @MARGINDATE + ' 23:59:58'  
       AND A.CLTCODE = L1.CLTCODE  
       AND A.VAMT = L1.VAMT  
       AND B.DDNO = L2.DDNO  
       AND L2.CLEAR_MODE = 'R'  
      )  
    GROUP BY CLTCODE  
    ) CLOSEBAL  
   GROUP BY CLTCODE  
    
  END  
    /*-----------------------------------------------------------------------------------------------*/  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #CLOSEBAL  
  SELECT CLTCODE, SUM(VAMT) VAMT  
  FROM (  
   SELECT CLTCODE, SUM(CASE   
      WHEN DRCR = 'C'  
       THEN VAMT  
      ELSE - VAMT  
      END) VAMT  
   FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
   WHERE VDT >= @SDTCUR  
    AND VDT <= @MARGINDATE + ' 23:59'  
   GROUP BY CLTCODE  
     
   UNION  
     
   SELECT CLTCODE, SUM(CASE   
      WHEN @VALIDATIONDATE <> @MARGINDATE  
       THEN CASE   
         WHEN DRCR = 'C'  
          THEN VAMT  
         ELSE - VAMT  
         END  
      ELSE 0  
      END) VAMT  
   FROM ACCOUNTNCE.DBO.LEDGER(NOLOCK)  
   WHERE VDT BETWEEN @VALIDATIONDATE  
     AND @VALIDATIONDATE + ' 23:59'  
    AND VTYP NOT IN ('15', '21')  
   GROUP BY CLTCODE  
   ) CLOSEBAL  
  GROUP BY CLTCODE  
 END  
  
 DECLARE @INT_ACT_CMLDGR INT  
  
 SET @INT_ACT_CMLDGR = 0  
  
 SELECT @INT_ACT_CMLDGR = SUBMENUREFNO  
 FROM FOMG13REFERENCE(NOLOCK)  
 WHERE SUBJECT = 'ACTOPTION'  
  AND HEADING = 'VDT WISE CM LEDGER' -- Capital Market Ledger Balance  
  
 IF @INT_ACT_CMLDGR = 1  
 BEGIN  
  INSERT INTO #CLOSEBAL  
  SELECT PARTY_CODE, 0  
  FROM FOMARGINNEW_EFFCOLL  
  WHERE NOT EXISTS (  
    SELECT PARTY_CODE  
    FROM #CLOSEBAL  
    WHERE #CLOSEBAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
    )  
  
  IF @ACTOPT = 'WITHOUT BILL'  
  BEGIN  
   UPDATE #CLOSEBAL  
   SET VAMT = VAMT + VAMT_CM  
   FROM (  
    SELECT CLTCODE, SUM(VAMT) VAMT_CM  
    FROM (  
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT <= @MARGINDATE + ' 23:59'  
      AND VTYP <> '15'  
     GROUP BY CLTCODE  
       
     UNION ALL  
       
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT < @MARGINDATE  
      AND VTYP = '15'  
      AND VDT < (  
       SELECT LEFT(MAX(SEC_PAYIN), 11)  
       FROM [ANAND1].MSAJAG.DBO.SETT_MST  
       WHERE SEC_PAYIN < @MARGINDATE  
        AND SETT_TYPE = 'N'  
       )  
     GROUP BY CLTCODE  
     ) CLOSEBAL  
    GROUP BY CLTCODE  
    ) CLOSEBAL_FINAL  
   WHERE CLTCODE = PARTY_CODE  
  END  
  ELSE  
  BEGIN  
   UPDATE #CLOSEBAL  
   SET VAMT = VAMT + VAMT_CM  
   FROM (  
    SELECT CLTCODE, SUM(VAMT) VAMT_CM  
    FROM (  
     SELECT CLTCODE, SUM(CASE   
        WHEN DRCR = 'C'  
         THEN VAMT  
        ELSE - VAMT  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT >= @SDTCUR  
      AND VDT <= @MARGINDATE  
     GROUP BY CLTCODE  
       
     UNION  
       
     SELECT CLTCODE, SUM(CASE   
        WHEN @VALIDATIONDATE <> @MARGINDATE  
         THEN CASE   
           WHEN DRCR = 'C'  
            THEN VAMT  
           ELSE - VAMT  
           END  
        ELSE 0  
        END) VAMT  
     FROM ACCOUNT.DBO.LEDGER(NOLOCK)  
     WHERE VDT BETWEEN @VALIDATIONDATE  
       AND @VALIDATIONDATE + ' 23:59'  
     GROUP BY CLTCODE  
     ) CLOSEBAL  
    GROUP BY CLTCODE  
    ) CLOSEBAL_FINAL  
   WHERE CLTCODE = PARTY_CODE  
  END  
 END  
  
 SELECT PARTY_CODE = PARENTCODE, VAMT = SUM(VAMT)  
 INTO #CLOSEBAL_FINAL  
 FROM #CLOSEBAL(NOLOCK), CLIENT2_VIEW(NOLOCK)  
 WHERE #CLOSEBAL.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
 GROUP BY PARENTCODE  
  
 UPDATE FOMARGINNEW_EFFCOLL  
 SET EFFECTIVECOLL = EFFECTIVECOLL + VAMT  
 FROM #CLOSEBAL_FINAL  
 WHERE #CLOSEBAL_FINAL.PARTY_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE  
  
 DROP TABLE #CLOSEBAL  
END  
  
IF CONVERT(DATETIME, @MarginDate) > CONVERT(DATETIME, 'JUL  1 2018')  
BEGIN  
 TRUNCATE TABLE FoMarginNew_EffColl  
  
 INSERT INTO FoMarginNew_EffColl  
 SELECT PARTY_CODE, (  
   CASE   
    WHEN T_MARGINAVL > 0  
     THEN TDAY_MARGIN  
    ELSE TDAY_MARGIN + T_MARGINAVL  
    END  
   ) + (  
   CASE   
    WHEN T_MTMAVL > 0  
     THEN TDAY_MTM  
    ELSE TDAY_MTM + T_MTMAVL  
    END  
   ),0,0  
 FROM [ANAND1].MSAJAG.DBO.TBL_COMBINE_REPORTING_DETAIL  
 WHERE MARGINDATE = @MarginDate  
  AND EXCHANGE = 'NCE'  
  AND SEGMENT = 'FUTURES'  
END  
  
UPDATE FoMarginNew_EffColl  
SET EFFECTIVECOLL = 0  
WHERE EFFECTIVECOLL < 0  
 SELECT * FROM FOMARGINNEW_EFFCOLL 
CREATE TABLE [#SHORTAGE] ([PARTY_CODE] [VARCHAR](12), [EFFECTIVECOLL] [MONEY], [BRKSHORT] [MONEY], [SLAB] [INT], [MINIMUMPERCENTAGE] [DECIMAL](18, 2), [BRKPENALITY] [MONEY])  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF @ACTOPT = 'WITHOUT BILL'  
BEGIN  
 INSERT INTO #SHORTAGE  
 SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - TOTALMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - TOTALMARGIN) * 100 / TOTALMARGIN) MINIMUMPERCENTAGE, 0  
 FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)  
 WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
   AND @MARGINDATE + ' 23:59'  
  AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
  AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.TOTALMARGIN  
  AND TOTALMARGIN > 0  
END  
ELSE  
BEGIN  
 IF @VALIDATEWITH = 'NONE'  
 BEGIN  
  UPDATE FOMARGINNEW_EFFCOLL  
  SET EFFECTIVECOLL = PSPANMARGIN  
  FROM FOMARGINNEW(NOLOCK)  
  WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
    AND @MARGINDATE + ' 23:59'  
   AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
   AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN  
   AND PSPANMARGIN > 0  
  
  INSERT INTO #SHORTAGE  
  SELECT PARTY_CODE, EFFECTIVECOLL, 0 BRKSHORT, 0, 0 MINIMUMPERCENTAGE, 0  
  FROM FOMARGINNEW_EFFCOLL(NOLOCK)  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #SHORTAGE  
  SELECT FOMARGINNEW.PARTY_CODE, EFFECTIVECOLL, (EFFECTIVECOLL - PSPANMARGIN) BRKSHORT, 0, ((EFFECTIVECOLL - PSPANMARGIN) * 100 / PSPANMARGIN) MINIMUMPERCENTAGE, 0  
  FROM FOMARGINNEW_EFFCOLL, FOMARGINNEW(NOLOCK)  
  WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
    AND @MARGINDATE + ' 23:59'  
   AND FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
   AND FOMARGINNEW_EFFCOLL.EFFECTIVECOLL < FOMARGINNEW.PSPANMARGIN  
   AND PSPANMARGIN > 0  
 END  
END  
  
UPDATE #SHORTAGE  
SET SLAB = FOMG13PENALTYMASTER.SLAB, MINIMUMPERCENTAGE = FOMG13PENALTYMASTER.MINIMUMPERCENTAGE, BRKPENALITY = CASE   
  WHEN CHARGEFLAG = 1  
   THEN CASE   
     WHEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100 > FOMG13PENALTYMASTER.MINIMUMAMT)  
      THEN ((ABS(#SHORTAGE.MINIMUMPERCENTAGE) * FOMG13PENALTYMASTER.MINIMUMPERCENTAGE) / 100)  
     ELSE MINIMUMAMT  
     END  
  ELSE 0  
  END  
FROM FOMG13PENALTYMASTER(NOLOCK)  
WHERE TOPENALTYPERCENTAGE >= ABS(#SHORTAGE.MINIMUMPERCENTAGE)  
 AND FROMPENALTYPERCENTAGE <= ABS(#SHORTAGE.MINIMUMPERCENTAGE)  
 AND EFFECTIVEDATE = (  
  SELECT MAX(EFFECTIVEDATE)  
  FROM FOMG13PENALTYMASTER  
  WHERE EFFECTIVEDATE <= @MARGINDATE  
  )  
  
DELETE FOMG13SHORTAGE  
WHERE FILEDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND BATCH_NO = @BATCHNO  
 AND REFNO = @REFNO  
  
INSERT INTO FOMG13SHORTAGE  
SELECT @MARGINDATE, #SHORTAGE.PARTY_CODE, @BATCHNO, @REFNO, TOTALMARGIN, EFFECTIVECOLL, EFFECTIVECOLL, BRKSHORT, BRKSHORT, SLAB, SLAB, MINIMUMPERCENTAGE, BRKPENALITY, MINIMUMPERCENTAGE, BRKPENALITY, '', '', 0  
FROM #SHORTAGE(NOLOCK), FOMARGINNEW(NOLOCK)  
WHERE FOMARGINNEW.MDATE BETWEEN @MARGINDATE  
  AND @MARGINDATE + ' 23:59'  
 AND #SHORTAGE.PARTY_CODE = FOMARGINNEW.PARTY_CODE  
  
DROP TABLE #SHORTAGE  
  
INSERT INTO FOMARGIN_SHORTAGE_LOG  
VALUES (@MARGINDATE, @VALIDATEWITH, @ACTOPT, @COLLOPT, @BATCHNO, @REFNO, @VALIDATIONDATE, '', GETDATE())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoMarginNew_Calc_Get
-- --------------------------------------------------



CREATE PROC  [dbo].[FoMarginNew_Calc_Get] 
(	
	@MARGINDATE VARCHAR(11),
	@REPORTEXCESS VARCHAR(10),
	@CLIENTTYPE VARCHAR(10)= ''
)
AS

-- exec FoMarginNew_Calc_Get 'Jan  8 2025','REQUIRED'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


CREATE TABLE #FOMARGIN_SHORTAGE
(
	MDATE VARCHAR(11),
	PARTY_CODE VARCHAR(20),
	SPREADMARGIN MONEY,
	NONSPREADMARGIN MONEY,
	TOTALMARGIN MONEY,
	MTOM MONEY,
	MTOMLOSS MONEY,
	DEL_MARGIN MONEY,
	EFFECTIVECOLL MONEY,
	CL_TYPE VARCHAR(2),
	PEAKMARGIN MONEY,
	EFFECTIVECOLL_PEAK MONEY
)


	INSERT INTO #FOMARGIN_SHORTAGE
	SELECT 
		UPPER(REPLACE(CONVERT(VARCHAR,MDATE,106),' ','-')) MDATE,
		(CASE WHEN FOMARGINNEW_EFFCOLL.PARTY_CODE = MEMBERCODE THEN 'PRO_' ELSE '' END) 
			+ ISNULL(OLDPARTY_CODE,FOMARGINNEW_EFFCOLL.PARTY_CODE) PARTY_CODE,
		SPREADMARGIN,
		NONSPREADMARGIN,
		TOTALMARGIN,
		MTOM,
		MTOMLOSS = ISNULL(MTOMLOSS,0),
		DEL_MARGIN = ISNULL(DEL_MARGIN,0),
		CASE WHEN @REPORTEXCESS  ='REQUIRED'
			THEN
				(CASE
					WHEN EFFECTIVECOLL > TOTALMARGIN
					THEN
						TOTALMARGIN
					ELSE
						CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
					END)
			ELSE
				CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
			END
	
		AS EFFECTIVECOLL,
	       ltrim(rtrim( CL_TYPE)),
		PEAKMARGIN,
		CASE WHEN @REPORTEXCESS  ='REQUIRED'
			------------------------Condition Committed on 17JAn2024 SRE-33198 BY VAIBHAV K--------------------------
			/*
			THEN
				(CASE
					WHEN EFFECTIVECOLL > PEAKMARGIN
					THEN
						PEAKMARGIN
					ELSE
						CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
					END)
			ELSE
				CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
			END
			*/
			----------------------------- END -------------------------
			---------------------ADDED Condition on 17JAN2025 BY Vaihav---------------------------
				THEN
				(CASE
					WHEN EffectiveColl_PEAK > PEAKMARGIN
					THEN
						PEAKMARGIN
					ELSE
						CASE WHEN EffectiveColl_PEAK < 0 THEN 0 ELSE EffectiveColl_PEAK END
					END)
			ELSE
				CASE WHEN EffectiveColl_PEAK < 0 THEN 0 ELSE EffectiveColl_PEAK END
			END

			------------------------- END ---------------------
	
		AS EFFECTIVECOLL_PEAK
	FROM
		FOMARGINNEW_EFFCOLL (NOLOCK) ,
	    FOOWNER (NOLOCK),
		FOMARGINNEW (NOLOCK)
		LEFT OUTER JOIN PARTYMAPPING (NOLOCK) ON (FOMARGINNEW.PARTY_CODE = NEWPARTY_CODE)
	WHERE
		FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
	    AND FOMARGINNEW.MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	    AND CL_TYPE <> 'TM'
	    /*AND EXISTS (
					SELECT CL_CODE FROM CLIENT1 (NOLOCK) 
					WHERE 
					    1 = (CASE 
								WHEN  @CLIENTTYPE ='' THEN 1
								WHEN  @CLIENTTYPE = 'NRI' AND CL_TYPE = 'NRI' THEN 1 
								WHEN  @CLIENTTYPE <> 'NRI' AND CL_TYPE <> 'NRI' THEN 1 
								ELSE 0 END)					
						AND CL_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE)*/


 


 
						
						
	IF @CLIENTTYPE = 'NRI' 
	BEGIN
			UPDATE #FOMARGIN_SHORTAGE  SET PARTY_CODE = BANKID 
			FROM CLIENT1,CLIENT2 WHERE #FOMARGIN_SHORTAGE.PARTY_CODE =CLIENT2.PARTY_CODE 
			AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
	END

	DELETE FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	AND EXISTS (SELECT PARTY_CODE FROM FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59')

	INSERT INTO FOMARGIN_SHORTAGE 
	--SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),'',GETDATE(),PEAKMARGIN ,EFFECTIVECOLL_PEAK 
	select MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,MTOMLOSS,DEL_MARGIN,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),PEAKMARGIN, EFFECTIVECOLL_PEAK
 FROM #FOMARGIN_SHORTAGE

--select * from #FOMARGIN_SHORTAGE
	SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,PEAKMARGIN,
	MTOM,EFFECTIVECOLL,EFFECTIVECOLL_PEAK,CL_TYPE=LEFT(CL_TYPE,1),MTOMLOSS,DEL_MARGIN 
	FROM #FOMARGIN_SHORTAGE
	--WHERE party_code = 'A766487'
	
	
	DROP TABLE #FOMARGIN_SHORTAGE

/*----------------------------------------------- END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoMarginNew_Calc_Get_BKUP_08APR2024
-- --------------------------------------------------


CREATE PROC  [dbo].[FOMARGINNEW_CALC_GET] 
(	
	@MARGINDATE VARCHAR(11),
	@REPORTEXCESS VARCHAR(10),
	@CLIENTTYPE VARCHAR(10)= ''
)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


CREATE TABLE #FOMARGIN_SHORTAGE
(
	MDATE VARCHAR(11),
	PARTY_CODE VARCHAR(20),
	SPREADMARGIN MONEY,
	NONSPREADMARGIN MONEY,
	TOTALMARGIN MONEY,
	MTOM MONEY,
	MTOMLOSS MONEY,
	DEL_MARGIN MONEY,
	EFFECTIVECOLL MONEY,
	CL_TYPE VARCHAR(2)
)


	INSERT INTO #FOMARGIN_SHORTAGE
	SELECT 
		UPPER(REPLACE(CONVERT(VARCHAR,MDATE,106),' ','-')) MDATE,
		(CASE WHEN FOMARGINNEW_EFFCOLL.PARTY_CODE = MEMBERCODE THEN 'PRO_' ELSE '' END) 
			+ ISNULL(OLDPARTY_CODE,FOMARGINNEW_EFFCOLL.PARTY_CODE) PARTY_CODE,
		SPREADMARGIN,
		NONSPREADMARGIN,
		TOTALMARGIN,
		MTOM,
		MTOMLOSS = ISNULL(MTOMLOSS,0),
		DEL_MARGIN = ISNULL(DEL_MARGIN,0),
		CASE WHEN @REPORTEXCESS  ='REQUIRED'
			THEN
				(CASE
					WHEN EFFECTIVECOLL > TOTALMARGIN
					THEN
						TOTALMARGIN
					ELSE
						CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
					END)
			ELSE
				CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
			END
	
		AS EFFECTIVECOLL,
	       ltrim(rtrim( CL_TYPE))
	FROM
		FOMARGINNEW_EFFCOLL (NOLOCK) ,
	    FOOWNER (NOLOCK),
		FOMARGINNEW (NOLOCK)
		LEFT OUTER JOIN PARTYMAPPING (NOLOCK) ON (FOMARGINNEW.PARTY_CODE = NEWPARTY_CODE)
	WHERE
		FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
	    AND FOMARGINNEW.MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	    AND CL_TYPE <> 'TM'
	    /*AND EXISTS (
					SELECT CL_CODE FROM CLIENT1 (NOLOCK) 
					WHERE 
					    1 = (CASE 
								WHEN  @CLIENTTYPE ='' THEN 1
								WHEN  @CLIENTTYPE = 'NRI' AND CL_TYPE = 'NRI' THEN 1 
								WHEN  @CLIENTTYPE <> 'NRI' AND CL_TYPE <> 'NRI' THEN 1 
								ELSE 0 END)					
						AND CL_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE)*/
						
						
	IF @CLIENTTYPE = 'NRI' 
	BEGIN
			UPDATE #FOMARGIN_SHORTAGE  SET PARTY_CODE = BANKID 
			FROM CLIENT1,CLIENT2 WHERE #FOMARGIN_SHORTAGE.PARTY_CODE =CLIENT2.PARTY_CODE 
			AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
	END

	DELETE FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	AND EXISTS (SELECT PARTY_CODE FROM FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59')

	INSERT INTO FOMARGIN_SHORTAGE 
	SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),'',GETDATE() FROM #FOMARGIN_SHORTAGE

	SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,
	MTOM,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),MTOMLOSS,DEL_MARGIN FROM #FOMARGIN_SHORTAGE
	
	DROP TABLE #FOMARGIN_SHORTAGE

/*----------------------------------------------- END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoMarginNew_Calc_Get_BKUP_17JAN2025
-- --------------------------------------------------



CREATE PROC  [dbo].[FoMarginNew_Calc_Get_BKUP_17JAN2025] 
(	
	@MARGINDATE VARCHAR(11),
	@REPORTEXCESS VARCHAR(10),
	@CLIENTTYPE VARCHAR(10)= ''
)
AS

-- exec FoMarginNew_Calc_Get 'Jan  8 2025','REQUIRED'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


CREATE TABLE #FOMARGIN_SHORTAGE
(
	MDATE VARCHAR(11),
	PARTY_CODE VARCHAR(20),
	SPREADMARGIN MONEY,
	NONSPREADMARGIN MONEY,
	TOTALMARGIN MONEY,
	MTOM MONEY,
	MTOMLOSS MONEY,
	DEL_MARGIN MONEY,
	EFFECTIVECOLL MONEY,
	CL_TYPE VARCHAR(2),
	PEAKMARGIN MONEY,
	EFFECTIVECOLL_PEAK MONEY
)


	INSERT INTO #FOMARGIN_SHORTAGE
	SELECT 
		UPPER(REPLACE(CONVERT(VARCHAR,MDATE,106),' ','-')) MDATE,
		(CASE WHEN FOMARGINNEW_EFFCOLL.PARTY_CODE = MEMBERCODE THEN 'PRO_' ELSE '' END) 
			+ ISNULL(OLDPARTY_CODE,FOMARGINNEW_EFFCOLL.PARTY_CODE) PARTY_CODE,
		SPREADMARGIN,
		NONSPREADMARGIN,
		TOTALMARGIN,
		MTOM,
		MTOMLOSS = ISNULL(MTOMLOSS,0),
		DEL_MARGIN = ISNULL(DEL_MARGIN,0),
		CASE WHEN @REPORTEXCESS  ='REQUIRED'
			THEN
				(CASE
					WHEN EFFECTIVECOLL > TOTALMARGIN
					THEN
						TOTALMARGIN
					ELSE
						CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
					END)
			ELSE
				CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
			END
	
		AS EFFECTIVECOLL,
	       ltrim(rtrim( CL_TYPE)),
		PEAKMARGIN,
		CASE WHEN @REPORTEXCESS  ='REQUIRED'
			THEN
				(CASE
					WHEN EFFECTIVECOLL > PEAKMARGIN
					THEN
						PEAKMARGIN
					ELSE
						CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
					END)
			ELSE
				CASE WHEN EFFECTIVECOLL < 0 THEN 0 ELSE EFFECTIVECOLL END
			END
	
		AS EFFECTIVECOLL_PEAK
	FROM
		FOMARGINNEW_EFFCOLL (NOLOCK) ,
	    FOOWNER (NOLOCK),
		FOMARGINNEW (NOLOCK)
		LEFT OUTER JOIN PARTYMAPPING (NOLOCK) ON (FOMARGINNEW.PARTY_CODE = NEWPARTY_CODE)
	WHERE
		FOMARGINNEW_EFFCOLL.PARTY_CODE = FOMARGINNEW.PARTY_CODE
	    AND FOMARGINNEW.MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	    AND CL_TYPE <> 'TM'
	    /*AND EXISTS (
					SELECT CL_CODE FROM CLIENT1 (NOLOCK) 
					WHERE 
					    1 = (CASE 
								WHEN  @CLIENTTYPE ='' THEN 1
								WHEN  @CLIENTTYPE = 'NRI' AND CL_TYPE = 'NRI' THEN 1 
								WHEN  @CLIENTTYPE <> 'NRI' AND CL_TYPE <> 'NRI' THEN 1 
								ELSE 0 END)					
						AND CL_CODE = FOMARGINNEW_EFFCOLL.PARTY_CODE)*/


 


 
						
						
	IF @CLIENTTYPE = 'NRI' 
	BEGIN
			UPDATE #FOMARGIN_SHORTAGE  SET PARTY_CODE = BANKID 
			FROM CLIENT1,CLIENT2 WHERE #FOMARGIN_SHORTAGE.PARTY_CODE =CLIENT2.PARTY_CODE 
			AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
	END

	DELETE FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'
	AND EXISTS (SELECT PARTY_CODE FROM FOMARGIN_SHORTAGE WHERE MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59')

	INSERT INTO FOMARGIN_SHORTAGE 
	--SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),'',GETDATE(),PEAKMARGIN ,EFFECTIVECOLL_PEAK 
	select MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,MTOMLOSS,DEL_MARGIN,EFFECTIVECOLL,CL_TYPE=LEFT(CL_TYPE,1),PEAKMARGIN, EFFECTIVECOLL_PEAK
 FROM #FOMARGIN_SHORTAGE

--select * from #FOMARGIN_SHORTAGE
	SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,PEAKMARGIN,
	MTOM,EFFECTIVECOLL,EFFECTIVECOLL_PEAK,CL_TYPE=LEFT(CL_TYPE,1),MTOMLOSS,DEL_MARGIN 
	FROM #FOMARGIN_SHORTAGE
	--WHERE party_code = 'A766487'
	
	
	DROP TABLE #FOMARGIN_SHORTAGE

/*----------------------------------------------- END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.fomg13generateshortFile
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.fomg13generateshortFile    Script Date: 1/17/2004 11:42:42 PM ******/






/****** Object:  Stored Procedure dbo.fomg13generateshortFile    Script Date: 10/17/2002 6:31:21 PM ******/
CREATE  proc fomg13generateshortFile
(@clientType as varchar(10),
 @filedate as varchar(11),
 @batch_no as varchar(10),
@refno as int)
as 
If @clientType='EXCHANGE'
BEGIN 
select 0,Filedate,batch_no,refno,exchslab,party_code,marginrequirement,marginreported,exchshort,exchshortagepercentage,exchpenalty from fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno,exchslab,party_code,marginrequirement,marginreported,exchshort,exchshortagepercentage,exchpenalty
union
SELECT 1,Filedate,batch_no,refno,exchslab,'SUBTOTAL',sum(marginrequirement),sum(marginreported),sum(exchshort),0,SUM(exchpenalty) AS QtySum
FROM fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno,exchslab
union
SELECT 2,Filedate,batch_no,refno,99999,'GRANDTOTAL',sum(marginrequirement),sum(marginreported),sum(exchshort),0,SUM(exchpenalty) AS QtySum
FROM fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno
order by exchslab,1,party_code,exchpenalty
END
ELSE IF  @clientType='BROKER'
BEGIN 

select 0,Filedate,batch_no,refno,brkslab,party_code,marginrequirement,MARGINAVAILABLE,brkshort,brkshortagepercentage,brkpenalty from fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno,brkslab,party_code,marginrequirement,MARGINAVAILABLE,brkshort,brkshortagepercentage,brkpenalty
union
SELECT 1,Filedate,batch_no,refno,brkslab,'SUBTOTAL',sum(marginrequirement),sum(MARGINAVAILABLE),sum(brkshort),0,SUM(brkpenalty) AS QtySum
FROM fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno,brkslab
union
SELECT 2,Filedate,batch_no,refno,99999,'GRANDTOTAL',sum(marginrequirement),sum(MARGINAVAILABLE),sum(brkshort),0,SUM(brkpenalty) AS QtySum
FROM fomg13shortage
where filedate like @filedate+'%'
and  batch_no like @batch_no
and refno=@refno
GROUP BY Filedate,batch_no,refno
order by brkslab,1,party_code,brkpenalty
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoMissingScrip
-- --------------------------------------------------

CREATE Proc FoMissingScrip As       

/*
 THE FOLLOWING IS REMARKED FOR VBB VALUE OF LOT

Declare      
@@selfotrade Cursor,      
@@MyPKey  Int,      
@@option_type varchar(2),      
@@inst_type varchar(6),      
@@symbol varchar(12),      
@@Cexpirydate varchar(20),      
@@strike_price money,      
@@SecName varchar(20),      
@@Series varchar(2),      
@@Mylot Int,      
@@Todays Varchar(30),      
@@expirydate smalldatetime,      
@@MySettno Int      
      
      
select Top 1 @@todays = left(convert(varchar,Activitytime,109),11) From FoTrade       
set @@Todays = @@Todays + ' 00:01:01'       
      
select @@Mysettno = Isnull(max(Sett_no),0) from Fosett_mst       
      
select @@mypkey = isnull( max(p_key),0) from foscrip2      
      
Set @@selFoTrade = cursor for      
      
Select Distinct inst_type,symbol,expirydate,option_type,isnull(strike_price,0),sec_name       
from fotrade where expirydate not in ( select expirydate from FoScrip2 where       
foscrip2.inst_type=fotrade.inst_type and      
foscrip2.symbol=fotrade.symbol and      
foscrip2.expirydate=fotrade.expirydate and      
foscrip2.option_type = fotrade.option_type and      
foscrip2.strike_price=fotrade.strike_price)      
      
Open @@SelFoTrade      
      
Fetch next from @@SelFoTrade into @@inst_type,@@symbol,@@expirydate,@@option_type,@@strike_price,@@SecName      
      
set @@mysettno = @@Mysettno + 1       
set @@Mypkey = @@Mypkey + 1      
      
While @@Fetch_Status = 0       
begin      
        
If @@Inst_type like 'FUT%'       
   Set @@strike_price = 0      
      
If @@Inst_type like 'FUT%'       
   set @@option_type = ''      
      
If @@Inst_type like 'FUT%'       
   Set @@Series = 'F'      
Else      
   Set @@Series = 'O'      
      
set @@expirydate = (left(convert(varchar,@@Expirydate,109),11)) + ' 23:59:00'      
    
--select @@mylot = isnull(max(C_Regular_Lot),0) from foscrip2 where symbol = @@Symbol       
select @@mylot = 0
      
Insert into foscrip2 values(@@MyPkey + 1,@@inst_type,@@symbol,@@SecName,@@expirydate,@@strike_price,@@option_type,      
@@Todays,@@expirydate,@@series,0,@@mylot,@@Expirydate,'',@@symbol,'',@@expirydate,@@strike_price,'',0)      
      
insert into foscrip1 values(@@Inst_Type, @@Symbol,@@Expirydate,@@Strike_Price,@@Option_type)      
set @@Mypkey = @@Mypkey + 1      
set @@mysettno = @@Mysettno + 1       
      
Insert into Fosett_mst values('NSEFO',@@Series,@@mysettno,@@inst_type,@@Symbol,@@Todays,@@expirydate,@@strike_price,@@Option_type,'JAN  1 1990 00:00','JAN  1 1990 00:00','JAN  1 1990 00:00','JAN  1 1990 00:00',@@Series,'N',@@Expirydate)      
      
Fetch next from @@SelFoTrade into @@inst_type,@@symbol,@@expirydate,@@option_type,@@strike_price,@@SecName      
End      
      
deallocate @@SelFoTrade      
    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoOpenPosGenrate
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.FoOpenPosGenrate    Script Date: 1/17/2004 11:42:37 PM ******/






CREATE  Proc FoOpenPosGenrate   
(@SDate Varchar(11)) As   
  
select Party_Code,s.Inst_Type,s.Symbol,ExpiryDate=Left(Convert(Varchar,S.EXPIRYDATE,109),11),s.strike_price,s.option_type,  
       Pqty=sum(s.Pqty), SQty=sum(s.Sqty),  
       NQty=sum(s.Pqty)-sum(s.Sqty),  
       netrate = (case when s.inst_type like 'OPT%' then   
     isnull(( select foclosing.cl_rate from foclosing  
                   where Foclosing.trade_date = (select Max(trade_date) from foclosing  
   where trade_date <=  @sdate + ' 23:59:00')   
                 and foclosing.Inst_Type = s.inst_type  
                   and foclosing.symbol=s.symbol                                      
                   and foclosing.expirydate = s.expirydate  
                   and foclosing.strike_price=s.strike_price  
                   and foclosing.option_type=s.option_type ),0)  
  else   
   isnull(( select foclosing_billreport.cl_rate from foclosing_billreport  
                   where Foclosing_billreport.trade_date = (select Max(trade_date) from foclosing_billreport  
   where trade_date <=  @sdate + ' 23:59:00')  
               and foclosing_billreport.Inst_Type = s.inst_type  
                   and foclosing_billreport.symbol=s.symbol                                      
                   and foclosing_billreport.expirydate = s.expirydate  
                   and foclosing_billreport.strike_price=s.strike_price  
                   and foclosing_billreport.option_type=s.option_type ),0)  
  end),  
Sauda_date = @sdate  
from fonetposview s   
where s.sauda_date <= @sdate +' 23:59:00' 
and s.MaturityDate >@sdate+' 23:59' 
group by party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type  
order by S.Party_Code,S.Inst_type,S.SymBol,S.expirydate,S.Strike_Price,S.Option_Type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FORearrangeAfterContflag
-- --------------------------------------------------


CREATE PROCEDURE FORearrangeAfterContflag 

@Party_code Varchar(10),
@option_type varchar(2),
@inst_type varchar(6),
@symbol varchar(12),
@expirydate varchar(11),
@strike_price money,
@TDate Varchar(11)


AS 

declare 
 @@trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@loop cursor,
 @@Brokscheme varchar(3)
 
	Update FOSettlement set settflag = (case when s.sell_buy = 1 then 2
						else 3 end )
	from FOSettlement s,FOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.option_type = b.option_type
	and b.inst_type = b.inst_type
	and b.symbol = s.symbol
	and left(convert(varchar,b.expirydate,109),11) = @expirydate
	and b.strike_price = b.strike_price
	AND  b.sqty <> 0 and b.pqty <>  0 
	and s.party_code = @party_code
	and s.option_type = @option_type
	and s.inst_type = @inst_type
	and s.symbol = @symbol
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and s.strike_price = @strike_price
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   
	
	Update FOSettlement set settflag = 4 from FOSettlement s,FOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.option_type = s.option_type
	and b.inst_type = s.inst_type
	and b.symbol = s.symbol
	and left(convert(varchar,b.expirydate,109),11) = @expirydate
	and b.strike_price = s.strike_price
	AND  b.sqty = 0 and b.pqty >  0 
	and s.party_code = @party_code
	and s.option_type = @option_type
	and s.inst_type = @inst_type
	and s.symbol = @symbol
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and s.strike_price = @strike_price
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   


	Update FOSettlement set settflag = 5 from FOSettlement s,FOCursorContSale b 
	where b.party_code = s.party_code	
	and b.sauda_date = left(convert(varchar,s.sauda_date,109),11) 
        	and b.option_type = s.option_type
	and b.inst_type = s.inst_type
	and b.symbol = s.symbol
	and left(convert(varchar,b.expirydate,109),11) = @expirydate
	and b.strike_price = s.strike_price
	AND  b.sqty > 0 and b.pqty =  0 
	and s.party_code = @party_code
	and s.option_type = @option_type
	and s.inst_type = @inst_type
	and s.symbol = @symbol
	and left(convert(varchar,s.expirydate,109),11) = @expirydate
	and s.strike_price = @strike_price
	and left(convert(varchar,s.sauda_date,109),11) = @Tdate   

set @@Flag = cursor for
	 select pqty,sqty from FOCursorContUnEqualSalePur
	 where party_code = @party_code and option_type = @option_type
	 and inst_type = @inst_type and symbol = @symbol
	 and left(convert(varchar,expirydate,109),11) = @expirydate
	 and strike_price = @strike_price
	 and left(convert(varchar,sauda_date,109),11) = @Tdate   
	 and pqty <> 0 AND  sqty <> 0 and isnull(pqty,0) <> isnull(sqty,0)
	 group by pqty,sqty
open @@flag
fetch next from @@Flag into @@Pqty,@@sqty

if @@fetch_status = 0 	
	begin
		While @@fetch_status = 0 
		begin
			if @@Pqty > @@Sqty 
		        	begin 
				select @@pdiff = @@Pqty - @@Sqty 
				  /*Find a trade whose tradeqty = the diff in paty and sqty and update it with setflag = 4 */	
				set @@Loop  = cursor for 
					select trade_no,tradeqty from FOsettlement 
					where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 1 and tradeqty = @@Pdiff 
				 open @@loop
				 fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				 if @@fetch_status = 0 
				 begin 
					update FOsettlement set settflag = 4   
					where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  

				close @@Loop
				deallocate @@Loop 
			  	end
			  	else if @@fetch_status <> 0  
			 	begin 
					close @@Loop
				   	deallocate @@Loop  
				   	set @@Loop  = cursor for 
						select trade_no,tradeqty from FOsettlement 
					   	where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
		   			        	and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
						and left(convert(varchar,sauda_date,109),11) = @Tdate   and sell_buy = 1 
						order by tradeqty Desc
				   	open @@loop
				  	fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				  	while @@pdiff > 0       
				  	begin
						if @@pdiff >= @@Lqty 	
	                                        begin
					     		update Fosettlement set settflag = 4   
							where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  

					     		select @@pdiff = @@Pdiff - @@Lqty
						end    
					        else if @@pdiff < @@Lqty 
			    			begin
							
							insert into FoSettlement select ContractNo,BillNo,'B'+Trade_no,Party_Code,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,
							Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@@Pdiff,AuctionPart,MarketType,Series,Order_no,Price,Sauda_date,Table_No,Line_No,
							Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,4,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,
							sebi_tax,Broker_chrg,Service_tax,@@Pdiff*price,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate
							/* Added By Animesh Cause of Added new fields in FoSettlement on Date 04/09/2001 12:25 PM. */
							,ParticipantCode,Status,CpId,Instrument,BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
				    			from FOSettlement where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
							and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty   	
	     						
 
				     		        	update FOsettlement set settflag = 2,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*price    
				    		        	where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty 

							select @@Pdiff = 0   
						end 
			    			fetch next from @@Loop into @@Ltrade_no,@@Lqty
			   		end
		   			close @@Loop
				end    
 			end
			else if @@Pqty < @@Sqty
			begin 
				select @@pdiff = @@sqty - @@pqty

 				set @@Loop  = cursor for 
				select trade_no,tradeqty from FOsettlement 
        	     	        		where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
				and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
				and sell_buy = 2 and tradeqty = @@Pdiff 
 				
				open @@loop
			  	 fetch next from @@Loop into @@Ltrade_no,@@Lqty     
			 	 if @@fetch_status = 0 
				 begin
 				 	update FOsettlement set settflag = 5  
  				  	where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 
			 		
					close @@Loop
				 	deallocate @@Loop 
			  	end
				else if @@fetch_status <> 0  
			 	begin 
					close @@Loop
				   	deallocate @@Loop  

				   	set @@Loop  = cursor for 
				    	select trade_no,tradeqty from FOsettlement 
					where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
		   			and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					and sell_buy = 2 
					order by tradeqty Desc

				   	open @@loop
					fetch next from @@Loop into @@Ltrade_no,@@Lqty     
				  	while @@pdiff > 0       
				   	begin
						if @@pdiff >= @@Lqty 
						begin
							update FOSettlement set settflag = 5   
						    	where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
							and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  
						     	
							select @@pdiff = @@Pdiff - @@Lqty
					   	 end    
					    	else if @@pdiff < @@Lqty 
					    	begin	
							
							insert into FoSettlement select ContractNo,BillNo,'B'+Trade_no,Party_Code,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,
							Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@@Pdiff,AuctionPart,MarketType,Series,Order_no,Price,Sauda_date,Table_No,Line_No,
							Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,5,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,
							sebi_tax,Broker_chrg,Service_tax,@@Pdiff*price,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate	
							/* Added By Animesh Cause of Added new fields in FoSettlement on Date 04/09/2001 12:25 PM. */
							,ParticipantCode,Status,CpId,Instrument,BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
						     	from FOSettlement where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
							and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
							and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty   	
	     						
						     	update FOsettlement set settflag = 3,Tradeqty = @@Lqty - @@pdiff,Trade_Amount = (@@Lqty - @@pdiff)*price    
				    		        	where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
					   		and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price and left(convert(varchar,sauda_date,109),11) = @Tdate   
					   		and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 

     						    	select @@Pdiff = 0   
					   	 end 
					    	fetch next from @@Loop into @@Ltrade_no,@@Lqty
				   	end
 				  	close @@Loop
				  end	
			 end 
			 fetch next from @@Flag into @@Pqty,@@sqty
		end 
		close @@Flag
		deallocate @@Flag
	end

 Select @@brokscheme = brok_scheme from client2  Where Client2.Party_code = @Party_code 
Select @@brokscheme , @TDate,@Party_code,@inst_type,@symbol,@expirydate,@strike_price,@option_type
If @@Brokscheme in ('20','21','22','23','24','25','26','27','28','29','30')
Begin
	Exec FOAfterConSettOffflag @TDate,@Party_code,@inst_type,@symbol,@expirydate,@strike_price,@option_type
	exec Upbroksett @TDate,@Party_code,@option_type,@inst_type,@symbol,@expirydate,@strike_price
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOREARRANGEBILLFLAG
-- --------------------------------------------------

CREATE  PROCEDURE FOREARRANGEBILLFLAG

(@EXPIRYDATE SMALLDATETIME) 

AS 

DECLARE  
@@EXPDATE VARCHAR(11),  
@@SELFOTRADE CURSOR,  
@@MYPKEY  INT,  
@@OPTION_TYPE VARCHAR(2),  
@@INST_TYPE VARCHAR(6),  
@@SYMBOL VARCHAR(12),  
@@STRIKE_PRICE MONEY,  
@@SECNAME VARCHAR(20),  
@@EXPIRYDATE SMALLDATETIME,  
@@MYSETTNO INT,  
@@PARTICIPANTCODE VARCHAR(15),  
@@BRANCHID VARCHAR(10),  
@@ACTIVITYTIME SMALLDATETIME,  
@@SELLBUY INT,  
@@PROCLI INT,  
@@PRICE MONEY,  
@@PARTYCODE VARCHAR(10),  
@@MEMBERCODE VARCHAR(6),  
@@TRADEQTY AS INT,  
@@GETEXPIRYDATE AS CURSOR,  
@@TEMPEXPIRYDATE AS SMALLDATETIME,  
@@TEMPSAUDADATE AS VARCHAR(11) ,
@@INSTRUMENT MONEY,
@@BOOKTYPE MONEY
  
SET @@MEMBERCODE = (SELECT LTRIM(RTRIM(ISNULL(MEMBERCODE,''))) FROM FOOWNER)  

  
SET @@GETEXPIRYDATE=CURSOR FOR SELECT DISTINCT LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11), LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) FROM FOSCRIP2 WHERE MATURITYDATE=@EXPIRYDATE --AND  INST_TYPE LIKE 'FUT%'   
OPEN @@GETEXPIRYDATE  
FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
SELECT @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
  
WHILE @@FETCH_STATUS=0 AND @@TEMPEXPIRYDATE=@@TEMPEXPIRYDATE AND @@TEMPSAUDADATE=@@TEMPSAUDADATE  
  
 BEGIN  
		SET @EXPIRYDATE=''  
		SET @EXPIRYDATE=@@TEMPEXPIRYDATE  
		
		SET @@EXPDATE = (SELECT LEFT(CONVERT(VARCHAR,@EXPIRYDATE,109),11))  
		SET @@MYPKEY = 0  
		
		TRUNCATE TABLE FOSETTLEMENTEXPIRY    
		
		
		INSERT INTO FOSETTLEMENTEXPIRY 
		SELECT * FROM FOSETTLEMENT (NOLOCK) WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59' 
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59' 
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))

		TRUNCATE TABLE FOTRADE   
		
		SELECT 
			INST_TYPE,
			SYMBOL,
			STRIKE_PRICE,
			OPTION_TYPE,
			CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, 
			CL_RATE 
		INTO
			#FOCLOSING_BILLREPORT
		FROM 
			FOCLOSING_BILLREPORT (NOLOCK) 
		WHERE 
			TRADE_DATE  BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE + ' 23:59'

		CREATE TABLE #FOTRADE
		(
			[INTSRNO] [INT] IDENTITY NOT NULL  ,
			[STATUS] [VARCHAR] (3)  ,
			[INST_TYPE] [VARCHAR] (6)  ,
			[SYMBOL] [VARCHAR] (12)  ,
			[EXPIRYDATE] [SMALLDATETIME] NULL ,
			[STRIKE_PRICE] [MONEY] NULL ,
			[OPTION_TYPE] [VARCHAR] (2)  ,
			[SEC_NAME] [VARCHAR] (25)  ,
			[BOOKTYPE] [INT]   ,
			[BOOKTYPENAME] [INT]   ,
			[MARKETTYPE] [INT]   ,
			[USER_ID] [INT] NULL ,
			[BRANCH_ID] [VARCHAR] (15)  ,
			[SELL_BUY] [INT] NULL ,
			[TRADEQTY] [INT] NULL ,
			[PRICE] [MONEY] NULL ,
			[PRO_CLI] [INT] NULL ,
			[PARTY_CODE] [VARCHAR] (10)  ,
			[PARTICIPANTCODE] [VARCHAR] (50)  ,
			[O_C_FLAG] [VARCHAR] (5)  ,
			[C_U_FLAG] [VARCHAR] (7)  ,
			[ACTIVITYTIME] [DATETIME] NULL ,
			[LAST_MOD_TIME] [DATETIME] NULL ,
			[ORDER_NO] [VARCHAR] (15)  ,
			[OPP_BROKER_ID] [VARCHAR] (5)  ,
			[SETTFLAG] [INT] NULL ,
			[MEMBERCODE] [VARCHAR] (10)  ,
			[TMPARTYCODE] [VARCHAR] (10)  ,
			[RESERVED1] [VARCHAR] (10)  ,
			[RESERVED2] [VARCHAR] (10)  ,
			[RESERVED3] [VARCHAR] (10)  ,
			[RESERVED4] [VARCHAR] (10)  ,
			[RESERVED5] [VARCHAR] (10) 
		)

		INSERT INTO #FOTRADE 
		(
			STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,
			BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,
			PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,OPP_BROKER_ID,SETTFLAG,
			MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5
		)
		SELECT 
			'11',E.INST_TYPE,E.SYMBOL,E.EXPIRYDATE,E.STRIKE_PRICE,E.OPTION_TYPE,E.INST_TYPE+E.SYMBOL,
			NUMERATOR,DENOMINATOR,RegularLot,999,0 ,	
			SBFLAG = (CASE WHEN SUM(PQTY-SQTY) > 0 THEN 2 ELSE 1 END), 
			NETQTY= ABS(SUM(PQTY-SQTY)),  
			PRICE = CASE LEFT(E.INST_TYPE,3) WHEN 'FUT' THEN ISNULL(#FOCLOSING_BILLREPORT.CL_RATE,0) ELSE 0 END,
			PRO_CLI = (CASE WHEN LTRIM(RTRIM(PARTY_CODE))=@@MEMBERCODE THEN '2' ELSE '1' END),
			PARTY_CODE,PARTICIPANTCODE=@@MEMBERCODE,'10','COVER',@@TEMPSAUDADATE,@@TEMPSAUDADATE,
			'NIL',0,@@MEMBERCODE,BRANCHID=PARTY_CODE,0,0,'','',''	
		FROM 
		(
			SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,
			SEC_NAME=LEFT(S.INST_TYPE,3)+S.SYMBOL+LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11),S.EXPIRYDATE,  
			PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END ),  
			SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END )
			FROM FOSETTLEMENT S  (NOLOCK) 
			WHERE  
			S.RESERVED1 = '0'  AND 
			S.EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE + ' 23:59'  
			AND SAUDA_DATE > 'JAN  1 1900'
			AND SAUDA_DATE <= @@TEMPSAUDADATE + ' 23:59'
			GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE  
		) E 
		LEFT OUTER JOIN 
		#FOCLOSING_BILLREPORT
		ON 
		(
			#FOCLOSING_BILLREPORT.INST_TYPE = E.INST_TYPE 
			AND #FOCLOSING_BILLREPORT.SYMBOL=E.SYMBOL   
			AND #FOCLOSING_BILLREPORT.STRIKE_PRICE=E.STRIKE_PRICE 
			AND #FOCLOSING_BILLREPORT.OPTION_TYPE =E.OPTION_TYPE   
			AND #FOCLOSING_BILLREPORT.EXPIRYDATE = CONVERT(VARCHAR,E.EXPIRYDATE,103)  
		),  
		FOSCRIP2 F  
		WHERE 
			E.EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE +' 23:59'  
			AND E.INST_TYPE=F.INST_TYPE  
			AND E.SYMBOL=F.SYMBOL  
			AND E.EXPIRYDATE=F.EXPIRYDATE  
			AND F.MATURITYDATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND E.STRIKE_PRICE = F.STRIKE_PRICE
			AND E.OPTION_TYPE = F.OPTION_TYPE
		GROUP BY PARTY_CODE,E.INST_TYPE,E.SYMBOL,E.EXPIRYDATE,E.OPTION_TYPE,E.STRIKE_PRICE,
		#FOCLOSING_BILLREPORT.CL_RATE,
		NUMERATOR,DENOMINATOR,F.RegularLot
		HAVING SUM(PQTY - SQTY)  <> 0  	

		INSERT INTO FOTRADE
		SELECT 	
			TRADENO=9000000000 + INTSRNO,
			STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,
			BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,
			PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,
			ORDERNO=999999990000000 +INTSRNO, OPP_BROKER_ID,SETTFLAG,
			MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5
		FROM 	#FOTRADE

	
		UPDATE FOTRADE SET SETTFLAG = SELL_BUY + 3

		DECLARE  @@TDATE AS VARCHAR(11)
		SET @@TDATE = (SELECT LEFT(CONVERT(VARCHAR,MAX(ACTIVITYTIME)),11) FROM FOTRADE)
		DECLARE @@COUNT INT
		
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT @@COUNT = COUNT(1) FROM FOTRADE (NOLOCK), CLIENT2 (NOLOCK)
		WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT2.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30')  
		
		IF @@COUNT > 0
		BEGIN 
			EXEC FOTRDSETTOFFFLAG @@TDATE   
		END
		
		EXEC FOTRD_CLIENTMASTER 
		
		TRUNCATE TABLE BBGFOSETTLEMENT    
		
		INSERT INTO BBGFOSETTLEMENT SELECT '0000000',C_REGULAR_LOT,TRADE_NO, PARTY_CODE,  
		INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID ,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,  
		AUCTIONPART=CASE LEFT(INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,MARKETTYPE,0, ORDER_NO,PRICE,  
		@@TEMPSAUDADATE,FOCONFIRMVIEW_EXPIRY.TABLE_NO,LINE_NO,VAL_PERC, NORMAL ,DAY_PUC, DAY_SALES,  
		SETT_PURCH, SETT_SALES, SELL_BUY,SETTFLAG,   
		BROKAPPLIED ,  
		NETRATE ,  
		AMOUNT,  
		INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX, BROKER_CHRG,  
		SERVICE_TAX,  
		TRADE_AMOUNT , 1 ,'0',  
		NBROKAPP = 0,  
		NSERTAX = 0,  
		0, 'F',0,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1=0,DUMMY2=PRICE,  
		RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN (F.MEMBERCODE) OR PARTICIPANTCODE = 'NCIT') THEN 0  
		WHEN PARTICIPANTCODE IS NULL THEN 0  
		ELSE 1 END),RESERVED2,PARTY_CODE
		FROM FOCONFIRMVIEW_EXPIRY,FOOWNER F  
		
		INSERT INTO BBGFOSETTLEMENT SELECT '0000000',C_REGULAR_LOT,TRADE_NO,PARTY_CODE,
		FOTRADE.INST_TYPE,FOTRADE.SYMBOL,FOTRADE.SEC_NAME,FOTRADE.EXPIRYDATE,FOTRADE.STRIKE_PRICE,
		FOTRADE.OPTION_TYPE,USER_ID,  
		PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,CASE LEFT(FOTRADE.INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,MARKETTYPE,0,
		ORDER_NO,PRICE,@@TEMPSAUDADATE,TABLE_NO=0,LINE_NO = 0,'V',  
		NORMAL=0,DAY_PUC=0,DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,SELL_BUY,SETTFLAG=0,BROKAPPLIED=0,NETRATE=PRICE,  
		AMOUNT=PRICE*TRADEQTY,  
		INS_CHRG=0,  
		TURN_TAX=0,  
		OTHER_CHRG=0,  
		SEBI_TAX=0,  
		BROKER_CHRG=0,  
		SERVICE_TAX=0,  
		TRADE_AMOUNT=PRICE*TRADEQTY,  
		1,'0',0,0,0,'F',0,PARTICIPANTCODE,STATUS,CPID='0',INSTRUMENT=BOOKTYPENAME,BOOKTYPE,TMPARTYCODE,TMARK='0',  
		SCHEME=0,DUMMY1=0,DUMMY2=PRICE,  
		RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN
		(SELECT MEMBERCODE FROM FOOWNER) OR PARTICIPANTCODE = 'NCIT') THEN 0  
		WHEN PARTICIPANTCODE IS NULL THEN 0  
		ELSE 1 END),RESERVED2,PARTY_CODE 
		FROM FOTRADE, FOSCRIP2
		WHERE 
		FOTRADE.INST_TYPE = FOSCRIP2.INST_TYPE
		AND FOTRADE.SYMBOL = FOSCRIP2.SYMBOL
		AND CONVERT(VARCHAR,FOTRADE.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103)
		AND FOTRADE.STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE
		AND FOTRADE.OPTION_TYPE = FOSCRIP2.OPTION_TYPE
		AND FOTRADE.TRADE_NO NOT IN (SELECT DISTINCT TRADE_NO FROM FOCONFIRMVIEW_EXPIRY)  

		UPDATE BBGFOSETTLEMENT SET PARENTCODE = C.PARENTCODE
		FROM CLIENT2_VIEW C (NOLOCK) WHERE C.PARTY_CODE = BBGFOSETTLEMENT.PARTY_CODE

                INSERT INTO FOSETTLEMENT SELECT 
                CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,
                ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,
                SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,
                INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,
                TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,
                SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,
                BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
                FROM FOSETTLEMENTEXPIRY

		TRUNCATE TABLE FOSETTLEMENTEXPIRY    
		
		EXEC BBGDIRECTFOGENCONTRACT_EXPIRY  
		
		UPDATE BBGFOSETTLEMENT SET SETTFLAG = CASE WHEN SELL_BUY =1 THEN  4 ELSE 5 END 
		UPDATE BBGFOSETTLEMENT SET CONTRACTNO =0 WHERE INST_TYPE LIKE 'OPT%' AND AUCTIONPART ='CA'
		
		INSERT INTO FOEXPIRYBACKUP SELECT *,GETDATE() FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%' OR AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%')
		
		DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))		
		
		DELETE FROM FOEXPIRYSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		
		INSERT INTO FOEXPIRYSETTLEMENT 
		SELECT
			CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID,
			PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,
			LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,
			AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,
			NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,
			DUMMY1,DUMMY2,RESERVED1,RESERVED2
		FROM BBGFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		INSERT INTO FOSETTLEMENT 
		SELECT
			CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID,
			PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,
			LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,
			AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,
			NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,
			DUMMY1,DUMMY2,RESERVED1,RESERVED2
		FROM BBGFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		IF (SELECT ISNULL(MEMBERTYPE,'') FROM FOOWNER) = 'CM'  
		BEGIN  
        		DELETE FROM FOTMCLCHRG WHERE ORDERNO LIKE '99999999%' AND SAUDA_DATE BETWEEN @@TEMPSAUDADATE  
			AND @@TEMPSAUDADATE +' 23:59' AND DUMMY2 IN ('EA','CA')
        		
        		INSERT INTO FOTMCLCHRG SELECT PARTY_CODE,ORDER_NO,SAUDA_DATE,CLEARINGCHARGES = (BROKAPPLIED*TRADEQTY),DUMMY1='0',
        		DUMMY2=CASE LEFT(INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,TRADE_NO,SELL_BUY  
        		FROM BBGFOSETTLEMENT  
        		WHERE ORDER_NO LIKE '99999999%' AND SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
        		
        		UPDATE FOEXPIRYSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0 
			WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))

        		UPDATE FOSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0 
			WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		END  

       		UPDATE FOSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0,
                INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,NETRATE = 0
                WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59' AND AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'	

		TRUNCATE TABLE BBGFOSETTLEMENT    
		TRUNCATE TABLE FOTRADE   
		TRUNCATE TABLE FOFTTRADE
		DROP TABLE #FOCLOSING_BILLREPORT
		DROP TABLE #FOTRADE

		EXEC PR_CHARGES_DETAIL @@TEMPSAUDADATE,@@TEMPSAUDADATE,'',''
		
		FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
   END         
  
CLOSE @@GETEXPIRYDATE  
DEALLOCATE @@GETEXPIRYDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoRearrangeBillflag_New
-- --------------------------------------------------

CREATE  PROCEDURE FoRearrangeBillflag_New

(@ExpiryDate smalldatetime) 

AS 

declare  
@@expdate varchar(11),  
@@selfotrade Cursor,  
@@MyPKey  Int,  
@@option_type varchar(2),  
@@inst_type varchar(6),  
@@symbol varchar(12),  
@@strike_price money,  
@@SecName varchar(20),  
@@expirydate smalldatetime,  
@@MySettno Int,  
@@participantcode varchar(15),  
@@branchid varchar(10),  
@@activitytime smalldatetime,  
@@sellbuy int,  
@@procli int,  
@@price money,  
@@partycode varchar(10),  
@@membercode varchar(6),  
@@tradeqty as int,  
@@GetExpiryDate as cursor,  
@@TempExpirydate as smalldatetime,  
@@TempSaudadate as varchar(11), 
@@Instrument money,
@@MarketType money,
@@BookType money,
@@Reserved2 varchar(20)
  

SET @@expdate = (select left(convert(varchar,@expirydate,109),11))  
SET @@membercode = (select ltrim(rtrim(isnull(membercode,''))) from foowner)  


  
SET @@GetExpiryDate=CURSOR FOR 
SELECT DISTINCT 
	left(convert(varchar,EXPIRYDATE,109),11), 
	left(convert(varchar,maturitydate,109),11) 
from 
	foscrip2 
where 
	Maturitydate=@ExpiryDate --AND  inst_type like 'FUT%'   

OPEN @@GetExpiryDate  
FETCH NEXT FROM @@GetExpiryDate into @@TempExpirydate,@@TempSaudadate  

--select @@TempExpirydate,@@TempSaudadate  
  
While @@Fetch_Status = 0 --and @@TempExpirydate=@@TempExpirydate and @@TempSaudadate=@@TempSaudadate  
  
 Begin  
		SET @ExpiryDate=''  
		SET @ExpiryDate=@@TempExpirydate  
		
		--SET @@expdate = (select left(convert(varchar,@expirydate,109),11))  
		--SET @@membercode = (select ltrim(rtrim(isnull(membercode,''))) from foowner)  

		SET @@MyPkey = 0  
		
		truncate table fosettlementexpiry    
		
		
		insert into fosettlementexpiry select * from fosettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
		
		delete from fosettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))

		truncate table fotrade   
		
		select 
			Inst_type,
			Symbol,
			Strike_Price,
			Option_Type,
			Convert(Varchar,ExpiryDate,103) as ExpiryDate, 
			cl_rate 
		into
			#FoClosing_BillReport
		from 
			foclosing_billreport  
		where 
			trade_date  like @@TempSaudadate +'%'  
			and expiryDate like  @@expdate+'%'


		Set @@selFoTrade = cursor for  

		select E.inst_type,E.symbol,E.expirydate,E.strike_price,E.option_type,E.inst_type+E.symbol,  
		sbflag = (case when sum(pqty-sqty) > 0 then 2 else 1 end),  
		netqty= abs(sum(pqty-sqty)),  
		price = (Case left(e.inst_type,3) when 'FUT' then
		isnull(#Foclosing_BillReport.Cl_rate,0) else 0 end),  
		pro_cli = (case when ltrim(rtrim(party_code))=@@membercode then '2' else '1' end),  
		party_code,participantcode,@@expdate+' 23:30:00',party_code,
		Numerator,Denominator,RegularLot,PriceUnit  
		from 
		(
			Select S.Party_Code,s.Inst_Type,s.Symbol,s.Strike_Price,s.Option_Type,
			sec_Name=Left(S.Inst_Type,3)+S.Symbol+Left(Convert(Varchar,s.Expirydate,109),11),s.Expirydate,  
			S.Sauda_Date,  
			Pqty = ( Case When Sell_Buy = 1 Then Sum(S.Tradeqty) Else 0 End ),  
			Sqty = ( Case When Sell_Buy = 2 Then Sum(S.Tradeqty) Else 0 End ),netrate,price,  
			Participantcode = (Case When (Participantcode = '' Or Participantcode Is Null)   
			   Then (Select Ltrim(Rtrim(Isnull(Membercode,''))) From FoOwner)  
			   Else Ltrim(Rtrim(Participantcode))  
			   End)  
			From FoSettlement S  
			where  
			S.Reserved1 = '0'  and 
			S.expirydate like  @@expdate+'%'  
			Group By S.Party_Code,s.Inst_Type,s.Symbol,s.Strike_Price,s.Option_Type,s.Expirydate,  
			S.Sauda_Date,s.Sell_Buy,s.Netrate,s.Price,participantcode
		) E 
		left outer join 
		#FoClosing_BillReport
		on 
		(
			#foclosing_billreport.Inst_Type = E.inst_type 
			and #foclosing_billreport.symbol=E.symbol   
			and #foclosing_billreport.strike_price=E.strike_price 
			and #foclosing_billreport.option_type =E.option_type   
			and #foclosing_billreport.expirydate = convert(varchar,E.expirydate,103)  
		),  
		foscrip2 F  
		where 
			E.expirydate like  @@expdate+'%'  
			and E.inst_type=F.inst_type  
			and E.symbol=f.symbol  
			and E.expirydate=f.expirydate  
			and f.maturitydate like @@TempSaudadate +'%'  
			and e.strike_price = f.strike_price
			and e.option_type = f.option_type
			And e.Sauda_Date <= @@TempSaudadate + ' 23:59'
		group by party_code,E.inst_type,E.symbol,E.expirydate,E.option_type,E.strike_price,
		participantcode,Numerator,Denominator,RegularLot,PriceUnit
		having sum(pqty - sqty)  <> 0  
		order by party_code,E.inst_type,E.symbol,E.expirydate,E.option_type,E.strike_price  
		
		
		Open @@SelFoTrade  
		Fetch next from @@SelFoTrade into @@inst_type,@@symbol,@@expirydate,@@strike_price,@@option_type,  
		@@SecName,@@sellbuy,@@tradeqty,@@price,@@procli,@@partycode,@@participantcode,@@activitytime,@@branchid,
		@@BookType,@@Instrument,@@MarketType,@@Reserved2
		
		set @@Mypkey = @@Mypkey + 1  
		
		While @@Fetch_Status = 0 and  @@partycode=@@partycode AND @@inst_type=@@inst_type  AND @@symbol=@@symbol  AND @@expirydate=@@expirydate   
		
		begin  	
                       Insert into fotrade values(9000000000+@@MyPkey ,'11',@@inst_type,@@symbol,@@expirydate,@@strike_price,@@option_type,
                       @@SecName,@@BookType,@@Instrument,@@MarketType,999,'1',@@sellbuy,@@tradeqty,@@price,@@procli,@@partycode,@@participantcode,'10','COVER',@@TempSaudadate,@@TempSaudadate,
                       999999990000000+@@MyPkey,'NIL',0,@@membercode,@@branchid,0,@@Reserved2,'','','')        

		set @@Mypkey = @@Mypkey + 1  
		Fetch next from @@SelFoTrade into @@inst_type,@@symbol,@@expirydate,@@strike_price,@@option_type,  
		@@SecName,@@sellbuy,@@tradeqty,@@price,@@procli,@@partycode,@@participantcode,@@activitytime,@@branchid,
		@@BookType,@@Instrument,@@MarketType,@@Reserved2
		
		end  
		deallocate @@SelFoTrade  
		

		exec fotrdcontract  
		
		truncate table bbgfosettlement    
		
		insert into bbgfosettlement select '0000000',BillNo=C_Regular_Lot,Trade_no, party_code,  
		inst_type,symbol,sec_name,expirydate,strike_price,option_type,user_id ,pro_cli,o_c_flag,c_u_flag,tradeqty,  
		auctionpart=Case Left(Inst_Type,3) when 'OPT' then 'CA' else 'EA' end,markettype,0, order_no,Price,  
		@@TempSaudadate,foconfirmview_expiry.Table_No,Line_No,Val_perc, Normal ,Day_puc, day_sales,  
		Sett_purch, Sett_sales, Sell_buy,settflag,   
		Brokapplied ,  
		NetRate ,  
		Amount,  
		Ins_chrg,turn_tax,other_chrg,sebi_tax, Broker_chrg,  
		Service_tax,  
		Trade_amount , 1 ,'0',  
		nbrokapp = 0,  
		nsertax = 0,  
		0, 'F',0,ParticipantCode,Status,CpId,Instrument,BookType,Branch_Id,tmark,Scheme,Dummy1=0,Dummy2=Price,  
		Reserved1=(case when participantcode is not null and (participantcode  in (f.membercode) or participantcode = 'NCIT') then 0  
		when participantcode is null then 0  
		else 1 end),Reserved2  
		from foconfirmview_expiry,foowner f  
		
                insert into bbgfosettlement select '0000000',C_Regular_Lot,Trade_No,Party_Code,
		FoTrade.Inst_Type,FoTrade.Symbol,FoTrade.Sec_Name,FoTrade.Expirydate,FoTrade.Strike_price,
		FoTrade.Option_type,User_Id,
                Pro_cli,O_C_Flag,C_U_Flag,TradeQty,'EA',MarKetType,0,order_no,Price,@@TempSaudadate,table_no=0,line_no = 0,'V',
                normal=0,day_puc=0,day_sales=0,sett_purch=0,sett_sales=0,Sell_Buy,settflag=0,brokapplied=0,netrate=price,
                amount=price*tradeqty,
                ins_chrg=0,
                turn_tax=0,
                other_chrg=0,
                sebi_tax=0,
                broker_chrg=0,
                service_tax=0,
                trade_amount=price*tradeqty,
                1,'0',0,0,0,'F',0,ParticipantCode,status,cpid='0',instrument=BookTypeName,BookType,tmpartycode,tmark='0',
                scheme=0,dummy1=0,dummy2=price,
                Reserved1=(case when participantcode is not null and (participantcode  in (select membercode from foowner) or participantcode = 'NCIT') then 0
                when participantcode is null then 0
                else 1 end),Reserved2
		from fotrade, FoScrip2
		where 
		FoTrade.Inst_Type = FoScrip2.Inst_Type
		And FoTrade.Symbol = FoScrip2.Symbol
		And convert(varchar,FoTrade.ExpiryDate,103) = convert(varchar,FoScrip2.ExpiryDate,103)
		And FoTrade.Strike_Price = FoScrip2.Strike_Price
		And FoTrade.Option_Type = FoScrip2.Option_Type
                And fotrade.trade_no not in (select distinct trade_no from foconfirmview_expiry)

                insert into fosettlement select 
                Contractno,Billno,Trade_No,Party_Code,Inst_Type,Symbol,Sec_Name,Expirydate,Strike_Price,
                Option_Type,User_Id,Pro_Cli,O_C_Flag,C_U_Flag,Tradeqty,Auctionpart,Markettype,Series,
                Order_No,Price,Sauda_Date,Table_No,Line_No,Val_Perc,Normal,Day_Puc,Day_Sales,
                Sett_Purch,Sett_Sales,Sell_Buy,Settflag,Brokapplied,Netrate,Amount,
                Ins_Chrg,Turn_Tax,Other_Chrg,Sebi_Tax,Broker_Chrg,Service_Tax,
                Trade_Amount,Billflag,Sett_No,Nbrokapp,Nsertax,N_Netrate,
                Sett_Type,Cl_Rate,Participantcode,Status,Cpid,Instrument,
                Booktype,Branch_Id,Tmark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2
                from fosettlementexpiry

		truncate table fosettlementexpiry    
		
		exec BBGDirectFOGenContract_expiry  
		
		update bbgfosettlement set settflag = case when sell_buy =1 then  4 else 5 end 
		Update bbgfosettlement set contractno =0 where inst_type like 'OPT%' and auctionpart ='CA'
		
		insert into foexpirybackup select *,getdate() from fosettlement where sauda_date like @@TempSaudadate + '%' 
		and expirydate like @@expdate +'%' and (auctionpart = 'EA' and inst_type like 'FUT%' or auctionpart = 'CA' and inst_type like 'OPT%')
		
		delete from fosettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))		
		
		delete from foexpirysettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%'
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
		
		
		insert into foexpirysettlement select * from bbgfosettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%' 
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
		
		insert into fosettlement select * from bbgfosettlement where sauda_date like @@TempSaudadate + '%' and expirydate like @@expdate +'%'
		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
		
		if (select isnull(membertype,'') from foowner) = 'CM'  
		begin  
        		delete from fotmclchrg where orderno like '99999999%' and sauda_date like @@TempSaudadate + '%' and dummy2 in ('EA','CA')
        		
        		insert into fotmclchrg select Party_code,order_no,Sauda_date,Clearingcharges = (brokapplied*tradeqty),dummy1='0',
        		dummy2=Case Left(Inst_Type,3) when 'OPT' then 'CA' else 'EA' end,trade_no,sell_buy  
        		from bbgfosettlement  
        		where order_no like '99999999%' and sauda_date like @@TempSaudadate + '%'
        		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
        		
        		update foexpirysettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0 where expirydate like @@expdate +'%' 
        		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))

        		update fosettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0 where expirydate like @@expdate +'%' 
        		and ((auctionpart = 'EA' and inst_type like 'FUT%') or (auctionpart = 'CA' and inst_type like 'OPT%'))
		end  

       		Update fosettlement set nbrokapp = 0,nsertax = 0,brokapplied = 0,service_tax = 0,
                ins_Chrg=0,Turn_Tax=0,Other_Chrg=0,Sebi_Tax=0,Broker_Chrg=0,NetRate = 0
                where expirydate like @@expdate +'%' and auctionpart = 'CA' and inst_type like 'OPT%'	


		
		truncate table bbgfosettlement    
		truncate table fotrade   
		truncate table fofttrade    
		drop table #FoClosing_BillReport

		FETCH NEXT FROM @@GetExpiryDate into @@TempExpirydate,@@TempSaudadate  
   END         
  
CLOSE @@GetExpiryDate  
Deallocate @@GetExpiryDate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoRearrangeTrdflag
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[FoRearrangeTrdflag]  
    
AS     
 DECLARE     
 @@LTRADE_NO VARCHAR(14),    
 @@LQTY NUMERIC(9),     
 @@PDIFF NUMERIC(9),      
 @@FLAG CURSOR,    
 @@LOOP CURSOR,  
 @@TPARTY_CODE VARCHAR(20),    
 @@TINST_TYPE VARCHAR(20),     
 @@TSYMBOL VARCHAR(20),    
 @@TEXPIRYDATE DATETIME,    
 @@TSTRIKE_PRICE MONEY,    
 @@TOPTION_TYPE VARCHAR(20),  
 @@TPQTY NUMERIC(9),  
 @@TSQTY NUMERIC(9),  
 @@SAUDA_DATE VARCHAR(11)  
  
EXEC FOTRD_CLIENTMASTER 


 SELECT TOP 1 @@SAUDA_DATE = LEFT(ACTIVITYTIME,11) FROM FOTRADE  
  
 --INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','START','UPDATING FOTRADE WITH DEFAULT VALUE',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
  
    
 UPDATE FOTRADE SET SETTFLAG = '1' FROM FOTRADE ,FOTRD_CLIENT2 CLIENT2   WHERE     
 CLIENT2.TRAN_CAT = 'DEL'   AND CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE   
   
 UPDATE FOTRADE SET SETTFLAG =   
  (CASE WHEN SELL_BUY=1 THEN '2' ELSE '3' END)   
 FROM FOTRD_CLIENT2 CLIENT2, FOTRADE  WHERE     
 FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.TRAN_CAT = 'TRD'    
   
  --INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','UPDATING FOTRADE WITH DEFAULT VALUE','GETTING OPEN QTY',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
   
 SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE ,  
 PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
 SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
 INTO #TRADE  
 FROM FOTRADE S WITH(INDEX(PARTYCODE)) ,FOTRD_CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.TRAN_CAT = 'TRD'     
 GROUP BY S.PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE    
 HAVING ( SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0)      
 OR (SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 )      
  
  --INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','GETTING OPEN QTY','UPDATING OPEN QTY WITH 4 5',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
   
 UPDATE FOTRADE SET SETTFLAG = (CASE WHEN PQTY = 0 THEN 5 ELSE 4 END)      
 FROM FOTRADE T, #TRADE T1       
 WHERE T.PARTY_CODE = T1.PARTY_CODE      
 AND T.INST_TYPE = T1.INST_TYPE  
 AND T.SYMBOL = T1.SYMBOL  
 AND T.EXPIRYDATE = T1.EXPIRYDATE  
 AND T.OPTION_TYPE = T1.OPTION_TYPE  
 AND T.STRIKE_PRICE = T1.STRIKE_PRICE  
   
  --INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','UPDATING OPEN QTY WITH 4 5','GETTING POSITIONS TO #TRADENEW',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
  
 SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE ,  
 PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
 SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
 INTO #TRADENEW  
 FROM FOTRADE S WITH(INDEX(PARTYCODE)) WHERE SETTFLAG IN (2,3)  
 GROUP BY S.PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE    
  
  
  --INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','GETTING POSITIONS TO #TRADENEW','OPENING CURSOR @@FLAG ON POSITIOS',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
   
 SET @@FLAG = CURSOR FOR   
   SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE, PQTY, SQTY  
   FROM #TRADENEW S  
   ORDER BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE  
  
 OPEN @@FLAG      
 FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TOPTION_TYPE,@@TPQTY,@@TSQTY      
      
 WHILE ( (@@FETCH_STATUS = 0)  )      
 BEGIN      
      IF  @@TSQTY = 0      
      BEGIN      
           UPDATE FOTRADE SET SETTFLAG = 4      
         WHERE PARTY_CODE = @@TPARTY_CODE       
           AND INST_TYPE = @@TINST_TYPE  
           AND SYMBOL = @@TSYMBOL  
           AND EXPIRYDATE = @@TEXPIRYDATE  
           AND OPTION_TYPE = @@TOPTION_TYPE  
     AND STRIKE_PRICE = @@TSTRIKE_PRICE  
           AND SELL_BUY = 1       
       END      
       IF  @@TPQTY = 0      
       BEGIN      
           UPDATE FOTRADE SET SETTFLAG = 5  
           WHERE PARTY_CODE = @@TPARTY_CODE       
           AND INST_TYPE = @@TINST_TYPE  
           AND SYMBOL = @@TSYMBOL  
           AND EXPIRYDATE = @@TEXPIRYDATE  
           AND OPTION_TYPE = @@TOPTION_TYPE  
           AND STRIKE_PRICE = @@TSTRIKE_PRICE  
           AND SELL_BUY = 2  
        END      
      
         IF  ( (@@TPQTY > @@TSQTY) AND (@@TSQTY > 0 ))       
         BEGIN       
              SELECT @@PDIFF = @@TPQTY - @@TSQTY      
  
              SET @@LOOP  = CURSOR FOR       
              SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND INST_TYPE = @@TINST_TYPE  
              AND SYMBOL = @@TSYMBOL  
              AND EXPIRYDATE = @@TEXPIRYDATE  
              AND OPTION_TYPE = @@TOPTION_TYPE  
              AND STRIKE_PRICE = @@TSTRIKE_PRICE  
              AND SELL_BUY = 1   
              ORDER BY PRICE DESC        
              OPEN @@LOOP      
  
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN      
  
                        UPDATE FOTRADE SET SETTFLAG = 4         
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 1       
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY       
   
                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END  
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
                    INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,   
                    SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,    
                    PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,4,MEMBERCODE,  
            TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5     
            FROM FOTRADE  
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 1       
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY                        
  
                        UPDATE FOTRADE SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF          
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 1       
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY      
  
                        SELECT @@PDIFF = 0         
                END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
                 END      
                 CLOSE @@LOOP       
          END        
                
          IF  ( (@@TPQTY < @@TSQTY) AND (@@TPQTY > 0 ))       
          BEGIN       
      SELECT @@PDIFF = @@TSQTY - @@TPQTY      
  
              SET @@LOOP  = CURSOR FOR  
              SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND INST_TYPE = @@TINST_TYPE  
              AND SYMBOL = @@TSYMBOL  
              AND EXPIRYDATE = @@TEXPIRYDATE  
              AND OPTION_TYPE = @@TOPTION_TYPE  
              AND STRIKE_PRICE = @@TSTRIKE_PRICE  
              AND SELL_BUY = 2  
              ORDER BY PRICE DESC        
              OPEN @@LOOP      
  
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN      
  
                        UPDATE FOTRADE SET SETTFLAG = 5  
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 2  
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY        
  
                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END          
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
  
                    INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,   
                    SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,    
                    PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,5,MEMBERCODE,  
            TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5     
            FROM FOTRADE  
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 2       
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY                        
  
                        UPDATE FOTRADE SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF          
                        WHERE PARTY_CODE = @@TPARTY_CODE       
                   AND INST_TYPE = @@TINST_TYPE  
                   AND SYMBOL = @@TSYMBOL  
                   AND EXPIRYDATE = @@TEXPIRYDATE  
                   AND OPTION_TYPE = @@TOPTION_TYPE  
                   AND STRIKE_PRICE = @@TSTRIKE_PRICE  
                        AND SELL_BUY = 2  
                        AND TRADE_NO = @@LTRADE_NO       
                        AND TRADEQTY = @@LQTY      
  
                        SELECT @@PDIFF = 0         
                    END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
               END      
               CLOSE @@LOOP        
  
            END      
  FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TOPTION_TYPE,@@TPQTY,@@TSQTY      
END      
CLOSE @@FLAG      
DEALLOCATE @@FLAG  
--INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','CLOSING INNSER CURSOR','GOING TO FOTRDSETTOFFFLAG_SPL',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
  
EXECUTE FOREARRANGETRDFLAGSPL @@SAUDA_DATE  
  
--INSERT INTO PROCESS_MONITOR VALUES ('FO IMPORT TRADE','CONFIRMATION','','FOREARRANGETRDFLAG','GOING TO FOTRDSETTOFFFLAG_SPL','END',@@ROWCOUNT,@@SAUDA_DATE,GETDATE())  
  

EXEC FOTRD_CLIENTMASTER 


UPDATE  
	FOTRADE  
SET  
 	SEC_NAME = FOSCRIP2.SEC_NAME   
FROM  
 	FOSCRIP2  (NOLOCK)
WHERE   
	FOTRADE.INST_TYPE = FOSCRIP2.INST_TYPE AND   
	FOTRADE.SYMBOL = FOSCRIP2.SYMBOL AND   
	FOTRADE.EXPIRYDATE = FOSCRIP2.EXPIRYDATE AND   
	FOTRADE.STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE AND   
	FOTRADE.OPTION_TYPE = FOSCRIP2.OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoRearrangeTrdflagSpl
-- --------------------------------------------------



CREATE   PROCEDURE [dbo].[FoRearrangeTrdflagSpl] ( @TDate Varchar(11) ) AS       
    
Declare       
 @@FoSettLoop As Cursor,      
 @@Trade_no varchar(14),      
 @@TodayQty numeric(9),      
 @@Ltrade_no varchar(14),      
 @@Lqty numeric(9),       
 @@Pdiff numeric(9),         
 @@TPosCur cursor,      
 @@TParty_code Varchar(20),      
 @@TNetqty numeric(9),      
 @@TInst_Type Varchar(20),       
 @@TSymbol Varchar(20),      
 @@TEXPIRYDATE Datetime,      
 @@TStrike_Price Money,      
 @@TOption_type Varchar(20),      
 @@PPosCur Cursor,      
 @@PParty_code Varchar(20),      
 @@PNetQty Numeric(9),      
 @@PInst_Type Varchar(20),       
 @@PSymbol Varchar(20),      
 @@PEXPIRYDATE Datetime,      
 @@PStrike_Price Money,      
 @@POption_type Varchar(20),      
 @@DiffQty  Numeric(9) ,    
 @@Loop Cursor    
    
  --Insert Into Process_Monitor values ('IMPORT TRADE','CONFIRMATION','','FoRearrangeTrdflagSpl','START','Updating FoTrade With Default Value',@@ROWCOUNT,@TDate,GETDATE())    
        
 Update foTrade Set settflag = Case When Sell_buy =1 then 8 else 9 end     
 from foTrade WITH(INDEX(PARTYCODE))  ,FoTrd_Client2 client2 WITH(INDEX(PARTYCODE))      
 Where client2.Party_code = foTrade.party_code      
 And Client2.brok_scheme >= '20'        
 and settflag not in (2,3)    
    
  --Insert Into Process_Monitor values ('IMPORT TRADE','CONFIRMATION','','FoRearrangeTrdflagSpl','Updating FoTrade With Default Value','Opening cursor for todays open positions ',@@ROWCOUNT,@TDate,GETDATE())    
        
 Set @@TPosCur = cursor for         
  Select s.Party_Code, Inst_Type, Symbol,ExpiryDate,    
  strike_price,option_type ,    
  NetQty = Sum(Case When sell_buy = 1 then tradeqty else 0 end)- Sum(Case When sell_buy = 2 then tradeqty else 0 end)    
  from FoTrade s WITH(INDEX(PARTYCODE)),FoTrd_client2 C  Where     
  s.Party_Code = C.Party_code     
  and Settflag in(8,9)  and Expirydate >= @Tdate + ' 23:59:00'      
  AND c.Brok_scheme >= '20'       
  group by S.Party_Code,s.Inst_Type,s.Symbol,S.ExpiryDate,s.Strike_Price,s.Option_Type    
       
 Open @@TPosCur      
 Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TStrike_Price,@@TOption_Type,@@TNetQty    
     
 If @@fetch_status = 0         
  Begin      
   While @@fetch_status = 0       
    Begin       
    
     Set @@PPosCur = Cursor For      
    
     Select S.Party_Code, Inst_Type, Symbol,ExpiryDate, strike_price,option_type,    
     NetQty = Sum(Case When sell_buy = 1 then tradeqty else 0 end)-Sum(Case When sell_buy = 2 then tradeqty else 0 end)    
     from Fosettlement s, FoTrd_Client2 C WITH(INDEX(PARTYCODE))     
     Where s.party_code = C.Party_code     
     And Inst_type = @@TInst_type And Symbol = @@TSymbol And Expirydate = @@TExpiryDate     
     And Strike_Price = @@TStrike_price And Option_type = @@TOption_type      
     And expirydate >= @Tdate     
     And S.party_code = @@TParty_code and sauda_date < @Tdate     
     and c.Brok_scheme >= '20'       
    
     Group By S.party_code,s.Inst_Type,s.Symbol,expirydate,s.strike_price,s.option_type    
     
     Open @@PPosCur      
     Fetch Next From @@PPosCur into @@PParty_code, @@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type,@@PNetQty    
     
     If @@Fetch_Status = 0      
       While @@fetch_status = 0       
        Begin      
         If  Abs(@@PNetQty) <  Abs(@@TNetqty)      
          Begin      
           select @@Diffqty = Abs(@@PNetQty)    
          End      
         If  Abs(@@PNetQty) >  Abs(@@TNetqty)      
          Begin      
           select @@Diffqty = Abs(@@TNetQty)      
          End      
         If ((@@PNetQty + @@TNetQty ) = 0 )         
          Begin      
           If @@TNetqty > 0     
            Begin      
    
             Update foTrade set settflag = '6'       
             where  party_code = @@TParty_code      
             And Inst_type = @@TInst_type     
                    And Symbol = @@TSymbol       
             And Expirydate = @@TExpiryDate     
             And Strike_Price = @@TStrike_price       
             And Option_type = @@TOption_type      
             And SettFlag =8    
           End       
           If @@TNetQty < 0       
            Begin       
    
             Update foTrade set settflag = '7'       
             where party_code = @@TParty_code     
             And Inst_type = @@TInst_type     
                   And Symbol = @@TSymbol       
             And Expirydate = @@TExpiryDate    
             And Strike_Price = @@TStrike_price       
             And Option_type = @@TOption_type      
             And SettFlag = 9    
            End      
          End       
          If ( (@@PNetQty > 0 ) And (@@TNetQty < 0))         
           Begin      
            If (@@PNetQty) >= Abs(@@TNetqty)      
              Begin       
               Update foTrade set settflag = '7'       
               Where party_code = @@TParty_code     
               And Inst_type = @@TInst_type And Symbol = @@TSymbol       
               And Expirydate = @@TExpiryDate     
               And Strike_Price = @@TStrike_price       
               And Option_type = @@TOption_type      
               And SettFlag =9      
             End      
             If ((@@PNetQty) < Abs(@@TNetqty))       
              Begin      
                 Select @@pdiff = Abs(@@DiffQty)      
                 Set @@Loop  = cursor for       
                  Select trade_no,tradeqty from FOTrade       
                  Where party_code = @@TParty_code and inst_type = @@TInst_type and symbol = @@TSymbol      
                  and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price       
                  and option_type = @@TOption_type    
                  and sell_buy = 2       
                  and Settflag in (5,9)       
                  Order by tradeqty Desc      
                  Open @@loop      
                  Fetch next from @@Loop into @@Ltrade_no,@@Lqty           
                    While @@pdiff > 0             
                     Begin      
                      if @@pdiff >= @@Lqty        
                        Begin      
                         update FoTrade set settflag = 7         
                         where party_code = @@TParty_code and inst_type = @@TInst_type and symbol = @@TSymbol      
                         and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price       
                         and option_type = @@TOption_type     
                         and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (5,9)      
                    
                         select @@pdiff = @@Pdiff - @@Lqty      
                        End          
                       Else if @@pdiff < @@Lqty       
                        Begin      
                         insert into FoTrade select 'T'+Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,      
                         Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,      
                         ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,7,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5       
                         from FOTrade where party_code = @@TParty_code and inst_type = @@TInst_type and symbol = @@TSymbol      
                         and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price and option_type = @@TOption_type     
                         and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty          
                         update FOTrade set settflag = 9,Tradeqty = @@Lqty - @@pdiff         
                         where party_code = @@TParty_code and inst_type = @@TInst_type and symbol = @@TSymbol      
                         and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price and option_type = @@TOption_type    
                         and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty       
                    
              select @@Pdiff = 0         
                    
                       End       
                       Fetch next from @@Loop into @@Ltrade_no,@@Lqty      
                    End      
                  Close @@Loop      
              End                                  
           End                            
           If ( (@@PNetQty < 0 ) And (@@TNetQty > 0))         
            Begin      
             If Abs(@@PNetQty) >= (@@TNetqty)      
               Begin       
    
                Update foTrade set settflag = '6'       
                Where party_code = @@TParty_code     
                And Inst_type = @@TInst_type And Symbol = @@TSymbol       
                And Expirydate = @@TExpiryDate     
                And Strike_Price = @@TStrike_price       
                And Option_type = @@TOption_type      
                And SettFlag =8      
              End      
              If Abs(@@PNetQty) < Abs(@@TNetqty)       
                Begin      
                    Select @@pdiff = Abs(@@DiffQty)    
                  
                    Set @@Loop  = cursor for     
                    Select trade_no,tradeqty from FOTrade     
                    Where party_code = @@TParty_code  and inst_type = @@TInst_type and symbol = @@TSymbol    
                    and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price     
                   and option_type = @@TOption_type    
                    and sell_buy = 1     
                    and Settflag in (4,8)      
                    Order by tradeqty Desc    
                    Open @@loop    
                    Fetch next from @@Loop into @@Ltrade_no,@@Lqty         
                       
                    While @@pdiff > 0           
                    Begin    
                         If @@pdiff >= @@Lqty      
                         Begin    
    
                              Update FoTrade set settflag = 6       
                              Where party_code = @@TParty_code  and inst_type = @@TInst_type and symbol = @@TSymbol    
                              and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price and option_type = @@TOption_type    
                              and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (4,8)    
                              Select @@pdiff = @@Pdiff - @@Lqty    
                         End        
                         Else If @@pdiff < @@Lqty     
                         Begin    
                              insert into FoTrade select 'T' + Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,    
                              Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,    
                              ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,6,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5                                   
                              from FOTrade where party_code = @@TParty_code  and inst_type = @@TInst_type and symbol = @@TSymbol    
                              and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price and option_type = @@TOption_type    
                              and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty        
                   
                              update FOTrade set settflag = 8,Tradeqty = @@Lqty - @@pdiff        
                              where party_code = @@TParty_code and inst_type = @@TInst_type and symbol = @@TSymbol    
                              and expirydate = @@TExpiryDate and strike_price = @@TStrike_Price and option_type = @@TOption_type    
                              and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty   
                              select @@Pdiff = 0       
                           End     
                           Fetch next from @@Loop into @@Ltrade_no,@@Lqty    
           End    
                      Close @@Loop    
                End      
            End       
       Fetch Next From @@PPosCur into @@PParty_code, @@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type,@@PNetQty    
    End      
    close @@PPosCur      
    deallocate @@PPosCur      
    Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TStrike_Price,@@TOption_Type,@@TNetQty    
  End      
  Close @@TPosCur      
  Deallocate @@TPosCur       
 End      
 --Insert Into Process_Monitor values ('IMPORT TRADE','CONFIRMATION','','FoRearrangeTrdflagSpl','closing cursor','END',@@ROWCOUNT,@TDate,GETDATE())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoScripWiseBrokerage
-- --------------------------------------------------



CREATE  Procedure [dbo].[FoScripWiseBrokerage]  
@sauda_date varchar(11),  
@FromParty varchar(10),  
@ToParty varchar(10)  
As  
  
Update FoSettlement set   
       Table_no = BrokTable.Table_No,Line_no = BrokTable.Line_No,  
       Val_perc = BrokTable.Val_perc,Normal = broktable.Normal,Day_puc = Broktable.Day_puc,Day_Sales = Broktable.day_sales,  
       Sett_Purch = Broktable.Sett_purch, Sett_sales = Broktable.Sett_sales,  
    
 BrokApplied = (  case    
		when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='V' and FOSETTLEMENT.sell_buy = 1)  
		                        Then   
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		                   when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='V' and FOSETTLEMENT.sell_buy = 2)  
		                        Then   
		((floor(( broktable.Normal*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		                   when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='P' and FOSETTLEMENT.sell_buy = 1)  
		                         Then    
		((floor ( (((broktable.Normal*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) / 
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
		                  when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='P' and FOSETTLEMENT.sell_buy = 2)  
		                       Then   
		((floor(( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		                when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='V' )   
		                      Then   
		((floor(( ((Broktable.Day_puc*F.MultiPlier))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		                when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='P' )   
		                       Then   
		((floor(( ((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		             when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='V' )  
		                       Then   
		((floor(( Broktable.day_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		            when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='P' )  
		                       Then 
		((floor(( ((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		          when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='V' )  
		                       Then   
		((floor(( Broktable.Sett_purch*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		     when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='P' )  
		                       Then   
		((floor(( ((Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		       when ( FOSETTLEMENT.SettFlag in (5,7,9) and broktable.val_perc ='V' )  
		              Then   
		((floor(( Broktable.Sett_sales*F.MultiPlier * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		                   when ( FOSETTLEMENT.SettFlag in (5,7,9)  and broktable.val_perc ='P' )  
		                       Then   
		((floor(( ((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /    
		(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /   
		power(10,broktable.round_to))  
		Else  0  
		End   ), 
NetRate = (  case    
	      when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='V' and FOSETTLEMENT.sell_buy = 1)  
	           Then   
	      (FOSETTLEMENT.price) + ((floor((  (( broktable.Normal*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * 
				(broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='V' and FOSETTLEMENT.sell_buy = 2)  
				           Then   
				                      (FOSETTLEMENT.price) - ((floor(( (( broktable.Normal*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='P' and FOSETTLEMENT.sell_buy = 1)  
				            Then   
				                 (FOSETTLEMENT.price)+ ((floor(( (((broktable.Normal*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='P' and FOSETTLEMENT.sell_buy = 2)  
				           Then   
				                       (FOSETTLEMENT.price) -  ((floor((  ( ((broktable.Normal*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='V' )   
				        Then   
				             (FOSETTLEMENT.price) + ((floor(( ((Broktable.Day_puc*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='P' )   
				        Then   
				             (FOSETTLEMENT.price) + ((floor(( (((Broktable.Day_puc*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='V' )  
				         Then   
				             (FOSETTLEMENT.price) - ((floor(( (( Broktable.day_sales*F.MultiPlier)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='P' )  
				        Then   
				            (FOSETTLEMENT.price) - ((floor((  (((Broktable.day_sales*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='V' )  
				         Then   
				                    (FOSETTLEMENT.price) + ((floor(( ((Broktable.Sett_purch*F.MultiPlier  )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='P' )  
				          Then   
				               (FOSETTLEMENT.price) + ((floor(( ( (( Broktable.Sett_purch*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag in (5,7,9) and broktable.val_perc ='V' )  
				          Then   
				             (FOSETTLEMENT.price) - ((floor(( (( Broktable.Sett_sales*F.MultiPlier )) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / 
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))  
				when ( FOSETTLEMENT.SettFlag in (5,7,9) and broktable.val_perc ='P' )  
				         Then   
				             (FOSETTLEMENT.price) -  ((floor((  (((Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
				(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))  
							Else  0   
	            End   
	             ),  
        Service_tax =  (case    
        when ( FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='V')  
             Then   
                 ((floor((   
                        (((((floor((( broktable.Normal*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                      power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                      (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when (FOSETTLEMENT.SettFlag = 1 and broktable.val_perc ='P')  
             Then   
                      ((floor((   
                                   (((((floor((   ((broktable.Normal*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
																				 (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                          power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                          (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))  
        when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='V' )   
             Then    
                       ((floor((   
                                    (((((floor(( (Broktable.Day_puc*F.MultiPlier) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when (FOSETTLEMENT.SettFlag = 2  and broktable.val_perc ='P' )   
             Then   
                       ((floor((   
                                    (((((floor((( (Broktable.Day_puc*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / 
																						(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='V' )  
             Then   
                       ((floor((   
                                    (((((floor((( Broktable.day_sales*F.MultiPlier ) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when (FOSETTLEMENT.SettFlag = 3  and broktable.val_perc ='P' )  
             Then   
                       ((floor((   
                                    (((((floor((( (Broktable.day_sales*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / 
																						(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='V' )  
             Then    
                       ((floor((   
                                    (((((floor((( Broktable.Sett_purch*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
        when ( FOSETTLEMENT.SettFlag in (4,6,8)  and broktable.val_perc ='P' )  
             Then   
                       ((floor((   
                                    (((((floor((( (Broktable.Sett_purch*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig +
																						 Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
                                            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
                                             (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      

        when ( FOSETTLEMENT.SettFlag in (5,7,9) and broktable.val_perc ='V' )  
             Then     
                       ((floor((   
                                  (((((floor((( Broktable.Sett_sales*F.MultiPlier)  * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
												           power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
											           (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
	         when ( FOSETTLEMENT.SettFlag in (5,7,9) and broktable.val_perc ='P' )  
            Then    
           ((floor((   
				           (((((floor((( (Broktable.Sett_sales*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + 
																	Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /  
											            power(10,Broktable.round_to))) * FOSETTLEMENT.Tradeqty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /  
											            (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))      
		   Else  0   
       End  ) * BookType / Instrument,  
      Trade_amount = FOSETTLEMENT.Tradeqty * FOSETTLEMENT.price  
      FROM BrokTable,FOSETTLEMENT,FOTAXES,foscrip2,client1,Client2,FOGLOBALS,
        (
                SELECT party_code,inst_type,symbol,expirydate,PQty=SUM(PQty),SQty=Sum(SQty),
                SDate,option_type,strike_price
                FROM 
                        (
                        Select t1.party_code,t1.inst_type,t1.symbol,t1.sec_name,t1.expirydate,t1.sell_buy,
                        PQty = (Case When Sell_buy = 1 Then sum(tradeqty) else 0 end ),
                        SQty = (Case When Sell_buy = 2 Then sum(tradeqty) else 0 end ),
                        SDate = Left(Convert(Varchar,sauda_date,109),11),option_type,strike_price
                        from foSettlement t1 
                        Where t1.sauda_date Like @sauda_date + '%'  
                        and t1.party_code >= @FromParty  
                        and t1.party_code <= @ToParty  
                        and t1.Status <>  'E'
                        GROUP BY t1.party_code,t1.inst_type,t1.symbol,t1.sec_name,t1.expirydate,t1.sell_buy,
                        Left(Convert(Varchar,sauda_date,109),11),option_type,strike_price
                )
                FoSettSale
                group by party_code,inst_type,symbol,expirydate,SDate,option_type,strike_price
        )
         s,
        (

                Select ContractNo,BillNo,Trade_no,FF.Party_Code,FF.Inst_type,FF.Symbol,FF.Sec_name,FF.Expirydate,FF.Strike_price,
                FF.Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,FF.Series,Order_no,Price,
                Sauda_date,FF.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,
                Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,FF.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,
                Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,
                MPrice = (CASE WHEN C2.Dummy1 = 0 
                	       THEN PRICE 
                	       Else
                		   (Case When C2.Dummy1 = 1 
                			 Then (Case When FF.Strike_Price = 0 Then FF.Price Else FF.Strike_Price End )
                	                 Else FF.Strike_price + PRICE  
                		    END)
                	  END) , 
                MultiPlier = ( Case When ( C2.Brok_Scheme = 4 or C2.Brok_Scheme = 5 ) 
                		Then (ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/
                                (Case When TradeQty = 0 Then 1 else TradeQty End))
                		Else  1
                	      End),
                TaxPrice = (CASE WHEN TaxesFlag = 0 
                	       THEN PRICE 
                	       Else
                		   (Case When TaxesFlag = 1 
                			 Then (Case When FF.Strike_Price = 0 Then FF.Price Else FF.Strike_Price End )
                	                 Else FF.Strike_price + PRICE
                		    END)
                	  END) ,
                FF.reserved1,FF.dummy1,status
                From
                FoSettlement FF, Client2 C2, FoScrip2 S2,FOOwner
                where c2.Party_Code = FF.Party_Code 
                and FF.inst_type = S2.inst_type 
                AND FF.SYMBOL = S2.SYMBOL      
                AND FF.expirydate = S2.expirydate
                and FF.option_type = S2.option_type 
                And FF.Strike_Price = S2.Strike_Price
                and FF.sauda_date Like @sauda_date + '%'  
                and FF.party_code >= @FromParty  
                and FF.party_code <= @ToParty  
                and FF.Status <>  'E'  
        ) F, FoScripBrokerage B  
      WHERE FOSETTLEMENT.party_code = Client2.Party_code  
		and client1.cl_code=client2.cl_code              
		and FOSETTLEMENT.inst_type = foscrip2.inst_type   
		AND FOSETTLEMENT.SYMBOL = FOSCRIP2.SYMBOL        
		AND FOSETTLEMENT.expirydate=foscrip2.expirydate and  
		FOSETTLEMENT.option_type = foscrip2.option_type and  
		FOSETTLEMENT.party_code = s.party_code and  
		FOSETTLEMENT.inst_type=S.inst_type and    
		FOSETTLEMENT.symbol=S.symbol and  
		FOSETTLEMENT.expirydate=S.expirydate  AND  
		FOSETTLEMENT.strike_price = s.strike_price and    
		FOSETTLEMENT.option_type = s.option_type 
		And FoSettlement.Inst_Type = B.Inst_Type   
		And FoSettlement.Party_Code like B.Party_Code  
		And FoSettlement.Symbol = B.Symbol  
		And FoSettlement.Inst_Type = B.Inst_Type  
		And Broktable.Table_no = B.Table_No  
		And fosettlement.Sauda_Date between B.From_Date And B.To_Date  
		And fosettlement.Sauda_Date like s.SDate  + '%' And    
		FOSETTLEMENT.party_code = F.party_code and  
		FOSETTLEMENT.inst_type=F.inst_type and    
		FOSETTLEMENT.symbol=F.symbol and  
		FOSETTLEMENT.expirydate=F.expirydate  AND  
		FOSETTLEMENT.strike_price = F.strike_price and                  
		FOSETTLEMENT.option_type = F.option_type and                    
		FOSETTLEMENT.sauda_date = F.sauda_date AND  
		FOSETTLEMENT.Trade_No = F.Trade_No AND   
		FOSETTLEMENT.Order_No = F.Order_No AND  
		FOSETTLEMENT.Sell_Buy = F.Sell_Buy AND   
		FOSETTLEMENT.Sauda_Date  between year_start_dt and year_end_dt AND  
		Broktable.Line_no =  ( case when (B.Brok_Scheme = 1 or B.Brok_Scheme = 5 or B.Brok_Scheme = 22) then       
                 (Select min(Broktable.line_no) from broktable where  
                        Broktable.table_no = B.TABLE_NO       
                       and Trd_Del = ( Case When s.Pqty >= s.Sqty   
							      then ( Case When ( FOSETTLEMENT.Sell_Buy = 1 )   
                    Then 'F'    
                    Else 'S'  
                 End )  
                Else  
                ( Case When ( FOSETTLEMENT.Sell_Buy = 2 )   
                    Then 'F'    
                    Else 'S'  
                 End )       
             End )  
               and FOSETTLEMENT.Party_Code = Client2.Party_code      
               and F.MPrice <= Broktable.upper_lim)             
               when (B.Brok_Scheme = 3 or B.Brok_Scheme = 6 or B.Brok_Scheme = 23 ) then       
                 (Select min(Broktable.line_no) from broktable where  
                  Broktable.table_no = B.TABLE_NO                          
                  and Trd_Del = ( Case When s.Pqty > s.Sqty   
           then ( Case When ( FOSETTLEMENT.Sell_Buy = 1 )   
                    Then 'F'    
                    Else 'S'  
                 End )  
                Else  
                ( Case When ( FOSETTLEMENT.Sell_Buy = 2 )   
                    Then 'F'    
                    Else 'S'  
                 End )       
             End )  
       and FOSETTLEMENT.Party_Code =  Client2.Party_code      
       and F.MPrice <= Broktable.upper_lim)   
        else   
                                       (  select min(line_no) from broktable   
                                          where F.MPrice <= Broktable.upper_lim   
                     and broktable.table_no = B.TABLE_NO  )  
       end )  
 and FOTAXES.exchange = 'NCE'
 and fosettlement.sauda_date Like @sauda_date + '%'  
 and fosettlement.party_code >= @FromParty  
 and fosettlement.party_code <= @ToParty  
 and FOSETTLEMENT.Status <>  'E'  
-- And FOSETTLEMENT.inst_Type = FoTaxes.Inst_Type
-- And FOSETTLEMENT.Symbol = FoTaxes.Symbol
 And fosettlement.Sauda_Date between fotaxes.From_date and fotaxes.To_date
 and fosettlement.Sauda_Date between FoGlobals.year_start_dt and FoGlobals.year_end_dt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOSettBrokEditUp
-- --------------------------------------------------





CREATE   Procedure [dbo].[FOSettBrokEditUp]
(
	@Option_type varchar(2),
	@inst_type varchar(6),
	@symbol varchar(12),
	@Sauda_date varchar(11),
	@strike_price numeric(9),
	@party_code varchar(10),
	@trade_no varchar(14),
	@Order_No Varchar(16),
	@contractNo varchar(14) ,
	@MarketRate Numeric(18,9),
	@Brok Numeric(18,8),
	@Val_Perc Varchar(1),
	@Sell_Buy Int,
	@NetRate Numeric(18,9), 
	@expirydate varchar(11),
	@Flag Int ,
	@StatusId Varchar(50),
	@strModule Varchar(50)
)
AS
if @flag = 1 
begin 
		Update fosettlement set
				BrokApplied = (  case  
					when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
					Then 
						@Brok
					when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
					Then 
						@Brok
					when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
					Then  
						((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + 
						broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))
					when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
					Then 
						((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
						broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
					when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
					Then 
						@Brok
					when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
					Then 
						((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /(broktable.RoFig + 
						broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
					when (fosettlement.SettFlag = 3  and @val_perc ='V' )
					Then 
						@Brok
					when (fosettlement.SettFlag = 3  and @val_perc ='P' )
					Then         
						((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
						broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
					when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
					Then 
						@Brok
					when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
					Then 
						((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
						broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
					when ( fosettlement.SettFlag = 5  and @val_perc ='V' )
					Then 
						@Brok
					when ( fosettlement.SettFlag = 5  and @val_perc ='P' )
					Then 
						((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
						broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
					Else  0 
				End 
			),
	
		NetRate = (  case  
				when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
				Then 
					fosettlement.price + @Brok
				when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
				Then 
					fosettlement.price - @Brok
				when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
				Then 
					(fosettlement.price)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + 
					broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
				Then 
					(fosettlement.price) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + 
					broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
				Then 
					fosettlement.price + @Brok
				when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
				Then 
					(fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when (fosettlement.SettFlag = 3  and @val_perc ='V' )
				Then 
					fosettlement.price - @Brok
				when (fosettlement.SettFlag = 3  and @val_perc ='P' )
				Then 
					(fosettlement.price) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
				Then
					fosettlement.price + @Brok
				when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
				Then 
					(fosettlement.price) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + 
					broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when ( fosettlement.SettFlag =5  and @val_perc ='V' )
				Then 
					fosettlement.price - @Brok
				when ( fosettlement.SettFlag =5  and @val_perc ='P' )
				Then 
					(fosettlement.price) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))
				Else  0 
			End 
			),
		Amount = 
				( case  
				when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
				Then 
					FoSettlement.TradeQty  * (fosettlement.price + @Brok)
				when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
				Then 
					FoSettlement.TradeQty  * (fosettlement.price - @Brok)
				when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
				Then 
					FoSettlement.TradeQty  * ((fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
				when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
				Then 
					FoSettlement.TradeQty * ((fosettlement.price) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
				when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
				Then 
					FoSettlement.TradeQty  * (fosettlement.price + @Brok)
				when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
				Then 
					FoSettlement.TradeQty * ( (fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
				when (fosettlement.SettFlag = 3  and @val_perc ='V' )
				Then 
					FoSettlement.TradeQty  * (fosettlement.price - @Brok)
				when (fosettlement.SettFlag = 3  and @val_perc ='P' )
				Then 
					FoSettlement.TradeQty * (  (fosettlement.price) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
				when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
				Then 
					FoSettlement.TradeQty  * (fosettlement.price + @Brok)
				when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
				Then 
					FoSettlement.TradeQty * ( (fosettlement.price) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
				when ( fosettlement.SettFlag =5  and @val_perc ='V' )
				Then 
					FoSettlement.TradeQty  * (fosettlement.price - @Brok)
				when ( fosettlement.SettFlag =5  and @val_perc ='P' )
				Then 
					FoSettlement.TradeQty  * (  (fosettlement.price) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))
				Else  0 
			End 
			),
		Ins_chrg  = ((floor(( ((fotaxes.insurance_chrg * (f.Taxprice) * FoSettlement.TradeQty)/100) * power(10,Broktable.round_to)+
						broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
	
		turn_tax  =  ((floor(( ((fotaxes.turnover_tax * (((f.Taxprice) * FoSettlement.Tradeqty) * BookType)/Instrument) /100 ) * power(10,Broktable.round_to)+  
						broktable.roFig + broktable.errnum ) /    (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    power(10,broktable.round_to)),  
	
		other_chrg = ((floor(( ((fotaxes.other_chrg * (((f.Taxprice) * FoSettlement.Tradeqty) * BookType)/Instrument) /100 ) * power(10,Broktable.round_to)+  
						broktable.roFig + broktable.errnum ) /    (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    power(10,broktable.round_to)),  	

		sebi_tax =     ((floor(( ((fotaxes.sebiturn_tax *(f.Taxprice) * FoSettlement.TradeQty)/100) * power(10,Broktable.round_to)+
						broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),
	
		Broker_chrg =  ((ceiling(( ((fotaxes.broker_note * (f.Taxprice) * FoSettlement.TradeQty)/100) * power(10,Broktable.round_to)+
						broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
	
		Service_tax =  Case When Client2.Service_Chrg = 1 And  Client2.Sertaxmethod = 1 Then 0 Else
					(case  
						when ( fosettlement.SettFlag = 1 and @val_perc ='V')
						Then							
							Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
						when (fosettlement.SettFlag = 1 and @val_perc ='P')
						Then 
							((floor(( 
							(((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig +
							Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
							power(10,Broktable.round_to))) * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax) / 100) * power(10,Broktable.round_to)+
							Broktable.roFig + Broktable.errnum ) /
							(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
						when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
						Then  
							Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
						when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
						Then 
							((floor(( 
							(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig +
							Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
							power(10,Broktable.round_to))) * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+
							Broktable.roFig + Broktable.errnum ) /
							(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
						when (fosettlement.SettFlag = 3  and @val_perc ='V' )
						Then 
							Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
						when (fosettlement.SettFlag = 3  and @val_perc ='P' )
						Then 
							((floor(( 
							(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + 
							Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
							power(10,Broktable.round_to))) * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+
							Broktable.roFig + Broktable.errnum ) /
							(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
						when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
						Then  
							Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
						when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
						Then 
							((floor(( 
							(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig +
							Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
							power(10,Broktable.round_to))) * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+
							Broktable.roFig + Broktable.errnum ) /
							(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
						when ( fosettlement.SettFlag = 5  and @val_perc ='V' )
						Then   
							Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
						when ( fosettlement.SettFlag = 5  and @val_perc ='P' )
						Then  
							((floor(( 
							(((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + 
							Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
							power(10,Broktable.round_to))) * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+
							Broktable.roFig + Broktable.errnum ) /
							(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
						Else  0 
					End 
					) End,
			Trade_amount = FoSettlement.TradeQty * fosettlement.price,							
			Status = 'E'
			FROM
				fosettlement,
				BrokTable,
				FOTAXES,
				Client2,
				Client1,
				foglobals,
			      ( select ContractNo,BillNo,Trade_no,F.Party_Code,F.Inst_type,F.Symbol,F.Sec_name,F.Expirydate,F.Strike_price,F.Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,F.Series,Order_no,Price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,  
						MPrice = (CASE WHEN C2.Dummy1 = 0   
						        THEN PRICE   
						        Else  
						     (Case When C2.Dummy1 = 1   
						    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
						                  Else F.Strike_price + PRICE    
						      END)  
						   END) ,   
						MultiPlier = 1, 
						TaxPrice = (CASE WHEN TaxesFlag = 0   
						        THEN PRICE   
						        Else  
						     (Case When TaxesFlag = 1   
						    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
						                  Else F.Strike_price + PRICE    
						      END)  
						   END) ,  
						f.reserved1,f.dummy1,status  
						from FoSettlement F, Client2 C2, FOOwner  
						where c2.Party_Code = F.Party_Code   
						And F.sauda_date Like @sauda_date + '%'  
						And F.Party_Code Like @party_code  
						And F.Inst_Type Like @Inst_Type  
						And F.Symbol Like @Symbol  
						And F.ExpiryDate Like @expirydate + '%'  
						And F.Strike_Price = (Case When @Strike_Price = 0 Then F.Strike_Price Else @Strike_Price End)  
						And F.Option_Type Like @Option_Type
			       ) F /* FoSettView */ 
			WHERE 
			left(convert(varchar,fosettlement.sauda_date,109),11) = @Sauda_date and
			fosettlement.option_type = @option_type 
			and fosettlement.inst_type = @inst_Type
			AND fosettlement.SYMBOL = @symbol  
			AND left(convert(varchar,fosettlement.expirydate,109),11) = @expirydate 
			and fosettlement.strike_price = @strike_price                 
			and fosettlement.party_code = @party_code 
			and fosettlement.Trade_no Like @Trade_no
			and fosettlement.Order_no Like @Order_no 
			and fosettlement.contractno = @contractno
			and fosettlement.Sell_Buy = @Sell_Buy
			and Client2.Party_code = @party_code 
			and FOTAXES.Trans_cat = (Case When Cl_Type = 'PRO' Then 'PRO' Else Client2.Tran_cat End )
			and Client2.Cl_Code = Client1.Cl_Code
			And FOSETTLEMENT.party_code = F.party_code and
			FOSETTLEMENT.inst_type=F.inst_type and  
			FOSETTLEMENT.symbol=F.symbol and
			FOSETTLEMENT.expirydate=F.expirydate  AND
			FOSETTLEMENT.strike_price = F.strike_price and                
			FOSETTLEMENT.sec_name = F.sec_name and                        
			FOSETTLEMENT.option_type = F.option_type and                  
			FOSETTLEMENT.sauda_date = F.sauda_date AND
			FOSETTLEMENT.Trade_No = F.Trade_No AND 
			FOSETTLEMENT.Order_No = F.Order_No AND
			fosettlement.Sell_Buy = F.Sell_Buy   and
			year_start_dt <= FOSETTLEMENT.Sauda_date and
			year_end_dt >= FOSETTLEMENT.Sauda_date  and
			FOSETTLEMENT.Sauda_date >= FOTAXES.From_date and
			FOSETTLEMENT.Sauda_date <= FOTAXES.to_date 
			and Broktable.table_no = ( Select distinct table_no from Broktable Where Table_no = (Case When Left(F.Inst_Type,3) = 'FUT'  
										Then Client2.std_rate
										Else Client2.Brok2_TableNo
										End))
			and Broktable.Line_no = 1 
			And (FOTAXES.exchange = 'NCE') 
end
if @flag = 2 
begin
		Update fosettlement set
		BrokApplied = (  case  
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
			Then 
				@Brok
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
			Then 
				@Brok
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
			Then  
				((floor ( (((@Brok*F.MultiPlier /100 ) * F.MPrice)  * power(10,Broktable.round_to) + broktable.roFig + 
				broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /power(10,broktable.round_to))
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
			Then 
				((floor(( ((@Brok*F.MultiPlier /100 )* F.MPrice) * power(10,Broktable.round_to)+broktable.roFig +
				 broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
			Then 
				@Brok
			when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
			Then 
				((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
				broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when (fosettlement.SettFlag = 3  and @val_perc ='V' )
			Then 
				@Brok
			when (fosettlement.SettFlag = 3  and @val_perc ='P' )
			Then         
				((floor(( ((@Brok*F.MultiPlier/ 100) * F.MPrice) * power(10,Broktable.round_to)+broktable.roFig + 
				broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
				when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
			Then 
				@Brok
			when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
			Then 
				((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /(broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when ( fosettlement.SettFlag = 5  and @val_perc ='V' )
			Then 
				@Brok
			when ( fosettlement.SettFlag = 5  and @val_perc ='P' )
			Then 
				((floor(( ((@Brok*F.MultiPlier/100) * F.MPrice) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			Else  0 
			End 
		),

		NetRate = (  case  
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
			Then 
				fosettlement.price + @Brok
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
			Then 
				fosettlement.price - @Brok
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
			Then 
				(fosettlement.price)+ ((floor(( (((@Brok*F.MultiPlier /100 )* F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig +
				 broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
			Then 
				(fosettlement.price) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+broktable.roFig + 
				broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
			Then 
				fosettlement.price + @Brok
			when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
			Then 
				(fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when (fosettlement.SettFlag = 3  and @val_perc ='V' )
			Then 
				fosettlement.price - @Brok
			when (fosettlement.SettFlag = 3  and @val_perc ='P' )
			Then 
				(fosettlement.price) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
			Then 
				fosettlement.price + @Brok
			when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
			Then 
				(fosettlement.price) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  (broktable.RoFig + 
				broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
			when ( fosettlement.SettFlag =5  and @val_perc ='V' )
			Then 
				fosettlement.price - @Brok
			when ( fosettlement.SettFlag =5  and @val_perc ='P' )
			Then 
				(fosettlement.price) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to))
			Else  0 
			End 
		),
		Amount = 
			(  case  
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 1)
			Then 
				FoSettlement.TradeQty  * (fosettlement.price + @Brok)
			when ( fosettlement.SettFlag = 1 and @val_perc ='V' and fosettlement.Sell_Buy = 2)
			Then 
				FoSettlement.TradeQty  * (fosettlement.price - @Brok)
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 1)
			Then 
				FoSettlement.TradeQty  * ((fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100 )* F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
			when ( fosettlement.SettFlag = 1 and @val_perc ='P' and fosettlement.Sell_Buy = 2)
			Then 
				FoSettlement.TradeQty * ((fosettlement.price) -  ((floor((  ( ((@Brok*F.MultiPlier /100 )* F.MPrice))  * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
			when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
			Then 
				FoSettlement.TradeQty  * (fosettlement.price + @Brok)
			when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
			Then 
				FoSettlement.TradeQty * ( (fosettlement.price) + ((floor(( (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
			when (fosettlement.SettFlag = 3  and @val_perc ='V' )
			Then 
				FoSettlement.TradeQty  * (fosettlement.price - @Brok)
			when (fosettlement.SettFlag = 3  and @val_perc ='P' )
			Then 
				FoSettlement.TradeQty * (  (fosettlement.price) - ((floor((  (((@Brok*F.MultiPlier/ 100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))
			when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
			Then 
				FoSettlement.TradeQty  * (fosettlement.price + @Brok)
			when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
			Then 
				FoSettlement.TradeQty * ( (fosettlement.price) + ((floor(( ( (( @Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to)))			
			when ( fosettlement.SettFlag =5  and @val_perc ='V' )
			Then 
				FoSettlement.TradeQty  * (fosettlement.price - @Brok)
			when ( fosettlement.SettFlag =5  and @val_perc ='P' )
			Then 
				FoSettlement.TradeQty  * (  (fosettlement.price) -  ((floor((  (((@Brok*F.MultiPlier/100) * F.MPrice)) * power(10,Broktable.round_to)+
				broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  /  power(10,broktable.round_to)))
			Else  0 
			End 
		),
		Ins_chrg  = ((floor(( ((fotaxes.insurance_chrg * (f.Taxprice) * FoSettlement.TradeQty)/100) * power(10,Broktable.round_to)+
					broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
	

		turn_tax  =  ((floor(( ((fotaxes.turnover_tax * (((f.Taxprice) * FoSettlement.Tradeqty) * BookType)/Instrument) /100 ) * power(10,Broktable.round_to)+  
						broktable.roFig + broktable.errnum ) /    (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    power(10,broktable.round_to)),  
	
		other_chrg = ((floor(( ((fotaxes.other_chrg * (((f.Taxprice) * FoSettlement.Tradeqty) * BookType)/Instrument) /100 ) * power(10,Broktable.round_to)+  
						broktable.roFig + broktable.errnum ) /    (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /    power(10,broktable.round_to)),  	

		sebi_tax =     ((floor(( ((fotaxes.sebiturn_tax *(f.Taxprice) * FoSettlement.TradeQty)/100) * power(10,Broktable.round_to)+broktable.roFig + 
						broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),

	
		Service_tax =  Case When Client2.Service_Chrg = 1 And  Client2.Sertaxmethod = 1 Then 0 Else
				(case  
				when ( fosettlement.SettFlag = 1 and @val_perc ='V')
				Then 
					Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
				when (fosettlement.SettFlag = 1 and @val_perc ='P')
				Then 
					((floor(( 
					(((((floor((   ((@Brok*F.MultiPlier /100 ) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + 
					Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
					power(10,Broktable.round_to))) * FoSettlement.TradeQty * FOGlobals.service_tax) / 100) * power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
					(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))
				when (fosettlement.SettFlag = 2  and @val_perc ='V' ) 
				Then  
					Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
				when (fosettlement.SettFlag = 2  and @val_perc ='P' ) 
				Then 
					((floor(( 
					(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + 
					Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
					power(10,Broktable.round_to))) * FoSettlement.TradeQty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
					(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
				when (fosettlement.SettFlag = 3  and @val_perc ='V' )
				Then 
					Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
				when (fosettlement.SettFlag = 3  and @val_perc ='P' )
				Then 
					((floor(( 
					(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig + 
					Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
					power(10,Broktable.round_to))) * FoSettlement.TradeQty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
					(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
				when ( fosettlement.SettFlag = 4  and @val_perc ='V' )
				Then  
					Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
				when ( fosettlement.SettFlag = 4  and @val_perc ='P' )
				Then 
					((floor(( 
					(((((floor((( (@Brok*F.MultiPlier/100) *  F.MPrice) * power(10,broktable.round_to)+Broktable.roFig + Broktable.errnum ) / (Broktable.RoFig +
					Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
					power(10,Broktable.round_to))) * FoSettlement.TradeQty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
					(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
				when ( fosettlement.SettFlag = 5  and @val_perc ='V' )
				Then   
					Round(@Brok * FoSettlement.TradeQty * FoSettlement.BookType / FoSettlement.Instrument* FOGlobals.service_tax/100,4)
				when ( fosettlement.SettFlag = 5  and @val_perc ='P' )
				Then  
					((floor(( 
					(((((floor((( (@Brok*F.MultiPlier/100) * F.MPrice) * power(10,broktable.round_to)+Broktable.roFig +
					Broktable.errnum ) / (Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) /
					power(10,Broktable.round_to))) * FoSettlement.TradeQty * FOGlobals.service_tax) / 100)   *   power(10,Broktable.round_to)+Broktable.roFig + Broktable.errnum ) /
					(Broktable.RoFig + Broktable.Nozero )) * (Broktable.rofig +Broktable.NoZero ) ) / power(10,Broktable.round_to))    
				Else  0 
				End 
			) end,
			Trade_amount = FoSettlement.TradeQty * fosettlement.price,
			Status = 'E'
			FROM
				BrokTable,
				FOTAXES,
				Client2,
				Client1 ,
				foglobals,
			      ( select ContractNo,BillNo,Trade_no,F.Party_Code,F.Inst_type,F.Symbol,F.Sec_name,F.Expirydate,F.Strike_price,F.Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,F.Series,Order_no,Price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,  
						MPrice = (CASE WHEN C2.Dummy1 = 0   
						        THEN PRICE   
						        Else  
						     (Case When C2.Dummy1 = 1   
						    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
						                  Else F.Strike_price + PRICE    
						      END)  
						   END) ,   
						MultiPlier = 1, 
						TaxPrice = (CASE WHEN TaxesFlag = 0   
						        THEN PRICE   
						        Else  
						     (Case When TaxesFlag = 1   
						    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
						                  Else F.Strike_price + PRICE    
						      END)  
						   END) ,  
						f.reserved1,f.dummy1,status  
						from FoSettlement F, Client2 C2, FOOwner  
						where c2.Party_Code = F.Party_Code   
						And F.sauda_date Like @sauda_date + '%'  
						And F.Party_Code Like @party_code  
						And F.Inst_Type Like @Inst_Type  
						And F.Symbol Like @Symbol  
						And F.ExpiryDate Like @expirydate + '%'  
						And F.Strike_Price = (Case When @Strike_Price = 0 Then F.Strike_Price Else @Strike_Price End)  
						And F.Option_Type Like @Option_Type
			       ) F /* FoSettView */ 
			WHERE 
				left(convert(varchar,fosettlement.sauda_date,109),11) = @Sauda_date and
				fosettlement.option_type = @option_type 
				and fosettlement.inst_type = @inst_Type
				AND fosettlement.SYMBOL = @symbol  
				AND left(convert(varchar,fosettlement.expirydate,109),11) = @expirydate  
				and fosettlement.strike_price = @strike_price                 
				and fosettlement.party_code = @party_code 
				and fosettlement.Trade_no Like @Trade_no
				and fosettlement.Order_no Like @Order_no 
				and fosettlement.contractno = @contractno
				and fosettlement.price = @MarketRate 
				and Client2.Party_code = @party_code 
				and FOTAXES.Trans_cat = (Case When Cl_Type = 'PRO' Then 'PRO' Else Client2.Tran_cat End )
				and Client2.Cl_Code = Client1.Cl_Code
				and Broktable.table_no = ( Select distinct table_no from Broktable 
											Where Table_no = (Case When Left(F.Inst_Type,3) = 'FUT'  
											Then Client2.std_rate
											Else Client2.Brok2_TableNo
											End))
				and	FOSETTLEMENT.party_code = F.party_code and
				FOSETTLEMENT.inst_type=F.inst_type and  
				FOSETTLEMENT.symbol=F.symbol and
				FOSETTLEMENT.expirydate=F.expirydate  AND
				FOSETTLEMENT.strike_price = F.strike_price and                
				FOSETTLEMENT.sec_name = F.sec_name and                        
				FOSETTLEMENT.option_type = F.option_type and                  
				FOSETTLEMENT.sauda_date = F.sauda_date AND
				FOSETTLEMENT.Trade_No = F.Trade_No AND 
				FOSETTLEMENT.Order_No = F.Order_No AND
				fosettlement.Sell_Buy = F.Sell_Buy and 
				Broktable.Line_no =  1  and 
				FOTAXES.exchange = 'NCE' and
				FOSETTLEMENT.Sauda_date >= FOTAXES.From_date and
				FOSETTLEMENT.Sauda_date <= FOTAXES.to_date 
end    
else If @Flag = 3
Begin
		update fosettlement set 
		NetRate = @NetRate, N_NetRate =@NetRate,
		BrokApplied = Abs(@NetRate - F.MPrice), NBrokApp = Abs(@NetRate - F.MPrice),
		Service_Tax = Case When Client2.Service_Chrg = 1 And  Client2.Sertaxmethod = 1 Then 0 Else
			Round(FoSettlement.TradeQty*Abs(@NetRate - F.MPrice)*foGlobals.service_tax/100,BrokTable.Round_To) end, 
		NSerTax = Round(FoSettlement.TradeQty*Abs(@NetRate - F.MPrice)*foGlobals.service_tax/100,BrokTable.Round_To),
		Amount = Round(@NetRate*FoSettlement.TradeQty,BrokTable.Round_To) , Status = 'E'
		From 
			Client2,
			foGlobals,
			BrokTable,
		      ( select ContractNo,BillNo,Trade_no,F.Party_Code,F.Inst_type,F.Symbol,F.Sec_name,F.Expirydate,F.Strike_price,F.Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,F.Series,Order_no,Price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,  
					MPrice = (CASE WHEN C2.Dummy1 = 0   
					        THEN PRICE   
					        Else  
					     (Case When C2.Dummy1 = 1   
					    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
					                  Else F.Strike_price + PRICE    
					      END)  
					   END) ,   
					MultiPlier = 1, 
					TaxPrice = (CASE WHEN TaxesFlag = 0   
					        THEN PRICE   
					        Else  
					     (Case When TaxesFlag = 1   
					    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
					                  Else F.Strike_price + PRICE    
					      END)  
					   END) ,  
					f.reserved1,f.dummy1,status  
					from FoSettlement F, Client2 C2, FOOwner  
					where c2.Party_Code = F.Party_Code   
					And F.sauda_date Like @sauda_date + '%'  
					And F.Party_Code Like @party_code  
					And F.Inst_Type Like @Inst_Type  
					And F.Symbol Like @Symbol  
					And F.ExpiryDate Like @expirydate + '%'  
					And F.Strike_Price = (Case When @Strike_Price = 0 Then F.Strike_Price Else @Strike_Price End)  
					And F.Option_Type Like @Option_Type
		       ) F /* FoSettView */ 
		WHERE  
			left(convert(varchar,fosettlement.sauda_date,109),11) = @Sauda_date and
			fosettlement.option_type = @option_type 
			and fosettlement.inst_type = @inst_Type
			AND fosettlement.SYMBOL = @symbol  
			AND left(convert(varchar,fosettlement.expirydate,109),11) = @expirydate  
			and fosettlement.strike_price = @strike_price                 
			and fosettlement.party_code = @party_code 
			and fosettlement.Trade_no Like @Trade_no
			and fosettlement.Order_no Like @Order_no 
			and fosettlement.contractno = @contractno
			and client2.party_code = @party_code
			and Broktable.table_no = ( Select distinct table_no from Broktable
										Where Table_no = (Case When Left(F.Inst_Type,3) = 'FUT'  
																Then Client2.std_rate
																Else Client2.Brok2_TableNo
																End))
			and FOSETTLEMENT.party_code = F.party_code and
			FOSETTLEMENT.inst_type=F.inst_type and  
			FOSETTLEMENT.symbol=F.symbol and
			FOSETTLEMENT.expirydate=F.expirydate  AND
			FOSETTLEMENT.strike_price = F.strike_price and                
			FOSETTLEMENT.sec_name = F.sec_name and                        
			FOSETTLEMENT.option_type = F.option_type and                  
			FOSETTLEMENT.sauda_date = F.sauda_date AND
			FOSETTLEMENT.Trade_No = F.Trade_No AND 
			FOSETTLEMENT.Order_No = F.Order_No AND
			fosettlement.Sell_Buy = F.Sell_Buy   
			and fosettlement.Sell_Buy = @Sell_Buy
			and Broktable.Line_no = 1
			and year_start_dt <= FOSETTLEMENT.Sauda_date
			and year_end_dt >= FOSETTLEMENT.Sauda_date  
end  
else If @Flag =4
Begin
		update fosettlement set 
		NetRate = @NetRate, N_NetRate =@NetRate,
		BrokApplied = Abs(@NetRate - F.MPrice), NBrokApp = Abs(@NetRate - F.MPrice),
		Service_Tax = Case When Client2.Service_Chrg = 1 And  Client2.Sertaxmethod = 1 Then 0 Else
			Round(FoSettlement.TradeQty*Abs(@NetRate - F.MPrice)*foGlobals.service_tax/100,BrokTable.Round_To) end,
		NSerTax = Round(FoSettlement.TradeQty*Abs(@NetRate - F.MPrice)*foGlobals.service_tax/100,BrokTable.Round_To),
		Amount = Round(@NetRate*FoSettlement.TradeQty,BrokTable.Round_To) , Status = 'E'
		From
			Client2,
			foGlobals,
			BrokTable,
			fosettlement,
		      ( select ContractNo,BillNo,Trade_no,F.Party_Code,F.Inst_type,F.Symbol,F.Sec_name,F.Expirydate,F.Strike_price,F.Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,F.Series,Order_no,Price,Sauda_date,F.Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,F.other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,  
					MPrice = (CASE WHEN C2.Dummy1 = 0   
					        THEN PRICE   
					        Else  
					     (Case When C2.Dummy1 = 1   
					    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
					                  Else F.Strike_price + PRICE    
					      END)  
					   END) ,   
					MultiPlier = 1, 
					TaxPrice = (CASE WHEN TaxesFlag = 0   
					        THEN PRICE   
					        Else  
					     (Case When TaxesFlag = 1   
					    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )       
					                  Else F.Strike_price + PRICE    
					      END)  
					   END) ,  
					f.reserved1,f.dummy1,status  
					from FoSettlement F, Client2 C2, FOOwner  
					where c2.Party_Code = F.Party_Code   
					And F.sauda_date Like @sauda_date + '%'  
					And F.Party_Code Like @party_code  
					And F.Inst_Type Like @Inst_Type  
					And F.Symbol Like @Symbol  
					And F.ExpiryDate Like @expirydate + '%'  
					And F.Strike_Price = (Case When @Strike_Price = 0 Then F.Strike_Price Else @Strike_Price End)  
					And F.Option_Type Like @Option_Type
		       ) F /* FoSettView */ 
		WHERE 
		left(convert(varchar,fosettlement.sauda_date,109),11) = @Sauda_date and
		fosettlement.option_type = @option_type 
		and fosettlement.inst_type = @inst_Type
		AND fosettlement.SYMBOL = @symbol  
		AND left(convert(varchar,fosettlement.expirydate,109),11) = @expirydate  
		and fosettlement.strike_price = @strike_price                 
		and fosettlement.party_code = @party_code 
		and fosettlement.Trade_no Like @Trade_no
		and fosettlement.Order_no Like @Order_no 
		and fosettlement.contractno = @contractno
		and fosettlement.price = @MarketRate 
		and client2.party_code = @party_code
		and Broktable.table_no = ( Select distinct table_no from Broktable 
									Where Table_no = (Case When Left(F.Inst_Type,3) = 'FUT'  
														Then Client2.std_rate
														Else Client2.Brok2_TableNo
														End))
		and FOSETTLEMENT.party_code = F.party_code and
		FOSETTLEMENT.inst_type=F.inst_type and  
		FOSETTLEMENT.symbol=F.symbol and
		FOSETTLEMENT.expirydate=F.expirydate  AND
		FOSETTLEMENT.strike_price = F.strike_price and                
		FOSETTLEMENT.sec_name = F.sec_name and                        
		FOSETTLEMENT.option_type = F.option_type and                  
		FOSETTLEMENT.sauda_date = F.sauda_date AND
		FOSETTLEMENT.Trade_No = F.Trade_No AND 
		FOSETTLEMENT.Order_No = F.Order_No AND
		fosettlement.Sell_Buy = F.Sell_Buy   
		and fosettlement.Sell_Buy = @Sell_Buy
		and Broktable.Line_no = 1 
		and year_start_dt <= FOSETTLEMENT.Sauda_date
		and year_end_dt >= FOSETTLEMENT.Sauda_date  
end

Exec ReCalculateStampDuty @Sauda_Date, @Party_Code


if @@error = 0  
Begin
	Exec Console_Log  @party_code,'',@sauda_date,@Inst_Type,@Symbol,@ExpiryDate,@Strike_Price,@Option_Type,
	@Order_No,@Trade_No,@Sell_Buy,@ContractNo,'',@Brok,0,@MarketRate,0,@NetRate,0,0,0,0,'','',@StatusId,@strModule,'RECAL BROK'
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrd_ClientMaster
-- --------------------------------------------------

CREATE  Procedure [dbo].[FoTrd_ClientMaster]  
As 


Declare @SaudaDate Varchar(11)   
  
Set Transaction isolation level read uncommitted   
Truncate Table FoTrd_Client1   
Truncate Table FoTrd_Client2   
Truncate Table FoTrd_BrokTable  
Truncate Table FoTrd_ClientTaxes
Truncate Table FoTrd_ClientBrokScheme

Select Top 1 @SaudaDate = Left(ActivityTime,11) From FoTrade

UPDATE FOTRADE SET BookType = Numerator, BookTypeName = Denominator
FROM FOSCRIP2
WHERE FOTRADE.Inst_Type = FOSCRIP2.Inst_Type
AND FOTRADE.Symbol = FOSCRIP2.Symbol
AND FOTRADE.Expirydate= FOSCRIP2.Expirydate
AND FOTRADE.Strike_price= FOSCRIP2.Strike_price
AND FOTRADE.Option_type = FOSCRIP2.Option_type

Select Distinct Party_Code Into #Trade From FoTrade  
  
Insert Into FoTrd_Client2    
Select 
	Cl_Code,Exchange,Tran_Cat,Scrip_cat,Party_code,Table_no,Sub_TableNo,Margin,
	Turnover_tax,Sebi_Turn_tax,Insurance_Chrg,Service_chrg,Std_rate,P_To_P,
	exposure_lim,demat_tableno,BankId,CltDpNo,Printf,ALBMDelchrg,ALBMDelivery,
	AlbmCF_tableno,MF_tableno,SB_tableno,brok1_tableno,brok2_tableno,brok3_tableno,
	BrokerNote,Other_chrg,brok_scheme,Contcharge,MinContAmt,AddLedgerBal,Dummy1,Dummy2,
	InsCont,SerTaxMethod,Dummy6,Dummy7,Dummy8,Dummy9,Dummy10
From Client2 C2 with(nolock)  
Where C2.Party_Code In ( Select Party_code From #Trade)  
  
Insert into FoTrd_Client1    
Select * From Client1 C1 with(nolock) Where Cl_Code In (Select Cl_Code From FoTrd_Client2 C2)    
  

Insert Into FoTrd_ClientBrokScheme
Select  Party_Code,Date_From,Date_To,Fut_BrokTable,Opt_BrokTable,Fut_Exp_BrokTable,
	Opt_Exc_BrokTable,Comm_Del_BrokTable,Brok_Scheme,Opt_Brok_ComputeOn
From 
	FoClientBrokScheme
Where
	@SaudaDate Between Date_From and Date_To
	And Party_Code In ( Select Party_code From #Trade)  


Insert Into FoTrd_BrokTable  
Select * From Broktable where table_no In ( Select Distinct Fut_BrokTable From FoTrd_ClientBrokScheme )  
  
Insert Into FoTrd_BrokTable  
Select * From Broktable where Table_No In ( Select Distinct Opt_BrokTable From FoTrd_ClientBrokScheme )   
And Table_No Not In (Select Distinct Fut_BrokTable From FoTrd_ClientBrokScheme)  
  

Insert Into FoTrd_ClientTaxes
Select 	
	Party_Code,Date_From,Date_To,Fut_Insurance_Chrg,Fut_Turnover_Tax,Fut_Other_Chrg,
	Fut_Sebiturn_Tax,Fut_Broker_Note,Opt_Insurance_Chrg,Opt_Turnover_Tax,Opt_Other_Chrg,
	Opt_Sebiturn_Tax,Opt_Broker_Note,Round_To,RoFig,ErrNum,NoZero
From
	FoClientTaxes
Where
	@SaudaDate Between Date_From and Date_To
	And Party_Code In ( Select Party_code From #Trade)  

UPDATE
	FOTRADE
SET
	RESERVED3 = 
	CASE 
		WHEN BROK_SCHEME IN (1,5,21,25) THEN
			CASE 
                            WHEN ((S.PQTY >= S.SQTY)
                                  AND SETTFLAG IN (1,2,3,4,
                                                   5)) THEN (CASE 
                                                               WHEN (FoTrade.SELL_BUY = 1) THEN 'F'
                                                               ELSE 'S'
                                                             END)
                            WHEN SETTFLAG IN (6,7) THEN 'S'
                            WHEN SETTFLAG IN (8,9) THEN 'F'
                            WHEN ((S.PQTY < S.SQTY)
                                  AND SETTFLAG IN (1,2,3,4,
                                                   5)) THEN (CASE 
                                                               WHEN (FoTrade.SELL_BUY = 2) THEN 'F'
                                                               ELSE 'S'
                                                             END)
                            WHEN SETTFLAG IN (6,7) THEN 'S'
                            WHEN SETTFLAG IN (8,9) THEN 'F'
                            WHEN SETTFLAG = 0 THEN 'F'
                          END
		WHEN BROK_SCHEME = 2 THEN 
			CASE 
	                         WHEN S.PQTY = S.SQTY THEN (CASE 
	                                                      WHEN S.PRATE > = S.SRATE THEN (CASE 
	                                                                                       WHEN FoTrade.SELL_BUY = 1 THEN 'F'
	                                                                                       ELSE 'S'
	                      END)
	                                                      ELSE (CASE 
	                                                              WHEN (FoTrade.SELL_BUY = 2) THEN 'F'
	                                                              ELSE 'S'
	                                                            END)
	                                                    END)
	                         ELSE (CASE 
	                                 WHEN S.PQTY > = S.SQTY THEN (CASE 
	                                                                WHEN (FoTrade.SELL_BUY = 1) THEN 'F'
	                                                                ELSE 'S'
	                                                              END)
	                                 ELSE (CASE 
	                                         WHEN (FoTrade.SELL_BUY = 2) THEN 'F'
	                                         ELSE 'S'
	                                       END)
	                               END)
	                       END
		WHEN BROK_SCHEME IN (3,6,23,26) THEN
			CASE 
                                    WHEN ((S.PQTY > S.SQTY)
                                          AND SETTFLAG IN (1,2,3,4,
                                                           5)) THEN (CASE 
                                                                       WHEN (FoTrade.SELL_BUY = 1) THEN 'F'
                                                                       ELSE 'S'
                                                                     END)
                                    WHEN SETTFLAG IN (6,7) THEN 'S'
                                    WHEN SETTFLAG IN (8,9) THEN 'F'
                                    WHEN ((S.PQTY <= S.SQTY)
                                          AND SETTFLAG IN (1,2,3,4,
                                                           5)) THEN (CASE 
                                                                       WHEN (FoTrade.SELL_BUY = 2) THEN 'F'
                                                                       ELSE 'S'
                                                                     END)
                                    WHEN SETTFLAG IN (6,7) THEN 'S'
                                    WHEN SETTFLAG IN (8,9) THEN 'F'
                                    WHEN SETTFLAG = 0 THEN 'F'
                                  END
		ELSE
			'T'
		END
FROM
	(
	Select 
		party_code,inst_type,symbol,
		expirydate,strike_price ,option_type,  
		pqty = isnull(Sum(Case When Sell_Buy = 1 Then tradeqty Else 0 End),0),  
		sqty = isnull(Sum(Case When Sell_Buy = 2 Then tradeqty Else 0 End),0),
		PRate = (Case When isnull(Sum(Case When Sell_Buy = 1 Then tradeqty Else 0 End),0) > 0   
			      Then IsNull(Sum(Case When Sell_Buy = 1 Then TradeQty*Price Else 0 End),0) /   
			           isnull(Sum(Case When Sell_Buy = 1 Then tradeqty Else 0 End),0)  
			      Else 0   
			 End),  
		SRate = (Case When isnull(Sum(Case When Sell_Buy = 2 Then tradeqty Else 0 End),0) > 0   
			      Then IsNull(Sum(Case When Sell_Buy = 2 Then TradeQty*Price Else 0 End),0) /   
		                   isnull(Sum(Case When Sell_Buy = 2 Then tradeqty Else 0 End),0)  
		              Else 0   
		         End)
	From
		FoTrade 
	GROUP BY 
		party_code,inst_type,symbol,expirydate,
		strike_price  ,option_type
	) S,
	FoTrd_ClientTaxes FoClientTaxes,
	FoTrd_ClientBrokScheme FoClientBrokScheme
Where 	
	FoTrade.party_code = FoClientTaxes.Party_Code and 
	FoTrade.ActivityTime between FoClientTaxes.Date_From and FoClientTaxes.Date_To and
	FoTrade.party_code = FoClientBrokScheme.Party_Code and 
	FoTrade.ActivityTime between FoClientBrokScheme.Date_From and FoClientBrokScheme.Date_To and
	FoTrade.party_code = s.party_code and
	FoTrade.inst_type=S.inst_type and  
	FoTrade.symbol=S.symbol and
	FoTrade.expirydate=S.expirydate AND
	FoTrade.strike_price = s.strike_price and                 
	FoTrade.option_type = s.option_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrd_ScripMaster
-- --------------------------------------------------
CREATE  Proc FoTrd_ScripMaster As    
Set NoCount On   
  
Select Distinct Inst_Type,Symbol,ExpiryDate,Option_Type,Strike_Price  
Into #Trade from FoTrade  
  
Truncate table FoTrd_FoScrip1  
Truncate table FoTrd_FoScrip2    
  
Insert Into FoTrd_FoScrip2    
Select T.Inst_Type,T.Symbol,Sec_Name,T.Expirydate,T.Strike_price,T.Option_type,Startdate,Maturitydate,Series,Cor_Act_Level,  
C_Regular_Lot,C_Issue_Mat_Dt,C_U_Inst_type,C_U_Symbol,C_U_Series,C_U_Expirydate,C_U_StrikePrice,C_U_Option_type,C_U_CAL  
 From FoScrip2 S2, (Select Inst_Type,Symbol,ExpiryDate,Option_Type,Strike_Price From #Trade ) T    
Where S2.Inst_Type=T.Inst_Type and S2.Symbol=T.Symbol and S2.ExpiryDate=T.ExpiryDate and   
S2.Option_Type=T.Option_Type and S2.Strike_Price=T.Strike_Price  
    
Insert into FoTrd_FoScrip1    
Select distinct Inst_Type,Symbol,Expirydate,Strike_Price,Option_type From FoTrd_FoScrip2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrdContract
-- --------------------------------------------------





CREATE  PROCEDURE FoTrdContract

AS 
 Declare 
 @@FoSettLoop As Cursor,
 @@Trade_no varchar(14),
 @@TodayQty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),

 @@Tdate As varchar(11), 
/* T Prefix stands for Today and P stands for Previous */

 @@TPosCur cursor,
 @@TParty_code Varchar(20),
 @@TNetqty numeric(9),
 @@TInst_Type Varchar(20), 
 @@TSymbol Varchar(20),
 @@TEXPIRYDATE Datetime,
 @@TStrike_Price Money,
 @@TOption_type Varchar(20),

 
 @@PPosCur Cursor,
 @@PParty_code Varchar(20),
 @@PNetQty Numeric(9),
 @@PInst_Type Varchar(20), 
 @@PSymbol Varchar(20),
 @@PEXPIRYDATE Datetime,
 @@PStrike_Price Money,
 @@POption_type Varchar(20),

 @@DiffQty  Numeric(9)


Update foTrade Set settflag = '1' from foTrade,client2 where 
foTrade.party_code = Client2.Party_code And Client2.Tran_Cat = 'DEL' 

Update foTrade Set settflag = '2' from foTrade,client2 where 
foTrade.party_code = Client2.Party_code And  sell_buy = 1 And Client2.Tran_Cat = 'TRD' 


Update foTrade  set settflag = '3' from foTrade , client2 where 
foTrade.party_code = Client2.Party_code And   Client2.Tran_Cat = 'TRD'  and sell_buy = 2 





Set @@TPosCur = cursor for


Select TrdVw.Party_Code, TrdVw.Inst_Type, TrdVw.Symbol, TrdVw.EXPIRYDATE,
		NetQty = sum(TrdVw.Pqty - TrdVw.Sqty),  /* sell_buy = (case when sum(Pqty - Sqty) < 0 Then '2' Else '1' End),   Pqty,Sqty, */ 
		TrdVw.strike_price,TrdVw.option_type  
From 
	FoTrdImpBfView TrdVw
Join
	(
		Select distinct x.party_Code 
		from 
		(
			select distinct CLIENT2.PARTY_CODE, CLIENT2.brok1_tableno from client2, FOTRADE 
			WHERE FOTRADE.pARty_CODE = CLIENT2.PARTY_CODE
		) x
		join
		BrokTable b
		on (b.table_no = x.brok1_tableno)
		where 
		(
			Day_Puc <> 0 or
			Day_Sales <> 0 or
			Sett_purch <> 0 or
			Sett_sales <> 0
		)
	) PCodes
on 
	(TrdVw.Party_Code = PCodes.Party_Code)
Group by TrdVw.Party_Code, TrdVw.Inst_Type, TrdVw.Symbol, TrdVw.EXPIRYDATE, TrdVw.Strike_Price, TrdVw.Option_Type
Order by TrdVw.Party_code ,TrdVw.Inst_type, TrdVw.Symbol 


Open @@TPosCur
Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type

If @@fetch_status = 0   
Begin
     While @@fetch_status = 0 
     Begin
          Print @@TParty_code + '    ' +@@TInst_Type +'   '+ @@TSymbol  + '    ' +  @@TOption_type  +  '   ' + Convert(Varchar, @@TStrike_Price) +  '      ' + Convert(Varchar,@@TExpirydate,109) +'   ' + convert(varchar,@@TNetQty) + ' Todays Position  '

           If (@@TNetQty  = 0 )   
           Begin

                Update foTrade set settflag = '2' 
                where
                party_code = @@TParty_code  
                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                And Expirydate = @@TExpiryDate
                And Strike_Price = @@TStrike_price 
                And Option_type = @@TOption_type
                And Sell_buy = 1

 
                Update foTrade set settflag = '3' 
                where
                     party_code = @@TParty_code 
                     And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                     And Expirydate = @@TExpiryDate
                     And Strike_Price = @@TStrike_price 
                     And Option_type = @@TOption_type
                     And Sell_buy = 2
           End 

           If (@@TNetqty < 0 )  
           Begin
                Exec FOTrdIMPflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@@TNetQty,'S'
           End
           If (@@TNetqty > 0 )  
           Begin
                Exec FOTrdIMPflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@@TNetQty,'B'
           End 
           Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type
     End
       
End

Close @@TPosCur

Deallocate @@TPosCur

set @@Tdate = (select Left(convert(Varchar,Max(ActivityTime)),11) from FoTrade)

Declare @@Count int

set transaction isolation level read uncommitted
Select @@Count = count(1) from FoTrade (nolock), Client2 (nolock)
where FoTrade.party_code = client2.party_code
and Client2.brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30')  

if @@Count > 0
begin 
	Exec FOTrdSettOffflag @@Tdate   
End

EXEC FOTrd_Clientmaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrdContract_New
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.FoTrdContract_New    Script Date: 1/17/2004 11:42:38 PM ******/






/* JAN 18 2002  12:10 p.m.   */

/* Drop Procedure FoTrdContract_New */

CREATE  PROCEDURE FoTrdContract_New

AS 
 Declare 
 @@FoSettLoop As Cursor,
 @@Trade_no varchar(14),
 @@TodayQty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),

 @@Tdate As varchar(11), 
/* T Prefix stands for Today and P stands for Previous */

 @@TPosCur cursor,
 @@TParty_code Varchar(20),
 @@TNetqty numeric(9),
 @@TInst_Type Varchar(20), 
 @@TSymbol Varchar(20),
 @@TEXPIRYDATE Datetime,
 @@TStrike_Price Money,
 @@TOption_type Varchar(20),

 
 @@PPosCur Cursor,
 @@PParty_code Varchar(20),
 @@PNetQty Numeric(9),
 @@PInst_Type Varchar(20), 
 @@PSymbol Varchar(20),
 @@PEXPIRYDATE Datetime,
 @@PStrike_Price Money,
 @@POption_type Varchar(20),

 @@DiffQty  Numeric(9)


Update foTrade Set settflag = '1' from foTrade,client2 where 
foTrade.party_code = Client2.Party_code And Client2.Tran_Cat = 'DEL' 

Update foTrade Set settflag = '2' from foTrade,client2 where 
foTrade.party_code = Client2.Party_code And  sell_buy = 1 And Client2.Tran_Cat = 'TRD' 


Update foTrade  set settflag = '3' from foTrade , client2 where 
foTrade.party_code = Client2.Party_code And   Client2.Tran_Cat = 'TRD'  and sell_buy = 2 





Set @@TPosCur = cursor for


Select TrdVw.Party_Code, TrdVw.Inst_Type, TrdVw.Symbol, TrdVw.EXPIRYDATE,
		NetQty = sum(TrdVw.Pqty - TrdVw.Sqty),  /* sell_buy = (case when sum(Pqty - Sqty) < 0 Then '2' Else '1' End),   Pqty,Sqty, */ 
		TrdVw.strike_price,TrdVw.option_type  
From 
	FoTrdImpBfView TrdVw
Join
	(
		Select distinct x.party_Code 
		from 
		(
			select distinct CLIENT2.PARTY_CODE, CLIENT2.brok1_tableno from client2, FOTRADE 
			WHERE FOTRADE.pARty_CODE = CLIENT2.PARTY_CODE
		) x
		join
		BrokTable b
		on (b.table_no = x.brok1_tableno)
		where 
		(
			Day_Puc <> 0 or
			Day_Sales <> 0 or
			Sett_purch <> 0 or
			Sett_sales <> 0
		)
	) PCodes
on 
	(TrdVw.Party_Code = PCodes.Party_Code)
Group by TrdVw.Party_Code, TrdVw.Inst_Type, TrdVw.Symbol, TrdVw.EXPIRYDATE, TrdVw.Strike_Price, TrdVw.Option_Type
Order by TrdVw.Party_code ,TrdVw.Inst_type, TrdVw.Symbol 

/*
Select Party_Code, Inst_Type, Symbol,EXPIRYDATE,NetQty = sum(Pqty - Sqty),  /* sell_buy = (case when sum(Pqty - Sqty) < 0 Then '2' Else '1' End),   Pqty,Sqty, */ strike_price,option_type  
From FoTrdImpBfView 
Group by Party_Code, Inst_Type, Symbol,EXPIRYDATE,Strike_Price,Option_Type
Order by Party_code ,Inst_type,Symbol 
*/
Open @@TPosCur
Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type

If @@fetch_status = 0   
Begin
     While @@fetch_status = 0 
     Begin
          Print @@TParty_code + '    ' +@@TInst_Type +'   '+ @@TSymbol  + '    ' +  @@TOption_type  +  '   ' + Convert(Varchar, @@TStrike_Price) +  '      ' + Convert(Varchar,@@TExpirydate,109) +'   ' + convert(varchar,@@TNetQty) + ' Todays Position  '

           If (@@TNetQty  = 0 )   
           Begin
                Print ' Both Are Equal and Opposite' 
                Print ' Update Fosettlement Set Settflag = 2 '

                Update foTrade set settflag = '2' 
                where
                party_code = @@TParty_code  
                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                And Expirydate = @@TExpiryDate
                And Strike_Price = @@TStrike_price 
                And Option_type = @@TOption_type
                And Sell_buy = 1

                Print ' Update Fosettlement Set Settflag = 3 ' 
 
                Update foTrade set settflag = '3' 
                where
                     party_code = @@TParty_code 
                     And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                     And Expirydate = @@TExpiryDate
                     And Strike_Price = @@TStrike_price 
                     And Option_type = @@TOption_type
                     And Sell_buy = 2
           End 

           If (@@TNetqty < 0 )  
           Begin
                Exec FOTrdIMPflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@@TNetQty,'S'
           End
           If (@@TNetqty > 0 )  
           Begin
                Exec FOTrdIMPflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@@TNetQty,'B'
           End 
           Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type
     End
       
End

Close @@TPosCur

Deallocate @@TPosCur

set @@Tdate = (select Left(convert(Varchar,Max(ActivityTime)),11) from FoTrade)

Declare @@Count int

set transaction isolation level read uncommitted
Select @@Count = count(1) from FoTrade (nolock), Client2 (nolock)
where FoTrade.party_code = client2.party_code
and Client2.brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30')  

if @@Count > 0
begin 
	Exec FOTrdSettOffflag @@Tdate   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTrdImpflagArrange
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.FOTrdImpflagArrange    Script Date: 1/17/2004 11:42:37 PM ******/






CREATE  PROCEDURE FOTrdImpflagArrange 
@Party_code Varchar(10),
@option_type varchar(2),
@inst_type varchar(6),
@symbol varchar(12),
@expirydate varchar(11),
@strike_price money,
@Diffqty numeric(9),
@Sell_buy Char(2)

AS 
Declare 
 @@Trade_no varchar(14),
 @@Pqty numeric(9), 
 @@Sqty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),
 @@Flag cursor,
 @@Loop cursor

 
 Print @Sell_buy

 If @Sell_buy = 'B' 
 Begin 
      Print   ' In Procedure sell_buy =  B ' 
      Select @@pdiff = Abs(@Diffqty)

      Print convert(varchar(20),@@Pdiff)

      Set @@Loop  = cursor for 
      Select trade_no,tradeqty from FOTrade 
      Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
      and sell_buy = 1 
      
      Order by tradeqty Desc
      Open @@loop
      Fetch next from @@Loop into @@Ltrade_no,@@Lqty     
     


      While @@pdiff > 0       
      Begin
           Print ' In PDiff > 0 ' 
           If @@pdiff >= @@Lqty  
           Begin
                Update FoTrade set settflag = 4   
                Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price  
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  
                Select @@pdiff = @@Pdiff - @@Lqty
                Print '@@PDiff = @@Pdiff - @@LQty ' + Convert(varchar(11),@@Pdiff)  
           End    
           Else If @@pdiff < @@Lqty 
           Begin
                insert into FoTrade select 'T' + Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,
                Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,
                ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,4,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5 

                 from FOTrade where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                 and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price    
                 and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty    
 
                update FOTrade set settflag = 2,Tradeqty = @@Lqty - @@pdiff    
                where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price  
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty 
                select @@Pdiff = 0   
             End 
             Fetch next from @@Loop into @@Ltrade_no,@@Lqty
        End
        Close @@Loop
  End
      Else 
      Begin 
            Print   ' In Procedure sell_buy =  S ' 
           Select @@pdiff = Abs(@Diffqty)
           Set @@Loop  = cursor for 
           Select trade_no,tradeqty from FOTrade 
           Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
           and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
           and sell_buy = 2 
           /* and Settflag in (5,9) */
           Order by tradeqty Desc
           Open @@loop
           Fetch next from @@Loop into @@Ltrade_no,@@Lqty     
           While @@pdiff > 0       
           Begin
                Print ' In S '
                if @@pdiff >= @@Lqty  
                Begin
                     update FoTrade set settflag = 5   
                     where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                     and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price   
                     and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  
                     select @@pdiff = @@Pdiff - @@Lqty
                End    
                Else if @@pdiff < @@Lqty 
                Begin
                     insert into FoTrade select 'T' + Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,
                     Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,
                      ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,5,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5  
                      from FOTrade where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
                      and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty    
 
                      update FOTrade set settflag = 3,Tradeqty = @@Lqty - @@pdiff    
                      where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol
                      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price 
                      and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty 
                      select @@Pdiff = 0   
                 End 
                 Fetch next from @@Loop into @@Ltrade_no,@@Lqty
           End
           Close @@Loop
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.foTrdMisScrip
-- --------------------------------------------------
CREATE proc foTrdMisScrip as 
Select Distinct inst_type,symbol,expirydate,option_type,strike_price,sec_name 
from fotrade where expirydate not in ( select expirydate from foScrip2 where 
foscrip2.inst_type=fotrade.inst_type and
foscrip2.symbol=fotrade.symbol and
foscrip2.expirydate=fotrade.expirydate and
foscrip2.option_type = fotrade.option_type and
foscrip2.strike_price=fotrade.strike_price)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.fotrdselall
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 1/17/2004 11:42:42 PM ******/








/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 09/10/2001 6:27:20 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 09/07/2001 10:36:06 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 9/7/01 5:07:22 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 9/7/2001 4:10:05 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 08/10/2001 4:53:41 PM ******/


/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 8/7/01 4:29:06 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 7/25/01 10:05:59 PM ******/



/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 6/30/01 11:51:36 AM ******/



/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 5/26/01 4:17:01 PM ******/


/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 3/17/01 9:55:52 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 3/21/01 12:50:08 PM ******/

/****** Object:  Stored Procedure dbo.fotrdselall    Script Date: 20-Mar-01 11:38:50 PM ******/


/*Final sql - 07 feb 2001 */
/*Ranjeet Choudhary*/
/*used in nsefo segment*/


CREATE  proc fotrdselall as
select * from fotrade

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FotrdSelSm
-- --------------------------------------------------
CREATE proc FotrdSelSm as  
SELECT inst_type,symbol,expirydate,option_type,strike_price,User_Id,  
       Party_Code From foTrade where fotrade.party_code   
         not in (select distinct party_code from client2)  
         or fotrade.expirydate not in (select expirydate from foscrip2  
                                       where foscrip2.inst_type=fotrade.inst_type and  
                                       foscrip2.symbol=fotrade.symbol  and   
                                       foscrip2.option_type = fotrade.option_type and  
                                       foscrip2.strike_price = fotrade.strike_price and  
                                       foscrip2.expirydate = fotrade.expirydate  
                                        )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrdSelTrdqtyConfirm
-- --------------------------------------------------



CREATE  PROC FoTrdSelTrdqtyConfirm as
Select ISNULL(sum(tradeqty),0),ISNULL(sum(tradeqty*price),0),Count(1) from foconfirmview

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrdSelTrdqtyTrade
-- --------------------------------------------------
CREATE PROC FoTrdSelTrdqtyTrade as
Select ISNULL(sum(tradeqty),0),ISNULL(sum(tradeqty*price),0),Count(1) from fotrade

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTrdSettflagArrange
-- --------------------------------------------------
CREATE PROCEDURE FOTrdSettflagArrange   
@Party_code Varchar(10),  
@option_type varchar(2),  
@inst_type varchar(6),  
@symbol varchar(12),  
@expirydate varchar(11),  
@strike_price money,  
@Tdate varchar(11),  
@Diffqty numeric(9),  
@Sell_buy Char(2)  
  
AS   
Declare   
 @@Trade_no varchar(14),  
 @@Pqty numeric(9),   
 @@Sqty numeric(9),  
 @@Ltrade_no varchar(14),  
 @@Lqty numeric(9),   
 @@Pdiff numeric(9),  
 @@Flag cursor,  
 @@Loop cursor  
  
   
 Print @Sell_buy  
  
 If @Sell_buy = 'B'   
 Begin   
      Print   ' In Procedure sell_buy =  B '   
      Select @@pdiff = Abs(@Diffqty)  
      Print convert(varchar(20),@@Pdiff)  
      Set @@Loop  = cursor for   
      Select trade_no,tradeqty from FOTrade   
      Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price   
      and sell_buy = 1   
      and Settflag in (4,8)    
      Order by tradeqty Desc  
      Open @@loop  
      Fetch next from @@Loop into @@Ltrade_no,@@Lqty       
       
      While @@pdiff > 0         
      Begin  
           If @@pdiff >= @@Lqty    
           Begin  
                Update FoTrade set settflag = 6     
                Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price     
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (4,8)  
                Select @@pdiff = @@Pdiff - @@Lqty  
                Print '@@PDiff = @@Pdiff - @@LQty ' + Convert(varchar(11),@@Pdiff)    
           End      
           Else If @@pdiff < @@Lqty   
           Begin  
                insert into FoTrade select 'T' + Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,  
                Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,  
                ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,6,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5   
                  
                from FOTrade where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price     
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty      
   
                update FOTrade set settflag = 8,Tradeqty = @@Lqty - @@pdiff      
                where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price   
                and sell_buy = 1 and trade_no = @@ltrade_no and tradeqty = @@lqty
                select @@Pdiff = 0     
             End   
             Fetch next from @@Loop into @@Ltrade_no,@@Lqty  
        End  
        Close @@Loop  
  End  
      Else   
      Begin   
           Print   ' In Procedure sell_buy =  S '   
           Select @@pdiff = Abs(@Diffqty)  
           Set @@Loop  = cursor for   
           Select trade_no,tradeqty from FOTrade   
           Where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
           and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price   
           and sell_buy = 2   
         and Settflag in (5,9)   
           Order by tradeqty Desc  
           Open @@loop  
           Fetch next from @@Loop into @@Ltrade_no,@@Lqty       
           While @@pdiff > 0         
           Begin  
                if @@pdiff >= @@Lqty    
                Begin  
       update FoTrade set settflag = 7     
                     where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                     and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price   
                     and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty  and Settflag in (4,8)  
       select @@pdiff,@@lqty,'UPPILI'  
                     select @@pdiff = @@Pdiff - @@Lqty  
                End      
                Else if @@pdiff < @@Lqty   
                Begin  
                     insert into FoTrade select 'T'+Trade_no,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,  
                     Sec_name,BookType,BookTypeName,MarKetType, User_id,Branch_Id,Sell_buy,@@Pdiff,Price,Pro_cli,Party_code,  
                     ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,7,membercode,tmpartycode,reserved1,reserved2,reserved3,reserved4,reserved5   
                     from FOTrade where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                     and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price     
                     and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty      
   
                      update FOTrade set settflag = 9,Tradeqty = @@Lqty - @@pdiff     
                      where party_code = @party_code and option_type = @option_type and inst_type = @inst_type and symbol = @symbol  
                      and left(convert(varchar,expirydate,109),11) = @expirydate and strike_price = @strike_price    
                      and sell_buy = 2 and trade_no = @@ltrade_no and tradeqty = @@lqty   
    select @@pdiff,@@lqty,'UPPILIKRISHNAN'  
                      select @@Pdiff = 0     
         
                 End   
                 Fetch next from @@Loop into @@Ltrade_no,@@Lqty  
           End  
           Close @@Loop  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTrdSettOffflag
-- --------------------------------------------------
CREATE  PROCEDURE FOTrdSettOffflag 
@TDate Varchar(11)
AS 
 Declare 
 @@FoSettLoop As Cursor,
 @@Trade_no varchar(14),
 @@TodayQty numeric(9),
 @@Ltrade_no varchar(14),
 @@Lqty numeric(9), 
 @@Pdiff numeric(9),

/* T Prefix stands for Today and P stands for Previous */

 @@TPosCur cursor,
 @@TParty_code Varchar(20),
 @@TNetqty numeric(9),
 @@TInst_Type Varchar(20), 
 @@TSymbol Varchar(20),
 @@TEXPIRYDATE VARCHAR(11),
 @@TStrike_Price Money,
 @@TOption_type Varchar(20),

 
 @@PPosCur Cursor,
 @@PParty_code Varchar(20),
 @@PNetQty Numeric(9),
 @@PInst_Type Varchar(20), 
 @@PSymbol Varchar(20),
 @@PEXPIRYDATE Datetime,
 @@PStrike_Price Money,
 @@POption_type Varchar(20),
 @@DiffQty  Numeric(9)

Update foTrade Set settflag = '8' from foTrade,client2 
Where foTrade.party_code = Client2.Party_code And Client2.brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30')  
and sell_buy = 1 and settflag = '4'

Update foTrade  set settflag = '9' from foTrade , client2 
Where foTrade.party_code = Client2.Party_code And Client2.brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30') 
and sell_buy = 2 and settflag = '5'



Set @@TPosCur = cursor for


Select Party_Code, Inst_Type, Symbol,EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),NetQty = sum(Pqty - Sqty),  /* sell_buy = (case when sum(Pqty - Sqty) < 0 Then '2' Else '1' End),   Pqty,Sqty, */ strike_price,option_type  
From Fotrdsettbfview where expirydate >= @Tdate + ' 23:59:00'
And Settflag in(8,9) 
Group by Party_Code, Inst_Type, Symbol,EXPIRYDATE,Strike_Price,Option_Type
Order by Party_code ,Inst_type,Symbol 

Open @@TPosCur
Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type

If @@fetch_status = 0   
Begin
     While @@fetch_status = 0 
     Begin
          Print @@TParty_code + '    ' +@@TInst_Type +'   '+ @@TSymbol  + '    ' +  @@TOption_type  +  '   ' + Convert(Varchar, @@TStrike_Price) +  '      ' + @@TExpirydate +'   ' + convert(varchar,@@TNetQty) + ' Todays Position  '


          Set @@PPosCur = Cursor For
 
          Select Party_Code, NetQty = (sum(Pqty - Sqty)),Inst_Type, Symbol,EXPIRYDATE, strike_price,option_type   
          From BBGFoSettbfView where  
          expirydate >= @Tdate +  ' 23:59:59'
          And party_code = @@TParty_code and sauda_date < Convert(Smalldatetime,@Tdate + ' 00:00:00') and expirydate >= @Tdate + ' 23:59:59'
          And Inst_type = @@TInst_type And Symbol = @@TSymbol And Expirydate LIKE @@TExpiryDate +'%'
          And Strike_Price = @@TStrike_price And Option_type = @@TOption_type
          Group by Party_Code, Inst_Type, Symbol,EXPIRYDATE,strike_price,option_type
    
          Open @@PPosCur
          Fetch Next From @@PPosCur into @@PParty_code, @@PNetQty,@@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type                
   
          If @@Fetch_Status = 0
          While @@fetch_status = 0 
                Begin
                     Print @@PParty_code + '   ' + @@PInst_Type +'   ' + @@PSymbol  +'    ' + @@POption_type +  '   '  +  Convert(Varchar, @@TStrike_Price) +  '      ' +LEFT(Convert(Varchar,@@PExpirydate,109),11) + '   ' + convert(varchar,@@PNetQty) + ' 



 
Previous Position  '
                     
                     If  Abs(@@PNetQty) <  Abs(@@TNetqty)
                     Begin
                          select @@Diffqty = Abs(@@PNetQty)
                     End
                     If  Abs(@@PNetQty) >  Abs(@@TNetqty)
                     Begin
                          select @@Diffqty = Abs(@@TNetQty)
                     End
 
                     If ((@@PNetQty + @@TNetQty ) = 0 )   
                     Begin
                   Print ' Both Are Equal and Opposite' 
                           If @@TNetqty > 0 
             Begin
           Print ' Update FoTrade Set Settflag = 6 '
                                Update foTrade set settflag = '6' 
                                where
                                expirydate >= @Tdate +  ' 23:59:59'
                                And party_code = @@TParty_code  and expirydate >= @Tdate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate LIKE @@TExpiryDate +'%'
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(8)
                           End 
                           
                           If @@TNetQty < 0 
                           Begin
                                Print ' Update Fosettlement Set Settflag = 7 '  
                                Update foTrade set settflag = '7' 
                                where
                                expirydate >= @Tdate +  ' 23:59:59'
                                And party_code = @@TParty_code and expirydate >= @Tdate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate LIKE @@TExpiryDate +'%'
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(9)
                           End
                     End 


                     /* If Position till Yesterday and Position for Today are + Then */ 
                     If ( (@@PNetQty >= 0 ) And (@@TNetQty > 0))   
                     Begin
                          Print 'Update FoTrade Set Settflag = 8 ' /* Cause both the positions are of same side */
                          Update foTrade set settflag = '8' 
                          Where
                                expirydate >= @Tdate +  ' 23:59:59'
                                And party_code = @@TParty_code and expirydate >= @Tdate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate LIKE @@TExpiryDate +'%'
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(8)
                     End 

                     /* If Position till Yesterday and Position for Today are - Then */
                     If ( (@@PNetQty <= 0 ) And (@@TNetQty < 0))   
                     Begin
                         Print 'Update FoTrade Set Settflag = 9'
          Update foTrade set settflag = '9' 
                         Where
                                expirydate >= @Tdate +  ' 23:59:59'
                                And party_code = @@TParty_code and expirydate >= @Tdate + ' 23:59:59'
                                And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                And Expirydate LIKE @@TExpiryDate +'%'
                                And Strike_Price = @@TStrike_price 
                                And Option_type = @@TOption_type
                                And SettFlag in(9)
                     End   

                     /* Now we will take the case where Cumulative Position till yesterday is + and Todays is Negative */  
                     If ( (@@PNetQty > 0 ) And (@@TNetQty < 0))   
                     Begin
                          /* If Position till Yesterday is greater than Absolute of Today or Equal then the SettSettoff will apply */  
                          If (@@PNetQty) >= Abs(@@TNetqty)
                          Begin 
                    Print ' Update FoTrade Settflag = 7 '
  Update foTrade set settflag = '7' 
                  Where
                                     expirydate >= @Tdate +  ' 23:59:59'
                                     And party_code = @@TParty_code and expirydate >= @Tdate + ' 23:59:59'
                                     And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                     And Expirydate LIKE @@TExpiryDate +'%'
                                     And Strike_Price = @@TStrike_price 
                                     And Option_type = @@TOption_type
                                     And SettFlag in(9)

                           End
                          /* If Position till Yesterday is greater than Absolute of Today then We
                             Will Split The trade Which are sell side  or sett_flag = 5  */   

                          If ((@@PNetQty) < Abs(@@TNetqty)) 
                          Begin
                               Exec FOTrdSettflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@Tdate,@@DiffQty,'S'
                          End
/*
                          If Abs(@@Diffqty) = Abs(@@TNetqty) 
                          Begin
                               Print    ' @@DiffQty = TNetQty  Update settlement Se Settflag = 7  ' + Convert (Varchar,@@Diffqty)
                          
                          End
*/  
                          
                     End 

                     
                     If ( (@@PNetQty < 0 ) And (@@TNetQty > 0))   
                     Begin
                          /* If Position till Yesterday is greater than Absolute of Today or equal then the SettSettoff will apply */  
                          If Abs(@@PNetQty) >= (@@TNetqty)
                          Begin 
                             Print ' Update FoTrade Settflag = 6 '  
                             Update foTrade set settflag = '6' 
                             Where
                                  expirydate >= @Tdate +  ' 23:59:59'
                                  And party_code = @@TParty_code and expirydate >= @Tdate + ' 23:59:59'
                                  And Inst_type = @@TInst_type And Symbol = @@TSymbol 
                                  And Expirydate LIKE @@TExpiryDate +'%'
                                  And Strike_Price = @@TStrike_price 
                                  And Option_type = @@TOption_type
                                  And SettFlag in(8)
                          End

                          /* If Position till Yesterday is greater than Absolute of Today then We
                             Will Split The trade Which are sell side  or sett_flag = 5  */   
                          If Abs(@@PNetQty) < Abs(@@TNetqty) 
    Begin
       Print 'Going to Cursor in PnetQty < 0 '
                               Exec FOTrdSettflagArrange @@TParty_code,@@TOption_type,@@TInst_type,@@TSymbol,@@TExpiryDate,@@TStrike_Price,@Tdate,@@DiffQty,'B'
                          End
/*                         
                          If Abs(@@Diffqty) = Abs(@@TNetqty) 
                          Begin
                               Print    ' @@DiffQty = TNetQty  Update settlement Se Settflag = 6  ' + Convert (Varchar,@@Diffqty)
                          End 
*/   
                     End 
                      
                     Fetch Next From @@PPosCur into @@PParty_code, @@PNetQty,@@Pinst_type ,@@PSymbol,@@PExpirydate,@@PStrike_price,@@Poption_type
                           
                End
			
Else
                Begin
                         Print 'Past Position is Zero '
                         

               End
close @@PPosCur
deallocate @@PPosCur
                
     Fetch next from @@TPosCur into @@TParty_code,@@TInst_Type,@@TSymbol,@@TExpirydate,@@TNetQty,@@TStrike_Price,@@TOption_Type
     End
Close @@TPosCur
Deallocate @@TPosCur
       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoTrdUpdExpDt
-- --------------------------------------------------
CREATE  PROC FoTrdUpdExpDt 
 as

  update foTrade set
  expirydate = substring(convert(varchar,expirydate,109),1,11)+ ' ' + '23:59:00'
  where convert(varchar,expirydate,108) = '00:00:00'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FoValanGenerate
-- --------------------------------------------------
CREATE PROC [dbo].[FoValanGenerate] 

(

	@SAUDA_DATE VARCHAR(11),

	@USERNAME VARCHAR(50) =''

) AS          

DECLARE           

@@START_DATE DATETIME,          

@@EXPIRYDATE DATETIME,          

@@SETT_NO VARCHAR(12),          

@@SETT_TYPE VARCHAR(2),          

          

@@BILLNO INT,          

@@FROMPARTY VARCHAR(10),          

@@TOPARTY VARCHAR(10),          

          

@@ACNAME VARCHAR(50),          

@@ACCODE VARCHAR(10),          

@@OPPCODE VARCHAR(10),          

@@REVCODE VARCHAR(10),          

@@DUMMYOPPCODE VARCHAR(10),          

@@DUMMYREVCODE VARCHAR(10),          

          

@@CLRHSGPARTY VARCHAR(10) ,          

@@BRKRELPARTY VARCHAR(10) ,          

@@SERTAXPARTY VARCHAR(10) ,          

@@CESSTAXPARTY VARCHAR(10) ,          

@@EDUCESSTAXPARTY VARCHAR(10) ,          

@@OPTEXEPARTY VARCHAR(10) ,          

@@RNDOFFPARTY VARCHAR(10) ,          

@@CARFORPARTY VARCHAR(10) ,          

@@SERTAXPAYPARTY VARCHAR(10) ,          

@@CESSTAXPAYPARTY VARCHAR(10),          

@@EDUCESSTAXPAYPARTY VARCHAR(10),          

@@INSSERTAXPARTY VARCHAR(10) ,          

@@INSSEBITAXPARTY VARCHAR(10) ,          

@@INSTURNTAXPARTY VARCHAR(10) ,          

@@INSBRKNOTEPARTY VARCHAR(10) ,          

@@REMACCPARTY VARCHAR(10) ,          

@@SEBITAXPARTY VARCHAR(10) ,          

@@TURNTAXPARTY VARCHAR(10) ,          

@@BRKNOTEPARTY VARCHAR(10) ,          

@@REVCLRHSGPARTY VARCHAR(10) ,           

@@CONCLRHSGPARTY VARCHAR(10) ,          

@@CLRPREPARTY VARCHAR(10) ,          

@@CLRCHRGPARTY VARCHAR(10) ,          

@@REVCLRCHRGPARTY VARCHAR(10) ,          

@@INSCHRGPARTY VARCHAR(10),          

@@OTHERSPARTY VARCHAR(10),            

@@DUMMYBRANCH_CD VARCHAR(10),          

@@BRANCH_CD VARCHAR(10),          

@@SELL_BUY INT,          

@@MTOM NUMERIC(18,6),          

@@PREMIUM NUMERIC(18,6),          

@@EXEASSIGN NUMERIC(18,6),          

@@BROKERAGE NUMERIC(18,6),          

@@SERVICE_TAX NUMERIC(18,6),          

@@CESS_TAX NUMERIC(18,6),          

@@EDUCESS_TAX NUMERIC(18,6),          

@@TSERVICE_TAX NUMERIC(18,6),            

@@TCESS_TAX NUMERIC(18,6),            

@@TEDUCESS_TAX NUMERIC(18,6),            

@@TBROKERAGE NUMERIC(18,6),        

@@EXSERVICE_TAX NUMERIC(18,6),          

@@TURN_TAX NUMERIC(18,6),          

@@SEBI_TAX NUMERIC(18,6),          

@@BROKER_CHRG NUMERIC(18,6),          

@@CL_CHRG NUMERIC(18,6),          

@@EXCL_CHRG NUMERIC(18,6),          

@@DIFFAMT NUMERIC(18,6),          

@@TRDAMT  NUMERIC(18,6),          

@@DELAMT  NUMERIC(18,6),          

@@OPPAMT  NUMERIC(18,6),          

@@REVAMT  NUMERIC(18,6),          

@@ACCAMT  NUMERIC(18,6),          

@@CALSERAMT  NUMERIC(18,6),          

@@INSCHRG NUMERIC(18,6),          

@@OTHERCHARGES NUMERIC(18,6), 

@@TEXSERVICE_TAX NUMERIC(18,6),          

@@TEXCESS_TAX NUMERIC(18,6),          

@@TEXEDUCESS_TAX NUMERIC(18,6),          

          

@@NETMTOM NUMERIC(18,6),          

@@NETPREMIUM NUMERIC(18,6),          

@@NETEXEASSIGN NUMERIC(18,6),          

@@NETBROKERAGE NUMERIC(18,6),          

@@NETSERVICE_TAX NUMERIC(18,6),          

@@NETCESS_TAX NUMERIC(18,6),            

@@NETEDUCESS_TAX NUMERIC(18,6),            

@@NETEXCESS_TAX NUMERIC(18,6),            

@@NETEXEDUCESS_TAX NUMERIC(18,6),            

@@NETEXSERVICE_TAX NUMERIC(18,6),          

@@NETTURN_TAX NUMERIC(18,6),          

@@NETSEBI_TAX NUMERIC(18,6),          

@@NETBROKER_CHRG NUMERIC(18,6),          

@@NETCL_CHRG NUMERIC(18,6),          

@@NETEXCL_CHRG NUMERIC(18,6),          

@@NETDIFFAMT NUMERIC(18,6),          

@@GROSSDIFFAMT NUMERIC(18,6),          

@@NETTRDAMT  NUMERIC(18,6),          

@@NETDELAMT  NUMERIC(18,6),          

@@NETINSCHRG NUMERIC(18,6),          

@@NETOTHERCHARGES NUMERIC(18,6),        

          

@@TRDSTDUTY NUMERIC(18,6),          

@@DELSTDUTY NUMERIC(18,6),          

@@STDUTY NUMERIC(18,6),          

@@TRDTTDUTY NUMERIC(18,6),          

@@DELTTDUTY NUMERIC(18,6),          

@@TTDUTY NUMERIC(18,6),          

@@TRANS_CAT VARCHAR(3),          

@@SERVICE_CHRG NUMERIC(18,6),          

@@CESS_CHRG NUMERIC(18,6),          

@@EDUCESS_CHRG NUMERIC(18,6),          

          

@@SUB_BROKER VARCHAR(10),          

@@COM_PER NUMERIC(18,6),          

@@BROKSHARE NUMERIC(18,6),          

@@NETBROKSHARE NUMERIC(18,6),          

@@GROSSBROKSHARE NUMERIC(18,6),          

          

@@SETMSTCUR CURSOR, 

@@VALANACCCUR CURSOR,          

@@VALANAMTCUR CURSOR          

          

SELECT @@NETMTOM = 0           

SELECT @@NETPREMIUM = 0           

SELECT @@NETEXEASSIGN = 0           

SELECT @@NETBROKERAGE = 0           

SELECT @@NETSERVICE_TAX = 0           

SELECT @@NETCESS_TAX = 0             

SELECT @@NETEDUCESS_TAX = 0             

SELECT @@TBROKERAGE = 0         

SELECT @@TSERVICE_TAX = 0            

SELECT @@TCESS_TAX = 0            

SELECT @@TEDUCESS_TAX = 0            

SELECT @@TEXSERVICE_TAX = 0            

SELECT @@TEXCESS_TAX = 0          

SELECT @@TEXEDUCESS_TAX = 0          

SELECT @@NETEXSERVICE_TAX = 0           

SELECT @@NETEXCESS_TAX = 0             

SELECT @@NETEXEDUCESS_TAX = 0             

SELECT @@NETTURN_TAX = 0           

SELECT @@NETSEBI_TAX = 0           

SELECT @@NETBROKER_CHRG = 0           

SELECT @@NETCL_CHRG = 0           

SELECT @@NETEXCL_CHRG = 0           

SELECT @@NETDIFFAMT = 0           

SELECT @@GROSSDIFFAMT = 0           

SELECT @@NETTRDAMT  = 0           

SELECT @@NETDELAMT  = 0          

SELECT @@NETINSCHRG  = 0          

SELECT @@NETOTHERCHARGES = 0  

          

SET @@SETMSTCUR = CURSOR FOR            

SELECT SERVICE_TAX, CESS_TAX,EDUCESS_TAX FROM FOGLOBALS  WHERE @SAUDA_DATE >= YEAR_START_DT AND @SAUDA_DATE <=  YEAR_END_DT           

OPEN @@SETMSTCUR             

FETCH NEXT FROM @@SETMSTCUR INTO @@SERVICE_CHRG, @@CESS_CHRG  , @@EDUCESS_CHRG          

CLOSE @@SETMSTCUR            

DEALLOCATE @@SETMSTCUR            

         

          

       

EXEC FOVALANPOP @SAUDA_DATE,'','ZZZZZZZZZ'          

          

DELETE FROM FOACCBILL WHERE BILLDATE LIKE @SAUDA_DATE + '%'          





SELECT @@START_DATE = LEFT(ISNULL(MAX(SEC_PAYIN),@SAUDA_DATE),11) FROM        

(SELECT TOP 1 SEC_PAYIN FROM MSAJAG.DBO.SETT_MST (NOLOCK)         

WHERE SEC_PAYIN  > @SAUDA_DATE         

AND SETT_TYPE = 'N' order by SEC_PAYIN) S



SET @@SETT_NO = ''

SET @@SETT_TYPE = ''

SET @@EXPIRYDATE = @@START_DATE



/*          

SET @@VALANACCCUR = CURSOR FOR          

SELECT 

	TOP 1 SETT_NO=CONVERT(VARCHAR,EXPIRYDATE,112),

	SETT_TYPE='N',

	START_DATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),

	EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)        

FROM FOSCRIP2 WHERE MATURITYDATE >= @SAUDA_DATE        



OPEN @@VALANACCCUR          

FETCH NEXT FROM @@VALANACCCUR INTO @@SETT_NO,@@SETT_TYPE,@@START_DATE,@@EXPIRYDATE          

CLOSE @@VALANACCCUR          

DEALLOCATE @@VALANACCCUR          



*/

          

/* START OF PARTY BILL AMOUNT */          

     

INSERT INTO FOACCBILL            

          

SELECT

	PARTY_CODE,BILLNO=0,        

	SELL_BUY = 

		(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 1 ELSE 2 END), 

	SETT_NO, SETT_TYPE, SAUDA_DATE, START_DATE, END_DATE, SEC_PAYIN, SEC_PAYOUT, 

	AMOUNT =  ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)), 

	D1, D2, D3, D4, BRANCH_CODE, NARR

	FROM (

		SELECT PARTY_CODE,

			SELL_BUY = (CASE WHEN SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE         

					THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + 

						 INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)         

					ELSE -1 END ) > 0         

					THEN 2        

					ELSE 1        

					END),        

	SETT_NO=@@SETT_NO,SETT_TYPE=@@SETT_TYPE,SAUDA_DATE,START_DATE=@@START_DATE,

	END_DATE=@@START_DATE,SEC_PAYIN=@@START_DATE,SEC_PAYOUT=@@START_DATE,        

	AMOUNT = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE         

				THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX + 

					INS_CHRG + SEBI_TAX + OTHER_CHRG + BROKER_NOTE + CL_CHRG-EXCL_CHRG)        

				ELSE SBILLAMT + PBILLAMT + (SERVICE_TAX - EXSER_TAX + INS_CHRG + OTHER_CHRG +

					 TURN_TAX + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)         

				END)),2) ,        

	D1=0,D2=0,D3=0,D4=0, BRANCH_CODE, NARR='BILL POSTED'  

FROM

	FOBILLVALAN_TEMP , FOOWNER WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'        

GROUP BY

	BRANCH_CODE,PARTY_CODE,SAUDA_DATE, PARTICIPANTCODE  ) A

GROUP BY

	PARTY_CODE, SETT_NO, SETT_TYPE, SAUDA_DATE, START_DATE, END_DATE,

	SEC_PAYIN, SEC_PAYOUT, D1, D2, D3, D4, BRANCH_CODE, NARR

      

/* END OF PARTY BILL AMOUNT */          

    
SET @@VALANACCCUR = CURSOR FOR          

 SELECT ACNAME,ACCODE FROM VALANACCOUNT V WHERE EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT A          

 WHERE A.EFFDATE <= @SAUDA_DATE AND V.ACNAME = A.ACNAME) ORDER BY ACNAME          

OPEN @@VALANACCCUR          

FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE          

WHILE @@FETCH_STATUS = 0           

BEGIN          

 IF @@ACNAME = 'CLEARING HOUSE'            

  SELECT @@CLRHSGPARTY = @@ACCODE          

 IF @@ACNAME = 'Brokerage Charges'            

  SELECT @@BRKRELPARTY = @@ACCODE        

 IF @@ACNAME = 'SERVICE TAX'            

  SELECT @@SERTAXPARTY = @@ACCODE          

 IF @@ACNAME = 'CESS TAX'              

   SELECT @@CESSTAXPARTY = @@ACCODE            

 IF @@ACNAME = 'EDU CESS TAX'              

   SELECT @@EDUCESSTAXPARTY = @@ACCODE            

 IF @@ACNAME = 'OPTION EXERCISE'            

  SELECT @@OPTEXEPARTY = @@ACCODE          

 IF @@ACNAME = 'ROUNDING OFF'            

  SELECT @@RNDOFFPARTY = @@ACCODE          

 IF @@ACNAME = 'CARRY FORWARD CHARGE'            

  SELECT @@CARFORPARTY = @@ACCODE          

 IF @@ACNAME = 'SERVICE TAX PAYABLE'            

  SELECT @@SERTAXPAYPARTY = @@ACCODE          

 IF @@ACNAME = 'INCLUSIVE SERVICE TAX'            

  SELECT @@INSSERTAXPARTY = @@ACCODE          

 IF @@ACNAME = 'INCLUSIVE SEBI TAX'            

  SELECT @@INSSEBITAXPARTY = @@ACCODE          

 IF @@ACNAME = 'INCLUSIVE TURN TAX'            

  SELECT @@INSTURNTAXPARTY = @@ACCODE          

 IF @@ACNAME = 'INCLUSIVE STAMP TAX'            

  SELECT @@INSBRKNOTEPARTY = @@ACCODE          

 IF @@ACNAME = 'REMISSOR ACCOUNT'            

  SELECT @@REMACCPARTY = @@ACCODE          

 IF @@ACNAME = 'SEBI TAX'            

  SELECT @@SEBITAXPARTY = @@ACCODE          

 IF @@ACNAME = 'CESS TAX PAYABLE'              

   SELECT @@CESSTAXPAYPARTY = @@ACCODE            

 IF @@ACNAME = 'EDU CESS TAX PAYABLE'              

   SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE            

 IF @@ACNAME = 'TURN OVER TAX'            

  SELECT @@TURNTAXPARTY = @@ACCODE          

 IF @@ACNAME = 'STAMP DUTY'            

  SELECT @@BRKNOTEPARTY = @@ACCODE          

 IF @@ACNAME = 'REVERSE CLRG HOUSE'            

  SELECT @@REVCLRHSGPARTY = @@ACCODE           

 IF @@ACNAME = 'CONS. CLRG HOUSE'            

  SELECT @@CONCLRHSGPARTY = @@ACCODE          

 IF @@ACNAME = 'CLEARING CHARGES'            

  SELECT @@CLRCHRGPARTY = @@ACCODE          

 IF @@ACNAME = 'REVERSE CLEARING CHARGES'            

  SELECT @@REVCLRCHRGPARTY = @@ACCODE          

 IF @@ACNAME = 'CLEARING PREMIUM ACCOUNT'            

  SELECT @@CLRPREPARTY = @@ACCODE          

 IF @@ACNAME = 'SECURITY TRANSACTION TAX'            

  SELECT @@INSCHRGPARTY = @@ACCODE          

 IF @@ACNAME = 'OTHER CHARGES'          

  SELECT @@OTHERSPARTY = @@ACCODE        

          

  --PRINT @@ACNAME          

          

 FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE          

END          

CLOSE @@VALANACCCUR          

DEALLOCATE @@VALANACCCUR          

       

/* EXCHANGE AND LEVIS BRANCH WISE OBLIGATION AMOUNT */          

SET @@VALANAMTCUR = CURSOR FOR           

 SELECT BRANCH_CODE,        

 MTOM      = ISNULL(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND PARTICIPANTCODE = MEMBERCODE  AND SYMBOL <> 'BROKERAGE'       

       THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT         

        ELSE 0         

          END),0),        

 PREMIUM   = ISNULL(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE   AND SYMBOL <> 'BROKERAGE'      

        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT         

        ELSE 0         

          END),0),        

 EXEASSIGN = ISNULL(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE   AND SYMBOL <> 'BROKERAGE'      

        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT         

        ELSE 0         

          END),0),        

 BROKERAGE=SUM((CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN

	((SBROKAMT + PBROKAMT +

	CASE WHEN INSURANCE_CHRG_AC = 1 AND CLIENT2.INSURANCE_CHRG = 1 THEN INS_CHRG ELSE 0 END +

	CASE WHEN TURNOVER_AC = 1 AND CLIENT2.TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END +

	CASE WHEN SEBI_TURN_AC = 1 AND CLIENT2.SEBI_TURN_TAX = 1  THEN SEBI_TAX ELSE 0 END +

	CASE WHEN OTHER_CHRG_AC = 1 AND CLIENT2.OTHER_CHRG = 1 THEN FOBILLVALAN_TEMP.OTHER_CHRG ELSE 0 END + 

	CASE WHEN BROKER_NOTE_AC = 1 AND CLIENT2.BROKERNOTE = 1 THEN BROKER_NOTE ELSE 0 END )

	*100/(100+@@SERVICE_CHRG))

		- (

		CASE WHEN INSURANCE_CHRG_AC = 1 AND CLIENT2.INSURANCE_CHRG = 1 THEN INS_CHRG ELSE 0 END +

		CASE WHEN TURNOVER_AC = 1 AND CLIENT2.TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END  + 

		CASE WHEN SEBI_TURN_AC = 1 AND CLIENT2.SEBI_TURN_TAX = 1  THEN SEBI_TAX ELSE 0 END +

		CASE WHEN OTHER_CHRG_AC = 1 AND CLIENT2.OTHER_CHRG = 1 THEN FOBILLVALAN_TEMP.OTHER_CHRG ELSE 0 END + 

		CASE WHEN BROKER_NOTE_AC = 1 AND CLIENT2.BROKERNOTE = 1 THEN BROKER_NOTE ELSE 0 END )

		ELSE SBROKAMT + PBROKAMT END)),        

 SERVICE_TAX=SUM(FOBILLVALAN_TEMP.SERVICE_TAX + 

	CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1

		THEN ((SBROKAMT + PBROKAMT) - 

		((SBROKAMT + PBROKAMT + 

		CASE WHEN INSURANCE_CHRG_AC = 1 AND CLIENT2.INSURANCE_CHRG = 1 THEN INS_CHRG ELSE 0 END +

		CASE WHEN TURNOVER_AC = 1 AND CLIENT2.TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END + 

		CASE WHEN SEBI_TURN_AC = 1 AND CLIENT2.SEBI_TURN_TAX = 1  THEN SEBI_TAX ELSE 0 END  +

		CASE WHEN OTHER_CHRG_AC = 1 AND CLIENT2.OTHER_CHRG = 1 THEN FOBILLVALAN_TEMP.OTHER_CHRG ELSE 0 END + 

		CASE WHEN BROKER_NOTE_AC = 1 AND CLIENT2.BROKERNOTE = 1 THEN BROKER_NOTE  ELSE 0 END )* 

	100/(100+@@SERVICE_CHRG)))

	ELSE 0 END),

 EXSERVICE_TAX=SUM(EXSER_TAX),        

 TURN_TAX=SUM(TURN_TAX),SEBI_TAX=SUM(SEBI_TAX), INS_CHRG=SUM( INS_CHRG), OTHER_CHRG = SUM(FOBILLVALAN_TEMP.OTHER_CHRG),  

 BROKER_CHRG=SUM(BROKER_NOTE),CL_CHRG = SUM(CL_CHRG),EXCL_CHRG = SUM(EXCL_CHRG)         

 FROM

	FOBILLVALAN_TEMP, FOOWNER, CLIENT1, CLIENT2, FOGLOBALS

 WHERE

	SAUDA_DATE LIKE @SAUDA_DATE + '%'

	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE

	AND CLIENT2.PARTY_CODE = FOBILLVALAN_TEMP.PARTY_CODE

	AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

 GROUP BY BRANCH_CODE        

 ORDER BY BRANCH_CODE



OPEN @@VALANAMTCUR           

FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,          

                @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@OTHERCHARGES,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG    

WHILE @@FETCH_STATUS = 0           

BEGIN           

 SELECT @@NETMTOM = @@NETMTOM + @@MTOM          

 SELECT @@NETPREMIUM = @@NETPREMIUM + @@PREMIUM          

 SELECT @@NETEXEASSIGN = @@NETEXEASSIGN + @@EXEASSIGN           

 SELECT @@NETTURN_TAX = @@NETTURN_TAX + @@TURN_TAX          

 SELECT @@NETSEBI_TAX = @@NETSEBI_TAX + @@SEBI_TAX      

 SELECT @@NETBROKER_CHRG = @@NETBROKER_CHRG + @@BROKER_CHRG   

 SELECT @@NETCL_CHRG = @@NETCL_CHRG + @@CL_CHRG          

 SELECT @@NETEXCL_CHRG = @@NETEXCL_CHRG + @@EXCL_CHRG          

 SELECT @@NETINSCHRG  = @@NETINSCHRG + @@INSCHRG          

 SELECT @@NETOTHERCHARGES = @@NETOTHERCHARGES + @@OTHERCHARGES

 SELECT @@TSERVICE_TAX =  @@SERVICE_TAX            

 SELECT @@TEXSERVICE_TAX =  @@EXSERVICE_TAX             



/*

 SELECT @@TCESS_TAX = @@SERVICE_TAX - ROUND(( @@SERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)          

 SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)          

 SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX         

 SELECT @@TSERVICE_TAX = @@SERVICE_TAX - @@TCESS_TAX - @@TEDUCESS_TAX       

              

 SELECT @@TEXCESS_TAX = @@TEXSERVICE_TAX - ROUND(( @@TEXSERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG)),2)            

 SELECT @@TEXEDUCESS_TAX = ROUND(@@TEXCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)          

 SELECT @@TEXCESS_TAX = @@TEXCESS_TAX - @@TEXEDUCESS_TAX         

 SELECT @@TEXSERVICE_TAX = @@TEXSERVICE_TAX - @@TEXCESS_TAX - @@TEXEDUCESS_TAX 

        

 SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX          

 SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX          

 SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX           

 SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX           

        

 SELECT @@NETEXSERVICE_TAX = @@NETEXSERVICE_TAX + @@TEXSERVICE_TAX          

 SELECT @@NETSERVICE_TAX = @@NETSERVICE_TAX + @@TSERVICE_TAX        

 SELECT @@TBROKERAGE = @@BROKERAGE      

 SELECT @@NETBROKERAGE = @@NETBROKERAGE + @@TBROKERAGE                

*/



 if (@@CESS_Chrg+@@EDUCESS_Chrg) > 0                 

 BEGIN  

	 Select @@TCESS_Tax = @@Service_Tax - Round(( @@Service_Tax * 100 ) / ( 100 + (@@CESS_Chrg+@@EDUCESS_Chrg) ),2)            

	 Select @@TEDUCESS_Tax = Round(@@TCESS_Tax*@@EDUCESS_Chrg/(@@CESS_Chrg+@@EDUCESS_Chrg),2)         

 END

 ELSE

 BEGIN

	Select @@TCESS_Tax = 0

	Select @@TEDUCESS_Tax = 0

 END



 Select @@TCESS_Tax = @@TCESS_Tax - @@TEDUCESS_Tax           

 Select @@TService_Tax = @@Service_Tax - @@TCESS_Tax - @@TEDUCESS_Tax         

 

 if (@@CESS_Chrg+@@EDUCESS_Chrg) > 0                 

 BEGIN  

	 Select @@TExCESS_Tax = @@TExService_Tax - Round(( @@TExService_Tax * 100 ) / ( 100 + (@@CESS_Chrg+@@EDUCESS_Chrg)),2)              

	 Select @@TExEDUCESS_Tax = Round(@@TExCESS_Tax*@@EDUCESS_Chrg/(@@CESS_Chrg+@@EDUCESS_Chrg),2)            

 END

 ELSE

 BEGIN  

	 Select @@TExCESS_Tax = 0

	 Select @@TExEDUCESS_Tax = 0

 END



 Select @@TExCESS_Tax = @@TExCESS_Tax - @@TExEDUCESS_Tax           

 Select @@TExService_Tax = @@TExService_Tax - @@TExCESS_Tax - @@TExEDUCESS_Tax   

          

 Select @@NetCESS_Tax = @@NetCESS_Tax + @@TCESS_Tax            

 Select @@NetEDUCESS_Tax = @@NetEDUCESS_Tax + @@TEDUCESS_Tax            

 Select @@NetExCESS_Tax = @@NetExCESS_Tax + @@TExCESS_Tax             

 Select @@NetExEDUCESS_Tax = @@NetExEDUCESS_Tax + @@TExEDUCESS_Tax             

          

 Select @@NetExService_Tax = @@NetExService_Tax + @@TExService_Tax            

 Select @@NetService_Tax = @@NetService_Tax + @@TService_Tax          

 Select @@TBrokerage = @@Brokerage        

 Select @@NetBrokerage = @@NetBrokerage + @@TBrokerage          

          
 
          

 IF @@MTOM > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

            

 INSERT INTO FOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@MTOM),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')           

              

 IF @@PREMIUM > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

            

 INSERT INTO FOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@PREMIUM),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

 IF @@EXEASSIGN > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

    

 INSERT INTO FOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@EXEASSIGN),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

   

 INSERT INTO FOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TBROKERAGE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')           

        

          

          

 INSERT INTO FOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TSERVICE_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

            

 INSERT INTO FOACCBILL VALUES (@@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TEXSERVICE_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

          

 IF ROUND(@@TCESS_TAX,2) <> 0           

 BEGIN          

   INSERT INTO FOACCBILL VALUES (@@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')      

 END          

 IF ROUND(@@TEDUCESS_TAX,2) <> 0           

 BEGIN          

   INSERT INTO FOACCBILL VALUES (@@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TEDUCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

 END          

          

        

  IF ROUND(@@TEXCESS_TAX,2) <> 0   

   BEGIN          

    INSERT INTO FOACCBILL VALUES (@@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TEXCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

  END        

  IF ROUND(@@TEXEDUCESS_TAX,2) <> 0   

   BEGIN          

    INSERT INTO FOACCBILL VALUES (@@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TEXEDUCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

  END          

          

          

 INSERT INTO FOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@TURN_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

           

 INSERT INTO FOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@SEBI_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@BROKER_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@CL_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

            

 INSERT INTO FOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@EXCL_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@INSCHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@OTHERSPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,        

         ROUND(@@OTHERCHARGES,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')        

        

          

 FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,          

                      @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@OTHERCHARGES,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG          

          

END          

CLOSE @@VALANAMTCUR          

DEALLOCATE @@VALANAMTCUR          

          

SELECT @@NETBROKSHARE = 0          

SELECT @@GROSSBROKSHARE = 0          

          

SET @@VALANAMTCUR = CURSOR FOR          

SELECT SB.SUB_BROKER,COM_PERC, BRANCH_CD, BROKERAGE = SUM(PBROKAMT+SBROKAMT)*COM_PERC/100          

FROM FOBILLVALAN_TEMP S, CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB          

WHERE S.PARTY_CODE = C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE           

AND C1.SUB_BROKER = SB.SUB_BROKER           

AND SB.COM_PERC > 0           

AND S.SAUDA_DATE LIKE @SAUDA_DATE + '%'          

GROUP BY SB.SUB_BROKER,COM_PERC,BRANCH_CD          

ORDER BY SB.SUB_BROKER,BRANCH_CD          

OPEN @@VALANAMTCUR           

FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD,@@BROKSHARE          

WHILE @@FETCH_STATUS = 0            

BEGIN          

 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD          

 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0            

 BEGIN          

  SELECT @@NETBROKSHARE = @@NETBROKSHARE + @@BROKSHARE          

  SELECT @@GROSSBROKSHARE = @@GROSSBROKSHARE + @@BROKSHARE          

          

  INSERT INTO FOACCBILL VALUES ( @@SUB_BROKER,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

               ROUND(@@BROKSHARE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

             

  FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD,@@BROKSHARE          

 END          

/*      

 INSERT INTO FOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

       ROUND(@@NETBROKSHARE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          

*/      

 SELECT @@NETBROKSHARE = 0          

END          

          

SET @@VALANAMTCUR = CURSOR FOR          

 SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),BRANCHCD,SELL_BUY FROM FOACCBILL WHERE           

 BILLDATE LIKE @SAUDA_DATE + '%' AND BRANCHCD <> 'ZZZ'          

 GROUP BY BRANCHCD,SELL_BUY           

 ORDER BY BRANCHCD,SELL_BUY          

OPEN @@VALANAMTCUR           

FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY          

WHILE @@FETCH_STATUS = 0            

BEGIN          

 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD          

 SELECT @@NETDIFFAMT = 0          

 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0           

 BEGIN          

  IF @@SELL_BUY = 1           

  BEGIN          

   SELECT @@NETDIFFAMT = @@NETDIFFAMT + @@DIFFAMT          

   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT          

  END        

  ELSE          

  BEGIN                                  

   SELECT @@NETDIFFAMT = @@NETDIFFAMT - @@DIFFAMT           

   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                 

END          

  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY            

 END          

 IF @@NETDIFFAMT > 0           

  INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')          

 ELSE IF @@NETDIFFAMT < 0           

  INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')          

           

END          

CLOSE @@VALANAMTCUR          

DEALLOCATE @@VALANAMTCUR          

          

 IF @@NETMTOM > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

            
 INSERT INTO FOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@NETMTOM),2),0,0,0,0,'ZZZ','BILL POSTED')           

              

 IF @@NETPREMIUM > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

            

 INSERT INTO FOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@NETPREMIUM),2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 IF @@NETEXEASSIGN > 0           

  SELECT @@SELL_BUY = 1            

 ELSE          

  SELECT @@SELL_BUY = 2          

            

 INSERT INTO FOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@NETEXEASSIGN),2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETBROKERAGE,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETSERVICE_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 IF ROUND(@@NETCESS_TAX,2) <> 0           

  BEGIN          

   INSERT INTO FOACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

  END          



 IF ROUND(@@NETEDUCESS_TAX,2) <> 0           

  BEGIN          

   INSERT INTO FOACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETEDUCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

  END          



 IF ROUND(@@NETEXCESS_TAX,2) <> 0           

  BEGIN          

   INSERT INTO FOACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETEXCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

  END          



 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0           

  BEGIN          

   INSERT INTO FOACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETEXEDUCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

  END          



          

          

            

 INSERT INTO FOACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETEXSERVICE_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETTURN_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

           

 INSERT INTO FOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETSEBI_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETBROKER_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,    

         ROUND(@@NETCL_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          

            

 INSERT INTO FOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETEXCL_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          

/*          

 INSERT INTO FOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@GROSSBROKSHARE,2),0,0,0,0,'ZZZ','BILL POSTED')          

*/          

 INSERT INTO FOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(@@NETINSCHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          

          

 INSERT INTO FOACCBILL VALUES ( @@OTHERSPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,        

         ROUND(@@NETOTHERCHARGES,2),0,0,0,0,'ZZZ','BILL POSTED')        

          

SELECT @@OPPAMT = 0          

          

SET @@VALANAMTCUR = CURSOR FOR          

 SELECT OPPCODE,REVCODE,ACCODE FROM VALANACCOUNT WHERE REVERSED = 1           

 AND EFFDATE = (SELECT MIN(EFFDATE) FROM VALANACCOUNT          

 WHERE EFFDATE <= @SAUDA_DATE ) ORDER BY OPPCODE,REVCODE          

OPEN @@VALANAMTCUR           

FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE           

WHILE @@FETCH_STATUS =  0          

BEGIN         

 SELECT @@DUMMYOPPCODE = @@OPPCODE          

 WHILE @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0          

 BEGIN          

  SELECT @@REVAMT = 0          

  SELECT @@DUMMYREVCODE = @@REVCODE          

  WHILE @@DUMMYREVCODE = @@REVCODE AND @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0          

  BEGIN          

   SET @@VALANACCCUR = CURSOR FOR          

    SELECT AMOUNT,SELL_BUY FROM FOACCBILL WHERE BILLDATE LIKE @SAUDA_DATE + '%'          

    AND PARTY_CODE = @@ACCODE AND BRANCHCD = 'ZZZ'          

   OPEN @@VALANACCCUR           

   FETCH NEXT FROM @@VALANACCCUR INTO @@ACCAMT,@@SELL_BUY          

          

   IF @@FETCH_STATUS =  0          

   BEGIN          

    IF @@SELL_BUY = 1           

    BEGIN          

     SELECT @@REVAMT = @@REVAMT + @@ACCAMT          

     SELECT @@OPPAMT = @@OPPAMT + @@ACCAMT          

    END          

    ELSE          

    BEGIN          

     SELECT @@REVAMT = @@REVAMT - @@ACCAMT          

     SELECT @@OPPAMT = @@OPPAMT - @@ACCAMT          

    END          

   END          

   ELSE          

   CLOSE @@VALANACCCUR          

  DEALLOCATE @@VALANACCCUR          

   FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE       

  END          

  IF @@REVAMT > 0           

   INSERT INTO FOACCBILL VALUES ( @@DUMMYREVCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

          ROUND(ABS(@@REVAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          

  ELSE          

   INSERT INTO FOACCBILL VALUES ( @@DUMMYREVCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

          ROUND(ABS(@@REVAMT),2),0,0,0,0,'ZZZ','BILL POSTED')      

 END           

 IF @@OPPAMT > 0          

  INSERT INTO FOACCBILL VALUES ( @@DUMMYOPPCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@OPPAMT),2),0,0,0,0,'ZZZ','BILL POSTED')            

 ELSE          

  INSERT INTO FOACCBILL VALUES ( @@DUMMYOPPCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

         ROUND(ABS(@@OPPAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          

END          

CLOSE @@VALANAMTCUR          

DEALLOCATE @@VALANAMTCUR          

          

SELECT @@GROSSDIFFAMT = 0          

          

SET @@VALANAMTCUR = CURSOR FOR          

          

SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM FOACCBILL A,ACCOUNTNCE.DBO.ACMAST M           

WHERE BILLDATE LIKE @SAUDA_DATE + '%'          

AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )          

GROUP BY SELL_BUY          

          

OPEN @@VALANAMTCUR           

FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY          

WHILE @@FETCH_STATUS = 0            

BEGIN          

 BEGIN          

  IF @@SELL_BUY = 1           

  BEGIN            

   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT          

  END           

  ELSE          

  BEGIN                              

   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                   

  END          

  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY          

 END          

END          

CLOSE @@VALANAMTCUR          

DEALLOCATE @@VALANAMTCUR          

          

          

IF @@GROSSDIFFAMT > 0           

 INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          

ELSE           

 INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          

        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          

          

            

DELETE FROM FOACCBILL WHERE AMOUNT = 0 AND BILLDATE LIKE @SAUDA_DATE + '%'   

          

EXEC FOGENBILLNO @SAUDA_DATE         



           

DELETE FROM FOBILLVALAN WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'

                

INSERT INTO FOBILLVALAN                 

SELECT * FROM FOBILLVALAN_TEMP                





TRUNCATE TABLE FOBILLVALAN_TEMP



EXEC VALAN_ADDITIONAL_PROCESS @SAUDA_DATE

EXEC VALAN_GST_BILLPOST @SAUDA_DATE          



/*------------------------- PROCESS CONTROLER PLUG IN --------------------------------*/

UPDATE 

	V2_BUSINESS_PROCESS 

SET 

	BILLING = BILLING + 1 ,

	LASTUPDATEDATE = GETDATE()



WHERE 

	LEFT(BUSINESS_DATE,11) = @SAUDA_DATE





INSERT INTO V2_PROCESS_STATUS_LOG 

( 

	EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,

	FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP

)

SELECT

	EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),

	SEGMENT='FUTURES',

	BUSINESSDATE=@SAUDA_DATE,

	PROCESSID = 'VALANGEN',

	PROCESSNAME = 'VALAN GENERATION',

	FILENAME='',

	START_END_FLAG=1,

	PROCESSDATE=GETDATE(),

	PROCESSBY=@USERNAME,

	MACHINEIP=''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOVALANPOP
-- --------------------------------------------------
CREATE PROC [dbo].[FOVALANPOP](
           @SDATE  VARCHAR(11),
           @FPARTY VARCHAR(12),
           @TPARTY VARCHAR(12))
AS

  DECLARE  @MDATE           VARCHAR(11),
           @INTCLOSINGCOUNT INT
  
  DECLARE  @CHKPARTY DATETIME,
           @CHKDATE  INT
                     
  SELECT @INTCLOSINGCOUNT = COUNT(1)
  FROM   FOCLOSING_BILLREPORT (NOLOCK)
  WHERE  TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                
  IF @INTCLOSINGCOUNT = 0
    BEGIN
      SELECT @INTCLOSINGCOUNT = COUNT(1)
      FROM   FOSETTLEMENT (NOLOCK)
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
    END
    
  IF @INTCLOSINGCOUNT > 0
    BEGIN
	
	  EXEC CALCULATE_TRANS_CHRG @SDATE

	  EXEC STT_CHARGES_FINAL @SDATE ,'','ZZZZZZZZZZ'

	  EXEC CALCULATESTAMPDUTY @SDATE

      SELECT @INTCLOSINGCOUNT = SUM(INSURANCE_CHRG_AC + TURNOVER_AC + SEBI_TURN_AC + BROKER_NOTE_AC + OTHER_CHRG_AC)
      FROM   FOGLOBALS (NOLOCK)
      WHERE  @SDATE BETWEEN YEAR_START_DT AND YEAR_END_DT
                                              
      IF @INTCLOSINGCOUNT > 0
        BEGIN
          /*---------------------------------------------------------------------------------------*/
          UPDATE FOSETTLEMENT
          SET    SERVICE_TAX = ((TRADEQTY * BROKAPPLIED * BOOKTYPE / INSTRUMENT) + (CASE 
	              WHEN G.INSURANCE_CHRG_AC = 1
	                   AND C2.INSURANCE_CHRG = 1 THEN FOSETTLEMENT.INS_CHRG
	              ELSE 0
	            END) + (CASE 
                      WHEN G.TURNOVER_AC = 1
                           AND C2.TURNOVER_TAX = 1 THEN FOSETTLEMENT.TURN_TAX
                      ELSE 0
                    END) + (CASE 
                      WHEN G.SEBI_TURN_AC = 1
                           AND C2.SEBI_TURN_TAX = 1 THEN FOSETTLEMENT.SEBI_TAX
                      ELSE 0
                    END) + (CASE 
                      WHEN G.BROKER_NOTE_AC = 1
                           AND C2.BROKERNOTE = 1 THEN FOSETTLEMENT.BROKER_CHRG
                      ELSE 0
                    END) + (CASE 
                      WHEN G.OTHER_CHRG_AC = 1
                           AND C2.OTHER_CHRG = 1 THEN FOSETTLEMENT.OTHER_CHRG
                      ELSE 0
                    END)) * G.SERVICE_TAX / 100
FROM   FOGLOBALS G,
	CLIENT2 C2
          WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                 AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
                 AND FOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE
                 AND SERVICE_CHRG + SERVICE_CHRG + SERTAXMETHOD <> 3
        /*---------------------------------------------------------------------------------------*/
        END
        
      SELECT TOP 1 @CHKPARTY = BILLDATE
      FROM   TBL_MTOMPREMIUMBILL (NOLOCK)
      WHERE  BILLDATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
      
      SELECT @CHKDATE = ISNULL(CONVERT(NUMERIC,@CHKPARTY),0)
                        
      IF @CHKDATE <> 0
        BEGIN
          DELETE FROM TBL_MTOMPREMIUMBILL
          WHERE       BILLDATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                      AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
        END
        
      SELECT   *
      INTO     #FOSCRIP2
      FROM     FOSCRIP2 (NOLOCK)
      WHERE    FOSCRIP2.MATURITYDATE >= @SDATE
      ORDER BY INST_TYPE,
               SYMBOL,
               STRIKE_PRICE,
               OPTION_TYPE,
               EXPIRYDATE
               
      SELECT @MDATE = ISNULL(MIN(EXPIRYDATE),@SDATE)
      FROM   #FOSCRIP2
             
      SELECT *
      INTO   #FOCLOSING
      FROM   FOCLOSING (NOLOCK)
      WHERE  FOCLOSING.TRADE_DATE = (SELECT MAX(TRADE_DATE)
                                     FROM   FOCLOSING
                                     WHERE  FOCLOSING.TRADE_DATE < @SDATE)
                                    
      SELECT *
      INTO   #FOCLOSINGTODAY
      FROM   FOCLOSING (NOLOCK)
      WHERE  FOCLOSING.TRADE_DATE LIKE @SDATE + '%'
          
      SELECT   CONTRACTNO,
               BILLNO,
               TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
               PARTY_CODE,
               INST_TYPE,
               SYMBOL,
               SEC_NAME,
               EXPIRYDATE,
               STRIKE_PRICE,
               OPTION_TYPE,
               TRADEQTY = SUM(TRADEQTY),
               AUCTIONPART,
               MARKETTYPE,
               SERIES,
               ORDER_NO,
               PRICE,
               SAUDA_DATE,
               SELL_BUY,
               BROKAPPLIED = SUM(TRADEQTY * BROKAPPLIED) / SUM(TRADEQTY),
               NETRATE = SUM(TRADEQTY * NETRATE) / SUM(TRADEQTY),
               AMOUNT = SUM(AMOUNT),
               INS_CHRG = SUM(INS_CHRG),
               TURN_TAX = SUM(TURN_TAX),
               OTHER_CHRG = SUM(OTHER_CHRG),
               SEBI_TAX = SUM(SEBI_TAX),
               BROKER_CHRG = SUM(BROKER_CHRG),
               SERVICE_TAX = SUM(SERVICE_TAX),
               TRADE_AMOUNT = SUM(TRADE_AMOUNT),
               SETT_NO,
               NBROKAPP = 0,
               NSERTAX = 0,
               N_NETRATE = CONVERT(NUMERIC(18,4),0),
               SETT_TYPE,
               BILLFLAG = 0,
               CL_RATE,
               PARTICIPANTCODE,
               STATUS,
               RESERVED1,
               RESERVED2,
               BOOKTYPE,
               INSTRUMENT,
               TOTALBROK = CONVERT(NUMERIC(18,4),0),
               TOTALSER = CONVERT(NUMERIC(18,4),0)
      INTO     #FOSETTLEMENT
      FROM     FOSETTLEMENT (NOLOCK)
      WHERE    EXPIRYDATE >= @MDATE
               AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
               AND TRADEQTY > 0
      GROUP BY CONTRACTNO,BILLNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),PARTY_CODE,
               INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,
               STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,MARKETTYPE,
               SERIES,ORDER_NO,PRICE,SAUDA_DATE,
               SELL_BUY,SETT_NO,SETT_TYPE,CL_RATE,
               PARTICIPANTCODE,STATUS,RESERVED1,RESERVED2,
               BOOKTYPE,INSTRUMENT
      ORDER BY PARTY_CODE,
               INST_TYPE,
               SYMBOL,
               EXPIRYDATE,
               STRIKE_PRICE,
               OPTION_TYPE,
               SAUDA_DATE
               
      UPDATE #FOSETTLEMENT
      SET    TOTALBROK = CD_TOT_BROK,
             TOTALSER = CD_TOT_SERTAX,
             N_NETRATE = PRICE + CASE WHEN SELL_BUY =1 THEN  CD_TOT_BROK/TRADEQTY ELSE -CD_TOT_BROK/TRADEQTY END
      FROM   CHARGES_DETAIL (NOLOCK)
      WHERE  LEFT(CD_SAUDA_DATE,11) = @SDATE
             AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)
             AND CD_PARTY_CODE = PARTY_CODE
             AND CD_INST_TYPE = INST_TYPE
             AND CD_SYMBOL = SYMBOL
             AND CD_EXPIRY_DATE = EXPIRYDATE
             AND CD_STRIKE_PRICE = STRIKE_PRICE
             AND CD_OPTION_TYPE = OPTION_TYPE
             AND CD_TRADE_NO = TRADE_NO
                               
      SELECT *
      INTO   #FOTMCLCHRG
      FROM   FOTMCLCHRG
      WHERE  SAUDA_DATE LIKE @SDATE + '%'
             AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
                                                
      SELECT *
      INTO   #CLIENT2
      FROM   CLIENT2
      WHERE  PARTY_CODE IN (SELECT DISTINCT PARTY_CODE
                            FROM   #FOSETTLEMENT)
                           
      SELECT *
      INTO   #CLIENT1
      FROM   CLIENT1
      WHERE  CL_CODE IN (SELECT CL_CODE
                         FROM   #CLIENT2)
                        
      CREATE CLUSTERED INDEX [IDXSYMBOL] ON [DBO].[#CLIENT2] (
            [PARTY_CODE],
            [CL_CODE])
      
      CREATE CLUSTERED INDEX [IDXSYMBOL] ON [DBO].[#CLIENT1] (
            [CL_CODE])
      
      INSERT INTO TBL_MTOMPREMIUMBILL
      SELECT   BILLDATE = @SDATE + ' 23:59:00',
               PQTY = SUM(CASE 
                           WHEN S.SELL_BUY = 1 THEN (CASE 
                                                        WHEN S.RESERVED1 <> 1 THEN (S.TRADEQTY)
                              ELSE 0
                                                      END)
                            ELSE 0
                          END),
               SQTY = SUM(CASE 
                            WHEN S.SELL_BUY = 2 THEN (CASE 
                                                        WHEN S.RESERVED1 <> 1 THEN (S.TRADEQTY)
                                                        ELSE 0
                                                      END)
                            ELSE 0
                          END),
               NETRATE = ISNULL((SELECT FOCLOSING.CL_RATE
                                 FROM   #FOCLOSING FOCLOSING
                                 WHERE  FOCLOSING.INST_TYPE = S.INST_TYPE
                                        AND FOCLOSING.SYMBOL = S.SYMBOL
                                        AND FOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE
                                        AND FOCLOSING.OPTION_TYPE = S.OPTION_TYPE
                                        AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,S.EXPIRYDATE,103)),
                                0),
               CL_RATE = ISNULL((SELECT FOCLOSING.CL_RATE
                                 FROM   #FOCLOSINGTODAY FOCLOSING
                                 WHERE  FOCLOSING.INST_TYPE = S.INST_TYPE
                                        AND FOCLOSING.SYMBOL = S.SYMBOL
                                        AND FOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE
                                        AND FOCLOSING.OPTION_TYPE = S.OPTION_TYPE
                                        AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,S.EXPIRYDATE,103)),
                                0),
               S.PARTY_CODE,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
               SDATE = @SDATE,
               SELL_BUY = CASE 
                            WHEN SUM(CASE 
                                       WHEN S.SELL_BUY = 1 THEN (CASE 
                                                                   WHEN S.RESERVED1 <> 1 THEN (S.TRADEQTY)
                                                                   ELSE 0
                                                                 END)
                                       ELSE 0
                                     END) > SUM(CASE 
                                                  WHEN S.SELL_BUY = 2 THEN (CASE 
                                                                              WHEN S.RESERVED1 <> 1 THEN (S.TRADEQTY)
                                                                              ELSE 0
                                                                            END)
                                                  ELSE 0
                                                END) THEN 1
                            ELSE 2
                          END,
               SERVICE_TAX = 0,
               BROK = 0,
               NONEXPIRYSERVICE_TAX = 0,
               NONEXPIRYBROK = 0,
               SEBI_TAX = 0,
               TURN_TAX = 0,
               STAMPDUTY = 0,
               INEX_SERVICE_TAX = 0,
               INEX_SEBI_TAX = 0,
               INEX_TURN_TAX = 0,
               INEX_STAMPDUTY = 0,
               EXPIRYBROK = 0,
               EXPIRYSERVICE_TAX = 0,
               INSURANCE_CHRG = 0,
               INEX_INSURANCE_CHRG = 0,
               OTHER_CHRG = 0,
               INEX_OTHER_CHRG = 0,
               AUCTIONPART = '',
               OPTION_TYPE = S.OPTION_TYPE,
               STRIKE_PRICE = S.STRIKE_PRICE,
               NETWITHBROK = ISNULL((SELECT FOCLOSING.CL_RATE
                                     FROM   #FOCLOSING FOCLOSING
WHERE  FOCLOSING.INST_TYPE = S.INST_TYPE
            AND FOCLOSING.SYMBOL = S.SYMBOL
     AND FOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE
                                            AND FOCLOSING.OPTION_TYPE = S.OPTION_TYPE
                                            AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,S.EXPIRYDATE,103)),
                                    0),
               BFDAYFLAG = 'B-F',
               S.RESERVED1,
               ACTBUYQTY = SUM(CASE 
                                 WHEN S.SELL_BUY = 1 THEN (S.TRADEQTY)
                                 ELSE 0
                               END),
               ACTSELLQTY = SUM(CASE 
                                  WHEN S.SELL_BUY = 2 THEN (S.TRADEQTY)
                                  ELSE 0
                                END),
               0,
               NUMERATOR,
               DENOMINATOR,
               REGULARLOT
      FROM     #FOSETTLEMENT S,
               #FOSCRIP2 FOSCRIP2
      WHERE    SAUDA_DATE < @SDATE
               AND FOSCRIP2.INST_TYPE = S.INST_TYPE
               AND FOSCRIP2.SYMBOL = S.SYMBOL
               AND FOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE
               AND FOSCRIP2.OPTION_TYPE = S.OPTION_TYPE
               AND S.EXPIRYDATE = FOSCRIP2.EXPIRYDATE
               AND S.INST_TYPE LIKE 'FUT%'
               AND FOSCRIP2.INST_TYPE LIKE 'FUT%'
      GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,
               CONVERT(VARCHAR,S.EXPIRYDATE,103),S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
               S.RESERVED1,FOSCRIP2.MATURITYDATE,NUMERATOR,DENOMINATOR,
               REGULARLOT
               
      INSERT INTO TBL_MTOMPREMIUMBILL
      SELECT   BILLDATE = @SDATE + ' 23:59:00',
               PQTY = (CASE 
                         WHEN S.SELL_BUY = 1 THEN CASE 
                                                    WHEN S.RESERVED1 <> 1 THEN SUM(S.TRADEQTY)
                                                    ELSE 0
                                                  END
                         ELSE 0
                       END),
               SQTY = (CASE 
                         WHEN S.SELL_BUY = 2 THEN CASE 
                                                    WHEN S.RESERVED1 <> 1 THEN SUM(S.TRADEQTY)
                                                    ELSE 0
                                                  END
                         ELSE 0
                       END),
               ISNULL(S.PRICE,0),
               CL_RATE = (CASE 
                            WHEN S.INST_TYPE LIKE 'FUT%' THEN ISNULL((SELECT FOCLOSING.CL_RATE
                                                                      FROM   #FOCLOSINGTODAY FOCLOSING
                                                                      WHERE  FOCLOSING.INST_TYPE = S.INST_TYPE
                                                                             AND FOCLOSING.SYMBOL = S.SYMBOL
                                                                             AND FOCLOSING.STRIKE_PRICE = S.STRIKE_PRICE
                                                                             AND FOCLOSING.OPTION_TYPE = S.OPTION_TYPE
                                                                             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,S.EXPIRYDATE,103)),
                                                                     0)
                            ELSE 0
                          END),
               S.PARTY_CODE,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
               SDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) + ' 00:00:00',
               SELL_BUY,
               
               /*INCLUSIVE AND EXCLUSIVE*/
               SERVICE_TAX = (CASE 
                                WHEN (C2.SERVICE_CHRG = 1
                                       OR C2.SERVICE_CHRG = 0) THEN ISNULL(SUM(TOTALSER),0) + SUM(SERVICE_TAX)
 ELSE 0
                   END),
               
               BROK = SUM(ABS(NBROKAPP) * TRADEQTY) + SUM(BROKAPPLIED * TRADEQTY) + SUM(TOTALBROK),
               
               NONEXPIRYSERVICE_TAX = (CASE 
                                         WHEN (C2.SERVICE_CHRG = 1
                                                OR C2.SERVICE_CHRG = 0) THEN SUM(SERVICE_TAX)
                                         ELSE 0
                                       END),
               
               NONEXPIRYBROK = SUM(BROKAPPLIED * TRADEQTY) + SUM(TOTALBROK),
               
               SEBI_TAX = (CASE 
                             WHEN (C2.SEBI_TURN_TAX = 1) THEN ISNULL(SUM(S.SEBI_TAX),0)
                             ELSE 0
                           END),
               TURN_TAX = (CASE 
                             WHEN (C2.TURNOVER_TAX = 1) THEN ISNULL(SUM(S.TURN_TAX),0)
                             ELSE 0
                           END),
               STAMPDUTY = (CASE 
                              WHEN (C2.BROKERNOTE = 1) THEN SUM(S.BROKER_CHRG)
                              ELSE 0
                            END),
               INEX_SERVICE_TAX = (CASE 
                                     WHEN C2.SERVICE_CHRG = 2 THEN /* ISNULL(SUM(S.SERVICE_TAX),0)  */
                                                                   ISNULL(SUM(NSERTAX),0) + SUM(SERVICE_TAX)
                                     ELSE 0
                                   END),
               INEX_SEBI_TAX = (CASE 
                                  WHEN C2.SEBI_TURN_TAX = 1 THEN ISNULL(SUM(S.SEBI_TAX),0)
                                  ELSE 0
                                END),
               INEX_TURN_TAX = (CASE 
                                  WHEN C2.TURNOVER_TAX = 1 THEN ISNULL(SUM(S.TURN_TAX),0)
                                  ELSE 0
                                END),
               INEX_STAMPDUTY = (CASE 
                                   WHEN C2.BROKERNOTE = 1 THEN SUM(S.BROKER_CHRG)
                                   ELSE 0
                                 END),
               
               EXPIRYBROK = SUM(ABS(NBROKAPP) * TRADEQTY),
               EXPIRYSERVICE_TAX = (CASE 
                                      WHEN (C2.SERVICE_CHRG = 1
                                             OR C2.SERVICE_CHRG = 0) THEN ISNULL(SUM(NSERTAX),0)
                                      ELSE 0
                                    END),
               INSURANCE_CHRG = (CASE 
                                   WHEN (C2.INSURANCE_CHRG = 1) THEN SUM(S.INS_CHRG)
                                   ELSE 0
                                 END),
               INEX_INSURANCE_CHRG = (CASE 
                                        WHEN C2.INSURANCE_CHRG = 1 THEN SUM(S.INS_CHRG)
                                        ELSE 0
                                      END),
               
               OTHER_CHRG = (CASE 
                               WHEN (C2.OTHER_CHRG = 1) THEN SUM(S.OTHER_CHRG)
                               ELSE 0
                             END),
               INEX_OTHER_CHRG = (CASE 
                                    WHEN C2.OTHER_CHRG = 1 THEN SUM(S.OTHER_CHRG)
                                    ELSE 0
                                  END),
               AUCTIONPART = S.AUCTIONPART,
               OPTION_TYPE = S.OPTION_TYPE,
               STRIKE_PRICE = S.STRIKE_PRICE,
               NETWITHBROK = CASE WHEN N_NETRATE <>0 THEN N_NETRATE ELSE S.NETRATE END,
               BFDAYFLAG = '',
               S.RESERVED1,
               ACTBUYQTY = (CASE 
                              WHEN S.SELL_BUY = 1 THEN SUM(S.TRADEQTY)
                              ELSE 0
                            END),
               ACTSELLQTY = (CASE 
                               WHEN S.SELL_BUY = 2 THEN SUM(S.TRADEQTY)
                               ELSE 0
   END),
               0,
         NUMERATOR,
               DENOMINATOR,
               REGULARLOT
      FROM     #CLIENT2 C2,
               #FOSETTLEMENT S,
               #FOSCRIP2 FOSCRIP2
      WHERE    SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
               AND FOSCRIP2.INST_TYPE = S.INST_TYPE
               AND FOSCRIP2.SYMBOL = S.SYMBOL
               AND FOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE
               AND FOSCRIP2.OPTION_TYPE = S.OPTION_TYPE
               AND CONVERT(VARCHAR,S.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103)
               AND FOSCRIP2.MATURITYDATE >= @SDATE
               AND S.PARTY_CODE = C2.PARTY_CODE
      GROUP BY LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) + ' 00:00:00',S.PRICE,S.PARTY_CODE,S.INST_TYPE,
               S.SYMBOL,S.EXPIRYDATE,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),SELL_BUY,
               CONVERT(VARCHAR,S.EXPIRYDATE,103),SEBI_TAX,TURN_TAX,S.EXPIRYDATE,
               S.BILLFLAG,S.STRIKE_PRICE,S.OPTION_TYPE,C2.SERVICE_CHRG,
               C2.SEBI_TURN_TAX,C2.TURNOVER_TAX,C2.BROKERNOTE,S.RESERVED1,
               C2.INSURANCE_CHRG,C2.OTHER_CHRG,S.AUCTIONPART,S.NETRATE,
               FOSCRIP2.MATURITYDATE,NUMERATOR,DENOMINATOR,REGULARLOT,N_NETRATE
               
      TRUNCATE TABLE FOBILLVALAN_TEMP
      
      /* BROUGHT FORWARD TRADES */
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   S.PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO,
               0                                                                                                                                                                                                                                               





                           CONTRACTNO,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
               S.OPTION_TYPE,
               S.STRIKE_PRICE,
               S.AUCTIONPART,
               F.MATURITYDATE,
               SAUDA_DATE = @SDATE + ' 23:59',
               ISIN = '',
               PQTY = SUM(CASE 
                            WHEN SELL_BUY = 1 THEN S.TRADEQTY
                            ELSE 0
                          END),
               SQTY = SUM(CASE 
                            WHEN SELL_BUY = 2 THEN S.TRADEQTY
                            ELSE 0
                          END),
               PRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 1 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY)
                                                                        ELSE 0
                                                                      END)
                                ELSE 0
                              END),4),
               SRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 2 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY)
     ELSE 0
                                                                      END)
                                ELSE 0
                              END),4),
               PAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 1 THEN (S.TRADEQTY * NETRATE * NUMERATOR / DENOMINATOR) + (CASE 
                                                                                                               WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX
                                                                                                               ELSE 0
                                                                                                             END)
                                  ELSE 0
                                END),4),
               SAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 2 THEN (S.TRADEQTY * NETRATE * NUMERATOR / DENOMINATOR) + (CASE 
                                                                                                               WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX
                                                                                                               ELSE 0
                                                                                                             END)
                                  ELSE 0
                                END),4),
               PBROKAMT = 0,
               SBROKAMT = 0,
               PBILLAMT = 0,
               SBILLAMT = 0,
               CL_RATE = 0,
               CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = 0,
               EXSER_TAX = 0,
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = 0,
               TURN_TAX = 0,
               BROKER_NOTE = 0,
               INS_CHRG = 0,
               OTHER_CHRG = 0,
               TRADETYPE = 'BF',
               PARTICIPANTCODE = MEMBERCODE,
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
               STATUSNAME = '',
               EXCHANGE = 'NCE',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
               COMPANYNAME = '',
               REGION = C1.REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
               EMAIL = C1.EMAIL,
               SBU = C2.DUMMY8,
               RELMGR = C2.DUMMY9,
               GRP = C2.DUMMY10,
               SECTOR = '',
               CMCLOSING = 0,
               TRACK = '',
               NUMERATOR,
               DENOMINATOR,
               REGULARLOT,
               C1.AREA
      FROM     FOSCRIP2 F,
               FOSETTLEMENT S,
               FOOWNER,
               CLIENT1 C1,
               CLIENT2 C2
      WHERE    SAUDA_DATE < @SDATE
               AND F.INST_TYPE = S.INST_TYPE
               AND F.SYMBOL = S.SYMBOL
               AND CONVERT(VARCHAR,S.EXPIRYDATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)
               AND F.STRIKE_PRICE = S.STRIKE_PRICE
               AND F.OPTION_TYPE = S.OPTION_TYPE
               AND F.MATURITYDATE >= @SDATE
               AND LTRIM(RTRIM(S.PARTY_CODE)) >= @FPARTY
               AND LTRIM(RTRIM(S.PARTY_CODE)) <= @TPARTY
               AND S.PARTY_CODE = C2.PARTY_CODE
               AND C2.CL_CODE = C1.CL_CODE
               AND S.RESERVED1 <> 1
      GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,F.MATURITYDATE,
               S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE,SHORT_NAME,
               CL_TYPE,BILLNO,AUCTIONPART,SERVICE_CHRG,
               PARTICIPANTCODE,FAMILY,TRADER,BRANCH_CD,
               SUB_BROKER,MEMBERTYPE,MEMBERCODE,DUMMY8,
               DUMMY9,DUMMY10,NUMERATOR,DENOMINATOR,
               REGULARLOT,C1.REGION,C1.AREA,C1.EMAIL
      
      --HAVING SUM(CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END) <> SUM(CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END)           
      
      /* TODAYS TRADE */
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   S.PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO,
               CONTRACTNO,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
               S.OPTION_TYPE,
               S.STRIKE_PRICE,
               S.AUCTIONPART,
               F.MATURITYDATE,
               SAUDA_DATE = @SDATE + ' 23:59',
               ISIN = '',
               PQTY = SUM(CASE 
                            WHEN SELL_BUY = 1 THEN S.TRADEQTY
                            ELSE 0
                          END),
               SQTY = SUM(CASE 
                            WHEN SELL_BUY = 2 THEN S.TRADEQTY
                            ELSE 0
                          END),
               PRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 1 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY)
                                                                        ELSE 0
                                                                      END)
                                ELSE 0
                              END),4),
               SRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 2 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(18,4),S.TRADEQTY)
                                                                        ELSE 0
                                                                      END)
                                ELSE 0
                              END),4),
               PAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 1 THEN (S.TRADEQTY * (PRICE + BROKAPPLIED) * NUMERATOR / DENOMINATOR)
                                  ELSE 0
                                END),4),
               SAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 2 THEN (S.TRADEQTY * (PRICE - BROKAPPLIED) * NUMERATOR / DENOMINATOR)
                                  ELSE 0
                                END),4),
               PBROKAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 1 THEN (S.TRADEQTY * BROKAPPLIED * NUMERATOR / DENOMINATOR)
                                      ELSE 0
                                    END),4),
               SBROKAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 2 THEN (S.TRADEQTY * BROKAPPLIED * NUMERATOR / DENOMINATOR)
                                      ELSE 0
                                    END),4),
               PBILLAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 1 THEN (S.TRADEQTY * (PRICE + BROKAPPLIED) * NUMERATOR / DENOMINATOR)
                    ELSE 0
       END),4),
SBILLAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 2 THEN (S.TRADEQTY * (PRICE - BROKAPPLIED) * NUMERATOR / DENOMINATOR)
                                      ELSE 0
                                    END),4),
               CL_RATE = 0,
               CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = SUM(SERVICE_TAX),
               EXSER_TAX = (CASE 
                              WHEN C2.SERVICE_CHRG = 2 THEN SUM(SERVICE_TAX)
                              ELSE 0
                            END),
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = (CASE 
                             WHEN SEBI_TURN_TAX = 1 THEN SUM(SEBI_TAX)
                             ELSE 0
                           END),
               TURN_TAX = (CASE 
                             WHEN C2.TURNOVER_TAX = 1 THEN SUM(TURN_TAX)
                             ELSE 0
                           END),
               BROKER_NOTE = (CASE 
                                WHEN BROKERNOTE = 1 THEN SUM(BROKER_CHRG)
                                ELSE 0
                              END),
               INS_CHRG = (CASE 
                             WHEN C2.INSURANCE_CHRG = 1 THEN SUM(INS_CHRG)
                             ELSE 0
                           END),
               OTHER_CHRG = 0,
               TRADETYPE = 'BT',
               PARTICIPANTCODE = (CASE 
                                    WHEN S.RESERVED1 = 1 THEN PARTICIPANTCODE
                                    ELSE MEMBERCODE
                                  END),
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
               STATUSNAME = '',
               EXCHANGE = 'NCE',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
               COMPANYNAME = '',
               REGION = C1.REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
               EMAIL = C1.EMAIL,
               SBU = C2.DUMMY8,
               RELMGR = C2.DUMMY9,
               GRP = C2.DUMMY10,
               SECTOR = '',
               CMCLOSING = 0,
               TRACK = '',
               NUMERATOR,
               DENOMINATOR,
               REGULARLOT,
               C1.AREA
      FROM     FOSCRIP2 F,
               FOSETTLEMENT S,
               FOOWNER,
               CLIENT1 C1,
               CLIENT2 C2
      WHERE    SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
               AND F.INST_TYPE = S.INST_TYPE
               AND F.SYMBOL = S.SYMBOL
               AND CONVERT(VARCHAR,S.EXPIRYDATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)
               AND F.STRIKE_PRICE = S.STRIKE_PRICE
               AND F.OPTION_TYPE = S.OPTION_TYPE
               AND F.MATURITYDATE >= @SDATE
               AND LTRIM(RTRIM(S.PARTY_CODE)) >= @FPARTY
               AND LTRIM(RTRIM(S.PARTY_CODE)) <= @TPARTY
               AND S.PARTY_CODE = C2.PARTY_CODE
               AND C2.CL_CODE = C1.CL_CODE
               AND TRADEQTY > 0
      GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,F.MATURITYDATE,
               S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE,SHORT_NAME,
               CL_TYPE,BILLNO,CONTRACTNO,AUCTIONPART,
               SERVICE_CHRG,PARTICIPANTCODE,FAMILY,TRADER,
               BRANCH_CD,SUB_BROKER,MEMBERTYPE,SEBI_TURN_TAX,
               C2.TURNOVER_TAX,BROKERNOTE,MEMBERCODE,RESERVED1,
               DUMMY8,DUMMY9,DUMMY10,NUMERATOR,
               DENOMINATOR,REGULARLOT,INS_CHRG,C2.INSURANCE_CHRG,
               C1.REGION,C1.AREA,C1.EMAIL
               
      /*VOLUMN BASED BROK*/
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   PARTY_CODE = CD_PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO = 0,
               CONTRACTNO = CD_CONTRACT_NO,
       INST_TYPE = CD_INST_TYPE,
               SYMBOL = CD_SYMBOL,
               EXPIRYDATE = CD_EXPIRY_DATE,
               OPTION_TYPE = CD_OPTION_TYPE,
               STRIKE_PRICE = CD_STRIKE_PRICE,
               AUCTIONPART = CD_AUCTIONPART,
               ISNULL(F.MATURITYDATE,'1900-01-01'),
               SAUDA_DATE = CD_SAUDA_DATE + ' 23:59',
               ISIN = '',
               PQTY = 0,
               SQTY = 0,
               PRATE = 0,
               SRATE = 0,
               PAMT = 0,
               SAMT = 0,
               PBROKAMT = SUM(CD_TOT_BUYBROK),
               SBROKAMT = SUM(CD_TOT_SELLBROK),
               PBILLAMT = SUM(CD_TOT_BUYBROK + CD_TOT_SELLBROK),
               SBILLAMT = SUM(0),
               CL_RATE = 0,
               CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = SUM(CD_TOT_SERTAX),
               EXSER_TAX = (CASE 
                              WHEN C2.SERVICE_CHRG = 2 THEN SUM(CD_TOT_SERTAX)
                              ELSE 0
                            END),
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = 0,
               TURN_TAX = 0,
               BROKER_CHRG = 0,
               INS_CHRG = 0,
               OTHER_CHRG = 0,
               TRADETYPE = 'BT',
               PARTICIPANTCODE = MEMBERCODE,
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
               STATUSNAME = 'BRK',
               EXCHANGE = 'NCE',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
               COMPANYNAME = '',
               REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
               EMAIL = C1.EMAIL,
               DUMMY2 = '',
               DUMMY3 = '',
               DUMMY4 = 0,
               DUMMY5 = 0,
               CMCLOSING = 0,
               TRACK = '',
               NUMERATOR,
               DENOMINATOR,
               REGULARLOT,
               C1.AREA
      FROM     CHARGES_DETAIL S
               LEFT OUTER JOIN #FOSCRIP2 F
                 ON (F.INST_TYPE = S.CD_INST_TYPE
                     AND F.SYMBOL = S.CD_SYMBOL
                     AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,S.CD_EXPIRY_DATE,103)
                     AND F.STRIKE_PRICE = S.CD_STRIKE_PRICE
                     AND F.OPTION_TYPE = S.CD_OPTION_TYPE),
               CLIENT1 C1,
               CLIENT2 C2,
               FOOWNER
      WHERE    S.CD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
               AND S.CD_PARTY_CODE = C2.PARTY_CODE
               AND C1.CL_CODE = C2.CL_CODE
      GROUP BY CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_INST_TYPE,
               CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,
               CD_AUCTIONPART,C1.AREA,C1.SHORT_NAME,C1.CL_TYPE,
               F.MATURITYDATE,C2.SERVICE_CHRG,C1.FAMILY,C1.TRADER,
               C1.BRANCH_CD,C1.SUB_BROKER,FOOWNER.MEMBERTYPE,C1.REGION,
               C1.EMAIL,MEMBERCODE,NUMERATOR,DENOMINATOR,
               REGULARLOT
               
      UPDATE FOBILLVALAN_TEMP
      SET    SYMBOL = F.SYMBOL,
             INST_TYPE = F.INST_TYPE,
             EXPIRYDATE = F.EXPIRYDATE,
             STRIKE_PRICE = F.STRIKE_PRICE,
             OPTION_TYPE = F.OPTION_TYPE,
             MATURITYDATE = F.MATURITYDATE
      FROM   #FOSCRIP2 F
      WHERE  FOBILLVALAN_TEMP.SYMBOL = ''
             AND F.SYMBOL = 'BROKERAGE'
                            
      /* TODAYS TRADE */
      IF (SELECT ISNULL(COUNT(PARTY_CODE),0)
          FROM   #FOTMCLCHRG) > 0
        BEGIN
        
          UPDATE FOBILLVALAN_TEMP
          SET    CL_CHRG = ISNULL((SELECT CLEARINGCHARGES
                                   FROM   (SELECT   S.PARTY_CODE,
                                                    S.INST_TYPE,
  S.SYMBOL,
                                           S.OPTION_TYPE,
                                                    S.STRIKE_PRICE,
                                                    S.EXPIRYDATE,
                                                    CLEARINGCHARGES = ISNULL(SUM(CLEARINGCHARGES),0)
                                           FROM     #FOTMCLCHRG C,
                                                    #FOSETTLEMENT S
                                           WHERE    S.PARTY_CODE = C.PARTY_CODE
                                                    AND C.ORDERNO = S.ORDER_NO
                                                    AND C.TRADE_NO = S.TRADE_NO
                                                    AND C.SELL_BUY = S.SELL_BUY
                                                    AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = LEFT(CONVERT(VARCHAR,C.SAUDA_DATE,109),11)
                                                    AND S.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                           GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.OPTION_TYPE,
                                                    S.STRIKE_PRICE,S.EXPIRYDATE) S
                                   WHERE  S.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
                                          AND S.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
                                          AND S.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
                                          AND S.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
                                          AND S.EXPIRYDATE = FOBILLVALAN_TEMP.EXPIRYDATE
                                          AND FOBILLVALAN_TEMP.PARTY_CODE = S.PARTY_CODE),
                                  0)
          WHERE  FOBILLVALAN_TEMP.TRADETYPE = 'BT'
                 AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'

		--EXEC PR_CUT_CHRGS_FROM_BROK @SDATE
                                                                             
          UPDATE FOBILLVALAN_TEMP
          SET    EXCL_CHRG = CL_CHRG
          FROM   FOOWNER
          WHERE  (CLRGCHG = 1
                  AND CHMCLCHRG = 1)
                  OR (CLRGCHG = 4
                      AND CHMCLCHRG = 1)
                  OR (CLRGCHG = 2
                      AND CHMCLCHRG = 0)
                  OR (CLRGCHG = 0
                      AND CHMCLCHRG = 0)
                     AND FOBILLVALAN_TEMP.TRADETYPE = 'BT'
                     AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
        END
        
      UPDATE FOBILLVALAN_TEMP
      SET    PBILLAMT = PQTY * FOCLOSING.CL_RATE * NUMERATOR / DENOMINATOR,
             SBILLAMT = SQTY * FOCLOSING.CL_RATE * NUMERATOR / DENOMINATOR,
             PAMT = PQTY * FOCLOSING.CL_RATE * NUMERATOR / DENOMINATOR,
             SAMT = SQTY * FOCLOSING.CL_RATE * NUMERATOR / DENOMINATOR
      FROM   FOCLOSING
      WHERE  FOCLOSING.TRADE_DATE = (SELECT MAX(TRADE_DATE)
                                     FROM   FOCLOSING
                                     WHERE  FOCLOSING.TRADE_DATE < @SDATE + ' 23:59')
             AND FOCLOSING.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOCLOSING.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
             AND FOCLOSING.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
             AND FOBILLVALAN_TEMP.TRADETYPE = 'BF'
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND FOBILLVALAN_TEMP.INST_TYPE LIKE 'FUT%'
                                                 
      UPDATE FOBILLVALAN_TEMP
      SET    CL_RATE = FOCLOSING.CL_RATE,
             CMCLOSING = FOCLOSING.CL_RATE
      FROM   #FOCLOSINGTODAY FOCLOSING
      WHERE  FOCLOSING.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOCLOSING.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
             AND FOCLOSING.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                                         
      UPDATE FOBILLVALAN_TEMP
      SET    CMCLOSING = FOCLOSING.CL_RATE
      FROM   FOCLOSING
      WHERE  TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND FOBILLVALAN_TEMP.INST_TYPE LIKE 'OPT%'
             AND FOCLOSING.INST_TYPE LIKE 'FUT%'
                                          
      UPDATE FOBILLVALAN_TEMP
      SET    PBILLAMT = (CASE 
                           WHEN PARTICIPANTCODE = MEMBERCODE THEN (CASE 
                                                                     WHEN PBILLAMT - PQTY * CL_RATE *
                                                                      NUMERATOR / DENOMINATOR + SQTY * CL_RATE * NUMERATOR / DENOMINATOR - SBILLAMT > 0 THEN 
                                                                      PBILLAMT - PQTY * CL_RATE * NUMERATOR / DENOMINATOR + SQTY * CL_RATE * NUMERATOR /
                                                                       DENOMINATOR - SBILLAMT
                                                                     ELSE 0
                                                                   END)
                           ELSE PBROKAMT
                         END),
             SBILLAMT = (CASE 
                           WHEN PARTICIPANTCODE = MEMBERCODE THEN (CASE 
                                                                     WHEN PBILLAMT - PQTY * CL_RATE * NUMERATOR / DENOMINATOR + SQTY * CL_RATE * NUMERATOR /
                                                                      DENOMINATOR - SBILLAMT < 0 THEN ABS(PBILLAMT - PQTY * CL_RATE * NUMERATOR / DENOMINATOR + SQTY *
                                                                       CL_RATE * NUMERATOR / DENOMINATOR - SBILLAMT)
                                                                     ELSE 0
                                                                   END)
                           ELSE SBROKAMT
                         END)
      FROM   FOOWNER
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND INST_TYPE LIKE 'FUT%'
                                
      UPDATE FOBILLVALAN_TEMP
      SET    PBILLAMT = PBROKAMT,
             SBILLAMT = SBROKAMT
      FROM   FOOWNER
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND INST_TYPE LIKE 'OPT%'
             AND PARTICIPANTCODE <> MEMBERCODE
                                    
      UPDATE FOBILLVALAN_TEMP
      SET    FAMILYNAME = SHORT_NAME
      FROM   CLIENT1 C1,
             CLIENT2 C2
      WHERE  C1.CL_CODE = C2.CL_CODE
             AND C2.PARTY_CODE = FOBILLVALAN_TEMP.FAMILY
                                 
      DELETE FROM FOBILLVALAN
      WHERE       SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                         
      INSERT INTO FOBILLVALAN
      SELECT *
      FROM   FOBILLVALAN_TEMP
      
	INSERT INTO TBL_MTOMPREMIUMBILL   
	SELECT BILLDATE=CD_SAUDA_DATE,PQTY=0,SQTY=0,NETRATE=0,CL_RATE=0,CD_PARTY_CODE,  
	INST_TYPE='',CD_SYMBOL,EXPIRYDATE='',SDATE=CD_SAUDA_DATE,SELL_BUY=1,SERVICE_TAX=CD_TOT_SERTAX,  
	BROK=CD_TOT_BROK,NONEXPIRYSERVICE_TAX=CD_TOT_SERTAX,NONEXPIRYBROK=CD_TOT_BROK,SEBI_TAX=0,TURN_TAX=0,  
	STAMPDUTY=0,INEX_SERVICE_TAX=0,INEX_SEBI_TAX=0,INEX_TURN_TAX=0,  
	INEX_STAMPDUTY=0,EXPIRYBROK=0,EXPIRYSERVICE_TAX=0,INSURANCE_CHRG=0,  
	INEX_INSURANCE_CHRG=0,OTHER_CHRG=0,INEX_OTHER_CHRG=0,  
	AUCTIONPART='',OPTION_TYPE='',STRIKE_PRICE=0,NETWITHBROK=CD_TOT_BROK,  
	BFDAYFLAG='',RESERVED1=0,ACTBUYQTY=0,ACTSELLQTY=0,CLOSINGRATE=0,NUMERATOR=1,DENOMINATOR=1,REGULARLOT=1  
	FROM CHARGES_DETAIL  
	WHERE CD_SAUDA_DATE LIKE @SDATE + '%'  
	AND CD_SYMBOL = 'BROKERAGE'        
	             
      /*---------------------  POPULATING REPORTING TABLE  START  ---------------------------*/
      DELETE TBL_MTOMPREMIUMBILL_REPORT
      WHERE  BILLDATE < DATEADD(D,-2,GETDATE())
                        
      DELETE TBL_MTOMPREMIUMBILL_REPORT
      WHERE  BILLDATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                  
      INSERT INTO TBL_MTOMPREMIUMBILL_REPORT
      SELECT *
      FROM   TBL_MTOMPREMIUMBILL (NOLOCK)
      WHERE  BILLDATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                  
    /*---------------------  POPULATING REPORTING TABLE  END  ---------------------------*/
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_IDUSER_LIST
-- --------------------------------------------------
CREATE PROC [dbo].[GET_IDUSER_LIST]  
(  
 @IDUSER VARCHAR(30)  
)  
  
AS  
  
SET @IDUSER = UPPER(@IDUSER)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
IF @IDUSER = 'BRANCH'  
 BEGIN  
  SELECT DISTINCT BRANCH_CODE, BRANCH = UPPER(BRANCH) FROM BRANCH (NOLOCK) ORDER BY BRANCH  
 END  
ELSE IF @IDUSER = 'SUBBROKER'  
 BEGIN   
  SELECT DISTINCT SUB_BROKER, NAME = UPPER(NAME) FROM SUBBROKERS (NOLOCK) WHERE SUB_BROKER <> '' AND NAME <> '' ORDER BY NAME   
 END  
ELSE IF @IDUSER = 'TRADER'  
 BEGIN  
 SELECT DISTINCT SHORT_NAME,LONG_NAME FROM BRANCHES (NOLOCK) WHERE SHORT_NAME <> '' AND LONG_NAME <> '' ORDER BY LONG_NAME   
 END  
ELSE IF @IDUSER = 'AREA'  
 BEGIN  
  SELECT DISTINCT AREACODE,DESCRIPTION FROM AREA (NOLOCK) ORDER BY DESCRIPTION  
 END   
ELSE IF @IDUSER = 'REGION'  
 BEGIN  
  SELECT DISTINCT REGIONCODE,DESCRIPTION FROM REGION (NOLOCK) ORDER BY DESCRIPTION  
 END  
ELSE IF @IDUSER = 'FAMILY'  
 BEGIN  
  SELECT DISTINCT FAMILY, FAMILY AS DESCRIPTION FROM MSAJAG.DBO.CLIENT_DETAILS (NOLOCK) WHERE FAMILY <> '' AND FAMILY <> CL_CODE ORDER BY DESCRIPTION  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_MARGIN_LEDGER_NCX
-- --------------------------------------------------

--EXEC GET_MARGIN_LEDGER_NSX 'apr 20 2017' ,'apr 22 2017', '0', 'z', 'BROKER', 'BROKER', ''

CREATE PROCEDURE [dbo].[GET_MARGIN_LEDGER_NCX]
	@FROM_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@FROM_CODE VARCHAR(10),
	@TO_CODE VARCHAR(10),
	@STATUSID VARCHAR(10),
	@STATUSNAME VARCHAR(10),
	@STRBRANCH VARCHAR(10)
AS	

DECLARE
	@BACKDATE VARCHAR(11),
	@EXCHANGE VARCHAR(20)

SET @EXCHANGE = 'nce'

SELECT @BACKDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 109), 109)

CREATE TABLE #GET_MARGIN_REQ
 (VOUDT DATETIME,        
               EFFDT DATETIME,        
               SHORTDESC VARCHAR(100),        
               DRAMT MONEY,        
               CRAMT MONEY,        
               VNO VARCHAR(12),        
               DDNO VARCHAR(20),        
               NARRATION VARCHAR(200),        
               CLTCODE VARCHAR(10),        
               VTYP INT,        
               VDT VARCHAr(10),        
             EDT VARCHAr(10)) 

/*
CREATE TABLE #CL_LIST
(
	PARTY_CODE VARCHAR(10),
	FROMDATE DATETIME,
	TODATE DATETIME,
	CHARGED INT
)

--SELECT * FROM MSAJAG..CLIENT_MARGIN_DATEWISE CD (NOLOCK)

INSERT INTO #CL_LIST
SELECT PARTY_CODE,FROM_DATE,TO_DATE,MARGIN FROM MSAJAG..CLIENT_DETAILS C, (
SELECT * FROM MSAJAG..CLIENT_MARGIN_DATEWISE (NOLOCK) WHERE EXCHANGE = 'NSX' AND SEGMENT = 'FUTURES') CD 
WHERE C.PARTY_CODE = CD.CL_CODE
AND C.PARTY_CODE BETWEEN @FROM_CODE AND @TO_CODE
AND BRANCH_CD LIKE CASE WHEN @STRBRANCH <> '' THEN @STRBRANCH ELSE BRANCH_CD END
AND @STATUSNAME = (CASE 
                    WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                    WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                    WHEN @STATUSID = 'TRADER' THEN TRADER
                    WHEN @STATUSID = 'FAMILY' THEN FAMILY
                    WHEN @STATUSID = 'CLIENT' THEN C.PARTY_CODE
                    ELSE 'BROKER'
                END)
--AND (@FROM_DATE BETWEEN FROM_DATE And TO_DATE Or @TO_DATE BETWEEN FROM_DATE And TO_DATE)
AND ((@FROM_DATE BETWEEN FROM_DATE And TO_DATE Or @TO_DATE BETWEEN FROM_DATE And TO_DATE)
 or (FROM_DATE > @FROM_DATE and TO_DATE < @TO_DATE))

 */

CREATE TABLE #CL_LIST
(
	PARTY_CODE VARCHAR(10)
)

INSERT INTO #CL_LIST
SELECT CL_CODE FROM MSAJAG..CLIENT_DETAILS
WHERE @STATUSNAME = (CASE 
                    WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                    WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                    WHEN @STATUSID = 'TRADER' THEN TRADER
                    WHEN @STATUSID = 'FAMILY' THEN FAMILY
                    WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
                    ELSE 'BROKER'
                END)
AND CL_CODE BETWEEN @FROM_CODE AND @TO_CODE

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = MDATE, 
	EFFDT = MDATE, 
	SHORTDESC = '0IM', DRAMT = SPREADMARGIN,  CRAMT = 0, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-INITIAL MARGIN AS ON'+CONVERT(VARCHAR(11), MDATE, 109),
	CLTCODE = f.PARTY_CODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), MDATE, 103),
    EDT = CONVERT(VARCHAR(10), MDATE, 103)
FROM FOMARGINNEW F, #CL_LIST C
WHERE F.PARTY_CODE = C.PARTY_CODE AND MDATE BETWEEN @FROM_DATE AND @TO_DATE
--AND MDATE BETWEEN FROMDATE AND TODATE
AND F.PARTY_CODE between @FROM_CODE AND @TO_CODE



INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = MDATE, 
	EFFDT = MDATE, 
	SHORTDESC = '0EX', DRAMT = mtom,/*CASE WHEN CHARGED = 0 THEN Mtom ELSE 0 END,*/  CRAMT = 0, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-EXPOSURE MARGIN AS ON'+CONVERT(VARCHAR(11), MDATE, 109),
	CLTCODE = f.PARTY_CODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), MDATE, 103),
    EDT = CONVERT(VARCHAR(10), MDATE, 103)
FROM FOMARGINNEW F, #CL_LIST C
WHERE F.PARTY_CODE = C.PARTY_CODE AND MDATE BETWEEN @FROM_DATE AND @TO_DATE
--AND MDATE BETWEEN FROMDATE AND TODATE
AND F.PARTY_CODE between @FROM_CODE AND @TO_CODE


SELECT ID = (ROW_NUMBER() OVER(ORDER BY START_DATE ASC)), SETT_DATE=START_DATE INTO #TEMP_SETTMST_MARGINCOLL  FROM MSAJAG..SETT_MST WHERE SETT_TYPE = 'N' AND START_DATE>=@FROM_DATE AND START_DATE <= dateadd(D, 5, convert(datetime, @TO_DATE, 109)) +' 23:59' ORDER BY START_DATE ASC 

ALTER TABLE #TEMP_SETTMST_MARGINCOLL
ADD NEW_DATE DATETIME

UPDATE A SET NEW_DATE = (SELECT SETT_DATE FROM #TEMP_SETTMST_MARGINCOLL A1 WHERE A1.ID = A.ID+1)
FROM #TEMP_SETTMST_MARGINCOLL A


INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0IM R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-INITIAL MARGIN REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0IM'

INSERT INTO #GET_MARGIN_REQ (VOUDT, EFFDT, SHORTDESC, DRAMT, CRAMT, VNO, DDNO, NARRATION, CLTCODE, VTYP, VDT, EDT)
SELECT 
	VOUDT = NEW_DATE, 
	EFFDT = NEW_DATE, 
	SHORTDESC = '0EX R', DRAMT = 0,  CRAMT = DRAMT, VNO = '0', DDNO = '0',
	NARRATION = @EXCHANGE+'-EXPOSURE MARGIN REVERSAL OF'+CONVERT(VARCHAR(11), VOUDT, 109),
	CLTCODE,
	VTYP = '8',
	VDT = CONVERT(VARCHAR(10), NEW_DATE, 103),
    EDT = CONVERT(VARCHAR(10), NEW_DATE, 103)
FROM #GET_MARGIN_REQ G,  #TEMP_SETTMST_MARGINCOLL A
WHERE G.VOUDT = A.SETT_DATE AND SHORTDESC = '0EX'

DECLARE
	@MDATE DATETIME

SELECT @MDATE = MAX(MDATE) FROM FOMARGINNEW WHERE MDATE <= @TO_DATE

SELECT * FROM #GET_MARGIN_REQ WHERE EFFDT <= @MDATE AND (DRAMT <> 0 OR CRAMT <> 0)  ORDER BY CLTCODE, VDT, SHORTDESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_OPEN_BILL_DATES
-- --------------------------------------------------

create PROCEDURE [dbo].[GET_OPEN_BILL_DATES]
	@REPORT_DATE VARCHAR(11)
AS

CREATE TABLE #OPEN_BILLS
(
	BILLDATE DATETIME,
	T1_DATES DATETIME,
	T2_DATES DATETIME
)

INSERT INTO #OPEN_BILLS (BILLDATE) 
SELECT MAX(BILLDATE) FROM OPEN_BILL_DATES WHERE BILLDATE <= @REPORT_DATE + ' 23:59'

UPDATE O SET T1_DATES = FUNDS_PAYIN FROM (SELECT FUNDS_PAYIN = MAX(FUNDS_PAYIN) FROM OPEN_BILL_DATES A, #OPEN_BILLS O1 WHERE A.BILLDATE < O1.BILLDATE) B , #OPEN_BILLS O  

UPDATE O SET T2_DATES = FUNDS_PAYIN FROM (SELECT FUNDS_PAYIN = MIN(FUNDS_PAYIN) FROM OPEN_BILL_DATES A, #OPEN_BILLS O1 WHERE A.BILLDATE <= T1_DATES + ' 23:59' AND A.FUNDS_PAYIN >= T1_DATES + ' 23:59') B, #OPEN_BILLS O  

SELECT * FROM #OPEN_BILLS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_PWD_EXPIRY
-- --------------------------------------------------


CREATE PROC GET_PWD_EXPIRY
(
  @UNAME VARCHAR(100)
)
AS
SELECT LTRIM(RTRIM(T.FLDFIRSTNAME)) AS FIRSTNAME,   
 CASE WHEN DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 2  THEN  'THE DAY AFTER TOMORROW'  
 ELSE  
 	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 1  THEN  'TOMORROW'  
 ELSE  
	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 0  THEN  '<U>TODAY</U>'  
 ELSE  
	'ON ' + LEFT(CONVERT(VARCHAR, T.PWD_EXPIRY_DATE, 109), 11)  
END 
END 
END  
 AS PWD_EXPIRY_DATE  
 FROM  
	TBLPRADNYAUSERS T, TBLADMIN A 
 WHERE  
	T.FLDADMINAUTO = A.FLDAUTO_ADMIN  
	AND T.FLDUSERNAME = @UNAME 
	AND GETDATE() <= T.PWD_EXPIRY_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_CATEGORY
-- --------------------------------------------------



CREATE PROC GET_USER_CATEGORY
(
  @FLDCATEGORY INT
)
AS
SELECT FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @FLDCATEGORY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_EDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_EDIT]
(
	@UID	VARCHAR(25),
	@UNAME	VARCHAR(25),
	@CAT	VARCHAR(15),
	@ADMIN_ID INT 
)			
/*
	SELECT * FROM TBLPRADNYAUSERS WHERE FLDCATEGORY = 0
	EXEC GET_USER_EDIT '','', '','2' 
*/
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	(SELECT 
		UPPER(T.FLDUSERNAME) AS FLDUSERNAME, 
		UPPER(T.FLDFIRSTNAME) AS FLDFIRSTNAME, 
		UPPER(T.FLDLASTNAME) AS FLDLASTNAME, 
		T.FLDPHONE1, 
		T.FLDPHONE2, 
		T.FLDAUTO, 
		UPPER(C.FLDCATEGORYNAME) AS FLDCATEGORYNAME 
	FROM  
		TBLPRADNYAUSERS T,TBLCATEGORY C  
	WHERE 
		T.FLDCATEGORY = C.FLDCATEGORYCODE  
		AND  T.FLDADMINAUTO = @ADMIN_ID    
		AND T.FLDUSERNAME LIKE @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
		AND FLDCATEGORY LIKE @CAT +'%' 
	)
	UNION ALL
	(
	SELECT 
		UPPER(FLDUSERNAME),
		UPPER(FLDFIRSTNAME),
		UPPER(FLDLASTNAME),
		FLDPHONE1,
		FLDPHONE2,
		FLDAUTO, 
		FLDCATEGORYNAME = '0'
	FROM 
		TBLPRADNYAUSERS T  
	WHERE 
		FLDADMINAUTO = @ADMIN_ID AND FLDCATEGORY = '0'  
		AND T.FLDUSERNAME LIKE  @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
	)
	ORDER BY 7,1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_FOREDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_FOREDIT]
(
	@FLDAUTO INT
)
AS
/*
GET_USER_FOREDIT 81848
select * from TBLUSERCONTROLMASTER where flduserid = 81848
*/
SELECT 
	T.FLDAUTO,
	FLDUSERNAME,
	FLDPASSWORD,
	FLDFIRSTNAME,
	FLDMIDDLENAME,
	FLDLASTNAME,
	FLDSEX,
	FLDADDRESS1,
	FLDADDRESS2,
	FLDPHONE1,	
	FLDPHONE2,	
	FLDCATEGORY,
	FLDADMINAUTO,
	FLDSTNAME,
	PWD_EXPIRY_DATE,
	TB.FLDPWDEXPIRY,
	TB.FLDMAXATTEMPT,
	TB.FLDATTEMPTCNT,
	TB.FLDSTATUS,
	TB.FLDLOGINFLAG,
	TB.FLDACCESSLVL,
	TB.FLDIPADD,
	TB.FLDFIRSTLOGIN,
	TB.FLDFORCELOGOUT,
	FLD_MAC_ID
FROM 
	TBLPRADNYAUSERS T, TBLUSERCONTROLMASTER TB
WHERE
	T.FLDAUTO = @FLDAUTO  
	AND T.FLDAUTO = FLDUSERID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getdt
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.getdt    Script Date: 1/17/2004 11:42:42 PM ******/








/****** Object:  Stored Procedure dbo.getdt    Script Date: 09/10/2001 6:27:20 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 09/07/2001 10:36:07 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 9/7/01 5:07:23 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 9/7/2001 4:10:06 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 08/10/2001 4:53:42 PM ******/


/****** Object:  Stored Procedure dbo.getdt    Script Date: 8/7/01 4:29:06 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 7/25/01 10:05:59 PM ******/



/****** Object:  Stored Procedure dbo.getdt    Script Date: 6/30/01 11:51:37 AM ******/



/****** Object:  Stored Procedure dbo.getdt    Script Date: 5/26/01 4:17:01 PM ******/


/****** Object:  Stored Procedure dbo.getdt    Script Date: 3/17/01 9:55:52 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 3/21/01 12:50:09 PM ******/

/****** Object:  Stored Procedure dbo.getdt    Script Date: 20-Mar-01 11:38:51 PM ******/


/*Final sql - 07 feb 2001 */
/*Ranjeet Choudhary*/
/*used in nsefo segment*/

CREATE  proc getdt as
 /*Used in NSE FO */ 
 /*Control Name :FoClosing Module Name :CmdEnterRates_Click()*/
 /*Function:This is used get server side date*/
 /*Written By :Ranjeet Choudhary */ 
 select getdate()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getErrorTrd
-- --------------------------------------------------

CREATE  Proc getErrorTrd as

Select Inst_Type,Symbol,Expirydate,Strike_price,Option_type,Party_Code,Trade_No,Order_No,Status
from FOFtTrade  Where Status in (12,17)
and Order_No not In ( Select Order_No From FOTrade)
Order By 1,2,3,4,5,6,7,8

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetProcess
-- --------------------------------------------------
Create Proc GetProcess As
Declare @ProcessIdCur Cursor
Declare @ProcessId  int

Set @ProcessIdCur = Cursor For Select spid from  master.dbo.sysprocesses
  
Open @ProcessIdCur  
Fetch Next From @ProcessIdCur into @ProcessId
While @@Fetch_Status = 0   
   Begin  
			Print  @ProcessId
		 dbcc inputbuffer(@ProcessId) WITH NO_INFOMSGS
		Fetch Next From @ProcessIdCur into @ProcessId
		End  
Close @ProcessIdCur  
DeAllocate @ProcessIdCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getStampDuty_Fixed
-- --------------------------------------------------

create  Proc getStampDuty_Fixed as

SELECT  Left(s.Sauda_date,11) sDate,s.party_code,s.symbol,
(
	CEILING
	(
		MAX (f.broker_note)
	) 
	/
	COUNT(*)

) dutypertrd

INTO #tmpStampDuty_Fixed
	FROM
		fosettlement s, fotaxes f
	WHERE
		s.inst_type = f.inst_type  AND s.symbol = f.symbol
		and LEFT (s.sauda_date,11) BETWEEN f.from_date AND f.to_date
		and f.trans_cat ='TRD'
		and LTRIM (RTRIM (f.basis)) = 'FIXED'
 and TradeQty >0
GROUP BY Left(s.Sauda_date,11) ,s.party_code,s.symbol

Select  sDate,f.Party_Code,  sum(tmp.dutypertrd)  Duty_New, sum(broker_chrg) Duty_Old 
FROM
	fosettlement f, #tmpStampDuty_Fixed tmp
	WHERE
		f.party_code = tmp.party_code and f.symbol=tmp.symbol and
		LEFT(sauda_date,11) =sDate
group by sDate,f.Party_Code
order by sDate,f.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getStampDuty_Qty
-- --------------------------------------------------
Create Proc getStampDuty_Qty as

Select  Left(s.Sauda_date,11) sDate, s.Party_code,s.Symbol,    
(CEILING((Sum(TradeQty)/Max(f.Unit))* Max(f.Broker_Note)) / 
Sum(TradeQty/MarketType)) DutyPerTrd    
into #tmpStampDuty    
 from Fosettlement s, Fotaxes f where     
s.Inst_Type = f.Inst_Type  and s.Symbol = f.Symbol    
and left(s.Sauda_Date,11) between f.From_date and f.To_date    
and f.Trans_cat ='TRD'    
and f.Basis = 'QTY'    
and TradeQty > 0  
Group by Left(s.Sauda_date,11), s.Party_Code,s.Symbol    
    
   
Select  sDate,f.Party_Code, sum((f.TradeQty / f.MarketType) * tmp.DutyPerTrd) Duty_New, sum(broker_chrg) Duty_Old
from fosettlement f,#tmpStampDuty tmp where     
f.Party_Code = tmp.Party_Code and f.Symbol=tmp.Symbol    
and left(sauda_date,11)= sDate
group by sDate,f.Party_Code
order by sDate,f.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.getStampDuty_Value
-- --------------------------------------------------

create  Proc getStampDuty_Value as

Select  Left(s.Sauda_date,11) sDate,s.Party_code,s.Symbol,    
(CEILING(Sum((TradeQty * Price * booktype / instrument ) /f.Unit)) / sum(TradeQty) )  DutyPerTrd    
into #tmpStampDuty2
 from Fosettlement s, Fotaxes f where     
s.Inst_Type = f.Inst_Type  and s.Symbol = f.Symbol    
and left(s.Sauda_Date,11) between f.From_date and f.To_date    
and f.Trans_cat ='TRD'    
and f.Basis = 'VALUE'    
and TradeQty > 0  
Group by  Left(s.Sauda_date,11),s.Party_Code,s.Symbol 

    
Select  sDate,f.Party_Code, sum( tmp.DutyPerTrd * f.TradeQty) Duty_New, sum(broker_chrg) Duty_Old 
from fosettlement f,#tmpStampDuty2 tmp where     
f.Party_Code = tmp.Party_Code and f.Symbol=tmp.Symbol    
and left(sauda_date,11)= sDate
group by sDate,f.Party_Code
order by sDate,f.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GST_SERVICE_TAX_SPLIT
-- --------------------------------------------------

--CREATED UNDER SRE-41845--

CREATE PROC [dbo].[GST_SERVICE_TAX_SPLIT]
AS

DECLARE @SPLITCODE VARCHAR(10)

DECLARE @GSTDATE DATETIME

--SET  @GSTDATE = 'JUN 16 2017'
SET  @GSTDATE = 'NOV 17 2025'

SELECT @SPLITCODE = ACCODE FROM NCE.DBO.VALANACCOUNT
WHERE ACNAME = 'SPLIT TAX'

SELECT VNO, VTYP, BOOKTYPE, VDT, LNO=MAX(LNO) 
INTO #STAXVNO FROM AccountNCE.DBO.LEDGER
WHERE VDT >= @GSTDATE
AND CLTCODE = @SPLITCODE
GROUP BY VNO, VTYP, BOOKTYPE, VDT

SELECT L.Vtyp, L.Vno, L.Edt, L.Lno, L.Acname, L.Drcr, L.Vamt, L.Vdt, L.Vno1, L.Refno, L.Balamt, 
	   L.Nodays, L.Cdt, L.Cltcode, L.Booktype, L.Enteredby, L.Pdt, L.Checkedby, L.Actnodays, L.Narration 
INTO #LEDGER 
FROM AccountNCE.DBO.LEDGER L, #STAXVNO V
WHERE L.VDT >= @GSTDATE 
AND L.VDT = V.VDT
AND L.VNO = V.VNO
AND L.VTYP = V.VTYP
AND L.BOOKTYPE = V.BOOKTYPE

SELECT CLTCODE, VNO,VTYP,BOOKTYPE,RECCNT = COUNT(1) INTO #WRONGDATA 
FROM #LEDGER
WHERE CLTCODE IN (SELECT CLTCODE FROM AccountNCE.DBO.ACMAST WHERE ACCAT = 4)
GROUP BY CLTCODE,VNO,VTYP,BOOKTYPE
HAVING COUNT(1) > 1

DELETE FROM #LEDGER
WHERE EXISTS (SELECT VNO FROM #WRONGDATA
			  WHERE #WRONGDATA.VNO = #LEDGER.VNO
			  AND	#WRONGDATA.VTYP = #LEDGER.VTYP
			  AND   #WRONGDATA.BOOKTYPE = #LEDGER.BOOKTYPE) 

 
SELECT DISTINCT PARTY_CODE, SOURCESTATE = G.STATE, 
				TARGETSTATE = L_STATE, VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
INTO #FINDATA
FROM #LEDGER L, ANGELNSECM.MSAJAG.DBO.TBL_CLIENT_GST_DATA C, ANGELNSECM.MSAJAG.DBO.TBL_GST_LOCATION G
WHERE L.CLTCODE = C.PARTY_CODE
AND C.GST_LOCATION = G.LOC_CODE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

INSERT INTO #FINDATA
SELECT CL_CODE,SOURCESTATE=OWNER.STATE, 
TARGETSTATE=L_STATE,  VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
FROM #LEDGER N, NCE.DBO.FOOWNER OWNER,
ANGELNSECM.MSAJAG.DBO.TBL_STATE_GST_DATA T, NCE.DBO.CLIENT1 G
WHERE  OWNER.State = STATE_NAME
AND VDT BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE   
AND G.CL_CODE NOT IN (SELECT PARTY_CODE FROM #FINDATA WHERE G.CL_CODE = #FINDATA.Party_Code)
AND G.CL_CODE = N.CLTCODE 

UPDATE #FINDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM NCE.DBO.STATE_MASTER WHERE STATE <> 'OTHER')

UPDATE #FINDATA SET
	GST_PER  = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.GST_PER ELSE 0 END),
	CGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.CGST_PER ELSE 0 END),
	SGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 0 THEN S.SGST_PER ELSE 0 END),
	IGST_PER = (CASE WHEN TARGETSTATE <> SOURCESTATE THEN S.IGST_PER ELSE 0 END),
	UGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 1 THEN S.UGST_PER ELSE 0 END),
	STATE_CODE = S.STATE_CODE 
FROM ANGELNSECM.MSAJAG.DBO.TBL_STATE_GST_DATA S
WHERE STATE_NAME = SOURCESTATE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

SELECT L.* INTO #SGSTLED FROM #LEDGER L, #FINDATA F 
WHERE L.VDT = F.VDT 
  AND L.VNO = F.VNO
  AND L.VTYP = F.VTYP
  AND L.BOOKTYPE = L.BOOKTYPE
  AND L.CLTCODE = @SPLITCODE
  AND (SGST_PER + UGST_PER) > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * SGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NCE.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_SGST'
  AND SGST_PER > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * UGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NCE.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_UGST'
  AND UGST_PER > 0
  
UPDATE #LEDGER SET VAMT = #LEDGER.VAMT - F.VAMT
FROM #SGSTLED F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NCE.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_CGST'
  AND CGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NCE.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_IGST'
  AND IGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

INSERT INTO #LEDGER 
SELECT * FROM #SGSTLED

UPDATE #LEDGER SET ACNAME = A.ACNAME
FROM AccountNCE.DBO.ACMAST A 
WHERE A.CLTCODE = #LEDGER.CLTCODE

DECLARE @CRVAMT MONEY
DECLARE @DRVAMT MONEY
DECLARE @CRVAMT_NEW MONEY
DECLARE @DRVAMT_NEW MONEY

SET @CRVAMT = 0 
SET @DRVAMT = 0 
SET @CRVAMT_NEW = 0 
SET @DRVAMT_NEW = 0 

SELECT @CRVAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM AccountNCE.DBO.LEDGER
WHERE VDT >= @GSTDATE
AND EXISTS (SELECT VNO FROM #LEDGER
			  WHERE AccountNCE.DBO.LEDGER.VNO = #LEDGER.VNO
			  AND	AccountNCE.DBO.LEDGER.VTYP = #LEDGER.VTYP
			  AND   AccountNCE.DBO.LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

SELECT @CRVAMT_NEW = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT_NEW = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM #LEDGER 

IF @CRVAMT = @CRVAMT_NEW AND @DRVAMT = @DRVAMT_NEW
BEGIN
	DELETE FROM AccountNCE.DBO.LEDGER
	WHERE VDT >= @GSTDATE
	AND EXISTS (SELECT VNO FROM #LEDGER
				  WHERE AccountNCE.DBO.LEDGER.VNO = #LEDGER.VNO
				  AND	AccountNCE.DBO.LEDGER.VTYP = #LEDGER.VTYP
				  AND   AccountNCE.DBO.LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

	INSERT INTO AccountNCE.DBO.LEDGER
	SELECT Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration 
	FROM #LEDGER 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HistoryToDataNCDX
-- --------------------------------------------------

CREATE Proc [dbo].[HistoryToDataNCDX] (@CutOffDate varchar(11))
AS

Begin
		Insert into  Foclosing
		Select * from Pradnya.dbo.History_Foclosing_Ncdx where Trade_date <= @CutOffDate + ' 23:59:59' 
		Delete from Pradnya.dbo.History_Foclosing_Ncdx where Trade_date <= @CutOffDate +  ' 23:59:59' 
		
		Insert into Foclosing_Billreport 
		Select * from Pradnya.dbo.History_Foclosing_Billreport_Ncdx where Trade_date <= @CutOffDate +  ' 23:59:59' 
		Delete from Pradnya.dbo.History_Foclosing_Billreport_Ncdx where Trade_date <= @CutOffDate +  ' 23:59:59' 
		
		Insert into FoexerciseAllocation 
		Select * from Pradnya.dbo.History_FoexerciseAllocation_Ncdx where Foea_position_date <= @CutOffDate +  ' 23:59:59' 
		Delete from Pradnya.dbo.History_FoexerciseAllocation_Ncdx where Foea_position_date <= @CutOffDate +  ' 23:59:59' 
		
		Insert into Fosettlement 
		Select * from Pradnya.dbo.History_Fosettlement_Ncdx where  Left(Expirydate,11) = @CutOffDate  
		Delete from Pradnya.dbo.History_Fosettlement_Ncdx where  Left(Expirydate,11) = @CutOffDate 

		Delete from Pradnya.Dbo.DataIn_History_Fosettlement_NCDX where Left(Expirydate,11) = @CutOffDate 

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HTTP_REQUEST
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[HTTP_REQUEST]        
(         
@URI varchar(max),         
@response varchar(max) OUT        
)        
AS        
        
DECLARE        
@xhr INT        
,@result INT        
,@httpStatus INT        
,@msg VARCHAR(255),        
@RES_TEXT varchar(max)        
        
EXEC @result = sp_OACreate 'MSXML2.XMLHttp.6.0', @xhr OUT        
        
IF @result <> 0 BEGIN RAISERROR('sp_OACreate on MSXML2.XMLHttp.6.0 failed', 16,1) RETURN         
END        
        
EXEC @result = sp_OAMethod @xhr, 'open', NULL, 'GET', @URI, false        
IF @result <>0 BEGIN RAISERROR('sp_OAMethod Open failed', 16,1) RETURN         
END        
  
EXEC @result = sp_OAMethod @xhr, SEND, NULL, ''        
IF @result <>0 BEGIN RAISERROR('sp_OAMethod SEND failed', 16,1) RETURN         
END        
        
EXEC @result = sp_OAGetProperty @xhr, 'status', @httpStatus OUT        
        
IF @result <>0         
    BEGIN RAISERROR('sp_OAMethod read status failed', 16,1) RETURN         
    END        
        
IF @httpStatus <> 200 BEGIN RAISERROR('sp_OAMethod http status bad', 16,1) RETURN         
END        
        
EXEC @result = sp_OAGetProperty @xhr, 'responseText', @response OUT    
  
--IF @result <>0 BEGIN RAISERROR('sp_OAMethod read response failed', 16,1)   
-- RETURN         
--END        
        
EXEC @result = sp_OADestroy @xhr        
        
  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Index_GetIndexName
-- --------------------------------------------------
CREATE Proc Index_GetIndexName As  
Declare @TableName Varchar(100),  
@CurTbl Cursor,  
@Sql Varchar(150)  
  
Create Table #Tbl_Index  
(Sno Int IDENTITY (1, 1) NOT NULL,  
 IndexName Varchar(100) NOT NULL,  
 TableName Varchar(100) NOT NULL)  
  
Set @CurTbl = Cursor For  
Select Name From Sysobjects   
Where xType = 'U'  
Order By Name   
Open @CurTbl  
Fetch Next from  @CurTbl into @TableName  
While @@Fetch_Status = 0   
Begin  
 Insert Into #Tbl_Index  

      Select i.name, TableName=@TableName
      from (dbo.sysindexes i inner join
         dbo.sysfilegroups s on
         i.groupid = s.groupid )
      where id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
      (INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1) 

   
 Fetch Next from  @CurTbl into @TableName  
End  
Close @CurTbl  
DeAllocate @CurTbl  
  
Select * From #Tbl_Index  
Order By TableName, IndexName

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INS_FOFTTRADE
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[INS_FOFTTRADE] (@INTMODE INT) AS  
  
  IF @INTMODE = 1   
  BEGIN  
      /*TERMINAL FILE*/  
      INSERT INTO FOFTTRADE   
      (TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
      SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,  
      PRO_CLI,PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,  
      ORDER_NO,OPP_BROKER_ID,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
  
      SELECT
        TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,  
        CASE WHEN OPTION_TYPE='XX' THEN '' ELSE OPTION_TYPE END,SEC_NAME,BOOKTYPE,  
        BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID=PARTY_CODE,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,  
        PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,RIGHT(ORDERTIME,8),   
        0,'','','0','0','','',''  
      FROM FOFTTRADE_1_IMP
      
      UPDATE FOFTTRADE SET  Pro_Cli = ISNULL(Pro_Cli,1),O_C_Flag =ISNULL(O_C_Flag,0), C_U_Flag = ISNULL(C_U_Flag,0),
      Booktype = ISNULL(Booktype,0), BooktypeNAME = ISNULL(BooktypeNAME,0) 

  END  
ELSE  IF @INTMODE = 2
 BEGIN  
      /*EXCHANGE FILE*/  
      INSERT INTO FOFTTRADE   
      (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
      SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
      PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
      MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
  
      SELECT
        TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,CASE WHEN OPTION_TYPE='XX' THEN '' ELSE OPTION_TYPE END,SEC_NAME,  
        BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID=PARTY_CODE,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,  
        PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,RIGHT(ORDERTIME,8) ,1,'COVER',   
        0,'','','0','0','','',''  
      FROM FOFTTRADE_2_IMP  
      
      
      TRUNCATE TABLE FOTRADE_CTCLID_TMP      
      INSERT INTO FOTRADE_CTCLID_TMP
      SELECT DISTINCT ACTIVITYTIME,ORDER_NO,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CTCLID
      FROM FOFTTRADE_2_IMP-- WHERE ISNULL(CTCLID,'') <> ''
 END  

ELSE  IF @INTMODE = 4
 BEGIN  
      /*EXCHANGE FILE*/  
	  
      INSERT INTO FOFTTRADE   
      (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
      SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
      PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
      MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
  
      SELECT
        TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,CASE WHEN OPTION_TYPE='XX' THEN '' ELSE OPTION_TYPE END,SEC_NAME,  
        BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID=PARTY_CODE,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,  
        PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,RIGHT(ORDERTIME,8) ,1,'COVER',   
        0,'','','0','0','','',''  
      FROM FOFTTRADE_4_IMP  

 END 
 
 ELSE  IF @INTMODE = 3
 BEGIN  
        /*FTP FILE*/  
        INSERT INTO FOFTTRADE   
        (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
        SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
        PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
        MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
        
        SELECT 
                RIGHT(TRADE_NO,8)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
                '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=S_TRADER,
				BRANCH_ID=S_PARTY_CODE,
                SELL_BUY = 2,
                TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN S_PRO_CLI ='C' THEN 1 ELSE 2 END,  
                PARTY_CODE = S_PARTY_CODE,
                PARTICIPANTCODE = (CASE WHEN S_CONFIRMATION = 'Y' THEN S_PARTICIPANTCODE ELSE S_BROKERCODE END),  
                C_U_FLAG  ,
                ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
                ORDER_NO = S_ORDER_NO , RIGHT(ORDERTIME,8),  
                MARKETTYPE,S_O_C_FLAG,0 SETTFLAG,S_BROKERCODE MEMBERCODE,S_PARTY_CODE TMPARTYCODE,
                0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4, 
                RESERVED5 = CASE WHEN S_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
        FROM FOFTTRADE_3_IMP
        WHERE S_CMCODE <> 'NULL' 

        /*FTP FILE*/  
        INSERT INTO FOFTTRADE   
        (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
        SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
        PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
        MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

        SELECT 
                RIGHT(TRADE_NO,7)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
                '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=B_TRADER,
				BRANCH_ID=B_PARTY_CODE,
                SELL_BUY = 1,
                TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN B_PRO_CLI ='C' THEN 1 ELSE 2 END,  
                PARTY_CODE = B_PARTY_CODE,
                PARTICIPANTCODE = (CASE WHEN B_CONFIRMATION = 'Y' THEN B_PARTICIPANTCODE ELSE B_BROKERCODE END),  
                C_U_FLAG  ,
                ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
                ORDER_NO = B_ORDER_NO ,RIGHT(ORDERTIME,8),  
                MARKETTYPE,B_O_C_FLAG,0 SETTFLAG,B_BROKERCODE MEMBERCODE,B_PARTY_CODE TMPARTYCODE,
                0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4,
                RESERVED5 = CASE WHEN B_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
        FROM FOFTTRADE_3_IMP
        WHERE B_CMCODE <> 'NULL' 
 END 
 
 IF @INTMODE = 5   
  BEGIN  
    -- STANDARD FILE
     INSERT INTO FOFTTRADE   
      (TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
      SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,  
      PRO_CLI,PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,  
      ORDER_NO,OPP_BROKER_ID,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
  
      SELECT
        RIGHT(UnqTradIdr,7)*1 UnqTradIdr,RptdTxSts,FinInstrmTp,TckrSymb,XpryDt,ISNULL(StrkPric,0) STRIKE_PRICE,  
        CASE WHEN OptnTp='XX' THEN '' ELSE OptnTp END,FinInstrmNm,PlcOfTrad,  
        BOOKTYPENAME=SellrTermnlId,MktTpandId,InstgUsr,BrnchId,BuySellInd,TradQty,Pric,ClntTp ,PARTY_CODE=AcctId,  
        CtdnPtcptId ,O_C_FLAG='0',C_U_FLAG='0',ACTIVITYTIME=CONVERT(datetime,TradDtTm01,103),LAST_MOD_TIME=UpdDt,OrdrRef,RIGHT(OrdrDtTm,8),   
        0,'','','0','0','','',''  
      FROM FOTRADE_STANDARD_IMP
      
      UPDATE FOFTTRADE SET  Pro_Cli = ISNULL(Pro_Cli,1),O_C_Flag =ISNULL(O_C_Flag,0), C_U_Flag = ISNULL(C_U_Flag,0),
      Booktype = ISNULL(Booktype,0), BooktypeNAME = ISNULL(BooktypeNAME,0) 

  END  

  
TRUNCATE TABLE FOFTTRADE_1_IMP
TRUNCATE TABLE FOFTTRADE_2_IMP
TRUNCATE TABLE FOFTTRADE_3_IMP
TRUNCATE TABLE FOFTTRADE_4_IMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mtomcheck
-- --------------------------------------------------
create proc mtomcheck as 

select sum(foea_Daily_MTM_Settlement_Value) mtom,
foea_symbol,
foea_expirydate,
foea_party_code
into #aa
from foexerciseallocation
where foea_position_date like 'apr 25 2005%'
and foea_inst_type like 'fut%'
group by foea_symbol,foea_expirydate,foea_party_code
order  by foea_symbol,foea_expirydate,foea_party_code


select sum(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) amt,
symbol,
expirydate,
party_code
into #bb
from fobillvalan
where sauda_date like 'apr 25 2005%'
and inst_type like 'fut%'
group by symbol,expirydate,party_code
order  by symbol,expirydate,party_code


select * from #aa,#bb
where
foea_party_code = party_code
and  foea_symbol = symbol
and foea_expirydate = expirydate
and mtom <> amt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_Bill
-- --------------------------------------------------

CREATE    PROC [dbo].[NCDX_Bill]          
@FBRANCH VARCHAR(10),          
@FSUBBROKER VARCHAR(10),          
@FPARTYCODE VARCHAR(16),          
@TPARTYCODE VARCHAR(16),          
@FDATEFROM  VARCHAR(11),          
@TDATEFROM  VARCHAR(11),          
@STATUSID VARCHAR(15),          
@STATUSNAME VARCHAR(25)          
          
AS          
          
SELECT F.PARTY_CODE,          
F.INST_TYPE ,          
F.SYMBOL ORGSYMBOL,        
F.SYMBOL + CASE WHEN TRADETYPE = 'BF' THEN ' (B-F)' ELSE '' END  SYMBOL,          
CONVERT(VARCHAR(11),F.EXPIRYDATE,109) EXPIRYDATE,          
F.OPTION_TYPE ,          
F.STRIKE_PRICE ,          
QTY_UNIT,          
PRICEUNIT,          
CL_RATE,          
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,        
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,        
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT*F.DENOMINATOR/F.NUMERATOR)/SUM(PQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT*F.DENOMINATOR/F.NUMERATOR)/SUM(PQTY) ELSE

  
    
      
 0 END END AS PRATE,        
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT*F.DENOMINATOR/F.NUMERATOR)/SUM(SQTY) ELSE 0 END ELSE 0 END ELSE CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT*F.DENOMINATOR/F.NUMERATOR)/SUM(SQTY) ELSE

  
    
      
 0 END END AS SRATE,        
BILLNO,          
CONVERT(VARCHAR(11),SAUDA_DATE,103) SAUDA_DATE,          
          
PAMT =  CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END,          
SAMT =  CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END,          
SERVICE_TAX = SUM(F.SERVICE_TAX ),          
SEBI_TAX    = SUM(F.SEBI_TAX),          
TURN_TAX    = SUM(F.TURN_TAX),          
BROKER_NOTE = SUM(F.BROKER_NOTE),          
INSURANCE_CHRG  = SUM(F.INS_CHRG),          
OTHER_CHRG  = SUM(F.OTHER_CHRG) ,        
TRADETYPE =  CASE WHEN TRADETYPE = 'BF' THEN 1 ELSE 2 END         
          
FROM FOBILLVALAN F, CLIENT1 C1 , CLIENT2 C2, FOSCRIP2 FOS2          
          
 WHERE F.SYMBOL = FOS2.SYMBOL AND F.INST_TYPE = FOS2.INST_TYPE           
          
 AND F.EXPIRYDATE = FOS2.EXPIRYDATE AND F.STRIKE_PRICE = FOS2.STRIKE_PRICE           
 AND F.OPTION_TYPE = FOS2.OPTION_TYPE           
 AND F.PARTY_CODE >= @FPARTYCODE AND F.PARTY_CODE <= @TPARTYCODE           
 AND SAUDA_DATE >= @FDATEFROM +' 00:00' AND SAUDA_DATE <=@TDATEFROM + ' 23:59'          
 AND F.PARTY_CODE=C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE           
 AND C2.PRINTF IN(  '0', '3' )           
          
 AND BRANCH_CD LIKE @FBRANCH        
 AND BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)          
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE  '%' END)          
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)          
           
GROUP BY          
F.PARTY_CODE,          
F.INST_TYPE ,          
F.SYMBOL,          
CONVERT(VARCHAR(11),F.EXPIRYDATE,109),          
F.OPTION_TYPE ,          
F.STRIKE_PRICE ,          
QTY_UNIT,          
PRICEUNIT,          
CL_RATE,          
CONVERT(VARCHAR(11),SAUDA_DATE,103),BILLNO,          
SERVICE_TAX,          
SERVICE_CHRG,          
INSURANCE_CHRG,INS_CHRG,SAUDA_DATE,F.EXPIRYDATE,TRADETYPE        
      

        
 ORDER BY YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),F.PARTY_CODE ,F.INST_TYPE,  ORGSYMBOL ,     
 YEAR(F.EXPIRYDATE),  MONTH(F.EXPIRYDATE),DAY(F.EXPIRYDATE),TRADETYPE, F.OPTION_TYPE, F.STRIKE_PRICE, SAUDA_DATE,RIGHT(SAUDA_DATE,7)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_ContractPrint_Digital
-- --------------------------------------------------



CREATE Proc [dbo].[NCDX_ContractPrint_Digital]      
      
@fpartycode varchar(16),          
@tpartycode varchar(16),          
@fdatefrom  varchar(11),          
@tdatefrom  varchar(11),          
@statusid varchar(15),          
@statusname varchar(25),      
@strbranch varchar(12),      
@strsubbrokfrom varchar(12),      
@strsubbrokto varchar(12)          
          

AS          

          
if @strsubbrokto=''      
  begin      
      SET @strsubbrokto='ZZZZZZZZZZ'      
  end      
      
Select order_no = (case when auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 2 then 'Exercise'          
         when auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 1 then 'Assignment'          
         else order_no end),          
 Trade_no, Convert(Varchar,Sauda_Date,108) as TradeTime,Tradeqty,isnull(price,0) Price,          

 brokapplied = isnull(brokapplied + 
               	(case when c2.service_chrg = 1 then isnull(((f.service_tax*instrument/booktype )/TradeQty),0) Else 0 End),0),
 (tradeQty * price) Value,
 Totbrokapplied = isnull((brokapplied * TradeQty * booktype / Instrument)+
		(case when c2.service_chrg = 1 then isnull(f.service_tax,0) Else 0 End),0),

 NetRate = (Case when sell_buy =1 then  
	isnull(netrate +(case when c2.service_chrg = 1 then isnull(((f.service_tax*instrument/booktype)/TradeQty),0) Else 0 End),0) 
 Else 
	isnull(netrate -(case when c2.service_chrg = 1 then isnull(((f.service_tax*instrument/booktype)/TradeQty),0) Else 0 End),0) 
 End), 

 f.inst_type, f.symbol,          

 Amt= abs(case when sell_buy = 1 then (tradeqty * netrate * booktype / instrument) + 
           (case when c2.service_chrg = 1 then isnull((f.service_tax),0) else
             (case when c2.service_chrg = 0 then 0 else
               (case when c2.service_chrg = 2 then 0 else 0 end) end ) end )
 Else (tradeqty * netrate * booktype / instrument) -
          (case when c2.service_chrg = 1 then isnull((f.service_tax),0) else
             (case when c2.service_chrg = 0 then 0 else
               (case when c2.service_chrg = 2 then 0 else 0 end ) end ) end) end ),
  
LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,          
f.party_code,sell_buy,contractno,convert(varchar,sauda_date,103) as sauda_date,          
isnull(f.strike_price,0) strike_price, f.option_type,          
inst_type= (case when f.auctionpart = 'EA' then stuff(f.inst_type,1,3,'EA-') else f.inst_type end ),      
f.symbol,      
f.option_type,      
LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,      
f.strike_price,      
ins_chrg = (case when insurance_chrg=1 then ins_chrg else 0 end),      
broker_chrg= (Case When BrokerNote = 1       
     Then (Broker_chrg)      
     Else 0       
             End) ,      
turn_tax=(Case When Turnover_tax = 1       
     Then (turn_tax)        
     Else 0       
             End),      
service_tax = case when c2.service_chrg=0 then convert(varchar,isnull((f.SERVICE_TAX),0))Else  '0.00' End,      
Qty_Unit,PriceUnit = cast(tradeqty as varchar) + '*' + cast(booktype as varchar) + '/' + cast(instrument as varchar) ,      
isnull(c1.Long_Name,'') as Party_Name,isnull(c1.L_Address1,'') as L_Address1,      
isnull(c1.L_Address2,'') as L_Address2,isnull(c1.L_Address3,'') as L_Address3,isnull(c1.L_city,'') as L_city,      
isnull(c1.L_Zip,'') as L_Zip, isnull(c1.pan_gir_no,'') as pan_gir_no,       
isnull(c1.Res_Phone1,'') as Res_Phone1,isnull(c1.Off_Phone1,'') as Off_Phone1,
case when len(c1.Fax) = 0 then '-' else c1.Fax end as Fax      
          
From fosettlement f, client1 c1 , client2 c2, FoScrip2 fs      
 where f.party_code >= @fpartycode and f.party_code <= @tpartycode           
 And sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'          
 And tradeqty <> 0         
 And f.party_code=c2.party_code and c1.cl_code = c2.cl_code           
 And c1.cl_type <> 'INS' and f.auctionpart not in ('EA','CA','EX')          
 And fs.symbol=f.symbol and fs.expirydate = f.expirydate and fs.inst_type=f.inst_type       
 And f.option_type=fs.option_type and f.strike_price=fs.strike_price      

 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)          
 And sub_broker Like (Case When @statusid = 'subbroker' then @statusname else  '%' end)          
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)          
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)          
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)         
       
      
 Order by f.party_code,f.symbol,year(sauda_date),month(sauda_date),day(sauda_date),f.inst_type,year(f.expirydate),       
month(f.expirydate),day(f.expirydate),order_no,f.option_type, f.strike_price, sell_buy,sauda_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_ContractPrint_PS
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[NCDX_ContractPrint_PS]      
@fBranch varchar(10),      
@fSubBroker varchar(10),      
@fpartycode varchar(16),      
@tpartycode varchar(16),      
@fdatefrom  varchar(11),      
@tdatefrom  varchar(11),      
@statusid varchar(15),      
@statusname varchar(25),      
@PRINTF VARCHAR(6) = 'ALL',            
@DigiFlag VARCHAR(7) = 'ALL'      
      
AS      
      
      
Select order_no = (case when auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 2 then 'Exercise'      
         when auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 1 then 'Assignment'      
         else order_no end),      
 Trade_no, left(Sauda_Date,11) + ' ' + right(Sauda_date,7) as TradeTime,Tradeqty,isnull(price,0) Price,      
 brokapplied = isnull((brokapplied * TradeQty *  booktype / instrument  ),0)  ,      
 Totbrokapplied = isnull((brokapplied * TradeQty *  booktype / instrument  ),0)  ,      
 isnull(netrate,0) netrate, f.inst_type, f.symbol,      
 Amt=(case when sell_buy = 1 then (tradeqty * netrate * booktype / instrument) +       
               (case when c2.service_chrg = 1 then isnull((f.service_tax),0) else      
                  (case when c2.service_chrg = 0 then isnull((f.service_tax),0) else      
                      (case when c2.service_chrg = 2 then 0 else 0 end) end ) end )      
 Else (tradeqty * netrate * booktype / instrument) -      
               (case when c2.service_chrg = 1 then isnull((f.service_tax),0) else      
                   (case when c2.service_chrg = 0 then isnull((f.service_tax),0) else      
                       (case when c2.service_chrg = 2 then 0 else 0 end ) end ) end) end ),      
 LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,      
 f.party_code,sell_buy,contractno,convert(varchar,sauda_date,103) as sauda_date,      
 isnull(f.strike_price,0) strike_price, f.option_type,      
 service_tax =      
        (cASE WHEN c2.service_chrg=0 THEN (f.service_tax) ELSE      
               (CASE WHEN c2.service_chrg=1  THEN 0 ELSE      
                   (cASE WHEN c2.service_chrg=2 THEN  0      
                END) END) END) ,      
         syear=year(sauda_date),smonth=month(sauda_date),sday=day(sauda_date),      
 DFlag = (Case When 'Feb 15 2002' + ' 23:59:59' <= 'Dec 15 2001 23:59:59' Then 0 Else 1 End),      
 f.BookType,f.Instrument, isnull(fos2.priceunit,'') as priceunit , isnull(fos2.qty_unit,'') as qty_unit ,      
 broker_chrg= (Case When BrokerNote = 1       
     Then (Broker_chrg)      
     Else 0       
             End) ,      
 turn_tax=(Case When Turnover_tax = 1       
     Then (turn_tax)        
     Else 0       
             End),      
 Sebi_tax=(Case When Sebi_Turn_tax = 1       
     Then (sebi_tax)        
     Else 0       
             End),      
  Insurance_Chrg = (Case When Insurance_Chrg = 1      
    Then (Ins_chrg)      
   ELse 0      
   End ),       
 FoGlobals.Service_Tax sTax      
 
 into #fosettlement
      
From fosettlement f, client1 c1 , client2 c2, foscrip2 fos2, FoGlobals, DBO.FUN_PRINTF(@PRINTF) P           
 where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type       
 and f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price       
 and f.Option_type = fos2.Option_type       
 and f.party_code >= @fpartycode and f.party_code <= @tpartycode       
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'      
 and tradeqty <> 0 --and c2.printf in(  '0', '3' )       
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code       
 and c1.cl_type <> 'INS' and f.auctionpart not in ('EA','CA','EX')      
 and f.sauda_date between year_start_dt and year_end_dt        
 ANd Branch_cd like @fBranch       
 AND Sub_Broker like @fSubBroker      
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)     
 And region Like (Case When @statusid = 'region' then @statusname else  '%' end)     
 And sub_broker Like (Case When @statusid = 'subbroker' then @statusname else  '%' end)      
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)      
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)      
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)      
 --and c2.printf in(  '0', '3' )      
 And C2.Printf <> '3'       
 AND C2.PRINTF = P.PRINTF               
 AND C2.PRINTF <> (CASE WHEN 'CONTRACT' = 'CONTRACT'                
     THEN 1        
     ELSE 9        
   END)          
 AND 1 = (CASE WHEN @DIGIFLAG = 'ALL'             
   THEN 1             
   ELSE (CASE WHEN C2.PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_ECNBOUNCED T )             
   THEN 1            
   ELSE 0             
   END)            
   END)      
   
update #fosettlement      
SET      
 brokapplied = brokapplied + Case When Sell_Buy =1 then CD_Tot_BuyBrok Else CD_Tot_SellBrok End      
      + (Case When 0 = 1 Then       
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end      
        Else 0 End),      
 Totbrokapplied = Totbrokapplied + Case When Sell_Buy =1 then CD_Tot_BuyBrok Else CD_Tot_SellBrok End      
      + (Case When 0 = 1 Then       
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end      
        Else 0 End),     
 service_tax = service_tax + (Case When 0 = 0 Then       
   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax end      
   Else 0 End)      
FROM      
 CHARGES_DETAIL      
WHERE      
 Convert(Varchar,CD_Sauda_Date,103) = Convert(Varchar,Sauda_Date,103)      
 And CD_Party_Code = Party_Code       
 And CD_Inst_Type = Inst_Type    
 And CD_Symbol = Symbol      
 And Convert(Varchar,CD_Expiry_Date,106) = ExpiryDate      
 And CD_Option_Type = Option_Type      
 And CD_Strike_Price = Strike_Price      
 And CD_Trade_No = Trade_No      
 And CD_Order_No = Order_No    
       
insert into #fosettlement
select order_no='',Trade_no='',TradeTime='',Tradeqty=0,Price=0,CD_Tot_BuyBrok,CD_Tot_BuyBrok,netrate=0,inst_type=CD_inst_type,
symbol=(Case When CD_Symbol = '' Then 'CONT BROK' Else CD_symbol End),Amt=0,expirydate='',cd_party_code,sell_buy=1,CD_contract_no,
convert(varchar,CD_sauda_date,103),strike_price=0,option_type='',
service_tax=CD_Tot_BuySerTax,
yy          =year(CD_sauda_date),       
mm          =month(CD_sauda_date),       
dd          =day(CD_sauda_date),       
DFlag       = 1 ,       
BookType=1,Instrument=1,priceunit='',qty_unit='',broker_chrg=0,turn_tax=0,Sebi_tax=0,Insurance_Chrg=0,sTax=0
from CHARGES_DETAIL
WHERE   
CD_Sauda_Date >= @fdatefrom    
AND CD_Sauda_Date <= @fdatefrom + ' 23:59:59'      
AND CD_party_code     >= @fpartycode       
AND CD_party_code <= @tpartycode      
And CD_Trade_No = ''      
And CD_Tot_BuyBrok > 0   

insert into #fosettlement
select order_no='',Trade_no='',TradeTime='',Tradeqty=0,Price=0,CD_Tot_SellBrok,CD_Tot_SellBrok,netrate=0,inst_type=CD_inst_type,
symbol=(Case When CD_Symbol = '' Then 'CONT BROK' Else CD_symbol End),Amt=0,expirydate='',cd_party_code,sell_buy=2,CD_contract_no,
convert(varchar,CD_sauda_date,103),strike_price=0,option_type='',
service_tax=CD_Tot_SellSerTax,
yy          =year(CD_sauda_date),       
mm          =month(CD_sauda_date),       
dd          =day(CD_sauda_date),       
DFlag       = 1 ,       
BookType=1,Instrument=1,priceunit='',qty_unit='',broker_chrg=0,turn_tax=0,Sebi_tax=0,Insurance_Chrg=0,sTax=0
from CHARGES_DETAIL
WHERE   
CD_Sauda_Date >= @fdatefrom    
AND CD_Sauda_Date <= @fdatefrom + ' 23:59:59'      
AND CD_party_code     >= @fpartycode       
AND CD_party_code <= @tpartycode      
And CD_Trade_No = ''      
And CD_Tot_SellBrok > 0   


 select * from #fosettlement
 order by party_code,contractno ,inst_type, symbol,      
 expirydate, option_type, strike_price, sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_ContractPrint_Sum
-- --------------------------------------------------

/*
Proc name : NCDX_ContractPrint
Segment : NCDX Fut
Desc : To Fetch data for Contract printing (pre printed stationary)
Date : 8 May 2004
Modification Log : 20 jul 04
*/


CREATE  PROCEDURE [dbo].[NCDX_ContractPrint_Sum]
@fpartycode varchar(16),
@tpartycode varchar(16),
@fdatefrom  varchar(12),
@tdatefrom  varchar(12)

AS


Select  Order_no=Min(Order_No),Trade_no=Min(Trade_no), tradetime=Min(LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11)),
	Tradeqty=sum(tradeqty),isnull((sum(price *tradeqty)/sum(tradeqty)),0) Price,

	brokapplied = sum(brokapplied*TradeQty )/sum(TradeQty),

	TotBrokapplied = Sum(isnull((brokapplied * TradeQty *  booktype / instrument) ,0)) ,


	isnull(sum(netrate*tradeqty)/sum(tradeqty),0) Netrate, f.inst_type,f.symbol, 
	LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,f.party_code,sell_buy,contractno,
	convert(varchar,sauda_date,103) as sauda_date, isnull(f.strike_price,0) strike_price, f.option_type,

	Amt = (case when sell_buy = 1 then (sum(tradeqty * netrate * booktype / instrument) +
        (case when c2.service_chrg = 1 then isnull(sum(f.service_tax),0) else
            (case when c2.service_chrg = 0 then 0 else
                (case when c2.service_chrg = 2 then 0 else 0  end ) end) end ) )
       Else (sum(tradeqty * netrate * booktype / instrument) - 
        (case when c2.service_chrg = 1 then isnull(sum(f.service_tax),0) else
            (case when c2.service_chrg = 0 then 0 else
                (case when c2.service_chrg = 2 then 0 else  0 end ) end ) end)) end ),
	service_tax =
        (cASE WHEN c2.service_chrg=0 THEN isnull(sum(f.SERVICE_TAX),0)  ELSE
                     (CASE WHEN c2.service_chrg=1  THEN 0 ELSE
                    (cASE WHEN c2.service_chrg=2 THEN  0
                  END) END) END) ,
	Year (sauda_date), Month(sauda_date),Day(sauda_date),
	DFlag = (Case When 'Feb 15 2002' + ' 23:59:59' <= 'Dec 15 2001 23:59:59' Then 0 Else 1 End),
	f.BookType,f.Instrument, isnull(fos2.priceunit,'') as priceunit , isnull(fos2.qty_unit,'') as qty_unit ,

	broker_note= sum(Case When BrokerNote = 1 
	    Then (Broker_chrg)
	    Else 0 
             End) ,
	turn_tax=sum(Case When Turnover_tax = 1 
	    Then (turn_tax)  
	    Else 0 
             End),
	Sebi_tax=sum(Case When Sebi_Turn_tax = 1 
	    Then (sebi_tax)  
	    Else 0 
             End)

	From fosettlement f, client1 c1 , client2 c2, foscrip2 fos2 
	Where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type AND 
	f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price AND 
	f.Option_type = fos2.Option_type AND 
	f.party_code >= @fpartycode and f.party_code <= @tpartycode and 
	sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@fdatefrom + ' 23:59'
	and tradeqty <> 0 and f.auctionpart not in ('EA','CA','EX')
	and c2.printf in( '2' ,'4') 
	and f.party_code=c2.party_code and c1.cl_code = c2.cl_code and f.auctionpart<>'CA'

	Group by  f.party_code,f.inst_type,f.symbol,f.expirydate,f.option_type,f.strike_price,
	f.sell_buy,c2.service_chrg, convert(varchar,sauda_date,103),Year (sauda_date), Month(sauda_date),
  Day(sauda_date),contractno,f.BookType,f.Instrument, fos2.priceunit , fos2.qty_unit

  Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type, f.symbol, f.expirydate, 
	f.option_type, f.strike_price, sell_buy

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_ContractPrint_Sum_PS
-- --------------------------------------------------
/*      
Proc name : NCDX_ContractPrint      
Segment : NCDX Fut      
Desc : To Fetch data for Contract printing (pre printed stationary)      
Date : 8 May 2004      
Modification Log : 15 Sep 04      
*/      
      
      
CREATE  PROCEDURE NCDX_ContractPrint_Sum_PS      
@fBranch varchar(10),      
@fSubBroker varchar(10),      
@fpartycode varchar(16),      
@tpartycode varchar(16),      
@fdatefrom  varchar(11),      
@tdatefrom  varchar(11),      
@statusid varchar(15),      
@statusname varchar(25)      
      
AS      
      
      
Select  Order_no=Min(Order_No),Trade_no=Min(Trade_no), tradetime=Min(left(Sauda_Date,11) + ' ' + right(Sauda_date,7)),      
 Tradeqty=sum(tradeqty),isnull((sum(price *tradeqty)/sum(tradeqty)),0) Price,      
      
 brokapplied = sum(brokapplied*TradeQty )/sum(TradeQty),      
      
 TotBrokapplied = Sum(isnull((brokapplied * TradeQty *  booktype / instrument) ,0)) ,      
    
        
 isnull(sum(netrate*tradeqty)/sum(tradeqty),0) Netrate, f.inst_type,f.symbol,       
 LEFT(CONVERT(VARCHAR,f.expirydate,106),11) as expirydate,f.party_code,sell_buy,contractno,      
 convert(varchar,sauda_date,103) as sauda_date, isnull(f.strike_price,0) strike_price, f.option_type,      
      
 Amt = (case when sell_buy = 1 then (sum(tradeqty * netrate * booktype / instrument) +      
        (case when c2.service_chrg = 1 then isnull(sum(f.service_tax),0) else      
            (case when c2.service_chrg = 0 then 0 else      
                (case when c2.service_chrg = 2 then 0 else 0  end ) end) end ) )      
       Else (sum(tradeqty * netrate * booktype / instrument) -       
        (case when c2.service_chrg = 1 then isnull(sum(f.service_tax),0) else      
            (case when c2.service_chrg = 0 then 0 else      
                (case when c2.service_chrg = 2 then 0 else  0 end ) end ) end)) end ),      
 service_tax =      
        (cASE WHEN c2.service_chrg=0 THEN isnull(sum(f.SERVICE_TAX),0)  ELSE      
                     (CASE WHEN c2.service_chrg=1  THEN 0 ELSE      
                    (cASE WHEN c2.service_chrg=2 THEN  0      
                  END) END) END) ,      
 Year (sauda_date), Month(sauda_date),Day(sauda_date),      
 DFlag = (Case When 'Feb 15 2002' + ' 23:59:59' <= 'Dec 15 2001 23:59:59' Then 0 Else 1 End),      
 f.BookType,f.Instrument, isnull(fos2.priceunit,'') as priceunit , isnull(fos2.qty_unit,'') as qty_unit ,      
      
 broker_chrg= sum(Case When BrokerNote = 1       
     Then (Broker_chrg)      
     Else 0       
             End) ,      
 turn_tax=sum(Case When Turnover_tax = 1       
     Then (turn_tax)        
     Else 0       
             End),      
 Sebi_tax=sum(Case When Sebi_Turn_tax = 1       
     Then (sebi_tax)        
     Else 0       
             End),      
  Insurance_Chrg = sum(Case When Insurance_Chrg = 1      
    Then (Ins_chrg)      
   ELse 0      
   End ),       
 FoGlobals.Service_Tax sTax      
      
 From fosettlement f, client1 c1 , client2 c2, foscrip2 fos2,FoGlobals        
 Where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type AND       
 f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price AND       
 f.Option_type = fos2.Option_type AND       
 f.party_code >= @fpartycode and f.party_code <= @tpartycode       
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'      
 and tradeqty <> 0 and f.auctionpart not in ('EA','CA','EX')      
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code and f.auctionpart<>'CA'      
 and f.sauda_date between year_start_dt and year_end_dt      
 AND Branch_Cd Like @fBranch      
 And sub_broker Like @fSubBroker      
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)      
 And sub_broker Like (Case When @statusid = 'subbroker' then @statusname else  '%' end)      
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)      
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)      
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)      
 --and c2.printf in( '2' ,'4')       
      
      
 Group by  f.party_code,f.inst_type,f.symbol,f.expirydate,f.option_type,f.strike_price,      
 f.sell_buy,c2.service_chrg, convert(varchar,sauda_date,103),Year (sauda_date), Month(sauda_date),      
 Day(sauda_date),contractno,f.BookType,f.Instrument, fos2.priceunit , fos2.qty_unit,FoGlobals.service_tax,      
-- f.sauda_date,
right(f.Sauda_date,7)      
      
  Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type, f.symbol, year(f.expirydate),       
 month(f.expirydate),day(f.expirydate),f.option_type, f.strike_price, sell_buy,f.sauda_date,right(f.Sauda_date,7)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCDX_Digital_Bill
-- --------------------------------------------------

--sp_helptext NCDX_Digital_Bill


CREATE  PROC [dbo].[NCDX_Digital_Bill]        
    
@fpartycode varchar(16),        
@tpartycode varchar(16),        
@fdatefrom  varchar(11),        
@tdatefrom  varchar(11),        
@statusid varchar(15),        
@statusname varchar(25),    
@strbranch varchar(12),    
@strsubbrokfrom varchar(12),    
@strsubbrokto varchar(12)        
        
                
AS                
                
SET TRANSACTION ISOLATION LEVEL    READ UNCOMMITTED    
    
if @strsubbrokto=''    
  begin    
      SET @strsubbrokto='ZZZZZZZZZZ'    
  end    
          
SELECT f.PARTY_CODE,                
f.INST_TYPE ,                
f.SYMBOL OrgSymbol,              
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                
convert(varchar(11),f.expirydate,109) expirydate,                
f.option_type ,                
f.strike_price ,                
cl_rate,                
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else          
            
 0 End End AS prate,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else          
            
 0 End End AS srate,              
billno,                
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                
                
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                
service_tax = sum(f.service_tax ),                
sebi_tax    = Sum(f.sebi_tax),                
turn_tax    = Sum(f.turn_tax),                
broker_note = Sum(f.broker_note),                
Insurance_Chrg  = Sum(f.ins_chrg),                
other_chrg  = Sum(f.other_chrg) ,              
TradeType =  Case When TradeType = 'BF' then 1 else 2 end             
          
into #temp          
          
From FoBillValan f, client1 c1 , client2 c2, foscrip2 fos2
                
where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type                 
                
 and f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price                 
 and f.Option_type = fos2.Option_type                 
 and f.party_code >= @fpartycode and f.party_code <= @tpartycode                 
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code                 
       
                
group by                
f.PARTY_CODE,                
f.INST_TYPE ,                
f.SYMBOL,                
convert(varchar(11),f.expirydate,109),                
f.option_type ,                
f.strike_price ,                
cl_rate,                
convert(varchar(11),SAUDA_DATE,103),billno,                
Service_chrg,                
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType          
    
    
Having (  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End > 0   
 or   
 Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End > 0 )  
          
Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type,  OrgSymbol ,              
 year(f.expirydate),  month(f.expirydate),day(f.expirydate),TradeType, f.option_type, f.strike_price, sauda_date,right(Sauda_date,7)                 
          
                
  
Select    
  
isnull(c1.Long_Name,'') as Party_Name,isnull(c1.L_Address1,'') as L_Address1,  
isnull(c1.L_Address2,'') as L_Address2,isnull(c1.L_Address3,'') as L_Address3,isnull(c1.L_city,'') as L_city,  
isnull(c1.L_Zip,'') as L_Zip, isnull(c1.pan_gir_no,'') as pan_gir_no,   
isnull(c1.Res_Phone1,'') as Res_Phone1,isnull(c1.Off_Phone1,'') as Off_Phone1 , c2.party_code   , Branch_cd,Sub_Broker
      
into #Client      
      
From       
Client1 C1,Client2 C2,Owner      
Where       
 C1.Cl_Code =c2.Cl_Code and       
 party_code >= @fpartycode and party_code <= @tpartycode                 
  
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)      
 And sub_broker Like (Case When @statusid = 'subbroker' then @statusname else  '%' end)      
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)      
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)      
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)     
     
      
  
select   
#temp.PARTY_CODE,  INST_TYPE , OrgSymbol,Symbol,  expirydate, option_type ,                
strike_price , cl_rate, pqty,  sqty,   prate,  srate,   billno,                
SAUDA_DATE, pamt, samt, service_tax ,sebi_tax , turn_tax ,  
Branch_Cd + '/' + Sub_Broker + '/' + #Client.Party_Code   Party_NameToPrint

,L_Address1,L_Address2,L_Address3,L_city,  

L_Zip, pan_gir_no, Res_Phone1, Off_Phone1,Branch_cd    
   
from #Client , #temp  , FoOwner
  
where #Client.party_code = #temp.party_code


-- select * from foglobals

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCE_Digital_Bill
-- --------------------------------------------------

CREATE PROC [dbo].[NCE_Digital_Bill]
      
@fpartycode varchar(16),          
@tpartycode varchar(16),          
@fdatefrom  varchar(11),          
@tdatefrom  varchar(11),          
@statusid varchar(15),          
@statusname varchar(25),      
@strbranch varchar(12),      
@strsubbrokfrom varchar(12),      
@strsubbrokto varchar(12)          
          
AS
                  
SET TRANSACTION ISOLATION LEVEL    READ UNCOMMITTED      

set @strbranch = upper(ltrim(rtrim(@strbranch)))
if len(@strbranch) = 0 set @strbranch = '%'

if @strsubbrokto=''      
  begin      
      SET @strsubbrokto='ZZZZZZZZZZ'      
  end      
            
SELECT f.PARTY_CODE,                  
f.INST_TYPE ,                  
f.SYMBOL OrgSymbol,                
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                  
convert(varchar(11),f.expirydate,109) expirydate,                  
f.option_type ,                  
f.strike_price ,                  
cl_rate,                  
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,                
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,                
Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 



      
 0 End End AS prate,              
Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 



  
    
0 End End AS srate,              
billno,                  
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                  
                  
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                  
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                  
service_tax = sum(f.service_tax ),                  
sebi_tax    = Sum(f.sebi_tax),                  
turn_tax    = Sum(f.turn_tax),                  
broker_note = Sum(f.broker_note),                  
Insurance_Chrg  = Sum(f.ins_chrg),                  
other_chrg  = Sum(f.other_chrg) ,                
TradeType =  Case When TradeType = 'BF' then 1 else 2 end  ,  
Sum(SBrokAmt + PBrokAmt) TotBrok  
            
into #temp            
            
From FoBillValan f, client1 c1 , client2 c2, foscrip2 fos2                  
                  
 where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type                   
                  
 and f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price                   
 and f.Option_type = fos2.Option_type                   
 and f.party_code >= @fpartycode and f.party_code <= @tpartycode                   
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                  
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code                   

                  
group by                  
f.PARTY_CODE,                  
f.INST_TYPE ,                  
f.SYMBOL,                  
convert(varchar(11),f.expirydate,109),                  
f.option_type ,                  
f.strike_price ,                  
cl_rate,                  
convert(varchar(11),SAUDA_DATE,103),billno,                  
Service_Tax,                  
Service_chrg,                  
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType            
/** Changes Start under SRE-28872 *****/
UNION ALL

SELECT f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL OrgSymbol,                  
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                    
convert(varchar(11),f.expirydate,109) expirydate,                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,                  
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,                  
Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 
  
  
  
  
        
 0 End End AS prate,                
Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 
  
      
0 End End AS srate,                
billno,                    
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                    
                    
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                    
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                    
service_tax = sum(f.service_tax ),                    
sebi_tax    = Sum(f.sebi_tax),                    
turn_tax    = Sum(f.turn_tax),                    
broker_note = Sum(f.broker_note),                    
Insurance_Chrg  = Sum(f.ins_chrg),                    
other_chrg  = Sum(f.other_chrg) ,                  
TradeType =  Case When TradeType = 'BF' then 1 else 2 end  ,    
Sum(SBrokAmt + PBrokAmt) TotBrok    
From FoBillValan f, client1 c1 , client2 c2                    
 where                     
f.party_code >= @fpartycode and f.party_code <= @tpartycode                     
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                    
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code    AND Symbol like 'Brok%'                   
group by                    
f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL,                    
convert(varchar(11),f.expirydate,109),                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
convert(varchar(11),SAUDA_DATE,103),billno,                    
Service_Tax,                    
Service_chrg,                    
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType   

/** Changes Done *****/
        
/*Having (  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End > 0       
 or       
 Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End > 0 )      
 */  
             
--Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type,  OrgSymbol ,      
-- year(f.expirydate),  month(f.expirydate),day(f.expirydate),TradeType, f.option_type, f.strike_price, sauda_date,right(Sauda_date,7)                     
              
 update  t  
 set t.BillNo=f.bill_no  
 from #temp t ,foaccbill f   
 where t.Party_Code=f.Party_Code  
 and convert(varchar(11),SAUDA_DATE,103)=convert(varchar(11),f.BillDate,103)          
      
Select        
      
isnull(c1.Long_Name,'') as Party_Name,isnull(c1.L_Address1,'') as L_Address1,      
isnull(c1.L_Address2,'') as L_Address2,isnull(c1.L_Address3,'') as L_Address3,isnull(c1.L_city,'') as L_city,      
isnull(c1.L_Zip,'') as L_Zip, isnull(c1.pan_gir_no,'') as pan_gir_no,       
isnull(c1.Res_Phone1,'') as Res_Phone1,isnull(c1.Off_Phone1,'') as Off_Phone1 , c2.party_code   , Branch_cd,Sub_Broker    
          
into #Client          
          
From           
Client1 C1,Client2 C2,Owner          
Where           
 C1.Cl_Code =c2.Cl_Code and           
 party_code >= @fpartycode and party_code <= @tpartycode                     
   and party_code in (select distinct party_code from #temp (nolock))   
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)          
 And sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)          
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)          
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)          
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)         
         
          
--Truncate table ncdx_aws_digital_bill  
--insert  into ncdx_aws_digital_bill           
select       
#temp.PARTY_CODE,  INST_TYPE , OrgSymbol,Symbol,  expirydate, option_type ,                    
strike_price , cl_rate, pqty,  sqty,   prate,  srate,   billno,                    
SAUDA_DATE, pamt, samt, service_tax ,sebi_tax , turn_tax ,      
broker_note ,Insurance_Chrg , other_chrg,TradeType ,  Party_Name,TotBrok,         
 Branch_Cd + '/' + Sub_Broker + '/' + #Client.Party_Code  Party_NameToPrint    
    
,L_Address1,L_Address2,L_Address3,L_city,      
    
L_Zip, pan_gir_no, Res_Phone1, Off_Phone1,Branch_cd,sub_broker,pcode = #Client.Party_Code    
       
from #Client , #temp  , FoOwner    
      
where  
 #Client.party_code = #temp.party_code and  
 #Client.Branch_cd like @strbranch  
   
order by pcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCE_Digital_Bill_aws
-- --------------------------------------------------


  --Created SP under SRE-30720
CREATE PROC [dbo].[NCE_Digital_Bill_aws]  
        
@fpartycode varchar(16),            
@tpartycode varchar(16),            
@fdatefrom  varchar(11),            
@tdatefrom  varchar(11),            
@statusid varchar(15),            
@statusname varchar(25),        
@strbranch varchar(12),        
@strsubbrokfrom varchar(12),        
@strsubbrokto varchar(12)            
            
AS  
                    
SET TRANSACTION ISOLATION LEVEL    READ UNCOMMITTED        
  
set @strbranch = upper(ltrim(rtrim(@strbranch)))  
if len(@strbranch) = 0 set @strbranch = '%'  
  
if @strsubbrokto=''        
  begin        
      SET @strsubbrokto='ZZZZZZZZZZ'        
  end        
              
SELECT f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL OrgSymbol,                  
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                    
convert(varchar(11),f.expirydate,109) expirydate,                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,                  
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,                  
Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 
  
  
  
  
        
 0 End End AS prate,                
Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 
  
  
  
  
    
      
0 End End AS srate,                
billno,                    
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                    
                    
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                    
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                    
service_tax = sum(f.service_tax ),                    
sebi_tax    = Sum(f.sebi_tax),                    
turn_tax    = Sum(f.turn_tax),                    
broker_note = Sum(f.broker_note),                    
Insurance_Chrg  = Sum(f.ins_chrg),                    
other_chrg  = Sum(f.other_chrg) ,                  
TradeType =  Case When TradeType = 'BF' then 1 else 2 end  ,    
Sum(SBrokAmt + PBrokAmt) TotBrok    
              
into #temp              
              
From FoBillValan f, client1 c1 , client2 c2, foscrip2 fos2                    
                    
 where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type                     
                    
 and f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price                     
 and f.Option_type = fos2.Option_type                     
 and f.party_code >= @fpartycode and f.party_code <= @tpartycode                     
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                    
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code                     
  
                    
group by                    
f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL,                    
convert(varchar(11),f.expirydate,109),                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
convert(varchar(11),SAUDA_DATE,103),billno,                    
Service_Tax,                    
Service_chrg,                    
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType    
/** Changes Start under SRE-28872 *****/
UNION ALL

SELECT f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL OrgSymbol,                  
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                    
convert(varchar(11),f.expirydate,109) expirydate,                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,                  
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,                  
Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty) Else 
  
  
  
  
        
 0 End End AS prate,                
Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty) Else 
  
  
  
  
    
      
0 End End AS srate,                
billno,                    
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                    
                    
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                    
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                    
service_tax = sum(f.service_tax ),                    
sebi_tax    = Sum(f.sebi_tax),                    
turn_tax    = Sum(f.turn_tax),                    
broker_note = Sum(f.broker_note),                    
Insurance_Chrg  = Sum(f.ins_chrg),                    
other_chrg  = Sum(f.other_chrg) ,                  
TradeType =  Case When TradeType = 'BF' then 1 else 2 end  ,    
Sum(SBrokAmt + PBrokAmt) TotBrok    
From FoBillValan f, client1 c1 , client2 c2                    
 where                     
f.party_code >= @fpartycode and f.party_code <= @tpartycode                     
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                    
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code    AND Symbol like 'Brok%'                   
group by                    
f.PARTY_CODE,                    
f.INST_TYPE ,                    
f.SYMBOL,                    
convert(varchar(11),f.expirydate,109),                    
f.option_type ,                    
f.strike_price ,                    
cl_rate,                    
convert(varchar(11),SAUDA_DATE,103),billno,                    
Service_Tax,                    
Service_chrg,                    
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType   

/** Changes Start End *****/
        
/*Having (  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End > 0       
 or       
 Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End > 0 )      
 */  
             
--Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type,  OrgSymbol ,      
-- year(f.expirydate),  month(f.expirydate),day(f.expirydate),TradeType, f.option_type, f.strike_price, sauda_date,right(Sauda_date,7)                     
              
 update  t  
 set t.BillNo=f.bill_no  
 from #temp t ,foaccbill f   
 where t.Party_Code=f.Party_Code  
 and convert(varchar(11),SAUDA_DATE,103)=convert(varchar(11),f.BillDate,103)          
      
Select        
      
isnull(c1.Long_Name,'') as Party_Name,isnull(c1.L_Address1,'') as L_Address1,      
isnull(c1.L_Address2,'') as L_Address2,isnull(c1.L_Address3,'') as L_Address3,isnull(c1.L_city,'') as L_city,      
isnull(c1.L_Zip,'') as L_Zip, isnull(c1.pan_gir_no,'') as pan_gir_no,       
isnull(c1.Res_Phone1,'') as Res_Phone1,isnull(c1.Off_Phone1,'') as Off_Phone1 , c2.party_code   , Branch_cd,Sub_Broker    
          
into #Client          
          
From           
Client1 C1,Client2 C2,Owner          
Where           
 C1.Cl_Code =c2.Cl_Code and           
 party_code >= @fpartycode and party_code <= @tpartycode                     
   and party_code in (select distinct party_code from #temp (nolock))   
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)          
 And sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)          
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)          
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)          
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)         
         
          
Truncate table nce_aws_digital_bill  
insert  into nce_aws_digital_bill           
select       
#temp.PARTY_CODE,  INST_TYPE , OrgSymbol,Symbol,  expirydate, option_type ,                    
strike_price , cl_rate, pqty,  sqty,   prate,  srate,   billno,                    
SAUDA_DATE, pamt, samt, service_tax ,sebi_tax , turn_tax ,      
broker_note ,Insurance_Chrg , other_chrg,TradeType ,  Party_Name,TotBrok,         
 Branch_Cd + '/' + Sub_Broker + '/' + #Client.Party_Code  Party_NameToPrint    
    
,L_Address1,L_Address2,L_Address3,L_city,      
    
L_Zip, pan_gir_no, Res_Phone1, Off_Phone1,Branch_cd,sub_broker,pcode = #Client.Party_Code    
       
from #Client , #temp  , FoOwner    
      
where  
 #Client.party_code = #temp.party_code and  
 #Client.Branch_cd like @strbranch  
   
order by pcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWVALANSUMMARY_FO
-- --------------------------------------------------

CREATE   PROC [dbo].[NEWVALANSUMMARY_FO]    
/*    
 EXEC NEWVALANSUMMARY '2006070', 'N', 'APR  1 2006', 'O', 'CLIENT', 'ME123'    
 L.Cltcode    
 A.Acname    
 Dramt    
 Cramt    
 Vdt    
 ClBal    
*/    
 @BILLDATE VARCHAR(11),    
 @VDT VARCHAR(11),    
 @DISPOPT VARCHAR(1),    
 @STATUSID VARCHAR(10),    
 @STATUSNAME VARCHAR(30)    
    
AS    
--SELECT * FROM FOACCBILL    
IF @STATUSID <> 'BROKER'    
 BEGIN    
  SELECT     
   CLTCODE = C2.PARTY_CODE,     
   ACNAME = C1.LONG_NAME,     
   DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,     
   CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,    
   VDT = @VDT,     
   CLBAL = 0    
  FROM     
   FOACCBILL A, CLIENT1 C1, CLIENT2 C2    
  WHERE     
   C1.CL_CODE = C2.CL_CODE     
   AND C2.PARTY_CODE = A.PARTY_CODE    
   AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE    
   AND @STATUSNAME =     
    (    
     CASE    
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD    
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER    
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER    
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY    
      WHEN @STATUSID = 'AREA' THEN C1.AREA    
      WHEN @STATUSID = 'REGION' THEN C1.REGION    
      WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE    
     ELSE    
      'BROKER'    
     END    
    )    
  ORDER BY    
   C2.PARTY_CODE    
 END    
ELSE    
 BEGIN    
  IF @DISPOPT = 'A'    
   BEGIN    
    SELECT     
     CLTCODE = A.PARTY_CODE,     
     ACNAME = M.LONGNAME,     
     DRAMT = SUM(CASE WHEN A.SELL_BUY = 1 THEN A.AMOUNT ELSE 0 END),     
     CRAMT = SUM(CASE WHEN A.SELL_BUY = 2 THEN A.AMOUNT ELSE 0 END),    
     VDT = @VDT,     
     CLBAL = 0    
    FROM     
     FOACCBILL A, ACCOUNTNCE.DBO.ACMAST M    
    WHERE     
     A.PARTY_CODE = M.CLTCODE    
     AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE    
     AND ((A.BRANCHCD <> 'ZZZ' And M.Accat =4) OR  (A.BRANCHCD = 'ZZZ' And M.Accat <>4))
    GROUP BY    
     A.PARTY_CODE,    
     M.LONGNAME    
    ORDER BY    
     A.PARTY_CODE    
   END    
  ELSE IF @DISPOPT = 'P'    
   BEGIN    
    SELECT     
     CLTCODE = C2.PARTY_CODE,     
     ACNAME = C1.LONG_NAME,     
     DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,     
     CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,    
     VDT = @VDT,     
     CLBAL = 0    
    FROM     
     FOACCBILL A, CLIENT1 C1, CLIENT2 C2    
    WHERE     
     C1.CL_CODE = C2.CL_CODE     
     AND C2.PARTY_CODE = A.PARTY_CODE    
     AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE    
    ORDER BY    
     C2.PARTY_CODE    
   END    
  ELSE    
   BEGIN    
    SELECT     
     CLTCODE = PARTY_CODE, ACNAME = LONG_NAME, DRAMT = SUM(DRAMT), CRAMT = SUM(CRAMT), VDT, CLBAL = SUM(CLBAL)    
    FROM    
     (    
      SELECT     
       A.PARTY_CODE,     
       LONG_NAME = M.LONGNAME,     
       DRAMT = SUM(CASE WHEN A.SELL_BUY = 1 THEN A.AMOUNT ELSE 0 END),     
       CRAMT = SUM(CASE WHEN A.SELL_BUY = 2 THEN A.AMOUNT ELSE 0 END),    
       VDT = @VDT,     
       CLBAL = 0    
      FROM     
       FOACCBILL A, ACCOUNTNCE.DBO.ACMAST M    
      WHERE     
       A.PARTY_CODE = M.CLTCODE    
       AND M.ACCAT NOT IN (4, 14)    
       AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE    
       AND A.BRANCHCD = 'ZZZ'    
      GROUP BY    
       A.PARTY_CODE,    
       M.LONGNAME    
      UNION ALL    
      SELECT     
       PARTY_CODE = '',    
       LONG_NAME = 'CLIENT SUMMARY',     
       DRAMT = CASE WHEN A.SELL_BUY = 1 THEN AMOUNT ELSE 0 END,     
       CRAMT = CASE WHEN A.SELL_BUY = 2 THEN AMOUNT ELSE 0 END,    
       VDT = @VDT,     
       CLBAL = 0    
      FROM     
       FOACCBILL A, CLIENT1 C1, CLIENT2 C2    
      WHERE     
       C1.CL_CODE = C2.CL_CODE     
       AND C2.PARTY_CODE = A.PARTY_CODE    
       AND CONVERT(VARCHAR(11), A.BILLDATE, 109) = @BILLDATE    
     ) A    
    GROUP BY    
     PARTY_CODE, LONG_NAME, VDT    
   END    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NSE_SCRIPUPLOAD
-- --------------------------------------------------

CREATE  PROC NSE_SCRIPUPLOAD (@FilePath Varchar(100)) AS

Select * into TempScrip2 From Scrip2 

Select * into TempScrip1 From Scrip1 

TRUNCATE TABLE Scrip_IMP
TRUNCATE TABLE Scrip1
TRUNCATE TABLE Scrip2
TRUNCATE TABLE COMPANY

SELECT SCRIP_CD=CONVERT(VARCHAR(12),''),
SERIES=CONVERT(VARCHAR(3),''),
SCRIP_NAME=CONVERT(VARCHAR(50),''),
FILLER1=CONVERT(VARCHAR(12),''),
ISIN=CONVERT(VARCHAR(12),'')
INTO #Scrip_imp

--Bulk insert #Scrip_imp from @FilePath with  ( FIELDTERMINATOR = ',', ROWTERMINATOR = '\n' ) 
EXEC Proc_Bulk_Ins '#Scrip_imp', @FilePath, ','

INSERT INTO Scrip_imp
SELECT * FROM #Scrip_imp

INSERT INTO Scrip_imp
Select Distinct Scrip_Cd, S2.Series, Long_Name, FILLER1='', ISIN  from TempScrip1 S1, TempScrip2 S2
Where S1.Co_Code = S2.Co_Code And S1.Series = S2.Series
And Scrip_Cd not in ( Select Scrip_cd From Scrip_imp 
Where Scrip_imp.Scrip_Cd = S2.Scrip_Cd AND Scrip_imp.Series = S2.Series )

Insert Into Company 
Select Sno, Left(SCRIP_NAME,20),SCRIP_NAME,'','','','','','','','','','','','' 
From Scrip_imp

Insert Into Scrip1 
Select Sno, Series,Left(SCRIP_NAME,20),SCRIP_NAME,1,10,'','','','','EQ','EQ','','','Dec 31 2049','','','','' 
From Scrip_imp

Insert Into Scrip2 
Select Sno,Series,'NSE',Scrip_CD,'HIG','','',0,0,0,'','','NRM','','','','','','','','','', '', '', '', '', '', '', 0, '', 0, 0, 0, '', 0 
From Scrip_imp
            
Update Scrip2 Set Sector = S2.Sector,Track = S2.Track, CDOL_No = S2.CDol_No,
Res1 = S2.Res1, Res2= S2.Res2, Res3 = S2.Res3, Res4 = S2.Res4, Globalcustodian = S2.Globalcustodian, 
Common_Code = IsNull(S2.Common_Code,''), IndexName = S2.IndexName, Industry = S2.Industry, 
Bloomberg = S2.Bloomberg, RicCode = S2.RicCode, Reuters = S2.Reuters, IES = S2.IES, 
NoofIssuedshares = S2.NoofIssuedshares, Status = S2.Status, ADRGDRRatio = S2.ADRGDRRatio, 
GEMultiple = S2.GEMultiple, GroupforGE = S2.GroupforGE, RBICeilingIndicatorFlag = S2.RBICeilingIndicatorFlag,
RBICeilingIndicatorValue = S2.RBICeilingIndicatorValue 
From TempScrip2 S2 Where S2.Scrip_Cd = Scrip2.Scrip_Cd And S2.Series = Scrip2.Series

DROP TABLE TempScrip1
DROP TABLE TempScrip2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PCREATEBOUSERS
-- --------------------------------------------------

CREATE   PROC [dbo].[PCREATEBOUSERS]  
(  
	 @UPDTFLAG VARCHAR(1),  
	 @PARTICIPANT VARCHAR(10),  
	 @CATEGORYNAME VARCHAR(20),  
	 @USERID VARCHAR(20),  
	 @PASSWORD VARCHAR(15),  
	 @FIRSTNAME VARCHAR(50),  
	 @MIDDLENAME VARCHAR(25),  
	 @LASTNAME VARCHAR(25),
	 @EDITADDBY VARCHAR(25)  
)  
  
AS  
  
DECLARE @@ADMINCOUNT INT  
DECLARE @@CONTROLCOUNT INT  
DECLARE @@USERCOUNT INT  
DECLARE @@CATEGORYCODE INT  
DECLARE @@USERLOGINID INT  
DECLARE @@ADMINAUTO INT  
  
IF @UPDTFLAG = 'I'  
BEGIN  
  
 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT   
   
 IF @@ADMINCOUNT >0  
 BEGIN  
  
	 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME     
	IF @@ADMINCOUNT >0  
	BEGIN  

		  SELECT @@USERCOUNT = COUNT(1) FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID    
		  IF @@USERCOUNT = 0  
		  BEGIN    
		  
		   SELECT @@CATEGORYCODE = FLDCATEGORYCODE FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME  
		 
		   SELECT @@ADMINAUTO = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT  
		  
		    
		   INSERT INTO TBLPRADNYAUSERS  
		   (FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2,FLDPHONE1,FLDPHONE2,FLDCATEGORY,FLDADMINAUTO,FLDSTNAME,PWD_EXPIRY_DATE,EDIT_FLAG,CREATED_BY,MODIFIED_BY)  
		   VALUES  
		   (@USERID, @PASSWORD, LEFT(@FIRSTNAME,50), LEFT(@MIDDLENAME,25), LEFT(@LASTNAME, 50), 'MALE',  
		   '','','','', @@CATEGORYCODE, @@ADMINAUTO, @USERID, 'DEC 31 2049','A',@EDITADDBY,@EDITADDBY)  
		     
		   SELECT @@USERLOGINID = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID  
		     
		   INSERT INTO TBLUSERCONTROLMASTER  
		   (FLDUSERID,FLDPWDEXPIRY,FLDMAXATTEMPT,FLDATTEMPTCNT,FLDSTATUS,FLDLOGINFLAG,FLDACCESSLVL,FLDIPADD,FLDTIMEOUT,FLDFIRSTLOGIN,FLDFORCELOGOUT)  
		   VALUES  
		   (@@USERLOGINID, 365, 100, 0, 0, 0, 'F', '', 30, 'N', 0)  
	END
  END  
 END  
   
END  
ELSE  
BEGIN  
 UPDATE TBLADMIN  
 SET FLDPASSWORD = @PASSWORD  
 WHERE FLDNAME = @PARTICIPANT  
  
 UPDATE TBLPRADNYAUSERS  
 SET FLDPASSWORD  = @PASSWORD  
 WHERE FLDUSERNAME = @USERID  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_COMMON_CONTRACTDATA_NEW
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[POP_COMMON_CONTRACTDATA_NEW]
	(
	@FROMDATE VARCHAR(11),
	@USERNAME VARCHAR(20) = ''
	)
AS

/*

EXEC POP_COMMON_CONTRACTDATA_NEW 'MAR 19 2018',''

*/

DECLARE @FROMPARTY VARCHAR(10)
DECLARE @TOPARTY VARCHAR(10)

SET @FROMPARTY = '0'
SET @TOPARTY = 'zzzzzzzzzz'


CREATE TABLE #CONTRACT (
	CONTRACTNO VARCHAR(10),
	CONTRACTNO_NEW VARCHAR(10),
	SAUDA_DATE DATETIME,
	SETT_NO VARCHAR(10),
	SETT_TYPE VARCHAR(3),
	SETT_DATE VARCHAR(11),
	EXCHANGE VARCHAR(3),
	SEGMENT VARCHAR(10),
	ORDER_NO VARCHAR(20),
	ORDER_TIME VARCHAR(8),
	TRADE_NO VARCHAR(16),
	TRADE_TIME VARCHAR(8),
	SCRIPNAME VARCHAR(100),
	QTY BIGINT,
	TMARK VARCHAR(1),
	SELL_BUY VARCHAR(1),
	MARKETRATE NUMERIC (36,18),
	MARKETAMT NUMERIC (36,18),
	BROKERAGE NUMERIC (36,18),
	SERVICE_TAX NUMERIC (36,18),
	INS_CHRG NUMERIC (36,18),
	NETAMOUNT NUMERIC (36,18),
	SEBI_TAX NUMERIC (36,18),
	TURN_TAX NUMERIC (36,18),
	BROKER_CHRG NUMERIC (36,18),
	OTHER_CHRG NUMERIC (36,18),
	NETAMOUNTALL NUMERIC (36,18),
	BROK NUMERIC (36,18),
	NETRATE NUMERIC (36,18),
	CL_RATE NUMERIC (36,18),
	BROKERSEBIREGNO VARCHAR(20),
	MEMBERCODE VARCHAR(50),
	CINNO VARCHAR(100),
	SETTTYPE_DESC VARCHAR(35),
	BFCF_FLAG VARCHAR(6),
	CONTRACT_HEADER_DET VARCHAR(200),
	REMARK VARCHAR(100),
	COMPANYNAME VARCHAR(100),
	USER_ID VARCHAR(20),
	REMARK_ID VARCHAR(1),
	REMARK_DESC VARCHAR(200),
	NETOBLIGATION NUMERIC (36,18),
	BRANCH_CD VARCHAR(15),
	SUB_BROKER VARCHAR(15),
	TRADER VARCHAR(25),
	AREA VARCHAR(25),
	REGION VARCHAR(25),
	FAMILY VARCHAR(15),
	PARTY_CODE VARCHAR(15),
	PARTYNAME VARCHAR(100),
	L_ADDRESS1 VARCHAR(100),
	L_ADDRESS2 VARCHAR(100),
	L_ADDRESS3 VARCHAR(100),
	L_STATE VARCHAR(50),
	L_CITY VARCHAR(50),
	L_ZIP VARCHAR(10),
	OFF_PHONE1 VARCHAR(50),
	OFF_PHONE2 VARCHAR(50),
	PAN_GIR_NO VARCHAR(15),
	MAPIDID VARCHAR(20),
	UCC_CODE VARCHAR(20),
	SEBI_NO VARCHAR(25),
	PARTICIPANT_CODE VARCHAR(16),
	CL_TYPE VARCHAR(3),
	SERVICE_CHRG TINYINT,
	PRINTF TINYINT,
	CL_STATUS VARCHAR(3),
	ISIN VARCHAR(12),
	BOOKTYPE NUMERIC (18,4),
	INSTRUMENT NUMERIC (18,4)	
	)

CREATE CLUSTERED INDEX [IDXCONT] ON [DBO].[#CONTRACT] (
	[PARTY_CODE],
	[EXCHANGE],
	[SEGMENT],
	[SCRIPNAME],
	[ORDER_NO],
	[TRADE_NO],
	[SETT_TYPE]
	)
	
DECLARE @FNOBILL_FLAG INT
DECLARE @CONTRACT_TYPE INT

SELECT @FNOBILL_FLAG = ISNULL(FNO_CONTRACT_BILL,0),@CONTRACT_TYPE = ISNULL(CONTRACT_TYPE,1) FROM TBL_COMMONCONTRACT_MASTER (NOLOCK)
WHERE @FROMDATE BETWEEN EFFECTIVE_FROM  AND EFFECTIVE_TO

DECLARE @EXCHANGE_NEW VARCHAR(3)
DECLARE @SEGMENT_NEW VARCHAR(10)
DECLARE @SHAREDB VARCHAR(35)
DECLARE @SHARESERVER VARCHAR(35)
DECLARE @ACCOUNTDB VARCHAR(35)
DECLARE @ACCOUNTSERVER VARCHAR(35)

DECLARE @EXCHANGEWISE_CURSOR CURSOR 
DECLARE @STRSQL VARCHAR(8000) 

SELECT EXCHANGE,SEGMENT INTO #CLIENT_BROK_DETAILS FROM MSAJAG.DBO.CLIENT_BROK_DETAILS (NOLOCK) GROUP BY EXCHANGE,SEGMENT 

SET @EXCHANGEWISE_CURSOR = CURSOR
FOR
SELECT DISTINCT 
	EXCHANGE = M.EXCHANGE,
	SEGMENT = M.SEGMENT,
	SHAREDB,
	SHARESERVER,
	ACCOUNTDB,
	ACCOUNTSERVER
FROM PRADNYA..MULTICOMPANY M(NOLOCK),
	#CLIENT_BROK_DETAILS CB(NOLOCK)
WHERE CATEGORY = 'COMMODITY'
	AND M.EXCHANGE IN ('NCE')
	AND SEGMENT_DESCRIPTION NOT LIKE '%PCM%'
	AND CB.EXCHANGE = M.EXCHANGE
	AND CB.SEGMENT = M.SEGMENT
	AND PRIMARYSERVER = 1

OPEN @EXCHANGEWISE_CURSOR

FETCH NEXT
FROM @EXCHANGEWISE_CURSOR
INTO
	@EXCHANGE_NEW,
	@SEGMENT_NEW,
	@SHAREDB,
	@SHARESERVER,
	@ACCOUNTDB,
	@ACCOUNTSERVER

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @STRSQL = ''
	IF @SHARESERVER = @@SERVERNAME 
	BEGIN
		SET @SHARESERVER =''
	END
	ELSE
	BEGIN
		SET @SHARESERVER = @SHARESERVER + '.'
	END

	SET @STRSQL = 'INSERT INTO #CONTRACT EXEC ' + @SHARESERVER + @SHAREDB + '.DBO.POP_CONTRACTDATA ''' + @FROMDATE + ''',''' + @USERNAME + ''',''FETCH'',' + CONVERT(VARCHAR,@FNOBILL_FLAG)
	print @STRSQL
	EXEC (@STRSQL)
		
	FETCH NEXT
	FROM @EXCHANGEWISE_CURSOR
	INTO 
		@EXCHANGE_NEW,
		@SEGMENT_NEW,
		@SHAREDB,
		@SHARESERVER,
		@ACCOUNTDB,
		@ACCOUNTSERVER
END

CLOSE @EXCHANGEWISE_CURSOR

DEALLOCATE @EXCHANGEWISE_CURSOR


IF (@FNOBILL_FLAG = 1)
BEGIN
	UPDATE #CONTRACT
	SET SCRIPNAME = SCRIPNAME + ' (' + LEFT(BFCF_FLAG, 2) + ')'
	WHERE SEGMENT = 'FUTURES'
		AND LEN(BFCF_FLAG) <> 0
		

	UPDATE #CONTRACT 
	SET NETAMOUNT = (
	CASE 
		WHEN TMARK = '0'  THEN
		CASE 
			WHEN LEFT(SCRIPNAME,3) = 'OPT' THEN (CASE WHEN SELL_BUY = 1 THEN -ROUND(NETRATE*QTY,4)* CONVERT(INT,BOOKTYPE) /CONVERT(INT,INSTRUMENT)  ELSE ROUND(NETRATE*QTY,4) * CONVERT(INT,BOOKTYPE)/CONVERT(INT,INSTRUMENT)  END)
			ELSE
		CASE 
			WHEN SELL_BUY =2 THEN ROUND((MARKETRATE - CL_RATE) * QTY * CONVERT(INT,BOOKTYPE)/CONVERT(INT,INSTRUMENT),4)
			ELSE ROUND((CL_RATE-MARKETRATE) * QTY * CONVERT(INT,BOOKTYPE)/CONVERT(INT,INSTRUMENT),4) 
		END - BROKERAGE
		END
		ELSE - BROKERAGE 
	END)
	WHERE SEGMENT = 'FUTURES'
	AND LEFT(BFCF_FLAG, 2) = 'BT'		

	UPDATE #CONTRACT SET  TMARK ='' WHERE SEGMENT = 'FUTURES'				
END

IF @CONTRACT_TYPE = 0  -- COMMON CONTRACT IS ENABLED
BEGIN
	SELECT PARTY_CODE,EXCHANGE,SEGMENT,NETOBL=SUM(NETAMOUNT)
	INTO #NETOBL1
	FROM #CONTRACT
	WHERE SEGMENT = 'FUTURES'
	GROUP BY PARTY_CODE,EXCHANGE,SEGMENT
	
	UPDATE #CONTRACT SET NETOBLIGATION = A.NETOBL
	FROM #NETOBL1 A
	WHERE A.PARTY_CODE = #CONTRACT.PARTY_CODE
	AND A.EXCHANGE = #CONTRACT.EXCHANGE
	AND A.SEGMENT = #CONTRACT.SEGMENT
	
	DROP TABLE #NETOBL1
END
ELSE
BEGIN
	SELECT PARTY_CODE,EXCHANGE,SEGMENT,CONTRACTNO,NETOBL=SUM(NETAMOUNT)
	INTO #NETOBL2
	FROM #CONTRACT
	WHERE SEGMENT = 'FUTURES'
	GROUP BY PARTY_CODE,EXCHANGE,SEGMENT,CONTRACTNO
	
	UPDATE #CONTRACT SET NETOBLIGATION = A.NETOBL
	FROM #NETOBL2 A
	WHERE A.PARTY_CODE = #CONTRACT.PARTY_CODE
	AND A.EXCHANGE = #CONTRACT.EXCHANGE
	AND A.SEGMENT = #CONTRACT.SEGMENT
	AND A.CONTRACTNO = #CONTRACT.CONTRACTNO
	
	DROP TABLE #NETOBL2
END

UPDATE #CONTRACT
SET CONTRACTNO = A.CONTRACTNO, SELL_BUY = A.SELL_BUY
FROM (
	SELECT SAUDA_DATE = LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		SETT_TYPE,
		CONTRACTNO,
		SELL_BUY,
		ORDER_NO
	FROM #CONTRACT(NOLOCK)
	WHERE CONTRACTNO <> 0
	GROUP BY LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		CONTRACTNO,
		SETT_TYPE,
		SELL_BUY,
		ORDER_NO
	) A
WHERE A.PARTY_CODE = #CONTRACT.PARTY_CODE
	AND LEFT(A.SAUDA_DATE, 11) = LEFT(#CONTRACT.SAUDA_DATE, 11)
	AND A.SETT_TYPE = #CONTRACT.SETT_TYPE
	AND #CONTRACT.ORDER_NO = A.ORDER_NO
	AND #CONTRACT.CONTRACTNO = 0

UPDATE #CONTRACT
SET CONTRACTNO = A.CONTRACTNO
FROM (
	SELECT SAUDA_DATE = LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		SETT_TYPE,
		CONTRACTNO
	FROM #CONTRACT(NOLOCK)
	WHERE CONTRACTNO <> 0
	GROUP BY LEFT(SAUDA_DATE, 11),
		PARTY_CODE,
		CONTRACTNO,
		SETT_TYPE
	) A
WHERE A.PARTY_CODE = #CONTRACT.PARTY_CODE
	AND LEFT(A.SAUDA_DATE, 11) = LEFT(#CONTRACT.SAUDA_DATE, 11)
	AND A.SETT_TYPE = #CONTRACT.SETT_TYPE
	AND #CONTRACT.SCRIPNAME = 'BROKERAGE'
	AND #CONTRACT.CONTRACTNO = 0

UPDATE #CONTRACT
SET CONTRACT_HEADER_DET = EXCHANGE + ' - ' + SEGMENT + ' - ' 
+ (CASE WHEN SEGMENT = 'CAPITAL' THEN SETTTYPE_DESC + ' (' + LTRIM(RTRIM(SETT_NO)) + ' - ' + LTRIM(RTRIM(SETT_TYPE)) + ' - '
+ LTRIM(RTRIM(SETT_DATE)) + ' - Ref. No: ' + LTRIM(RTRIM(CONTRACTNO)) + ')' ELSE 'Ref. No: ' + LTRIM(RTRIM(CONTRACTNO)) END)

UPDATE #CONTRACT
SET CONTRACT_HEADER_DET = EXCHANGE + ' - ' + SEGMENT
WHERE SEGMENT = 'FUTURES'
	AND BFCF_FLAG = 'BF_F'
	AND LEFT(BFCF_FLAG, 2) = 'BT'

UPDATE #CONTRACT
SET CONTRACTNO = 0
WHERE #CONTRACT.SCRIPNAME LIKE '%BROKERAGE%'

DELETE #CONTRACT WHERE CL_TYPE = 'INS'

BEGIN TRANSACTION
--------------------------------- COMMON CONTRACT NO UPDATE STARTS HERE ----------------------------
IF @CONTRACT_TYPE = 0  -- COMMON CONTRACT ENABLED
BEGIN

	DECLARE @CONTGEN_COMMON INT
	IF (
			SELECT COUNT(1)
			FROM CONTGEN_COMMON
			WHERE @FROMDATE BETWEEN START_DATE AND END_DATE
			) = 0
		BEGIN
			RAISERROR ('CANNOT PROCEED. PLEASE CONFIGURE THE CONT GEN COMMON FIRST',16,1)
		RETURN
	END


	SELECT @CONTGEN_COMMON = ISNULL(CONVERT(INT, CONTRACTNO), 0)
	FROM CONTGEN_COMMON 
	WHERE @FROMDATE BETWEEN START_DATE AND END_DATE

	CREATE TABLE #CONTRACTNO
	 (
		SNO INT IDENTITY NOT NULL,
		PARTY_CODE VARCHAR(20),
		SETT_TYPE VARCHAR(3),
		SETT_NO VARCHAR(10),
		CONTRACTNO VARCHAR(20)
		)

	CREATE CLUSTERED INDEX IDXPARTY ON #CONTRACTNO (PARTY_CODE)

	UPDATE #CONTRACT SET CL_STATUS = C1.CL_STATUS
	FROM CLIENT1 C1, CLIENT2 C2
	WHERE C1.CL_CODE = C2.CL_CODE
	AND C2.PARTY_CODE = #CONTRACT.PARTY_CODE
	AND #CONTRACT.CL_STATUS = ''

	UPDATE #CONTRACT
	SET CONTRACTNO_NEW = '', SAUDA_DATE = @FROMDATE

	CREATE TABLE #CONTRACTNO_1
	(
		PARTY_CODE VARCHAR(10),
		CONTRACTNO_NEW VARCHAR(10)
	)
	
	CREATE CLUSTERED INDEX [IDXCONT] ON [DBO].[#CONTRACTNO_1] (PARTY_CODE)
	
	INSERT INTO #CONTRACTNO_1
	SELECT DISTINCT PARTY_CODE,CONTRACTNO_NEW
	FROM COMMON_CONTRACT_DATA C(NOLOCK)
	WHERE C.SAUDA_DATE = @FROMDATE
		
	IF (SELECT COUNT(1) FROM #CONTRACT WHERE EXISTS (SELECT CL_TYPE FROM CONTGEN_COMMON_STYLE C WHERE C.CL_TYPE = #CONTRACT.CL_TYPE)) > 0
			OR (SELECT COUNT(1) FROM #CONTRACT WHERE EXISTS (SELECT CL_TYPE FROM CONTGEN_COMMON_STYLE C WHERE C.CL_STATUS = #CONTRACT.CL_STATUS)) > 0
		BEGIN
	
		CREATE TABLE #CLIENT_SPL
		(
			PARTY_CODE VARCHAR(20)
		)
		
		CREATE INDEX IDXCL ON #CLIENT_SPL (PARTY_CODE)
		
		INSERT INTO #CLIENT_SPL
		SELECT DISTINCT PARTY_CODE 
		FROM #CONTRACT
		WHERE EXISTS (SELECT CL_TYPE FROM CONTGEN_COMMON_STYLE WHERE 
						CONTGEN_COMMON_STYLE.CL_TYPE = #CONTRACT.CL_TYPE
						AND CONTGEN_COMMON_STYLE.CL_TYPE <> '' )
						
		UNION ALL
		
		SELECT DISTINCT PARTY_CODE 
		FROM #CONTRACT
		WHERE EXISTS (SELECT CL_TYPE FROM CONTGEN_COMMON_STYLE WHERE 
						CONTGEN_COMMON_STYLE.CL_STATUS = #CONTRACT.CL_STATUS
						AND CONTGEN_COMMON_STYLE.CL_STATUS <> '' )	
	
		UPDATE #CONTRACT
		SET CONTRACTNO_NEW = C.CONTRACTNO_NEW
		FROM #CONTRACTNO_1 C(NOLOCK)
		WHERE  C.PARTY_CODE = #CONTRACT.PARTY_CODE
		AND NOT EXISTS (SELECT PARTY_CODE  FROM #CLIENT_SPL WHERE #CLIENT_SPL.PARTY_CODE = #CONTRACT.PARTY_CODE)
					
		CREATE TABLE #CONTRACTNO_2
		(
			PARTY_CODE VARCHAR(10),
			CONTRACTNO_NEW VARCHAR(10),
			SETT_TYPE VARCHAR(3),
			SETT_NO VARCHAR(7),
			CONTRACTNO VARCHAR(10)
		)
		
		CREATE CLUSTERED INDEX [IDXCONT] ON [DBO].[#CONTRACTNO_1] (PARTY_CODE,SETT_TYPE,SETT_NO,CONTRACTNO)
		
		INSERT INTO #CONTRACTNO_2
		SELECT DISTINCT PARTY_CODE,CONTRACTNO_NEW,SETT_TYPE,SETT_NO,CONTRACTNO
		FROM COMMON_CONTRACT_DATA C(NOLOCK)
		WHERE C.SAUDA_DATE = @FROMDATE
							
		UPDATE #CONTRACT
		SET CONTRACTNO_NEW = C.CONTRACTNO_NEW
		FROM #CONTRACTNO_2 C(NOLOCK)
		WHERE  C.PARTY_CODE = #CONTRACT.PARTY_CODE
		AND C.SETT_TYPE =  #CONTRACT.SETT_TYPE
		AND C.SETT_NO =  #CONTRACT.SETT_NO
		AND C.CONTRACTNO =  #CONTRACT.CONTRACTNO
		AND EXISTS (SELECT PARTY_CODE  FROM #CLIENT_SPL WHERE #CLIENT_SPL.PARTY_CODE = #CONTRACT.PARTY_CODE)

		INSERT INTO #CONTRACTNO
		SELECT DISTINCT PARTY_CODE,'','',''
		FROM #CONTRACT
		WHERE SAUDA_DATE = @FROMDATE
		AND CONTRACTNO_NEW = ''
		AND NOT EXISTS (SELECT PARTY_CODE  FROM #CLIENT_SPL WHERE #CLIENT_SPL.PARTY_CODE = #CONTRACT.PARTY_CODE)


		INSERT INTO #CONTRACTNO
		SELECT DISTINCT PARTY_CODE,SETT_TYPE,SETT_NO,CONTRACTNO
		FROM #CONTRACT
		WHERE SAUDA_DATE = @FROMDATE
		AND CONTRACTNO_NEW = ''
		AND EXISTS (SELECT PARTY_CODE  FROM #CLIENT_SPL WHERE #CLIENT_SPL.PARTY_CODE = #CONTRACT.PARTY_CODE)
		
		DROP TABLE #CLIENT_SPL

	END
	ELSE
	BEGIN

		UPDATE #CONTRACT
		SET CONTRACTNO_NEW = C.CONTRACTNO_NEW
		FROM #CONTRACTNO_1 C(NOLOCK)
		WHERE C.PARTY_CODE = #CONTRACT.PARTY_CODE
	
		INSERT INTO #CONTRACTNO
		SELECT DISTINCT PARTY_CODE,SETT_TYPE='',SETT_NO='',CONTRACTNO=''
		FROM #CONTRACT
		WHERE SAUDA_DATE = @FROMDATE
		AND CONTRACTNO_NEW = ''
	END
	
	DROP TABLE #CONTRACTNO_1

	UPDATE #CONTRACT
	SET CONTRACTNO_NEW = STUFF('0000000', 8 - LEN(@CONTGEN_COMMON + SNO), LEN(@CONTGEN_COMMON + SNO), @CONTGEN_COMMON + SNO)
	FROM #CONTRACT B,
		#CONTRACTNO T
	WHERE B.PARTY_CODE = T.PARTY_CODE
	AND T.CONTRACTNO = ''

	UPDATE #CONTRACT
	SET CONTRACTNO_NEW = STUFF('0000000', 8 - LEN(@CONTGEN_COMMON + SNO), LEN(@CONTGEN_COMMON + SNO), @CONTGEN_COMMON + SNO)
	FROM #CONTRACT B,
		#CONTRACTNO T
	WHERE B.PARTY_CODE = T.PARTY_CODE
	AND B.SETT_TYPE = T.SETT_TYPE
	AND B.SETT_NO = T.SETT_NO
	AND B.CONTRACTNO = T.CONTRACTNO
	AND T.CONTRACTNO <> ''


	SELECT @CONTGEN_COMMON = @CONTGEN_COMMON + ISNULL(MAX(SNO), 0)
	FROM #CONTRACTNO

	UPDATE CONTGEN_COMMON
	SET CONTRACTNO = @CONTGEN_COMMON
	WHERE @FROMDATE BETWEEN START_DATE AND END_DATE

	DROP TABLE #CONTRACTNO
	END
ELSE
	BEGIN
		UPDATE #CONTRACT SET CONTRACTNO_NEW = CONTRACTNO	
	END


--------------------------------- COMMON CONTRACT NO UPDATE ENDS HERE ----------------------------

DELETE
FROM COMMON_CONTRACT_DATA
WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

INSERT INTO COMMON_CONTRACT_DATA
SELECT CONTRACTNO,CONTRACTNO_NEW,SAUDA_DATE,
SETT_NO,
SETT_TYPE,SETT_DATE,EXCHANGE,SEGMENT,ORDER_NO,ORDER_TIME,TRADE_NO,TRADE_TIME,
SCRIPNAME,QTY,TMARK,SELL_BUY,MARKETRATE,MARKETAMT,BROKERAGE,SERVICE_TAX,INS_CHRG,NETAMOUNT,SEBI_TAX,TURN_TAX,BROKER_CHRG,OTHER_CHRG,
NETAMOUNTALL,BROK,NETRATE,CL_RATE,BROKERSEBIREGNO,MEMBERCODE,CINNO,SETTTYPE_DESC,BFCF_FLAG,CONTRACT_HEADER_DET,REMARK,COMPANYNAME,
USER_ID,REMARK_ID,REMARK_DESC,NETOBLIGATION,BRANCH_CD,SUB_BROKER,TRADER,AREA,REGION,FAMILY,PARTY_CODE,PARTYNAME,L_ADDRESS1,L_ADDRESS2,
L_ADDRESS3,L_STATE,L_CITY,L_ZIP,OFF_PHONE1,OFF_PHONE2,PAN_GIR_NO,MAPIDID,UCC_CODE,SEBI_NO,PARTICIPANT_CODE,CL_TYPE,SERVICE_CHRG,PRINTF,ISIN
FROM #CONTRACT
ORDER BY PARTY_CODE,
EXCHANGE,
SEGMENT,
SCRIPNAME

/* FOR LOG OF USER*/
DECLARE @EXCHANGE VARCHAR(20)
DECLARE @DESC VARCHAR(MAX)
DECLARE @SEGMENT VARCHAR(20)

SELECT DISTINCT EXCHANGE,
	SEGMENT,
	EXCHANGE_DET = EXCHANGE + '-' + SEGMENT
INTO #EXCHANGE
FROM COMMON_CONTRACT_DATA
WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
ORDER BY EXCHANGE,
	SEGMENT

ALTER TABLE #EXCHANGE

ALTER COLUMN EXCHANGE_DET VARCHAR(MAX)

SET @EXCHANGE = ''
SET @DESC = ''
SET @SEGMENT = ''

UPDATE #EXCHANGE
SET @DESC = EXCHANGE_DET = @DESC + '|' + EXCHANGE_DET,
	@EXCHANGE = EXCHANGE,
	@SEGMENT = SEGMENT

DECLARE @DESCRIPTION VARCHAR(MAX)

SET @DESCRIPTION = (
		SELECT MAX(EXCHANGE_DET)
		FROM #EXCHANGE
		)

IF LEN(@DESCRIPTION) > 0
BEGIN
	INSERT INTO [COMMONCN_PROCESS_LOG]
	VALUES (
		@FROMDATE,
		@USERNAME,
		@DESCRIPTION,
		GETDATE()
		)
END

/* END FOR LOG OF USER*/
COMMIT


DROP TABLE #CONTRACT

DROP TABLE #CLIENT_BROK_DETAILS


DROP TABLE #EXCHANGE

/*--------------------------------------------------- END OF PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA
-- --------------------------------------------------


CREATE  PROC [dbo].[POP_CONTRACTDATA]
(  
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(11)='',
	@STRMODE VARCHAR(10) ='POPULATE',
	@FNOBILL_FLAG INT = 0 -- 1 : CONTRACT CUM BILL , 0 - CONTRACT ONLY
)

AS   

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @STRMODE = 'POPULATE'
BEGIN

	/* ------------------------------------------------------------------------
							REMOVING THE EXISTING RECORDS
	---------------------------------------------------------------------------*/

	DELETE CONTRACT_MASTER 
	WHERE
		TRADE_DATE >= @SAUDA_DATE AND 
		TRADE_DATE <= @SAUDA_DATE +' 23:59'

	DELETE CONTRACT_DATA
	WHERE
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59'

	DELETE CONTRACT_DATA_DET
	WHERE
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59'

	/* ------------------------------------------------------------------------
						TAKING FILTERD TRADES TO TEMPORARY TABLE
	---------------------------------------------------------------------------*/

	CREATE TABLE #FOSETTLEMENT
	(
		CONTRACTNO VARCHAR(14),
		ORDER_NO VARCHAR(20),
		CPID VARCHAR(20),
		TRADE_NO VARCHAR(20),
		SAUDA_DATE DATETIME,
		PARTY_CODE VARCHAR(10),
		INST_TYPE VARCHAR(6),
		SYMBOL VARCHAR(12),
		EXPIRYDATE DATETIME,
		STRIKE_PRICE MONEY,
		OPTION_TYPE VARCHAR(2),
		AUCTIONPART VARCHAR(2),
		SELL_BUY INT,
		TRADEQTY INT,
		PRICE NUMERIC(36, 12),
		BROKAPPLIED NUMERIC(36, 12),
		TOTBROKAPPLIED NUMERIC(36, 12),
		NETRATE NUMERIC(36, 12),
		AMOUNT NUMERIC(36, 12),
		SERVICE_TAX NUMERIC(36, 12),
		BROKER_CHRG NUMERIC(36, 12),
		TURN_TAX NUMERIC(36, 12),
		SEBI_TAX NUMERIC(36, 12),
		OTHER_CHRG NUMERIC(36, 12),
		INS_CHRG NUMERIC(36, 12),
		ORDFLG INT,
		PRICEUNIT VARCHAR(20),
		QTY_UNIT VARCHAR(10),
		BOOKTYPE NUMERIC(36, 12),
		INSTRUMENT NUMERIC(36, 12),
		ORDER_TIME VARCHAR(8),		
		CONT_CL_RATE	NUMERIC(36,18),
		CONT_USER_ID	VARCHAR(20),
		CONT_REMARK_ID	VARCHAR(1),
		CONT_REMARK_DESC VARCHAR(200)
	)

	SELECT * INTO #FOSETTLEMENT_1 FROM #FOSETTLEMENT

	CREATE INDEX [IDXPARTY] ON [DBO].[#FOSETTLEMENT_1] ([PARTY_CODE])   

	INSERT INTO #FOSETTLEMENT
	SELECT 
		CONTRACTNO,ORDER_NO,CPID,TRADE_NO,SAUDA_DATE,PARTY_CODE,
		INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,
		SELL_BUY,TRADEQTY,PRICE,BROKAPPLIED,TOTBROKAPPLIED=0,NETRATE,
		AMOUNT=(PRICE*TRADEQTY*BOOKTYPE/INSTRUMENT),
		SERVICE_TAX,BROKER_CHRG,TURN_TAX,SEBI_TAX,OTHER_CHRG,
		INS_CHRG,ORDFLAG=1,'','',BOOKTYPE,INSTRUMENT,
		--ORDER_TIME = CPID,  -- COMENTED ON 19 JUL 2024 SRE-28076
		ORDER_TIME = right(CPID,7),   -- ADDED ON 19 JUL 2024 SRE-28076
		--(CASE WHEN LEN(CPID) = 6 
		--	THEN LEFT(CPID,2) + ':' + RIGHT(LEFT(CPID,4),2) + ':' + RIGHT(CPID,2)
		--	ELSE '0' + LEFT(CPID,1) + ':' + RIGHT(LEFT(CPID,3),2) + ':' + RIGHT(CPID,2) END),

		CONT_CL_RATE	=0,
		CONT_USER_ID	=USER_ID,
		CONT_REMARK_ID	='',
		CONT_REMARK_DESC=''
	FROM FOSETTLEMENT                 
	WHERE 
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59' AND 
		AUCTIONPART <> 'CA' AND
		TRADEQTY > 0  AND 
		PRICE > 0 

	UPDATE #FOSETTLEMENT SET TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO) 
	WHERE UPPER(LEFT(TRADE_NO,1)) BETWEEN 'A' AND 'Z' 

	/*
	SELECT * FROM FOSETTLEMENT
	UPDATE 
		#FOSETTLEMENT 
	SET 
		PRICEUNIT = FOSCRIP2.PRICEUNIT,
		QTY_UNIT = FOSCRIP2.QTY_UNIT
	FROM
		NCE..FOSCRIP2
	WHERE
		FOSCRIP2.INST_TYPE = #FOSETTLEMENT.INST_TYPE
		AND FOSCRIP2.SYMBOL = #FOSETTLEMENT.SYMBOL
		AND LEFT(FOSCRIP2.EXPIRYDATE,11) = LEFT(#FOSETTLEMENT.EXPIRYDATE,11)
		AND FOSCRIP2.STRIKE_PRICE = #FOSETTLEMENT.STRIKE_PRICE
		AND FOSCRIP2.OPTION_TYPE = #FOSETTLEMENT.OPTION_TYPE
	*/

	INSERT INTO #FOSETTLEMENT_1
	SELECT 
		CONTRACTNO,ORDER_NO,CPID ,TRADE_NO,SAUDA_DATE,
		PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
		OPTION_TYPE,AUCTIONPART,SELL_BUY,
		TRADEQTY = SUM(TRADEQTY),
		PRICE = SUM(TRADEQTY*PRICE)/ SUM(TRADEQTY),
		BROKAPPLIED = SUM(BROKAPPLIED*TRADEQTY)/ SUM(TRADEQTY),
		TOTBROKAPPLIED = 0,
		NETRATE= SUM(NETRATE*TRADEQTY)/ SUM(TRADEQTY),
		AMOUNT = SUM(AMOUNT),
		SERVICE_TAX = SUM(SERVICE_TAX),
		BROKER_CHRG = SUM(BROKER_CHRG),
		TURN_TAX = SUM(TURN_TAX),
		SEBI_TAX = SUM(SEBI_TAX),
		OTHER_CHRG = SUM(OTHER_CHRG),
		INS_CHRG = SUM(INS_CHRG),
		ORDFLAG=1,
		PRICEUNIT,
		QTY_UNIT,
		BOOKTYPE,
		INSTRUMENT,
		ORDER_TIME,
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC	
	FROM  #FOSETTLEMENT
	GROUP BY
		CONTRACTNO,
		ORDER_NO,
		CPID,
		TRADE_NO,
		SAUDA_DATE,
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		AUCTIONPART,
		SELL_BUY,
		PRICEUNIT,
		QTY_UNIT,
		BOOKTYPE,
		INSTRUMENT,
		ORDER_TIME,
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC

	/* ------------------------------------------------------------------------
					VBB UPDATE
	---------------------------------------------------------------------------*/

	UPDATE   
		#FOSETTLEMENT_1  
	SET  
		TOTBROKAPPLIED = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END  
				+ (CASE WHEN SERVICE_CHRG = 1 THEN   
				CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END  
						ELSE 0 END),  
		SERVICE_TAX = SERVICE_TAX + (CASE WHEN SERVICE_CHRG = 0 THEN   
				CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END  
				ELSE 0 END)
	FROM  
		CHARGES_DETAIL, CLIENT2
	WHERE  
		CLIENT2.PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE
		AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)  
		AND CD_PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE   
		AND CD_INST_TYPE = INST_TYPE
		AND CD_SYMBOL = SYMBOL  
		AND CD_EXPIRY_DATE LIKE LEFT(EXPIRYDATE,11) + '%' 
		AND CD_OPTION_TYPE = OPTION_TYPE  
		AND CD_STRIKE_PRICE = STRIKE_PRICE  
		AND CD_TRADE_NO = TRADE_NO  
		AND CD_ORDER_NO = ORDER_NO  



	INSERT INTO #FOSETTLEMENT_1
	SELECT  
		CD_CONTRACT_NO,
		CD_ORDER_NO,   
		CPID = '',   
		CD_TRADE_NO,   
		CONVERT(VARCHAR,CD_SAUDA_DATE,102) AS SAUDA_DATE,   
		CD_PARTY_CODE,  
		CD_INST_TYPE,   
		CD_SYMBOL= (CASE WHEN CD_SYMBOL = '' THEN 'CONT BROK' ELSE CD_SYMBOL END),   
		EXPIRYDATE = (CASE WHEN CD_SYMBOL = '' THEN '' ELSE 
							LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,106),11) END)  ,   
		STRIKE_PRICE = ISNULL(CD_STRIKE_PRICE,0),   
		CD_OPTION_TYPE,
		CD_AUCTIONPART,
		SELL_BUY = CASE WHEN CD_TOT_BUYBROK > 0 THEN 1 ELSE 2 END,
		TRADEQTY = 0,
		PRICE = 0,
		BROKAPPLIED = 0,
		TOTBROKAPPLIED = CD_TOT_BUYBROK + CD_TOT_SELLBROK
						+ (CASE WHEN SERVICE_CHRG = 1 THEN   
						CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),
		NETRATE= 0,
		AMOUNT = 0,
		SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN   
						CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),
		BROKER_CHRG = 0,
		TURN_TAX = 0,
		SEBI_TAX = 0,
		OTHER_CHRG = 0,
		INS_CHRG = 0,
		ORDFLG = (CASE WHEN CD_ORDER_NO <> '' THEN 1  
					WHEN CD_SYMBOL <> '' THEN 2  
					ELSE 3 END)  ,
		PRICEUNIT='',
		QTY_UNIT='',
		BOOKTYPE=1,
		INSTRUMENT=1,
		ORDER_TIME ='',
		CONT_CL_RATE	=0,
		CONT_USER_ID	='',
		CONT_REMARK_ID	='',
		CONT_REMARK_DESC=''	
	FROM
		CHARGES_DETAIL F, CLIENT2
	WHERE
		PARTY_CODE = CD_PARTY_CODE
		AND CD_SAUDA_DATE >= @SAUDA_DATE
		AND CD_SAUDA_DATE <= @SAUDA_DATE + ' 23:59:59'
		AND CD_TRADE_NO = ''  
		AND CD_TOT_BUYBROK + CD_TOT_SELLBROK > 0    
		AND CD_PARTY_CODE IN 
		(
			SELECT 
				DISTINCT PARTY_CODE 
			FROM
				#FOSETTLEMENT (NOLOCK)
		)


	UPDATE	#FOSETTLEMENT_1 
	SET		CONT_CL_RATE = C.CL_RATE
	FROM	FOCLOSING C (NOLOCK)
	WHERE	C.TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	AND #FOSETTLEMENT_1.INST_TYPE  = C.INST_TYPE
	AND #FOSETTLEMENT_1.SYMBOL  = C.SYMBOL
	AND #FOSETTLEMENT_1.EXPIRYDATE  = C.EXPIRYDATE
	AND #FOSETTLEMENT_1.STRIKE_PRICE  = C.STRIKE_PRICE
	AND #FOSETTLEMENT_1.OPTION_TYPE  = C.OPTION_TYPE
	AND LEFT(#FOSETTLEMENT_1.INST_TYPE,3) = 'FUT'

			
	IF (SELECT COUNT(1) FROM SYS.TABLES WHERE NAME='TBL_CONTRACT_TERMINAL_MAPPING') > 0 
	BEGIN
		UPDATE #FOSETTLEMENT_1 SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'') 
		FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK) 
		WHERE CONT_USER_ID = T.TERMINAL_ID
		AND ISNULL(T.TERMINAL_ID,'') <> '' 
		AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE 

		UPDATE #FOSETTLEMENT_1 SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'') 
		FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK) 
		WHERE #FOSETTLEMENT_1.ORDER_NO = T.ORDER_NO
		AND ISNULL(T.ORDER_NO,'') <> ''
		AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE 
	END

	/* ------------------------------------------------------------------------
			TAKING FILTERD CLIENT DETAILS TO TEMPORARY TABLE
	---------------------------------------------------------------------------*/
	INSERT INTO  CONTRACT_MASTER
	SELECT  
		@SAUDA_DATE,
		C2.PARTY_CODE,   
		C1.LONG_NAME,   
		C1.L_ADDRESS1,   
		C1.L_ADDRESS2,   
		C1.L_ADDRESS3,   
		C1.L_CITY,   
		C1.L_STATE,   
		C1.L_ZIP,   
		C1.BRANCH_CD ,   
		C1.SUB_BROKER,   
		C1.TRADER,   
		C1.AREA,  
		C1.REGION,  
		C1.FAMILY,   
		C1.PAN_GIR_NO,   
		C1.OFF_PHONE1,   
		C1.OFF_PHONE2,
		PRINTF,   
		MAPIDID,   
		UCC_CODE,  
		C2.SERVICE_CHRG,   
		BROKERNOTE,   
		TURNOVER_TAX,   
		SEBI_TURN_TAX,   
		C2.OTHER_CHRG,   
		INSURANCE_CHRG,  
		SEBI_NO = FD_CODE  ,
		PARTICIPANTCODE = ISNULL(BANKID,''),
		CL_TYPE,
		CL_STATUS
	FROM    CLIENT1 C1   
	WITH   
			(   
					NOLOCK   
			)   
			,   
			CLIENT2 C2   
	WITH   
			(   
					NOLOCK   
			)   
	LEFT OUTER JOIN UCC_CLIENT UC   
	WITH   
			(   
					NOLOCK   
			)   
			ON C2.PARTY_CODE = UC.PARTY_CODE   
	WHERE   C2.CL_CODE       = C1.CL_CODE   
		AND C2.PARTY_CODE IN 
		(
			SELECT 
				DISTINCT PARTY_CODE 
			FROM
				#FOSETTLEMENT (NOLOCK)
		)


	/* ------------------------------------------------------------------------
			TAKING CONTRACT DATA TO THE FINAL TEMP TABLE (NON SUMMARISED)
	---------------------------------------------------------------------------*/

	INSERT INTO CONTRACT_DATA
	SELECT  
			CONTRACTNO,   
			ORDER_NO,   
			ORDER_TIME,   
			TRADE_NO,   
			LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,   
			@SAUDA_DATE,   
			F.PARTY_CODE,   
			INST_TYPE,   
			SYMBOL,   
			LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,   
			ISNULL(STRIKE_PRICE,0) STRIKE_PRICE, 
			OPTION_TYPE,   
			AUCTIONPART , 
			QTY = TRADEQTY,
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN TRADEQTY   
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN TRADEQTY   
					ELSE 0 END),   
			PRICE,
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
							WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0) + TOTBROKAPPLIED
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
			 WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)   + TOTBROKAPPLIED
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1   
					THEN ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1 AND TRADEQTY > 0  
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   
					THEN ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1  AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			NETAMT=(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  
				
			ISNULL(AMOUNT,0) AMOUNT ,   
			PAMT=(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0) + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT=(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0)  - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
							   THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= (   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = (   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = (   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = (   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = (   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = (   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT) + TOTBROKAPPLIED,0),
			ORDFLG = 1,
			PRICEUNIT = CONVERT(VARCHAR,CONVERT(INT,BOOKTYPE)),
			QTY_UNIT = CONVERT(VARCHAR,CONVERT(INT,INSTRUMENT)),
			CONT_CL_RATE,
			CONT_USER_ID,
			CONT_REMARK_ID,
			CONT_REMARK_DESC
	FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C
	WHERE          
			C.PARTY_CODE = F.PARTY_CODE		
			AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
			AND PRINTF <> '3'

	/* ------------------------------------------------------------------------
				TAKING CONTRACT DATA TO THE FINAL TABLE (SUMMARISED)
	---------------------------------------------------------------------------*/


	INSERT INTO CONTRACT_DATA
	SELECT  
			CONTRACTNO,   
			ORDER_NO		='000000000000000',   
			ORDER_TIME      = '',
			TRADE_NO        ='0000000',
			TRADETIME       ='00:00:00',
			@SAUDA_DATE,
			F.PARTY_CODE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			AUCTIONPART,
			QTY = SUM(TRADEQTY),
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(TRADEQTY)
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SUM(TRADEQTY)
					ELSE 0 END),   
			PRICE = SUM(PRICE*TRADEQTY)/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END),
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END)
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2  
					THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END)
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(ISNULL((BROKAPPLIED + (   
					CASE   
							WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)  )+ SUM(TOTBROKAPPLIED)
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SUM(ISNULL((BROKAPPLIED + (   
					CASE   
					WHEN C.SERVICE_CHRG=1   AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0))+ SUM(TOTBROKAPPLIED)
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1  AND SUM(TRADEQTY) > 0 
					THEN SUM(ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0))/SUM(TRADEQTY)   
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   AND SUM(TRADEQTY) > 0  
					THEN SUM(ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0))/SUM(TRADEQTY)
					ELSE 0 END),   
			NETAMT= SUM(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  

			AMOUNT = SUM(ISNULL(AMOUNT,0)),   
			PAMT= SUM(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0)  + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT= SUM(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0)  - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
						 WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= SUM(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
							 WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= SUM(   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = SUM(   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = SUM(   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = SUM(   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = SUM(   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = SUM(   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = SUM(   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= SUM(   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = SUM(ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)+ TOTBROKAPPLIED,0)),
			ORDFLG,
			PRICEUNIT = CONVERT(VARCHAR,CONVERT(INT,BOOKTYPE)),
			QTY_UNIT = CONVERT(VARCHAR,CONVERT(INT,INSTRUMENT)),
			CONT_CL_RATE,
			CONT_USER_ID,
			CONT_REMARK_ID,
			CONT_REMARK_DESC		
	FROM
		#FOSETTLEMENT_1 F,
		CONTRACT_MASTER C
	WHERE          
		C.PARTY_CODE = F.PARTY_CODE   
		AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
		AND PRINTF = '3'
	GROUP BY 
		CONTRACTNO,   
		F.PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		AUCTIONPART,
		SELL_BUY,
		ORDFLG  ,
		CONVERT(INT,BOOKTYPE),
		CONVERT(INT,INSTRUMENT),
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC
		

	UPDATE CONTRACT_DATA   
	SET ORDER_NO = F.ORDER_NO,  
	TRADE_NO = F.TRADE_NO,  
	ORDER_TIME = F.CPID,  
	TRADETIME = LEFT(CONVERT(VARCHAR,F.SAUDA_DATE,108),11)  
	FROM #FOSETTLEMENT_1 F  
	WHERE LEFT(CONTRACT_DATA.SAUDA_DATE,11) = LEFT(F.SAUDA_DATE,11)  
	AND CONTRACT_DATA.PARTY_CODE = F.PARTY_CODE  
	AND CONTRACT_DATA.INST_TYPE = F.INST_TYPE  
	AND CONTRACT_DATA.SYMBOL = F.SYMBOL  
	AND CONTRACT_DATA.EXPIRYDATE = F.EXPIRYDATE  
	AND CONTRACT_DATA.STRIKE_PRICE = F.STRIKE_PRICE  
	AND CONTRACT_DATA.OPTION_TYPE = F.OPTION_TYPE  
	AND CONTRACT_DATA.AUCTIONPART = F.AUCTIONPART  
	AND CONTRACT_DATA.SELL_BUY = F.SELL_BUY  
	AND CONTRACT_DATA.ORDER_NO = '000000000000000'  
	AND F.SAUDA_DATE = (SELECT SAUDA_DATE=MIN(SAUDA_DATE)  
		 FROM #FOSETTLEMENT_1 F1  
		 WHERE F1.PARTY_CODE = F.PARTY_CODE  
		 AND F1.INST_TYPE = F.INST_TYPE  
		 AND F1.SYMBOL = F.SYMBOL  
		 AND F1.EXPIRYDATE = F.EXPIRYDATE  
		 AND F1.STRIKE_PRICE = F.STRIKE_PRICE  
		 AND F1.OPTION_TYPE = F.OPTION_TYPE  
		 AND F1.AUCTIONPART = F.AUCTIONPART  
		 AND F1.SELL_BUY = F.SELL_BUY)

	/* ------------------------------------------------------------------------
			TAKING CONTRACT DATA TO THE FINAL ARCHIVAL TABLE (SUMMARISED)
	---------------------------------------------------------------------------*/

	INSERT INTO CONTRACT_DATA_DET
	SELECT  
			CONTRACTNO,   
			ORDER_NO,   
			ORDER_TIME,   
			TRADE_NO,   
			LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,   
			@SAUDA_DATE,   
			F.PARTY_CODE,   
			INST_TYPE,   
			SYMBOL,   
			LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,   
			ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,   
			OPTION_TYPE,
			AUCTIONPART ,
			QTY = TRADEQTY,
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN TRADEQTY   
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
				   THEN TRADEQTY   
					ELSE 0 END),   
			PRICE,
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
				 WHEN C.SERVICE_CHRG=1  AND TRADEQTY > 0 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)   + TOTBROKAPPLIED
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
			 WHEN C.SERVICE_CHRG=1   AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0) + TOTBROKAPPLIED    
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1  AND TRADEQTY > 0 
					THEN ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)  
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   AND TRADEQTY > 0
					THEN ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			NETAMT=(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  
			ISNULL(AMOUNT,0) AMOUNT ,   
			PAMT=(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0)  + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
							   WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT=(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0) - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= (   
			CASE   
					WHEN SELL_BUY = 1   
			  THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= (   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = (   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = (   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = (   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = (   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = (   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)+ TOTBROKAPPLIED,0),
			ORDFLG,
			PRICEUNIT,
			QTY_UNIT
	FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C
	WHERE          
			C.PARTY_CODE = F.PARTY_CODE
			AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
			AND PRINTF = '3'

	/* ------------------------------------------------------------------------
						CLEANING TEMPORARY TABLES
	---------------------------------------------------------------------------*/

	DROP TABLE #FOSETTLEMENT
	DROP TABLE #FOSETTLEMENT_1


	/* ------------------------------------------------------------------------
			UPDATING PROCESS TRACKER
	---------------------------------------------------------------------------*/

		UPDATE 
			V2_BUSINESS_PROCESS 
		SET 
			CONTRACT = CONTRACT + 1 ,
			LASTUPDATEDATE = GETDATE()			
		WHERE 
			LEFT(BUSINESS_DATE,11) = @SAUDA_DATE

		INSERT INTO V2_PROCESS_STATUS_LOG 
		( 
			EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
			FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
		)
		SELECT
			EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
			SEGMENT='FUTURES',
			BUSINESSDATE=@SAUDA_DATE,
			PROCESSID = 'CONTRACT',
			PROCESSNAME = 'CONTRACT POPUP',
			FILENAME='',
			START_END_FLAG=1,
			PROCESSDATE=GETDATE(),
			PROCESSBY=@USERNAME,
			MACHINEIP=''
		
END
IF @STRMODE = 'FETCH'
BEGIN
	DECLARE @EXCHANGECODE VARCHAR(3)
	SELECT  TOP 1 @EXCHANGECODE= EXCHANGE FROM FOGLOBALS (NOLOCK)

	IF @FNOBILL_FLAG = 1			-- CONTRACT CUM BILL ENABLED
	BEGIN	
			SELECT 
				CONTRACTNO,
				CONTRACTNO_NEW = CONTRACTNO,
				SAUDA_DATE = @SAUDA_DATE,
				SETT_NO = '',
				SETT_TYPE = '',
				SETT_DATE = '',
				EXCHANGE = @EXCHANGECODE ,
				SEGMENT = 'FUTURES',
				ORDER_NO = '',
				ORDER_TIME = '',
				TRADE_NO = '',
				TRADE_TIME='',
				SCRIPNAME = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
								ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
								+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 	END),
				QTY=ABS(SUM(PQTY-SQTY)),
				TMARK= '0',
				SELL_BUY=(CASE WHEN SUM(PQTY-SQTY) > 0 THEN 1 ELSE 2 END),
				--MARKETRATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PAMT+SAMT)/SUM(PQTY+SQTY) ELSE 0 END),
				--MARKETAMT = SUM(PAMT+SAMT),
				MARKETRATE = (SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END))/ 
							(CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PQTY-SQTY) ELSE 1 END),
				MARKETAMT = SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END),
				
				BROKERAGE = SUM(PBROKAMT-SBROKAMT),
				SERVICE_TAX = SUM(SERVICE_TAX),
				INS_CHRG = SUM(INS_CHRG),
				NETAMOUNT	= SUM(SBILLAMT-PBILLAMT),
				SEBI_TAX = SUM(SEBI_TAX),
				TURN_TAX = SUM(TURN_TAX),
				BROKER_CHRG = SUM(BROKER_NOTE),
				OTHER_CHRG = SUM(D.OTHER_CHRG),
				NETAMOUNTALL= 0,
				BROK  = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PBROKAMT-SBROKAMT)/SUM(PQTY-SQTY) ELSE 0 END),
				NETRATE = 0,
				CL_RATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN  ABS(SUM((PQTY-SQTY)*CL_RATE) / SUM(PQTY-SQTY)) ELSE 0 END), 
				BROKERSEBIREGNO = O.BROKERSEBIREGNO,
				MEMBERCODE = O.MEMBERCODE,
				CINNO = O.CIN,
				SETTTYPE_DESC='',
				BFCF_FLAG = 'BF_'+LEFT(INST_TYPE,1), 
				CONTRACT_HEADER_DET = '', 
				REMARK = '', 
				COMPANYNAME = O.COMPANY, USER_ID='', 
				REMARK_ID	= '', 
				REMARK_DESC = '', 
				NETOBLIGATION = 0,
				M.BRANCH_CD, 
				M.SUB_BROKER, 
				M.TRADER, 
				M.AREA, 
				M.REGION, 
				M.FAMILY, 
				PARTY_CODE= D.PARTY_CODE,
				PARTYNAME = LONG_NAME,
				M.L_ADDRESS1,
				M.L_ADDRESS2,
				M.L_ADDRESS3,
				M.L_STATE,
				M.L_CITY,
				M.L_ZIP,
				M.OFF_PHONE1,
				M.OFF_PHONE2,
				M.PAN_GIR_NO,
				MAPIDID = '',
				UCC_CODE= '',
				SEBI_NO = FD_CODE,
				PARTICIPANT_CODE = BANKID,
				M.CL_TYPE,
				SERVICE_CHRG,
				PRINTF,
				M.CL_STATUS,
				ISIN = '',
				PRICEUNIT = NUMERATOR,
				QTY_UNIT = DENOMINATOR
		 FROM 
			 FOBILLVALAN D WITH (NOLOCK),
			 DBO.CLIENT1 M WITH (NOLOCK),
			 DBO.FOOWNER O WITH (NOLOCK),
			 DBO.CLIENT2 C2 WITH (NOLOCK)
		WHERE
			M.CL_CODE = C2.PARTY_CODE
			AND M.CL_CODE = D.PARTY_CODE
			AND M.CL_TYPE <> 'INS'
			AND LEFT(INST_TYPE,3) = 'FUT' 
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND (TRADETYPE = 'BF' OR (TRADETYPE = 'BT' AND (PQTY-SQTY) <> 0 AND AUCTIONPART='CA' ))
		GROUP BY 
			CONTRACTNO, SAUDA_DATE, M.BRANCH_CD,  M.SUB_BROKER, 
			M.TRADER, M.AREA,  M.REGION,  M.FAMILY,  D.PARTY_CODE,
			LONG_NAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3, M.L_STATE,
			M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2, M.PAN_GIR_NO,
			FD_CODE, BANKID, M.CL_TYPE, SERVICE_CHRG, PRINTF, 
			CASE 
				WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
				ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
				+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END,
			LEFT(INST_TYPE,1),
			O.BROKERSEBIREGNO,O.MEMBERCODE,
			O.CIN,BRANCH_CD,M.SUB_BROKER,
			O.COMPANY,M.CL_STATUS,
			NUMERATOR,
			DENOMINATOR
		HAVING SUM(PQTY-SQTY) <> 0 
	
		UNION ALL
		
		SELECT 
			CONTRACTNO,
			CONTRACTNO_NEW = CONTRACTNO,
			SAUDA_DATE,
			SETT_NO = '',
			SETT_TYPE = '',
			SETT_DATE = '',
			EXCHANGE = @EXCHANGECODE ,
			SEGMENT = 'FUTURES',
			ORDER_NO,
			ORDER_TIME,
			TRADE_NO,
			TRADE_TIME=TRADETIME,
			SCRIPNAME = (
			CASE 
				WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
				ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
				+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END),
			QTY	=PQTY+SQTY,
			--TMARK	= ORDFLG,
			TMARK = '0',
			SELL_BUY ,
			MARKETRATE = PRATE+SRATE,
			MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
			BROKERAGE,
			SERVICE_TAX,
			INS_CHRG,
			NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
						THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
						ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
			SEBI_TAX,
			TURN_TAX,
			BROKER_CHRG,
			D.OTHER_CHRG,
			NETAMOUNTALL = (
			CASE 
				WHEN SELL_BUY = 1 THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
				ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
			END),
			BROK = (
			CASE
				WHEN QTY <> 0 THEN BROKERAGE/QTY*QTY_UNIT/PRICEUNIT
				ELSE BROKERAGE*QTY_UNIT/PRICEUNIT
			END),
			/*
			NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END) 
					ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),
					*/
			NETRATE = (
			CASE
				WHEN QTY <> 0 THEN 
				CASE
					WHEN SELL_BUY = 1 THEN PRICE + (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
					ELSE PRICE - (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
				END
				ELSE PRICE
			END),					
			CL_RATE = CONT_CL_RATE, 
			BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
			CONTRACT_HEADER_DET = '', REMARK = '', 
			COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
			REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
			NETOBLIGATION = 0, 
			M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
			M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
			M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
			M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
			M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
			PARTICIPANT_CODE = '',
			CL_TYPE,
			M.SERVICE_CHRG,
			M.PRINTF,CL_STATUS,
			ISIN = '',
			PRICEUNIT,
			QTY_UNIT
		FROM 
			CONTRACT_DATA D WITH (NOLOCK),
			CONTRACT_MASTER M WITH (NOLOCK),
			DBO.FOOWNER O WITH (NOLOCK)
		WHERE
			M.TRADE_DATE  = D.SAUDA_DATE
			AND M.PARTY_CODE = D.PARTY_CODE
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
		ORDER BY
			SAUDA_DATE,D.PARTY_CODE
	END
	ELSE
	BEGIN
		SELECT 
			CONTRACTNO,
			CONTRACTNO_NEW = CONTRACTNO,
			SAUDA_DATE,
			SETT_NO = '',
			SETT_TYPE = '',
			SETT_DATE = '',
			EXCHANGE = @EXCHANGECODE ,
			SEGMENT = 'FUTURES',
			ORDER_NO,
			ORDER_TIME,
			TRADE_NO,
			TRADE_TIME=TRADETIME,
			SCRIPNAME = (
			CASE 
			WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
			ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
			+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END),
			QTY	=PQTY+SQTY,
			TMARK	= ORDFLG,
			SELL_BUY ,
			MARKETRATE = PRATE+SRATE,
			MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
			BROKERAGE,
			SERVICE_TAX,
			INS_CHRG,
			NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
						THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
						ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
			SEBI_TAX,
			TURN_TAX,
			BROKER_CHRG,
			D.OTHER_CHRG,
			NETAMOUNTALL = (CASE WHEN SELL_BUY = 1
						THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
						ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
						END),
			BROK = (
			CASE
				WHEN QTY <> 0 THEN BROKERAGE/QTY*QTY_UNIT/PRICEUNIT
				ELSE BROKERAGE*QTY_UNIT/PRICEUNIT
			END),
			/*
			NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END) 
					ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),
					*/
			--NETRATE = (PNETRATE+SNETRATE),	
			NETRATE = (
			CASE
				WHEN QTY <> 0 THEN 
				CASE
					WHEN SELL_BUY = 1 THEN PRICE + (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
					ELSE PRICE - (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
				END
				ELSE PRICE
			END),				
			CL_RATE = CONT_CL_RATE, 
			BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
			CONTRACT_HEADER_DET = '', REMARK = '', 
			COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
			REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
			NETOBLIGATION = 0, 
			M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
			M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
			M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
			M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
			M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
			PARTICIPANT_CODE = '',
			CL_TYPE,
			M.SERVICE_CHRG,
			M.PRINTF,CL_STATUS,
			ISIN = '',
			PRICEUNIT,
			QTY_UNIT			 
		FROM 
			CONTRACT_DATA D WITH (NOLOCK),
			CONTRACT_MASTER M WITH (NOLOCK),
			DBO.FOOWNER O WITH (NOLOCK)
		WHERE
			M.TRADE_DATE  = D.SAUDA_DATE
			AND M.PARTY_CODE = D.PARTY_CODE
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
		ORDER BY
		 SAUDA_DATE,D.PARTY_CODE
	END
END		

/* ------------------------------------------------------------------------
								END OF PROCEDURE
---------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA_BKP_19JUL2024_SRE_28076
-- --------------------------------------------------



CREATE  PROC [dbo].[POP_CONTRACTDATA_BKP_19JUL2024_SRE_28076]
(  
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(11)='',
	@STRMODE VARCHAR(10) ='POPULATE',
	@FNOBILL_FLAG INT = 0 -- 1 : CONTRACT CUM BILL , 0 - CONTRACT ONLY
)

AS   

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @STRMODE = 'POPULATE'
BEGIN

	/* ------------------------------------------------------------------------
							REMOVING THE EXISTING RECORDS
	---------------------------------------------------------------------------*/

	DELETE CONTRACT_MASTER 
	WHERE
		TRADE_DATE >= @SAUDA_DATE AND 
		TRADE_DATE <= @SAUDA_DATE +' 23:59'

	DELETE CONTRACT_DATA
	WHERE
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59'

	DELETE CONTRACT_DATA_DET
	WHERE
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59'

	/* ------------------------------------------------------------------------
						TAKING FILTERD TRADES TO TEMPORARY TABLE
	---------------------------------------------------------------------------*/

	CREATE TABLE #FOSETTLEMENT
	(
		CONTRACTNO VARCHAR(14),
		ORDER_NO VARCHAR(20),
		CPID VARCHAR(20),
		TRADE_NO VARCHAR(20),
		SAUDA_DATE DATETIME,
		PARTY_CODE VARCHAR(10),
		INST_TYPE VARCHAR(6),
		SYMBOL VARCHAR(12),
		EXPIRYDATE DATETIME,
		STRIKE_PRICE MONEY,
		OPTION_TYPE VARCHAR(2),
		AUCTIONPART VARCHAR(2),
		SELL_BUY INT,
		TRADEQTY INT,
		PRICE NUMERIC(36, 12),
		BROKAPPLIED NUMERIC(36, 12),
		TOTBROKAPPLIED NUMERIC(36, 12),
		NETRATE NUMERIC(36, 12),
		AMOUNT NUMERIC(36, 12),
		SERVICE_TAX NUMERIC(36, 12),
		BROKER_CHRG NUMERIC(36, 12),
		TURN_TAX NUMERIC(36, 12),
		SEBI_TAX NUMERIC(36, 12),
		OTHER_CHRG NUMERIC(36, 12),
		INS_CHRG NUMERIC(36, 12),
		ORDFLG INT,
		PRICEUNIT VARCHAR(20),
		QTY_UNIT VARCHAR(10),
		BOOKTYPE NUMERIC(36, 12),
		INSTRUMENT NUMERIC(36, 12),
		ORDER_TIME VARCHAR(8),		
		CONT_CL_RATE	NUMERIC(36,18),
		CONT_USER_ID	VARCHAR(20),
		CONT_REMARK_ID	VARCHAR(1),
		CONT_REMARK_DESC VARCHAR(200)
	)

	SELECT * INTO #FOSETTLEMENT_1 FROM #FOSETTLEMENT

	CREATE INDEX [IDXPARTY] ON [DBO].[#FOSETTLEMENT_1] ([PARTY_CODE])   

	INSERT INTO #FOSETTLEMENT
	SELECT 
		CONTRACTNO,ORDER_NO,CPID,TRADE_NO,SAUDA_DATE,PARTY_CODE,
		INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,
		SELL_BUY,TRADEQTY,PRICE,BROKAPPLIED,TOTBROKAPPLIED=0,NETRATE,
		AMOUNT=(PRICE*TRADEQTY*BOOKTYPE/INSTRUMENT),
		SERVICE_TAX,BROKER_CHRG,TURN_TAX,SEBI_TAX,OTHER_CHRG,
		INS_CHRG,ORDFLAG=1,'','',BOOKTYPE,INSTRUMENT,
		ORDER_TIME = CPID,
		--(CASE WHEN LEN(CPID) = 6 
		--	THEN LEFT(CPID,2) + ':' + RIGHT(LEFT(CPID,4),2) + ':' + RIGHT(CPID,2)
		--	ELSE '0' + LEFT(CPID,1) + ':' + RIGHT(LEFT(CPID,3),2) + ':' + RIGHT(CPID,2) END),

		CONT_CL_RATE	=0,
		CONT_USER_ID	=USER_ID,
		CONT_REMARK_ID	='',
		CONT_REMARK_DESC=''
	FROM FOSETTLEMENT                 
	WHERE 
		SAUDA_DATE >= @SAUDA_DATE AND 
		SAUDA_DATE <= @SAUDA_DATE +' 23:59' AND 
		AUCTIONPART <> 'CA' AND
		TRADEQTY > 0  AND 
		PRICE > 0 

	UPDATE #FOSETTLEMENT SET TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO) 
	WHERE UPPER(LEFT(TRADE_NO,1)) BETWEEN 'A' AND 'Z' 

	/*
	SELECT * FROM FOSETTLEMENT
	UPDATE 
		#FOSETTLEMENT 
	SET 
		PRICEUNIT = FOSCRIP2.PRICEUNIT,
		QTY_UNIT = FOSCRIP2.QTY_UNIT
	FROM
		NCE..FOSCRIP2
	WHERE
		FOSCRIP2.INST_TYPE = #FOSETTLEMENT.INST_TYPE
		AND FOSCRIP2.SYMBOL = #FOSETTLEMENT.SYMBOL
		AND LEFT(FOSCRIP2.EXPIRYDATE,11) = LEFT(#FOSETTLEMENT.EXPIRYDATE,11)
		AND FOSCRIP2.STRIKE_PRICE = #FOSETTLEMENT.STRIKE_PRICE
		AND FOSCRIP2.OPTION_TYPE = #FOSETTLEMENT.OPTION_TYPE
	*/

	INSERT INTO #FOSETTLEMENT_1
	SELECT 
		CONTRACTNO,ORDER_NO,CPID ,TRADE_NO,SAUDA_DATE,
		PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
		OPTION_TYPE,AUCTIONPART,SELL_BUY,
		TRADEQTY = SUM(TRADEQTY),
		PRICE = SUM(TRADEQTY*PRICE)/ SUM(TRADEQTY),
		BROKAPPLIED = SUM(BROKAPPLIED*TRADEQTY)/ SUM(TRADEQTY),
		TOTBROKAPPLIED = 0,
		NETRATE= SUM(NETRATE*TRADEQTY)/ SUM(TRADEQTY),
		AMOUNT = SUM(AMOUNT),
		SERVICE_TAX = SUM(SERVICE_TAX),
		BROKER_CHRG = SUM(BROKER_CHRG),
		TURN_TAX = SUM(TURN_TAX),
		SEBI_TAX = SUM(SEBI_TAX),
		OTHER_CHRG = SUM(OTHER_CHRG),
		INS_CHRG = SUM(INS_CHRG),
		ORDFLAG=1,
		PRICEUNIT,
		QTY_UNIT,
		BOOKTYPE,
		INSTRUMENT,
		ORDER_TIME,
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC	
	FROM  #FOSETTLEMENT
	GROUP BY
		CONTRACTNO,
		ORDER_NO,
		CPID,
		TRADE_NO,
		SAUDA_DATE,
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		AUCTIONPART,
		SELL_BUY,
		PRICEUNIT,
		QTY_UNIT,
		BOOKTYPE,
		INSTRUMENT,
		ORDER_TIME,
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC

	/* ------------------------------------------------------------------------
					VBB UPDATE
	---------------------------------------------------------------------------*/

	UPDATE   
		#FOSETTLEMENT_1  
	SET  
		TOTBROKAPPLIED = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END  
				+ (CASE WHEN SERVICE_CHRG = 1 THEN   
				CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END  
						ELSE 0 END),  
		SERVICE_TAX = SERVICE_TAX + (CASE WHEN SERVICE_CHRG = 0 THEN   
				CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END  
				ELSE 0 END)
	FROM  
		CHARGES_DETAIL, CLIENT2
	WHERE  
		CLIENT2.PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE
		AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)  
		AND CD_PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE   
		AND CD_INST_TYPE = INST_TYPE
		AND CD_SYMBOL = SYMBOL  
		AND CD_EXPIRY_DATE LIKE LEFT(EXPIRYDATE,11) + '%' 
		AND CD_OPTION_TYPE = OPTION_TYPE  
		AND CD_STRIKE_PRICE = STRIKE_PRICE  
		AND CD_TRADE_NO = TRADE_NO  
		AND CD_ORDER_NO = ORDER_NO  



	INSERT INTO #FOSETTLEMENT_1
	SELECT  
		CD_CONTRACT_NO,
		CD_ORDER_NO,   
		CPID = '',   
		CD_TRADE_NO,   
		CONVERT(VARCHAR,CD_SAUDA_DATE,102) AS SAUDA_DATE,   
		CD_PARTY_CODE,  
		CD_INST_TYPE,   
		CD_SYMBOL= (CASE WHEN CD_SYMBOL = '' THEN 'CONT BROK' ELSE CD_SYMBOL END),   
		EXPIRYDATE = (CASE WHEN CD_SYMBOL = '' THEN '' ELSE 
							LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,106),11) END)  ,   
		STRIKE_PRICE = ISNULL(CD_STRIKE_PRICE,0),   
		CD_OPTION_TYPE,
		CD_AUCTIONPART,
		SELL_BUY = CASE WHEN CD_TOT_BUYBROK > 0 THEN 1 ELSE 2 END,
		TRADEQTY = 0,
		PRICE = 0,
		BROKAPPLIED = 0,
		TOTBROKAPPLIED = CD_TOT_BUYBROK + CD_TOT_SELLBROK
						+ (CASE WHEN SERVICE_CHRG = 1 THEN   
						CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),
		NETRATE= 0,
		AMOUNT = 0,
		SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN   
						CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),
		BROKER_CHRG = 0,
		TURN_TAX = 0,
		SEBI_TAX = 0,
		OTHER_CHRG = 0,
		INS_CHRG = 0,
		ORDFLG = (CASE WHEN CD_ORDER_NO <> '' THEN 1  
					WHEN CD_SYMBOL <> '' THEN 2  
					ELSE 3 END)  ,
		PRICEUNIT='',
		QTY_UNIT='',
		BOOKTYPE=1,
		INSTRUMENT=1,
		ORDER_TIME ='',
		CONT_CL_RATE	=0,
		CONT_USER_ID	='',
		CONT_REMARK_ID	='',
		CONT_REMARK_DESC=''	
	FROM
		CHARGES_DETAIL F, CLIENT2
	WHERE
		PARTY_CODE = CD_PARTY_CODE
		AND CD_SAUDA_DATE >= @SAUDA_DATE
		AND CD_SAUDA_DATE <= @SAUDA_DATE + ' 23:59:59'
		AND CD_TRADE_NO = ''  
		AND CD_TOT_BUYBROK + CD_TOT_SELLBROK > 0    
		AND CD_PARTY_CODE IN 
		(
			SELECT 
				DISTINCT PARTY_CODE 
			FROM
				#FOSETTLEMENT (NOLOCK)
		)


	UPDATE	#FOSETTLEMENT_1 
	SET		CONT_CL_RATE = C.CL_RATE
	FROM	FOCLOSING C (NOLOCK)
	WHERE	C.TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	AND #FOSETTLEMENT_1.INST_TYPE  = C.INST_TYPE
	AND #FOSETTLEMENT_1.SYMBOL  = C.SYMBOL
	AND #FOSETTLEMENT_1.EXPIRYDATE  = C.EXPIRYDATE
	AND #FOSETTLEMENT_1.STRIKE_PRICE  = C.STRIKE_PRICE
	AND #FOSETTLEMENT_1.OPTION_TYPE  = C.OPTION_TYPE
	AND LEFT(#FOSETTLEMENT_1.INST_TYPE,3) = 'FUT'

			
	IF (SELECT COUNT(1) FROM SYS.TABLES WHERE NAME='TBL_CONTRACT_TERMINAL_MAPPING') > 0 
	BEGIN
		UPDATE #FOSETTLEMENT_1 SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'') 
		FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK) 
		WHERE CONT_USER_ID = T.TERMINAL_ID
		AND ISNULL(T.TERMINAL_ID,'') <> '' 
		AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE 

		UPDATE #FOSETTLEMENT_1 SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'') 
		FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK) 
		WHERE #FOSETTLEMENT_1.ORDER_NO = T.ORDER_NO
		AND ISNULL(T.ORDER_NO,'') <> ''
		AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE 
	END

	/* ------------------------------------------------------------------------
			TAKING FILTERD CLIENT DETAILS TO TEMPORARY TABLE
	---------------------------------------------------------------------------*/
	INSERT INTO  CONTRACT_MASTER
	SELECT  
		@SAUDA_DATE,
		C2.PARTY_CODE,   
		C1.LONG_NAME,   
		C1.L_ADDRESS1,   
		C1.L_ADDRESS2,   
		C1.L_ADDRESS3,   
		C1.L_CITY,   
		C1.L_STATE,   
		C1.L_ZIP,   
		C1.BRANCH_CD ,   
		C1.SUB_BROKER,   
		C1.TRADER,   
		C1.AREA,  
		C1.REGION,  
		C1.FAMILY,   
		C1.PAN_GIR_NO,   
		C1.OFF_PHONE1,   
		C1.OFF_PHONE2,
		PRINTF,   
		MAPIDID,   
		UCC_CODE,  
		C2.SERVICE_CHRG,   
		BROKERNOTE,   
		TURNOVER_TAX,   
		SEBI_TURN_TAX,   
		C2.OTHER_CHRG,   
		INSURANCE_CHRG,  
		SEBI_NO = FD_CODE  ,
		PARTICIPANTCODE = ISNULL(BANKID,''),
		CL_TYPE,
		CL_STATUS
	FROM    CLIENT1 C1   
	WITH   
			(   
					NOLOCK   
			)   
			,   
			CLIENT2 C2   
	WITH   
			(   
					NOLOCK   
			)   
	LEFT OUTER JOIN UCC_CLIENT UC   
	WITH   
			(   
					NOLOCK   
			)   
			ON C2.PARTY_CODE = UC.PARTY_CODE   
	WHERE   C2.CL_CODE       = C1.CL_CODE   
		AND C2.PARTY_CODE IN 
		(
			SELECT 
				DISTINCT PARTY_CODE 
			FROM
				#FOSETTLEMENT (NOLOCK)
		)


	/* ------------------------------------------------------------------------
			TAKING CONTRACT DATA TO THE FINAL TEMP TABLE (NON SUMMARISED)
	---------------------------------------------------------------------------*/

	INSERT INTO CONTRACT_DATA
	SELECT  
			CONTRACTNO,   
			ORDER_NO,   
			ORDER_TIME,   
			TRADE_NO,   
			LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,   
			@SAUDA_DATE,   
			F.PARTY_CODE,   
			INST_TYPE,   
			SYMBOL,   
			LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,   
			ISNULL(STRIKE_PRICE,0) STRIKE_PRICE, 
			OPTION_TYPE,   
			AUCTIONPART , 
			QTY = TRADEQTY,
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN TRADEQTY   
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN TRADEQTY   
					ELSE 0 END),   
			PRICE,
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
							WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0) + TOTBROKAPPLIED
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
			 WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)   + TOTBROKAPPLIED
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1   
					THEN ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1 AND TRADEQTY > 0  
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   
					THEN ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1  AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			NETAMT=(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  
				
			ISNULL(AMOUNT,0) AMOUNT ,   
			PAMT=(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0) + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT=(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0)  - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
							   THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= (   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = (   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = (   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = (   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = (   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = (   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT) + TOTBROKAPPLIED,0),
			ORDFLG = 1,
			PRICEUNIT = CONVERT(VARCHAR,CONVERT(INT,BOOKTYPE)),
			QTY_UNIT = CONVERT(VARCHAR,CONVERT(INT,INSTRUMENT)),
			CONT_CL_RATE,
			CONT_USER_ID,
			CONT_REMARK_ID,
			CONT_REMARK_DESC
	FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C
	WHERE          
			C.PARTY_CODE = F.PARTY_CODE		
			AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
			AND PRINTF <> '3'

	/* ------------------------------------------------------------------------
				TAKING CONTRACT DATA TO THE FINAL TABLE (SUMMARISED)
	---------------------------------------------------------------------------*/


	INSERT INTO CONTRACT_DATA
	SELECT  
			CONTRACTNO,   
			ORDER_NO		='000000000000000',   
			ORDER_TIME      = '',
			TRADE_NO        ='0000000',
			TRADETIME       ='00:00:00',
			@SAUDA_DATE,
			F.PARTY_CODE,
			INST_TYPE,
			SYMBOL,
			EXPIRYDATE,
			STRIKE_PRICE,
			OPTION_TYPE,
			AUCTIONPART,
			QTY = SUM(TRADEQTY),
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(TRADEQTY)
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SUM(TRADEQTY)
					ELSE 0 END),   
			PRICE = SUM(PRICE*TRADEQTY)/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END),
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END)
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2  
					THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(CASE WHEN TRADEQTY > 0 THEN TRADEQTY ELSE 1 END)
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN SUM(ISNULL((BROKAPPLIED + (   
					CASE   
							WHEN C.SERVICE_CHRG=1 AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)  )+ SUM(TOTBROKAPPLIED)
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN SUM(ISNULL((BROKAPPLIED + (   
					CASE   
					WHEN C.SERVICE_CHRG=1   AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0))+ SUM(TOTBROKAPPLIED)
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1  AND SUM(TRADEQTY) > 0 
					THEN SUM(ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0))/SUM(TRADEQTY)   
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   AND SUM(TRADEQTY) > 0  
					THEN SUM(ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0))/SUM(TRADEQTY)
					ELSE 0 END),   
			NETAMT= SUM(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  

			AMOUNT = SUM(ISNULL(AMOUNT,0)),   
			PAMT= SUM(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0)  + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT= SUM(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0)  - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
						 WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= SUM(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
							 WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= SUM(   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = SUM(   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = SUM(   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = SUM(   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = SUM(   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = SUM(   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = SUM(   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= SUM(   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = SUM(ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)+ TOTBROKAPPLIED,0)),
			ORDFLG,
			PRICEUNIT = CONVERT(VARCHAR,CONVERT(INT,BOOKTYPE)),
			QTY_UNIT = CONVERT(VARCHAR,CONVERT(INT,INSTRUMENT)),
			CONT_CL_RATE,
			CONT_USER_ID,
			CONT_REMARK_ID,
			CONT_REMARK_DESC		
	FROM
		#FOSETTLEMENT_1 F,
		CONTRACT_MASTER C
	WHERE          
		C.PARTY_CODE = F.PARTY_CODE   
		AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
		AND PRINTF = '3'
	GROUP BY 
		CONTRACTNO,   
		F.PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		AUCTIONPART,
		SELL_BUY,
		ORDFLG  ,
		CONVERT(INT,BOOKTYPE),
		CONVERT(INT,INSTRUMENT),
		CONT_CL_RATE,
		CONT_USER_ID,
		CONT_REMARK_ID,
		CONT_REMARK_DESC
		

	UPDATE CONTRACT_DATA   
	SET ORDER_NO = F.ORDER_NO,  
	TRADE_NO = F.TRADE_NO,  
	ORDER_TIME = F.CPID,  
	TRADETIME = LEFT(CONVERT(VARCHAR,F.SAUDA_DATE,108),11)  
	FROM #FOSETTLEMENT_1 F  
	WHERE LEFT(CONTRACT_DATA.SAUDA_DATE,11) = LEFT(F.SAUDA_DATE,11)  
	AND CONTRACT_DATA.PARTY_CODE = F.PARTY_CODE  
	AND CONTRACT_DATA.INST_TYPE = F.INST_TYPE  
	AND CONTRACT_DATA.SYMBOL = F.SYMBOL  
	AND CONTRACT_DATA.EXPIRYDATE = F.EXPIRYDATE  
	AND CONTRACT_DATA.STRIKE_PRICE = F.STRIKE_PRICE  
	AND CONTRACT_DATA.OPTION_TYPE = F.OPTION_TYPE  
	AND CONTRACT_DATA.AUCTIONPART = F.AUCTIONPART  
	AND CONTRACT_DATA.SELL_BUY = F.SELL_BUY  
	AND CONTRACT_DATA.ORDER_NO = '000000000000000'  
	AND F.SAUDA_DATE = (SELECT SAUDA_DATE=MIN(SAUDA_DATE)  
		 FROM #FOSETTLEMENT_1 F1  
		 WHERE F1.PARTY_CODE = F.PARTY_CODE  
		 AND F1.INST_TYPE = F.INST_TYPE  
		 AND F1.SYMBOL = F.SYMBOL  
		 AND F1.EXPIRYDATE = F.EXPIRYDATE  
		 AND F1.STRIKE_PRICE = F.STRIKE_PRICE  
		 AND F1.OPTION_TYPE = F.OPTION_TYPE  
		 AND F1.AUCTIONPART = F.AUCTIONPART  
		 AND F1.SELL_BUY = F.SELL_BUY)

	/* ------------------------------------------------------------------------
			TAKING CONTRACT DATA TO THE FINAL ARCHIVAL TABLE (SUMMARISED)
	---------------------------------------------------------------------------*/

	INSERT INTO CONTRACT_DATA_DET
	SELECT  
			CONTRACTNO,   
			ORDER_NO,   
			ORDER_TIME,   
			TRADE_NO,   
			LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,   
			@SAUDA_DATE,   
			F.PARTY_CODE,   
			INST_TYPE,   
			SYMBOL,   
			LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,   
			ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,   
			OPTION_TYPE,
			AUCTIONPART ,
			QTY = TRADEQTY,
			PQTY = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN TRADEQTY   
					ELSE 0 END),   
			SQTY = (   
			CASE   
					WHEN SELL_BUY = 2   
				   THEN TRADEQTY   
					ELSE 0 END),   
			PRICE,
			PRATE = (   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			SRATE = (   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL(PRICE,0)   
					ELSE 0 END),   
			PBROK =(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
				 WHEN C.SERVICE_CHRG=1  AND TRADEQTY > 0 
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0)   + TOTBROKAPPLIED
					ELSE 0 END),   
			SBROK =(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN ISNULL((BROKAPPLIED + (   
					CASE   
			 WHEN C.SERVICE_CHRG=1   AND TRADEQTY > 0
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END )),0) + TOTBROKAPPLIED    
					ELSE 0 END),   
			PNETRATE = (   
			CASE   
					WHEN SELL_BUY =1  AND TRADEQTY > 0 
					THEN ISNULL(NETRATE + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)  
					ELSE 0 END),   
			SNETRATE = (   
			CASE   
					WHEN SELL_BUY =2   AND TRADEQTY > 0
					THEN ISNULL(NETRATE - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX/TRADEQTY)*INSTRUMENT/BOOKTYPE,0)   
							ELSE 0 END),0)   
					ELSE 0 END),   
			NETAMT=(CASE WHEN SELL_BUY = 1 THEN (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) +   
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END) END ) END )  
			ELSE (TRADEQTY * NETRATE * BOOKTYPE / INSTRUMENT) -  
				(CASE WHEN C.SERVICE_CHRG = 1 THEN ISNULL((F.SERVICE_TAX),0) ELSE  
				(CASE WHEN C.SERVICE_CHRG = 0 THEN 0 ELSE  
				(CASE WHEN C.SERVICE_CHRG = 2 THEN 0 ELSE 0 END ) END ) END) END ),  
			ISNULL(AMOUNT,0) AMOUNT ,   
			PAMT=(   
			CASE   
					WHEN SELL_BUY = 1   
					THEN (TRADEQTY * (PRICE+BROKAPPLIED) * BOOKTYPE / INSTRUMENT) + ISNULL(TOTBROKAPPLIED,0)  + (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   

							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
							   WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END) END ) END )   
					ELSE 0 END),   
			SAMT=(   
			CASE   
					WHEN SELL_BUY = 2   
					THEN (TRADEQTY * (PRICE-BROKAPPLIED) * BOOKTYPE / INSTRUMENT) - ISNULL(TOTBROKAPPLIED,0) - (   
					CASE   
							WHEN C.SERVICE_CHRG = 1   
							THEN ISNULL((F.SERVICE_TAX),0)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG = 0   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG = 2   
											THEN 0   
											ELSE 0 END ) END ) END)   
					ELSE 0 END),   
			SELL_BUY,   
			PSERVICE_TAX= (   
			CASE   
					WHEN SELL_BUY = 1   
			  THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			SSERVICE_TAX= (   
					CASE   
					WHEN SELL_BUY = 2   
					THEN (   
					CASE   
							WHEN C.SERVICE_CHRG=0   
							THEN (F.SERVICE_TAX)   
							ELSE (   
							CASE   
									WHEN C.SERVICE_CHRG=1   
									THEN 0   
									ELSE (   
									CASE   
											WHEN C.SERVICE_CHRG=2   
											THEN 0 END) END) END)   
					ELSE 0 END),   
			BROKER_CHRG = (   
			CASE   
					WHEN BROKERNOTE = 1   
					THEN BROKER_CHRG   
					ELSE 0 END ),   
			TURN_TAX = (   
			CASE   
					WHEN TURNOVER_TAX = 1   
					THEN TURN_TAX   
					ELSE 0 END),   
			SEBI_TAX = (   
			CASE   
					WHEN SEBI_TURN_TAX = 1   
					THEN SEBI_TAX   
					ELSE 0 END),   
			OTHER_CHRG = (   
			CASE   
					WHEN C.OTHER_CHRG = 1   
					THEN F.OTHER_CHRG   
					ELSE 0 END) ,   
			INS_CHRG = (   
			CASE   
					WHEN INSURANCE_CHRG = 1   
					THEN INS_CHRG   
					ELSE 0 END ),   
			SERVICE_TAX = (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX   
					ELSE 0 END ),   
			NSERTAX= (   
			CASE   
					WHEN SERVICE_CHRG = 0   
					THEN SERVICE_TAX  
					ELSE 0 END ),   
			BROKERAGE = ISNULL((TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)+ TOTBROKAPPLIED,0),
			ORDFLG,
			PRICEUNIT,
			QTY_UNIT
	FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C
	WHERE          
			C.PARTY_CODE = F.PARTY_CODE
			AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)
			AND PRINTF = '3'

	/* ------------------------------------------------------------------------
						CLEANING TEMPORARY TABLES
	---------------------------------------------------------------------------*/

	DROP TABLE #FOSETTLEMENT
	DROP TABLE #FOSETTLEMENT_1


	/* ------------------------------------------------------------------------
			UPDATING PROCESS TRACKER
	---------------------------------------------------------------------------*/

		UPDATE 
			V2_BUSINESS_PROCESS 
		SET 
			CONTRACT = CONTRACT + 1 ,
			LASTUPDATEDATE = GETDATE()			
		WHERE 
			LEFT(BUSINESS_DATE,11) = @SAUDA_DATE

		INSERT INTO V2_PROCESS_STATUS_LOG 
		( 
			EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
			FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
		)
		SELECT
			EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
			SEGMENT='FUTURES',
			BUSINESSDATE=@SAUDA_DATE,
			PROCESSID = 'CONTRACT',
			PROCESSNAME = 'CONTRACT POPUP',
			FILENAME='',
			START_END_FLAG=1,
			PROCESSDATE=GETDATE(),
			PROCESSBY=@USERNAME,
			MACHINEIP=''
		
END
IF @STRMODE = 'FETCH'
BEGIN
	DECLARE @EXCHANGECODE VARCHAR(3)
	SELECT  TOP 1 @EXCHANGECODE= EXCHANGE FROM FOGLOBALS (NOLOCK)

	IF @FNOBILL_FLAG = 1			-- CONTRACT CUM BILL ENABLED
	BEGIN	
			SELECT 
				CONTRACTNO,
				CONTRACTNO_NEW = CONTRACTNO,
				SAUDA_DATE = @SAUDA_DATE,
				SETT_NO = '',
				SETT_TYPE = '',
				SETT_DATE = '',
				EXCHANGE = @EXCHANGECODE ,
				SEGMENT = 'FUTURES',
				ORDER_NO = '',
				ORDER_TIME = '',
				TRADE_NO = '',
				TRADE_TIME='',
				SCRIPNAME = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
								ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
								+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 	END),
				QTY=ABS(SUM(PQTY-SQTY)),
				TMARK= '0',
				SELL_BUY=(CASE WHEN SUM(PQTY-SQTY) > 0 THEN 1 ELSE 2 END),
				--MARKETRATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PAMT+SAMT)/SUM(PQTY+SQTY) ELSE 0 END),
				--MARKETAMT = SUM(PAMT+SAMT),
				MARKETRATE = (SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END))/ 
							(CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PQTY-SQTY) ELSE 1 END),
				MARKETAMT = SUM(CASE WHEN TRADETYPE = 'BF' THEN PAMT ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BF' THEN SAMT ELSE 0 END),
				
				BROKERAGE = SUM(PBROKAMT-SBROKAMT),
				SERVICE_TAX = SUM(SERVICE_TAX),
				INS_CHRG = SUM(INS_CHRG),
				NETAMOUNT	= SUM(SBILLAMT-PBILLAMT),
				SEBI_TAX = SUM(SEBI_TAX),
				TURN_TAX = SUM(TURN_TAX),
				BROKER_CHRG = SUM(BROKER_NOTE),
				OTHER_CHRG = SUM(D.OTHER_CHRG),
				NETAMOUNTALL= 0,
				BROK  = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PBROKAMT-SBROKAMT)/SUM(PQTY-SQTY) ELSE 0 END),
				NETRATE = 0,
				CL_RATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN  ABS(SUM((PQTY-SQTY)*CL_RATE) / SUM(PQTY-SQTY)) ELSE 0 END), 
				BROKERSEBIREGNO = O.BROKERSEBIREGNO,
				MEMBERCODE = O.MEMBERCODE,
				CINNO = O.CIN,
				SETTTYPE_DESC='',
				BFCF_FLAG = 'BF_'+LEFT(INST_TYPE,1), 
				CONTRACT_HEADER_DET = '', 
				REMARK = '', 
				COMPANYNAME = O.COMPANY, USER_ID='', 
				REMARK_ID	= '', 
				REMARK_DESC = '', 
				NETOBLIGATION = 0,
				M.BRANCH_CD, 
				M.SUB_BROKER, 
				M.TRADER, 
				M.AREA, 
				M.REGION, 
				M.FAMILY, 
				PARTY_CODE= D.PARTY_CODE,
				PARTYNAME = LONG_NAME,
				M.L_ADDRESS1,
				M.L_ADDRESS2,
				M.L_ADDRESS3,
				M.L_STATE,
				M.L_CITY,
				M.L_ZIP,
				M.OFF_PHONE1,
				M.OFF_PHONE2,
				M.PAN_GIR_NO,
				MAPIDID = '',
				UCC_CODE= '',
				SEBI_NO = FD_CODE,
				PARTICIPANT_CODE = BANKID,
				M.CL_TYPE,
				SERVICE_CHRG,
				PRINTF,
				M.CL_STATUS,
				ISIN = '',
				PRICEUNIT = NUMERATOR,
				QTY_UNIT = DENOMINATOR
		 FROM 
			 FOBILLVALAN D WITH (NOLOCK),
			 DBO.CLIENT1 M WITH (NOLOCK),
			 DBO.FOOWNER O WITH (NOLOCK),
			 DBO.CLIENT2 C2 WITH (NOLOCK)
		WHERE
			M.CL_CODE = C2.PARTY_CODE
			AND M.CL_CODE = D.PARTY_CODE
			AND M.CL_TYPE <> 'INS'
			AND LEFT(INST_TYPE,3) = 'FUT' 
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND (TRADETYPE = 'BF' OR (TRADETYPE = 'BT' AND (PQTY-SQTY) <> 0 AND AUCTIONPART='CA' ))
		GROUP BY 
			CONTRACTNO, SAUDA_DATE, M.BRANCH_CD,  M.SUB_BROKER, 
			M.TRADER, M.AREA,  M.REGION,  M.FAMILY,  D.PARTY_CODE,
			LONG_NAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3, M.L_STATE,
			M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2, M.PAN_GIR_NO,
			FD_CODE, BANKID, M.CL_TYPE, SERVICE_CHRG, PRINTF, 
			CASE 
				WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
				ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
				+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END,
			LEFT(INST_TYPE,1),
			O.BROKERSEBIREGNO,O.MEMBERCODE,
			O.CIN,BRANCH_CD,M.SUB_BROKER,
			O.COMPANY,M.CL_STATUS,
			NUMERATOR,
			DENOMINATOR
		HAVING SUM(PQTY-SQTY) <> 0 
	
		UNION ALL
		
		SELECT 
			CONTRACTNO,
			CONTRACTNO_NEW = CONTRACTNO,
			SAUDA_DATE,
			SETT_NO = '',
			SETT_TYPE = '',
			SETT_DATE = '',
			EXCHANGE = @EXCHANGECODE ,
			SEGMENT = 'FUTURES',
			ORDER_NO,
			ORDER_TIME,
			TRADE_NO,
			TRADE_TIME=TRADETIME,
			SCRIPNAME = (
			CASE 
				WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
				ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
				+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END),
			QTY	=PQTY+SQTY,
			--TMARK	= ORDFLG,
			TMARK = '0',
			SELL_BUY ,
			MARKETRATE = PRATE+SRATE,
			MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
			BROKERAGE,
			SERVICE_TAX,
			INS_CHRG,
			NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
						THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
						ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
			SEBI_TAX,
			TURN_TAX,
			BROKER_CHRG,
			D.OTHER_CHRG,
			NETAMOUNTALL = (
			CASE 
				WHEN SELL_BUY = 1 THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
				ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
			END),
			BROK = (
			CASE
				WHEN QTY <> 0 THEN BROKERAGE/QTY*QTY_UNIT/PRICEUNIT
				ELSE BROKERAGE*QTY_UNIT/PRICEUNIT
			END),
			/*
			NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END) 
					ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),
					*/
			NETRATE = (
			CASE
				WHEN QTY <> 0 THEN 
				CASE
					WHEN SELL_BUY = 1 THEN PRICE + (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
					ELSE PRICE - (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
				END
				ELSE PRICE
			END),					
			CL_RATE = CONT_CL_RATE, 
			BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
			CONTRACT_HEADER_DET = '', REMARK = '', 
			COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
			REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
			NETOBLIGATION = 0, 
			M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
			M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
			M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
			M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
			M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
			PARTICIPANT_CODE = '',
			CL_TYPE,
			M.SERVICE_CHRG,
			M.PRINTF,CL_STATUS,
			ISIN = '',
			PRICEUNIT,
			QTY_UNIT
		FROM 
			CONTRACT_DATA D WITH (NOLOCK),
			CONTRACT_MASTER M WITH (NOLOCK),
			DBO.FOOWNER O WITH (NOLOCK)
		WHERE
			M.TRADE_DATE  = D.SAUDA_DATE
			AND M.PARTY_CODE = D.PARTY_CODE
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
		ORDER BY
			SAUDA_DATE,D.PARTY_CODE
	END
	ELSE
	BEGIN
		SELECT 
			CONTRACTNO,
			CONTRACTNO_NEW = CONTRACTNO,
			SAUDA_DATE,
			SETT_NO = '',
			SETT_TYPE = '',
			SETT_DATE = '',
			EXCHANGE = @EXCHANGECODE ,
			SEGMENT = 'FUTURES',
			ORDER_NO,
			ORDER_TIME,
			TRADE_NO,
			TRADE_TIME=TRADETIME,
			SCRIPNAME = (
			CASE 
			WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) 
			ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' ' 
			+ CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE) 
			END),
			QTY	=PQTY+SQTY,
			TMARK	= ORDFLG,
			SELL_BUY ,
			MARKETRATE = PRATE+SRATE,
			MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),
			BROKERAGE,
			SERVICE_TAX,
			INS_CHRG,
			NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' 
						THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END) 
						ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,
			SEBI_TAX,
			TURN_TAX,
			BROKER_CHRG,
			D.OTHER_CHRG,
			NETAMOUNTALL = (CASE WHEN SELL_BUY = 1
						THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)
						ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)
						END),
			BROK = (
			CASE
				WHEN QTY <> 0 THEN BROKERAGE/QTY*QTY_UNIT/PRICEUNIT
				ELSE BROKERAGE*QTY_UNIT/PRICEUNIT
			END),
			/*
			NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END) 
					ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),
					*/
			--NETRATE = (PNETRATE+SNETRATE),	
			NETRATE = (
			CASE
				WHEN QTY <> 0 THEN 
				CASE
					WHEN SELL_BUY = 1 THEN PRICE + (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
					ELSE PRICE - (BROKERAGE/QTY*QTY_UNIT/PRICEUNIT)
				END
				ELSE PRICE
			END),				
			CL_RATE = CONT_CL_RATE, 
			BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1), 
			CONTRACT_HEADER_DET = '', REMARK = '', 
			COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID, 
			REMARK_ID	= CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC, 
			NETOBLIGATION = 0, 
			M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA, 
			M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,
			M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,
			M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,
			M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,
			PARTICIPANT_CODE = '',
			CL_TYPE,
			M.SERVICE_CHRG,
			M.PRINTF,CL_STATUS,
			ISIN = '',
			PRICEUNIT,
			QTY_UNIT			 
		FROM 
			CONTRACT_DATA D WITH (NOLOCK),
			CONTRACT_MASTER M WITH (NOLOCK),
			DBO.FOOWNER O WITH (NOLOCK)
		WHERE
			M.TRADE_DATE  = D.SAUDA_DATE
			AND M.PARTY_CODE = D.PARTY_CODE
			AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
		ORDER BY
		 SAUDA_DATE,D.PARTY_CODE
	END
END		

/* ------------------------------------------------------------------------
								END OF PROCEDURE
---------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PostNcdxFutValan
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PostNcdxFutValan]  
@vtyp smallint,  
@BookType char(2),  
@vno varchar(12),  
@vdt varchar(11),  
@edtdr varchar(11),  
@edtcr varchar(11),  
@cdt datetime,  
@pdt datetime,  
@EnteredBy varchar(25),   
@CheckedBy varchar(25),  
@sett_no  varchar(7),  
@sett_type varchar(3),  
@sessionid int  
  
/*SlipNo,,ChequeInName,ChqPrinted*/  
AS  
  
declare  
@@lno  as int,  
@@vno1 as varchar(12),  
@@refno char(12),  
@@NoDays int,  
@@actnodays int,  
@@balamt money,  
@@SlipNo smallint,  
@@Slipdate datetime,  
@@clearingmode char(2),  
@@receiptno int,  
@@ddno       as int,  
@@vdt1 as datetime,  
@@edt1 as datetime,  
@@edt2 as datetime,  
@@dddt1 as datetime,  
@@reldt1     as datetime,  
@@party_code as varchar(10),   
@@bill_no    as int,   
@@sell_buy    as char(1),   
@@sett_no    as varchar(7),   
@@sett_type  as varchar(3),   
@@amount     as money,    
@@branchcd   as varchar(10),   
@@vnarr      as varchar(234),  
@@vnarr1     as varchar(234),  
@@accat      as tinyint,  
@@acname     as varchar(100),  
@@bnkname    as varchar(20),  
@@brnname    as varchar(20),  
@@rcursor    as cursor  
  
select @@vdt1 = convert(datetime,@vdt+' '+convert(varchar,getdate(),114))  
select @@edt1 = convert(datetime,@edtdr+' '+convert(varchar,getdate(),114))  
select @@edt2 = convert(datetime,@edtcr+' '+convert(varchar,getdate(),114))  
  
select @@vno1 = @vno  
select @@reldt1 = ''  
select @@dddt1 = @vdt  
select @@refno = ''  
select @@nodays = 0  
select @@actnodays  = 0  
select @@balamt = 0  
select @@slipno = 0  
select @@slipdate =''  
select @@ddno = 0  
/*select @@clearingmode =' ' */  
select @@receiptno = 0  
  
select * into #ledger from ledger where 1=2  
  
select * into #ledger1 from ledger1 where 1=2  
  
set @@rcursor = cursor for  
select Party_Code, Bill_No, Sell_Buy, Sett_No, Sett_Type, Amount, BranchCd, Narration, accat, acname=longname  
from NCE.DBO.accbill b left outer join acmast a on b.party_code = a.cltcode  
where sett_no = @sett_no and sett_type = @sett_type  
open @@rcursor  
fetch next from @@rcursor   
into @@party_code, @@bill_no, @@sell_buy, @@sett_no, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname  
  
select @@lno = 0  
select @@vnarr1 = 'Settno=' + rtrim(@Sett_No) + 'NCE' + rtrim(@Sett_type) + rtrim(@@vnarr)  
  
while @@fetch_status = 0  
begin  
  
   if @@accat = 4 or @@branchcd = 'ZZZ'  
   begin  
      select @@bnkname = rtrim(@Sett_No) + 'NCE' + rtrim(@Sett_type) + convert(varchar,@@bill_no,10)  
      select @@brnname = ''  
      select @@lno = @@lno + 1  
     
      Insert into #ledger(vtyp,vno,drcr,vamt,vdt,refno,cltcode,EnteredBy,lno,balamt,  
                           Vno1,booktype,edt,cdt,pdt,NoDays,actnodays,CheckedBy,acname,narration)   
              values (@vtyp,@vno,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@@vdt1,@@refno,upper(@@party_code),@EnteredBy,@@lno,@@balamt,  
                           @@Vno1,@booktype,(case when @@sell_buy = 1 then @@edt1 else @@edt2 end),@cdt,@pdt,@@NoDays,@@actnodays,@CheckedBy,@@acname,@@vnarr1)  
  
      insert into  #ledger1(lno,bnkname,brnname,dd,ddno,dddt,relamt,vtyp,vno,BookType,refno,reldt,micrno,SlipNo,Slipdate,Clear_mode,ChequeInName,ChqPrinted,receiptno,drcr)  
                values (@@lno,@@bnkname,substring(@@brnname,1,20),'B',rtrim(@@ddno),@@dddt1,@@amount,@vtyp,@vno,@BookType,@@refno,@@reldt1,0,@@slipno,@@slipdate,'','',1,@@receiptno,(case when @@sell_buy = 1 then 'D' else 'C' end))  
  
   end  
  
   if @@accat = 4  
   begin  
 insert into billmatch(Exchange,Segment,Sett_type,Sett_No,BillNo,Date,Party_Code,Amount,DrCr,balamt,vtype,vno,lno,Branch,BookType)  
                       values('NCE','FUTURES',@@sett_type,@@sett_no,@@bill_no,@vdt,@@party_code,@@amount,(case when @@sell_buy = 1 then 'D' else 'C' end),@@amount,@vtyp,@vno,@@lno,@@branchcd,@booktype)  
   end  
  
   fetch next from @@rcursor   
   into @@party_code, @@bill_no, @@sell_buy, @@sett_no, @@sett_type, @@amount, @@branchcd, @@vnarr, @@accat, @@acname  
  
end  
  
  
  
insert into ledger select * from #ledger  
  
insert into ledger1 select * from #ledger1  
  
  
Insert into ledger3  
select lno,narration,refno,vtyp,vno,BookType   
from #ledger   
where vtyp = @vtyp and booktype = @booktype and vno = @vno  
  
Insert into ledger3  
select 0,narration,refno,vtyp,vno,BookType   
from #ledger   
where vtyp = @vtyp and booktype = @booktype and vno = @vno and lno = 1  
  
insert into ledger2  
select vtyp, vno, lno, (case when sell_buy = 1 then 'D' else 'C' end), amount, costcode, BookType, cltcode   
from #ledger l, NCE.DBO.accbill b, costmast c  
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and b.sett_no = @sett_no and b.sett_type = @sett_type  
and l.cltcode = b.party_code and b.branchcd = c.costname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHARGES_DETAIL
-- --------------------------------------------------


CREATE  PROCEDURE [dbo].[PR_CHARGES_DETAIL]         
(        
 @SAUDA_DATE_FROM VARCHAR(11),        
 @SAUDA_DATE_TO VARCHAR(11) ,        
 @PARTY_FROM VARCHAR(10),        
 @PARTY_TO VARCHAR(10),    
 @USERNAME VARCHAR(50) = ''    
) AS         
        
         
    
/*    
 PROCEDURE NAME  : CALCULATE_VOLUMNBROK    
 DESCRIPTION : COMPUTE VOLUMN (VALUE/QUANTITY/LOT SIZE)    
 TABLES USING  :     
 1. SCHEME_MASTER - SCHEME DEFINITION MASTER TABLE     
 2. SCHEME_MAPPING - SCHEME MAPPING TO END CLIENT     
 3. CONTRACT_ROUNDING - CLIENT'S CONTRACT LEVEL ROUNDINGS    
 4. CHARGES_DETAIL - KEEPING COMPUTED BROKERAGE    
*/    
    
/*---------------------------------------------------------------------------------------------------------------    
    CREATING TEMP TABLE FOR PROCESS    
----------------------------------------------------------------------------------------------------------------*/    
DECLARE @SEBI_PER NUMERIC(18, 4)    
    
SET @SEBI_PER = 2.5     
    
--BEGIN TRANSACTION    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
     
CREATE TABLE [DBO].[#CHARGES_DETAIL_TEMP]    
(    
 [CD_PARTY_CODE]     [VARCHAR] (10),    
 [CD_SAUDA_DATE]     [DATETIME],    
 [CD_CONTRACT_NO]   [VARCHAR] (14),    
 [CD_TRADE_NO]     [VARCHAR] (20),    
 [CD_ORDER_NO]     [VARCHAR] (20),    
 [CD_INST_TYPE]     [VARCHAR] (6),    
 [CD_SYMBOL]      [VARCHAR] (12),    
 [CD_EXPIRY_DATE]    [DATETIME],    
 [CD_OPTION_TYPE]    [VARCHAR] (2),    
 [CD_STRIKE_PRICE]   [MONEY],    
 [CD_AUCTIONPART]    [VARCHAR] (2),    
 [CD_MARKETLOT]     [INT],    
 [CD_SCHEME_ID]     [INT] ,    
 [CD_COMPUTATIONLEVEL]    [CHAR] (1),    
 [CD_COMPUTATIONON]    [CHAR] (1),    
 [CD_COMPUTATIONTYPE]    [CHAR] (1),    
 [CD_BUYRATE]      [MONEY],    
 [CD_SELLRATE]     [MONEY],    
 [CD_TOT_BUYQTY]     [INT],    
 [CD_TOT_SELLQTY]    [INT],    
 [CD_TOT_BUYTURNOVER]    [MONEY],    
 [CD_TOT_SELLTURNOVER]    [MONEY],    
 [CD_TOT_BUYTURNOVER_ROUNDED]  [MONEY],    
 [CD_TOT_SELLTURNOVER_ROUNDED]  [MONEY],    
 [CD_TOT_TURNOVER]    [MONEY],    
 [CD_TOT_TURNOVER_ROUNDED]  [MONEY],    
 [CD_TOT_LOT]      [INT],    
 [CD_TOT_RES_TURNOVER]    [MONEY],    
 [CD_TOT_RES_TURNOVER_ROUNDED]  [MONEY],    
 [CD_TOT_RES_LOT]    [INT],    
 [CD_TOT_BUYBROK]    [MONEY],    
 [CD_TOT_SELLBROK]    [MONEY],    
 [CD_TOT_BROK]     [MONEY],    
 [CD_TOT_SERTAX]     [MONEY],    
 [CD_TOT_STT]      [MONEY],    
 [CD_TOT_TURN_TAX]   [MONEY],    
 [CD_TOT_OTHER_CHRG]    [MONEY],    
 [CD_TOT_SEBI_TAX]    [MONEY],    
 [CD_TOT_STAMPDUTY]    [MONEY],    
 [CD_EXCH_BUYRATE]    [MONEY],    
 [CD_EXCH_SELLRATE]    [MONEY],    
 [CD_MIN_BROKAMT]    [NUMERIC](18, 4),    
 [CD_MAX_BROKAMT]    [NUMERIC](18, 4),    
 [CD_MIN_SCRIPAMT]    [NUMERIC](18, 4),    
 [CD_MAX_SCRIPAMT]    [NUMERIC](18, 4),    
)    
    
/*    
CREATE TABLE [#FOSETTLEMENT]     
(    
 [SRNO] [INT]  ,    
 [CONTRACTNO] [VARCHAR] (14)  ,    
 [BILLNO] [INT]  ,    
 [TRADE_NO] [VARCHAR] (10)  ,    
 [PARTY_CODE] [VARCHAR] (10)  ,    
 [INST_TYPE] [VARCHAR] (6)  ,    
 [SYMBOL] [VARCHAR] (12)  ,    
 [SEC_NAME] [VARCHAR] (25)  ,    
 [EXPIRYDATE] [SMALLDATETIME]  ,    
 [STRIKE_PRICE] [MONEY]  ,    
 [OPTION_TYPE] [VARCHAR] (2)  ,    
 [USER_ID] [VARCHAR] (15)  ,    
 [PRO_CLI] [INT]  ,    
 [O_C_FLAG] [VARCHAR] (5)  ,    
 [C_U_FLAG] [VARCHAR] (7)  ,    
 [TRADEQTY] [INT]  ,    
 [AUCTIONPART] [VARCHAR] (2)  ,    
 [MARKETTYPE] [MONEY]  ,    
 [SERIES] [CHAR] (2)  ,    
 [ORDER_NO] [VARCHAR] (15)  ,    
 [PRICE] [MONEY]  ,    
 [SAUDA_DATE] [DATETIME]  ,    
 [TABLE_NO] [VARCHAR] (4)  ,    
 [LINE_NO] [DECIMAL](3, 0)  ,    
 [VAL_PERC] [CHAR] (1)  ,    
 [NORMAL] [MONEY]  ,    
 [DAY_PUC] [MONEY]  ,    
 [DAY_SALES] [MONEY]  ,    
 [SETT_PURCH] [MONEY]  ,    
 [SETT_SALES] [MONEY]  ,    
 [SELL_BUY] [INT]  ,    
 [SETTFLAG] [INT]  ,    
 [BROKAPPLIED] [MONEY]  ,    
 [NETRATE] [DECIMAL](15, 7)  ,    
 [AMOUNT] [MONEY]  ,    
 [INS_CHRG] [MONEY]  ,    
 [TURN_TAX] [MONEY]  ,    
 [OTHER_CHRG] [MONEY]  ,    
 [SEBI_TAX] [MONEY]  ,    
 [BROKER_CHRG] [MONEY]  ,    
 [SERVICE_TAX] [MONEY]  ,    
 [TRADE_AMOUNT] [MONEY]  ,    
 [BILLFLAG] [INT]  ,    
 [SETT_NO] [VARCHAR] (12)  ,   
 [NBROKAPP] [MONEY]  ,    
 [NSERTAX] [MONEY]  ,    
 [N_NETRATE] [DECIMAL](15, 7)  ,    
 [SETT_TYPE] [VARCHAR] (3)  ,    
 [CL_RATE] [MONEY]  ,    
 [PARTICIPANTCODE] [VARCHAR] (15)  ,    
 [STATUS] [VARCHAR] (3)  ,    
 [CPID] [INT]  ,    
 [INSTRUMENT] [MONEY]  ,    
 [BOOKTYPE] [MONEY]  ,    
 [BRANCH_ID] [VARCHAR] (15)  ,    
 [TMARK] [VARCHAR] (10)  ,    
 [SCHEME] [INT]  ,    
 [DUMMY1] [INT]  ,    
 [DUMMY2] [MONEY]  ,    
 [RESERVED1] [INT]  ,    
 [RESERVED2] [VARCHAR] (20)      
) ON [PRIMARY]    
    
*/    
    
SELECT * INTO #CHARGES_DETAIL_TEMP1 FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
SELECT * INTO #CHARGES_DETAIL_FINAL FROM #CHARGES_DETAIL_TEMP WHERE 1 = 2    
    
/*    
CREATE INDEX [IDXSDATE] ON [DBO].[#FOSETTLEMENT]     
(    
 [SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL],    
 [EXPIRYDATE], [OPTION_TYPE], [STRIKE_PRICE]    
)    
*/    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_INST_TYPE], [CD_SYMBOL],    
 [CD_EXPIRY_DATE], [CD_OPTION_TYPE], [CD_STRIKE_PRICE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_TEMP1]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_INST_TYPE], [CD_SYMBOL],    
 [CD_EXPIRY_DATE], [CD_OPTION_TYPE], [CD_STRIKE_PRICE]    
)    
    
CREATE INDEX [IDXSDATE] ON [DBO].[#CHARGES_DETAIL_FINAL]     
(    
 [CD_SAUDA_DATE], [CD_PARTY_CODE], [CD_INST_TYPE], [CD_SYMBOL],    
 [CD_EXPIRY_DATE], [CD_OPTION_TYPE], [CD_STRIKE_PRICE]    
)    
    
    
IF @PARTY_TO='' BEGIN SET @PARTY_TO ='ZZZZZ' END    
    
    
UPDATE    
 FOSETTLEMENT    
SET    
 BILLNO = C_REGULAR_LOT     
FROM    
 FOSCRIP2    
WHERE     
 SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59' AND    
 PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO AND     
 FOSCRIP2.INST_TYPE = FOSETTLEMENT.INST_TYPE AND     
 FOSCRIP2.SYMBOL = FOSETTLEMENT.SYMBOL AND     
 FOSCRIP2.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE AND     
 FOSCRIP2.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE AND     
 FOSCRIP2.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE AND    
 FOSETTLEMENT.BILLNO <> C_REGULAR_LOT    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR FLAT VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
    
    
 SELECT     
    T_SAUDADATE = CONVERT(VARCHAR,SAUDA_DATE,103),    
    T_PARTY_CODE = PARTY_CODE,    
    T_INST_TYPE = INST_TYPE,    
    T_SYMBOL = SYMBOL,    
    T_EXPIRYDATE = EXPIRYDATE,    
    T_OPTION_TYPE = OPTION_TYPE,    
    T_STRIKE_PRICE = STRIKE_PRICE,    
    TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1     
       THEN    
        (TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT)    
       ELSE    
        0    
       END),    
    TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2    
       THEN    
        (TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT)    
       ELSE    
        0    
       END) 
       
INTO #TRD_FOSETTLEMENT  

FROM    
    FOSETTLEMENT    
   WHERE    
    SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'    
    AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
   GROUP BY    
    CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE    

   
    
INSERT INTO #CHARGES_DETAIL_TEMP    
(    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,CD_SYMBOL,    
 CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
 CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
 CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
 CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
 CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
 CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
 CD_TOT_SERTAX,CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
)    
    
SELECT    
 PARTY_CODE,SAUDA_DATE,CONTRACTNO,TRADE_NO,ORDER_NO,INST_TYPE,SYMBOL,    
 EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MARKETLOT,SP_SCHEME_ID,    
 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_BROK_COMPUTETYPE,    
 BUYRATE,SELLRATE,    
 BUY_QTY, SELL_QTY,     
 BUY_TURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN BUY_TURNOVER/TOTALLOT ELSE BUY_TURNOVER END),     
        SELL_TURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN SELL_TURNOVER/TOTALLOT ELSE SELL_TURNOVER END),    
 RND_BUY_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_BUY_TURNOVER/TOTALLOT ELSE RND_BUY_TURNOVER END),4),     
 RND_SELL_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_SELL_TURNOVER/TOTALLOT ELSE RND_SELL_TURNOVER END),4),     
 TOTALTURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN TOTALTURNOVER/TOTALLOT ELSE TOTALTURNOVER END),     
        RND_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_TURNOVER/TOTALLOT ELSE RND_TURNOVER END),4),    
 TOTALLOT=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN (BUY_QTY+SELL_QTY)/TOTALLOT ELSE TOTALLOT END),    
 TOTALTURNOVER_RES,RND_TURNOVER_RES,TOTALLOT_RES,    
 BUYBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN BUYBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END)    
     ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,BUYBROKERAGE)     
      ELSE BUYBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END)* BUY_QTY/TOTALLOT    
    ELSE BUYBROKERAGE END),    
        SELLBROKERAGE = (CASE WHEN SP_BROK_COMPUTEON = 'V'    
        THEN (CASE WHEN SELLBROKERAGE > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END)    
     ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,SELLBROKERAGE)     
      ELSE SELLBROKERAGE    
      END))    
     END)    
    ELSE 0     
    END)* SELL_QTY/TOTALLOT    
    ELSE SELLBROKERAGE END),    
 TOTALBROKERAGE = CASE WHEN SP_BROK_COMPUTEON = 'V' THEN 0  ELSE    
   (CASE WHEN (BUYBROKERAGE+SELLBROKERAGE) > 0     
    THEN (CASE WHEN SP_MAX_BROKAMT = - 1     
     THEN (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END)    
     ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,    
      (CASE WHEN SP_MIN_BROKAMT <> 0     
      THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(BUYBROKERAGE+SELLBROKERAGE))     
      ELSE (BUYBROKERAGE+SELLBROKERAGE)    
      END))    
     END)    
    ELSE 0     
    END) END,    
 CD_TOT_SERTAX = 0,CD_TOT_STT,CD_TOT_TURN_TAX,    
 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,    
 CD_EXCH_SELLRATE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT    
FROM    
(    
 SELECT     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO ,    
 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 INST_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN INST_TYPE ELSE LEFT(INST_TYPE,3) END),    
 SYMBOL = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),    
 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 OPTION_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),    
 STRIKE_PRICE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),    
 AUCTIONPART ,    
 MARKETLOT = SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
 SP_COMPUTATION_LEVEL,    
 SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,    
 SP_SCHEME_TYPE,    
 SP_SCHEME_ID,    
 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /     
      SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
     THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
     ELSE 0     
     END),    
 BUY_QTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
 SELL_QTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
 TOTALQTY = SUM(TRADEQTY),    
 TOTALTURNOVER = SUM(TOTAL_TURNOVER),    
 BUY_TURNOVER = SUM(BUY_TURNOVER),    
 RND_BUY_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(SUM(BUY_TURNOVER),SP_MULTIPLIER) ,    
 SELL_TURNOVER = SUM(SELL_TURNOVER),    
 RND_SELL_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(SUM(SELL_TURNOVER),SP_MULTIPLIER) ,    
 RND_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER),SP_MULTIPLIER) ,     
 TOTALLOT = (CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER(SUM(TOTAL_TURNOVER), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'Q'      
   THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER(SUM(TRADEQTY), SP_MULTIPLIER) / CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END)    
   WHEN SP_BROK_COMPUTEON = 'L'    
   THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER(SUM(TRADEQTY),     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY))) /     
    (CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END*SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)))    
   ELSE    
    SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY)    
   END),    
 TOTALTURNOVER_RES = 0,    
 RND_TURNOVER_RES = 0,    
 TOTALLOT_RES = 0,    
 BUYBROKERAGE = (CASE WHEN SP_SCHEME_TYPE = 0     
         THEN (PRADNYA.DBO.ROUNDEDTURNOVER(    
              (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
                                             THEN SUM(BUY_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
                                             ELSE 0    
                                        END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V'     
      THEN 1    
                     ELSE SUM(BUY_TURNOVER)     
                                    END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *     
                            (CASE WHEN SP_BUY_BROK_TYPE = 'P'     
                                  THEN SP_BUY_BROK/100     
                                  ELSE SP_BUY_BROK     
                             END))    
                       WHEN (SUM(TOT_BUYTURNOVER) >= SUM(TOT_SELLTURNOVER) AND SP_SCHEME_TYPE = 1)     
                            OR (SUM(TOT_BUYTURNOVER) > SUM(TOT_SELLTURNOVER) AND SP_SCHEME_TYPE = 3)    
   THEN (PRADNYA.DBO.ROUNDEDTURNOVER(    
              (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
                                             THEN SUM(BUY_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
                                             ELSE 0    
                                        END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V'     
      THEN 1    
     ELSE SUM(BUY_TURNOVER)    
     END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *     
                            (CASE WHEN SP_BUY_BROK_TYPE = 'P'     
                                  THEN SP_BUY_BROK/100     
                                  ELSE SP_BUY_BROK     
                             END))    
                       ELSE (PRADNYA.DBO.ROUNDEDTURNOVER(    
              (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
                                 THEN SUM(BUY_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
                                             ELSE 0    
                                        END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V'     
      THEN 1    
     ELSE SUM(BUY_TURNOVER)    
     END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *     
                            (CASE WHEN SP_SELL_BROK_TYPE = 'P'     
                                  THEN SP_SELL_BROK/100     
                                  ELSE SP_SELL_BROK     
                             END))    
                   END),    
    
 SELLBROKERAGE = (CASE WHEN SP_SCHEME_TYPE = 0     
         THEN (PRADNYA.DBO.ROUNDEDTURNOVER(    
        (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
                                             THEN SUM(SELL_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
           ELSE 0    
                      END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V'     
      THEN 1    
                                  ELSE SUM(SELL_TURNOVER)     
                                    END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *     
                            (CASE WHEN SP_SELL_BROK_TYPE = 'P'     
                                  THEN SP_SELL_BROK/100     
                                  ELSE SP_SELL_BROK     
                             END))    
                       WHEN (SUM(TOT_BUYTURNOVER) >= SUM(TOT_SELLTURNOVER) AND SP_SCHEME_TYPE = 1)     
                            OR (SUM(TOT_BUYTURNOVER) > SUM(TOT_SELLTURNOVER) AND SP_SCHEME_TYPE = 3)    
                            THEN (PRADNYA.DBO.ROUNDEDTURNOVER(    
              (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
                                             THEN SUM(SELL_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
                                             ELSE 0    
                                        END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V'     
      THEN 1    
                                  ELSE SUM(SELL_TURNOVER)     
                                    END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *      
                            (CASE WHEN SP_SELL_BROK_TYPE = 'P'     
                                  THEN SP_SELL_BROK/100     
                                  ELSE SP_SELL_BROK     
                             END))    
                       ELSE (PRADNYA.DBO.ROUNDEDTURNOVER(    
              (CASE WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P'     
             THEN (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
                                             THEN SUM(SELL_TURNOVER)    
                                                 /SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
                                             ELSE 0    
                                        END)    
      WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V'     
      THEN 1    
                                  ELSE SUM(SELL_TURNOVER)     
                                    END),SP_MULTIPLIER)/CASE WHEN SP_MULTIPLIER = 0 THEN 1 ELSE SP_MULTIPLIER END *     
                            (CASE WHEN SP_BUY_BROK_TYPE = 'P'     
                                  THEN SP_BUY_BROK/100     
                                  ELSE SP_BUY_BROK     
                             END))    
                   END),    
 TOTALBROKERAGE = 0,     
 CD_TOT_SERTAX = 0 ,    
 CD_TOT_STT = SUM(INS_CHRG),    
 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
   ELSE 0     
   END),    
 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
    ELSE 0     
    END),    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT    
 FROM     
 (    
 SELECT     
 TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
 INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,    
 TRADEQTY,LOTSIZE = CONVERT(BIGINT,BILLNO),    
 SAUDA_DATE=LEFT(SAUDA_DATE,11),PRICE,       
 SP_PARTY_CODE,SP_COMPUTATION_LEVEL,SP_INST_TYPE,SP_SCRIP,SP_SCHEME_ID,SP_TRD_TYPE,    
 SP_SCHEME_TYPE,SP_MULTIPLIER,SP_BUY_BROK,SP_SELL_BROK,SP_RES_MULTIPLIER,    
 SP_RES_BUY_BROK,SP_RES_SELL_BROK,SP_VALUE_FROM,SP_VALUE_TO,SP_BROK_COMPUTEON,    
 SP_BROK_COMPUTETYPE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
 SP_BUY_BROK_TYPE,SP_SELL_BROK_TYPE,AUCTIONPART,    
 INS_CHRG = (INS_CHRG),    
 TURN_TAX = (TURN_TAX),     
 OTHER_CHRG = (F.OTHER_CHRG),    
 SEBI_TAX = (SEBI_TAX),    
 BROKER_CHRG = (BROKER_CHRG),    
 BUY_TURNOVER =     
  CASE WHEN SELL_BUY = 1 THEN     
    CASE WHEN SP_BROK_COMPUTEON = 'T'     
    THEN TRADEQTY* (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
      CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
      WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
      ELSE PRICE + STRIKE_PRICE END END) * BOOKTYPE / INSTRUMENT    
    WHEN SP_BROK_COMPUTEON = 'Q'    
     THEN TRADEQTY    
    WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
    ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)*BOOKTYPE/INSTRUMENT    
    END    
  ELSE 0 END,    
 SELL_TURNOVER =    
  CASE WHEN SELL_BUY = 2 THEN    
   CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY* (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
     CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
     WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
     ELSE PRICE + STRIKE_PRICE END END) * BOOKTYPE / INSTRUMENT    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
    ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)*BOOKTYPE/INSTRUMENT    
   END    
  ELSE 0 END,    
 TOTAL_TURNOVER =    
  CASE WHEN SP_BROK_COMPUTEON = 'T'     
   THEN TRADEQTY* (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
     CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
     WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
     ELSE PRICE + STRIKE_PRICE END END) * BOOKTYPE / INSTRUMENT    
   WHEN SP_BROK_COMPUTEON = 'Q'    
    THEN TRADEQTY    
   WHEN SP_BROK_COMPUTEON = 'L'    
     THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
    ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)*BOOKTYPE/INSTRUMENT    
  END,    
 BOOKTYPE,INSTRUMENT,    
 TOT_BUYTURNOVER,    
 TOT_SELLTURNOVER    
 FROM    
  FOSETTLEMENT F,    
  #TRD_FOSETTLEMENT FS,    
  SCHEME_MAPPING S,    
  CLIENT1 C1,    
  CLIENT2 C2    
 WHERE    
  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'    
  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
  AND CONVERT(VARCHAR,F.SAUDA_DATE,103) = T_SAUDADATE    
  AND F.PARTY_CODE = T_PARTY_CODE    
  AND F.INST_TYPE = T_INST_TYPE    
  AND F.SYMBOL = T_SYMBOL    
  AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,T_EXPIRYDATE,103)    
  AND F.OPTION_TYPE = T_OPTION_TYPE    
  AND F.STRIKE_PRICE = T_STRIKE_PRICE    
  AND F.PARTY_CODE = SP_PARTY_CODE    
  AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
  AND SYMBOL LIKE  CASE WHEN SP_SCRIP = 'ALL' THEN '%' ELSE SP_SCRIP END    
  AND  1 = CASE    
    WHEN SP_SCRIP = 'ALL' AND SYMBOL NOT IN     
    (     
    SELECT SP_SCRIP FROM SCHEME_MAPPING S    
    WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
    AND F.PARTY_CODE = SP_PARTY_CODE    
    AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
    )     
   THEN 1       
   ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END    
  AND SP_TRD_TYPE = CASE WHEN AUCTIONPART =''    
    THEN 'TRD' ELSE 'DEL' END    
 AND AUCTIONPART <> 'CA'    
 AND TRADEQTY > 0     
 AND SP_BROK_COMPUTETYPE = 'V'    
 AND C1.CL_CODE = C2.CL_CODE     
 AND C2.PARTY_CODE = F.PARTY_CODE    
 --AND CL_TYPE <> 'INS' AND RESERVED1 = 0      
 AND STATUS <> 'E'    
 ) FOSETT     
 GROUP BY     
 PARTY_CODE,    
 SAUDA_DATE,    
 CONTRACTNO,    
 (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN INST_TYPE ELSE LEFT(INST_TYPE,3) END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),    
 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),    
 SP_MULTIPLIER,SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_SCHEME_TYPE,    
 SP_BROK_COMPUTETYPE,SP_VALUE_FROM,SP_VALUE_TO,SP_SCHEME_ID,    
 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,        
 SP_SELL_BROK, SP_BUY_BROK, SP_BUY_BROK_TYPE, SP_SELL_BROK_TYPE,    
 AUCTIONPART,BOOKTYPE,INSTRUMENT    
 HAVING     
 (CASE     
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE* BOOKTYPE / INSTRUMENT)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
  ELSE (SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END) > SP_VALUE_FROM       
 AND       
 (CASE    
  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE* BOOKTYPE / INSTRUMENT)       
  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)      
  ELSE (SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
 END)    
  <=  
    (CASE WHEN SP_VALUE_TO = -1     
     THEN (CASE WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE* BOOKTYPE / INSTRUMENT)       
      WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
      WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
      ELSE (SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
     END)    
    ELSE SP_VALUE_TO    
    END)    
) FOSETTCHRG    
  
DROP TABLE #TRD_FOSETTLEMENT    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_SELLBROK > CD_TOT_BUYBROK    
  AND CD_COMPUTATIONON <> 'V'    
    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK    
  AND CD_TOT_BUYBROK > CD_TOT_SELLBROK     
  AND CD_COMPUTATIONON <> 'V'    
    
UPDATE     
  #CHARGES_DETAIL_TEMP    
SET    
  CD_TOT_BROK =CD_TOT_SELLBROK+ CD_TOT_BUYBROK    
WHERE    CD_COMPUTATIONON = 'V'    
    
/*---------------------------------------------------------------------------------------------------------------    
    FETCHING DATA FOR INCREMENTAL VALUE BASED BROKERAGE    
----------------------------------------------------------------------------------------------------------------*/    
IF (SELECT ISNULL(COUNT(1),0) FROM SCHEME_MAPPING      
WHERE SP_BROK_COMPUTETYPE = 'I' 
AND @SAUDA_DATE_FROM BETWEEN SP_DATE_FROM AND SP_DATE_TO) > 0   
BEGIN

	DECLARE @SETTCUR CURSOR,    
	 @PARTY_CODE VARCHAR(10),    
	 @SAUDA_DATE VARCHAR(11),    
	 @CONTRACTNO VARCHAR(14),    
	 @TRADE_NO VARCHAR(15),    
	 @ORDER_NO VARCHAR(15),    
	 @INST_TYPE VARCHAR(6),    
	 @SYMBOL VARCHAR(12),    
	 @EXPIRYDATE DATETIME,    
	 @OPTION_TYPE VARCHAR(2),    
	 @STRIKE_PRICE MONEY,    
	 @AUCTIONPART VARCHAR(2),    
	 @BUY_TURNOVER MONEY,    
	 @SELL_TURNOVER MONEY,    
	 @LOTSIZE BIGINT,    
	 @BUYRATE MONEY,    
	 @SELLRATE MONEY,    
	 @BUYQTY BIGINT,    
	 @SELLQTY BIGINT,    
	 @TOT_STT MONEY,    
	 @TOT_TURN_TAX MONEY,    
	 @TOT_OTHER_CHRG MONEY,    
	 @TOT_SEBI_TAX MONEY,    
	 @TOT_STAMPDUTY MONEY,    
	 @EXCH_BUYRATE MONEY,    
	 @EXCH_SELLRATE MONEY,    
	 @MIN_BROKAMT MONEY,    
	 @MAX_BROKAMT MONEY,    
	 @MIN_SCRIPAMT MONEY,    
	 @MAX_SCRIPAMT MONEY,    
	 @SP_COMPUTATIONLEVEL CHAR(1),    
	 @SP_COMPUTATIONON CHAR(1),    
	 @SP_COMPUTATIONTYPE CHAR(1),    
	 @SCHEMEID INT    
	    
	DECLARE @SCHEMECUR CURSOR,    
	 @SP_COMPUTATION_LEVEL CHAR(1),    
	 @SP_MULTIPLIER MONEY,    
	 @SP_BUY_BROK_TYPE CHAR(1),    
	 @SP_SELL_BROK_TYPE CHAR(1),    
	 @SP_BUY_BROK NUMERIC (18,4),    
	 @SP_SELL_BROK NUMERIC (18,4),    
	 @SP_VALUE_FROM NUMERIC (18,4),    
	 @SP_VALUE_TO NUMERIC (18,4),    
	 @BUYFLAG BIGINT,    
	 @SELLFLAG BIGINT,    
	 @SP_SCHEME_TYPE INT    
	    
	DECLARE     
	 @NEWBUYTURNOVER MONEY,    
	 @NEWBUYTURNOVERORG MONEY,    
	 @NEWSELLTURNOVER MONEY,    
	 @NEWSELLTURNOVERORG MONEY,    
	 @BUYBROKERAGE MONEY,    
	 @SELLBROKERAGE MONEY    
	    
	DECLARE     
	 @TOT_BUYTURNOVER MONEY,    
	 @TOT_SELLTURNOVER MONEY    
	    
	    
	SET @SETTCUR = CURSOR FOR    
	 SELECT     
	 PARTY_CODE,    
	 SAUDA_DATE,    
	 CONTRACTNO,    
	 TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
	 ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
	 INST_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL = 'C' THEN LEFT(INST_TYPE,3) ELSE INST_TYPE END),    
	 SYMBOL = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),    
	 EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
	 OPTION_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),    
	 STRIKE_PRICE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),    
	 AUCTIONPART,    
	 BUY_TURNOVER = SUM(BUY_TURNOVER),    
	 SELL_TURNOVER = SUM(SELL_TURNOVER),    
	 LOTSIZE=SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),    
	 BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	  END),    
	 SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	  END),    
	 BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
	 SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    
	 CD_TOT_STT = SUM(INS_CHRG),    
	 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
	 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
	 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
	 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
	 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
		THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		 SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
		ELSE 0     
		END),    
	 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
		THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		 SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
		 ELSE 0    
		END),    
	 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
	 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID,    
	 TOT_BUYTURNOVER = SUM(TOT_BUYTURNOVER),    
	 TOT_SELLTURNOVER = SUM(TOT_SELLTURNOVER)    
	 FROM     
	 (    
	 SELECT     
	  TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
	  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,    
	  TRADEQTY,LOTSIZE = CONVERT(BIGINT,BILLNO),SAUDA_DATE=LEFT(SAUDA_DATE,11),PRICE,    
	  BUY_TURNOVER = CASE WHEN SELL_BUY = 1 THEN    
		 CASE WHEN SP_BROK_COMPUTEON = 'T'     
		  THEN TRADEQTY*(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
		  CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
		  WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
		  ELSE PRICE + STRIKE_PRICE END END)*BOOKTYPE/INSTRUMENT    
		 WHEN SP_BROK_COMPUTEON = 'Q'    
		  THEN TRADEQTY    
		 ELSE TRADEQTY / CONVERT(BIGINT,BILLNO)*BOOKTYPE/INSTRUMENT    
		 END    
		ELSE 0 END,    
	  SELL_TURNOVER = CASE WHEN SELL_BUY = 2 THEN    
		 CASE WHEN SP_BROK_COMPUTEON = 'T'     
		  THEN TRADEQTY*(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
		  CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
		  WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
		  ELSE PRICE + STRIKE_PRICE END END)*BOOKTYPE/INSTRUMENT    
		 WHEN SP_BROK_COMPUTEON = 'Q'    
		  THEN TRADEQTY    
		 ELSE TRADEQTY / CONVERT(BIGINT,BILLNO)*BOOKTYPE/INSTRUMENT    
		 END    
		ELSE 0 END,    
	  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,    
	  SP_COMPUTATIONTYPE = SP_BROK_COMPUTETYPE,SP_SCHEME_ID,    
	  SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
	  SP_MULTIPLIER,AUCTIONPART,    
	  INS_CHRG = (INS_CHRG),    
	  TURN_TAX = (TURN_TAX),     
	  OTHER_CHRG = (F.OTHER_CHRG),    
	  SEBI_TAX = (SEBI_TAX),    
	  BROKER_CHRG = (BROKER_CHRG),        
	  TOT_BUYTURNOVER,    
	  TOT_SELLTURNOVER,    
	  BOOKTYPE,    
	  INSTRUMENT    
	 FROM    
	  FOSETTLEMENT F,    
	  (    
	   SELECT     
		T_SAUDADATE = CONVERT(VARCHAR,SAUDA_DATE,103),    
		T_PARTY_CODE = PARTY_CODE,    
		T_INST_TYPE = INST_TYPE,    
		T_SYMBOL = SYMBOL,    
		T_EXPIRYDATE = EXPIRYDATE,    
		T_OPTION_TYPE = OPTION_TYPE,    
		T_STRIKE_PRICE = STRIKE_PRICE,    
		TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1     
		   THEN    
			(TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT)    
		   ELSE    
			0    
		   END),    
		TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2    
		   THEN    
			(TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT)    
		   ELSE    
			0    
		   END)    
	   FROM    
		FOSETTLEMENT    
	   WHERE    
		SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59'    
		AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
	   GROUP BY    
		CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE    
	  ) FS,    
	  SCHEME_MAPPING S,    
	  CLIENT1 C1,    
	  CLIENT2 C2    
	 WHERE    
	  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
	  AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
	  AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
	  AND CONVERT(VARCHAR,F.SAUDA_DATE,103) = T_SAUDADATE    
	  AND F.PARTY_CODE = T_PARTY_CODE    
	  AND F.INST_TYPE = T_INST_TYPE    
	  AND F.SYMBOL = T_SYMBOL    
	  AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,T_EXPIRYDATE,103)    
	  AND F.OPTION_TYPE = T_OPTION_TYPE    
	  AND F.STRIKE_PRICE = T_STRIKE_PRICE    
	  AND F.PARTY_CODE = SP_PARTY_CODE    
	  AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
	  AND SYMBOL LIKE  CASE WHEN SP_SCRIP = 'ALL' THEN '%' ELSE SP_SCRIP END    
	  AND  1 = CASE    
	   WHEN SP_SCRIP = 'ALL' AND SYMBOL NOT IN     
	   (     
		SELECT SP_SCRIP FROM SCHEME_MAPPING S    
		WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
		AND F.PARTY_CODE = SP_PARTY_CODE    
		AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
	   )     
	   THEN 1       
	   ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END    
	 AND SP_TRD_TYPE = CASE WHEN AUCTIONPART =''    
		THEN 'TRD' ELSE 'DEL' END    
	 AND AUCTIONPART <> 'CA'    
	 AND TRADEQTY > 0     
	 AND SP_BROK_COMPUTETYPE = 'I'    
	 AND SP_VALUE_FROM = (SELECT MIN(SP_VALUE_FROM) FROM     
		SCHEME_MAPPING S    
		WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
		AND F.PARTY_CODE = SP_PARTY_CODE    
		AND LEFT(INST_TYPE,3) = SP_INST_TYPE)    
	 AND C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = F.PARTY_CODE    
	 --AND CL_TYPE <> 'INS' AND RESERVED1 = 0      
	 AND STATUS <> 'E'    
	 ) FOSETT    
	     
	 GROUP BY     
	 PARTY_CODE,    
	 SAUDA_DATE,    
	 CONTRACTNO,    
	 (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL = 'C' THEN LEFT(INST_TYPE,3) ELSE INST_TYPE END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),    
	 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),    
	 AUCTIONPART,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
	 SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID    
	    
	OPEN @SETTCUR    
	 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,@INST_TYPE,@SYMBOL,@EXPIRYDATE,    
	 @OPTION_TYPE,@STRIKE_PRICE,@AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
	 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
	 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
	 @SP_COMPUTATIONTYPE,@SCHEMEID,@TOT_BUYTURNOVER,@TOT_SELLTURNOVER    
	    
	 WHILE @@FETCH_STATUS = 0     
	 BEGIN       
	  SELECT @BUYFLAG = 0     
	  SELECT @SELLFLAG = 0     
	    
	  /*-----------------------------------------------------------------------------------------------------------*/    
	  SET @SCHEMECUR = CURSOR FOR    
	  SELECT    
	   SP_COMPUTATION_LEVEL,   
	   SP_MULTIPLIER,    
	   SP_BUY_BROK_TYPE,    
	   SP_SELL_BROK_TYPE,    
	   SP_BUY_BROK,    
	   SP_SELL_BROK,    
	   SP_VALUE_FROM,    
	   SP_VALUE_TO,    
	   SP_SCHEME_TYPE    
	  FROM    
	   SCHEME_MAPPING    
	  WHERE    
	   @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
	   AND SP_PARTY_CODE = @PARTY_CODE      
	   AND SP_INST_TYPE = LEFT(@INST_TYPE,3)    
	   AND @SYMBOL LIKE  CASE WHEN SP_SCRIP = 'ALL' THEN '%' ELSE SP_SCRIP END    
	   AND  1 = CASE    
		WHEN SP_SCRIP = 'ALL' AND @SYMBOL NOT IN     
		(     
		 SELECT SP_SCRIP FROM SCHEME_MAPPING S    
		 WHERE @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
		 AND SP_PARTY_CODE = @PARTY_CODE      
		 AND SP_INST_TYPE = LEFT(@INST_TYPE,3)      
		)     
		THEN 1       
		ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END      
	   AND SP_TRD_TYPE = CASE WHEN @AUCTIONPART =''    
		 THEN 'TRD' ELSE 'DEL' END    
	   AND SP_BROK_COMPUTETYPE = 'I'    
	  ORDER BY SP_VALUE_FROM    
	    
	  OPEN @SCHEMECUR    
	  FETCH NEXT FROM     
	   @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
	   @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
	    
	   SET @NEWBUYTURNOVER = @BUY_TURNOVER     
	   SET @NEWSELLTURNOVER = @SELL_TURNOVER     
	   SET @NEWBUYTURNOVERORG = 0     
	   SET @NEWSELLTURNOVERORG = 0     
	   SET @BUYBROKERAGE = 0    
	   SET @SELLBROKERAGE = 0    
	    
	  WHILE @@FETCH_STATUS = 0 AND (@NEWBUYTURNOVER > 0 OR @NEWSELLTURNOVER > 0)         
	  BEGIN    
	    
	  /*--------------------------------------------------------------------*/    
	  SET @BUYBROKERAGE = 0    
	  SET @SELLBROKERAGE = 0    
	  IF @NEWBUYTURNOVER > 0     
	  BEGIN    
	   IF @BUY_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
	   BEGIN     
		SET @NEWBUYTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
		SET @NEWBUYTURNOVERORG = @NEWBUYTURNOVER * @SP_MULTIPLIER    
	   END    
	   ELSE     
	   BEGIN    
		SET @NEWBUYTURNOVER = @BUY_TURNOVER - @SP_VALUE_FROM    
		IF @NEWBUYTURNOVER < 0  SET @NEWBUYTURNOVER = 0     
		SET @NEWBUYTURNOVERORG  = @NEWBUYTURNOVER      
		SELECT @NEWBUYTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(@NEWBUYTURNOVER,@SP_MULTIPLIER)    
		SELECT @NEWBUYTURNOVER = @NEWBUYTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
		SELECT @BUYFLAG = 1    
	   END    
	   IF @NEWBUYTURNOVER > 0     
	   BEGIN     
		SELECT @BUYBROKERAGE =     
		 CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
		 CASE WHEN @SP_BUY_BROK_TYPE ='P'    
		 THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
		 ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
		 ELSE    
		  CASE WHEN (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=1)    
		   OR   (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=3)    
		  THEN    
		   CASE WHEN @SP_BUY_BROK_TYPE ='P'       
		   THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100    
		   ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END    
		  ELSE    
		   CASE WHEN @SP_SELL_BROK_TYPE ='P'    
		   THEN @NEWBUYTURNOVER * @SP_SELL_BROK  /100    
		   ELSE @NEWBUYTURNOVER * @SP_SELL_BROK END    
		  END    
		 END    
	   END      
	   ELSE       
		SELECT @BUYBROKERAGE = 0       
	   END    
	    
	   IF @NEWSELLTURNOVER > 0     
	   BEGIN    
		IF @SELL_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1    
		BEGIN     
		 SET @NEWSELLTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
		 SET @NEWSELLTURNOVERORG = @NEWSELLTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
		END    
		ELSE     
		BEGIN    
		 SET @NEWSELLTURNOVER = @SELL_TURNOVER - @SP_VALUE_FROM    
		 IF @NEWSELLTURNOVER < 0 SET @NEWSELLTURNOVER = 0      
		 SET @NEWSELLTURNOVERORG  = @NEWSELLTURNOVER       
		 SELECT @NEWSELLTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(@NEWSELLTURNOVER,@SP_MULTIPLIER)    
		 SELECT @NEWSELLTURNOVER = @NEWSELLTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END    
		 SELECT @SELLFLAG = 1    
		END    
		IF @NEWSELLTURNOVER > 0    
		BEGIN      
		 SELECT @SELLBROKERAGE =     
		  CASE WHEN @SP_SCHEME_TYPE = 0 THEN    
		   CASE WHEN @SP_SELL_BROK_TYPE ='P'    
		   THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
		   ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
		  ELSE    
		   CASE WHEN (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=1)    
		   OR   (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=3)    
		   THEN    
			CASE WHEN @SP_SELL_BROK_TYPE ='P'    
			THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100    
			ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END    
		   ELSE    
			CASE WHEN @SP_BUY_BROK_TYPE ='P'    
			THEN @NEWSELLTURNOVER * @SP_BUY_BROK  /100    
			ELSE @NEWSELLTURNOVER * @SP_BUY_BROK END    
		   END    
		  END    
		END    
	   ELSE    
		SELECT @SELLBROKERAGE = 0       
	   END    
	    
	  INSERT INTO #CHARGES_DETAIL_TEMP1     
	  (    
	   CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
	   CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,    
	   CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,    
	   CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	   CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,    
	   CD_TOT_BUYTURNOVER_ROUNDED,CD_TOT_SELLTURNOVER_ROUNDED,    
	   CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
	   CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
	   CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,CD_TOT_SERTAX,    
	   CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,    
	   CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
	   CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	  )    
	  VALUES     
	  (    
	   @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,    
	   @INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,    
	   @STRIKE_PRICE,@AUCTIONPART,@LOTSIZE,@SCHEMEID,    
	   @SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,@SP_COMPUTATIONTYPE,@BUYRATE,@SELLRATE,    
	   @BUYQTY,@SELLQTY,@NEWBUYTURNOVERORG,@NEWSELLTURNOVERORG,    
	   (@NEWBUYTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),    
	   (@NEWSELLTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),0,0,    
	   (@BUYQTY+@SELLQTY)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END ,0,0,0,    
	   @BUYBROKERAGE,@SELLBROKERAGE,0,0,    
	   @TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,    
	   @EXCH_BUYRATE,@EXCH_SELLRATE,    
	   @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT    
	  )     
	      
	  IF @SP_VALUE_TO = -1       
	  BEGIN      
	   SELECT @NEWBUYTURNOVER = 0       
	   SELECT @NEWSELLTURNOVER = 0      
	  END       
	  /*--------------------------------------------------------------------*/    
	  FETCH NEXT FROM     
	  @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,    
	  @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE    
	 END    
	 CLOSE @SCHEMECUR    
	 DEALLOCATE @SCHEMECUR    
	  /*-----------------------------------------------------------------------------------------------------------*/    
	 FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,@INST_TYPE,@SYMBOL,@EXPIRYDATE,    
	 @OPTION_TYPE,@STRIKE_PRICE,@AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,    
	 @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,    
	 @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,    
	 @SP_COMPUTATIONTYPE,@SCHEMEID,@TOT_BUYTURNOVER,@TOT_SELLTURNOVER    
	    
	END    
	CLOSE @SETTCUR   
	DEALLOCATE @SETTCUR    
	    
	INSERT INTO #CHARGES_DETAIL_TEMP    
	 (    
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,CD_SYMBOL,    
	 CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,    
	 CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	 CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,    
	 CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,    
	 CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,    
	 CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,    
	 CD_TOT_SERTAX,    
	 CD_TOT_STT,CD_TOT_TURN_TAX,    
	 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,    
	 CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	 )    
	SELECT     
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,    
	 CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,    
	 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
	 CD_BUYRATE,CD_SELLRATE,CD_TOT_BUYQTY,CD_TOT_SELLQTY,    
	 CD_TOT_BUYTURNOVER,    
	 CD_TOT_SELLTURNOVER,    
	 CD_TOT_BUYTURNOVER_ROUNDED,    
	 CD_TOT_SELLTURNOVER_ROUNDED,    
	 CD_TOT_TURNOVER=CD_TOT_BUYTURNOVER+CD_TOT_SELLTURNOVER,    
	 CD_TOT_TURNOVER_ROUNDED=CD_TOT_BUYTURNOVER_ROUNDED+CD_TOT_SELLTURNOVER_ROUNDED,    
	 CD_TOT_LOT,    
	 CD_TOT_RES_TURNOVER=0,    
	 CD_TOT_RES_TURNOVER_ROUNDED=0,    
	 CD_TOT_RES_LOT,    
	 CD_TOT_BUYBROK=(CASE WHEN CD_TOT_BUYBROK > 0     
		THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
		THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
		 ELSE CD_TOT_BUYBROK    
		 END)    
		ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,    
		 (CASE WHEN CD_MIN_BROKAMT <> 0    
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)     
		 ELSE CD_TOT_BUYBROK    
		 END))    
		END)    
	   ELSE 0     
	   END),    
	 CD_TOT_SELLBROK=(CASE WHEN CD_TOT_SELLBROK > 0     
		THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
		THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
		 ELSE CD_TOT_SELLBROK    
		 END)    
		ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,    
		 (CASE WHEN CD_MIN_BROKAMT <> 0     
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)     
		 ELSE CD_TOT_SELLBROK    
		 END))    
		END)    
	   ELSE 0     
	   END),    
	 CD_TOT_BROK=(CASE WHEN CD_TOT_BROK > 0     
	   THEN (CASE WHEN CD_MAX_BROKAMT = - 1     
	   THEN (CASE WHEN CD_MIN_BROKAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
		ELSE CD_TOT_BROK    
		END)    
	   ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,    
		(CASE WHEN CD_MIN_BROKAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)     
		ELSE CD_TOT_BROK    
		END))    
	   END)    
	  ELSE 0     
	  END),         
	 CD_TOT_SERTAX=0,    
	 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,    
	 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,    
	 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	FROM    
	(    
	 SELECT     
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,    
	 CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,    
	 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	 CD_TOT_BUYQTY= CD_TOT_BUYQTY,    
	 CD_TOT_SELLQTY= CD_TOT_SELLQTY,    
	 CD_TOT_BUYTURNOVER=SUM(CD_TOT_BUYTURNOVER),    
	 CD_TOT_BUYTURNOVER_ROUNDED=SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
	 CD_TOT_SELLTURNOVER=SUM(CD_TOT_SELLTURNOVER),    
	 CD_TOT_SELLTURNOVER_ROUNDED=SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
	 CD_TOT_LOT,    
	 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
	 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
	 CD_TOT_RES_LOT,    
	 CD_TOT_BUYBROK=SUM(CD_TOT_BUYBROK),    
	 CD_TOT_SELLBROK=SUM(CD_TOT_SELLBROK),    
	 CD_TOT_BROK=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),    
	 CD_TOT_SERTAX = 0 ,    
	 CD_TOT_STT=(CD_TOT_STT),    
	 CD_TOT_TURN_TAX=(CD_TOT_TURN_TAX),    
	 CD_TOT_OTHER_CHRG=(CD_TOT_OTHER_CHRG),    
	 CD_TOT_SEBI_TAX=(CD_TOT_SEBI_TAX),    
	 CD_TOT_STAMPDUTY=(CD_TOT_STAMPDUTY),    
	 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
	 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	 FROM     
	 #CHARGES_DETAIL_TEMP1    
	 GROUP BY    
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,    
	 CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,    
	 CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,    
	 CD_TOT_LOT,CD_TOT_RES_LOT,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,    
	 CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT, CD_TOT_BUYQTY, CD_TOT_SELLQTY,    
	 CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY    
	)FOSETTCHRG    
END
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
WHERE    
 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
UPDATE     
 #CHARGES_DETAIL_TEMP    
SET    
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
WHERE    
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)    
    
/*---------------------------------------------------------------------------------------------------------------    
    TAKING DATA FOR SCRIP LEVEL + CONTRACT LEVEL ROUNDING    
----------------------------------------------------------------------------------------------------------------*/    
  
IF (SELECT ISNULL(COUNT(1),0) FROM SCHEME_MAPPING      
WHERE SP_MIN_SCRIPAMT+SP_MAX_SCRIPAMT <> -1
AND  @SAUDA_DATE_FROM BETWEEN SP_DATE_FROM AND SP_DATE_TO
) > 0       
BEGIN  
	 /*SCRIP LEVEL ROUNDING*/    
	 INSERT INTO #CHARGES_DETAIL_FINAL    
	 SELECT     
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
	 CD_TRADE_NO='',    
	 CD_ORDER_NO='',    
	 CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,    
	 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
	 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
	 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
	 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
	 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
	 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
	 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
	 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
	 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
	 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
	 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),    
	 CD_TOT_LOT=SUM(CD_TOT_LOT),    
	 CD_TOT_RES_TURNOVER=1,    
	 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
	 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
	 CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),    
	 CD_TOT_SELLBROK =SUM(CD_TOT_SELLBROK),    
	 CD_TOT_BROK = (CASE WHEN SUM(CD_TOT_BROK) > 0     
		THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
		 THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
		 ELSE SUM(CD_TOT_BROK)    
		 END)    
		ELSE PRADNYA.DBO.FNMIN(CD_MAX_SCRIPAMT,    
		 (CASE WHEN CD_MIN_SCRIPAMT <> 0     
		 THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
		 ELSE SUM(CD_TOT_BROK)    
		 END))    
		END)    
	   ELSE 0     
	   END),    
	 CD_TOT_SERTAX=0,    
	 CD_TOT_STT=SUM(CD_TOT_STT),    
	 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
	 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
	 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
	 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
	 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
	 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
	 0,0,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	 FROM     
	  #CHARGES_DETAIL_TEMP    
	 WHERE    
	  CD_COMPUTATIONLEVEL NOT IN ('C','S')    
	 GROUP BY    
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,    
	 CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,    
	 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
	 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
	 HAVING      
	 SUM(CD_TOT_BROK) <> (CASE WHEN SUM(CD_TOT_BROK) > 0     
		THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1     
		 THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0     
		  THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
		  ELSE SUM(CD_TOT_BROK)    
		  END)    
		 ELSE PRADNYA.DBO.FNMIN(CD_MAX_SCRIPAMT,    
		  (CASE WHEN CD_MIN_SCRIPAMT <> 0     
		  THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))     
		  ELSE SUM(CD_TOT_BROK)    
		  END))    
		 END)    
		ELSE 0     
		END)    
	    
	UPDATE     
	 #CHARGES_DETAIL_FINAL    
	SET    
	 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
	WHERE    
	 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
	    
	UPDATE     
	 #CHARGES_DETAIL_FINAL    
	SET    
	 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
	WHERE    
	 CD_TOT_BUYBROK >= CD_TOT_SELLBROK     
	    
	    
	DELETE     
	 #CHARGES_DETAIL_TEMP     
	FROM     
	 #CHARGES_DETAIL_FINAL    
	WHERE    
	 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
	 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE    
	 AND #CHARGES_DETAIL_TEMP.CD_CONTRACT_NO = #CHARGES_DETAIL_FINAL.CD_CONTRACT_NO    
	 AND #CHARGES_DETAIL_TEMP.CD_SYMBOL = #CHARGES_DETAIL_FINAL.CD_SYMBOL    
	 AND CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_EXPIRY_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_EXPIRY_DATE,103)    
	 AND #CHARGES_DETAIL_TEMP.CD_OPTION_TYPE = #CHARGES_DETAIL_FINAL.CD_OPTION_TYPE    
	 AND #CHARGES_DETAIL_TEMP.CD_STRIKE_PRICE = #CHARGES_DETAIL_FINAL.CD_STRIKE_PRICE    
	 AND  #CHARGES_DETAIL_TEMP.CD_AUCTIONPART = #CHARGES_DETAIL_FINAL.CD_AUCTIONPART    
	    
	    
	 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
	 
 END  

IF (SELECT ISNULL(COUNT(1),0) FROM CONTRACT_ROUNDING
 WHERE @SAUDA_DATE_FROM BETWEEN CR_DATE_FROM AND CR_DATE_TO) > 0       
BEGIN      
	 /*CONTRACT LEVEL ROUNDING*/    
	 TRUNCATE TABLE #CHARGES_DETAIL_FINAL    
	    
	 INSERT INTO #CHARGES_DETAIL_TEMP    
	 SELECT    
	 CD_PARTY_CODE=F.PARTY_CODE,    
	 CD_SAUDA_DATE=LEFT(SAUDA_DATE,11),    
	 CD_CONTRACT_NO=CONTRACTNO,    
	 CD_TRADE_NO=TRADE_NO,    
	 CD_ORDER_NO=ORDER_NO,    
	 CD_INST_TYPE= INST_TYPE,    
	 CD_SYMBOL=SYMBOL,    
	 CD_EXPIRY_DATE=EXPIRYDATE,    
	 CD_OPTION_TYPE=OPTION_TYPE,    
	 CD_STRIKE_PRICE=STRIKE_PRICE,    
	 CD_AUCTIONPART=AUCTIONPART,    
	 CD_MARKETLOT=CONVERT(BIGINT,BILLNO),    
	 CD_SCHEME_ID=0,    
	 CD_COMPUTATIONLEVEL='X',    
	 CD_COMPUTATIONON='',    
	 CD_COMPUTATIONTYPE='',    
	 CD_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	   END),    
	 CD_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	   END),    
	 CD_TOT_BUYQTY = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END),    
	 CD_TOT_SELLQTY = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),    
	 CD_TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END),    
	 CD_TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END),    
	 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END),    
	 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END),    
	 CD_TOT_TURNOVER=SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT),    
	 CD_TOT_TURNOVER_ROUNDED=SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT),    
	 CD_TOT_LOT=0,    
	 CD_TOT_RES_TURNOVER=0,    
	 CD_TOT_RES_TURNOVER_ROUNDED=0,    
	 CD_TOT_RES_LOT=0,    
	 CD_TOT_BUYBROK =  SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED *BOOKTYPE/INSTRUMENT ELSE 0 END ),    
	 CD_TOT_SELLBROK = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED *BOOKTYPE/INSTRUMENT ELSE 0 END ),    
	 CD_TOT_BROK = SUM(TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT),    
	 CD_TOT_SERTAX=SUM(SERVICE_TAX),    
	 CD_TOT_STT=SUM(INS_CHRG),    
	 CD_TOT_TURN_TAX=SUM(TURN_TAX),    
	 CD_TOT_OTHER_CHRG=SUM(F.OTHER_CHRG),    
	 CD_TOT_SEBI_TAX=SUM(SEBI_TAX),    
	 CD_TOT_STAMPDUTY=SUM(BROKER_CHRG),     
	 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	   END),    
	 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
	   THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT ELSE 0 END) /     
		SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
	   ELSE 0     
	   END),    
	 0,0,0,0    
	 FROM    
	 FOSETTLEMENT F    
	 WHERE     
	 SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'    
	 AND F.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
	 AND F.PARTY_CODE IN (SELECT CR_PARTY_CODE FROM CONTRACT_ROUNDING    
	 WHERE SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
	 AND F.PARTY_CODE NOT IN    
	 (    
	 SELECT F.PARTY_CODE FROM #CHARGES_DETAIL_TEMP    
	 WHERE        
	  CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)     
	  AND CD_PARTY_CODE = F.PARTY_CODE    
	  AND CD_INST_TYPE = INST_TYPE    
	  AND CD_SYMBOL = SYMBOL    
	  AND CONVERT(VARCHAR,CD_EXPIRY_DATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
	  AND CD_STRIKE_PRICE = STRIKE_PRICE    
	  AND CD_OPTION_TYPE = OPTION_TYPE    
	  AND CD_AUCTIONPART = AUCTIONPART    
	 )     
	 GROUP BY    
	 LEFT(SAUDA_DATE,11),         
	 F.PARTY_CODE,    
	 INST_TYPE,    
	 SYMBOL,    
	 EXPIRYDATE,    
	 STRIKE_PRICE,    
	 OPTION_TYPE,    
	 AUCTIONPART,    
	 CONTRACTNO,     ORDER_NO,    
	 TRADE_NO,    
	 CONVERT(BIGINT,BILLNO)    
	    
	 INSERT INTO #CHARGES_DETAIL_FINAL     
	 SELECT    
	 CD_PARTY_CODE,CD_SAUDA_DATE,    
	 CD_CONTRACT_NO,    
	 CD_TRADE_NO='',CD_ORDER_NO='',    
	 CD_INST_TYPE= 'FUTOPT',    
	 CD_SYMBOL='BROKERAGE',    
	 CD_EXPIRY_DATE='DEC 31 2049 23:59',    
	 CD_OPTION_TYPE='',CD_STRIKE_PRICE=0,CD_AUCTIONPART='',CD_MARKETLOT=0,    
	 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
	 CD_BUYRATE = 0,    
	 CD_SELLRATE = 0,    
	 CD_TOT_BUYQTY = 0,    
	 CD_TOT_SELLQTY = 0,    
	 CD_TOT_BUYTURNOVER = 0,    
	 CD_TOT_SELLTURNOVER = 0,    
	 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
	 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
	 CD_TOT_TURNOVER=0,    
	 CD_TOT_TURNOVER_ROUNDED=0,    
	 CD_TOT_LOT=0,    
	 CD_TOT_RES_TURNOVER=0,    
	 CD_TOT_RES_TURNOVER_ROUNDED=0,    
	 CD_TOT_RES_LOT=0,    
	 CD_TOT_BUYBROK =  SUM(CD_TOT_BUYBROK), 
	 CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),    
	 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
	   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
		ELSE SUM(CD_TOT_BROK)    
		END)    
	   ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,    
		(CASE WHEN CR_MIN_CONTRACTAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
		ELSE SUM(CD_TOT_BROK)    
		END))    
	   END,    
	 CD_TOT_SERTAX=0,    
	 CD_TOT_STT=0,    
	 CD_TOT_TURN_TAX=0,    
	 CD_TOT_OTHER_CHRG=0,    
	 CD_TOT_SEBI_TAX=0,    
	 CD_TOT_STAMPDUTY=0,    
	 CD_EXCH_BUYRATE=0 ,    
	 CD_EXCH_SELLRATE =0,    
	 0,0,0,0    
	FROM    
	 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
	 ON (CR_PARTY_CODE = CD_PARTY_CODE     
	  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)      
	GROUP BY    
	 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
	 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE,CD_CONTRACT_NO    
	HAVING     
	 SUM(CD_TOT_BROK) > CASE WHEN CR_MAX_CONTRACTAMT = - 1     
	  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
	   THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
	   ELSE SUM(CD_TOT_BROK)    
	   END)    
	  ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,    
	   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
	   THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))    
	   ELSE SUM(CD_TOT_BROK)    
	   END))    
	  END     
	    
   
	    
	INSERT INTO #CHARGES_DETAIL_FINAL     
	SELECT    
	 CD_PARTY_CODE,CD_SAUDA_DATE,    
	 CD_CONTRACT_NO,    
	 CD_TRADE_NO='',CD_ORDER_NO='',    
	 CD_INST_TYPE= 'FUTOPT',    
	 CD_SYMBOL='BROKERAGE',    
	 CD_EXPIRY_DATE='DEC 31 2049 23:59',    
	 CD_OPTION_TYPE='',CD_STRIKE_PRICE=0,CD_AUCTIONPART='',CD_MARKETLOT=0,    
	 CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='C',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',    
	 CD_BUYRATE = 0,    
	 CD_SELLRATE = 0,    
	 CD_TOT_BUYQTY = 0,    
	 CD_TOT_SELLQTY = 0,    
	 CD_TOT_BUYTURNOVER = 0,    
	 CD_TOT_SELLTURNOVER = 0,    
	 CD_TOT_BUYTURNOVER_ROUNDED = 0,    
	 CD_TOT_SELLTURNOVER_ROUNDED = 0,    
	 CD_TOT_TURNOVER=0,    
	 CD_TOT_TURNOVER_ROUNDED=0,    
	 CD_TOT_LOT=0,    
	 CD_TOT_RES_TURNOVER=0,    
	 CD_TOT_RES_TURNOVER_ROUNDED=0,    
	 CD_TOT_RES_LOT=1,    
	 CD_TOT_BUYBROK =  SUM(CD_TOT_BUYBROK),    
	 CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),    
	 CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1     
	   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))    
		ELSE SUM(CD_TOT_BROK)    
		END)    
	   ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,    
		(CASE WHEN CR_MIN_CONTRACTAMT <> 0     
		THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))    
		ELSE SUM(CD_TOT_BROK)    
		END))    
	   END,    
	 CD_TOT_SERTAX=0,    
	 CD_TOT_STT=0,    
	 CD_TOT_TURN_TAX=0,    
	 CD_TOT_OTHER_CHRG=0,    
	 CD_TOT_SEBI_TAX=0,    
	 CD_TOT_STAMPDUTY=0,    
	 CD_EXCH_BUYRATE=0 ,    
	 CD_EXCH_SELLRATE =0,    
	 0,0,0,0    
	 FROM    
	 #CHARGES_DETAIL_TEMP  LEFT OUTER JOIN CONTRACT_ROUNDING     
	 ON (CR_PARTY_CODE = CD_PARTY_CODE     
	  AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
	  AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL )    
	GROUP BY       
	 CD_PARTY_CODE,CR_MIN_CONTRACTAMT,    
	 CR_MAX_CONTRACTAMT,CD_SAUDA_DATE,CD_CONTRACT_NO    
	HAVING     
	 SUM(CD_TOT_BROK) < CASE WHEN CR_MAX_CONTRACTAMT = - 1     
	  THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
	  THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))    
	   ELSE SUM(CD_TOT_BROK)    
	   END)    
	  ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,    
	   (CASE WHEN CR_MIN_CONTRACTAMT <> 0     
	   THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))    
	   ELSE SUM(CD_TOT_BROK)    
	   END))    
	  END    
	    
	UPDATE     
	 #CHARGES_DETAIL_TEMP SET CD_TOT_BUYBROK = 0, CD_TOT_SELLBROK =0, CD_TOT_BROK = 0     
	FROM     
	 #CHARGES_DETAIL_FINAL    
	WHERE    
	 CONVERT(VARCHAR,#CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,#CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)    
	 AND #CHARGES_DETAIL_TEMP.CD_PARTY_CODE = #CHARGES_DETAIL_FINAL.CD_PARTY_CODE   
	 AND #CHARGES_DETAIL_TEMP.CD_COMPUTATIONLEVEL  = 'X' 
	 	    
	DELETE    
	 #CHARGES_DETAIL_TEMP    
	WHERE    
	 CD_COMPUTATIONLEVEL  = 'X'    
	 AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL )    

	UPDATE     
	 #CHARGES_DETAIL_FINAL    
	SET    
	 CD_TOT_BROK = CD_TOT_BROK - (CD_TOT_SELLBROK + CD_TOT_BUYBROK)    
	    
	UPDATE     
	 #CHARGES_DETAIL_FINAL    
	SET    
	 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0    
	WHERE    
	 CD_TOT_SELLBROK > CD_TOT_BUYBROK    
	    
	UPDATE     
	 #CHARGES_DETAIL_FINAL    
	SET    
	 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0    
	WHERE    
	 CD_TOT_BUYBROK >= CD_TOT_SELLBROK    
	    
	 DELETE FROM #CHARGES_DETAIL_TEMP    
	 WHERE CD_PARTY_CODE IN (SELECT CD_PARTY_CODE FROM #CHARGES_DETAIL_FINAL)    
	 AND #CHARGES_DETAIL_TEMP.CD_COMPUTATIONLEVEL  = 'X' 	
  
	 UPDATE #CHARGES_DETAIL_FINAL SET CD_COMPUTATIONLEVEL='C' WHERE CD_COMPUTATIONLEVEL='X'

	 UPDATE #CHARGES_DETAIL_TEMP SET CD_COMPUTATIONLEVEL = 'C' WHERE CD_COMPUTATIONLEVEL  = 'X'    
	    
	    
	 INSERT INTO #CHARGES_DETAIL_TEMP SELECT * FROM #CHARGES_DETAIL_FINAL    
END

 /*FINAL OUTPUT*/    
DELETE FROM CHARGES_DETAIL     
WHERE    
 CD_SAUDA_DATE >= @SAUDA_DATE_FROM      
 AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'    
 AND CD_PARTY_CODE >= @PARTY_FROM    
 AND CD_PARTY_CODE <= @PARTY_TO    
    
INSERT INTO CHARGES_DETAIL     
SELECT     
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 CD_INST_TYPE=  (CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_INST_TYPE ELSE '' END),        
 CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,    
 CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,    
 CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),    
 CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),    
 CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),    
 CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),    
 CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),    
 CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),    
 CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),    
 CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),    
 CD_TOT_LOT=SUM(CD_TOT_LOT),    
 CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),    
 CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),    
 CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),    
 CD_TOT_BUYBROK =  SUM(CD_TOT_BUYBROK),    
 CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),    
 CD_TOT_BROK = SUM(CD_TOT_BROK),    
 CD_TOT_BUYSERTAX= SUM(CD_TOT_BUYBROK * SERVICE_TAX/100 ),    
 CD_TOT_SELLSERTAX= SUM(CD_TOT_SELLBROK * SERVICE_TAX/100 ),    
 CD_TOT_SERTAX= SUM(CD_TOT_BROK * SERVICE_TAX/100 ),    
 CD_TOT_STT=SUM(CD_TOT_STT),    
 CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),    
 CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),    
 CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),    
 CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),    
 CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,    
 CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,    
 GETDATE()    
FROM     
 #CHARGES_DETAIL_TEMP , FOGLOBALS    
WHERE     
 CD_SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT    
GROUP BY    
 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,    
 (CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_INST_TYPE ELSE '' END),        
 CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,    
 CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,    
 CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT    
    
    
/*---------------------------------------------------------------------------------------------------------------    
   CLEANING TEMPORARY TABLES    
----------------------------------------------------------------------------------------------------------------*/    
    
DROP TABLE #CHARGES_DETAIL_TEMP    
DROP TABLE #CHARGES_DETAIL_TEMP1    
DROP TABLE #CHARGES_DETAIL_FINAL    
    
    
/*---------------------------------------------------------------------------------------------------------------    
   KEEPING DUMMY CONTRACT DESCRIPTOR AT THE MASTER    
----------------------------------------------------------------------------------------------------------------*/    
DECLARE @INTCOUNT INT    
SET @INTCOUNT = 0    
    
SELECT @INTCOUNT = COUNT(1) FROM FOSCRIP1 WHERE INST_TYPE ='FUTOPT' AND SYMBOL ='BROKERAGE'    
 AND EXPIRYDATE LIKE  'DEC 31 2049%'    
    
IF @INTCOUNT =0     
BEGIN    
    
 INSERT INTO FOSCRIP1 (INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE)    
 VALUES ('FUTOPT','BROKERAGE','DEC 31 2049 23:59',0,'')    
    
 INSERT INTO FOSCRIP2 (INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,    
  STARTDATE,MATURITYDATE,SERIES,COR_ACT_LEVEL,C_REGULAR_LOT,C_ISSUE_MAT_DT,    
  C_U_INST_TYPE,C_U_SYMBOL,C_U_SERIES,C_U_EXPIRYDATE,C_U_STRIKEPRICE,C_U_OPTION_TYPE,C_U_CAL)    
 VALUES ('FUTOPT','BROKERAGE','BROKERAGE','DEC 31 2049 23:59',    
  0,'',GETDATE(),GETDATE(),'',0,1,GETDATE(),'','','','',0,'',0)    
END    
    
/*--------------------------------------------------------------------------------------------------------------    
   UPDATING FOSETTLEMENT BROK APPLED & SERVICE CHRG TO ZERO FOR THE GIVEN CRITERIA    
----------------------------------------------------------------------------------------------------------------*/    
    
UPDATE     
 FOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0,    
 NETRATE = PRICE    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND CD_INST_TYPE = INST_TYPE    
 AND CD_SYMBOL = SYMBOL    
 AND CONVERT(VARCHAR,CD_EXPIRY_DATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)    
 AND CD_STRIKE_PRICE = STRIKE_PRICE    
 AND CD_OPTION_TYPE = OPTION_TYPE    
 AND CD_AUCTIONPART = AUCTIONPART    
 AND STATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND BROKAPPLIED <> 0    
    
    
UPDATE     
 FOSETTLEMENT    
SET    
 BROKAPPLIED = 0,    
 SERVICE_TAX = 0,    
 NETRATE = PRICE    
FROM    
 CHARGES_DETAIL     
WHERE    
 CONVERT(VARCHAR,CD_SAUDA_DATE,11) = CONVERT(VARCHAR,SAUDA_DATE,11)    
 AND CD_PARTY_CODE = PARTY_CODE    
 AND STATUS <> 'E'    
 AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'    
 AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO    
 AND CD_COMPUTATIONLEVEL  IN ( 'C' , 'O' )    
 AND CD_TOT_RES_LOT=0
   
/*------------------------- PROCESS CONTROLER PLUG IN --------------------------------*/    
UPDATE     
 V2_BUSINESS_PROCESS     
SET     
 VBB = VBB + 1 ,    
 LASTUPDATEDATE = GETDATE()    
    
WHERE     
 LEFT(BUSINESS_DATE,11) = @SAUDA_DATE_FROM    
    
    
INSERT INTO V2_PROCESS_STATUS_LOG     
(     
 EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,    
 FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP    
)    
SELECT    
 EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),    
 SEGMENT='FUTURES',    
 BUSINESSDATE=@SAUDA_DATE_FROM,    
 PROCESSID = 'VBB',    
 PROCESSNAME='VBB COMPUTATION',    
 FILENAME='PARTY -' + @PARTY_FROM + ' - ' + @PARTY_TO +  ' DATE - ' + @SAUDA_DATE_FROM + ' ' + @SAUDA_DATE_TO,    
 START_END_FLAG=1,    
 PROCESSDATE=GETDATE(),    
 PROCESSBY=@USERNAME,    
 MACHINEIP=''    
    
    
--COMMIT TRANSACTION    
    
/*---------------------------------------------------------------------------------------------------------------    
     END OF PROCEDURE    
----------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_COMPUTE_RMS_FEE
-- --------------------------------------------------

      
        
      --[PR_COMPUTE_RMS_FEE] 'may 21 2015'  
CREATE PROC [dbo].[PR_COMPUTE_RMS_FEE] (@SAUDA_DATE VARCHAR(11) ) AS        
        
/*        
 PROC TO COMPUTE THE EXCHAGE'S RISK MANAGEMENT FEES        
 CHARGE LOGIC - 0.005 % ON FRESH POSITION FOR A GRADE SCRIPS        
 CHARGES PERCENTAGE DEFINED ON FOGLOBALS SETTING TABLE        
 A GRADE SCRIP LIST MAINTAINED IN A TABLE 'FOSCRIP_A_GROUP'        
 COMPUTED CHARGES IS APPENDING AT OTHER CHARGES        
          
*/        
        
if (SELECT COUNT(1) FROM FOGLOBALS WHERE  @SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND ISNULL(RMS_FEES,0) > 0 ) = 0     
BEGIN        
 -- NOT ENABLED        
 RETURN        
END        
        
CREATE TABLE #RMSFEES        
(        
 PARTY_CODE VARCHAR(10),        
 SYMBOL VARCHAR(12),        
 EXPIRYDATE DATETIME,        
 FRESH_POS INT,        
 POS_VALUE MONEY,        
 FEES MONEY        
)        
        
CREATE CLUSTERED INDEX IDXFEES ON  #RMSFEES(SYMBOL,EXPIRYDATE)        
        
DECLARE @PRV_SAUDA_DATE VARCHAR(11)        
SELECT @PRV_SAUDA_DATE= MAX (TRADE_DATE) FROM FOCLOSING (NOLOCK)        
WHERE TRADE_DATE < @SAUDA_DATE    
  
        
-- FETCHING FRESH POSITIONS, IF ANY        
INSERT INTO #RMSFEES        
SELECT PARTY_CODE,SYMBOL,EXPIRYDATE,        
FRESH_POS = (CASE WHEN         
     CASE WHEN (PRV_POS<0 AND TDAY_POS <0)         
          THEN PRV_POS - TDAY_POS        
          WHEN (PRV_POS>0 AND TDAY_POS >0)         
          THEN TDAY_POS-PRV_POS        
          ELSE ABS(TDAY_POS)         
     END > 0 THEN         
     CASE WHEN (PRV_POS<0 AND TDAY_POS <0)         
          THEN TDAY_POS - PRV_POS        
          WHEN (PRV_POS>0 AND TDAY_POS >0)         
          THEN TDAY_POS-PRV_POS        
          ELSE TDAY_POS         
     END        
   ELSE 0 END),        
POS_VALUE = 0,FEES=0        
FROM        
(        
 SELECT         
  A.PARTY_CODE,        
  A.SYMBOL,        
  A.EXPIRYDATE,        
  PRV_POS = ISNULL(PRV_POS,0),        
  TDAY_POS = ISNULL(PRV_POS,0)+ ISNULL(TDAY_POS,0)        
 FROM         
 (        
  SELECT PARTY_CODE, SYMBOL,EXPIRYDATE,        
  TDAY_POS = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE - TRADEQTY END)        
  FROM FOSETTLEMENT (NOLOCK)         
  WHERE SAUDA_DATE  BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
   AND AUCTIONPART = ''    
   AND SYMBOL IN (SELECT SYMBOL FROM FOSCRIP_A_GROUP D WHERE D.SYMBOL = FOSETTLEMENT.SYMBOL        
   AND  @SAUDA_DATE BETWEEN D.DATE_FROM AND D.DATE_TO)         
  GROUP BY PARTY_CODE, SYMBOL,EXPIRYDATE        
 ) A        
 LEFT OUTER JOIN        
 (        
  SELECT PARTY_CODE, SYMBOL,EXPIRYDATE,PRV_POS = SUM(PQTY-SQTY)        
  FROM FOBILLVALAN (NOLOCK)        
  WHERE SAUDA_DATE  BETWEEN @PRV_SAUDA_DATE AND @PRV_SAUDA_DATE + ' 23:59'   
    AND AUCTIONPART = ''    
    AND SYMBOL IN (SELECT SYMBOL FROM FOSCRIP_A_GROUP D WHERE D.SYMBOL = FOBILLVALAN.SYMBOL        
    AND  @SAUDA_DATE BETWEEN D.DATE_FROM AND D.DATE_TO)         
  GROUP BY PARTY_CODE, SYMBOL,EXPIRYDATE        
 ) B        
 ON (A.PARTY_CODE = B.PARTY_CODE AND A.SYMBOL = B.SYMBOL        
  AND A.EXPIRYDATE = B.EXPIRYDATE)        
 --WHERE ISNULL(PRV_POS,0) <> ISNULL(TDAY_POS,0)        
) C        
WHERE EXISTS (SELECT SYMBOL FROM FOSCRIP_A_GROUP D WHERE D.SYMBOL = C.SYMBOL        
   AND  @SAUDA_DATE BETWEEN D.DATE_FROM AND D.DATE_TO)      
  
  
DELETE #RMSFEES WHERE FRESH_POS=0        
        
IF (SELECT COUNT(1) FROM #RMSFEES WHERE FRESH_POS <> 0)=0        
BEGIN        
 -- NO RECORDS TO PROCESS        
 DROP TABLE #RMSFEES        
 RETURN        
END        
        
UPDATE #RMSFEES SET POS_VALUE = ABS(FRESH_POS*CL_RATE*NUMERATOR/DENOMINATOR)        
FROM FOCLOSING (NOLOCK),        
FOSCRIP2 (NOLOCK)        
WHERE FOSCRIP2.SYMBOL = #RMSFEES.SYMBOL        
AND FOSCRIP2.EXPIRYDATE = #RMSFEES.EXPIRYDATE        
AND FOCLOSING.TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
AND FOCLOSING.SYMBOL = #RMSFEES.SYMBOL        
AND FOCLOSING.EXPIRYDATE = #RMSFEES.EXPIRYDATE        
        
---- APPLYING CHARGES        
UPDATE #RMSFEES SET FEES = ROUND(POS_VALUE * ISNULL(RMS_FEES,0) /100,4)        
FROM FOGLOBALS WHERE @SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT        
        
CREATE TABLE #RMSFEES_SETT        
(        
 PARTY_CODE VARCHAR(10),        
 SYMBOL VARCHAR(12),        
 EXPIRYDATE DATETIME,        
 TRADEORDERSELL VARCHAR(60)        
)        
        
CREATE CLUSTERED INDEX IDXST ON #RMSFEES_SETT (PARTY_CODE)        
        
-- APPENDING THE COMPUTED CHARGES AT FOSETTLEMENT - OTHER CHARGES        
BEGIN TRAN        
              
 UPDATE FOSETTLEMENT         
 SET OTHER_CHRG = ROUND((FOTAXES.OTHER_CHRG * PRICE * TRADEQTY * BOOKTYPE/INSTRUMENT) / 100,4)     
 FROM FOTAXES,CLIENT1, CLIENT2        
 WHERE         
 SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE        
 AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE        
 AND CLIENT2.OTHER_CHRG =1        
 AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE        
 AND FOSETTLEMENT.INST_TYPE = FOTAXES.INST_TYPE        
 AND FOSETTLEMENT.SYMBOL = FOTAXES.SYMBOL        
 AND FOTAXES.TRANS_CAT = 'TRD'        
 AND PRICE > 0        
 AND TRADEQTY > 0        
 AND AUCTIONPART =''        
        
        
 UPDATE FOSETTLEMENT SET  OTHER_CHRG = ((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END        
 * (PRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
 (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO))            
 FROM FOCLIENTTAXES        
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
 AND FOSETTLEMENT.PARTY_CODE  = FOCLIENTTAXES.PARTY_CODE        
 AND @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO        
 AND PRICE > 0        
 AND TRADEQTY > 0        
 AND AUCTIONPART =''           
        
 INSERT INTO #RMSFEES_SETT        
 SELECT   PARTY_CODE,           
   SYMBOL,        
   EXPIRYDATE,         
    TRADEORDERSELL = MIN(RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY))            
 FROM     FOSETTLEMENT  (NOLOCK)          
 WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'         
  AND EXISTS (SELECT PARTY_CODE            
     FROM   #RMSFEES            
     WHERE  #RMSFEES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE        
     AND #RMSFEES.SYMBOL = FOSETTLEMENT.SYMBOL        
     AND #RMSFEES.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE        
     AND FRESH_POS>0)            
  AND AUCTIONPART = ''            
  AND TRADEQTY > 0        
  AND SELL_BUY = 1        
 GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE          
        
 INSERT INTO  #RMSFEES_SETT        
 SELECT   PARTY_CODE,            
   SYMBOL,        
   EXPIRYDATE,         
    TRADEORDERSELL = MIN(RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY))            
             
 FROM     FOSETTLEMENT  (NOLOCK)          
 WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'         
  AND EXISTS (SELECT PARTY_CODE            
     FROM   #RMSFEES            
     WHERE  #RMSFEES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE        
     AND #RMSFEES.SYMBOL = FOSETTLEMENT.SYMBOL        
     AND #RMSFEES.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE        
     AND FRESH_POS<0)            
  AND AUCTIONPART = ''            
  AND TRADEQTY > 0        
  AND SELL_BUY = 2        
 GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE            
        
 UPDATE FOSETTLEMENT            
 SET    OTHER_CHRG = ISNULL(OTHER_CHRG,0) + #RMSFEES.FEES        
 FROM         
  #RMSFEES,        
  #RMSFEES_SETT        
 WHERE        
 SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'          
 AND #RMSFEES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE        
 AND #RMSFEES.SYMBOL = FOSETTLEMENT.SYMBOL        
 AND #RMSFEES.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE        
 AND #RMSFEES_SETT.PARTY_CODE = FOSETTLEMENT.PARTY_CODE        
 AND #RMSFEES_SETT.TRADEORDERSELL = RTRIM(FOSETTLEMENT.TRADE_NO) + RTRIM(FOSETTLEMENT.ORDER_NO) + CONVERT(VARCHAR,FOSETTLEMENT.SELL_BUY)        
        
 DELETE TBL_RMSFEES WHERE SAUDA_DATE = @SAUDA_DATE  
 
 UPDATE FOSETTLEMENT  
	SET    OTHER_CHRG = PRICE * TRADEQTY * TAX_PERC / 100
	FROM   RMFFEES_Exception  
	WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
	AND FOSETTLEMENT.SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO  
	AND RMFFEES_Exception.INST_TYPE = FOSETTLEMENT.INST_TYPE  
	AND RMFFEES_Exception.SYMBOL = FOSETTLEMENT.SYMBOL       
         
 INSERT INTO TBL_RMSFEES SELECT @SAUDA_DATE,*,GETDATE() FROM #RMSFEES        
        
COMMIT TRAN        
        
DROP TABLE #RMSFEES_SETT        
DROP TABLE #RMSFEES        
        
/*------------------------------------------------------- END OF THE PROC ------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_COLLATERAL_DETAILS_DAS_GET
-- --------------------------------------------------



CREATE PROC [dbo].[PR_FO_COLLATERAL_DETAILS_DAS_GET]
	(
 	@SDATE VARCHAR(11),
	@PARTYCODE VARCHAR(15),
	@TOCODE VARCHAR(15) = ''
	)

	AS
	IF @TOCODE = ''
		BEGIN
			SET @TOCODE = @PARTYCODE
		END
	
	SELECT @SDATE =  CONVERT(VARCHAR(11),MAX(SYSDATE)) FROM MSAJAG..CLOSING (NOLOCK)
	WHERE SYSDATE <= @SDATE	
		
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT 
		PARTY_CODE=PARENTCODE,
		EXCHANGE = 'NCE',
		SEGMENT = 'FUTURES',
		SCRIP_CD =(
		CASE 
			WHEN COLL_TYPE IN ('FD','BG') 
				THEN COLL_TYPE +'-'+ FD_BG_NO
			WHEN COLL_TYPE = 'SEC'
				THEN SCRIP_CD
			ELSE COLL_TYPE
		END),
		EXPIRYDATE = (
		CASE WHEN COLL_TYPE IN ('FD','BG') 
			THEN CONVERT(VARCHAR,MATURITY_DATE,11)
			ELSE ''
		END),	
		QTY=SUM(QTY),
		CL_RATE,
		VAKUATIONPER = MAX(100 - HAIRCUT),
		FINALAMOUNT=SUM(FINALAMOUNT),
		CASH_NCASH,
		SERIES = ISNULL(SERIES,'')
	INTO
		#COLLDETAILS
	FROM
		MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
		CLIENT2_VIEW (NOLOCK)
	WHERE
		CL_CODE = C.PARTY_CODE
		AND C.EXCHANGE = 'NCE'
		AND C.SEGMENT = 'FUTURES'
		AND EFFDATE LIKE @SDATE + '%'
		AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
	GROUP BY 
		PARENTCODE,SCRIP_CD,CL_RATE,CASH_NCASH,ISNULL(SERIES,''),
		(
		CASE WHEN COLL_TYPE IN ('FD','BG') 
			THEN CONVERT(VARCHAR,MATURITY_DATE,11)
			ELSE ''
		END),
		(
		CASE 
			WHEN COLL_TYPE IN ('FD','BG') 
				THEN COLL_TYPE +'-'+ FD_BG_NO
			WHEN COLL_TYPE = 'SEC'
				THEN SCRIP_CD
			ELSE COLL_TYPE
		END)				
	ORDER BY
		CASH_NCASH,
		PARTY_CODE,
		SCRIP_CD


	UPDATE 
		#COLLDETAILS
		SET SCRIP_CD = S2.SCRIP_CD
	FROM 
		BSEDB.DBO.SCRIP2 S2,
		BSEDB.DBO.SCRIP2 S1
	WHERE 
		S1.CO_CODE = S2.CO_CODE
		AND S1.SERIES = S2.SERIES
		AND #COLLDETAILS.SCRIP_CD = S2.BSECODE
		AND #COLLDETAILS.SERIES = 'BSE'
		

	SELECT *
	FROM #COLLDETAILS C
	ORDER BY PARTY_CODE,CASH_NCASH, SCRIP_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_DasDataGen
-- --------------------------------------------------


--Exec PR_FO_DasDataGen 'MAR  9 2007','00','ZZ','Back-End'  
  
CREATE Procedure [dbo].[PR_FO_DasDataGen]  
(  
@fdate datetime,  
@fparty varchar(50),  
@tparty varchar(50),  
@statusname varchar(20)  
)  

as  

DECLARE 
@STARTTIME VARCHAR(20), 
@ENDTIME VARCHAR(20) 

SELECT @STARTTIME = CONVERT(VARCHAR,GETDATE(),109)

Exec PR_FO_TRADE_DETAILS_DAS_UP @fdate,@fparty,@tparty,@statusname   
  
Exec PR_FO_OPEN_POSITION_DAS_UP @fdate,@fparty,@tparty,@statusname   
  
Exec PR_LEDGER_DETAILS_DAS_GET @fdate,@fparty,@tparty,@statusname   

SELECT @ENDTIME = CONVERT(VARCHAR,GETDATE(),109)

SELECT @STARTTIME, @ENDTIME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[PR_FO_LEDGER_DETAILS_DAS_UP]             
(            
    @FDate varchar(11),             
    @Fparty varchar(10),             
    @Tparty varchar(10)             
)            
            
/*==========================================================    
EXEC PR_FO_LEDGER_DETAILS_DAS_UP             
    @SDate = 'MAY 27 2005',             
    @Fparty = 'AHAM001',     
    @Tparty = 'AHAM001'     
==========================================================*/    
    
    
AS            
            
Select                   
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                  
 LEDDD_SAUDA_DATE = @FDATE,                
 LEDDD_OPENING_BAL = sum(LEDDD_OPENING_BAL),                  
 LEDDD_CHQ_REC = sum(LEDDD_CHQ_REC),                  
 LEDDD_CHQ_PAY = sum(LEDDD_CHQ_PAY),                  
 LEDDD_JV_ENTRY = sum(LEDDD_JV_ENTRY),                  
 LEDDD_CLOSING_BAL = sum(LEDDD_CLOSING_BAL),                  
 LEDDD_CASH_MARGIN = sum(LEDDD_CASH_MARGIN),                  
 LEDDD_OPENING_INIT_MARGIN = sum(LEDDD_OPENING_INIT_MARGIN),                  
 LEDDD_MRG_REC = sum(LEDDD_MRG_REC),                  
 LEDDD_MRG_REPAY = sum(LEDDD_MRG_REPAY),                  
 LEDDD_MRG_JV_ENTRY = sum(LEDDD_MRG_JV_ENTRY),                  
 LEDDD_CLOSING_INIT_MARGIN = sum(LEDDD_CLOSING_INIT_MARGIN),                  
 LEDDD_NONCASH_COLL_HC = sum(LEDDD_NONCASH_COLL_HC),                  
 LEDDD_INIT_EXPO_MARGIN = sum(LEDDD_INIT_EXPO_MARGIN),                
 LEDDD_CREATED_BY = 'Back-End',                
 LEDDD_CREATED_DT = Getdate(),                  
 LEDDD_ADD_MARGIN = 0,
 LEDDD_FT_D = SUM(LEDDD_FT_D),
 LEDDD_FT_C = SUM(LEDDD_FT_C),
 LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),
 LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
 LEDDD_CASH_COLL_HC = convert(numeric(18,4),0),
 LEDDD_MARGIN_FLAG = 0
 into #leddet
 From                 
 LEDGER_DETAILS_DAS                  
 WHERE             
    LEDDD_SAUDA_DATE BETWEEN @FDATE and @FDATE +' 23:59:59'
    AND LEDDD_PARTY_CODE BETWEEN @Fparty AND @Tparty               
    Group by LEDDD_PARTY_CODE           
    ORDER by LEDDD_PARTY_CODE
      
        

UPDATE #leddet
SET  LEDDD_CASH_COLL_HC= G.AMOUNT FROM
							( SELECT AMOUNT=ISNULL(SUM(AMOUNT),0),PARTY_CODE
							FROM MSAJAG.DBO.COLLATERALDETAILS C(NOLOCK)
							WHERE EFFDATE BETWEEN @FDATE and @FDATE +' 23:59:59'
							AND C.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
							AND CASH_NCASH = 'C'
							AND COLL_TYPE <> 'MARGIN'
							AND C.EXCHANGE ='MCX' AND C.SEGMENT ='FUTURES'
							GROUP BY PARTY_CODE) G
							WHERE #leddet.LEDDD_PARTY_CODE=G.PARTY_CODE               
          
        
select * from #leddet      
    ORDER by LEDDD_PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[PR_FO_OPEN_POSITION_DAS_GET]           
(          
    @SDate varchar(11),           
    @Fparty varchar(10),           
    @Tparty varchar(10)           
)          
          
AS          


          
SELECT           
    FOPDD_PARTY_CODE,           
    FOPDD_INST_TYPE,           
    FOPDD_SYMBOL,           
    FOPDD_STRIKE_PRICE,           
    FOPDD_OPTION_TYPE,   
    FOPDD_INTFLAG,          
    FOPDD_EXPIRYDATE = left(FOPDD_EXPIRYDATE,11),           
    FOPDD_SEC_NAME,           
    FOPDD_OPENING_PQTY, 
    FOPDD_OPENING_SQTY, 
		FOPDD_TODAY_PQTY , 
		FOPDD_TODAY_SQTY , 
		FOPDD_EXERCISEDQTY , 
		FOPDD_ASSIGNEDQTY , 
		FOPDD_INS_PQTY , 
		FOPDD_INS_SQTY , 
		FOPDD_CLOSING_PQTY , 
		FOPDD_CLOSING_SQTY , 
	FOPDD_EXPQTY, 
		FOPDD_AUTOCORPQTY , 
		FOPDD_LONGVALUE , 
		FOPDD_SHORTVALUE , 
    FOPDD_CLOSINGPRICE ,         
    FOPDD_STLMNTPRICE  ,          
    FOPDD_FLAG         ,        
    FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,        
    FOPDD_CREATED_DT = left(FOPDD_CREATED_DT,11)           
FROM           
FO_POS_DETAILS_DAS           
WHERE           
    FOPDD_SAUDA_DATE like @SDate +'%'           
    AND FOPDD_PARTY_CODE BETWEEN @Fparty AND @Tparty             
ORDER BY           
    FOPDD_PARTY_CODE,           
    FOPDD_FLAG,             
    FOPDD_INST_TYPE,           
    FOPDD_SYMBOL,           
    FOPDD_STRIKE_PRICE,           
    FOPDD_OPTION_TYPE ,         
    FOPDD_EXPIRYDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_UP
-- --------------------------------------------------

CREATE PROCEDURE PR_FO_OPEN_POSITION_DAS_UP
(
    @SDATE VARCHAR(11),                             
    @FPARTY VARCHAR(10),                             
    @TPARTY VARCHAR(10),                             
    @UNAME VARCHAR(10)                             
)                            
                            
AS                            
                            
/*=========================================================================================================                            
PROCEDURE NAME: PR_FO_TRADE_DETAILS_DAS_UP                            
PROCEDURE DESC: PROCEDURE TO POPULATE NSEFO TRADE DETAILS TO BE DISPLAYED IN DAS REPORT.                            
  OPEN POS SP'S ARE                        
  01--SP_HELPTEXT FODAILYOPENPOSITION                        
  02--SP_HELPTEXT FODAILYCFPOSITION                        
  03--SP_HELPTEXT FODAILYOPENPOSITION                        
  04--SP_HELPTEXT FODAILYCFPOSITION                        

/*
EXEC DKM_PR_FO_OPEN_POSITION_DAS_UP_INI 'MAR 28 2007','1851732','1851732',''     
*/
=========================================================================================================*/                            
                            
SET NOCOUNT ON                            
                            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                            
    DELETE                             
    FROM                             
       FO_POS_DETAILS_DAS                             
    WHERE                             
        FOPDD_SAUDA_DATE LIKE @SDATE + '%'                             
        AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                               
                            
                            
/*=========================================================================================================                            
    01 - FODAILYOPENPOSITION - FUT                        
=========================================================================================================*/                            
                               
INSERT                             
INTO                             
FO_POS_DETAILS_DAS                             
SELECT                             
	FOPDD_PARTY_CODE	= PARTY_CODE, 
	FOPDD_INST_TYPE		= INST_TYPE, 
	FOPDD_SYMBOL		= SYMBOL, 
	FOPDD_STRIKE_PRICE	= STRIKE_PRICE, 
	FOPDD_OPTION_TYPE	= OPTION_TYPE, 
	FOPDD_INTFLAG  = '',                          
	FOPDD_EXPIRYDATE	= LEFT(EXPIRYDATE,11), 
	FOPDD_SEC_NAME     = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11),                        
	FOPDD_OPENING_PQTY	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' 
					THEN PQTY-SQTY ELSE 0 END)) > 0 THEN 
					(SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) ELSE 0 END,
	FOPDD_OPENING_SQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) < 0 THEN 
					ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) ELSE 0 END,
	FOPDD_TODAY_PQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)),
	FOPDD_TODAY_SQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)),
	FOPDD_EXERCISEDQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'
					 THEN SQTY ELSE 0 END)),
	FOPDD_ASSIGNEDQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'
					 THEN PQTY ELSE 0 END)),
	FOPDD_INS_PQTY		= (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),
	FOPDD_INS_PQTY		= (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),
	FOPDD_CLOSING_PQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) > 0 THEN
					(SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) ELSE 0 END, 
	FOPDD_CLOSING_SQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) < 0 THEN
					ABS((SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END))) ELSE 0 END, 
	FOPDD_EXPQTY		= SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='FUT' 
					AND AUCTIONPART ='EA' THEN ABS(SQTY-PQTY) ELSE 0 END),
	FOPDD_AUTOCORPQTY	= SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART ='EA'  
					AND LEFT(EXPIRYDATE,11) <> @SDATE THEN ABS(SQTY-PQTY) ELSE 0 END),
	FOPDD_LONGVALUE 	= SUM((CASE WHEN (CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) > 0 THEN
					(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) ELSE 0 END) * CL_RATE * Numerator/Denominator), 
	FOPDD_SHORTVALUE 	= SUM((CASE WHEN (CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) < 0 THEN
					ABS((CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE * Numerator/Denominator), 
/*
	FOPDD_LONGVALUE 	= SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),
	FOPDD_SHORTVALUE 	= SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END), 
*/
	FOPDD_CLOSINGPRICE 	= CL_RATE,
	FOPDD_STLMNTPRICE 	= CL_RATE, 
/*	FOPDD_STLMNTPRICE 	= ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - 
					SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN 
					((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - 
					(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / 
					(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - 
					SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */
	FOPDD_FLAG         = '01' ,                        
	FOPDD_SAUDA_DATE   = @SDATE ,                
	FOPDD_CREATED_BY   = @UNAME,                
	FOPDD_CREATED_DT   = GETDATE()                           
FROM
	FOBILLVALAN (NOLOCK)
WHERE 
	LEFT(SAUDA_DATE,11) = @SDATE 
	AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
	AND LEFT(INST_TYPE,3) = 'FUT'
GROUP BY
	PARTY_CODE, 
	INST_TYPE, 
	SYMBOL, 
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	CL_RATE
ORDER BY 
	PARTY_CODE, 
	INST_TYPE, 
	SYMBOL, 
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE

                           
/*=========================================================================================================                            
    03 - FODAILYOPENPOSITION - OPT                         
=========================================================================================================*/                            
                            
INSERT                             
INTO                             
FO_POS_DETAILS_DAS                             
SELECT          
	FOPDD_PARTY_CODE	= PARTY_CODE, 
	FOPDD_INST_TYPE		= INST_TYPE, 
	FOPDD_SYMBOL		= SYMBOL, 
	FOPDD_STRIKE_PRICE	= STRIKE_PRICE, 
	FOPDD_OPTION_TYPE	= OPTION_TYPE, 
	FLAG=(CASE WHEN OPTION_TYPE LIKE 'C%'  AND SUM(PQTY) - SUM(SQTY) > 0 THEN                             
	 (CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CMCLOSING) THEN                                
	  'OUT'                                
	 ELSE                                
	  CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CMCLOSING) THEN                                
	   'IN'                                
	  ELSE                                
	   'AT'                                
	  END                                
	                                 
	 END)                                
	ELSE                                
	 CASE WHEN OPTION_TYPE LIKE 'C%'  AND SUM(PQTY) - SUM(SQTY) < 0 THEN                                
	  (CASE WHEN MAX(CL_RATE)+ STRIKE_PRICE > MAX(CMCLOSING) THEN                                
	   'OUT'                                
	  ELSE                                
	   CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CMCLOSING) THEN                                
		'IN'                                
	   ELSE                                
		'AT'                                
	   END                                 
	  END)                                 
	 ELSE                                
	  CASE WHEN  OPTION_TYPE LIKE 'P%'  AND SUM(PQTY) - SUM(SQTY) > 0 THEN                                
	   (CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CMCLOSING) THEN             
		'OUT'                                
	   ELSE                                
		CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CMCLOSING) THEN                                
		 'IN'                                
		ELSE                                
		 'AT'                                
		END                                
	   END)                                 
	  ELSE                                
	   CASE WHEN OPTION_TYPE LIKE 'P%'  AND SUM(PQTY) - SUM(SQTY) < 0 THEN                                
		(CASE WHEN MAX(CL_RATE)+STRIKE_PRICE > MAX(CMCLOSING) THEN                         
		 'OUT'                                
		 ELSE                                
		  CASE WHEN MAX(CL_RATE)+STRIKE_PRICE < MAX(CMCLOSING) THEN                                
		   'IN'                                
		  ELSE                                
		   'AT'                                
		  END                                 
		END)                                
	   END                                
	  END                                  
	 END                                 
	END), 
	FOPDD_EXPIRYDATE	= LEFT(EXPIRYDATE,11), 
	FOPDD_SEC_NAME     = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11),                        
	FOPDD_OPENING_PQTY	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' 
					THEN PQTY-SQTY ELSE 0 END)) > 0 THEN 
					(SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) ELSE 0 END,
	FOPDD_OPENING_SQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) < 0 THEN 
					ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN 
					PQTY-SQTY ELSE 0 END)) ELSE 0 END,
	FOPDD_TODAY_PQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN PQTY ELSE 0 END)),
	FOPDD_TODAY_SQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN SQTY ELSE 0 END)),
	FOPDD_EXERCISEDQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'
					 THEN SQTY ELSE 0 END)),
	FOPDD_ASSIGNEDQTY	= (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'
					 THEN PQTY ELSE 0 END)),
	FOPDD_INS_PQTY		= (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),
	FOPDD_INS_PQTY		= (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),
	FOPDD_CLOSING_PQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) > 0 THEN
					(SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) ELSE 0 END, 
	FOPDD_CLOSING_SQTY 	= CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) < 0 THEN
					ABS((SUM(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END))) ELSE 0 END, 
	FOPDD_EXPQTY		= SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='FUT' 
					AND AUCTIONPART ='EA' THEN ABS(SQTY-PQTY) ELSE 0 END),
	FOPDD_AUTOCORPQTY	= SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = 'CA'  
					AND LEFT(EXPIRYDATE,11) <> @SDATE + '%' THEN ABS(SQTY-PQTY) ELSE 0 END),
	FOPDD_LONGVALUE 	= SUM((CASE WHEN (CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) > 0 THEN
					(CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) ELSE 0 END) * CL_RATE * Numerator/Denominator), 
	FOPDD_SHORTVALUE 	= SUM((CASE WHEN (CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END) < 0 THEN
					ABS((CASE WHEN TRADETYPE = 'BF'
					THEN PQTY-SQTY ELSE 0 END) + (CASE WHEN TRADETYPE = 'BT' 
					THEN PQTY ELSE 0 END) - (CASE WHEN TRADETYPE = 'BT' 
					THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE * Numerator/Denominator), 
/*
	FOPDD_LONGVALUE 	= SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),
	FOPDD_SHORTVALUE 	= SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END),
*/ 
	FOPDD_CLOSINGPRICE 	= CL_RATE,
	FOPDD_STLMNTPRICE 	= CL_RATE, 
/*	FOPDD_STLMNTPRICE 	= ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - 
					SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN 
					((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - 
					(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / 
					(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - 
					SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */
	FOPDD_FLAG         = '03' ,                        
	FOPDD_SAUDA_DATE   = @SDATE ,                
	FOPDD_CREATED_BY   = @UNAME,                
	FOPDD_CREATED_DT   = GETDATE()                           
FROM
	FOBILLVALAN (NOLOCK)
WHERE 
	LEFT(SAUDA_DATE,11) = @SDATE 
	AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
	AND LEFT(INST_TYPE,3) = 'OPT'
GROUP BY
	PARTY_CODE, 
	INST_TYPE, 
	SYMBOL, 
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE, 
	CL_RATE 
ORDER BY 
	PARTY_CODE, 
	INST_TYPE, 
	SYMBOL, 
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE
                                
/*  
    SELECT                             
        *                             
    FROM                             
        FO_POS_DETAILS_DAS                             
    WHERE                             
        FOPDD_SAUDA_DATE LIKE @SDATE +'%'                             
        AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                            
    ORDER BY FOPDD_PARTY_CODE, FOPDD_FLAG, FOPDD_INST_TYPE, FOPDD_SYMBOL, FOPDD_STRIKE_PRICE, FOPDD_OPTION_TYPE, FOPDD_EXPIRYDATE                            
*/  
  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[PR_FO_TRADE_DETAILS_DAS_GET]           
(          
    @SDate varchar(11),           
    @Fparty varchar(10),           
    @Tparty varchar(10)           
)          
          
/*==========================================================  
EXEC PR_FO_TRADE_DETAILS_DAS_GET           
    @SDate = 'MAY 27 2005',           
    @Fparty = 'AHAM001',   
    @Tparty = 'AHAM001'   
==========================================================*/  
  
  
AS          
          
SELECT           
    FOTDD_PARTY_CODE,           
    FOTDD_INST_TYPE,           
    FOTDD_SYMBOL,           
    FOTDD_STRIKE_PRICE,           
    FOTDD_OPTION_TYPE,           
    FOTDD_EXPIRY_DATE = left(FOTDD_EXPIRY_DATE,11),           
    FOTDD_SEC_NAME,           
    FOTDD_TRADEQTY,           
    FOTDD_VALUE,           
    FOTDD_PRICE,           
    FOTDD_PQTY,           
    FOTDD_SQTY,           
    FOTDD_PAMT,           
    FOTDD_SAMT,           
    FOTDD_NETRATE,           
    FOTDD_CFPPRICE,           
    FOTDD_CFSPRICE,           
    FOTDD_SETTPRICE,           
    FOTDD_SAUDA_DATE = left(FOTDD_SAUDA_DATE,11),           
    FOTDD_PNETRATE,           
    FOTDD_SNETRATE,           
    FOTDD_CHARGES,           
    FOTDD_BROKERAGE,           
    FOTDD_SERVICE_TAX,           
    FOTDD_BROKER_NOTE,           
    FOTDD_TURN_TAX,           
    FOTDD_SEBI_TAX,           
    FOTDD_CONTRACTNO,           
    FOTDD_PCOMM,           
    FOTDD_SCOMM,           
    FOTDD_INS_CHRG,           
    FOTDD_FLAG = LEFT(FOTDD_FLAG,2),   
    TRADE_TYPE = RIGHT(FOTDD_FLAG,2),   
    FOTDD_O_C_FLAG,           
    FOTDD_AUCTIONPART,           
    FOTDD_CREATED_BY,           
    FOTDD_CREATED_DT = left(FOTDD_CREATED_DT,11)           
FROM           
    FO_TRADE_DETAILS_DAS           
WHERE           
    FOTDD_SAUDA_DATE like @SDate +'%'           
    AND FOTDD_PARTY_CODE BETWEEN @Fparty AND @Tparty             
ORDER BY           
    FOTDD_PARTY_CODE,         
    LEFT(FOTDD_FLAG,2),         
--    FOTDD_O_C_FLAG,         
    FOTDD_INST_TYPE,         
    FOTDD_SYMBOL,         
    FOTDD_STRIKE_PRICE,         
    FOTDD_OPTION_TYPE,         
    FOTDD_EXPIRY_DATE,   
    TRADE_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_UP
-- --------------------------------------------------

 
--PR_FO_TRADE_DETAILS_DAS_UP 'jul 31 2007','SRSAM025','SRSAM025','BACKEND'

--EXEC PR_FO_TRADE_DETAILS_DAS_UP 'JUL 10 2006','0','Z','BACKEND'           
  
CREATE  PROCEDURE [dbo].[PR_FO_TRADE_DETAILS_DAS_UP]           
(          
    @SDate varchar(11),           
    @Fparty varchar(10),           
    @Tparty varchar(10),           
    @UName varchar(10)           
)          
          
AS          
          
/*=========================================================================================================          
Procedure Name: PR_FO_TRADE_DETAILS_DAS_UP          
Procedure Desc: Procedure to Populate NSEFO Trade Details to be displayed in DAS Report.          
Procedure Summary:           
    01-TRADES CONFIRMATION - FUTURES          
    02-TRADES CONFIRMATION - OPTIONS          
    03-EXERCISE/ASSIGNMENT OF POSITIONS          
    MARK TO MARKET STATEMENT          
        04-TradeType       = 'BF'          
        05-TradeType       = 'BT'          
        06-Carry Forward Records          
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS          
    
EXEC PR_FO_TRADE_DETAILS_DAS_UP           
    @SDate = 'MAY 27 2005',           
    @Fparty = '0',           
    @Tparty = 'ZZZ',           
    @UName = 'BACKEND'    
=========================================================================================================*/          
          
Declare           
    @MemberCode as varchar(12)            
          
SET NOCOUNT ON          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
          
    DELETE           
    FROM           
        FO_TRADE_DETAILS_DAS           
    WHERE           
        FOTDD_SAUDA_DATE like @SDate + '%'           
        AND FOTDD_PARTY_CODE BETWEEN @Fparty AND @Tparty             
          
          
/*=========================================================================================================          
    01-TRADES CONFIRMATION - FUTURES          
=========================================================================================================*/          
          
SELECT           
    Party_Code,           
    Inst_Type,           
    Symbol,           
    expdate,           
    PQty,           
    SQty,           
    pAmt,           
    SAmt,           
    pnetrate,           
    snetrate,           
    charges,           
    Brokerage,           
    service_tax,           
    broker_note,           
    turn_tax,           
    sebi_tax,           
    ContractNo,           
    pComm,           
    sComm,           
    ins_chrg,
    Denominator,
    Numerator
INTO           
    #foDailyConfirm           
FROM           
    (           
    SELECT           
        s.Party_Code,           
        Inst_Type,           
        Symbol,           
        expdate = left(EXPIRYDATE, 11),           
        PQty,           
        SQty,           
        PAmt     = Pamt-pbrokamt,           
        SAmt     = Samt+sbrokamt,           
        pNetRate = pRate,           
        sNetRate = sRate,           
        pComm    =           
        (             
            CASE           
                WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (PBrokAmt) + Service_Tax           
                    ELSE (PBrokAmt) END           
                ELSE PBrokAmt END             
        )          
        ,           
        sComm =           
        (             
            CASE           
           WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (SBrokAmt) + Service_Tax           
                    ELSE (SBrokAmt) END           
                ELSE SBrokAmt END             
        )          
       ,           
        Charges = (PBrokAmt+SBrokAmt) +           
        (             
            CASE           
                WHEN C2.Service_Chrg <> 2           
                THEN (Service_Tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN (turn_tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
               WHEN Sebi_Turn_tax = 1           
                THEN (sebi_tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN BrokerNote = 1           
                THEN (Broker_note)           
                ELSE 0 END             
        )          
        ,           
        brokerage =           
        (             
            CASE           
                WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (PBrokAmt+SBrokAmt) + Service_Tax           
                    ELSE (PBrokAmt+SBrokAmt) END           
              ELSE PBrokAmt+SBrokAmt END             
        )          
        ,           
        service_tax =           
        (             
            CASE           
                WHEN C2.Service_Chrg = 0           
                THEN (Service_Tax)           
                ELSE 0 END           
        )          
        ,           
        broker_note =           
       (             
            CASE           
                WHEN BrokerNote = 1           
                THEN (Broker_note)           
                ELSE 0 END             
        )          
        ,           
        turn_tax =           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN ( turn_tax)           
                ELSE 0 END             
        )          
        ,           
        Sebi_tax =           
        (             
            CASE           
                WHEN Sebi_Turn_tax = 1           
                THEN (sebi_tax)           
                ELSE 0 END             
        )          
        ,           
        ContractNo,           
        Ins_Chrg =           
        (             
            CASE           
                WHEN Insurance_Chrg = 1           
                THEN ins_chrg           
                ELSE 0 END           
        ),           
	Denominator,
	Numerator
    FROM           
        FoBillvalan s WITH(NoLock)          
        ,           
        client2 c2 WITH(NoLock)           
    WHERE           
        sauda_date like @SDate + '%'           
        AND c2.party_code = s.party_code           
        AND C2.party_code BETWEEN @Fparty AND @Tparty             
        AND left(inst_type, 3) = 'FUT'           
        AND TradeType          = 'BT'           
    ) S             
            
            
    INSERT           
    INTO           
        FO_TRADE_DETAILS_DAS           
    SELECT           
        FOTDD_PARTY_CODE = Party_Code,           
        FOTDD_INST_TYPE = Inst_Type,           
        FOTDD_SYMBOL = Symbol,           
        FOTDD_STRIKE_PRICE = 0,           
        FOTDD_OPTION_TYPE = '',           
        FOTDD_EXPIRY_DATE = expdate,           
        FOTDD_SEC_NAME = '',           
        FOTDD_TRADEQTY = 0,           
        FOTDD_VALUE = 0,           
        FOTDD_PRICE = 0,           
        FOTDD_PQTY = sum(PQty),           
        FOTDD_SQTY = sum(SQty),           
        FOTDD_PAMT = sum(PAmt),           
        FOTDD_SAMT = sum(SAmt),           
        FOTDD_NETRATE = 0,           
        FOTDD_CFPPRICE = 0,          
        FOTDD_CFSPRICE = 0,           
        FOTDD_SETTPRICE = 0,           
        FOTDD_SAUDA_DATE = @SDate,           
        FOTDD_PNETRATE =           
        (          
            CASE           
            WHEN sum(pQty) > 0           
            THEN sum(pAmt*Denominator/Numerator)/sum(pQty)
	    --THEN sum(PNetrate*PQty)/SUM(PQty)
            ELSE 0 END           
        ),           
        FOTDD_SNETRATE =           
        (          
            CASE           
            WHEN sum(sQty) > 0           
            THEN sum(sAmt*Denominator/Numerator)/sum(sQty)
	    --THEN sum(SNetrate*SQty)/SUM(SQty)
            ELSE 0 END           
        ),           
        FOTDD_CHARGES = sum(Charges),           
        FOTDD_BROKERAGE = sum(Brokerage),           
        FOTDD_SERVICE_TAX = sum(service_tax),           
        FOTDD_BROKER_NOTE = sum(broker_note),           
        FOTDD_TURN_TAX = sum(turn_tax),           
        FOTDD_SEBI_TAX = sum(Sebi_tax),           
        FOTDD_CONTRACTNO = ContractNo,           
        FOTDD_PCOMM = sum(PComm),           
        FOTDD_SCOMM = sum(sComm),           
        FOTDD_INS_CHRG = sum(ins_chrg),           
        FOTDD_FLAG = '01',           
        FOTDD_O_C_FLAG = '',           
        FOTDD_AUCTIONPART = '',           
        FOTDD_CREATED_BY = @UName,           
        FOTDD_CREATED_DT = getdate()           
    FROM           
        #foDailyConfirm With(NoLock)           
    GROUP BY           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        Expdate,           
        ContractNo           
--    ORDER BY Party_Code, Inst_Type, Symbol, expirydate, Sauda_date             
            
          
/*=========================================================================================================          
    02-TRADES CONFIRMATION - OPTIONS          
=========================================================================================================*/          
          
SELECT           
    Party_Code,           
    Inst_Type,           
    Symbol,           
    expdate,           
    pQty,           
    sQty,           
    pAmt,           
    sAmt,           
    pnetrate,           
    snetrate,           
    charges,           
    brokerage,           
    service_tax,           
    broker_note,           
    turn_tax,           
    sebi_tax,         
    strike_price,           
    option_type,           
    ContractNo,           
    pComm,           
    sComm,           
    ins_chrg,
    Denominator,
    Numerator
INTO           
    #foDailyConfirm_Opt           
FROM           
    (           
    SELECT           
        s.Party_Code,           
        Inst_Type,           
        Symbol,           
        expdate = left(EXPIRYDATE, 11),           
        PQty,           
        SQty,           
        PAmt     = PQty* pRate,           
        SAmt     = SQty* sRate,           
        pNetRate = pRate,           
        sNetRate = sRate,           
        pComm    =           
        (             
            CASE           
                WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (PBrokAmt) + Service_Tax           
   ELSE (PBrokAmt) END           
                ELSE PBrokAmt END             
        )          
        ,           
        sComm =           
        (             
            CASE           
                WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (SBrokAmt) + Service_Tax           
                    ELSE (SBrokAmt) END           
                ELSE SBrokAmt END             
        )          
        ,           
        Charges = (PBrokAmt+SBrokAmt) +           
        (             
            CASE           
                WHEN C2.Service_Chrg <> 2           
                THEN (Service_Tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN (turn_tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Sebi_Turn_tax = 1           
                THEN (sebi_tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN BrokerNote = 1           
                THEN (Broker_note)           
                ELSE 0 END             
        )          
        ,           
        brokerage =           
        (             
            CASE           
                WHEN c2.Service_Chrg = 1           
                THEN           
                CASE           
                    WHEN c2.SerTaxMethod = 0           
                    THEN (PBrokAmt+SBrokAmt) + Service_Tax           
                    ELSE (PBrokAmt+SBrokAmt) END           
                ELSE PBrokAmt+SBrokAmt END             
        )          
        ,           
        service_tax =                 (             
            CASE           
                WHEN C2.Service_Chrg = 0           
                THEN (Service_Tax)           
                ELSE 0 END           
        )          
        ,           
        broker_note =           
        (             
            CASE           
                WHEN BrokerNote = 1           
                THEN (Broker_note)           
                ELSE 0 END             
        )          
        ,           
        turn_tax =           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN ( turn_tax)           
                ELSE 0 END             
        )          
        ,           
        Sebi_tax =           
        (             
            CASE           
                WHEN Sebi_Turn_tax = 1           
                THEN (sebi_tax)           
                ELSE 0 END             
        )          
        ,           
        Ins_Chrg =           
        (             
     	    CASE           
                WHEN Insurance_Chrg = 1           
                THEN ins_chrg           
                ELSE 0 END           
        )          
        ,           
        ContractNo,           
        strike_price,           
        option_type,
	Denominator,
	Numerator
    FROM           
        FoBillvalan s WITH(NoLock),           
        client2 c2 WITH(NoLock)           
    WHERE           
        sauda_date like @SDate + '%'           
        AND c2.party_code = s.party_code           
        AND C2.party_code BETWEEN @Fparty AND @Tparty             
        AND LEFT(inst_type, 3) = 'OPT'           
        AND s.AUCTIONPART not in ('EA', 'CA')           
        AND TradeType = 'BT'           
    ) F            
          
    INSERT         
    INTO           
        FO_TRADE_DETAILS_DAS           
    SELECT           
        FOTDD_PARTY_CODE = Party_Code,           
        FOTDD_INST_TYPE = Inst_Type,           
        FOTDD_SYMBOL = Symbol,           
        FOTDD_STRIKE_PRICE = strike_price,           
        FOTDD_OPTION_TYPE = option_type,           
        FOTDD_EXPIRY_DATE = expdate,           
        FOTDD_SEC_NAME = '',           
        FOTDD_TRADEQTY = 0,           
        FOTDD_VALUE = 0,           
        FOTDD_PRICE = 0,           
        FOTDD_PQTY = sum(PQty),           
        FOTDD_SQTY = sum(SQty),           
        FOTDD_PAMT = sum(PAmt),           
        FOTDD_SAMT = sum(SAmt),           
        FOTDD_NETRATE = 0,           
        FOTDD_CFPPRICE = 0,          
        FOTDD_CFSPRICE = 0,           
        FOTDD_SETTPRICE = 0,           
        FOTDD_SAUDA_DATE = @SDate,           
        FOTDD_PNETRATE =           
        (          
            CASE           
            WHEN sum(pQty) > 0           
            THEN sum(pAmt*Denominator/Numerator)/sum(pQty)
	    --THEN sum(PNetrate*PQty)/SUM(PQty)	           
            ELSE 0 END           
        ),           
        FOTDD_SNETRATE =           
        (          
            CASE           
            WHEN sum(sQty) > 0           
            THEN sum(sAmt*Denominator/Numerator)/sum(sQty)
	    --THEN sum(SNetrate*SQty)/SUM(SQty)           
            ELSE 0 END           
        ),           
        FOTDD_CHARGES = sum(Charges),           
        FOTDD_BROKERAGE = sum(Brokerage),           
        FOTDD_SERVICE_TAX = sum(service_tax),           
        FOTDD_BROKER_NOTE = sum(broker_note),           
        FOTDD_TURN_TAX = sum(turn_tax),           
        FOTDD_SEBI_TAX = sum(Sebi_tax),           
        FOTDD_CONTRACTNO = ContractNo,           
        FOTDD_PCOMM = sum(PComm),           
        FOTDD_SCOMM = sum(sComm),           
        FOTDD_INS_CHRG = sum(ins_chrg),           
        FOTDD_FLAG = '02',           
        FOTDD_O_C_FLAG = '',           
        FOTDD_AUCTIONPART = '',           
        FOTDD_CREATED_BY = @UName,           
        FOTDD_CREATED_DT = getdate()           
    FROM           
        #foDailyConfirm_Opt           
    GROUP BY           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        expdate,           
        ContractNo,           
        option_type,           
        strike_price           
--    ORDER BY Party_Code, Inst_Type, Symbol, expirydate, strike_price, option_type, Sauda_date            
          
          
/*=========================================================================================================          
    03-EXERCISE/ASSIGNMENT OF POSITIONS          
=========================================================================================================*/          
          
INSERT           
INTO           
    FO_TRADE_DETAILS_DAS           
SELECT           
    FOTDD_PARTY_CODE   = Party_Code,           
    FOTDD_INST_TYPE    = Inst_Type,           
    FOTDD_SYMBOL       = Symbol,           
    FOTDD_STRIKE_PRICE = strike_price,           
    FOTDD_OPTION_TYPE  = option_type,           
    FOTDD_EXPIRY_DATE  = expdate,           
    FOTDD_SEC_NAME     = '',           
    FOTDD_TRADEQTY     = 0,           
    FOTDD_VALUE        = 0,           
    FOTDD_PRICE        = Price,           
    FOTDD_PQTY         = PQty,           
    FOTDD_SQTY         = SQty,           
    FOTDD_PAMT         = PAmt,           
    FOTDD_SAMT         = SAmt,           
    FOTDD_NETRATE      = netrate,           
    FOTDD_CFPPRICE     = 0,           
    FOTDD_CFSPRICE     = 0,           
    FOTDD_SETTPRICE    = settprice,           
    FOTDD_SAUDA_DATE   = @SDate,           
    FOTDD_PNETRATE     = 0,           
    FOTDD_SNETRATE     = 0,           
    FOTDD_CHARGES      = Charges,           
    FOTDD_BROKERAGE    = Brokerage,           
    FOTDD_SERVICE_TAX  = service_tax,           
    FOTDD_BROKER_NOTE  = broker_note,           
    FOTDD_TURN_TAX     = turn_tax,           
    FOTDD_SEBI_TAX     = Sebi_tax,           
    FOTDD_CONTRACTNO   = '',           
    FOTDD_PCOMM        = 0,           
    FOTDD_SCOMM        = 0,           
    FOTDD_INS_CHRG     = Ins_Chrg,           
    FOTDD_FLAG         = '03',           
    FOTDD_O_C_FLAG     = '',           
   FOTDD_AUCTIONPART  = '',           
    FOTDD_CREATED_BY   = @UName,           
    FOTDD_CREATED_DT   = getdate()           
FROM           
    (           
    SELECT           
        s.party_code,           
        inst_type,           
        symbol,           
        expdate = left(expirydate, 11),           
        strike_price,           
        option_type,           
        pqty =           
        (             
            CASE           
                WHEN sell_buy = 1           
                THEN sum(tradeqty)           
                ELSE 0 END             
        )          
        ,           
        pamt =           
        (             
            CASE           
                WHEN sell_buy = 1           
                THEN sum(tradeqty*price*Booktype/Instrument)           
                ELSE 0 END             
        )          
        ,           
        sqty =           
        (             
            CASE           
                WHEN sell_buy = 2           
                THEN sum(tradeqty)           
                ELSE 0 END             
        )          
        ,           
        samt =           
        (             
            CASE   
                WHEN sell_buy = 2           
                THEN sum(tradeqty*price*Booktype/Instrument)           
                ELSE 0 END             
        )          
        ,           
        netrate   = price,           
        settprice = max(cl_rate),           
        Charges   = Sum(BrokApplied*TradeQty*Booktype/Instrument) +           
        (             
            CASE           
                WHEN C2.Service_Chrg <> 2           
                THEN Sum(Service_Tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN Sum(turn_tax)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Sebi_Turn_tax = 1           
                THEN Sum(sebi_tax)           
                ELSE 0 END             
        )           
        +           
        (            
            CASE           
                WHEN BrokerNote = 1           
                THEN Sum(Broker_chrg)           
                ELSE 0 END             
        )           
        +           
        (             
            CASE           
                WHEN Insurance_Chrg = 1           
                THEN sum(ins_chrg)           
                ELSE 0 END           
        )          
        ,           
        Brokerage   = Sum(BrokApplied*TradeQty*Booktype/Instrument),           
        service_tax =           
        (             
            CASE           
                WHEN C2.Service_Chrg <> 2           
                THEN Sum(Service_Tax)           
                ELSE 0 END           
        )          
        ,           
        broker_note =           
        (             
            CASE           
                WHEN BrokerNote = 1           
                THEN Sum(Broker_chrg)           
                ELSE 0 END             
        )          
        ,           
        turn_tax =           
        (             
            CASE           
                WHEN Turnover_tax = 1           
                THEN Sum(turn_tax)           
                ELSE 0 END             
        )          
        ,           
        Sebi_tax =           
        (             
            CASE           
                WHEN Sebi_Turn_tax = 1           
                THEN Sum(sebi_tax)           
                ELSE 0 END             
        )          
        ,           
        Ins_Chrg =     
        (             
            CASE           
                WHEN Insurance_Chrg = 1           
                THEN sum(ins_chrg)           
                ELSE 0 END           
        )          
        ,           
        Price           
    FROM           
        fosettlement s WITH(NoLock),           
        Client2 C2 WITH(NoLock)           
    WHERE           
        sauda_date like @SDate + '%'           
        AND C2.party_code BETWEEN @Fparty AND @Tparty             
        AND s.party_code       = c2.party_code           
        AND left(inst_type, 3) = 'OPT'           
        AND auctionpart        = 'EA'           
    GROUP BY           
        s.party_code,           
        s.Inst_Type,           
        s.Symbol,           
        S.EXPIRYDATE,           
        s.strike_price,           
        s.option_type,           
        S.Sell_buy,           
        Price,           
        C2.Service_Chrg,           
        Turnover_tax,           
        Sebi_Turn_tax,           
        Insurance_Chrg,           
        BrokerNote             
    ) F            
--    ORDER BY party_code, inst_type, symbol, expirydate, strike_price, option_type             
          
          
/*=========================================================================================================          
    MARK TO MARKET STATEMENT          
    04-TradeType       = 'BF'          
    05-TradeType       = 'BT'          
    06-Carry Forward Records          =========================================================================================================*/          
          
set @MemberCode = (select MemberCode from Foowner)            
            
    INSERT           
    INTO           
        FO_TRADE_DETAILS_DAS           
    SELECT           
        FOTDD_PARTY_CODE = Party_Code,           
        FOTDD_INST_TYPE = Inst_Type,          
        FOTDD_SYMBOL = Symbol,           
        FOTDD_STRIKE_PRICE = 0,           
        FOTDD_OPTION_TYPE = '',           
        FOTDD_EXPIRY_DATE = ExpDate,           
        FOTDD_SEC_NAME = '',           
        FOTDD_TRADEQTY = 0,           
        FOTDD_VALUE = 0,           
        FOTDD_PRICE = 0,           
        FOTDD_PQTY = PQty,           
        FOTDD_SQTY = SQty,           
        FOTDD_PAMT = PAmt,           
        FOTDD_SAMT = SAmt,           
        FOTDD_NETRATE = 0,           
        FOTDD_CFPPRICE = CFPPrice,          
        FOTDD_CFSPRICE = CFSPrice,           
        FOTDD_SETTPRICE = SettPrice,           
        FOTDD_SAUDA_DATE = @SDate,           
        FOTDD_PNETRATE = 0,           
        FOTDD_SNETRATE = 0,           
        FOTDD_CHARGES = Charges,           
        FOTDD_BROKERAGE = 0,           
        FOTDD_SERVICE_TAX = 0,           
        FOTDD_BROKER_NOTE = 0,           
        FOTDD_TURN_TAX = 0,           
        FOTDD_SEBI_TAX = 0,           
        FOTDD_CONTRACTNO = '',           
        FOTDD_PCOMM = 0,           
        FOTDD_SCOMM = 0,           
        FOTDD_INS_CHRG = 0,           
        FOTDD_FLAG = left(Flag,4),           
        FOTDD_O_C_FLAG = '',           
        FOTDD_AUCTIONPART = '',           
        FOTDD_CREATED_BY = @UName,           
        FOTDD_CREATED_DT = getdate()           
    FROM           
  (           
    SELECT           
        PQty =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) > 0           
            THEN Sum(PQty-SQty)           
            ELSE 0 END          
        )          
        ,           
        SQty =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) < 0           
	    THEN Abs(Sum(PQty-SQty))           
            ELSE 0 END          
        )          
        ,           
        PAmt =           
        (   
        CASE           
            WHEN Sum(PQty-SQty) > 0           
            THEN Sum(PAmt-SAmt)           
            ELSE 0 END          
        )          
        ,           
        SAmt =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) < 0           
            THEN Abs(Sum(PAmt-SAmt))           
            ELSE 0 END          
        )          
        ,           
        Charges = (Sum(service_tax) - sum(ExSer_Tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)),           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        ExpDate    = Left(ExpiryDate, 11),           
        Flag       = '04' + TradeType,           
        CFPPrice =           
        (          
        CASE           
            WHEN sum(pQty-sQty) > 0           
            THEN Sum((PAmt-SAmt)*Denominator/Numerator)/abs(sum(pQty-sQty))
            ELSE 0 END           
        )          
        ,           
        CFSPrice =           
 	(          
        CASE           
            WHEN sum(pQty-sQty) < 0           
            THEN abs(sum((PAmt-sAmt)*Denominator/Numerator))/abs(sum(pQty-sQty))           
            ELSE 0 END           
        )          
        ,           
        SettPrice = max(cl_rate)            
    FROM           
        FoBillValan           
    WHERE           
        Party_Code between @FParty And @TParty          
        AND Sauda_Date Like @SDate+'%'           
        AND left(inst_type,3) = 'FUT'           
        AND TradeType       = 'BF'           
        AND ParticiPantCode = @MemberCode           
    GROUP BY           
        Party_Code,           
        Inst_Type,    
        Symbol,           
        Left(ExpiryDate, 11),           
        TradeType           
              
    UNION ALL           
              
    SELECT           
        PQty    = Sum(PQty),           
        SQty    = sum(SQty),           
        PAmt    = sum(Pamt-pbrokamt),           
        SAmt    = Sum(Samt+sbrokamt),           
        Charges = (Sum(service_tax) - sum(ExSer_Tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)),           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        ExpDate    = Left(ExpiryDate, 11),           
        Flag       = '04'+ TradeType,                
        CFPPrice = max(pRate),           
        CFSPrice = max(sRate),           
        SettPrice = max(cl_rate)            
    FROM           
        FoBillValan           
    WHERE           
        Party_Code between @FParty And @TParty          
        AND Sauda_Date Like @SDate+'%'           
        AND left(inst_type,3) = 'FUT'           
        AND TradeType       = 'BT'           
        AND ParticiPantCode = @MemberCode           
    GROUP BY           
        Party_Code,           
    Inst_Type,           
        Symbol,           
        Left(ExpiryDate, 11),           
        TradeType           
              
    UNION ALL           
              
    SELECT           
        PQty =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) < 0           
            THEN Abs(Sum(PQty-SQty)) 
            ELSE 0 END          
        )          
        ,           
        SQty =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) > 0           
            THEN Abs(Sum(PQty-SQty))           
            ELSE 0 END          
        )          
        ,           
        PAmt =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) < 0           
            THEN Abs(Sum((PQty-SQty)*Cl_Rate*Numerator/Denominator))           
            ELSE 0 END          
        )          
       ,           
        SAmt =           
        (          
        CASE           
            WHEN Sum(PQty-SQty) > 0           
            THEN Abs(Sum(((PQty)-(SQty))*Cl_Rate*Numerator/Denominator))           
            ELSE 0 END          
        )          
        ,           
        Charges = 0,           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        ExpDate    = Left(ExpiryDate, 11),           
        Flag       = '04' + 'CF',           
        CFPPrice  = 0,           
        CFSPrice  = 0,           
        SettPrice = max(cl_rate)           
    FROM           
        FoBillValan           
    WHERE           
        Party_Code between @FParty And @TParty          
        AND Sauda_Date Like @SDate+'%'           
        AND left(inst_type,3) = 'FUT'           
        AND ParticiPantCode = @MemberCode           
    GROUP BY           
        Party_Code,           
        Inst_Type,           
        Symbol,           
        Left(ExpiryDate, 11)           
    HAVING           
        Sum(PQty-SQty) <> 0           
    ) t           
    WHERE           
    PQty+SQty > 0           
    --ORDER BY Inst_Type, Party_code, Symbol, ExpiryDate, Flag              
          
          
/*=========================================================================================================          
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS          
=========================================================================================================*/          
          
    INSERT           
    INTO           
        FO_TRADE_DETAILS_DAS           
    SELECT           
        FOTDD_PARTY_CODE = party_code,           
        FOTDD_INST_TYPE = Inst_type,           
        FOTDD_SYMBOL = Symbol,           
        FOTDD_STRIKE_PRICE = Strike_Price,           
        FOTDD_OPTION_TYPE = Option_Type,           
        FOTDD_EXPIRY_DATE = ExpiryDate,           
        FOTDD_SEC_NAME = Symbol + '-' + Inst_type,           
        FOTDD_TRADEQTY = TradeQty,           
        FOTDD_VALUE = NetRate*TradeQty,           
        FOTDD_PRICE = Price,           
        FOTDD_PQTY = 0,           
        FOTDD_SQTY = 0,           
        FOTDD_PAMT = 0,           
        FOTDD_SAMT = 0,           
        FOTDD_NETRATE = 0,           
        FOTDD_CFPPRICE = 0,          
        FOTDD_CFSPRICE = 0,           
        FOTDD_SETTPRICE = 0,           
        FOTDD_SAUDA_DATE = @SDate,           
        FOTDD_PNETRATE = 0,           
        FOTDD_SNETRATE = 0,           
        FOTDD_CHARGES = 0,           
        FOTDD_BROKERAGE = 0,           
        FOTDD_SERVICE_TAX = 0,           
        FOTDD_BROKER_NOTE = 0,           
        FOTDD_TURN_TAX = 0,           
        FOTDD_SEBI_TAX = 0,           
        FOTDD_CONTRACTNO = 0,           
        FOTDD_PCOMM = 0,           
        FOTDD_SCOMM = 0,           
        FOTDD_INS_CHRG = 0,           
        FOTDD_FLAG = '07',           
        FOTDD_O_C_FLAG = O_C_Flag,           
        FOTDD_AUCTIONPART = AuctionPart,           
        FOTDD_CREATED_BY = @UName,           
        FOTDD_CREATED_DT = getdate()           
    FROM           
        FoSettCorpAct With(NoLock)          
    WHERE           
        sauda_date like @SDate +'%'           
        AND party_code between @Fparty and @Tparty          
        AND AuctionPart = 'CA'           
--    ORDER BY O_C_Flag, Symbol, ExpiryDate, Option_Type            
          
    Drop Table #foDailyConfirm          
    Drop Table #foDailyConfirm_Opt          
          
    
  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FOFTTRAE_UPD
-- --------------------------------------------------


CREATE PROC [dbo].[PR_FOFTTRAE_UPD] (@NMODE INT) AS

TRUNCATE TABLE FOFTTRADE

IF @NMODE = 1  --EOD FILE
BEGIN
 
	INSERT INTO FOFTTRADE
	SELECT 
		TRADE_NO,STATUS=ACTIVITY_TYPE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME='',
		BOOKTYPE=0,BOOKTYPENAME=0,MARKETTYPE=0,USER_ID=BUY_DEALER_CODE,
		BRANCH_ID=BUY_BRANCH,SELL_BUY=1,TRADEQTY=TRADE_VOLUME,PRICE,PRO_CLI=CASE WHEN BUY_PRO_CLI ='C' THEN 1 ELSE 2 END ,
		PARTY_CODE=BUY_CLIENT,PARTICIPANTCODE= CASE WHEN BUY_CP_CODE <> '' THEN BUY_CP_CODE WHEN BUY_CONF_FLAG ='Y' THEN BUY_OLD_CP_CODE END ,
		O_C_FLAG=BUY_OC_FLAG,C_U_FLAG=BUY_CU_FLAG,ACTIVITYTIME=TRADE_TIME,LAST_MOD_TIME=TRADE_TIME,
		ORDER_NO=BUY_ORDER_NO,OPP_BROKER_ID='',SETTFLAG=0,MEMBERCODE=BUY_TM_CODE,TMPARTYCODE=BUY_CLIENT,
		RESERVED1=0,RESERVED2=0,RESERVED3='',RESERVED4='',RESERVED5=BUY_CONF_FLAG
	 FROM FOFTTRAE_1_IMP
	 WHERE ISNULL(BUY_TM_CODE,'') <> ''

	INSERT INTO FOFTTRADE
	SELECT 
		TRADE_NO,STATUS=ACTIVITY_TYPE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME='',
		BOOKTYPE=0,BOOKTYPENAME=0,MARKETTYPE=0,USER_ID=SELL_DEALER_CODE,
		BRANCH_ID=SELL_BRANCH,SELL_BUY=2,TRADEQTY=TRADE_VOLUME,PRICE,PRO_CLI=CASE WHEN SELL_PRO_CLI ='C' THEN 1 ELSE 2 END,
		PARTY_CODE=SELL_CLIENT,PARTICIPANTCODE=CASE WHEN SELL_CP_CODE <> '' THEN SELL_CP_CODE WHEN SELL_CONF_FLAG ='Y' THEN SELL_OLD_CP_CODE END ,
		O_C_FLAG=SELL_OC_FLAG,C_U_FLAG=SELL_CU_FLAG,ACTIVITYTIME=TRADE_TIME,LAST_MOD_TIME=TRADE_TIME,
		ORDER_NO=SELL_ORDER_NO,OPP_BROKER_ID='',SETTFLAG=0,MEMBERCODE=SELL_TM_CODE,TMPARTYCODE=SELL_CLIENT,
		RESERVED1=0,RESERVED2=0,RESERVED3='',RESERVED4='',RESERVED5=SELL_CONF_FLAG
	 FROM FOFTTRAE_1_IMP
	  WHERE ISNULL(SELL_TM_CODE,'') <> ''
	  
END
ELSE IF @NMODE = 3
 BEGIN  
        /*FTP FILE*/  
        INSERT INTO FOFTTRADE   
        (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
        SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
        PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
        MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  
        
        SELECT 
                RIGHT(TRADE_NO,8)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
                '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=S_TRADER,
				BRANCH_ID=S_PARTY_CODE,
                SELL_BUY = 2,
                TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN S_PRO_CLI ='C' THEN 1 ELSE 2 END,  
                PARTY_CODE = S_PARTY_CODE,
                PARTICIPANTCODE = (CASE WHEN S_CONFIRMATION = 'Y' THEN S_PARTICIPANTCODE ELSE S_BROKERCODE END),  
                C_U_FLAG  ,
                ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
                ORDER_NO = S_ORDER_NO , RIGHT(ORDERTIME,8),  
                MARKETTYPE,S_O_C_FLAG,0 SETTFLAG,S_BROKERCODE MEMBERCODE,S_PARTY_CODE TMPARTYCODE,
                0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4, 
                RESERVED5 = CASE WHEN S_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
        FROM FOFTTRADE_3_IMP
        WHERE S_CMCODE <> 'NULL' 

        /*FTP FILE*/  
        INSERT INTO FOFTTRADE   
        (TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
        SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
        PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
        MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

        SELECT 
                RIGHT(TRADE_NO,7)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
                '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=B_TRADER,
				BRANCH_ID=B_PARTY_CODE,
                SELL_BUY = 1,
                TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN B_PRO_CLI ='C' THEN 1 ELSE 2 END,  
                PARTY_CODE = B_PARTY_CODE,
                PARTICIPANTCODE = (CASE WHEN B_CONFIRMATION = 'Y' THEN B_PARTICIPANTCODE ELSE B_BROKERCODE END),  
                C_U_FLAG  ,
                ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
                ORDER_NO = B_ORDER_NO ,RIGHT(ORDERTIME,8),  
                MARKETTYPE,B_O_C_FLAG,0 SETTFLAG,B_BROKERCODE MEMBERCODE,B_PARTY_CODE TMPARTYCODE,
                0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4,
                RESERVED5 = CASE WHEN B_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
        FROM FOFTTRADE_3_IMP
        WHERE B_CMCODE <> 'NULL' 
 END 

 ELSE

BEGIN  /*TERMINAL FILE*/

	 INSERT INTO FOFTTRADE
	 SELECT 
		 TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE=CASE WHEN OPTION_TYPE='XX' THEN '' ELSE OPTION_TYPE END,
		 SEC_NAME,BOOKTYPE,BOOKTYPENAME=0,MARKETTYPE,USER_ID,
		 BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG=0,
		 ACTIVITYTIME=SAUDA_DATE,LAST_MOD_TIME, ORDER_NO,OPP_BROKER_ID,SETTFLAG=0,MEMBERCODE=PARTICIPANTCODE,
		 TMPARTYCODE=PARTY_CODE,RESERVED1=0,RESERVED2=0,RESERVED3='',RESERVED4='',RESERVED5=''
	 FROM FOFTTRAE_2_IMP

END
UPDATE FOFTTRADE SET PARTICIPANTCODE = MEMBERCODE WHERE PARTICIPANTCODE IS NULL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[PR_GET_STATUS]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)
)

AS

IF @DATEFROM <> '' AND @DATETO <> '' AND @EXCHANGE <> '' AND @SEGMENT <> ''
BEGIN
	DECLARE @COMPANYNAME VARCHAR(200)
	
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
	IF (@EXCHANGE ='NSE' OR @EXCHANGE='BSE') AND @SEGMENT ='CAPITAL'
	BEGIN 
		SELECT @COMPANYNAME = COMPANY FROM OWNER
	
		SELECT 
			@COMPANYNAME,
			@EXCHANGE,
			@SEGMENT,
			REC_DESCRIPTION = 
					CASE 
						WHEN REC_DESC= 1 THEN 'Last Trade Date'
						WHEN REC_DESC= 2 THEN 'Last Inst Trade Date'
						WHEN REC_DESC= 3 THEN 'Total Number of Retail Trades'
						WHEN REC_DESC= 4 THEN 'Total Number of Retail Contracts'
						WHEN REC_DESC= 5 THEN 'Total Retail Turnover'
						WHEN REC_DESC= 6 THEN 'Total Number of Inst Trades'
						WHEN REC_DESC= 7 THEN 'Total Number of Inst Contracts'
						WHEN REC_DESC= 8 THEN 'Total Inst Turnover'
						WHEN REC_DESC= 9 THEN 'Number of Trading Days'
						WHEN REC_DESC= 10 THEN 'Avrg Retail Contracts Per Day'
						WHEN REC_DESC= 11 THEN 'Avrg Retail Turnover Per Day'
						WHEN REC_DESC= 12 THEN 'Avrg Inst Contracts Per Day'
						WHEN REC_DESC= 13 THEN 'Avrg Inst Turnover Per Day'
					END,
			REC_VALUE
		FROM
			(
			SELECT REC_DESC=1,
			       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			    
			UNION ALL
			
			SELECT REC_DESC=2,
			       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			                                                    
			UNION ALL
			
			SELECT 
				REC_DESC=3, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(1))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT 
				REC_DESC=4, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT 
				REC_DESC=5, 
				REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT   
				REC_DESC=6, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(1))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT  
				REC_DESC=7, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			UNION ALL
			
			SELECT  
				REC_DESC=8 ,
				REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
	
			UNION ALL
		
			
			SELECT 
				REC_DESC= 9, 
				REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 10, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 11, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
	
			SELECT 
				REC_DESC= 12, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			UNION ALL
			
			SELECT 
				REC_DESC= 13, 
				REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END))
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
		) REC_DATA
	
	END
	ELSE
		IF (SELECT PATINDEX('%'+ @EXCHANGE + '%','|BCM|BSX|BXM|NMC|BSE|'))>0 AND @SEGMENT ='FUTURES'
			BEGIN
	
			SELECT @COMPANYNAME = COMPANY FROM BFOOWNER
	
			SELECT 
				@COMPANYNAME,
				@EXCHANGE,
				@SEGMENT,
				REC_DESCRIPTION = 
						CASE 
							WHEN REC_DESC= 1 THEN 'Last Trade Date'
							WHEN REC_DESC= 2 THEN 'Last Inst Trade Date'
							WHEN REC_DESC= 3 THEN 'Total Number of Retail Trades'
							WHEN REC_DESC= 4 THEN 'Total Number of Retail Contracts'
							WHEN REC_DESC= 5 THEN 'Total Retail Turnover'
							WHEN REC_DESC= 6 THEN 'Total Number of Inst Trades'
							WHEN REC_DESC= 7 THEN 'Total Number of Inst Contracts'
							WHEN REC_DESC= 8 THEN 'Total Inst Turnover'
							WHEN REC_DESC= 9 THEN 'Number of Trading Days'
							WHEN REC_DESC= 10 THEN 'Avrg Retail Contracts Per Day'
							WHEN REC_DESC= 11 THEN 'Avrg Retail Turnover Per Day'
							WHEN REC_DESC= 12 THEN 'Avrg Inst Contracts Per Day'
							WHEN REC_DESC= 13 THEN 'Avrg Inst Turnover Per Day'
						END,
				REC_VALUE
			FROM
				(
					SELECT REC_DESC= 1,
					       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					    
					UNION ALL
					
					SELECT REC_DESC= 2,
					       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					                                                    
					UNION ALL
		
					SELECT 
						REC_DESC= 3, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(1))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
					
					SELECT 
						REC_DESC= 4, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
					
					SELECT 
						REC_DESC= 5, 
						REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					UNION ALL
		
					SELECT 
						REC_DESC= 6, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(1))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					UNION ALL
					
					SELECT 
						REC_DESC= 7, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					UNION ALL
					
					SELECT 
						REC_DESC= 8, 
						REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
					UNION ALL
				
					
					SELECT 
						REC_DESC= 9, 
						REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
		
					UNION ALL
		
					SELECT 
						REC_DESC= 10, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					UNION ALL
		
					SELECT 
						REC_DESC= 11, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					UNION ALL
		
					SELECT 
						REC_DESC= 12, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
		
					UNION ALL
					
					SELECT 
						REC_DESC= 13, 
						REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
				) TRDDATA
			END
		ELSE
			BEGIN
			SELECT @COMPANYNAME = COMPANY FROM FOOWNER
	
			SELECT 
				@COMPANYNAME,
				@EXCHANGE,
				@SEGMENT,
				REC_DESCRIPTION = 
						CASE 
							WHEN REC_DESC= 1 THEN 'Last Trade Date'
							WHEN REC_DESC= 2 THEN 'Last Inst Trade Date'
							WHEN REC_DESC= 3 THEN 'Total Number of Retail Trades'
							WHEN REC_DESC= 4 THEN 'Total Number of Retail Contracts'
							WHEN REC_DESC= 5 THEN 'Total Retail Turnover'
							WHEN REC_DESC= 6 THEN 'Total Number of Inst Trades'
							WHEN REC_DESC= 7 THEN 'Total Number of Inst Contracts'
							WHEN REC_DESC= 8 THEN 'Total Inst Turnover'
							WHEN REC_DESC= 9 THEN 'Number of Trading Days'
							WHEN REC_DESC= 10 THEN 'Avrg Retail Contracts Per Day'
							WHEN REC_DESC= 11 THEN 'Avrg Retail Turnover Per Day'
							WHEN REC_DESC= 12 THEN 'Avrg Inst Contracts Per Day'
							WHEN REC_DESC= 13 THEN 'Avrg Inst Turnover Per Day'
						END,
				REC_VALUE
			FROM
				(
				SELECT REC_DESC= 1,
				       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				    
				UNION ALL
				
				SELECT REC_DESC= 2,
				       REC_VALUE=LEFT(MAX(SAUDA_DATE),11)
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				                                                    
				UNION ALL
	
				SELECT 
					REC_DESC= 3, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(1))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
				
				SELECT 
					REC_DESC= 4, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
				
				SELECT 
					REC_DESC= 5, 
					REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				UNION ALL
	
				SELECT 
					REC_DESC= 6, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(1))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				UNION ALL
				
				SELECT 
					REC_DESC= 7, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				UNION ALL
				
				SELECT 
					REC_DESC= 8, 
					REC_VALUE=CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
				UNION ALL
			
				
				SELECT 
					REC_DESC= 9, 
					REC_VALUE=CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
	
				UNION ALL
	
				SELECT 
					REC_DESC= 10, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
				UNION ALL
	
				SELECT 
					REC_DESC= 11, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
				UNION ALL
	
				SELECT 
					REC_DESC= 12, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
				UNION ALL
				
				SELECT 
					REC_DESC= 13, 
					REC_VALUE=CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
	
	
				) TRDDATA
			END
	
	  SELECT @COMPANYNAME,@EXCHANGE,@SEGMENT,
		 ENT_TYPE = A.ENT_TYPE,   
	         NO_OF_UNITS = ISNULL(NO_OF_UNITS,0),   
	         NO_OF_LOGIN = ISNULL(NO_OF_LOGIN,0),   
	         NO_OF_USERS = ISNULL(NO_OF_USERS,0)   
	  FROM   (SELECT ENT_TYPE,   
	                 NO_OF_UNITS = COUNT(1),   
	                 ORDER_BY  
	          FROM   V2_CLASS_VW_ENTITYMASTER (NOLOCK)   
	          GROUP BY ENT_TYPE,ORDER_BY) A   
	            LEFT OUTER JOIN   
	            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
	                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
	             FROM   (SELECT FLDADMINAUTO,   
	                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
	                     FROM   TBLPRADNYAUSERS (NOLOCK) 
	                     GROUP BY FLDADMINAUTO) U,   
	                     TBLADMIN A   
	             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
	             GROUP BY FLDSTATUS) B  
	             ON A.ENT_TYPE = B.ENT_TYPE    
	              LEFT OUTER JOIN   
	                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
	                        NO_OF_USERS = SUM(NO_OF_USERS)   
	                 FROM   (SELECT FLDADMINAUTO,   
	                                FLDSTNAME,   
	                                NO_OF_USERS = COUNT(1)   
	                         FROM TBLPRADNYAUSERS  (NOLOCK)  
	                         GROUP BY FLDADMINAUTO,   
	                          FLDSTNAME) U, TBLADMIN A   
	                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
	                 GROUP BY FLDSTATUS) C   
	                 ON A.ENT_TYPE = C.ENT_TYPE   
	  ORDER BY ORDER_BY  
END
/*------------------------------------------------- END OF THE PROCEDURE ---------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_STATUS_DATA
-- --------------------------------------------------


CREATE  PROCEDURE [DBO].[PR_GET_STATUS_DATA]
(
	@DATEFROM VARCHAR(11)='',
	@DATETO VARCHAR(11)='',
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7)
)
AS


IF @EXCHANGE <> '' AND @SEGMENT <> ''
BEGIN

/*-----------------------------------------------------------------------------------------------------------------------
						FETCHING THE TRANSACTRION DETAILS
-------------------------------------------------------------------------------------------------------------------------*/
	DECLARE @SR_RPT_PERIOD VARCHAR(30)
	DECLARE @SR_SEGMENT VARCHAR(12)
	DECLARE @SR_VALUE VARCHAR(2000)
	DECLARE @COMPANYNAME VARCHAR(200)			  
	DECLARE @SR_VALUE2 VARCHAR(2000)
	DECLARE @DATAVAL VARCHAR(100)
	DECLARE @DATACUR AS CURSOR

	IF @DATEFROM = '' BEGIN SET @DATEFROM = LEFT(GETDATE(),11) END
	IF @DATETO = '' BEGIN SET @DATETO = LEFT(GETDATE(),11) END	

	SET @SR_RPT_PERIOD =  CONVERT(VARCHAR,CONVERT(DATETIME, @DATEFROM),103) + '-' + CONVERT(VARCHAR,CONVERT(DATETIME, @DATETO),103)
	SET @SR_SEGMENT = @EXCHANGE +'-'+@SEGMENT
	SET @SR_VALUE = ''
	
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
	IF (@EXCHANGE ='NSE' OR @EXCHANGE='BSE') AND @SEGMENT ='CAPITAL'
	BEGIN 
		SELECT @COMPANYNAME = COMPANY FROM OWNER
			
			SELECT
			       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11) + '|'
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
			    
					
			SELECT 
			       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
			FROM   SETTLEMENT (NOLOCK)
			WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'			                                                  
		
			
			SELECT 				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT 
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')			
		
			SELECT 
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT   
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
					
			SELECT  
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
					
			SELECT  
				
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				SETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
			
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
				
			SELECT 
				@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
						 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
					  ELSE 0 END)) + '|'
			FROM
				ISETTLEMENT  (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				AND TRADEQTY > 0
				AND TRADE_NO NOT LIKE '%C%'
				AND LEFT(AUCTIONPART,1) NOT IN  ('A','F')
	
	END
	ELSE
		IF (SELECT PATINDEX('%'+ @EXCHANGE + '%','|BCM|BSX|BXM|NMC|BSE|'))>0 AND @SEGMENT ='FUTURES'
			BEGIN
	
			SELECT @COMPANYNAME = COMPANY FROM BFOOWNER	

					SELECT 
					       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					SELECT 
					       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
					FROM   BFOSETTLEMENT (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1                          
	
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					

					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0					

		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
					
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(MARKETRATE*TRADEQTY),0))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1	
			
					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
		
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=0
		
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1

					
					SELECT 
						@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
								 ISNULL(SUM(MARKETRATE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
							  ELSE 0 END))+ '|'
					FROM
						BFOSETTLEMENT  (NOLOCK)
					WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
					       AND TRADEQTY >0 
					       AND AUCTIONPART NOT IN ('CA','EA')
					       AND RESERVED1=1
	
			END
		ELSE
			BEGIN
			SELECT @COMPANYNAME = COMPANY FROM FOOWNER
	

				SELECT 
				       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				    
				
				SELECT 
				       @SR_VALUE = @SR_VALUE +  LEFT(MAX(SAUDA_DATE),11)+ '|'
				FROM   FOSETTLEMENT (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				                                                    
		
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
				
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(1))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT CONTRACTNO))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,ISNULL(SUM(PRICE*TRADEQTY),0))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1
				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,COUNT(DISTINCT LEFT(SAUDA_DATE,11)))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=0
	
	
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 COUNT(DISTINCT CONTRACTNO) /COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1

				
				SELECT 
					@SR_VALUE = @SR_VALUE +  CONVERT(VARCHAR,(CASE WHEN COUNT(DISTINCT LEFT(SAUDA_DATE,11)) > 0 THEN
							 ISNULL(SUM(PRICE*TRADEQTY),0)/COUNT(DISTINCT LEFT(SAUDA_DATE,11))
						  ELSE 0 END))+ '|'
				FROM
					FOSETTLEMENT  (NOLOCK)
				WHERE  SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
				       AND TRADEQTY >0 
				       AND AUCTIONPART NOT IN ('CA','EA')
				       AND RESERVED1=1

			END
	
	/*-----------------------------------------------------------------------------------------------------------------------
						FETCHING THE LOGIN DETAILS
	-------------------------------------------------------------------------------------------------------------------------*/
	
	SET @SR_VALUE2 = ''
	SET @DATACUR =  CURSOR FOR SELECT 
			CONVERT(VARCHAR,ISNULL(NO_OF_UNITS,0))+'-'+CONVERT(VARCHAR,ISNULL(NO_OF_LOGIN,0))+'-'+CONVERT(VARCHAR,ISNULL(NO_OF_USERS,0))
			FROM   (SELECT ENT_TYPE,   
		                 NO_OF_UNITS = COUNT(1),   
		                 ORDER_BY  
		          FROM   V2_CLASS_VW_ENTITYMASTER (NOLOCK)   
		          GROUP BY ENT_TYPE,ORDER_BY) A   
		            LEFT OUTER JOIN   
		            (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
		                    NO_OF_LOGIN = SUM(NO_OF_LOGIN)   
		             FROM   (SELECT FLDADMINAUTO,   
		                            NO_OF_LOGIN = COUNT(DISTINCT FLDSTNAME)   
		                     FROM   TBLPRADNYAUSERS (NOLOCK) 
		                     GROUP BY FLDADMINAUTO) U,   
		                     TBLADMIN A   
		             WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
		             GROUP BY FLDSTATUS) B  
		             ON A.ENT_TYPE = B.ENT_TYPE    
		              LEFT OUTER JOIN   
		                (SELECT ENT_TYPE = UPPER(FLDSTATUS),   
		                        NO_OF_USERS = SUM(NO_OF_USERS)   
		                 FROM   (SELECT FLDADMINAUTO,   
		                                FLDSTNAME,   
		                                NO_OF_USERS = COUNT(1)   
		                         FROM TBLPRADNYAUSERS  (NOLOCK)  
		                         GROUP BY FLDADMINAUTO,   
		                          FLDSTNAME) U, TBLADMIN A   
		                 WHERE FLDADMINAUTO = FLDAUTO_ADMIN   
		                 GROUP BY FLDSTATUS) C   
		                 ON A.ENT_TYPE = C.ENT_TYPE   
		  ORDER BY ORDER_BY 
	
	OPEN @DATACUR
	FETCH NEXT FROM @DATACUR INTO @DATAVAL
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @SR_VALUE2 = @SR_VALUE2 + @DATAVAL + '|' 
	
	FETCH NEXT FROM @DATACUR INTO @DATAVAL
	END
	CLOSE @DATACUR
	DEALLOCATE @DATACUR
	
	/*-----------------------------------------------------------------------------------------------------------------------
					POPULATING FINAL DATA INTO PRDNYA STATUS REPORT TABLE
	-------------------------------------------------------------------------------------------------------------------------*/
	
	IF ISNULL(@SR_VALUE,'') <>''
	BEGIN
		DELETE PRADNYA.DBO.STATUS_REPORT WHERE SR_RPT_PERIOD =@SR_RPT_PERIOD AND SR_SEGMENT = @SR_SEGMENT AND SR_TYPE = 1
		INSERT INTO PRADNYA.DBO.STATUS_REPORT SELECT @SR_RPT_PERIOD,@SR_SEGMENT,1,@SR_VALUE,GETDATE()
	END
	IF ISNULL(@SR_VALUE2,'') <>''
	BEGIN
		DELETE PRADNYA.DBO.STATUS_REPORT WHERE SR_RPT_PERIOD =@SR_RPT_PERIOD AND SR_SEGMENT = @SR_SEGMENT AND SR_TYPE = 2
		INSERT INTO PRADNYA.DBO.STATUS_REPORT SELECT @SR_RPT_PERIOD,@SR_SEGMENT,2,@SR_VALUE2,GETDATE()
	END
END

/*------------------------------------------------- END OF THE PROCEDURE ---------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_FILE
-- --------------------------------------------------



CREATE PROC [dbo].[PR_IMPORT_FILE] 
(
	@FILETYPE VARCHAR(20),
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS 

IF @FILETYPE = 'MARGIN FILE'
BEGIN
	EXEC PR_IMPORT_MARGIN_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	--EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'MRGIMP','',@UNAME,''
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_LEDGER_DETAILS_DAS_GET
-- --------------------------------------------------

--Exec PR_LEDGER_DETAILS_DAS_GET 'oct 26 2006','00','zz','Backend'        

                 
CREATE Procedure [dbo].[PR_LEDGER_DETAILS_DAS_GET]
(                        
 @fdate varchar(12),                      
 @fparty varchar(10),                         
 @tparty varchar(10),                      
 @uname  varchar(10)                       
)                        
                        
As                        
                        
Set NoCount On                                     
            
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
    DELETE                               
    FROM                               
       LEDGER_DETAILS_DAS                               
    WHERE                               
        LEDDD_SAUDA_DATE like @fDate + '%'                               
        AND LEDDD_PARTY_CODE BETWEEN @Fparty AND @Tparty                                 
        
                        
CREATE TABLE [dbo].[#LEDGER_DETAILS_DAS](                        
 [LEDDD_PARTY_CODE] [varchar](10) NOT NULL,                      
 [LEDDD_SAUDA_DATE] DATETIME ,                      
 [LEDDD_OPENING_BAL] [money] NULL,                        
 [LEDDD_CHQ_REC] [money] NULL,                        
 [LEDDD_CHQ_PAY] [money] NULL,                        
 [LEDDD_JV_ENTRY] [money] NULL,                        
 [LEDDD_CLOSING_BAL] [money] NULL,                        
 [LEDDD_CASH_MARGIN] [money] NULL,                        
 [LEDDD_OPENING_INIT_MARGIN] [money] NULL,                        
 [LEDDD_MRG_REC] [money] NULL,                        
 [LEDDD_MRG_REPAY] [money] NULL,                        
 [LEDDD_MRG_JV_ENTRY] [money] NULL,                        
 [LEDDD_CLOSING_INIT_MARGIN] [money] NULL,                        
 [LEDDD_NONCASH_COLL_HC] [money] NULL,                        
 [LEDDD_INIT_EXPO_MARGIN] [money] NULL,                      
 [LEDDD_CREATED_BY] [VARCHAR] (10) NOT NULL,                      
 [LEDDD_CREATED_DT]  DATETIME ,                     
 [LEDDD_FT_D] [money] NULL,                    
 [LEDDD_FT_C] [money] NULL,                    
 [LEDDD_MRG_FT] [money] NULL,                    
 [LEDDD_RUNNINGBAL] [money] NULL                    
) ON [PRIMARY]                        
                        
/*====================================================================================                        
 Opening Balance - Client Control A/c                        
====================================================================================*/                        
Insert into #LEDGER_DETAILS_DAS                         
select                         
 LEDDD_PARTY_CODE = cltcode,                       
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = isnull(sum(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate() ,                       
 LEDDD_FT_D = 0,                    
 LEDDD_FT_C = 0,                    
 LEDDD_MRG_FT = 0,                    
 LEDDD_RUNNINGBAL = 0                    
from                         
 AccountMCDX..ledger l,                         
 AccountMCDX..parameter p                         
where                         
 cltcode Between @fparty And @tparty                        
 and vdt < @fdate              
 and @fdate between sdtcur and ldtcur                         
 and vdt >= sdtcur                         
 and vdt <= ldtcur                         
group by                         
 cltcode              
                        
/*====================================================================================                        
 Cheque Receipts during the day                      
 Cheque Payments during the day                        
 Journal entries for the day                        
 Margin Receipts during the day                        
 Margin Repayment during the day                        
 Margin Journal entries for the day                        
====================================================================================*/                        
Insert into #LEDGER_DETAILS_DAS                       
Select                       
 LEDDD_PARTY_CODE = cltcode,                      
 LEDDD_SAUDA_DATE = @FDATE,                    
 LEDDD_OPENING_BAL = 0,                      
 isnull(sum(LEDDD_CHQ_REC),0),
 isnull(sum(LEDDD_CHQ_PAY),0),
 isnull(sum(LEDDD_JV_ENTRY),0),
 LEDDD_CLOSING_BAL = 0,                      
 LEDDD_CASH_MARGIN = 0,                      
 LEDDD_OPENING_INIT_MARGIN = 0,                      
 isnull(sum(ML.LEDDD_MRG_REC),0),                      
 isnull(sum(ML.LEDDD_MRG_REPAY),0),                      
 isnull(sum(ML.LEDDD_MRG_JV_ENTRY),0),                      
 LEDDD_CLOSING_INIT_MARGIN = isnull(sum(ML.LEDDD_MRG_REC),0) + isnull(sum(ML.LEDDD_MRG_REPAY),0) + isnull(sum(ML.LEDDD_MRG_JV_ENTRY),0),                      
 LEDDD_NONCASH_COLL_HC = 0,                      
 LEDDD_INIT_EXPO_MARGIN = 0,                      
 LEDDD_CREATED_BY = @UNAME,                    
 LEDDD_CREATED_DT = Getdate(),                      
 LEDDD_FT_D = isnull(sum(LEDDD_FT_D),0),                    
 LEDDD_FT_C = isnull(sum(LEDDD_FT_C),0),                    
 LEDDD_MRG_FT = isnull(sum(LEDDD_MRG_FT),0),                    
 LEDDD_RUNNINGBAL = 0                    
 from                       
 (
 select 
	 LEDDD_CHQ_REC = isnull(sum(CASE WHEN VTYP = '2' THEN (case when drcr ='C' then vamt else -vamt end) ELSE 0 END ),0) ,                      
	 LEDDD_CHQ_PAY = isnull(sum(CASE WHEN VTYP = '3' THEN (case when drcr ='C' then vamt else -vamt end) ELSE 0 END ),0),                      
	 LEDDD_JV_ENTRY = isnull(sum(CASE WHEN VTYP = '8' THEN (case when drcr ='C' then vamt else -vamt end) ELSE 0 END ),0),         
  LEDDD_FT_D = isnull(sum(CASE WHEN VTYP = '88' THEN (case when drcr ='D' then vamt else 0 end) ELSE 0 END ),0),                    
  LEDDD_FT_C = isnull(sum(CASE WHEN VTYP = '88' THEN (case when drcr ='C' then vamt else 0 end) ELSE 0 END ),0),                    
	 cltcode 
 From 
	 AccountMCDX..ledger (nolock)     
 where                       
	 cltcode Between @fparty and @tparty 
	 and vdt like @FDATE+ '%'                      
 group by cltcode 
 ) l 
 left outer join      
(                      
    Select     
	LEDDD_MRG_REC = isnull(sum(Case When vtyp = 19 Then (Case When drcr ='C' Then Amount Else -Amount End) else 0 end),0),       
	LEDDD_MRG_REPAY = isnull(sum(Case When vtyp = 20 Then (Case When drcr ='C' Then Amount Else -Amount End) else 0 end),0),       
	LEDDD_MRG_JV_ENTRY = isnull(sum(Case When vtyp = 24 Then (Case When drcr ='C' Then Amount Else -Amount End) else 0 end),0),       
 LEDDD_MRG_FT = isnull(sum(CASE WHEN VTYP = 88 THEN (case when drcr ='C' then Amount else -Amount end) ELSE 0 END ),0),                    
	party_code
    from AccountMCDX..MarginLedger (nolock) where party_code between @fparty and @tparty 
          and vdt like @FDATE+ '%'                      
  Group By Party_Code  
) ml     
on    
(    
 cltcode = party_code     
)    
group by cltcode
    
                        
/*====================================================================================                        
 Closing Balance - Client Control A/c (A)                        
====================================================================================*/                        
Insert into #LEDGER_DETAILS_DAS                         
select                         
 LEDDD_PARTY_CODE = cltcode,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = isnull(sum(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                        
 LEDDD_CASH_MARGIN = 0,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate(),                        
 LEDDD_FT_D = 0,                    
 LEDDD_FT_C = 0,                    
 LEDDD_MRG_FT = 0,                    
 LEDDD_RUNNINGBAL = 0                    
from                         
 AccountMCDX..ledger l,                         
 AccountMCDX..parameter p                         
where                         
 cltcode Between @fparty And @tparty                        
 and vdt <=  @fdate  + ' 23:59:59'                         
--- and vdt <= @fdate  + '23:59:59'            
 and @fdate between sdtcur and ldtcur                         
 and vdt >= sdtcur                         
 and vdt <= ldtcur                         
group by                         
 cltcode      
                        
/*====================================================================================                        
 Cash Margin                        
 Non-Cash Collateral Value (after hair-cut) (C)                        
====================================================================================*/         
                        
Insert into #LEDGER_DETAILS_DAS                         
Select                         
 LEDDD_PARTY_CODE = party_code,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                        
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN,                        
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                        
 LEDDD_NONCASH_COLL_HC,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                        
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate(),                        
 LEDDD_FT_D = 0,                    
 LEDDD_FT_C = 0,                    
 LEDDD_MRG_FT = 0,                    
 LEDDD_RUNNINGBAL = 0                    
 from                         
 (                        
      select       
  LEDDD_CASH_MARGIN = isnull(sum(actualcash),0),       
  --LEDDD_NONCASH_COLL_HC = isnull(sum(EffectiveColl-ActualCash),0),       
  LEDDD_NONCASH_COLL_HC = isnull(sum(noncash),0),       
  Party_Code       
  from msajag.dbo.collateral (nolock)       
  where trans_date >= @fdate                        
       --and Convert(varchar,trans_date) < @fdate + '23:59:00'                 
         and trans_date like @fdate + '%'                 
       and party_code between @fparty And @tparty                         
       and exchange = 'MCX' and segment = 'FUTURES'                         
  Group By Party_Code       
 ) C       
                        
                        
/*====================================================================================                        
 Closing Balance - Client Cash Initial Margin A/c (B)            
 Opening Balance - Client Cash Initial Margin A/c                        
====================================================================================*/                        
                        
Insert into #LEDGER_DETAILS_DAS                         
select                         
 LEDDD_PARTY_CODE = party_code,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                         
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                        
 sum(LEDDD_OPENING_INIT_MARGIN),                       
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = sum(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN = 0,                       
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate(),
  LEDDD_FT_D = 0,                    
 LEDDD_FT_C = 0,                    
 LEDDD_MRG_FT = 0,                    
 LEDDD_RUNNINGBAL = 0                          
from                         
 (       
 select LEDDD_OPENING_INIT_MARGIN = sum(t.amount), Party_Code       
 from       
 (      
  select party_code, isnull(case when drcr='D' then sum(-Amount) else Sum(amount) end,0) as Amount       
  from AccountMCDX..MarginLedger l (nolock),                       
  AccountMCDX..Parameter P (nolock)      
  where party_code between @fparty and @tparty and vdt <= @fdate      
  and  @fdate between sdtcur and ldtcur and vdt >= sdtcur and vdt <= ldtcur                           
  group by party_code,drcr                    
 )t       
                group by t.Party_Code      
) F                       
group by                         
 PARTY_CODE       
                        
/*====================================================================================                        
        Initial and Exposure Margin for Today (D)                        
====================================================================================*/                        
Insert into #LEDGER_DETAILS_DAS                         
select                         
 LEDDD_PARTY_CODE = party_code,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = 0,                         
 LEDDD_CHQ_REC = 0,                        
 LEDDD_CHQ_PAY = 0,                        
 LEDDD_JV_ENTRY = 0,                        
 LEDDD_CLOSING_BAL = 0,                        
 LEDDD_CASH_MARGIN = 0,                   
 LEDDD_OPENING_INIT_MARGIN = 0,                        
 LEDDD_MRG_REC = 0,                        
 LEDDD_MRG_REPAY = 0,                        
 LEDDD_MRG_JV_ENTRY = 0,                        
 LEDDD_CLOSING_INIT_MARGIN = 0,                         
 LEDDD_NONCASH_COLL_HC = 0,                        
 LEDDD_INIT_EXPO_MARGIN,       
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate(),                        
 LEDDD_FT_D = 0,                    
 LEDDD_FT_C = 0,                    
 LEDDD_MRG_FT = 0,                    
 LEDDD_RUNNINGBAL = 0                    
from                         
    (                        
    select LEDDD_INIT_EXPO_MARGIN = isnull(sum(TotalMargin+MtoM),0), party_code       
 from FoMarginNew (nolock) where party_code between @fparty and @tparty and mdate like @fdate + '%'                        
      group by party_code       
    ) F      
                        
/*====================================================================================                        
 FINAL SELECT                        
====================================================================================*/                        
/*  
Select                         
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = sum(LEDDD_OPENING_BAL),                        
 LEDDD_CHQ_REC = sum(LEDDD_CHQ_REC),                        
 LEDDD_CHQ_PAY = sum(LEDDD_CHQ_PAY),                        
 LEDDD_JV_ENTRY = sum(LEDDD_JV_ENTRY),                        
 LEDDD_CLOSING_BAL = sum(LEDDD_CLOSING_BAL),                        
 LEDDD_CASH_MARGIN = sum(LEDDD_CASH_MARGIN),                        
 LEDDD_OPENING_INIT_MARGIN = sum(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_MRG_REC = sum(LEDDD_MRG_REC),                        
 LEDDD_MRG_REPAY = sum(LEDDD_MRG_REPAY),                        
 LEDDD_MRG_JV_ENTRY = sum(LEDDD_MRG_JV_ENTRY),                        
 LEDDD_CLOSING_INIT_MARGIN = sum(LEDDD_CLOSING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = sum(LEDDD_NONCASH_COLL_HC),                        
 LEDDD_INIT_EXPO_MARGIN = sum(LEDDD_INIT_EXPO_MARGIN),                      
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate()                        
 From                       
 #LEDGER_DETAILS_DAS  
 Group by LEDDD_PARTY_CODE          
*/  
                       
 INSERT INTO LEDGER_DETAILS_DAS --SELECT * FROM #LEDGER_DETAILS_DAS                      
Select                         
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                        
 LEDDD_SAUDA_DATE = @FDATE,                      
 LEDDD_OPENING_BAL = sum(LEDDD_OPENING_BAL),                        
 LEDDD_CHQ_REC = sum(LEDDD_CHQ_REC),                        
 LEDDD_CHQ_PAY = sum(LEDDD_CHQ_PAY),                        
 LEDDD_JV_ENTRY = sum(LEDDD_JV_ENTRY),                        
 LEDDD_CLOSING_BAL = sum(LEDDD_CLOSING_BAL),                        
 LEDDD_CASH_MARGIN = sum(LEDDD_CASH_MARGIN),                        
 LEDDD_OPENING_INIT_MARGIN = sum(LEDDD_OPENING_INIT_MARGIN),                        
 LEDDD_MRG_REC = sum(LEDDD_MRG_REC),                        
 LEDDD_MRG_REPAY = sum(LEDDD_MRG_REPAY),                        
 LEDDD_MRG_JV_ENTRY = sum(LEDDD_MRG_JV_ENTRY),                        
 LEDDD_CLOSING_INIT_MARGIN = sum(LEDDD_CLOSING_INIT_MARGIN),                        
 LEDDD_NONCASH_COLL_HC = sum(LEDDD_NONCASH_COLL_HC),                        
 LEDDD_INIT_EXPO_MARGIN = sum(LEDDD_INIT_EXPO_MARGIN),                      
 LEDDD_CREATED_BY = @UNAME,                      
 LEDDD_CREATED_DT = Getdate(),                        
 LEDDD_FT_D = sum(LEDDD_FT_D),                    
 LEDDD_FT_C = sum(LEDDD_FT_C),                    
 LEDDD_MRG_FT = sum(LEDDD_MRG_FT),                    
 LEDDD_RUNNINGBAL = Sum(LEDDD_RUNNINGBAL)                    
 From                       
 #LEDGER_DETAILS_DAS                        
 Group by LEDDD_PARTY_CODE              
                      
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pr_MultiISIN_Imp
-- --------------------------------------------------
CREATE  Proc  pr_MultiISIN_Imp 
	(
		@FileName Varchar(200)
	) AS
Declare @strSql varchar(1000)

Truncate table MultiISIN_Imp

Set @strSql = 'Bulk insert  MultiISIN_Imp from ''' + @FileName  + '''  with ( FIELDTERMINATOR = ''~'', ROWTERMINATOR = ''\n'' )'
Exec(@strSql)

--Delete Delivery_MultiIsin From MultiISIN_Imp Where left(ltrim(rtrim(MultiISIN_Imp.IsIn)),12) = Delivery_MultiIsin.Isin

Insert Into Delivery_MultiIsin
Select 
	Inst_Type = 'FUTCOM',
	Symbol = Left(Substring(SecName,1,Case when Charindex(' ', SecName,1) > 0 then Charindex(' ', SecName,1) else 12  end),12),
	IsIn=left(ltrim(rtrim(IsIn)),12),
	Perc = 0,
	Status = 'P',
	EffDate = DateAdd(m,-2,GetDate()) ,
	WareHouse = left(upper(ltrim(rtrim(City))),20),
	CreatedBy = ' ',
	CreatedOn = GetDate(),
	ModifiedBy = ' ',
	ModifiedOn = ' ',
	Remark = 'File Imp'
From 
	MultiISIN_Imp
Where
	upper(ltrim(rtrim(CommType1))) = 'COMMODITY'  And 
	upper(ltrim(rtrim(Status2))) = 'ACTIVE'
	and left(ltrim(rtrim(IsIn)),12) not in (Select Isin From Delivery_MultiIsin)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------

CREATE  Proc PR_SQLTABLEREINDEX (@TABLE_NAME AS VARCHAR(254) = '') AS
/*--------------------------------------------------------------------------------------------------------------------
Program Name 	: PR_SQLTABLEREINDEX
Desc 		: SQL Scripts to 
				1. Re Index all the Transaction Oriented Tables
				2. Checking Index Key Duplication 
Tables Using 	: 1. SQLTableIndex  - Keeping the following Details
			a. TableName
			b. IndexName
			c. IndexColumn
		  2.  SQLTableReIndex_Log - Keeping Re Index Log 
					    and Index Duplication Record
Logic 		: 
			Checking the Availability of the Required Index 
				If Found  --  Re Index & Log to SQLTableReIndex_Log with a remark as 'REINDEX'
				Else   - Create & Log to SQLTableReIndex_Log with a remark as 'NEWINDEX'
				
			Checking the Index Key Duplication
				If Found  -- Log to SQLTableReIndex_Log with a remark as 'DUPLICATE'
Program Benefit : 
			1. Standard Table Index to Maintain
			2. Re Creation Of Index for performance

----------------------------------------------------------------------------------------------------------------------*/



Declare 
	@TableCur Cursor,
	@TableName Varchar(20),
	@IndexName Varchar(10),
	@IndexColumn Varchar(100),
	@IndexColumnChk Varchar(100)
Declare 
	@TIndexName Varchar(20),
	@TIndexColum Varchar(100),
	@strSQL Varchar(200),
	@IndexCurSor Cursor,
	@IndexFlag int,
	@IndexPrv Varchar(20),
	@IndexColumnPrv Varchar(100),
 	@IndexType varchar(20)

SET NOCOUNT ON

Set @TableCur = Cursor For
Select
	TableName,
	IndexName,
	IndexColumn,
	IndexColumnChk = Ltrim(RTrim(Upper(Replace(IndexColumn,',',''))))
From
	SQLTableIndex
Where
	1 = 1
	and TableName = (case when isnull(@TABLE_NAME,'') <> '' then @TABLE_NAME else TableName end) 


Open @TableCur
Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
While @@Fetch_Status = 0       
Begin      
	Set @IndexFlag  = 0
	Set @IndexColumnPrv = ''
	Set @IndexPrv = ''
	Set @IndexCurSor = Cursor for Select * From 
	(
		Select 
			i.name as IndexName,
			case when (i.status & 16)<> 0 then 'CLUSTERED' 
			else 'NONCLUSTERED' end as IndexType,
			upper(isnull(index_col(@TableName, i.indid,1 ),'')+isnull(index_col(@TableName, i.indid,2 ),'')
			+isnull(index_col(@TableName, i.indid,3 ),'')+isnull(index_col(@TableName, i.indid,4 ),'')
			+isnull(index_col(@TableName, i.indid,5 ),'')+isnull(index_col(@TableName, i.indid,6),'')
			+isnull(index_col(@TableName, i.indid,7 ),'')+isnull(index_col(@TableName, i.indid,8),'') ) as IndexColumns
		from 
			(dbo.sysindexes i inner join dbo.sysfilegroups s on i.groupid = s.groupid )
		where 
			id = object_id(@TableName) and i.indid > 0 and i.indid < 255 and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsAutoStatistics') <> 1) and
			(INDEXPROPERTY(object_id(@TableName), i.name, N'IsHypothetical') <> 1)
		 
	)TblIdx  Order By IndexColumns
	Open @IndexCurSor
	Fetch Next From @IndexCurSor into @TIndexName,@IndexType,@TIndexColum
	While @@Fetch_Status = 0       
	Begin     
		if @IndexColumnPrv = @TIndexColum
			Begin
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@IndexPrv,@TIndexColum,'DUPLICATE',@@SPId,GetDate())	
			End 
		If (@TIndexColum = @IndexColumnChk OR @IndexName = @TIndexName) AND @IndexFlag =0
			Begin
				Set @IndexFlag  = 1
				Set @strSQL = 'CREATE ' + @IndexType + ' INDEX ['+ @TIndexName +'] ON [dbo].['+@TableName+']('
				Set @strSQL = @strSQL + @IndexColumn + ')'
				Set @strSQL = @strSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				Exec (@strSQL)
				Insert Into SQLTableReIndex_Log Values 
				(@TableName,@TIndexName,@IndexColumn,'REINDEX',@@SPId,GetDate())
			End
		Set @IndexPrv = @TIndexName
		Set @IndexColumnPrv = @TIndexColum
		Fetch Next From @IndexCurSor into @TIndexName,@IndexType,@TIndexColum
	End      
	Close @IndexCurSor      
	DeAllocate @IndexCurSor
	if @IndexFlag =0
		Begin
			Set @strSQL = 'CREATE INDEX ['+ @IndexName +'] ON [dbo].['+@TableName+']('
			Set @strSQL = @strSQL + @IndexColumn + ')'
			Exec (@strSQL)
			Insert Into SQLTableReIndex_Log Values 
			(@TableName,@IndexName,@IndexColumn,'NEWINDEX',@@SPId,GetDate())
		End
	Fetch Next From @TableCur Into 	@TableName,@IndexName,@IndexColumn,@IndexColumnChk
End
Close @TableCur      
DeAllocate @TableCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATE_CLIENT
-- --------------------------------------------------
CREATE PROC PR_VALIDATE_CLIENT AS

EXEC FOTRD_CLIENTMASTER

SELECT FOTRADE.* INTO #FOERRTRADE 
FROM FOTRADE (NOLOCK), FOOWNER (NOLOCK) WHERE EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK)
WHERE CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE AND CLIENT2.BANKID <> FOTRADE.PARTICIPANTCODE)
AND ISNULL(PARTICIPANTCODE,'') <> ''
AND PARTICIPANTCODE <> FOOWNER.MEMBERCODE

INSERT INTO FOERRTRADE      
SELECT * FROM #FOERRTRADE

SELECT PARTY_CODE,'IN ACTIVE' FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE
AND CLIENT5.INACTIVEFROM <= GETDATE()

/*UNION ALL

SELECT C.PARTY_CODE,'EXPIRED SEBI REG' FROM 
FOTRD_CLIENT2 (NOLOCK), CLIENT_DETAILS_VIEW C (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = C.CL_CODE
AND ISNULL(C.SEBI_REGN_NO,'') <> '' AND C.SEBI_EXP_DATE <= GETDATE()*/

UNION ALL

SELECT DISTINCT PARTY_CODE,'WRONG CP CODE' FROM #FOERRTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATEFILE
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[PR_VALIDATEFILE] 
(
	@FILETYPE VARCHAR(12),
	@FILEPATHNAME VARCHAR(400),
	@SAUDA_DATE VARCHAR(11) =''
) AS

DECLARE @FILENAME VARCHAR(100)
DECLARE @INTSTAT INT
DECLARE @STRRET VARCHAR(200)
DECLARE @EXCHANGECODE VARCHAR(3)

IF  CHARINDEX('\',@FILEPATHNAME) > 0
BEGIN
	SET @FILENAME = REVERSE(LEFT(REVERSE(@FILEPATHNAME),CHARINDEX('\',REVERSE(@FILEPATHNAME))-1))
END
ELSE
BEGIN
	SET @FILENAME = @FILEPATHNAME
END

SET @INTSTAT = 0
SET @STRRET  = ''

SELECT @EXCHANGECODE = UPPER(EXCHANGE)  FROM FOGLOBALS (NOLOCK)

IF @FILETYPE ='MARGIN'
BEGIN
	-- NSEFFO, NSEFOPCM
	IF @EXCHANGECODE = 'NCE' OR @EXCHANGECODE = 'NCM'  
		BEGIN
		IF LEFT(@FILENAME,4) <> 'O_MG'
		BEGIN
			SET @INTSTAT = 1
			SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
		END
	END

	-- NSECURFO, NSECURFOPCM
	IF @EXCHANGECODE = 'NSX' OR @EXCHANGECODE = 'NXM'  
		BEGIN
		IF LEFT(@FILENAME,4) <> 'X_MG'
		BEGIN
			SET @INTSTAT = 1
			SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
		END
	END	
	
END

SELECT @INTSTAT,@STRRET

/*-------------------------------------- END OF THE PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_AllocationMapping
-- --------------------------------------------------

CREATE Proc Proc_AllocationMapping (@username varchar(20) = '') As

Update FOExerciseAllocation_Temp Set Foea_Party_Code = A.NewParty_Code From  PartyMapping A Where a.OldParty_Code = FOExerciseAllocation_Temp.Foea_Party_Code

/*----------------------------------- Process Controler plug in ---------------------------------------*/
Declare @SaudaDate Varchar(11)
Set @SaudaDate = (Select Top 1 Left(FoEa_Position_Date,11)  from FOExerciseAllocation_Temp)

IF (SELECT COUNT(1)  
  FROM   (SELECT TOP 1 Business_Date  
          FROM   V2_BUSINESS_PROCESS  
          WHERE  Left(Business_Date,11) = @SaudaDate) A) = 0  
BEGIN    
	Insert Into V2_BUSINESS_PROCESS 
		(
			Business_Date,Import_Trade,VBB,STT,Billing,Contract,
			Posting,PositionFile,MarginFile,MarginReturnFile,ClientMarginPop,
			ExchangeSTT,ExerciseAllocation,Open_Close,ProcessDate,
			ProcessBy,LastUpdateDate,LastUpdateBy,MachineIP
		)
	Select 	
		Business_Date = @SaudaDate,
		Import_Trade = 1,
		VBB = 1,
		STT = 1,
		Billing = 0,
		Contract = 0,
		Posting = 0,
		PositionFile = 1,
		MarginFile = 0,
		MarginReturnFile = 0,
		ClientMarginPop = 0,
		ExchangeSTT = 0,
		ExerciseAllocation = 0,
		Open_Close = 0,
		ProcessDate = GetDate(),
		ProcessBy =@username,
		LastUpdateDate = GetDate(),
		LastUpdateBy ='',
		MachineIP =''
END
ELSE
BEGIN
	Update 
		V2_BUSINESS_PROCESS 
	Set 
		PositionFile = PositionFile + 1 ,
		LastUpdateDate = GetDate()
	
	Where 
		Left(Business_Date,11) = @SaudaDate
END

IF (SELECT COUNT(1)  
	FROM   (SELECT TOP 1 FoEa_Position_Date  
        	  FROM   FOExerciseAllocation_Temp  
	          WHERE  FoEa_Exercise_Qty+FoEa_Alloc_Qty > 0) A) > 0 
	BEGIN
		Update 
			V2_BUSINESS_PROCESS 
		Set 
			ExerciseAllocation = -1 ,
			LastUpdateDate = GetDate()
		Where 
			Left(Business_Date,11) = @SaudaDate		
	END

Insert Into V2_PROCESS_STATUS_LOG 
( 
	Exchange,Segment,BusinessDate,ProcessId,ProcessName,
	FileName,Start_End_Flag,ProcessDate,ProcessBy,MachineIP
)
Select
	Exchange=(Select Top 1 Exchange from FoTaxes),
	Segment='FUTURES',
	BusinessDate=@SaudaDate,
	ProcessId = 'POSIMP',
	ProcessName='Position File Import',
	FileName='',
	Start_End_Flag=1,
	ProcessDate=GetDate(),
	ProcessBy=@username,
	MachineIP=''

/*------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_Bulk_Ins
-- --------------------------------------------------
CREATE Proc Proc_Bulk_Ins (@TableName varchar(100), @FileName varchar(200), @ParseString Varchar(2) = ',') AS 

Declare @strSql varchar(500)

Set @strSql = 'Truncate table ' + @TableName
Exec(@strSql)

Set @strSql = 'Bulk insert  ' + @TableName + ' from ''' + @FileName  + '''  with ( FIELDTERMINATOR = ''' + @ParseString + ''', ROWTERMINATOR = ''\n'' )'
Exec(@strSql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CALCULATE_CHARGES
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_CALCULATE_CHARGES]   
(
	@SAUDA_DATE VARCHAR(11),  
	@FROMPARTY VARCHAR(10)='',  
	@TOPARTY VARCHAR(10)='ZZZZZZZZ'  
)  
AS  

/*
===============================================================================================
PROC NAME		: PROC_CALCULATE_CHARGES
DESCRIPTION		: COMPUTING CHARGES AS PER DEFINED IN TBL_CHARGES_DETAILS
DATE			: 21 JUN 2008
MODIFICATION LOG	:
===============================================================================================
*/  

DECLARE 
	@SQL VARCHAR(2000),  
	@RULECURSOR CURSOR,  
	@RULE_CODE VARCHAR(10),   
	@RULE_TYPE VARCHAR(20),   
	@RULE_DEFINATION VARCHAR(2000),  
	@CHARGE_CODE VARCHAR(10)  
  
IF (SELECT COUNT(1)    
 FROM   (SELECT TOP 1 PARTY_CODE    
   FROM   FOSETTLEMENT (NOLOCK)
   WHERE  SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND FOSETTLEMENT.TRADEQTY > 0   
	AND AUCTIONPART <> 'CA') A) = 0   
    BEGIN    
      RETURN    
    END    


/*-----------------------------------------------------------------------------------------------------
				CREATING TEMP TABLES
------------------------------------------------------------------------------------------------------*/
CREATE TABLE #CLIENT
(
	PARTY_CODE VARCHAR(10)
)  

INSERT INTO #CLIENT 
SELECT 
	PARTY_CODE 
FROM
	CLIENT1 (NOLOCK), CLIENT2 (NOLOCK)
WHERE
	CLIENT1.CL_CODE = CLIENT2.CL_CODE
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
	AND CL_TYPE <> 'INS'

CREATE CLUSTERED INDEX IDXPARTY ON #CLIENT (PARTY_CODE)

CREATE TABLE #TBL_CHARGES_DATA
(
	[PARTY_CODE] [VARCHAR] (50)  ,
	[CHARGE_CODE] [VARCHAR] (10)  ,
	[CHARGE_AMOUNT] [NUMERIC](18, 4)  ,
	[RULE_CODE] [VARCHAR] (10) 
) 


CREATE CLUSTERED INDEX IDXPARTY ON #TBL_CHARGES_DATA (PARTY_CODE)

CREATE TABLE #FOSETTLEMENT
(
	PARTY_CODE VARCHAR(10),
	inst_type varchar(6),
	AUCTIONPART VARCHAR(2),
	SELL_BUY INT,
	TRADEQTY INT,
	PRICE MONEY,
	BROKAPPLIED MONEY
)

CREATE CLUSTERED INDEX IDXPARTY ON #FOSETTLEMENT (PARTY_CODE)

/*-----------------------------------------------------------------------------------------------------
			RE CALCULATING OTHER CHARGES ACTUAL CHARGES
------------------------------------------------------------------------------------------------------*/
UPDATE FOSETTLEMENT SET 
 OTHER_CHRG = ((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END
		 * (PRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
            (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO))
  
FROM   FOTAXES (NOLOCK),
       FOCLIENTTAXES (NOLOCK)
       
WHERE  SAUDA_DATE >= @SAUDA_DATE
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
       AND FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE
       AND TRADEQTY > 0
       AND AUCTIONPART <> 'CA'  

/*-----------------------------------------------------------------------------------------------------
				FECHING DATA TO TEMP TABLES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #FOSETTLEMENT
SELECT 
	PARTY_CODE,INST_TYPE,AUCTIONPART,SELL_BUY,
	TRADEQTY=SUM(TRADEQTY),
	PRICE = SUM(ABS(CASE 
                             WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE
                             ELSE PRICE + 
					CASE WHEN AUCTIONPART= 'EA' 
					THEN 
						CASE WHEN LEFT(OPTION_TYPE,1) ='P' 
						THEN -STRIKE_PRICE 
						ELSE STRIKE_PRICE 
						END 
					ELSE 0 END
                           END)* TRADEQTY) / SUM(TRADEQTY),
	BROKAPPLIED = SUM(BROKAPPLIED*TRADEQTY)/SUM(TRADEQTY),
	BOOKTYPE, INSTRUMENT
FROM FOSETTLEMENT (NOLOCK)
WHERE
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND AUCTIONPART <> 'CA'
	AND TRADEQTY > 0
	--AND STATUS <> 'E'   
GROUP BY
	PARTY_CODE,INST_TYPE,AUCTIONPART,SELL_BUY,BOOKTYPE, INSTRUMENT

  
INSERT INTO #TBL_CHARGES_DATA  
SELECT 
	PARTY_CODE, CHARGE_CODE = '0',   
	TOTALCHARGE = SUM(OTHER_CHRG), RULE_CODE = ''
FROM 
	FOSETTLEMENT  (NOLOCK)
WHERE 
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
GROUP BY
	PARTY_CODE  
HAVING SUM(OTHER_CHRG) <> 0   
  
/*-----------------------------------------------------------------------------------------------------
				COMPUTING COMMON CHARGES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #TBL_CHARGES_DATA  
SELECT
	PARTY_CODE, CHARGE_CODE,    
	TOTALCHARGE = SUM(TOTALAMT+TRDAMT+DELAMT+TRDBUYAMT+TRDSELLAMT  
        		 +DELBUYAMT+DELSELLAMT+TOTALBUY+TOTALSELL), 
	CHARGE_RULE 
FROM (  
	SELECT S.PARTY_CODE, T.CHARGE_CODE, T.CHARGE_RULE,   
	TOTALAMT = (CASE WHEN T.CHARGE_BY = 'FLAT'   
	     THEN (CASE WHEN T.VAL_PER = 'V'  
	       THEN (CASE WHEN T.CHARGE_ON = 'NOTRAN'   
	            THEN CEILING(CONVERT(NUMERIC(18,4),COUNT(1))/  
	            (CASE WHEN ISNULL(T.UNIT,0) = 0   
	               THEN 1   
	               ELSE T.UNIT   
	             END)) * T.RATE  
	            ELSE T.RATE  
	          END)  
	       ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	            THEN SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	            WHEN T.CHARGE_ON = 'BROK'   
	            THEN SUM(TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	            ELSE 0  
	          END)  
	        END)  
	     ELSE 0  
	   END),  
	TRDAMT = (CASE WHEN T.CHARGE_BY = 'TRD'   
	     THEN SUM(CASE WHEN AUCTIONPART =''
	          THEN (CASE WHEN T.VAL_PER = 'V'  
	               THEN T.RATE  
	            ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)           
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	DELAMT = (CASE WHEN T.CHARGE_BY = 'DEL'   
	     THEN SUM(CASE WHEN AUCTIONPART = 'EA'
	          THEN (CASE WHEN T.VAL_PER = 'V'  
	               THEN T.RATE  
	            ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
			 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)             
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	TRDBUYAMT = (CASE WHEN T.CHARGE_BY = 'TRD_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART='' AND SELL_BUY = 1   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TRDSELLAMT = (CASE WHEN T.CHARGE_BY = 'TRD_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART='' AND SELL_BUY = 2   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELBUYAMT = (CASE WHEN T.CHARGE_BY = 'DEL_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART='EA' AND SELL_BUY = 1   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELSELLAMT = (CASE WHEN T.CHARGE_BY = 'DEL_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART='EA' AND SELL_BUY = 2   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALBUY = (CASE WHEN T.CHARGE_BY = 'BUY'   
	      THEN SUM(CASE WHEN SELL_BUY = 1   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALSELL = (CASE WHEN T.CHARGE_BY = 'SELL'   
	      THEN SUM(CASE WHEN SELL_BUY = 2   
	           THEN (CASE WHEN T.VAL_PER = 'V'  
	                THEN T.RATE  
	             ELSE (CASE WHEN T.CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*T.RATE/100  
	                 WHEN T.CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*T.RATE/100   
	                 ELSE 0  
	               END)           
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END)  
	FROM 
		#FOSETTLEMENT S (NOLOCK), TBL_CHARGE_DETAIL T (NOLOCK), #CLIENT C1 (NOLOCK), TBL_CHARGE_MASTER M
	WHERE 
		C1.PARTY_CODE = S.PARTY_CODE  
		AND T.PARTY_CODE = 'ALL' 
		AND T.CHARGE_CODE = M.CHARGE_CODE 
		AND @SAUDA_DATE BETWEEN FROMDATE AND TODATE
		AND S.PARTY_CODE NOT IN (  
			    SELECT PARTY_CODE FROM TBL_CHARGE_DETAIL T1, TBL_CHARGE_MASTER M1  
			       WHERE T1.CHARGE_CODE = M1.CHARGE_CODE AND m.CHARGE_NAME = m1.CHARGE_NAME  
			    AND @SAUDA_DATE BETWEEN T1.FROMDATE AND T1.TODATE  
			    AND T1.PARTY_CODE <> 'ALL' )
		AND T.LINE_NO = M.LINE_NO		
and 1 = (case when T.charge_rule  = 'R0001' and auctionpart = 'EA' and price > 0 then 1 else 0 end)
	GROUP BY 
		S.PARTY_CODE, T.CHARGE_CODE, T.CHARGE_RULE,   
		T.CHARGE_BY, T.RATE, T.VAL_PER, T.CHARGE_ON, T.UNIT
	) A  
GROUP BY 
	PARTY_CODE, CHARGE_CODE, CHARGE_RULE

/*-----------------------------------------------------------------------------------------------------
			COMPUTING PARTY SEPECIFIC CHARGES
------------------------------------------------------------------------------------------------------*/

INSERT INTO #TBL_CHARGES_DATA  
SELECT 
	PARTY_CODE, CHARGE_CODE,   
	TOTALCHARGE = SUM(TOTALAMT+TRDAMT+DELAMT+TRDBUYAMT+TRDSELLAMT  
		      +DELBUYAMT+DELSELLAMT+TOTALBUY+TOTALSELL),
	CHARGE_RULE
FROM (  
	SELECT S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE,   
	TOTALAMT = (CASE WHEN CHARGE_BY = 'FLAT'   
	     THEN (CASE WHEN VAL_PER = 'V'  
	       THEN (CASE WHEN CHARGE_ON = 'NOTRAN'   
	            THEN CEILING(CONVERT(NUMERIC(18,4),COUNT(1))/  
	            (CASE WHEN ISNULL(UNIT,0) = 0   
	               THEN 1   
	               ELSE UNIT   
	             END)) * RATE  
	            ELSE RATE  
	          END)  
	       ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	            THEN SUM(TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	            WHEN CHARGE_ON = 'BROK'   
	            THEN SUM(TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	            ELSE 0  
	          END)  
	        END)  
	     ELSE 0  
	   END),  
	TRDAMT = (CASE WHEN CHARGE_BY = 'TRD'   
	     THEN SUM(CASE WHEN AUCTIONPART =''   
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)           
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	DELAMT = (CASE WHEN CHARGE_BY = 'DEL'   
	     THEN SUM(CASE WHEN AUCTIONPART ='EA' 
	          THEN (CASE WHEN VAL_PER = 'V'  
	               THEN RATE  
	            ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)             
	          END)  
	          ELSE 0  
	        END)  
	     ELSE 0  
	    END),  
	TRDBUYAMT = (CASE WHEN CHARGE_BY = 'TRD_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART ='' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TRDSELLAMT = (CASE WHEN CHARGE_BY = 'TRD_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART ='' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELBUYAMT = (CASE WHEN CHARGE_BY = 'DEL_BUY'   
	      THEN SUM(CASE WHEN AUCTIONPART ='EA' AND SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	DELSELLAMT = (CASE WHEN CHARGE_BY = 'DEL_SELL'   
	      THEN SUM(CASE WHEN AUCTIONPART ='EA' AND SELL_BUY = 2   
	           THEN (CASE WHEN VAL_PER = 'V'  
	        THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)             
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALBUY = (CASE WHEN CHARGE_BY = 'BUY'   
	      THEN SUM(CASE WHEN SELL_BUY = 1   
	           THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)            
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END),  
	TOTALSELL = (CASE WHEN CHARGE_BY = 'SELL'   
	      THEN SUM(CASE WHEN SELL_BUY = 2   
	       THEN (CASE WHEN VAL_PER = 'V'  
	                THEN RATE  
	             ELSE (CASE WHEN CHARGE_ON = 'TURNOVER'   
	                 THEN (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT)*RATE/100  
	                 WHEN CHARGE_ON = 'BROK'   
	                 THEN (TRADEQTY*BROKAPPLIED*BOOKTYPE/INSTRUMENT)*RATE/100   
	                 ELSE 0  
	               END)           
	           END)  
	           ELSE 0  
	        END)  
	      ELSE 0  
	       END)  
	FROM 
		#FOSETTLEMENT S (NOLOCK), TBL_CHARGE_DETAIL T (NOLOCK),  #CLIENT C1 (NOLOCK)
	WHERE 
		C1.PARTY_CODE = S.PARTY_CODE  
		AND S.PARTY_CODE = T.PARTY_CODE 
AND @SAUDA_DATE BETWEEN FROMDATE AND TODATE 
and 1 = (case when charge_rule  = 'R0001' and auctionpart = 'EA' and price > 0  then 1 else 0 end)
	GROUP BY 
		S.PARTY_CODE, CHARGE_CODE, CHARGE_RULE,   
		CHARGE_BY, RATE, VAL_PER, CHARGE_ON, UNIT
	) A  
GROUP BY
	PARTY_CODE, CHARGE_CODE, CHARGE_RULE
  
DELETE FROM #TBL_CHARGES_DATA  
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_CHARGE_PARTY_EXCEPTION  
             WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO) 
AND CHARGE_CODE <> '0'

/*-----------------------------------------------------------------------------------------------------
					APPLYING RULES 
------------------------------------------------------------------------------------------------------*/

SET @RULECURSOR = CURSOR FOR  
SELECT 
	DISTINCT R.RULE_CODE, RULE_TYPE, RULE_DEFINITION, CHARGE_CODE   
FROM 
	#TBL_CHARGES_DATA T, TBL_RULE_MASTER R  
WHERE 
	R.RULE_CODE = T.RULE_CODE  
	AND T.RULE_CODE <> ''  
ORDER BY
	R.RULE_CODE  

OPEN @RULECURSOR  
FETCH NEXT FROM @RULECURSOR INTO @RULE_CODE, @RULE_TYPE, @RULE_DEFINATION, @CHARGE_CODE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
	SET @SQL = "DELETE FROM #TBL_CHARGES_DATA "  
	SET @SQL = @SQL + " WHERE "
	SET @SQL = @SQL + " CHARGE_CODE = '" + @CHARGE_CODE + "'"   
	IF @RULE_TYPE = 'NOT APPLICABLE'   
	BEGIN   
		SET @SQL = @SQL + " AND PARTY_CODE IN "  
	END   
	ELSE  
	BEGIN  
		SET @SQL = @SQL + " AND PARTY_CODE NOT IN "  
	END   
	SET @SQL = @SQL + " (SELECT PARTY_CODE FROM CLIENT1 C1, CLIENT2 C2 "  
	SET @SQL = @SQL + " WHERE C1.CL_CODE = C2.CL_CODE AND "  
	SET @SQL = @SQL + " PARTY_CODE BETWEEN '" + @FROMPARTY + "' AND '" + @TOPARTY + "' AND "  
	SET @SQL = @SQL + REPLACE(@RULE_DEFINATION,'SAUDADATE',@SAUDA_DATE) + ')'  
	--PRINT @SQL
	EXEC (@SQL)  
 FETCH NEXT FROM @RULECURSOR INTO @RULE_CODE, @RULE_TYPE, @RULE_DEFINATION, @CHARGE_CODE  
END  
CLOSE @RULECURSOR  
DEALLOCATE @RULECURSOR  

/*-----------------------------------------------------------------------------------------------------
			UPDATING FINAL CHARGES TO FO SETTLEMENT OTHER CHARGES
------------------------------------------------------------------------------------------------------*/

SELECT   PARTY_CODE,
         TOTALCHRG = SUM(CHARGE_AMOUNT)
INTO     #CHARGES
FROM     #TBL_CHARGES_DATA
WHERE    
         CHARGE_CODE <> '0'
         AND RULE_CODE <> 'R0001'
GROUP BY PARTY_CODE
         
SELECT   PARTY_CODE,
         TRADEORDERSELL = MIN(RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY))
INTO     #SETTCHARGE
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND EXISTS (SELECT PARTY_CODE
                     FROM   #CHARGES
                     WHERE  #CHARGES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)
	AND AUCTIONPART <> 'CA'
	--AND STATUS <> 'E'
	AND TRADEQTY > 0
GROUP BY PARTY_CODE
         
UPDATE FOSETTLEMENT
SET    OTHER_CHRG = OTHER_CHRG + TOTALCHRG, TURN_TAX=0
FROM   #CHARGES,
       #SETTCHARGE
WHERE  SAUDA_DATE >= @SAUDA_DATE
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
       AND #CHARGES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE.TRADEORDERSELL = RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY)

SELECT   PARTY_CODE,
         TOTALCHRG = SUM(CHARGE_AMOUNT)
INTO     #CHARGES_1
FROM     #TBL_CHARGES_DATA
WHERE    
         CHARGE_CODE <> '0'
         AND RULE_CODE = 'R0001'
GROUP BY PARTY_CODE
         
SELECT   PARTY_CODE,
         TRADEORDERSELL = MIN(RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY))
INTO     #SETTCHARGE_1
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND EXISTS (SELECT PARTY_CODE
                     FROM   #CHARGES_1
                     WHERE  #CHARGES_1.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)
	AND AUCTIONPART <> 'CA'
	AND AUCTIONPART = 'EA'
	AND PRICE > 0 
	--AND STATUS <> 'E'
	AND TRADEQTY > 0
GROUP BY PARTY_CODE
         
UPDATE FOSETTLEMENT
SET    OTHER_CHRG = OTHER_CHRG + TOTALCHRG, TURN_TAX=0
FROM   #CHARGES_1,
       #SETTCHARGE_1
WHERE  SAUDA_DATE >= @SAUDA_DATE
       AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
       AND #CHARGES_1.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE_1.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
       AND #SETTCHARGE_1.TRADEORDERSELL = RTRIM(TRADE_NO) + RTRIM(ORDER_NO) + CONVERT(VARCHAR,SELL_BUY)
       AND AUCTIONPART = 'EA'
	   AND PRICE > 0 
/*-----------------------------------------------------------------------------------------------------
			POPULATING COMPUTED CHARGES TO CHARGES DATA 
------------------------------------------------------------------------------------------------------*/
DELETE FROM 
	TBL_CHARGES_DATA  
WHERE 
	SAUDA_DATE >= @SAUDA_DATE
	AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  

INSERT INTO TBL_CHARGES_DATA
SELECT @SAUDA_DATE,PARTY_CODE,CHARGE_CODE,CHARGE_AMOUNT,RULE_CODE,GETDATE() FROM #TBL_CHARGES_DATA


/*--------------------------------------------  END OF THE PROCEDURE -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_CONTRACT_MST
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_CONTRACT_MST]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT F&O CONTRACT MASTER FILE
*/

TRUNCATE TABLE FoScrip_IMP


--DECLARE @STRSQL VARCHAR(MAX)

--SET @STRSQL = 'BULK INSERT FoScrip_IMP FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = ''|'', ROWTERMINATOR = ''' + Char(10) + ''',FIRSTROW=2 )'        

--EXEC(@STRSQL)        

select FILE_DATA into #data from filedata
where 1 = 2

DECLARE @STRSQL VARCHAR(MAX)
SET @STRSQL = 'BULK INSERT #data FROM ''' +  @FILENAME  + '''  WITH ( ROWTERMINATOR = ''' + Char(10) + ''')'        

EXEC(@STRSQL)    

 
insert into FoScrip_IMP
SELECT 
DBO.PIECE(FILE_DATA,'|',1)	,
DBO.PIECE(FILE_DATA,'|',2)	,
DBO.PIECE(FILE_DATA,'|',3)	,
DBO.PIECE(FILE_DATA,'|',4)	,
DBO.PIECE(FILE_DATA,'|',5)	,
DBO.PIECE(FILE_DATA,'|',6)	,
LEFT(DATEADD(S,CAST(DBO.PIECE(FILE_DATA,'|',7)as int),'01-01-1980'),11)	,
DBO.PIECE(FILE_DATA,'|',8)	,
DBO.PIECE(FILE_DATA,'|',9)	,
DBO.PIECE(FILE_DATA,'|',10)	,
DBO.PIECE(FILE_DATA,'|',11)	,
DBO.PIECE(FILE_DATA,'|',12)	,
DBO.PIECE(FILE_DATA,'|',13)	,
DBO.PIECE(FILE_DATA,'|',14)	,
DBO.PIECE(FILE_DATA,'|',15)	,
DBO.PIECE(FILE_DATA,'|',16)	,
DBO.PIECE(FILE_DATA,'|',17)	,
DBO.PIECE(FILE_DATA,'|',18)	,
DBO.PIECE(FILE_DATA,'|',19)	,
DBO.PIECE(FILE_DATA,'|',20)	,
DBO.PIECE(FILE_DATA,'|',21)	,
DBO.PIECE(FILE_DATA,'|',22)	,
DBO.PIECE(FILE_DATA,'|',23)	,
DBO.PIECE(FILE_DATA,'|',24)	,
DBO.PIECE(FILE_DATA,'|',25)	,
DBO.PIECE(FILE_DATA,'|',26)	,
LEFT(DATEADD(S,CAST(DBO.PIECE(FILE_DATA,'|',27) as int),'01-01-1980'),11)	,
LEFT(DATEADD(S,CAST(DBO.PIECE(FILE_DATA,'|',28)	as int),'01-01-1980'),11)	,
LEFT(DATEADD(S,CAST(DBO.PIECE(FILE_DATA,'|',29)	as int),'01-01-1980'),11)	,
DBO.PIECE(FILE_DATA,'|',30)	,
DBO.PIECE(FILE_DATA,'|',31)	,
DBO.PIECE(FILE_DATA,'|',32)	,
DBO.PIECE(FILE_DATA,'|',33)	,
CONVERT(FLOAT,DBO.PIECE(FILE_DATA,'|',34))	,
CONVERT(FLOAT,DBO.PIECE(FILE_DATA,'|',35))	,
DBO.PIECE(FILE_DATA,'|',36)	,
DBO.PIECE(FILE_DATA,'|',37)	,
DBO.PIECE(FILE_DATA,'|',38)	,
DBO.PIECE(FILE_DATA,'|',39)	,
DBO.PIECE(FILE_DATA,'|',40)	,
DBO.PIECE(FILE_DATA,'|',41)	,
DBO.PIECE(FILE_DATA,'|',42)	,
DBO.PIECE(FILE_DATA,'|',43)	,
DBO.PIECE(FILE_DATA,'|',44)	,
DBO.PIECE(FILE_DATA,'|',45)	,
DBO.PIECE(FILE_DATA,'|',46)	,
DBO.PIECE(FILE_DATA,'|',47)	,
DBO.PIECE(FILE_DATA,'|',48)	,
DBO.PIECE(FILE_DATA,'|',49)	,
DBO.PIECE(FILE_DATA,'|',50)	,
DBO.PIECE(FILE_DATA,'|',51)	,
DBO.PIECE(FILE_DATA,'|',52)	,
DBO.PIECE(FILE_DATA,'|',53)	,
DBO.PIECE(FILE_DATA,'|',54)	,
DBO.PIECE(FILE_DATA,'|',55)	,
DBO.PIECE(FILE_DATA,'|',56)	,
DBO.PIECE(FILE_DATA,'|',57)	,
DBO.PIECE(FILE_DATA,'|',58)	,
DBO.PIECE(FILE_DATA,'|',59)	,
DBO.PIECE(FILE_DATA,'|',60)	,
DBO.PIECE(FILE_DATA,'|',61)	,
DBO.PIECE(FILE_DATA,'|',62)	,
DBO.PIECE(FILE_DATA,'|',63)	,
DBO.PIECE(FILE_DATA,'|',64)	,
DBO.PIECE(FILE_DATA,'|',65)	,
DBO.PIECE(FILE_DATA,'|',66)	,
DBO.PIECE(FILE_DATA,'|',67)	,
DBO.PIECE(FILE_DATA,'|',68)	,
DBO.PIECE(FILE_DATA,'|',69)	
FROM #DATA
WHERE DBO.PIECE(FILE_DATA,'|',1) <> 'NEATCO'
--AND DBO.PIECE(FILE_DATA,'|',1) = '1'


EXEC SP_CONTRACTMASTER_UPD  

EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'CNTMST','','AUTO_PROCESS',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_FO_MARGINPROCESS
-- --------------------------------------------------


-- PROC_FO_MARGINPROCESS 1,'JAN 15 2015'




CREATE PROC [dbo].[PROC_FO_MARGINPROCESS]   
(
	@SNO INT,
	@TRADEDATE VARCHAR(11),
	@TMPFOLDER VARCHAR(400)
)  
AS  

CREATE TABLE #MARGINFILE
(
	MRGFILENAME VARCHAR(100),
	MRGFILEDATA VARCHAR(MAX)
)
DECLARE @SAUDA_DATE VARCHAR(11)
SET @SAUDA_DATE =CONVERT(VARCHAR,CONVERT(DATETIME,@TRADEDATE),103)

INSERT INTO #MARGINFILE
EXEC CLS_MARGIN_CALC_GET @SAUDA_DATE ,'AUTO_PROCESS'

DECLARE @FILENAME VARCHAR(200)
DECLARE @CMD VARCHAR(1000)


SET @TMPFOLDER = @TMPFOLDER + 'FOMRG_' + CONVERT(VARCHAR,@@SPID)
SELECT TOP 1 @FILENAME = @TMPFOLDER + '\'+ MRGFILENAME FROM #MARGINFILE

SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @TMPFOLDER + ''', NO_OUTPUT'  
EXEC (@CMD)


DECLARE @FS INT,  @FILEID INT
EXECUTE MASTER..SP_OACREATE 'SCRIPTING.FILESYSTEMOBJECT', @FS OUT
EXECUTE  MASTER..SP_OAMETHOD @FS, 'CREATETEXTFILE', @FILEID OUT, @FILENAME,TRUE
EXECUTE  MASTER..SP_OAMETHOD @FS, 'OPENTEXTFILE', @FILEID OUT, @FILENAME, 8, 1


DECLARE        
@MRGFILEDATA VARCHAR(1000),  
@MRGDATACUR  CURSOR        

SET @MRGDATACUR = CURSOR FOR  SELECT MRGFILEDATA FROM  #MARGINFILE  
OPEN @MRGDATACUR        
FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA  
WHILE @@FETCH_STATUS = 0         
BEGIN
	EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'WRITELINE', NULL, @MRGFILEDATA
FETCH NEXT FROM @MRGDATACUR INTO @MRGFILEDATA  
END        
CLOSE @MRGDATACUR        
DEALLOCATE @MRGDATACUR

EXECUTE  MASTER..SP_OAMETHOD @FILEID, 'CLOSE' 
EXECUTE  MASTER..SP_OADESTROY @FILEID
EXECUTE  MASTER..SP_OADESTROY @FS


DROP TABLE #MARGINFILE


UPDATE TBL_AUTO_PROCESS_DETAIL SET 
PROCESS_HALTED_REASON = 'MARGIN PROCESS COMPLETED SUCCESSFULLY.' ,
ATTACHEMENT_FILE_NAME = @FILENAME, 
PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),
PROCESS_OUTPUT_QUERY = ''
WHERE SNO = @SNO AND PROCESS_STATUS = 99


/*-------------------------------------- END OF THE PROC ----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_FO_MTOMCHECK
-- --------------------------------------------------

-- EXEC PROC_FO_MTOMCHECK  'JUL  1 2015'      
CREATE PROC [dbo].[PROC_FO_MTOMCHECK]         
(      
 @TRADEDATE VARCHAR(11)      
)        
AS        
      
CREATE TABLE #OBL      
(      
 ERR_CODE VARCHAR(10),      
 ERR_DESC VARCHAR(500)      
)      
  
DELETE TBL_DAILY_MTM_DIFF WHERE SAUDA_DATE = @TRADEDATE      
      
 INSERT INTO TBL_DAILY_MTM_DIFF      
 SELECT @TRADEDATE,      
  ISNULL(PARTY_CODE,''),ISNULL(INST_TYPE,''),ISNULL(SYMBOL,''),ISNULL(EXPIRYDATE,''),ISNULL(OPTION_TYPE,''),      
  ISNULL(STRIKE_PRICE,0),ISNULL(MTM,0),ISNULL(PRM,0),ISNULL(EXC,0),      
  ISNULL(FOEA_PARTY_CODE,''),ISNULL(FOEA_INST_TYPE,''),ISNULL(FOEA_SYMBOL,''),ISNULL(FOEA_EXPIRYDATE,''),      
  ISNULL(FOEA_OPTION_TYPE,''),ISNULL(FOEA_STRIKE_PRICE,0),ISNULL(FOEA_MTM,0),ISNULL(FOEA_PRM,0),ISNULL(FOEA_EXC,0),      
  ERR_DESC = CASE       
      WHEN MTM IS NULL OR PRM IS NULL OR EXC IS NULL  THEN ' NOT PRESENT IN BO'      
      WHEN FOEA_MTM IS NULL OR FOEA_PRM IS NULL OR FOEA_EXC IS NULL THEN 'NOT PRESENT IN EXCHANGE'      
      WHEN ISNULL(MTM,0) <> ISNULL(FOEA_MTM,0) THEN 'MOTM MISMATCH'      
      WHEN ISNULL(PRM,0) <> ISNULL(FOEA_PRM,0) THEN 'PREMIUM MISMATCH'      
      WHEN ISNULL(EXC,0) <> ISNULL(FOEA_EXC,0) THEN 'EXCECISE ALLOCATION MISMATCH'      
     END      
 FROM      
 (      
  SELECT       
  PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,      
  MTM=SUM(CASE WHEN LEFT(INST_TYPE,3) ='FUT' THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END),      
  PRM=SUM(CASE WHEN LEFT(INST_TYPE,3) ='OPT' AND AUCTIONPART ='' THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END),      
  EXC=SUM(CASE WHEN LEFT(INST_TYPE,3) ='OPT' AND AUCTIONPART ='EA' THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END)      
  FROM FOBILLVALAN (NOLOCK)      
  WHERE SAUDA_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'      
  AND PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER)       
  GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE      
 ) BO      
 FULL OUTER JOIN      
 (      
  SELECT FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_OPTION_TYPE,FOEA_STRIKE_PRICE,      
  FOEA_MTM = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE + FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),      
  FOEA_PRM = SUM(FOEA_NETPREMIUM),      
  FOEA_EXC = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)      
  FROM FOEXERCISEALLOCATION (NOLOCK)       
  WHERE FOEA_POSITION_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'      
  GROUP BY FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_OPTION_TYPE,FOEA_STRIKE_PRICE      
 ) EX      
 ON      
 (      
  PARTY_CODE = FOEA_PARTY_CODE AND      
  INST_TYPE  = FOEA_INST_TYPE AND      
  SYMBOL  = FOEA_SYMBOL AND      
  EXPIRYDATE = FOEA_EXPIRYDATE AND      
  OPTION_TYPE = FOEA_OPTION_TYPE AND      
  STRIKE_PRICE = FOEA_STRIKE_PRICE      
 )      
  
DELETE FROM TBL_DAILY_MTM_DIFF WHERE SAUDA_DATE = @TRADEDATE      
AND BO_MTM = 0 AND EX_MTM = 0  
AND BO_PRM = 0 AND EX_PRM = 0  
AND BO_EXC = 0 AND EX_EXC = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_FOCLOSING_MD_UP
-- --------------------------------------------------


  
  
  
CREATE PROC [dbo].[PROC_FOCLOSING_MD_UP]     
(  
 @FILENAME VARCHAR(100),  
 @TRADEDATE VARCHAR(11)  
)    
AS    
  
/*  
 PROC TO IMPORT F&O CLOSING RATE FILE (MD)  
*/  
  
  
CREATE TABLE #FOCLOSING  
(  
 MARKET    VARCHAR (17),  
 INST_TYPE   VARCHAR (17),  
 SYMBOL    VARCHAR(60),  
 EXPIRYDATE   VARCHAR(20),  
 STRIKE_PRICE  VARCHAR(100),  
 OPTION_TYPE   VARCHAR (100),  
 PREVIOUS_CLOSE  VARCHAR(100),  
 OPEN_PRICE   VARCHAR(100),  
 HIGH    VARCHAR(100),  
 LOW     VARCHAR(100),  
 CL_RATE    VARCHAR(100),  
 TOTAL_VOLUME  VARCHAR(100),  
 TOTAL_VALUE   VARCHAR(100),  
 OPEN_INTEREST  VARCHAR(100),  
 CHANGE_IN_OP_INT VARCHAR(100)  
)  
DECLARE @STRSQL VARCHAR(MAX)  
  
SET @STRSQL = 'BULK INSERT #FOCLOSING FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''0X0a'' )'  
   
exec(@STRSQL) 

    
  
UPDATE #FOCLOSING SET STRIKE_PRICE = '0' WHERE STRIKE_PRICE = ''  
  
UPDATE #FOCLOSING SET OPTION_TYPE ='' WHERE STRIKE_PRICE = '0'  
  
DELETE FOCLOSING WHERE TRADE_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'  
  
DELETE FOCLOSING_BILLREPORT WHERE TRADE_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'  
  
INSERT INTO FOCLOSING  
SELECT CONVERT(NUMERIC(18,4),CL_RATE),EXPIRYDATE=LEFT(CONVERT(DATETIME,EXPIRYDATE),11)+' 23:59',  
TRADE_DATE=@TRADEDATE + ' 23:59',INST_TYPE,SYMBOL,CONVERT(NUMERIC(18,4),STRIKE_PRICE),  
COR_ACT_LEVEL=0,MARKETTYPE='',OPTION_TYPE FROM #FOCLOSING  
  
INSERT INTO FOCLOSING_BILLREPORT  
SELECT CONVERT(NUMERIC(18,4),CL_RATE),EXPIRYDATE=LEFT(CONVERT(DATETIME,EXPIRYDATE),11)+' 23:59',  
TRADE_DATE=@TRADEDATE + ' 23:59',INST_TYPE,SYMBOL,CONVERT(NUMERIC(18,4),STRIKE_PRICE),  
COR_ACT_LEVEL=0,MARKETTYPE='',OPTION_TYPE FROM #FOCLOSING  
  
  
DROP TABLE #FOCLOSING  
  
EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'CLOSING','','AUTO_PROCESS',''  
  
/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_HISTORYTRANS_CHECKDB
-- --------------------------------------------------


CREATE PROCEDURE PROC_HISTORYTRANS_CHECKDB 
(
	@TABLE1 VARCHAR(100),
	@TABLE2 VARCHAR(100)
)AS


DECLARE @OBJIDI1 BIGINT
DECLARE @OBJIDI2 BIGINT
DECLARE @INTERRSTAT INT
DECLARE @INTERRDESC VARCHAR(100)

SET @OBJIDI1 = 0
SET @OBJIDI2 = 0

SELECT @OBJIDI1=ID FROM SYSOBJECTS WHERE NAME = @TABLE1
SELECT @OBJIDI2=ID FROM PRADNYA.DBO.SYSOBJECTS WHERE NAME = @TABLE2

IF @OBJIDI1 = 0 OR @OBJIDI1 = 2
BEGIN
	SET @INTERRSTAT = 1
	IF @OBJIDI1 = 0  
	BEGIN
		SET @INTERRDESC = 'MISSING TABLE ' + @TABLE1
	END
	ELSE
	BEGIN
		SET @INTERRDESC = 'MISSING TABLE ' + @TABLE2
	END
	GOTO ERROR
END


SET @INTERRSTAT = 0
SET @INTERRDESC =''

/*-----------------------------------------------------------------------------------*/
IF (
	SELECT 
		COUNT(1)
	FROM
	(
		SELECT 
			FLDNAME=NAME,
			FLDTYPE=XTYPE,
			FLDWIDTH=LENGTH
		FROM 
			SYSCOLUMNS  
		WHERE 
			ID = @OBJIDI1
			AND [NAME] NOT IN (SELECT   NAME FROM SYSCOLUMNS 
						 WHERE COLUMNPROPERTY(ID,NAME,'ISIDENTITY')=1 
						 AND ID = @OBJIDI1)
	)  FOSETT
	
	FULL OUTER JOIN
	
	(
		SELECT 
			FLDNAME=NAME,
			FLDTYPE=XTYPE,
			FLDWIDTH=LENGTH 
		FROM 
			PRADNYA.DBO.SYSCOLUMNS  WHERE ID = @OBJIDI2
	) HIST
	
	ON 
	(
		FOSETT.FLDNAME = HIST.FLDNAME
	)
	
	WHERE
			FOSETT.FLDNAME IS NULL OR HIST.FLDNAME IS NULL
	
) > 0
BEGIN
	SET @INTERRSTAT = 1
	SET @INTERRDESC = 'ADDITIONAL COLUMNS'
	GOTO ERROR
END
/*----------------------------------------------------------------------------------*/

IF (
	SELECT 
		COUNT(1)
	FROM
	(
		SELECT 
			FLDNAME=NAME,
			FLDTYPE=XTYPE,
			FLDWIDTH=LENGTH
		FROM 
			SYSCOLUMNS  
		WHERE 
			ID = @OBJIDI1
			AND [NAME] NOT IN (SELECT   NAME FROM SYSCOLUMNS 
						 WHERE COLUMNPROPERTY(ID,NAME,'ISIDENTITY')=1 
						 AND ID = @OBJIDI1)
	)  FOSETT,
	(
		SELECT 
			FLDNAME=NAME,
			FLDTYPE=XTYPE,
			FLDWIDTH=LENGTH 
		FROM 
			PRADNYA.DBO.SYSCOLUMNS  WHERE ID = @OBJIDI2
	) HIST
	
	WHERE 
		FOSETT.FLDNAME = HIST.FLDNAME
		AND	(
				FOSETT.FLDTYPE <> HIST.FLDTYPE OR
				FOSETT.FLDWIDTH <> HIST.FLDWIDTH
			)
	
) > 0
BEGIN
	SET @INTERRSTAT = 1
	SET @INTERRDESC = 'COLUMNS TYPE / WIDTH DIFFER'
	GOTO ERROR
END

/*---------------------------------------------------------------------------------------*/

	IF @@ERROR <> 0  
	BEGIN  
		SET @INTERRSTAT = -1  
		SET @INTERRDESC = 'ERROR WHILE OBJECT EXECUTION'  
		GOTO ERROR  
	END  
	ELSE  
	BEGIN  
		SET @INTERRSTAT = 0 
		SET @INTERRDESC ='' 
		GOTO ERROR  
	END

 ERROR:

	SELECT @INTERRSTAT, @INTERRDESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_MG13_UP
-- --------------------------------------------------





CREATE PROC [dbo].[PROC_MARGIN_MG13_UP]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT F&O MARGIN FILE
*/

TRUNCATE TABLE FOMARGINNEW_IMP


DECLARE @STRSQL VARCHAR(MAX)

SET @STRSQL = 'BULK INSERT FOMARGINNEW_IMP_VIEW FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''\n'' )'        

EXEC(@STRSQL)    
DELETE FOMARGINNEW
WHERE MDATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'

UPDATE FOMARGINNEW_IMP
SET CL_TYPE = 'CL'
WHERE CL_TYPE = 'C'

--INSERT INTO FOMARGINNEW (MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,CL_TYPE,DEL_MARGIN,MTOMLOSS,PMARGIN,
--						PMARGINAMOUNT,PSPANMARGIN,AddMargin,PEAKMARGIN) 
--SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN=MTOM,TOTALMARGIN,MTOM=NONSPREADMARGIN,CL_TYPE='C',0,MTOMLOSS,0,0,0,0,PEAKMARGIN
--FROM FOMARGINNEW_IMP

INSERT INTO FOMARGINNEW (MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,CL_TYPE,DEL_MARGIN,MTOMLOSS,PMARGIN,
						PMARGINAMOUNT,PSPANMARGIN,AddMargin,PEAKMARGIN) 
SELECT MDATE,PARTY_CODE,SPREADMARGIN,NONSPREADMARGIN,TOTALMARGIN,MTOM,CL_TYPE='C',0,MTOMLOSS,0,0,0,0,PEAKMARGIN
FROM FOMARGINNEW_IMP

UPDATE FOMARGINNEW SET PSPANMARGIN = SPREADMARGIN + ( SPREADMARGIN  * PMARGIN / 100) 
WHERE MDATE = @TRADEDATE

UPDATE FOMARGINNEW SET PMARGINAMOUNT = PSPANMARGIN + NONSPREADMARGIN  
WHERE MDATE = @TRADEDATE

INSERT INTO FOMARGINNEW
SELECT MEMBERCODE PARTY_CODE,SUM(SPREADMARGIN) SPREADMARGIN ,NONSPREADMARGIN=SUM(NONSPREADMARGIN),
SUM(TOTALMARGIN) TOTALMARGIN,0 PMARGIN,MDATE=MDATE,
SUM(PMARGINAMOUNT) PMARGINAMOUNT,SUM(PSPANMARGIN) PSPANMARGIN,
'TM' CL_TYPE, SUM(MTOM) MTOM, SUM(AddMargin) AddMargin,SUM(DEL_MARGIN),SUM(MTOMLOSS),SUM(PEAKMARGIN)
FROM FOMARGINNEW, FOOWNER
WHERE MDATE = @TRADEDATE
GROUP BY MEMBERCODE,MDATE

EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'MRGIMP','','AUTO_PROCESS',''

/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_MG13_UP_UDIFF_EOD
-- --------------------------------------------------




CREATE PROC [dbo].[PROC_MARGIN_MG13_UP_UDIFF_EOD]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT F&O MARGIN FILE
	EXEC PROC_MARGIN_MG13_UP_UDIFF_EOD 'D:/Backoffice/MARGIN/Margin_NCL_CD_0_TM_06769_20240304_F_0000.CSV','04/03/2024',''

*/

IF LEN(@TRADEDATE) = 10 AND CHARINDEX('/', @TRADEDATE) > 0
BEGIN
	SET @TRADEDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TRADEDATE, 103), 109)
END

 
--TRUNCATE TABLE FOMARGINNEW_IMP_STD

DECLARE @STRSQL VARCHAR(MAX)

CREATE TABLE #TBL_FOMARGINNEW_IMP_UDIFF_EOD
	(
	Sgmt	VARCHAR(2),
	Src		VARCHAR(5),
	RptgDt	DATETIME,
	BizDt	DATETIME,
	TradRegnOrgn VARCHAR(1),
	Lvl		VARCHAR(1),
	ClrMmbId VARCHAR(20),
	BrkrOrCtdnPtcptId VARCHAR(20),
	ClntTp VARCHAR(1),
	ClntId VARCHAR(20),
	ISIN VARCHAR(20),
	TckrSymb VARCHAR(30),
	SttlmTp VARCHAR(20),
	SctiesSttlmTxId VARCHAR(20),
	SctySrs VARCHAR(20),
	FinInstrmId VARCHAR(20),
	FinInstrmTp VARCHAR(20),
	XpryDt DATETIME,
	StrkPric VARCHAR(20),
	OptnTp VARCHAR(20),
	ValAtRskMrgn VARCHAR(20),
	SPANMrgn VARCHAR(20),
	LossMrgn VARCHAR(20),
	PrmAmt VARCHAR(20),
	CnsltdCrstllsdOblgtnMrg VARCHAR(20),
	DlvrySttlmtMrgn VARCHAR(20),
	SpclMrgn VARCHAR(20),
	SpclCshMrgn VARCHAR(20),
	TndrMrgn VARCHAR(20),
	AddtlMrgn VARCHAR(20),
	MrkToMktNetd VARCHAR(20),
	MinMrgn VARCHAR(20),
	SPANMrgnMin VARCHAR(20),
	XtrmLossMrgnMin VARCHAR(20),
	AggtPeakLbltyRptd VARCHAR(20),
	EndOfDayRqrmntRptd VARCHAR(20),
	TtlMrgnAsPerActlParams VARCHAR(20),
	TtlBuyTradgVol VARCHAR(20),
	TtlBuyTrfVal VARCHAR(20),
	TtlSellTradgVol VARCHAR(20),
	TtlSellTrfVal VARCHAR(20),
	NetOpnQty VARCHAR(20),
	NetOpnVal VARCHAR(20),
	CncntrtnMrgn VARCHAR(20),
	DvlmntMrgn VARCHAR(20),
	CrossMrgnBnftForSPAN VARCHAR(20),
	CrossMrgnBnftForELM VARCHAR(20),
	Rmks	VARCHAR(20),
	Rsvd1	VARCHAR(20),
	Rsvd2	VARCHAR(20),
	Rsvd3	VARCHAR(20),
	Rsvd4	VARCHAR(20)
	)

IF @PROCID <> ''
BEGIN
	INSERT INTO #TBL_FOMARGINNEW_IMP_UDIFF_EOD
	SELECT 
		Sgmt	= DBO.PIECE(FILE_DATA,',',1),
		Src		= DBO.PIECE(FILE_DATA,',',2),
		MARGINDATE	= DBO.PIECE(FILE_DATA,',',3),
		BizDt	= DBO.PIECE(FILE_DATA,',',4),
		TradRegnOrgn = DBO.PIECE(FILE_DATA,',',5),
		Lvl		= DBO.PIECE(FILE_DATA,',',6),
		ClrMmbId = DBO.PIECE(FILE_DATA,',',7),
		BrkrOrCtdnPtcptId = DBO.PIECE(FILE_DATA,',',8),
		ClntTp = DBO.PIECE(FILE_DATA,',',9),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',10),
		ISIN = DBO.PIECE(FILE_DATA,',',11),
		TckrSymb = DBO.PIECE(FILE_DATA,',',12),
		SttlmTp = DBO.PIECE(FILE_DATA,',',13),
		SctiesSttlmTxId = DBO.PIECE(FILE_DATA,',',14),
		SctySrs = DBO.PIECE(FILE_DATA,',',15),
		FinInstrmId = DBO.PIECE(FILE_DATA,',',16),
		FinInstrmTp = DBO.PIECE(FILE_DATA,',',17),
		XpryDt = DBO.PIECE(FILE_DATA,',',18),
		StrkPric = DBO.PIECE(FILE_DATA,',',19),
		OptnTp = DBO.PIECE(FILE_DATA,',',20),
		ValAtRskMrgn = DBO.PIECE(FILE_DATA,',',21),
		SPANMrgn = DBO.PIECE(FILE_DATA,',',22),
		LossMrgn = DBO.PIECE(FILE_DATA,',',23),
		PrmAmt = DBO.PIECE(FILE_DATA,',',24),
		CnsltdCrstllsdOblgtnMrg = DBO.PIECE(FILE_DATA,',',25),
		DlvrySttlmtMrgn = DBO.PIECE(FILE_DATA,',',26),
		SpclMrgn = DBO.PIECE(FILE_DATA,',',27),
		SpclCshMrgn = DBO.PIECE(FILE_DATA,',',28),
		TndrMrgn = DBO.PIECE(FILE_DATA,',',29),
		AddtlMrgn = DBO.PIECE(FILE_DATA,',',30),
		MrkToMktNetd = DBO.PIECE(FILE_DATA,',',31),
		MinMrgn = DBO.PIECE(FILE_DATA,',',32),
		SPANMrgnMin = DBO.PIECE(FILE_DATA,',',33),
		XtrmLossMrgnMin = DBO.PIECE(FILE_DATA,',',34),
		AggtPeakLbltyRptd = DBO.PIECE(FILE_DATA,',',35),
		EndOfDayRqrmntRptd = DBO.PIECE(FILE_DATA,',',36),
		TtlMrgnAsPerActlParams = DBO.PIECE(FILE_DATA,',',37),
		TtlBuyTradgVol = DBO.PIECE(FILE_DATA,',',38),
		TtlBuyTrfVal = DBO.PIECE(FILE_DATA,',',39),
		TtlSellTradgVol = DBO.PIECE(FILE_DATA,',',40),
		TtlSellTrfVal = DBO.PIECE(FILE_DATA,',',41),
		NetOpnQty = DBO.PIECE(FILE_DATA,',',42),
		NetOpnVal = DBO.PIECE(FILE_DATA,',',43),
		CncntrtnMrgn = DBO.PIECE(FILE_DATA,',',44),
		DvlmntMrgn = DBO.PIECE(FILE_DATA,',',45),
		CrossMrgnBnftForSPAN = DBO.PIECE(FILE_DATA,',',46),
		CrossMrgnBnftForELM = DBO.PIECE(FILE_DATA,',',47),
		Rmks	= DBO.PIECE(FILE_DATA,',',48),
		Rsvd1	= DBO.PIECE(FILE_DATA,',',49),
		Rsvd2	= DBO.PIECE(FILE_DATA,',',50),
		Rsvd3	= DBO.PIECE(FILE_DATA,',',51),
		Rsvd4	= DBO.PIECE(FILE_DATA,',',52)
	FROM 
		CLASSFILEUPD 
	WHERE 
		SESSION_ID = @PROCID
		AND DBO.PIECE(FILE_DATA,',',1) <> 'Sgmt'
	
	DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID
END
ELSE
BEGIN
	--CREATE TABLE #TBL_FOMARGINNEW_IMP_UDIFF
	--	(
	--	FILE_DATA	VARCHAR(MAX)
	--	)
	
	--SET @STRSQL = 'BULK INSERT #TBL_FOMARGINNEW_IMP_UDIFF FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )'        
	SET @STRSQL = 'BULK INSERT #TBL_FOMARGINNEW_IMP_UDIFF_EOD FROM ''' + @FILENAME + '''  WITH ( FIELDTERMINATOR = '','', FIRSTROW = 2, ROWTERMINATOR = ''\n'' )'
	PRINT @STRSQL
	EXEC(@STRSQL) 
END

DELETE FROM TBL_FOMARGINNEW_UDIFF_EOD WHERE MARGINDATE >= @TRADEDATE AND MARGINDATE <= @TRADEDATE + ' 23:59'

UPDATE	#TBL_FOMARGINNEW_IMP_UDIFF_EOD
SET		ClntId = 'PRO' + BrkrOrCtdnPtcptId
WHERE	Lvl = 'P' AND ClntTp = 'P' AND ClntId IS NULL

INSERT	INTO TBL_FOMARGINNEW_UDIFF_EOD
SELECT	*
FROM 	#TBL_FOMARGINNEW_IMP_UDIFF_EOD 
WHERE	Sgmt <> 'Sgmt'
		AND Lvl = 'P'

DROP TABLE #TBL_FOMARGINNEW_IMP_UDIFF_EOD


DELETE FOMARGINNEW 
WHERE MDATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'

--UPDATE	FOMARGINNEW_IMP_STD
--SET		CL_TYPE = 'CL'
--WHERE	CL_TYPE = 'C'

SELECT * INTO #FOMARGINNEW_EOD FROM FOMARGINNEW WHERE 1 = 2
 
INSERT INTO #FOMARGINNEW_EOD 
SELECT	PARTY_CODE,
		SPREADMARGIN = SPANMrgnMin,
		NONSPREADMARGIN = 0,
		TOTALMARGIN = EndOfDayRqrmntRptd,
		PMARGIN = 0,
		MARGINDATE,
		PMARGINAMOUNT = 0,
		PSPANMARGIN = 0,
		CL_TYPE = 'CL', 
		MTOM = XtrmLossMrgnMin,
		ADDMARGIN = 0,
		DEL_MARGIN = 0,
		MTOMLOSS = CnsltdCrstllsdOblgtnMrg,
		PEAKMARGIN = AggtPeakLbltyRptd
FROM	TBL_FOMARGINNEW_UDIFF_EOD 
WHERE	MARGINDATE >= @TRADEDATE AND MARGINDATE <= @TRADEDATE + ' 23:59'

UPDATE	#FOMARGINNEW_EOD SET PSPANMARGIN = SPREADMARGIN + ( SPREADMARGIN  * PMARGIN / 100) 
WHERE	MDATE = @TRADEDATE

UPDATE	#FOMARGINNEW_EOD SET PMARGINAMOUNT = PSPANMARGIN + NONSPREADMARGIN  
WHERE	MDATE = @TRADEDATE
 
INSERT	INTO FOMARGINNEW
SELECT	* FROM #FOMARGINNEW_EOD
 
EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'AMRGIMP','','AUTO_PROCESS',''

/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_MG13_UP_UDIFF_PEAK
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MARGIN_MG13_UP_UDIFF_PEAK]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT F&O MARGIN FILE
	EXEC PROC_MARGIN_MG13_UP_UDIFF_EOD 'D:/Backoffice/MARGIN/Margin_NCL_CD_0_TM_06769_20240304_F_0000.CSV','04/03/2024',''

*/

IF LEN(@TRADEDATE) = 10 AND CHARINDEX('/', @TRADEDATE) > 0
BEGIN
	SET @TRADEDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TRADEDATE, 103), 109)
END

 
--TRUNCATE TABLE FOMARGINNEW_IMP_STD

DECLARE @STRSQL			VARCHAR(MAX),
		@FILECOUNTER	INT

SELECT @FILENAME = REPLACE(@FILENAME,'|','') 

SELECT @FILECOUNTER = CASE WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1100' THEN '01'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1230' THEN '02'	
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1430' THEN '03'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1530' THEN '04'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1700' THEN '05'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '1900' THEN '06'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '2030' THEN '07'
						   WHEN  LEFT(RIGHT(@FILENAME,8),4) = '2230' THEN '08'
					  END	
								
CREATE TABLE #TBL_FOMARGINNEW_UDIFF_EOD
	(
	Sgmt	VARCHAR(2),
	Src		VARCHAR(5),
	RptgDt	DATETIME,
	BizDt	DATETIME,
	TradRegnOrgn VARCHAR(1),
	Lvl		VARCHAR(1),
	ClrMmbId VARCHAR(20),
	BrkrOrCtdnPtcptId VARCHAR(20),
	ClntTp VARCHAR(1),
	ClntId VARCHAR(20),
	ISIN VARCHAR(20),
	TckrSymb VARCHAR(30),
	SttlmTp VARCHAR(20),
	SctiesSttlmTxId VARCHAR(20),
	SctySrs VARCHAR(20),
	FinInstrmId VARCHAR(20),
	FinInstrmTp VARCHAR(20),
	XpryDt DATETIME,
	StrkPric VARCHAR(20),
	OptnTp VARCHAR(20),
	ValAtRskMrgn VARCHAR(20),
	SPANMrgn VARCHAR(20),
	LossMrgn VARCHAR(20),
	PrmAmt VARCHAR(20),
	CnsltdCrstllsdOblgtnMrg VARCHAR(20),
	DlvrySttlmtMrgn VARCHAR(20),
	SpclMrgn VARCHAR(20),
	SpclCshMrgn VARCHAR(20),
	TndrMrgn VARCHAR(20),
	AddtlMrgn VARCHAR(20),
	MrkToMktNetd VARCHAR(20),
	MinMrgn VARCHAR(20),
	SPANMrgnMin VARCHAR(20),
	XtrmLossMrgnMin VARCHAR(20),
	AggtPeakLbltyRptd VARCHAR(20),
	EndOfDayRqrmntRptd VARCHAR(20),
	TtlMrgnAsPerActlParams VARCHAR(20),
	TtlBuyTradgVol VARCHAR(20),
	TtlBuyTrfVal VARCHAR(20),
	TtlSellTradgVol VARCHAR(20),
	TtlSellTrfVal VARCHAR(20),
	NetOpnQty VARCHAR(20),
	NetOpnVal VARCHAR(20),
	CncntrtnMrgn VARCHAR(20),
	DvlmntMrgn VARCHAR(20),
	CrossMrgnBnftForSPAN VARCHAR(20),
	CrossMrgnBnftForELM VARCHAR(20),
	Rmks	VARCHAR(20),
	Rsvd1	VARCHAR(20),
	Rsvd2	VARCHAR(20),
	Rsvd3	VARCHAR(20),
	Rsvd4	VARCHAR(20)
	)

IF @PROCID <> ''
BEGIN
	INSERT INTO #TBL_FOMARGINNEW_UDIFF_EOD
	SELECT 
		Sgmt	= DBO.PIECE(FILE_DATA,',',1),
		Src		= DBO.PIECE(FILE_DATA,',',2),
		MARGINDATE	= DBO.PIECE(FILE_DATA,',',3),
		BizDt	= DBO.PIECE(FILE_DATA,',',4),
		TradRegnOrgn = DBO.PIECE(FILE_DATA,',',5),
		Lvl		= DBO.PIECE(FILE_DATA,',',6),
		ClrMmbId = DBO.PIECE(FILE_DATA,',',7),
		BrkrOrCtdnPtcptId = DBO.PIECE(FILE_DATA,',',8),
		ClntTp = DBO.PIECE(FILE_DATA,',',9),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',10),
		ISIN = DBO.PIECE(FILE_DATA,',',11),
		TckrSymb = DBO.PIECE(FILE_DATA,',',12),
		SttlmTp = DBO.PIECE(FILE_DATA,',',13),
		SctiesSttlmTxId = DBO.PIECE(FILE_DATA,',',14),
		SctySrs = DBO.PIECE(FILE_DATA,',',15),
		FinInstrmId = DBO.PIECE(FILE_DATA,',',16),
		FinInstrmTp = DBO.PIECE(FILE_DATA,',',17),
		XpryDt = DBO.PIECE(FILE_DATA,',',18),
		StrkPric = DBO.PIECE(FILE_DATA,',',19),
		OptnTp = DBO.PIECE(FILE_DATA,',',20),
		ValAtRskMrgn = DBO.PIECE(FILE_DATA,',',21),
		SPANMrgn = DBO.PIECE(FILE_DATA,',',22),
		LossMrgn = DBO.PIECE(FILE_DATA,',',23),
		PrmAmt = DBO.PIECE(FILE_DATA,',',24),
		CnsltdCrstllsdOblgtnMrg = DBO.PIECE(FILE_DATA,',',25),
		DlvrySttlmtMrgn = DBO.PIECE(FILE_DATA,',',26),
		SpclMrgn = DBO.PIECE(FILE_DATA,',',27),
		SpclCshMrgn = DBO.PIECE(FILE_DATA,',',28),
		TndrMrgn = DBO.PIECE(FILE_DATA,',',29),
		AddtlMrgn = DBO.PIECE(FILE_DATA,',',30),
		MrkToMktNetd = DBO.PIECE(FILE_DATA,',',31),
		MinMrgn = DBO.PIECE(FILE_DATA,',',32),
		SPANMrgnMin = DBO.PIECE(FILE_DATA,',',33),
		XtrmLossMrgnMin = DBO.PIECE(FILE_DATA,',',34),
		AggtPeakLbltyRptd = DBO.PIECE(FILE_DATA,',',35),
		EndOfDayRqrmntRptd = DBO.PIECE(FILE_DATA,',',36),
		TtlMrgnAsPerActlParams = DBO.PIECE(FILE_DATA,',',37),
		TtlBuyTradgVol = DBO.PIECE(FILE_DATA,',',38),
		TtlBuyTrfVal = DBO.PIECE(FILE_DATA,',',39),
		TtlSellTradgVol = DBO.PIECE(FILE_DATA,',',40),
		TtlSellTrfVal = DBO.PIECE(FILE_DATA,',',41),
		NetOpnQty = DBO.PIECE(FILE_DATA,',',42),
		NetOpnVal = DBO.PIECE(FILE_DATA,',',43),
		CncntrtnMrgn = DBO.PIECE(FILE_DATA,',',44),
		DvlmntMrgn = DBO.PIECE(FILE_DATA,',',45),
		CrossMrgnBnftForSPAN = DBO.PIECE(FILE_DATA,',',46),
		CrossMrgnBnftForELM = DBO.PIECE(FILE_DATA,',',47),
		Rmks	= DBO.PIECE(FILE_DATA,',',48),
		Rsvd1	= DBO.PIECE(FILE_DATA,',',49),
		Rsvd2	= DBO.PIECE(FILE_DATA,',',50),
		Rsvd3	= DBO.PIECE(FILE_DATA,',',51),
		Rsvd4	= DBO.PIECE(FILE_DATA,',',52)
	FROM 
		CLASSFILEUPD 
	WHERE 
		SESSION_ID = @PROCID
		AND DBO.PIECE(FILE_DATA,',',1) <> 'Sgmt'
	
	DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID
END
ELSE
BEGIN
	--CREATE TABLE #TBL_FOMARGINNEW_IMP_UDIFF
	--	(
	--	FILE_DATA	VARCHAR(MAX)
	--	)
	
	--SET @STRSQL = 'BULK INSERT #TBL_FOMARGINNEW_IMP_UDIFF FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )'        
	SET @STRSQL = 'BULK INSERT #TBL_FOMARGINNEW_UDIFF_EOD FROM ''' + @FILENAME + '''  WITH ( FIELDTERMINATOR = '','', FIRSTROW = 2, ROWTERMINATOR = ''\n'' )'
	PRINT @STRSQL
	EXEC(@STRSQL) 
END

DELETE FROM TBL_FOMARGINNEW_UDIFF_EOD WHERE MARGINDATE >= @TRADEDATE AND MARGINDATE <= @TRADEDATE + ' 23:59'

UPDATE	#TBL_FOMARGINNEW_UDIFF_EOD
SET		ClntId =  BrkrOrCtdnPtcptId
WHERE	Lvl = 'P' AND ClntTp = 'P' AND ClntId IS NULL 

INSERT	INTO TBL_FOMARGINNEW_UDIFF_EOD
SELECT	*
FROM 	#TBL_FOMARGINNEW_UDIFF_EOD 
WHERE	Sgmt <> 'Sgmt'


 
DROP TABLE #TBL_FOMARGINNEW_UDIFF_EOD
  
DELETE FROM FOMARGINNEW_INTRADAY
WHERE MDATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND FILECOUNTER = @FILECOUNTER

INSERT	INTO FOMARGINNEW_INTRADAY
SELECT	FILECOUNTER=@FILECOUNTER,
		MARGINDATE,
		PARTY_CODE,
		SPANMARGIN=ISNULL(SPANMrgnMin,0),
		NET_BUY_PREMIUM=ISNULL(PrmAmt,0),
		EXTREAMELOSSMARGIN=ISNULL(XtrmLossMrgnMin,0),
		MTOMLOSS= ISNULL(CnsltdCrstllsdOblgtnMrg,0),
		OTHER_MARGIN = 0,
		TOTALMARGIN= ISNULL(EndOfDayRqrmntRptd,0),
		CL_TYPE=ClntTp,
		UPLOAD_BY='',
		UPLOAD_ON=GETDATE()		
FROM	TBL_FOMARGINNEW_UDIFF_EOD
WHERE	MARGINDATE >= @TRADEDATE AND MARGINDATE <= @TRADEDATE + ' 23:59'
 
 

--EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'AMRGIMP','','AUTO_PROCESS',''

/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_REPORTING
-- --------------------------------------------------

  


CREATE PROC [dbo].[PROC_MARGIN_REPORTING]  
(  
           @SAUDA_DATE VARCHAR(11),  
           @FROMPARTY  VARCHAR(10),  
           @TOPARTY    VARCHAR(10)  
)  
AS  
  
  DECLARE  @PREVDATE VARCHAR(11)  
  DECLARE  @SDTCUR VARCHAR(11)  
  DECLARE  @LDTCUR VARCHAR(11)  
                       
  SELECT @PREVDATE = LEFT(MAX(TRADE_DATE),11)  
  FROM   FOCLOSING  
  WHERE  TRADE_DATE < @SAUDA_DATE  
  
SELECT @SDTCUR = LEFT(SDTCUR,11) ,  
 @LDTCUR = LEFT(LDTCUR,11)  
FROM ACCOUNTNCE.DBO.PARAMETER P  
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   
  
CREATE TABLE #MARGINREPORTING  
(  
 PARTY_CODE  VARCHAR(12),  
 PREV_CASH   NUMERIC(18,4),  
 PREV_FD   NUMERIC(18,4),  
 PREV_BG  NUMERIC(18,4),  
 PREV_SEC   NUMERIC(18,4),  
 PREV_VAR   NUMERIC(18,4),  
 CURR_CASH   NUMERIC(18,4),  
 CURR_FD   NUMERIC(18,4),  
 CURR_BG   NUMERIC(18,4),  
 CURR_SEC   NUMERIC(18,4),  
 MAR_ADJUST   NUMERIC(18,4),  
 MAR_STATUS   NUMERIC(18,4)  
)  
   
 CREATE  INDEX [mindx] ON [dbo].[#MARGINREPORTING] ( [PARTY_CODE])  
  
  INSERT INTO   #MARGINREPORTING                       
  SELECT DISTINCT PARTY_CODE,  
                  PREV_CASH = 0,  
                  PREV_FD = 0,  
                  PREV_BG = 0,  
                  PREV_SEC = 0,  
                  PREV_VAR = 0,  
                  CURR_CASH = 0,  
                  CURR_FD = 0,  
                  CURR_BG = 0,  
                  CURR_SEC = 0,  
                  MAR_ADJUST = 0,  
                  MAR_STATUS = 0  
  FROM   FOMARGINNEW  
  WHERE  MDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
         AND CL_TYPE <> 'TM'  
  
                          
  UPDATE #MARGINREPORTING  
  SET    PREV_CASH = C.CASH,  
         PREV_FD = C.FD,  
         PREV_BG = C.BG,  
         PREV_SEC = C.SEC  
  FROM   (SELECT   PARTY_CODE=PARENTCODE,  
                   FD = SUM(CASE   
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT  
                              ELSE 0  
                            END),  
                   BG = SUM(CASE   
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT  
                              ELSE 0  
                            END),  
                   SEC = SUM(CASE   
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT  
                               ELSE 0  
                             END),  
                   CASH = SUM(CASE   
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT  
                                ELSE 0  
                              END)  
          FROM     MSAJAG.DBO.COLLATERALDETAILS C, CLIENT2 (NOLOCK)  
          WHERE      
     C.PARTY_CODE = CLIENT2.PARTY_CODE  
     AND EFFDATE BETWEEN @PREVDATE  AND @PREVDATE + ' 23:59'  
                   AND C.EXCHANGE = 'NCE'  
                   AND C.SEGMENT = 'FUTURES'  
          GROUP BY PARENTCODE) C  
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE  
  
                                         
  UPDATE #MARGINREPORTING  
  SET    PREV_VAR = MARGIN  
  FROM   (SELECT   PARTY_CODE,  
                   MARGIN = SUM(TOTALMARGIN + MTOM)  
          FROM     FOMARGINNEW  
          WHERE    MDATE BETWEEN @PREVDATE  AND  @PREVDATE + ' 23:59'  
                   AND CL_TYPE <> 'TM'  
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
          GROUP BY PARTY_CODE) C  
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE  
                                        
                                        
  UPDATE #MARGINREPORTING  
  SET    CURR_CASH = C.CASH - PREV_CASH,  
         CURR_FD = C.FD - PREV_FD,  
         CURR_BG = C.BG - PREV_BG,  
         CURR_SEC = C.SEC - PREV_SEC  
  FROM   (SELECT   PARTY_CODE=PARENTCODE,  
                   FD = SUM(CASE   
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT  
                              ELSE 0  
                            END),  
                   BG = SUM(CASE   
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT  
                              ELSE 0  
                            END),  
 SEC = SUM(CASE   
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT  
                               ELSE 0  
                             END),  
                   CASH = SUM(CASE   
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT  
                                ELSE 0  
                              END)  
          FROM     MSAJAG.DBO.COLLATERALDETAILS C, CLIENT2 (NOLOCK)  
          WHERE    C.PARTY_CODE = CLIENT2.PARTY_CODE  
     AND EFFDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
                   AND C.EXCHANGE = 'NCE'  
                   AND C.SEGMENT = 'FUTURES'  
          GROUP BY PARENTCODE) C  
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE  
  
  UPDATE #MARGINREPORTING  
  SET    PREV_CASH = PREV_CASH + LEDBAL  
  FROM   (SELECT   CLTCODE=PARENTCODE,  
                   LEDBAL = SUM(CASE   
                                  WHEN DRCR = 'C' THEN VAMT  
                                  ELSE -VAMT  
                                END)  
          FROM     ACCOUNTNCE.DBO.LEDGER L, CLIENT2 (NOLOCK),ACCOUNTNCE.DBO.PARAMETER P    
          WHERE      
     CLTCODE = CLIENT2.PARTY_CODE  
     AND VDT BETWEEN SDTCUR AND LDTCUR  
     AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  
           AND VDT < @SAUDA_DATE  
           AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY  
          GROUP BY PARENTCODE) L  
  WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE  
                      
  UPDATE #MARGINREPORTING  
  SET    CURR_CASH = CURR_CASH + LEDBAL  
  FROM   (SELECT   CLTCODE=PARENTCODE,  
                   LEDBAL = SUM(CASE   
                                  WHEN DRCR = 'C' THEN VAMT  
                                  ELSE -VAMT  
                                END)  
          FROM     ACCOUNTNCE.DBO.LEDGER L, CLIENT2 (NOLOCK)  
          WHERE    CLTCODE = CLIENT2.PARTY_CODE   
     AND VDT >= @SDTCUR  
                   AND VDT <= @LDTCUR + ' 23:59'  
                   AND VDT BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
                   AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY  
          GROUP BY PARENTCODE) L  
  WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE  
    
                         
  UPDATE #MARGINREPORTING  
  SET    MAR_ADJUST = MARGIN -PREV_VAR  
  FROM   (SELECT   PARTY_CODE,  
                   MARGIN = SUM(TOTALMARGIN + MTOM)  
          FROM     FOMARGINNEW  
          WHERE    MDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
                   AND CL_TYPE <> 'TM'  
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
     GROUP BY PARTY_CODE) C  
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE  
                                         
  UPDATE #MARGINREPORTING  
  SET    MAR_STATUS = PREV_CASH + PREV_FD + PREV_BG + PREV_SEC - PREV_VAR +   
  CURR_CASH + CURR_FD + CURR_BG + CURR_SEC - MAR_ADJUST  
                                                                                                                         
  DELETE FROM MARGIN_REPORTING  
  WHERE       SAUDA_DATE = @SAUDA_DATE  
              AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
                                                      
  INSERT INTO MARGIN_REPORTING  
  SELECT @SAUDA_DATE,  
         *,  
         GETDATE()  
  FROM   #MARGINREPORTING  
  
  DROP TABLE #MARGINREPORTING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_MarginMapping
-- --------------------------------------------------
CREATE Proc Proc_MarginMapping As

Update FoMarginNew_IMP Set Party_Code = A.NewParty_Code From  PartyMapping  A Where a.OldParty_Code = FoMarginNew_IMP.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_OPT_FUT_CONVERT
-- --------------------------------------------------





CREATE PROC [dbo].[PROC_OPT_FUT_CONVERT]
(
	@SAUDA_DATE	VARCHAR(11)
)
AS

-- EXEC PROC_OPT_FUT_CONVERT @SAUDA_DATE = 'NOV 28 2017' 

DELETE FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
AND INST_TYPE LIKE 'FUTCOM'
AND PRICE > 0 
AND AUCTIONPART = 'EA'
AND USER_ID = '9999'

SELECT CONTRACTNO=MAX(CONTRACTNO),BILLNO=MAX(BILLNO),TRADE_NO=MIN(TRADE_NO),PARTY_CODE,INST_TYPE='FUTCOM',
	   SYMBOL,SEC_NAME=CONVERT(VARCHAR(200),''),EXPIRYDATE,STRIKE_PRICE,--=0,
	   OPTION_TYPE='',USER_ID='9999',PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY=SUM(TRADEQTY),AUCTIONPART='EA',MARKETTYPE,SERIES,
	   ORDER_NO=MIN(ORDER_NO),PRICE=CONVERT(NUMERIC(18,4),0),SAUDA_DATE,TABLE_NO,LINE_NO=1,VAL_PERC=0,NORMAL=0,DAY_PUC=0,
	   DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,
	   SELL_BUY = (CASE WHEN Sell_buy = 2 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 1 
					    WHEN Sell_buy = 2 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 2
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 2 
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 1
						ELSE 1 
					END),
	   SETTFLAG=(CASE WHEN Sell_buy = 2 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 1 
					    WHEN Sell_buy = 2 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 2
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 2 
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 1
						ELSE 1 
					END) + 3,BROKAPPLIED=0,
	   NETRATE=0,AMOUNT=0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,SERVICE_TAX=0,
	   TRADE_AMOUNT=0,BILLFLAG=0,SETT_NO=0,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,SETT_TYPE=0,CL_RATE=0,
	   PARTICIPANTCODE,STATUS='E' ,
	   CPID=0,INSTRUMENT,BOOKTYPE,BRANCH_ID=0,TMARK=0,SCHEME=0,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0
	   INTO #FOSETTEXP
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE  @SAUDA_DATE +'%' 
AND INST_TYPE LIKE 'OPTFUT'
AND PRICE > 0 
AND AUCTIONPART = 'EA' 
GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE,SELL_BUY,PRO_CLI,O_C_FLAG,C_U_FLAG,MARKETTYPE,SERIES,SAUDA_DATE,TABLE_NO,PARTICIPANTCODE,INSTRUMENT,BOOKTYPE,OPTION_TYPE,STRIKE_PRICE
/*
INSERT INTO #FOSETTEXP
SELECT CONTRACTNO=MAX(CONTRACTNO),BILLNO=MAX(BILLNO),TRADE_NO=MIN(TRADE_NO),PARTY_CODE,INST_TYPE='FUTCOM',
	   SYMBOL,SEC_NAME=CONVERT(VARCHAR(200),''),EXPIRYDATE,STRIKE_PRICE=0,
	   OPTION_TYPE='',USER_ID='9999',PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY=SUM(TRADEQTY),AUCTIONPART='EA',MARKETTYPE,SERIES,
	   ORDER_NO=MIN(ORDER_NO),PRICE=CONVERT(NUMERIC(18,4),0),SAUDA_DATE,TABLE_NO,LINE_NO=1,VAL_PERC=0,NORMAL=0,DAY_PUC=0,
	   DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,
	   SELL_BUY,
	   SETTFLAG=(CASE WHEN SELL_BUY = 1 THEN 4 ELSE 5 END),BROKAPPLIED=0,
	   NETRATE=0,AMOUNT=0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,SERVICE_TAX=0,
	   TRADE_AMOUNT=0,BILLFLAG=0,SETT_NO=0,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,SETT_TYPE=0,CL_RATE=0,
	   PARTICIPANTCODE,STATUS='E' ,
	   CPID=0,INSTRUMENT,BOOKTYPE,BRANCH_ID=0,TMARK=0,SCHEME=0,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0	   
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE  @SAUDA_DATE +'%' 
AND INST_TYPE LIKE 'OPTFUT'
AND PRICE > 0 
AND AUCTIONPART = 'EA'
AND OPTION_TYPE = 'CE'
GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE,SELL_BUY,PRO_CLI,O_C_FLAG,C_U_FLAG,MARKETTYPE,SERIES,SAUDA_DATE,TABLE_NO,PARTICIPANTCODE,INSTRUMENT,BOOKTYPE
*/
  
SELECT F.SYMBOL, NEWEXPDATE = MIN(F.EXPIRYDATE), EXPDATE = E.EXPDATE, SEC_NAME = MIN(SEC_NAME)
INTO #EXPDATE 
FROM FOSCRIP2 F, (SELECT DISTINCT SYMBOL, EXPDATE = EXPIRYDATE, NEWEXPDATE = EXPIRYDATE
FROM #FOSETTEXP) E
WHERE F.INST_TYPE = 'FUTCOM' 
AND F.EXPIRYDATE > @SAUDA_DATE + ' 23:59' 
AND F.SYMBOL = E.SYMBOL
GROUP BY F.SYMBOL, E.EXPDATE

UPDATE #FOSETTEXP SET EXPIRYDATE = NEWEXPDATE, SEC_NAME = #EXPDATE.SEC_NAME
FROM #EXPDATE
WHERE #EXPDATE.SYMBOL = #FOSETTEXP.SYMBOL
AND #EXPDATE.EXPDATE = #FOSETTEXP.EXPIRYDATE 

UPDATE   #FOSETTEXP SET BookType = Numerator,  
Instrument = Denominator 
FROM FOSCRIP2 F
WHERE F.Inst_Type = #FOSETTEXP.INST_TYPE 
AND F.Symbol = #FOSETTEXP.Symbol
AND F.Expirydate = #FOSETTEXP.Expirydate
AND F.Strike_price = #FOSETTEXP.STRIKE_PRICE 
AND F.Option_type = #FOSETTEXP.OPTION_TYPE

UPDATE   FOSETTLEMENT SET BookType = Numerator,  
Instrument = Denominator 
FROM FOSCRIP2 F
WHERE Sauda_date LIKE @SAUDA_DATE + '%' 
AND F.Inst_Type = FOSETTLEMENT.INST_TYPE 
AND F.Symbol = FOSETTLEMENT.Symbol
AND F.Expirydate = FOSETTLEMENT.Expirydate
AND F.Strike_price = FOSETTLEMENT.STRIKE_PRICE 
AND F.Option_type = FOSETTLEMENT.OPTION_TYPE
AND F.Inst_Type LIKE 'OPT%' 
AND AuctionPart ='ea' 
 
 /*
UPDATE #FOSETTEXP SET PRICE = B.CL_RATE, NETRATE = B.CL_RATE 
FROM FOCLOSING_BILLREPORT B
WHERE TRADE_DATE LIKE @SAUDA_DATE + '%'
AND B.INST_TYPE = #FOSETTEXP.INST_TYPE
AND B.SYMBOL = #FOSETTEXP.SYMBOL
AND B.EXPIRYDATE = #FOSETTEXP.EXPIRYDATE
AND B.STRIKE_PRICE = #FOSETTEXP.STRIKE_PRICE 
AND B.OPTION_TYPE = #FOSETTEXP.OPTION_TYPE
AND PRICE = 0 
*/

UPDATE #FOSETTEXP SET PRICE = STRIKE_PRICE, NETRATE = STRIKE_PRICE 

UPDATE #FOSETTEXP SET STRIKE_PRICE=0

DELETE FROM #FOSETTEXP
WHERE LEFT(SAUDA_DATE,11) = LEFT(EXPIRYDATE,11)

INSERT INTO FOSETTLEMENT
SELECT * FROM #FOSETTEXP

DROP TABLE #FOSETTEXP
DROP TABLE #EXPDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_OPT_FUT_CONVERT_BAK_15082024
-- --------------------------------------------------





CREATE PROC [dbo].[PROC_OPT_FUT_CONVERT_BAK_15082024]
(
	@SAUDA_DATE	VARCHAR(11)
)
AS

-- EXEC PROC_OPT_FUT_CONVERT @SAUDA_DATE = 'NOV 28 2017' 

DELETE FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
AND INST_TYPE LIKE 'FUTCOM'
AND PRICE > 0 
AND AUCTIONPART = 'EA'
AND USER_ID = '9999'

SELECT CONTRACTNO=MAX(CONTRACTNO),BILLNO=MAX(BILLNO),TRADE_NO=MIN(TRADE_NO),PARTY_CODE,INST_TYPE='FUTCOM',
	   SYMBOL,SEC_NAME=CONVERT(VARCHAR(200),''),EXPIRYDATE,STRIKE_PRICE,--=0,
	   OPTION_TYPE='',USER_ID='9999',PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY=SUM(TRADEQTY),AUCTIONPART='EA',MARKETTYPE,SERIES,
	   ORDER_NO=MIN(ORDER_NO),PRICE=CONVERT(NUMERIC(18,4),0),SAUDA_DATE,TABLE_NO,LINE_NO=1,VAL_PERC=0,NORMAL=0,DAY_PUC=0,
	   DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,
	   SELL_BUY = (CASE WHEN Sell_buy = 2 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 1 
					    WHEN Sell_buy = 2 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 2
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 2 
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 1
						ELSE 1 
					END),
	   SETTFLAG=(CASE WHEN Sell_buy = 2 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 1 
					    WHEN Sell_buy = 2 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 2
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'CE' OR OPTION_TYPE = 'CA') THEN 2 
						WHEN Sell_buy = 1 AND (OPTION_TYPE = 'PE' OR OPTION_TYPE = 'PA') THEN 1
						ELSE 1 
					END) + 3,BROKAPPLIED=0,
	   NETRATE=0,AMOUNT=0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,SERVICE_TAX=0,
	   TRADE_AMOUNT=0,BILLFLAG=0,SETT_NO=0,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,SETT_TYPE=0,CL_RATE=0,
	   PARTICIPANTCODE,STATUS='E' ,
	   CPID=0,INSTRUMENT,BOOKTYPE,BRANCH_ID=0,TMARK=0,SCHEME=0,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0
	   INTO #FOSETTEXP
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE  @SAUDA_DATE +'%' 
AND INST_TYPE = 'OPTFUT'
AND PRICE > 0 
AND AUCTIONPART = 'EA' 
GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE,SELL_BUY,PRO_CLI,O_C_FLAG,C_U_FLAG,MARKETTYPE,SERIES,SAUDA_DATE,TABLE_NO,PARTICIPANTCODE,INSTRUMENT,BOOKTYPE,OPTION_TYPE,STRIKE_PRICE
/*
INSERT INTO #FOSETTEXP
SELECT CONTRACTNO=MAX(CONTRACTNO),BILLNO=MAX(BILLNO),TRADE_NO=MIN(TRADE_NO),PARTY_CODE,INST_TYPE='FUTCOM',
	   SYMBOL,SEC_NAME=CONVERT(VARCHAR(200),''),EXPIRYDATE,STRIKE_PRICE=0,
	   OPTION_TYPE='',USER_ID='9999',PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY=SUM(TRADEQTY),AUCTIONPART='EA',MARKETTYPE,SERIES,
	   ORDER_NO=MIN(ORDER_NO),PRICE=CONVERT(NUMERIC(18,4),0),SAUDA_DATE,TABLE_NO,LINE_NO=1,VAL_PERC=0,NORMAL=0,DAY_PUC=0,
	   DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,
	   SELL_BUY,
	   SETTFLAG=(CASE WHEN SELL_BUY = 1 THEN 4 ELSE 5 END),BROKAPPLIED=0,
	   NETRATE=0,AMOUNT=0,INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,SERVICE_TAX=0,
	   TRADE_AMOUNT=0,BILLFLAG=0,SETT_NO=0,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,SETT_TYPE=0,CL_RATE=0,
	   PARTICIPANTCODE,STATUS='E' ,
	   CPID=0,INSTRUMENT,BOOKTYPE,BRANCH_ID=0,TMARK=0,SCHEME=0,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0	   
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE  @SAUDA_DATE +'%' 
AND INST_TYPE LIKE 'OPTFUT'
AND PRICE > 0 
AND AUCTIONPART = 'EA'
AND OPTION_TYPE = 'CE'
GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE,SELL_BUY,PRO_CLI,O_C_FLAG,C_U_FLAG,MARKETTYPE,SERIES,SAUDA_DATE,TABLE_NO,PARTICIPANTCODE,INSTRUMENT,BOOKTYPE
*/
  
SELECT F.SYMBOL, NEWEXPDATE = MIN(F.EXPIRYDATE), EXPDATE = E.EXPDATE, SEC_NAME = MIN(SEC_NAME)
INTO #EXPDATE 
FROM FOSCRIP2 F, (SELECT DISTINCT SYMBOL, EXPDATE = EXPIRYDATE, NEWEXPDATE = EXPIRYDATE
FROM #FOSETTEXP) E
WHERE F.INST_TYPE = 'FUTENR' 
AND F.EXPIRYDATE > @SAUDA_DATE + ' 23:59' 
AND F.SYMBOL = E.SYMBOL
GROUP BY F.SYMBOL, E.EXPDATE

UPDATE #FOSETTEXP SET EXPIRYDATE = NEWEXPDATE, SEC_NAME = #EXPDATE.SEC_NAME
FROM #EXPDATE
WHERE #EXPDATE.SYMBOL = #FOSETTEXP.SYMBOL
AND #EXPDATE.EXPDATE = #FOSETTEXP.EXPIRYDATE 

UPDATE   #FOSETTEXP SET BookType = Numerator,  
Instrument = Denominator 
FROM FOSCRIP2 F
WHERE F.Inst_Type = #FOSETTEXP.INST_TYPE 
AND F.Symbol = #FOSETTEXP.Symbol
AND F.Expirydate = #FOSETTEXP.Expirydate
AND F.Strike_price = #FOSETTEXP.STRIKE_PRICE 
AND F.Option_type = #FOSETTEXP.OPTION_TYPE

UPDATE   FOSETTLEMENT SET BookType = Numerator,  
Instrument = Denominator 
FROM FOSCRIP2 F
WHERE Sauda_date LIKE @SAUDA_DATE + '%' 
AND F.Inst_Type = FOSETTLEMENT.INST_TYPE 
AND F.Symbol = FOSETTLEMENT.Symbol
AND F.Expirydate = FOSETTLEMENT.Expirydate
AND F.Strike_price = FOSETTLEMENT.STRIKE_PRICE 
AND F.Option_type = FOSETTLEMENT.OPTION_TYPE
AND F.Inst_Type LIKE 'OPT%' 
AND AuctionPart ='ea' 
 
 
UPDATE #FOSETTEXP SET PRICE = B.CL_RATE, NETRATE = B.CL_RATE 
FROM FOCLOSING_BILLREPORT B
WHERE TRADE_DATE LIKE @SAUDA_DATE + '%'
AND B.INST_TYPE = #FOSETTEXP.INST_TYPE
AND B.SYMBOL = #FOSETTEXP.SYMBOL
AND B.EXPIRYDATE = #FOSETTEXP.EXPIRYDATE
AND B.STRIKE_PRICE = #FOSETTEXP.STRIKE_PRICE 
AND B.OPTION_TYPE = #FOSETTEXP.OPTION_TYPE
AND PRICE = 0 


UPDATE #FOSETTEXP SET PRICE = 413.00, NETRATE = 413.00 

UPDATE #FOSETTEXP SET STRIKE_PRICE=0

DELETE FROM #FOSETTEXP
WHERE LEFT(SAUDA_DATE,11) = LEFT(EXPIRYDATE,11)

INSERT INTO FOSETTLEMENT
SELECT * FROM #FOSETTEXP

DROP TABLE #FOSETTEXP
DROP TABLE #EXPDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_POSITION_PS04_UP
-- --------------------------------------------------






CREATE PROC [dbo].[PROC_POSITION_PS04_UP]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROCID VARCHAR(50)=''
)  
AS  
/*
	PROC TO IMPORT F&O POSITION FILE
*/

TRUNCATE TABLE FOEXERCISEALLOCATION_TEMP


DECLARE @STRSQL VARCHAR(MAX)

SET @STRSQL = 'BULK INSERT FOEXERCISEALLOCATION_TEMP FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''\n'' )'        

EXEC(@STRSQL)    


UPDATE FOEXERCISEALLOCATION SET FOEA_EXPIRYDATE= LEFT(FOEA_EXPIRYDATE,11) + ' 23:59'
WHERE FOEXERCISEALLOCATION.FOEA_POSITION_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' 
    
UPDATE FOEXERCISEALLOCATION SET FOEA_OPTION_TYPE = '' , FOEA_STRIKE_PRICE = 0 
WHERE FOEXERCISEALLOCATION.FOEA_POSITION_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND LEFT(FOEA_INST_TYPE,3) ='FUT'

UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_EXPIRYDATE= LEFT(FOEA_EXPIRYDATE,11) + ' 23:59'
    
UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_OPTION_TYPE = '' , FOEA_STRIKE_PRICE = 0 WHERE LEFT(FOEA_INST_TYPE,3) ='FUT'

DELETE FOEXERCISEALLOCATION 
WHERE FOEXERCISEALLOCATION.FOEA_POSITION_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND
EXISTS (SELECT FOEA_PARTY_CODE FROM FOEXERCISEALLOCATION_TEMP WHERE
	FOEXERCISEALLOCATION_TEMP.FOEA_PARTY_CODE = FOEXERCISEALLOCATION.FOEA_PARTY_CODE AND  
	FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE = FOEXERCISEALLOCATION.FOEA_INST_TYPE AND  
	FOEXERCISEALLOCATION_TEMP.FOEA_SYMBOL = FOEXERCISEALLOCATION.FOEA_SYMBOL AND  
	FOEXERCISEALLOCATION_TEMP.FOEA_EXPIRYDATE = FOEXERCISEALLOCATION.FOEA_EXPIRYDATE AND  
	FOEXERCISEALLOCATION_TEMP.FOEA_STRIKE_PRICE = FOEXERCISEALLOCATION.FOEA_STRIKE_PRICE AND  
	FOEXERCISEALLOCATION_TEMP.FOEA_OPTION_TYPE = FOEXERCISEALLOCATION.FOEA_OPTION_TYPE)

DELETE FOCLOSING  
WHERE FOCLOSING.TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND	
LEFT(INST_TYPE,3) ='FUT'

DELETE FOCLOSING_BILLREPORT 
WHERE TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND	
LEFT(INST_TYPE,3) ='FUT'

INSERT INTO FOCLOSING  
SELECT DISTINCT 
	CL_RATE= FOEA_SETTLEMENTPRICE,
	EXPIRYDATE = FOEA_EXPIRYDATE,
	TRADE_DATE = @TRADEDATE + ' 23:59',
	INST_TYPE = FOEA_INST_TYPE,
	SYMBOL= FOEA_SYMBOL,
	STRIKE_PRICE = FOEA_STRIKE_PRICE,
	COR_ACT_LEVEL ='0',
	MARKETTYPE ='0',
	OPTION_TYPE = FOEA_OPTION_TYPE
FROM FOEXERCISEALLOCATION_TEMP  
WHERE LEFT(FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE,3) ='FUT'
  

INSERT INTO FOCLOSING_BILLREPORT  
SELECT DISTINCT 
	CL_RATE= FOEA_SETTLEMENTPRICE,
	EXPIRYDATE = FOEA_EXPIRYDATE,
	TRADE_DATE = @TRADEDATE + ' 23:59',
	INST_TYPE = FOEA_INST_TYPE,
	SYMBOL= FOEA_SYMBOL,
	STRIKE_PRICE = FOEA_STRIKE_PRICE,
	COR_ACT_LEVEL ='0',
	MARKETTYPE ='0',
	OPTION_TYPE = FOEA_OPTION_TYPE
FROM FOEXERCISEALLOCATION_TEMP  
WHERE LEFT(FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE,3) ='FUT'
  

UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING
WHERE OLDPARTY_CODE = FOEXERCISEALLOCATION_TEMP.FOEA_PARTY_CODE

 
INSERT INTO FOEXERCISEALLOCATION  
SELECT FOEA_TABLE_NO='0',FOEA_POSITION_DATE,FOEA_DESC='POSITION FILE ',FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,FOEA_TM_CODE,FOEA_ACC_TYPE,
FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,FOEA_COR_ACT_LEVEL,FOEA_PREEXALL_LONGQTY,
FOEA_PREEXALL_SHORTQTY,FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,FOEA_POSTEXALL_LONGQTY,FOEA_POSTEXALL_SHORTQTY,FOEA_BROUGHT_FORWARD_LONG_QUANTITY,
FOEA_BROUGHT_FORWARD_LONG_VALUE,FOEA_BROUGHT_FORWARD_SHORT_QUANTITY,FOEA_BROUGHT_FORWARD_SHORT_VALUE,FOEA_DAY_BUY_OPEN_QUANTITY,
FOEA_DAY_BUY_OPEN_VALUE,FOEA_DAY_SELL_OPEN_QUANTITY,FOEA_DAY_SELL_OPEN_VALUE,FOEA_PREEXALL_LONGVALUE,FOEA_PREEXALL_SHORTVALUE,
FOEA_POSTEXALL_LONGVALUE,FOEA_POSTEXALL_SHORTVALUE,FOEA_SETTLEMENTPRICE,FOEA_NETPREMIUM,FOEA_DAILY_MTM_SETTLEMENT_VALUE,
FOEA_FUTURES_FINAL_SETTLEMENT_VALUE,FOEA_EXERCISED_ASSIGNED_VALUE
FROM FOEXERCISEALLOCATION_TEMP


EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'POSIMP','','AUTO_PROCESS',''

/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_POSITION_PS04_UP_UDIFF
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_POSITION_PS04_UP_UDIFF]         
(      
 @FILENAME VARCHAR(100),      
 @TRADEDATE VARCHAR(11) ,     
@PROCID VARCHAR(50)=''
)        
AS        
/*      
 PROC TO IMPORT F&O POSITION FILE      
*/      
      
TRUNCATE TABLE FOEXERCISEALLOCATION_TEMP
TRUNCATE TABLE FOEXERCISEALLOCATION_TEMP_UDIFF 


CREATE TABLE #FOEXERCISEALLOCATION_TEMP_UDIFF
(
	FILE_DATA	VARCHAR(MAX)
)

      
      
DECLARE @STRSQL VARCHAR(MAX)      
IF @PROCID <> ''
BEGIN
		INSERT INTO #FOEXERCISEALLOCATION_TEMP_UDIFF
		SELECT
			FILE_DATA
		FROM 
			CLASSFILEUPD
		WHERE 
			SESSION_ID = @PROCID
		DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID

		DELETE   FROM #FOEXERCISEALLOCATION_TEMP_UDIFF where FILE_DATA like 'SGMT%'



INSERT INTO FOEXERCISEALLOCATION_TEMP_UDIFF  
 SELECT  
		DBO.PIECE(FILE_DATA,',',1),
		DBO.PIECE(FILE_DATA,',',2),
		DBO.PIECE(FILE_DATA,',',3),
		DBO.PIECE(FILE_DATA,',',4),
		DBO.PIECE(FILE_DATA,',',5),
		DBO.PIECE(FILE_DATA,',',6),
		DBO.PIECE(FILE_DATA,',',7),
		DBO.PIECE(FILE_DATA,',',8),
		DBO.PIECE(FILE_DATA,',',9),
		DBO.PIECE(FILE_DATA,',',10),
		DBO.PIECE(FILE_DATA,',',11),
		DBO.PIECE(FILE_DATA,',',12),
		DBO.PIECE(FILE_DATA,',',13),
		DBO.PIECE(FILE_DATA,',',14),
		DBO.PIECE(FILE_DATA,',',15),
		DBO.PIECE(FILE_DATA,',',16),
		DBO.PIECE(FILE_DATA,',',17),
		DBO.PIECE(FILE_DATA,',',18),
		DBO.PIECE(FILE_DATA,',',19),
		DBO.PIECE(FILE_DATA,',',20),
		DBO.PIECE(FILE_DATA,',',21),
		DBO.PIECE(FILE_DATA,',',22),
		DBO.PIECE(FILE_DATA,',',23),
		DBO.PIECE(FILE_DATA,',',24),
		DBO.PIECE(FILE_DATA,',',25),
		DBO.PIECE(FILE_DATA,',',26),
		DBO.PIECE(FILE_DATA,',',27),
		DBO.PIECE(FILE_DATA,',',28),
		DBO.PIECE(FILE_DATA,',',29),
		DBO.PIECE(FILE_DATA,',',30),
		DBO.PIECE(FILE_DATA,',',31),
		DBO.PIECE(FILE_DATA,',',32),
		DBO.PIECE(FILE_DATA,',',33),
		DBO.PIECE(FILE_DATA,',',34),
		DBO.PIECE(FILE_DATA,',',35),
		DBO.PIECE(FILE_DATA,',',36),
		DBO.PIECE(FILE_DATA,',',37),
		DBO.PIECE(FILE_DATA,',',38),
		DBO.PIECE(FILE_DATA,',',39),
		DBO.PIECE(FILE_DATA,',',40),
		DBO.PIECE(FILE_DATA,',',41),
		DBO.PIECE(FILE_DATA,',',42),
		DBO.PIECE(FILE_DATA,',',43),
		DBO.PIECE(FILE_DATA,',',44),
		DBO.PIECE(FILE_DATA,',',45),
		DBO.PIECE(FILE_DATA,',',46)
	FROM 
		#FOEXERCISEALLOCATION_TEMP_UDIFF 
	--WHERE 
	--	SESSION_ID = @PROCID
	--DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROCID
	
END
ELSE
BEGIN
	SET @STRSQL = 'BULK INSERT FOEXERCISEALLOCATION_TEMP_UDIFF FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''0x0a'',FIRSTROW=2 )'  

	EXEC(@STRSQL)    
END


--SELECT * from FOEXERCISEALLOCATION_TEMP_UDIFF

UPDATE A SET FININSTRMTP = PROCESS_VALUE
		FROM FOEXERCISEALLOCATION_TEMP_UDIFF A,MSAJAG..TBL_STANDARD_VALUES B
		WHERE A.FININSTRMTP = B.FIELD_VALUE
		AND FIELD_DESC='INSTRUMENTTYPE'
		AND EXCHANGE='MCX'
		AND SEGMENT='FUTURES'


      
INSERT INTO FOEXERCISEALLOCATION_TEMP
SELECT 
--FOEA_TABLE_NO='',
FOEA_POSITION_DATE= CONVERT(DATETIME,RPTGDT),
FOEA_SEGMENT_IND=SGMT,
FOEA_SETT_TYPE='',
--FOEA_DESC='',
FOEA_CM_CODE=CLRMMBID,
FOEA_MEM_TYPE='',
FOEA_TM_CODE=BRKRORCTDNPTCPTID,
FOEA_ACC_TYPE=CLNTTP,
FOEA_PARTY_CODE=CLNTID,
FOEA_INST_TYPE = FININSTRMTP,
FOEA_SYMBOL = TCKRSYMB,
FOEA_EXPIRYDATE = CONVERT(DATETIME,XPRYDT) + ' 23:59:00',
FOEA_STRIKE_PRICE = STRKPRIC,
FOEA_OPTION_TYPE = OPTNTP,
FOEA_COR_ACT_LEVEL='0',
FOEA_BROUGHT_FORWARD_LONG_QUANTITY = OPNGLNGQTY,
FOEA_BROUGHT_FORWARD_LONG_VALUE = OPNGLNGVAL,
FOEA_BROUGHT_FORWARD_SHORT_QUANTITY = OPNGSHRTQTY,
FOEA_BROUGHT_FORWARD_SHORT_VALUE = OPNGSHRTVAL,
FOEA_DAY_BUY_OPEN_QUANTITY = OPNBUYTRADGQTY,
FOEA_DAY_BUY_OPEN_VALUE = OPNBUYTRADGVAL,
FOEA_DAY_SELL_OPEN_QUANTITY = OPNSELLTRADGQTY,
FOEA_DAY_SELL_OPEN_VALUE = OPNSELLTRADGVAL,
FOEA_PREEXALL_LONGQTY= PREEXRCASSGNDLNGQTY,
FOEA_PREEXALL_LONGVALUE  = PREEXRCASSGNDLNGVAL,
FOEA_PREEXALL_SHORTQTY= PREEXRCASSGNDSHRTQTY,
FOEA_PREEXALL_SHORTVALUE = PREEXRCASSGNDSHRTVAL,
FOEA_EXERCISE_QTY=EXRCDQTY,
FOEA_ALLOC_QTY=ASSGNDQTY,

FOEA_POSTEXALL_LONGQTY= PSTEXRCASSGNDLNGQTY,
FOEA_POSTEXALL_LONGVALUE  = PREEXRCASSGNDLNGVAL,
FOEA_POSTEXALL_SHORTQTY=PSTEXRCASSGNDSHRTQTY,
FOEA_POSTEXALL_SHORTVALUE = PREEXRCASSGNDSHRTVAL,

FOEA_SETTLEMENTPRICE = STTLMPRIC,
FOEA_NETPREMIUM = PRMAMT,
FOEA_DAILY_MTM_SETTLEMENT_VALUE = DALYMRKTOMKTSETTLMVAL,
FOEA_FUTURES_FINAL_SETTLEMENT_VALUE = FUTRSFNLSTTLMVAL,
FOEA_EXERCISED_ASSIGNED_VALUE = EXRCASSGNDVAL

FROM FOEXERCISEALLOCATION_TEMP_UDIFF
WHERE UPPER(SGMT)<>'SGMT' 





UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_EXPIRYDATE= LEFT(FOEA_EXPIRYDATE,11) + ' 23:59'      
          
UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_OPTION_TYPE = '' , FOEA_STRIKE_PRICE = 0 WHERE LEFT(FOEA_INST_TYPE,3) ='FUT'      
          


UPDATE A SET FOEA_INST_TYPE = PROCESS_VALUE
FROM FOEXERCISEALLOCATION_TEMP A,[ANGELNSECM].MSAJAG.dbo.TBL_STANDARD_VALUES B
WHERE A.FOEA_INST_TYPE = B.FIELD_VALUE
AND FIELD_DESC='INSTRUMENTTYPE'
AND EXCHANGE='NCX'
AND SEGMENT='FUTURES'




DELETE FOEXERCISEALLOCATION       
WHERE FOEXERCISEALLOCATION.FOEA_POSITION_DATE BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'
/*AND      
EXISTS (SELECT FOEA_PARTY_CODE FROM FOEXERCISEALLOCATION_TEMP WHERE      
 FOEXERCISEALLOCATION_TEMP.FOEA_PARTY_CODE = FOEXERCISEALLOCATION.FOEA_PARTY_CODE AND        
 FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE = FOEXERCISEALLOCATION.FOEA_INST_TYPE AND        
 FOEXERCISEALLOCATION_TEMP.FOEA_SYMBOL = FOEXERCISEALLOCATION.FOEA_SYMBOL AND        
 FOEXERCISEALLOCATION_TEMP.FOEA_EXPIRYDATE = FOEXERCISEALLOCATION.FOEA_EXPIRYDATE AND        
 FOEXERCISEALLOCATION_TEMP.FOEA_STRIKE_PRICE = FOEXERCISEALLOCATION.FOEA_STRIKE_PRICE AND        
 FOEXERCISEALLOCATION_TEMP.FOEA_OPTION_TYPE = FOEXERCISEALLOCATION.FOEA_OPTION_TYPE)      
 */

DELETE FOCLOSING FROM FOEXERCISEALLOCATION_TEMP       
WHERE FOCLOSING.TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'       
/*AND LEFT(FOEA_POSITION_DATE, 11) = LEFT(TRADE_DATE, 11)      
AND FOEA_INST_TYPE = INST_TYPE      
AND FOEA_SYMBOL = SYMBOL      
AND LEFT(FOEA_EXPIRYDATE,11) = LEFT(EXPIRYDATE,11)      
AND CASE WHEN LEFT(FOEA_INST_TYPE,3) ='FUT' THEN '' ELSE FOEA_OPTION_TYPE END = OPTION_TYPE      
AND CASE WHEN LEFT(FOEA_INST_TYPE,3) ='FUT' THEN 0 ELSE FOEA_STRIKE_PRICE END = STRIKE_PRICE       
*/
      
DELETE FOCLOSING_BILLREPORT FROM FOEXERCISEALLOCATION_TEMP       
WHERE FOCLOSING_BILLREPORT.TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59'       
AND LEFT(FOEA_POSITION_DATE, 11) = LEFT(TRADE_DATE, 11)      
AND FOEA_INST_TYPE = INST_TYPE      
AND FOEA_SYMBOL = SYMBOL      
AND LEFT(FOEA_EXPIRYDATE,11) = LEFT(EXPIRYDATE,11)      
AND LEFT(FOEA_INST_TYPE,3) ='FUT'       

/*      
DELETE FOCLOSING        
WHERE FOCLOSING.TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND       
LEFT(INST_TYPE,3) ='FUT'      
      
DELETE FOCLOSING_BILLREPORT       
WHERE TRADE_DATE  BETWEEN @TRADEDATE AND @TRADEDATE + ' 23:59' AND       
LEFT(INST_TYPE,3) ='FUT'      
*/      

INSERT INTO FOCLOSING        
SELECT DISTINCT       
 CL_RATE= FOEA_SETTLEMENTPRICE,      
 EXPIRYDATE = FOEA_EXPIRYDATE,      
 TRADE_DATE = @TRADEDATE + ' 23:59',      
 INST_TYPE = FOEA_INST_TYPE,      
 SYMBOL= FOEA_SYMBOL,      
 STRIKE_PRICE = FOEA_STRIKE_PRICE,      
 COR_ACT_LEVEL ='0',      
 MARKETTYPE ='0',      
 OPTION_TYPE = FOEA_OPTION_TYPE      
FROM FOEXERCISEALLOCATION_TEMP        
WHERE LEFT(FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE,3) ='FUT'      
      
INSERT INTO FOCLOSING_BILLREPORT        
SELECT DISTINCT       
 CL_RATE= FOEA_SETTLEMENTPRICE,      
 EXPIRYDATE = FOEA_EXPIRYDATE,      
 TRADE_DATE = @TRADEDATE + ' 23:59',      
 INST_TYPE = FOEA_INST_TYPE,      
 SYMBOL= FOEA_SYMBOL,      
 STRIKE_PRICE = FOEA_STRIKE_PRICE,      
 COR_ACT_LEVEL ='0',      
 MARKETTYPE ='0',      
 OPTION_TYPE = FOEA_OPTION_TYPE      
FROM FOEXERCISEALLOCATION_TEMP        
WHERE LEFT(FOEXERCISEALLOCATION_TEMP.FOEA_INST_TYPE,3) ='FUT'      
        
      
UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_PARTY_CODE = NEWPARTY_CODE      
FROM PARTYMAPPING      
WHERE OLDPARTY_CODE = FOEXERCISEALLOCATION_TEMP.FOEA_PARTY_CODE      
 
 

 
INSERT INTO FOEXERCISEALLOCATION 
SELECT 
FOEA_TABLE_NO='0',
FOEA_POSITION_DATE,
FOEA_DESC='POSITION FILE',
FOEA_SEGMENT_IND,
FOEA_SETT_TYPE,
FOEA_CM_CODE,
FOEA_MEM_TYPE,
FOEA_TM_CODE,
FOEA_ACC_TYPE,
FOEA_PARTY_CODE,
FOEA_INST_TYPE,
FOEA_SYMBOL,
FOEA_EXPIRYDATE,
FOEA_STRIKE_PRICE,
FOEA_OPTION_TYPE,
FOEA_COR_ACT_LEVEL,
FOEA_PREEXALL_LONGQTY,
FOEA_PREEXALL_SHORTQTY,
FOEA_EXERCISE_QTY,
FOEA_ALLOC_QTY,
FOEA_POSTEXALL_LONGQTY,
FOEA_POSTEXALL_SHORTQTY,
FOEA_BROUGHT_FORWARD_LONG_QUANTITY,
FOEA_BROUGHT_FORWARD_LONG_VALUE,
FOEA_BROUGHT_FORWARD_SHORT_QUANTITY,
FOEA_BROUGHT_FORWARD_SHORT_VALUE,
FOEA_DAY_BUY_OPEN_QUANTITY,
FOEA_DAY_BUY_OPEN_VALUE,
FOEA_DAY_SELL_OPEN_QUANTITY,
FOEA_DAY_SELL_OPEN_VALUE,
FOEA_PREEXALL_LONGVALUE,
FOEA_PREEXALL_SHORTVALUE,
FOEA_POSTEXALL_LONGVALUE,
FOEA_POSTEXALL_SHORTVALUE,
FOEA_SETTLEMENTPRICE,
FOEA_NETPREMIUM,
FOEA_DAILY_MTM_SETTLEMENT_VALUE,
FOEA_FUTURES_FINAL_SETTLEMENT_VALUE,
FOEA_EXERCISED_ASSIGNED_VALUE

FROM FOEXERCISEALLOCATION_TEMP 

/*       
SELECT FOEA_TABLE_NO='0',FOEA_POSITION_DATE,FOEA_DESC='POSITION FILE',FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,      
FOEA_TM_CODE,FOEA_ACC_TYPE,FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,      
FOEA_COR_ACT_LEVEL,FOEA_PREEXALL_LONGQTY,FOEA_PREEXALL_SHORTQTY,FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,FOEA_POSTEXALL_LONGQTY,      
FOEA_POSTEXALL_SHORTQTY,FOEA_BROUGHT_FORWARD_LONG_QUANTITY,FOEA_BROUGHT_FORWARD_LONG_VALUE,FOEA_BROUGHT_FORWARD_SHORT_QUANTITY,      
FOEA_BROUGHT_FORWARD_SHORT_VALUE,FOEA_DAY_BUY_OPEN_QUANTITY,FOEA_DAY_BUY_OPEN_VALUE,FOEA_DAY_SELL_OPEN_QUANTITY,FOEA_DAY_SELL_OPEN_VALUE,      
FOEA_PREEXALL_LONGVALUE,FOEA_PREEXALL_SHORTVALUE,FOEA_POSTEXALL_LONGVALUE,FOEA_POSTEXALL_SHORTVALUE,FOEA_SETTLEMENTPRICE,FOEA_NETPREMIUM,      
FOEA_DAILY_MTM_SETTLEMENT_VALUE,FOEA_FUTURES_FINAL_SETTLEMENT_VALUE,FOEA_EXERCISED_ASSIGNED_VALUE,FOEA_BUY_DEL_ALLOCATED_QTY,      
FOEA_SELL_DEL_ALLOCATED_QTY,FOEA_POST_ALLOC_LONG_QTY,FOEA_POST_ALLOC_SHORT_QTY,FOEA_FINAL_SETT_PRICE, 
FOEA_RESERVED1, FOEA_RESERVED2, FOEA_RESERVED3, FOEA_OPT_DELV_LONG_QTY, FOEA_OPT_DELV_LONG_VALUE, 
FOEA_OPT_DELV_SHORT_QTY, FOEA_OPT_DELV_SHORT_VALUE 


     
FROM FOEXERCISEALLOCATION_TEMP  
*/
      
EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'POSIMP','','AUTO_PROCESS',''      
      
/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_STT_MAPPING
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_STT_MAPPING] (@TRADE_DATE VARCHAR(11)) AS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_STT_STT01_UP
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_STT_STT01_UP]   
(
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11),
	@PROGID VARCHAR(50) = ''
)  
AS  
/*
	PROC TO IMPORT F&O STT FILE
*/

CREATE TABLE #STT_EXCH
(
	FILE_DATA	VARCHAR(MAX)
)

DECLARE @STRSQL VARCHAR(MAX)

SET @STRSQL = 'BULK INSERT #STT_EXCH FROM ''' + @FILENAME  + ''' WITH ( ROWTERMINATOR = ''\n'' )'      

EXEC(@STRSQL) 


CREATE TABLE #STT
(
	RECTYPE		VARCHAR(2),
	STT_DATE	VARCHAR(20),
	TM_CODE		VARCHAR(20),
	PARTY_CODE	VARCHAR(20),
	INST_TYPE	VARCHAR(6),
	SYMBOL		VARCHAR(12),
	EXPIRYDATE	VARCHAR(20),
	STRIKE_PRICE	VARCHAR(20),
	OPTION_TYPE		VARCHAR(2),
	SQTY	VARCHAR(20),
	SAMT	VARCHAR(20),
	TSAMT_FUT	VARCHAR(20),
	TSAMT_OPT	VARCHAR(20),
	STT_FUT	VARCHAR(20),
	STT_OPT	VARCHAR(20)
)
	
INSERT INTO #STT
SELECT
	RECTYPE = DBO.PIECE(FILE_DATA,',',1),
	STT_DATE = DBO.PIECE(FILE_DATA,',',2),
	TM_CODE = DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = DBO.PIECE(FILE_DATA,',',4),
	INST_TYPE = '',
	SYMBOL = '',
	EXPIRYDATE = '',
	STRIKE_PRICE = '',
	OPTION_TYPE = '',
	SQTY = 0,
	SAMT = 0,
	TSAMT_FUT = 0,
	TSAMT_OPT = 0,
	STT_FUT =  DBO.PIECE(FILE_DATA,',',5),
	STT_OPT = 0
FROM #STT_EXCH
WHERE
	DBO.PIECE(FILE_DATA,',',1) = 20


INSERT INTO #STT
SELECT
	RECTYPE = DBO.PIECE(FILE_DATA,',',1),
	STT_DATE = DBO.PIECE(FILE_DATA,',',2),
	TM_CODE = DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = DBO.PIECE(FILE_DATA,',',4),
	INST_TYPE = DBO.PIECE(FILE_DATA,',',5),
	SYMBOL = DBO.PIECE(FILE_DATA,',',6),
	EXPIRYDATE = DBO.PIECE(FILE_DATA,',',7),
	STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',8),
	OPTION_TYPE = DBO.PIECE(FILE_DATA,',',9),
	SQTY = DBO.PIECE(FILE_DATA,',',10),
	SAMT = DBO.PIECE(FILE_DATA,',',11),
	TSAMT_FUT = DBO.PIECE(FILE_DATA,',',12),
	TSAMT_OPT = DBO.PIECE(FILE_DATA,',',13),
	STT_FUT = DBO.PIECE(FILE_DATA,',',14),
	STT_OPT = DBO.PIECE(FILE_DATA,',',15)
FROM #STT_EXCH WHERE DBO.PIECE(FILE_DATA,',',1) IN ('40','30')			

UPDATE #STT SET PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING
WHERE OLDPARTY_CODE = #STT.PARTY_CODE

UPDATE #STT SET STRIKE_PRICE = '0' WHERE ISNULL(STRIKE_PRICE,'') = ''

DELETE STT_EXCHG WHERE STT_DATE = @TRADEDATE
	
INSERT INTO STT_EXCHG
SELECT 
	RECTYPE,
	STT_DATE,
	TM_CODE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	CONVERT(MONEY,ISNULL(STRIKE_PRICE,'0')),
	OPTION_TYPE,
	CA_LEVEL=0,
	CONVERT(MONEY,ISNULL(SQTY,'0')),
	CONVERT(MONEY,ISNULL(SAMT,'0')),
	CONVERT(MONEY,ISNULL(TSAMT_FUT,'0')),
	CONVERT(MONEY,ISNULL(TSAMT_OPT,'0')),
	CONVERT(MONEY,ISNULL(STT_FUT,'0')),
	CONVERT(MONEY,ISNULL(STT_OPT,'0')),
	TOTALSTT = 0
FROM #STT

UPDATE STT_EXCHG SET TOTALSTT = STT_FUT+STT_OPT
WHERE STT_DATE = @TRADEDATE

DROP TABLE #STT
DROP TABLE #STT_EXCH
 
EXEC V2_PROCESS_STATUS_LOG_UPD @TRADEDATE,'CHKSTTIMP','','AUTO_PROCESS',''

/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_Trade_Transfer_ISetl
-- --------------------------------------------------


CREATE   Proc Proc_Trade_Transfer_ISetl 
(            
	@Sauda_Date      Varchar(11),            
	@PartyFrom       Varchar(10),             
	@PartyTo         Varchar(10),            
	@Inst_Type       Varchar(6) ,            
	@Symbol          Varchar(12),            
	@Expiry_Date     Varchar(11),            
	@Strike_Price    Money      ,            
	@Option_Type     Varchar(2) ,             
	@Sell_Buy       Int        ,            
	@ParticipantCode Varchar(15),             
	@ContractNo      Varchar(7) ,             
	@Order_No    Varchar(16),            
	@Trade_No        Varchar(14),            
	@ActualQty       Int        ,            
	@QtyToTransfer   Int,        
	@StatusId	 Varchar(50) ='',
	@strModule       Varchar(50) =''
) As            
            
Declare             
@TradeCursor     Cursor     ,            
@ContractNoCur   Cursor     ,            
@QtyInTrade      Int        ,            
@New_Trade_No    Varchar(14),            
@New_ContractNo  Varchar(7) ,            
@BillNo   int        ,            
@Style           Int    ,            
@ClType      Varchar(3) ,            
@ContStyle       Char(1)            
            
Select @New_ContractNo = 0             
/*          
Set @ContractNoCur = Cursor For            
Select ContractNo From FoSettlement             
Where Sauda_Date Like @Sauda_Date + '%'            
And Party_Code = @PartyTo And Reserved1 = 0             
Open @ContractNoCur            
Fetch Next From @ContractNoCur into @New_ContractNo            
Close @ContractNoCur            
DeAllocate @ContractNoCur            
*/          
          
--If @@Fetch_Status <> 0             
--Begin  
if @strModule <> ''
begin          
	Exec Console_Log  @PartyFrom,@PartyTo,@Sauda_Date,@Inst_Type,@Symbol,@Expiry_Date,@Strike_Price,@Option_Type,
	@Order_No,@Trade_No,@Sell_Buy,@ContractNo,'',0,0,0,0,0,0,@ActualQty,@QtyToTransfer,0,@ParticipantCode,'',@StatusId,@strModule,'PROC_TRADE_TRANSFER_ISETL'
end

 Set @New_ContractNo = 0            
  Select @ClType = Cl_Type,@ContStyle=C2.InsCont From Client1 C1, Client2 C2 Where C1.Cl_Code = C2.Cl_Code and C2.Party_Code = @PartyTo            
  if @ClType <> 'PRO'             
  Begin                  
     If @PartyFrom <> @PartyTo And @ContStyle = 'S'            
      Begin            
          Select Top 1 @New_ContractNo=isnull(Contractno,0) From FoSettlement 
			Where Sauda_Date like @Sauda_Date  + '%' 
			And Party_Code = @PartyTo              
			/*And Dummy1 = 0*/ 
			And inst_type = @Inst_Type
			And Symbol = @Symbol      
			And ExpiryDate Like  @Expiry_Date +'%'
			And Strike_Price = @Strike_Price
			And Option_Type =@Option_Type  			    
			And Reserved1 = 1 
			And TradeQty <> 0  
			And ContractNo <> 0 
      End            
      If @PartyFrom <> @PartyTo And @ContStyle = 'N'            
        Begin            
            Select Top 1 @New_ContractNo=isnull(Contractno,0) From FoSettlement Where Party_Code = @PartyTo              
             /*And Dummy1 = 0*/ And Reserved1 = 1 And TradeQty <> 0  And ContractNo <> 0            
      			 And Sauda_Date like @Sauda_Date  + '%'  
        End            
  if Len(@New_ContractNo) = 1      
   Begin           
          Select @New_ContractNo = Convert(Int,Contractno) + 1  From ContGen             
                       Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date            
                   
          Update ContGen Set Contractno = @New_ContractNo             
                       Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date            
                   
          Select @New_ContractNo = STUFF('0000000', 8 - Len(@New_ContractNo), Len(@New_ContractNo), @New_ContractNo)                   
   End      
 End        
--End            
            
Select @BillNo = 0             
            
If @ActualQty = @QtyToTransfer             
Begin            
 Insert Into FoSettlement             
 Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,            
        Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,Series,Order_no,Price,            
        Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,            
        Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,            
        Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,            
        BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2            
 From FoSettlement             
 Where Sauda_Date Like @Sauda_Date + '%'            
        And Party_Code = @PartyFrom            
        And Inst_Type = @Inst_Type            
        And Symbol = @Symbol            
        And ExpiryDate Like @Expiry_Date + '%'            
        And Strike_Price = @Strike_Price            
        And Option_Type = @Option_Type            
 And Reserved1 = 1             
        And Sell_Buy = @Sell_Buy            
        And ParticipantCode = @ParticipantCode            
        And ContractNo = @ContractNo          
        And Order_No Like @Order_No            
        And Trade_No Like @Trade_No            
            
            
 Update FoSettlement Set TradeQty = 0, Price = 0, NetRate = 0, Brokapplied = 0,             
 NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,            
 Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0             
 Where Sauda_Date Like @Sauda_Date + '%'            
        And Party_Code = @PartyFrom            
        And Inst_Type = @Inst_Type            
        And Symbol = @Symbol            
        And ExpiryDate Like @Expiry_Date + '%'            
        And Strike_Price = @Strike_Price            
        And Option_Type = @Option_Type            
 And Reserved1 = 1             
        And Sell_Buy = @Sell_Buy            
        And ParticipantCode = @ParticipantCode            
        And ContractNo = @ContractNo            
        And Order_No Like @Order_No            
        And Trade_No Like @Trade_No            
            
End            
Else            
Begin            
    Set @TradeCursor = Cursor For            
        Select TradeQty, Trade_No From FoSettlement            
        Where Sauda_Date Like @Sauda_Date + '%'            
        And Party_Code = @PartyFrom            
        And Inst_Type = @Inst_Type            
        And Symbol = @Symbol            
        And ExpiryDate Like @Expiry_Date + '%'            
        And Strike_Price = @Strike_Price            
        And Option_Type = @Option_Type            
 And Reserved1 = 1             
        And Sell_Buy = @Sell_Buy            
        And ParticipantCode = @ParticipantCode            
        And ContractNo = @ContractNo            
        And Order_No Like @Order_No            
        And Trade_No Like @Trade_No            
 Order By TradeQty Desc             
            
        Open @TradeCursor             
        Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No            
 While @@Fetch_Status = 0 And @QtyToTransfer > 0             
 Begin            
  If @QtyToTransfer >= @QtyInTrade            
  Begin            
   Insert Into FoSettlement             
   Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,            
          Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,Series,Order_no,Price,            
          Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,            
          Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,            
          Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,            
          BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2            
   From FoSettlement             
   Where Sauda_Date Like @Sauda_Date + '%'            
          And Party_Code = @PartyFrom            
          And Inst_Type = @Inst_Type            
          And Symbol = @Symbol            
          And ExpiryDate Like @Expiry_Date + '%'            
          And Strike_Price = @Strike_Price            
          And Option_Type = @Option_Type            
   And Reserved1 = 1             
          And Sell_Buy = @Sell_Buy            
          And ParticipantCode = @ParticipantCode            
          And ContractNo = @ContractNo            
          And Order_No Like @Order_No            
          And Trade_No Like @New_Trade_No            
   And TradeQty = @QtyInTrade            
            
   Update FoSettlement Set TradeQty = 0, Price = 0, NetRate = 0, Brokapplied = 0,             
   NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,            
   Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0             
   Where Sauda_Date Like @Sauda_Date + '%'            
          And Party_Code = @PartyFrom            
          And Inst_Type = @Inst_Type            
          And Symbol = @Symbol            
          And ExpiryDate Like @Expiry_Date + '%'        
          And Strike_Price = @Strike_Price            
          And Option_Type = @Option_Type            
   And Reserved1 = 1             
          And Sell_Buy = @Sell_Buy            
          And ParticipantCode = @ParticipantCode            
          And ContractNo = @ContractNo            
          And Order_No Like @Order_No            
          And Trade_No Like @New_Trade_No            
   And TradeQty = @QtyInTrade            
            
   Select @QtyToTransfer = @QtyToTransfer - @QtyInTrade            
  End            
  Else            
  Begin            
   Insert Into FoSettlement             
   Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,            
          Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@QtyToTransfer,AuctionPart,MarketType,Series,Order_no,Price,            
          Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,            
          Brokapplied,NetRate,@QtyToTransfer*Price,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,            
          Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,            
          BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2            
   From FoSettlement             
   Where Sauda_Date Like @Sauda_Date + '%'            
          And Party_Code = @PartyFrom            
          And Inst_Type = @Inst_Type            
          And Symbol = @Symbol            
          And ExpiryDate Like @Expiry_Date + '%'            
          And Strike_Price = @Strike_Price            
          And Option_Type = @Option_Type            
   And Reserved1 = 1             
   And Sell_Buy = @Sell_Buy            
          And ParticipantCode = @ParticipantCode            
          And ContractNo = @ContractNo            
          And Order_No Like @Order_No            
          And Trade_No Like @New_Trade_No            
   And TradeQty = @QtyInTrade            
            
   Update FoSettlement Set TradeQty = TradeQty - @QtyToTransfer, Amount = (TradeQty - @QtyToTransfer)*Price            
   Where Sauda_Date Like @Sauda_Date + '%'            
          And Party_Code = @PartyFrom            
          And Inst_Type = @Inst_Type            
          And Symbol = @Symbol            
          And ExpiryDate Like @Expiry_Date + '%'            
          And Strike_Price = @Strike_Price            
          And Option_Type = @Option_Type            
   And Reserved1 = 1             
          And Sell_Buy = @Sell_Buy            
          And ParticipantCode = @ParticipantCode            
          And ContractNo = @ContractNo            
          And Order_No Like @Order_No            
          And Trade_No Like @New_Trade_No            
            
   Select @QtyToTransfer = 0            
  End            
         Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No             
 End            
 Close @TradeCursor            
 DeAllocate @TradeCursor            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_RECAL
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[PROC_TRADE_TRANSFER_RECAL]    
(  
 @SAUDA_DATE VARCHAR(11),      
 @PARTY_CODE VARCHAR(10),      
 @INST_TYPE  VARCHAR(6) ,      
 @SYMBOL VARCHAR(12),      
 @EXPIRY_DATE VARCHAR(11),      
 @STRIKE_PRICE    MONEY ,      
 @OPTION_TYPE VARCHAR(2),  
 @STATUSID  VARCHAR(50),  
 @STRMODULE       VARCHAR(50)  
)  
    
AS      
    
IF @SYMBOL='' OR @SYMBOL = '%'      
BEGIN      
 SET @EXPIRY_DATE  = '%'      
END      
    
        SELECT PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,      
        PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),      
        SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),      
  
        PRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
      THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END)   
   /SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
      ELSE 0  
        END),  
        SRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
      THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END)   
   /SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
      ELSE 0  
        END),  
  
        OPTION_TYPE,STRIKE_PRICE,AUCTIONPART    
        INTO #FOSETTLEMENT1  
        FROM FOSETTLEMENT F    
        WHERE F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'      
        AND F.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN F.PARTY_CODE ELSE @PARTY_CODE END      
        AND F.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN F.INST_TYPE ELSE @INST_TYPE END        
        AND F.SYMBOL = CASE WHEN @SYMBOL ='%' THEN F.SYMBOL ELSE @SYMBOL END         
        AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%'      
        AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)      
        AND F.OPTION_TYPE LIKE @OPTION_TYPE    
        GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),OPTION_TYPE,STRIKE_PRICE,AUCTIONPART    
  
        SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,  
        USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,  
        NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,  
        SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,      
         MPRICE = (CASE WHEN C2.DUMMY1 = 0  
                         THEN PRICE  
                         ELSE      
                           (CASE WHEN C2.DUMMY1 = 1  
                                 THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                                  ELSE F.STRIKE_PRICE + PRICE   
                                  END)      
                         END) ,  
           MULTIPLIER = 1,     
           TAXPRICE = (CASE WHEN TAXESFLAG = 0  
                         THEN PRICE  
                         ELSE      
                           (CASE WHEN TAXESFLAG = 1  
                                 THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                                 ELSE F.STRIKE_PRICE + PRICE   
                                 END)      
                         END  
                           ) ,  
           F.RESERVED1,F.DUMMY1,STATUS      
           INTO #FOSETTLEMENT2  
           FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER      
           WHERE C2.PARTY_CODE = F.PARTY_CODE  
           AND F.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'      
           AND F.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN F.PARTY_CODE ELSE @PARTY_CODE END       
           AND F.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN F.INST_TYPE ELSE @INST_TYPE END           
           AND F.SYMBOL = CASE WHEN @SYMBOL ='%' THEN F.SYMBOL ELSE @SYMBOL END         
           AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%'      
  AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)      
           AND F.OPTION_TYPE LIKE @OPTION_TYPE   
    AND F.TRADEQTY <> 0  
  
    
UPDATE FOSETTLEMENT SET  
 TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,      
 VAL_PERC = BROKTABLE.VAL_PERC, NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,      
 SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,  
 BROKAPPLIED =    
        (((CASE WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
        THEN ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ))/POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
        THEN ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ))/POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
        THEN ((FLOOR((((BROKTABLE.NORMAL*F.MULTIPLIER * F.MPRICE) /100 )  * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
        THEN  
         ((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER * F.MPRICE) /100 )* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )  
        THEN  
         ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )  
        THEN  
         ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         ((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )      
        THEN     
         ((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER* F.MPRICE) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
      THEN  
         ((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         ((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         ((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  
         POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )   
                                    THEN   
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                              WHEN (FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )   
                                     THEN   
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH * (F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                             
        WHEN (FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )  
                                     THEN   
          ((FLOOR(( F.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                          WHEN (FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )  
                                     THEN   
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_SALES* (F.MPRICE)) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                        WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )  
                                     THEN   
          ((FLOOR((F.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                                 WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )  
                                THEN   
        ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH * (F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                     WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )  
           THEN   
          ((FLOOR((F.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
                                 WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )  
                                     THEN   
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_SALES * (F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))  
        ELSE  0  
        END  
            ))),   
 NETRATE =  
            (((  CASE  
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+      
         FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)  
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG +      
         FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
        THEN  
         (FOSETTLEMENT.PRICE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER * F.MPRICE)) /100 )* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /     
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
        THEN  
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER * F.MPRICE)) /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
         FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )  
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG +      
         FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )  
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER* F.MPRICE))/100)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /     
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +   FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
         FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER * F.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +    
          FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER* F.MPRICE)) /100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +     
         FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
  
        WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE))/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
  
        WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
  
        WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
  
        WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='V' )      
        THEN  
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
        WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='P' )      
        THEN  
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))      
  
        ELSE  0  
        END  
            ) )),  
 AMOUNT =  
         (((  CASE  
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)      
          THEN  
           FOSETTLEMENT.TRADEQTY  *  ( (FOSETTLEMENT.PRICE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+    
           FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /(FOCLIENTTAXES.ROFIG +  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)      
          THEN  
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)      
          THEN  
           FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)      
          THEN  
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )  
          THEN  
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE)+ ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )  
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
           FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+  
           FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )      
          WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
  
          WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )      
          WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )      
          WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )      
          WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='V' )      
          THEN  
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )      
          WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='P' )      
          THEN  
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))      
          ELSE  0  
          END  
         )* BOOKTYPE ) / INSTRUMENT),      
    
 INS_CHRG  = ((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_INSURANCE_CHRG ELSE OPT_INSURANCE_CHRG END  
  * (F.TAXPRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
            (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /POWER(10,FOCLIENTTAXES.ROUND_TO)),      
    
 TURN_TAX  =  ((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END   
  * (F.TAXPRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
            (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO)),      
    
 OTHER_CHRG = ((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  
   * (F.TAXPRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
            (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO)),      
    
 SEBI_TAX =((FLOOR(( ((CASE WHEN LEFT(FOSETTLEMENT.INST_TYPE,3) ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  
  *(F.TAXPRICE) * FOSETTLEMENT.TRADEQTY * BOOKTYPE / INSTRUMENT)/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
            (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO)),      
    
 BROKER_CHRG =  0,      
   
SERVICE_TAX =     
        CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE    
        (CASE   
         WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V')      
         THEN  
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN (FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P')      
         THEN  
          ((FLOOR((  
          (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER * F.MPRICE) /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))      
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )  
         THEN   
          ((FLOOR((  
          (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )  
         THEN  
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER *  F.MPRICE)/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
          FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
         THEN  
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )      
     THEN  
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER *  F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /     
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )      
         THEN  
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER *  F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )      
         THEN    
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
  
  
         WHEN ( FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )      
         THEN    
          ((FLOOR((  
    (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )      
         THEN    
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )      
         THEN    
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )      
         THEN    
          ((FLOOR((  
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
         WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )      
         THEN   
          ((FLOOR((  
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER * F.MPRICE) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /      
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))     
  
         ELSE  0  
         END  
        ) END,  
TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE      
    
FROM     
 BROKTABLE,    
 FOSETTLEMENT,    
 FOTAXES,    
 CLIENT1,    
 CLIENT2,    
 FOGLOBALS,    
 FOCLIENTTAXES,  
 FOCLIENTBROKSCHEME,    
 #FOSETTLEMENT1 S,   
 #FOSETTLEMENT2 F   
WHERE    
 FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND   
 FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND  
 FOSETTLEMENT.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND   
 FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND  
  
  FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE  AND     
  CLIENT1.CL_CODE=CLIENT2.CL_CODE AND     
  FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND      
  FOSETTLEMENT.INST_TYPE=S.INST_TYPE AND   
  FOSETTLEMENT.SYMBOL=S.SYMBOL AND      
  FOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND      
  FOSETTLEMENT.STRIKE_PRICE = S.STRIKE_PRICE AND  
  FOSETTLEMENT.OPTION_TYPE = S.OPTION_TYPE AND    
  FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND      
  FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND   
  FOSETTLEMENT.SYMBOL=F.SYMBOL AND      
  FOSETTLEMENT.AUCTIONPART = S.AUCTIONPART AND      
  FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND      
  FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND  
  FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND     
  FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND    
  FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND      
  FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND  
  FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND      
  FOSETTLEMENT.SELL_BUY = F.SELL_BUY AND   
  FOSETTLEMENT.TRADEQTY = F.TRADEQTY AND      
  BROKTABLE.TABLE_NO = (   
     CASE   
         WHEN LEFT(F.INST_TYPE,3) = 'FUT'   
         THEN FUT_BROKTABLE   
         ELSE OPT_BROKTABLE   
     END   
     )   
     AND BROKTABLE.LINE_NO = (   
     CASE   
         WHEN FOCLIENTBROKSCHEME.BROK_SCHEME IN (1,5,21,25)   
         THEN   
         (   
         SELECT   
             MIN(BROKTABLE.LINE_NO)   
         FROM BROKTABLE   
         WHERE BROKTABLE.TABLE_NO =(   
             CASE   
                 WHEN LEFT(F.INST_TYPE,3) = 'FUT'   
                 THEN FUT_BROKTABLE   
                 ELSE OPT_BROKTABLE   
             END   
             )   
             AND TRD_DEL = (   
             CASE   
                 WHEN ((S.PQTY >= S.SQTY)   
                 AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5))   
                 THEN (   
                 CASE   
                     WHEN ( FOSETTLEMENT.SELL_BUY = 1 )   
                     THEN 'F'   
          ELSE 'S'   
                 END   
                 )   
                 WHEN FOSETTLEMENT.SETTFLAG IN(6,7)   
                 THEN 'S'   
                 WHEN FOSETTLEMENT.SETTFLAG IN(8,9)   
                 THEN 'F'   
                 WHEN ((S.PQTY < S.SQTY)   
                 AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5))   
                 THEN (   
                 CASE   
                     WHEN ( FOSETTLEMENT.SELL_BUY = 2 )   
                     THEN 'F'   
           ELSE 'S'   
                 END   
                 )   
                 WHEN FOSETTLEMENT.SETTFLAG IN(6,7)   
                 THEN 'S'   
                 WHEN FOSETTLEMENT.SETTFLAG IN(8,9)   
                 THEN 'F'   
                 WHEN FOSETTLEMENT.SETTFLAG = 0   
                 THEN 'F'   
             END   
             )   
             AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE   
             AND F.MPRICE <= BROKTABLE.UPPER_LIM   
         )   
         WHEN FOCLIENTBROKSCHEME.BROK_SCHEME IN (3,6,23,26)   
         THEN   
         (   
         SELECT   
             MIN(BROKTABLE.LINE_NO)   
         FROM BROKTABLE   
         WHERE BROKTABLE.TABLE_NO = (   
             CASE   
                 WHEN LEFT(F.INST_TYPE,3) = 'FUT'   
                 THEN FUT_BROKTABLE   
                 ELSE OPT_BROKTABLE   
             END   
             )   
             AND TRD_DEL = (   
             CASE   
                 WHEN ((S.PQTY > S.SQTY)   
                 AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5))   
                 THEN (   
                 CASE   
                     WHEN ( FOSETTLEMENT.SELL_BUY = 1 )   
                     THEN 'F'   
                     ELSE 'S'   
                 END   
                 )   
                 WHEN FOSETTLEMENT.SETTFLAG IN(6,7)   
                 THEN 'S'   
                 WHEN FOSETTLEMENT.SETTFLAG IN(8,9)   
                 THEN 'F'   
                 WHEN ((S.PQTY <= S.SQTY)   
                 AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5))   
                 THEN (   
                 CASE   
                     WHEN ( FOSETTLEMENT.SELL_BUY = 2 )   
                     THEN 'F'   
                     ELSE 'S'   
                 END   
                 )   
                 WHEN FOSETTLEMENT.SETTFLAG IN(6,7)   
                 THEN 'S'   
                 WHEN FOSETTLEMENT.SETTFLAG IN(8,9)   
                 THEN 'F'   
                 WHEN FOSETTLEMENT.SETTFLAG = 0   
                 THEN 'F'   
             END   
             )   
             AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE   
             AND F.MPRICE <= BROKTABLE.UPPER_LIM   
         )   
         WHEN FOCLIENTBROKSCHEME.BROK_SCHEME =2  
   THEN  
         (   
         SELECT   
             MIN(BROKTABLE.LINE_NO)   
         FROM BROKTABLE   
         WHERE BROKTABLE.TABLE_NO = (   
             CASE   
                 WHEN LEFT(F.INST_TYPE,3) = 'FUT'   
                 THEN FUT_BROKTABLE   
                 ELSE OPT_BROKTABLE   
             END   
             )   
             AND TRD_DEL = (   
       CASE   WHEN S.PQTY = S.SQTY THEN (CASE   
                                                       WHEN S.PRATE > = S.SRATE THEN (CASE   
                                                                                        WHEN FOSETTLEMENT.SELL_BUY = 1 THEN 'F'  
                                                                                        ELSE 'S'  
                       END)  
                                            ELSE (CASE   
                                                               WHEN (FOSETTLEMENT.SELL_BUY = 2) THEN 'F'  
                                                               ELSE 'S'  
                                                             END)  
                                                     END)  
                          ELSE (CASE   
                                  WHEN S.PQTY > = S.SQTY THEN (CASE   
                                                                 WHEN (FOSETTLEMENT.SELL_BUY = 1) THEN 'F'  
      ELSE 'S'  
                                                               END)  
                                  ELSE (CASE   
                                          WHEN (FOSETTLEMENT.SELL_BUY = 2) THEN 'F'  
                                          ELSE 'S'  
                                        END)  
                                END)  
                        END  
             )   
             AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE   
             AND F.MPRICE <= BROKTABLE.UPPER_LIM   
         )   
         ELSE   
         (   
         SELECT   
             MIN(LINE_NO)   
         FROM BROKTABLE   
         WHERE F.MPRICE <= BROKTABLE.UPPER_LIM   
             AND BROKTABLE.TABLE_NO = (   
             CASE   
                 WHEN LEFT(F.INST_TYPE,3) = 'FUT'   
                 THEN FUT_BROKTABLE   
                 ELSE OPT_BROKTABLE   
             END   
             )   
         )   
     END   
     )  AND    
 --FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE CLIENT2.TRAN_CAT END )  AND      
 FOTAXES.EXCHANGE = 'NCE' AND    
 FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'  AND    
 FOSETTLEMENT.STATUS <>  'E'  AND    
 FOSETTLEMENT.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN FOSETTLEMENT.PARTY_CODE ELSE @PARTY_CODE END   AND    
 FOSETTLEMENT.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN FOSETTLEMENT.INST_TYPE ELSE @INST_TYPE END    AND     
 FOSETTLEMENT.SYMBOL = CASE WHEN @SYMBOL ='%' THEN FOSETTLEMENT.SYMBOL ELSE @SYMBOL END AND      
 FOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%'  AND     
 FOSETTLEMENT.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN FOSETTLEMENT.STRIKE_PRICE ELSE @STRIKE_PRICE END)  AND     
 FOSETTLEMENT.OPTION_TYPE LIKE @OPTION_TYPE  AND    
 FOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND     
 FOSETTLEMENT.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE     
 AND FOSETTLEMENT.TRADEQTY <> 0  
     
EXEC RECALCULATESTAMPDUTY @SAUDA_DATE, @PARTY_CODE    
  
  
  
IF @@ERROR = 0    
BEGIN  
 EXEC CONSOLE_LOG  @PARTY_CODE,'',@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,  
 '','',0,'','',0,0,0,0,0,0,0,0,0,'','',@STATUSID,@STRMODULE,'RECAL BROK'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_Trade_Transfer_Setl
-- --------------------------------------------------
CREATE  Proc Proc_Trade_Transfer_Setl 
(  
	@Sauda_Date      Varchar(11),  
	@PartyFrom       Varchar(10),   
	@PartyTo         Varchar(10),  
	@Inst_Type       Varchar(6) ,  
	@Symbol          Varchar(12),  
	@Expiry_Date     Varchar(11),  
	@Strike_Price    Money      ,  
	@Option_Type     Varchar(2) ,   
	@Sell_Buy     Int        ,  
	@ParticipantCode Varchar(15),   
	@ContractNo      Varchar(7) ,   
	@Order_No  Varchar(16),  
	@Trade_No        Varchar(14),  
	@ActualQty       Int        ,  
	@QtyToTransfer   Int        ,
	@StatusId	 Varchar(50) ='',
	@strModule       Varchar(50) ='',
	@UserId 	Varchar(15) =''
) As  
  
Declare   
@TradeCursor     Cursor     ,  
@ContractNoCur   Cursor     ,  
@QtyInTrade      Int        ,  
@New_Trade_No    Varchar(14),  
@New_ContractNo  Varchar(7) ,  
@BillNo       int        ,  
@Style           Int    ,  
@ClType      Varchar(3)  
  
Select @New_ContractNo = 0   
Set @ContractNoCur = Cursor For  
Select ContractNo From FoSettlement   
Where Sauda_Date Like @Sauda_Date + '%'  
And Party_Code = @PartyTo And Reserved1 = 0   
Open @ContractNoCur  
Fetch Next From @ContractNoCur into @New_ContractNo  
Close @ContractNoCur  
DeAllocate @ContractNoCur  
  
if @strModule <> ''
begin
	Exec Console_Log  @PartyFrom,@PartyTo,@Sauda_Date,@Inst_Type,@Symbol,@Expiry_Date,@Strike_Price,@Option_Type,
	@Order_No,@Trade_No,@Sell_Buy,@ContractNo,'',0,0,0,0,0,0,@ActualQty,@QtyToTransfer,0,@ParticipantCode,'',@StatusId,@strModule,'PROC_TRADE_TRANSFER_SETL'
end
If @@Fetch_Status <> 0   
Begin  
 Set @New_ContractNo = 0  
  Select @ClType = Cl_Type From Client1 C1, Client2 C2 Where C1.Cl_Code = C2.Cl_Code and C2.Party_Code = @PartyTo  
 if @ClType <> 'PRO'  
  Begin  
    Select @New_ContractNo = Convert(Int,Contractno) + 1  From ContGen   
               Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date  
  
    Update ContGen Set Contractno = @New_ContractNo   
                Where @Sauda_Date + ' 00:00:00' >= Start_Date and @Sauda_Date + ' 00:00:00' <= End_Date  
  End  
 Select @New_ContractNo = STUFF('0000000', 8 - Len(@New_ContractNo), Len(@New_ContractNo), @New_ContractNo)    
End  
  
Select @BillNo = 0   
  
If @ActualQty = @QtyToTransfer   
Begin  
 Insert Into FoSettlement   
 Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,  
        Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,Series,Order_no,Price,  
        Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,  
        Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,  
        Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,  
        BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2  
 From FoSettlement   
 Where Sauda_Date Like @Sauda_Date + '%'  
        And Party_Code = @PartyFrom  
        And Inst_Type = @Inst_Type  
        And Symbol = @Symbol  
        And ExpiryDate Like @Expiry_Date + '%'  
        And Strike_Price = @Strike_Price  
        And Option_Type = @Option_Type  
 And Reserved1 = 0   
        And Sell_Buy = @Sell_Buy  
        And ParticipantCode = @ParticipantCode  
        And ContractNo = @ContractNo  
        And Order_No Like @Order_No  
        And Trade_No Like @Trade_No  
  	And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End
  
 Update FoSettlement Set TradeQty = 0, Price = 0, NetRate = 0, Brokapplied = 0,   
 NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,  
 Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0   
 Where Sauda_Date Like @Sauda_Date + '%'  
        And Party_Code = @PartyFrom  
        And Inst_Type = @Inst_Type  
        And Symbol = @Symbol  
        And ExpiryDate Like @Expiry_Date + '%'  
        And Strike_Price = @Strike_Price  
        And Option_Type = @Option_Type  
 And Reserved1 = 0   
        And Sell_Buy = @Sell_Buy  
        And ParticipantCode = @ParticipantCode  
        And ContractNo = @ContractNo  
        And Order_No Like @Order_No  
        And Trade_No Like @Trade_No  
 	 And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End
End  
Else  
Begin  
        Set @TradeCursor = Cursor For  
        Select TradeQty, Trade_No From FoSettlement  
        Where Sauda_Date Like @Sauda_Date + '%'  
        And Party_Code = @PartyFrom  
        And Inst_Type = @Inst_Type  
        And Symbol = @Symbol  
        And ExpiryDate Like @Expiry_Date + '%'  
        And Strike_Price = @Strike_Price  
        And Option_Type = @Option_Type  
 And Reserved1 = 0   
        And Sell_Buy = @Sell_Buy  
        And ParticipantCode = @ParticipantCode  
   And ContractNo = @ContractNo  
        And Order_No Like @Order_No  
        And Trade_No Like @Trade_No  
And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End
 Order By TradeQty Desc   
  
        Open @TradeCursor   
        Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No  
 While @@Fetch_Status = 0 And @QtyToTransfer > 0   
 Begin  
  If @QtyToTransfer >= @QtyInTrade  
  Begin  
   Insert Into FoSettlement   
   Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,  
          Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,Tradeqty,AuctionPart,MarketType,Series,Order_no,Price,  
          Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,  
          Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,  
          Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,  
          BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2  
   From FoSettlement   
   Where Sauda_Date Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
   And Reserved1 = 0   
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And ContractNo = @ContractNo  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
   And TradeQty = @QtyInTrade  
  And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End

   Update FoSettlement Set TradeQty = 0, Price = 0, NetRate = 0, Brokapplied = 0,   
   NBrokapp = 0, N_NetRate = 0, Service_Tax = 0, NSerTax = 0, Amount = 0, Trade_Amount = 0,  
   Ins_Chrg = 0, turn_tax = 0, other_chrg = 0, sebi_tax = 0, Broker_Chrg = 0   
   Where Sauda_Date Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
   And Reserved1 = 0   
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And ContractNo = @ContractNo  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
   And TradeQty = @QtyInTrade  
  And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End

   Select @QtyToTransfer = @QtyToTransfer - @QtyInTrade  
  End  
  Else  
  Begin  
   Insert Into FoSettlement   
   Select @New_ContractNo,BillNo,Left('R'+Trade_no,14),@PartyTo,Inst_type,Symbol,Sec_name,Expirydate,Strike_price,  
          Option_type,User_id,Pro_cli,O_C_Flag,C_U_Flag,@QtyToTransfer,AuctionPart,MarketType,Series,Order_no,Price,  
          Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,  
          Brokapplied,NetRate,@QtyToTransfer*Price,Ins_chrg,turn_tax,other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,  
          Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,Cl_Rate,ParticipantCode,Status,CpId,Instrument,  
          BookType,Branch_Id,TMark,Scheme,Dummy1,Dummy2,Reserved1,Reserved2  
   From FoSettlement   
   Where Sauda_Date Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
   And Reserved1 = 0   
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And ContractNo = @ContractNo  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
   And TradeQty = @QtyInTrade  
  And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End

   Update FoSettlement Set TradeQty = TradeQty - @QtyToTransfer, Amount = (TradeQty - @QtyToTransfer)*Price  
   Where Sauda_Date Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol   
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
   And Reserved1 = 0   
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And ContractNo = @ContractNo  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
  And User_Id Like Case When @UserId <> '' Then @UserId Else '%' End

   Select @QtyToTransfer = 0  
  End  
         Fetch Next From @TradeCursor into @QtyInTrade, @New_Trade_No   
 End  
 Close @TradeCursor  
 DeAllocate @TradeCursor  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_Trade_Transfer_Trade
-- --------------------------------------------------


CREATE Proc Proc_Trade_Transfer_Trade 
(  
	@Sauda_Date      Varchar(11),   
	@PartyFrom       Varchar(10),   
	@PartyTo         Varchar(10),  
	@Inst_Type       Varchar(6) ,  
	@Symbol          Varchar(12),  
	@Expiry_Date     Varchar(11),  
	@Strike_Price    Money      ,  
	@Option_Type     Varchar(2) ,    
	@Sell_Buy     Int        ,  
	@ParticipantCode Varchar(15),   
	@Order_No  Varchar(16),  
	@Trade_No        Varchar(14),  
	@ActualQty       Int        ,  
	@QtyToTransfer   Int        ,
	@StatusId	 Varchar(50),
	@strModule       Varchar(50)
) As  
  
Declare   
@QtyInFoTrade      Int        ,  
@New_Trade_No    Varchar(14)  
  
Exec Console_Log  @PartyFrom,@PartyTo,@Sauda_Date,@Inst_Type,@Symbol,@Expiry_Date,@Strike_Price,@Option_Type,
@Order_No,@Trade_No,@Sell_Buy,'','',0,0,0,0,0,0,@ActualQty,@QtyToTransfer,0,@ParticipantCode,'',@StatusId,@strModule,'PROC_TRADE_TRANSFER_TRADE'

If @ActualQty = @QtyToTransfer   
Begin  
 Update FoTrade Set Party_Code = @PartyTo  
 Where ActivityTime Like @Sauda_Date + '%'  
        And Party_Code = @PartyFrom  
        And Inst_Type = @Inst_Type  
        And Symbol = @Symbol  
        And ExpiryDate Like @Expiry_Date + '%'  
        And Strike_Price = @Strike_Price  
        And Option_Type = @Option_Type  
        And Sell_Buy = @Sell_Buy  
        And ParticipantCode = @ParticipantCode  
        And Order_No Like @Order_No  
        And Trade_No Like @Trade_No  
End  
Else  
Begin  
        declare @FoTradeCursor Cursor     

	Set @FoTradeCursor = Cursor For  
        Select TradeQty, Trade_No From FoTrade   
        Where ActivityTime Like @Sauda_Date + '%'  
        And Party_Code = @PartyFrom  
        And Inst_Type = @Inst_Type  
        And Symbol = @Symbol  
        And ExpiryDate Like @Expiry_Date + '%'  
        And Strike_Price = @Strike_Price  
        And Option_Type = @Option_Type  
        And Sell_Buy = @Sell_Buy  
        And ParticipantCode = @ParticipantCode  
        And Order_No Like @Order_No  
        And Trade_No Like @Trade_No  
 Order By TradeQty Desc   
        Open @FoTradeCursor   
        Fetch Next From @FoTradeCursor into @QtyInFoTrade, @New_Trade_No  
 While @@Fetch_Status = 0 And @QtyToTransfer > 0   
 Begin  
  If @QtyToTransfer >= @QtyInFoTrade  
  Begin  
   Update FoTrade Set Party_Code = @PartyTo  
   Where ActivityTime Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
  
   Select @QtyToTransfer = @QtyToTransfer - @QtyInFoTrade  
  End  
  Else  
  Begin  
   Insert Into FoTrade  
   Select 'T'+Trade_No,Status,Inst_Type,Symbol,Expirydate,Strike_price,Option_type,Sec_Name,BookType,BookTypeName,  
   MarKetType,User_Id,Branch_Id,Sell_Buy,@QtyToTransfer,Price,Pro_cli,@PartyTo,ParticipantCode,O_C_Flag,  
   C_U_Flag,ActivityTime,Last_Mod_time,Order_No,Opp_Broker_Id,settflag,membercode,tmpartycode,  
   reserved1,reserved2,reserved3,reserved4,reserved5 From FoTrade  
   Where ActivityTime Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
  
   Update FoTrade Set TradeQty = TradeQty - @QtyToTransfer  
   Where ActivityTime Like @Sauda_Date + '%'  
          And Party_Code = @PartyFrom  
          And Inst_Type = @Inst_Type  
          And Symbol = @Symbol  
          And ExpiryDate Like @Expiry_Date + '%'  
          And Strike_Price = @Strike_Price  
          And Option_Type = @Option_Type  
          And Sell_Buy = @Sell_Buy  
          And ParticipantCode = @ParticipantCode  
          And Order_No Like @Order_No  
          And Trade_No Like @New_Trade_No  
  
   Select @QtyToTransfer = 0  
  End  
         Fetch Next From @FoTradeCursor into @QtyInFoTrade, @New_Trade_No   
	 End  
	Close @FoTradeCursor  
	DeAllocate @FoTradeCursor  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_UP
-- --------------------------------------------------

    
CREATE PROC [dbo].[PROC_TRADE_UP]               
(            
 @SNO   NUMERIC(18,0),            
 @SUBPROCESSID INT,            
 @FILETYPE  VARCHAR(10),            
 @SAUDA_DATE  VARCHAR(11),            
 @FILEPATH  VARCHAR(200)            
)              
AS              
/*            
 PROC TO IMPORT F&O TRADE FILE & PROCESS            
*/            
            
DECLARE @SQL  VARCHAR(MAX),            
  @TRADEQTY NUMERIC(18,0),            
  @CONFIRMQTY NUMERIC(18,0),            
  @TRADEAMT NUMERIC(18,4),            
  @CONFIRMAMT NUMERIC(18,4),            
  @RECCNT  NUMERIC(18,0),            
  @ERRMSG  VARCHAR(MAX)            
              

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE, '', '', 'AUTO', ''
            
UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99            
WHERE SNO = @SNO            
            
IF @SUBPROCESSID = 0             
BEGIN            
 TRUNCATE TABLE FOFTTRAE_1_IMP                   
 TRUNCATE TABLE FOFTTRAE_2_IMP     
 TRUNCATE TABLE FoFtTrade_3_IMP
 TRUNCATE TABLE FOFTTRADE            
 TRUNCATE TABLE FOTRADE            
            
 IF @FILETYPE = 'FTP'             
 BEGIN            
  BEGIN TRY            
   SET @SQL = LOWER('BULK INSERT FoFtTrade_3_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')            
   print @SQL
   EXEC (@SQL)            
  END TRY            
  BEGIN CATCH            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 0,            
   PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = ''            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99              
   RETURN            
  END CATCH            
          
  EXEC INS_FOFTTRADE 3            
 END      
 
  
             
 --IF @FILETYPE = 'FTP'             
 --BEGIN            
 -- BEGIN TRY            
 --  SET @SQL = LOWER('BULK INSERT FOFTTRAE_2_IMP FROM ''' + @FILEPATH + ''' WITH  (FIELDTERMINATOR = '','', ROWTERMINATOR = ''\N'' )')            
 --  EXEC (@SQL)            
 -- END TRY            
 -- BEGIN CATCH            
 --  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 0,            
 --  PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
 --  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
 --  PROCESS_OUTPUT_QUERY = ''            
 --  WHERE SNO = @SNO AND PROCESS_STATUS = 99              
 --  RETURN            
 -- END CATCH            
            
 -- EXEC PR_FOFTTRAE_UPD 2            
 --END            
             
 UPDATE FOFTTRADE SET OPTION_TYPE = '', EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'            
    WHERE INST_TYPE LIKE 'FUT%'            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE WHERE LEFT(ACTIVITYTIME,11) <> @SAUDA_DATE) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET             
  PROCESS_HALTED_REASON = 'SELECTED FILE IS HAVING SOME OTHER DATE DATA THAN THE BUSINESS DATE.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()             
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  TRUNCATE TABLE FOTRADE            
              
  RETURN            
 END            
              
 IF (SELECT ISNULL(COUNT(1),0) FROM (             
   SELECT TOP 1 LEFT(ACTIVITYTIME,11) AS ACTIVITYTIME FROM FOTRADE ) A WHERE LEFT(ACTIVITYTIME,11) NOT IN            
    (SELECT BUSINESS_DATE = LEFT(BUSINESS_DATE,11) FROM V2_BUSINESS_PROCESS (NOLOCK)            
   WHERE OPEN_CLOSE = 0)) > 0             
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET             
  PROCESS_HALTED_REASON = 'NOT ALLOW TO IMPORT THE DATA OF OTHER THEN THE PROCESS DATE IS OPEN.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()             
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  TRUNCATE TABLE FOTRADE            
              
  RETURN            
 END            
 ELSE            
 BEGIN            
   EXEC FODUPRECCHECK            
            
   INSERT INTO FOSTAT_TRD VALUES ('I10', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
 END    
END            
            
IF @SUBPROCESSID = 1 OR @SUBPROCESSID = 0            
BEGIN            
              
 Update FoTrd Set FoTrd.MarKetType = FoSrp2.RegularLot, FoTrd.BookType = FoSrp2.Numerator,             
 FoTrd.Reserved2 = FoSrp2.PriceUnit,FoTrd.BookTypeName = FoSrp2.Denominator            
 from FoTrade FoTrd, FoScrip2 FoSrp2            
 Where FoTrd.inst_type = FoSrp2.inst_type and FoTrd.symbol = FoSrp2.symbol and            
 left(FoSrp2.expirydate, 11) = left(FoTrd.expirydate, 11) And FoSrp2.Strike_Price = FoTrd.Strike_Price            
            
 EXEC FODUPRECSETTCHECK            
            
 INSERT INTO FOSTAT_TRD VALUES ('I20', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 1,            
  PROCESS_HALTED_REASON = 'ALL TRADES ARE DELETED BECAUSE OF DUPLICATION.',            
  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  DELETE FROM FOSTAT_TRD WHERE FILEDATE = @SAUDA_DATE            
            
  RETURN            
 END            
 SET @SUBPROCESSID = 2            
END            
            
IF @SUBPROCESSID = 2 OR @SUBPROCESSID = 0            
BEGIN            
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 2            
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
 UPDATE FOTRADE SET FOTRADE.PARTY_CODE = TERMPARTY.PARTY_CODE FROM TERMPARTY             
 WHERE TERMPARTY.USERID = FOTRADE.USER_ID AND FOTRADE.PRO_CLI = PROCLI            
            
 INSERT INTO FOSTAT_TRD VALUES ('I21', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
 SET @SUBPROCESSID = 3            
END            
            
IF @SUBPROCESSID = 3 OR @SUBPROCESSID = 0            
BEGIN            
 SET @SUBPROCESSID = 4            
END            
            
IF @SUBPROCESSID = 4 OR @SUBPROCESSID = 0            
BEGIN            
 -- FOR SKIPPING OF TRADE IN CASE OF MISSING CLIENT AND SCRIP            
 SET @SUBPROCESSID = 5            
END            
            
IF @SUBPROCESSID = 5 OR @SUBPROCESSID = 0            
BEGIN            
 INSERT INTO FOSTAT_TRD VALUES ('I40', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
            
 EXEC FOTRD_CLIENTMASTER            
     
 EXEC FOTRD_SCRIPMASTER            
              
 IF (SELECT COUNT(1) FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE            
  AND CLIENT5.INACTIVEFROM <= GETDATE()) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE INACTIVE CLIENT DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = 'SELECT PARTY_CODE FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE AND CLIENT5.INACTIVEFROM <= GETDATE() '            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTRD_CLIENT2)) > 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING CLIENT DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = 'SELECT DISTINCT PARTY_CODE, TERMINAL = USER_ID FROM FOTRADE WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTRD_CLIENT2) '            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
            
 IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK)             
             WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE            
             AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE            
             AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL            
             AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE            
             AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE            
             AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE))> 1            
 BEGIN            
             
             
  SET @ERRMSG = 'SELECT DISTINCT INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE'            
  SET @ERRMSG = @ERRMSG + ' FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 WHERE '            
  SET @ERRMSG = @ERRMSG + ' FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE'            
  SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL'            
  SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE'            
  SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE'            
  SET @ERRMSG = @ERRMSG + ' AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE) '            
                           
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'TRADES CONTAINS THE MISSING SCRIP DATA, PLEASE CORRECT.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = @ERRMSG            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
             
            
 SELECT @TRADEQTY = ISNULL(SUM(TRADEQTY),0), @TRADEAMT = ISNULL(SUM(TRADEQTY*PRICE),0)            
 FROM FOTRADE            
            
 SELECT @CONFIRMQTY = ISNULL(SUM(TRADEQTY),0), @CONFIRMAMT = ISNULL(SUM(TRADEQTY*PRICE),0)            
 FROM FOCONFIRMVIEW            
            
 IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
  PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',            
  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE()            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
            
 IF (@TRADEQTY - @CONFIRMQTY) <> 0 OR (@TRADEAMT - @CONFIRMAMT) <> 0    BEGIN            
  IF @TRADEQTY > @CONFIRMQTY OR @TRADEAMT > @CONFIRMAMT            
  BEGIN            
   IF @CONFIRMQTY = 0            
   BEGIN            
    UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
    PROCESS_HALTED_REASON = 'SEEMS TO BE ISSUE IN MASTER.',            
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()            
    WHERE SNO = @SNO AND PROCESS_STATUS = 99            
   END            
   ELSE            
   BEGIN             
    SET @ERRMSG = 'SELECT PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'            
    SET @ERRMSG = @ERRMSG + ' FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOCONFIRMVIEW WHERE '            
    SET @ERRMSG = @ERRMSG + ' FOTRADE.INST_TYPE = FOCONFIRMVIEW.INST_TYPE'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.SYMBOL = FOCONFIRMVIEW.SYMBOL'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.EXPIRYDATE = FOCONFIRMVIEW.EXPIRYDATE'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.STRIKE_PRICE = FOCONFIRMVIEW.STRIKE_PRICE'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.OPTION_TYPE = FOCONFIRMVIEW.OPTION_TYPE'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.TRADE_NO = FOCONFIRMVIEW.TRADE_NO'            
    SET @ERRMSG = @ERRMSG + ' AND FOTRADE.ORDER_NO = FOCONFIRMVIEW.ORDER_NO) '            
                  
    UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
    PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER.',            
    PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),                
    PROCESS_OUTPUT_QUERY = @ERRMSG            
    WHERE SNO = @SNO AND PROCESS_STATUS = 99            
   END            
 END            
  ELSE            
  BEGIN            
            
   SET @ERRMSG = 'SELECT PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'            
   SET @ERRMSG = @ERRMSG + ' FROM FOCONFIRMVIEW GROUP BY '            
   SET @ERRMSG = @ERRMSG + ' PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,ORDER_NO'            
   SET @ERRMSG = @ERRMSG + ' HAVING COUNT(1) > 1'            
              
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 5,            
   PROCESS_HALTED_REASON = 'SOME OF PARTY ARE HAVING PROBLEM IN THE MASTER. DUPLICATE DATA IS COMING FROM THE CONFIRMATION.',            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = @ERRMSG            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99            
  END            
  RETURN            
 END            
 ELSE            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 6            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  INSERT INTO FOSTAT_TRD VALUES ('I70', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
              
  SET @SUBPROCESSID = 6            
 END            
END            
            
IF @SUBPROCESSID = 6 OR @SUBPROCESSID = 0            
BEGIN            
            
 EXEC FOTRDCONTRACT               
            
 --EXEC FOTRD_CLIENTMASTER            
             
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7            
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
 INSERT INTO FOSTAT_TRD VALUES ('I80', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
 SET @SUBPROCESSID = 7            
END            
            
IF @SUBPROCESSID = 7 OR @SUBPROCESSID = 0            
BEGIN            
             
 IF (SELECT ISNULL(COUNT(1),0) FROM FOTRADE)  = 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
  PROCESS_HALTED_REASON = 'NO DATA PRESENT IN THE TRADE.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE()            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
      
 IF (SELECT ISNULL(COUNT(*),0) FROM CONTGEN, FOTRADE WHERE ACTIVITYTIME >= START_DATE AND ACTIVITYTIME <= END_DATE) <= 0            
 BEGIN            
  UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
  PROCESS_HALTED_REASON = 'PLEASE ENTER THE CONTRACT NO IN THE TABLE FOR THE CURRENT YEAR.',            
  PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
  PROCESS_OUTPUT_QUERY = ''            
  WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
  RETURN            
 END            
 BEGIN TRAN            
  SELECT @TRADEQTY = 0            
  SELECT @TRADEQTY = ISNULL(SUM(TRADEQTY),0), @RECCNT = ISNULL(COUNT(1),0) FROM FOTRADE            
  SELECT @TRADEQTY = @TRADEQTY + ISNULL(SUM(TRADEQTY),0) FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'            
             
  BEGIN TRY            
   EXEC FOGENCONTRACT --'AUTO_PROCESS'            
  END TRY            
  BEGIN CATCH            
   ROLLBACK TRAN            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
   PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = ''            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99              
   RETURN            
  END CATCH            
  SELECT @CONFIRMQTY = 0            
  SELECT @CONFIRMQTY = @CONFIRMQTY + ISNULL(SUM(TRADEQTY/BILLNO),0) FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'    
  
  print @TRADEQTY
  print @CONFIRMQTY

   
            
  IF @TRADEQTY <> @CONFIRMQTY             
  BEGIN            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 7,            
   PROCESS_HALTED_REASON = 'QTY BEFORE CONTRACT AND AFTER CONTRACT NOT MATCHING.',            
   PROCESS_STATUS = 98, PROCESS_ENDED_DATE = GETDATE(),            
   PROCESS_OUTPUT_QUERY = ''            
   WHERE SNO = @SNO AND PROCESS_STATUS = 99            
              
   RETURN            
  END            
            
  SET @SUBPROCESSID = 8            
 COMMIT             
            
 UPDATE TBL_AUTO_PROCESS_DETAIL SET SUB_PROCESS_ID = 8,            
 PROCESS_HALTED_REASON = 'TRADE IMPORTED SUCCESSFULLY.' + CONVERT(VARCHAR,@RECCNT),            
 PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(),            
 PROCESS_OUTPUT_QUERY = '', PROCESS_STATUS_ALERT_INTERVAL = '00:00:00'            
 WHERE SNO = @SNO AND PROCESS_STATUS = 99            
            
 INSERT INTO FOSTAT_TRD VALUES ('I95', @SAUDA_DATE + ' ' + CONVERT(VARCHAR,GETDATE(),108),@SAUDA_DATE,GETDATE())            
END            
            
IF @SUBPROCESSID = 8 OR @SUBPROCESSID = 0            
BEGIN            
 DELETE FROM FOSTAT_TRD WHERE FILEDATE = @SAUDA_DATE            
END            
            
            
            
/*------------------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_VBB_Scheme_Mapping
-- --------------------------------------------------
CREATE Proc [dbo].[Proc_VBB_Scheme_Mapping]
as

Begin


truncate table scheme_master

set identity_insert scheme_master on
insert into scheme_master (SM_SrNo,SM_Scheme_Id,SM_Scheme_Desc,SM_Trd_Type,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier,SM_Res_Buy_Brok,
SM_Res_Sell_Brok,SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,SM_CreatedBy,SM_CreatedOn,SM_ModifiedBy,SM_ModifiedOn)
select  
SM_SrNo,SM_Scheme_Id,SM_Scheme_Desc,SM_Trd_Type,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier,SM_Res_Buy_Brok,
SM_Res_Sell_Brok,SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,SM_CreatedBy,SM_CreatedOn,SM_ModifiedBy,SM_ModifiedOn
from mcdx.dbo.scheme_master
order by SM_Scheme_Id
set identity_insert scheme_master off


-- Option percentrage, Option minimum and Option maximum 

truncate table scheme_mapping 
 
select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), brokp6, brokd6, BROKMD6 into #fo_opt_brok from mcdx..VWNCBROK v where optlot = 'Y' and brokp6 <> 0 and brokd6 <> 0 and brokmd6 <> 0 
and excd = 'L' and ismig = 1 and brokd6 <= brokmd6
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

 
 
alter table #fo_opt_brok add scheme_id int, scheme_desc varchar(100) 

update #fo_opt_brok set scheme_id = 0, scheme_desc = ''
update #fo_opt_brok set scheme_desc = 'OPT ' + CONVERT(VARCHAR, FORMAT(BROKP6,'0.######')) + '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD6,'0.##')) + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD6,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_opt_brok a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_opt_brok where scheme_id = 0

delete from #fo_opt_brok where  ucc is not null and scheme_id = 0


  
insert into Scheme_Mapping
select ucc SP_Party_Code, 'T' SP_Computation_Level, 'OPT' SP_Inst_Type, secu SP_Scrip, scheme_id SP_Scheme_Id, 'TRD' SP_Trd_Type, 0 SP_Scheme_Type, 1.000 SP_Multiplier,
'P' SP_Buy_Brok_Type, 'P' SP_Sell_Brok_Type, brokp6 SP_Buy_Brok, brokp6 SP_Sell_Brok, 0.0000 SP_Res_Multiplier, 0.0000 SP_Res_Buy_Brok, 0.0000 SP_Res_Sell_Brok, 
0.0000 SP_Value_From, -1.000 SP_Value_To, 'PRICE' SP_TurnOverOn,'V' SP_Brok_ComputeOn,'V' SP_Brok_ComputeType, BROKD6 SP_Min_BrokAmt, BROKMD6 SP_Max_BrokAmt, 
0.0000 SP_Min_ScripAmt, -1.0000 SP_Max_ScripAmt, '2021-04-01' SP_Date_From,'2049-12-31 23:59:00.000' SP_Date_To,'DEMO' SP_CreatedBy,getdate() SP_CreatedOn, 
'' SP_ModifiedBy, '' SP_ModifiedOn
from #fo_opt_brok f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.SP_Inst_Type = 'OPT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

------------------------------


select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), brokp6, brokd6, BROKMD6 into #fo_opt_brok1 from mcdx..VWNCBROK V where optlot = 'Y' and brokp6 <> 0 and brokd6 <> 0 and brokmd6 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_opt_brok1 add scheme_id int , scheme_desc varchar(100) 

update #fo_opt_brok1 set scheme_id = 0, scheme_desc = ''
update #fo_opt_brok1 set scheme_desc = 'OPT ' + CONVERT(VARCHAR, FORMAT(BROKP6,'0.######')) + '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD6,'0.##')) --+ ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD6,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_opt_brok1 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_opt_brok where  ucc is not null and scheme_id = 0

delete from #fo_opt_brok1 where  ucc is not null and scheme_id = 0


insert into Scheme_Mapping
select ucc, 'T', 'OPT', secu, scheme_id, 'TRD', 0, 1.000, 'P', 'P', brokp6, brokp6, 0.0000, 0.0000, 0.0000, 0.0000, -1.000, 'PRICE', 'V','V', BROKD6, -1.0000 BROKMD6, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_opt_brok1 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

------------------------------
 

select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), brokp6, brokd6, BROKMD6 into #fo_opt_brok2 from mcdx.dbo.VWNCBROK v where optlot = 'Y' and brokp6 <> 0 and brokd6 = 0 and brokmd6 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_opt_brok2 add scheme_id int , scheme_desc varchar(100) 

update #fo_opt_brok2 set scheme_id = 0, scheme_desc = ''
update #fo_opt_brok2 set scheme_desc = 'OPT ' + CONVERT(VARCHAR, FORMAT(BROKP6,'0.######')) --+ '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD6,'0.##')) --+ ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD6,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_opt_brok2 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_opt_brok where  ucc is not null and scheme_id = 0

delete from #fo_opt_brok2 where  ucc is not null and scheme_id = 0

--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_opt_brok)
--and getdate() between SP_Date_From and SP_Date_To


insert into Scheme_Mapping
select ucc SP_Party_Code, 'T' SP_Computation_Level, 'OPT' SP_Inst_Type, secu SP_Scrip, scheme_id SP_Scheme_Id, 'TRD' SP_Trd_Type, 0 SP_Scheme_Type, 1.000 SP_Multiplier,
'P' SP_Buy_Brok_Type, 'P' SP_Sell_Brok_Type, brokp6 SP_Buy_Brok, brokp6 SP_Sell_Brok, 0.0000 SP_Res_Multiplier, 0.0000 SP_Res_Buy_Brok, 0.0000 SP_Res_Sell_Brok, 
0.0000 SP_Value_From, -1.000 SP_Value_To, 'PRICE' SP_TurnOverOn,'V' SP_Brok_ComputeOn,'V' SP_Brok_ComputeType, BROKD6 SP_Min_BrokAmt, BROKMD6 SP_Max_BrokAmt, 
0.0000 SP_Min_ScripAmt, -1.0000 SP_Max_ScripAmt, '2021-04-01' SP_Date_From,'2049-12-31 23:59:00.000' SP_Date_To,'DEMO' SP_CreatedBy,getdate() SP_CreatedOn, 
'' SP_ModifiedBy, '' SP_ModifiedOn
from #fo_opt_brok2 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

 
--------------------


-- Option percentrage is ZERO, Option minimum and Option maximum
 
select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), brokp6, brokd6, BROKMD6 into #fo_opt_brok3 from mcdx..VWNCBROK v where optlot = 'Y'  and brokp6 = 0 and brokd6 <> 0 and brokmd6 <> 0
and excd = 'L' and ismig = 1
and brokd6 = BROKMD6
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)
 
alter table #fo_opt_brok3 add scheme_id int,  scheme_desc varchar(100)

update #fo_opt_brok3 set scheme_id = 0, scheme_desc = ''
update #fo_opt_brok3 set scheme_desc = 'OPT MIN ' + CONVERT(VARCHAR, FORMAT(BROKD6,'0.##')) + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD6,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_opt_brok3 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_opt_brok where  ucc is not null and scheme_id = 0

delete from #fo_opt_brok3 where  ucc is not null and scheme_id = 0

--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_opt_brok)
--and getdate() between SP_Date_From and SP_Date_To

insert into Scheme_Mapping
select ucc, 'T', 'OPT', secu, scheme_id, 'TRD', 0, 1.000, 'V', 'V', BROKD6, BROKMD6, 0.0000, 0.0000, 0.0000, 0.0000, -1.000,'PRICE', 'L','V', 0.0000, -1.000, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_opt_brok3 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc


-- Option percentrage is ZERO, Option minimum and Option maximum
 
select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), brokp6, brokd6, BROKMD6 into #fo_opt_brok4 from mcdx.dbo.VWNCBROK v where optlot = 'Y'  and brokp6 = 0 and brokd6 <> 0 and brokmd6 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_opt_brok4 add scheme_id int,  scheme_desc varchar(100)

update #fo_opt_brok4 set scheme_id = 0, scheme_desc = ''
update #fo_opt_brok4 set scheme_desc = 'OPT MIN ' + CONVERT(VARCHAR, FORMAT(BROKD6,'0.##')) -- + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD6,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_opt_brok4 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_opt_brok where  ucc is not null and scheme_id = 0

delete from #fo_opt_brok4 where  ucc is not null and scheme_id = 0

--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_opt_brok)
--and getdate() between SP_Date_From and SP_Date_To

insert into Scheme_Mapping
select ucc, 'T', 'OPT', secu, scheme_id, 'TRD', 0, 1.000, 'V', 'V', BROKD6, BROKMD6, 0.0000, 0.0000, 0.0000, 0.0000, -1.000,'PRICE', 'L','V', 0.0000, -1.000, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_opt_brok4 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'OPT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc



/*
-- Future percentrage, Future minimum and Future maximum 
 

select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), BROKP1, BROKD1, BROKMD1 into #fo_fut_brok from mcdx..VWNCBROK v where futlot = 'Y' and BROKP1 <> 0 and BROKD1 <> 0 and BROKMD1 <> 0 
and excd = 'L' and ismig = 1 and BROKD1 <= BROKMD1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)
 
alter table #fo_fut_brok add scheme_id int, scheme_desc varchar(100) 

update #fo_fut_brok set scheme_id = 0, scheme_desc = ''
update #fo_fut_brok set scheme_desc = 'FUT ' + CONVERT(VARCHAR, FORMAT(BROKP1,'0.######')) + '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD1,'0.##')) + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD1,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_fut_brok a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_fut_brok where  ucc is not null and scheme_id = 0

delete from #fo_fut_brok where  ucc is not null and scheme_id = 0

--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_fut_brok)
--and getdate() between SP_Date_From and SP_Date_To and SP_Inst_Type = 'FUT'

-- truncate table scheme_mapping 

 
insert into Scheme_Mapping
select ucc SP_Party_Code, 'T' SP_Computation_Level, 'FUT' SP_Inst_Type, secu SP_Scrip, scheme_id SP_Scheme_Id, 'TRD' SP_Trd_Type, 0 SP_Scheme_Type, 1.000 SP_Multiplier,
'P' SP_Buy_Brok_Type, 'P' SP_Sell_Brok_Type, BROKP1 SP_Buy_Brok, BROKP1 SP_Sell_Brok, 0.0000 SP_Res_Multiplier, 0.0000 SP_Res_Buy_Brok, 0.0000 SP_Res_Sell_Brok, 
0.0000 SP_Value_From, -1.000 SP_Value_To, 'PRICE' SP_TurnOverOn,'V' SP_Brok_ComputeOn,'V' SP_Brok_ComputeType, BROKD1 SP_Min_BrokAmt, BROKMD1 SP_Max_BrokAmt, 
0.0000 SP_Min_ScripAmt, -1.0000 SP_Max_ScripAmt, '2021-04-01' SP_Date_From,'2049-12-31 23:59:00.000' SP_Date_To,'DEMO' SP_CreatedBy,getdate() SP_CreatedOn, 
'' SP_ModifiedBy, '' SP_ModifiedOn
from #fo_fut_brok f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

------------------------------

 

select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), BROKP1, BROKD1, BROKMD1 into #fo_fut_brok1 from mcdx..VWNCBROK v where futlot = 'Y' and BROKP1 <> 0 and BROKD1 <> 0 and BROKMD1 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_fut_brok1 add scheme_id int , scheme_desc varchar(100) 

update #fo_fut_brok1 set scheme_id = 0, scheme_desc = ''
update #fo_fut_brok1 set scheme_desc = 'FUT ' + CONVERT(VARCHAR, FORMAT(BROKP1,'0.######')) + '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD1,'0.##')) --+ ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD1,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_fut_brok1 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_fut_brok1 where  ucc is not null and scheme_id = 0

delete from #fo_fut_brok1 where  ucc is not null and scheme_id = 0


--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_fut_brok)
--and getdate() between SP_Date_From and SP_Date_To and SP_Inst_Type = 'FUT'


insert into Scheme_Mapping
select ucc, 'T', 'FUT', secu, scheme_id, 'TRD', 0, 1.000, 'P', 'P', BROKP1, BROKP1, 0.0000, 0.0000, 0.0000, 0.0000, -1.000, 'PRICE', 'V','V', BROKD1, -1.0000 BROKMD1, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_fut_brok1 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

------------------------------

 

select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), BROKP1, BROKD1, BROKMD1 into #fo_fut_brok2 from mcdx.dbo.VWNCBROK v where futlot = 'Y' and BROKP1 <> 0 and BROKD1 = 0 and BROKMD1 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_fut_brok2 add scheme_id int , scheme_desc varchar(100) 

update #fo_fut_brok2 set scheme_id = 0, scheme_desc = ''
update #fo_fut_brok2 set scheme_desc = 'FUT ' + CONVERT(VARCHAR, FORMAT(BROKP1,'0.######')) --+ '% - MIN ' + CONVERT(VARCHAR, FORMAT(BROKD1,'0.##')) --+ ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD1,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_fut_brok2 a, nsecurfo.dbo.Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_fut_brok where  ucc is not null and scheme_id = 0

delete from #fo_fut_brok2 where  ucc is not null and scheme_id = 0


--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_fut_brok)
--and getdate() between SP_Date_From and SP_Date_To and SP_Inst_Type = 'FUT'


insert into Scheme_Mapping
select ucc SP_Party_Code, 'T' SP_Computation_Level, 'FUT' SP_Inst_Type, secu SP_Scrip, scheme_id SP_Scheme_Id, 'TRD' SP_Trd_Type, 0 SP_Scheme_Type, 1.000 SP_Multiplier,
'P' SP_Buy_Brok_Type, 'P' SP_Sell_Brok_Type, BROKP1 SP_Buy_Brok, BROKP1 SP_Sell_Brok, 0.0000 SP_Res_Multiplier, 0.0000 SP_Res_Buy_Brok, 0.0000 SP_Res_Sell_Brok, 
0.0000 SP_Value_From, -1.000 SP_Value_To, 'PRICE' SP_TurnOverOn,'V' SP_Brok_ComputeOn,'V' SP_Brok_ComputeType, BROKD1 SP_Min_BrokAmt, BROKMD1 SP_Max_BrokAmt, 
0.0000 SP_Min_ScripAmt, -1.0000 SP_Max_ScripAmt, '2021-04-01' SP_Date_From,'2049-12-31 23:59:00.000' SP_Date_To,'DEMO' SP_CreatedBy,getdate() SP_CreatedOn, 
'' SP_ModifiedBy, '' SP_ModifiedOn
from #fo_fut_brok2 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

 
--------------------


-- Future percentrage is ZERO, Future minimum and Future maximum
 
select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), BROKP1, BROKD1, BROKMD1 into #fo_fut_brok3 from mcdx..VWNCBROK v where futlot = 'Y'  and BROKP1 = 0 and BROKD1 <> 0 and BROKMD1 <> 0
and excd = 'L' and ismig = 1
and BROKD1 = BROKMD1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)
 
alter table #fo_fut_brok3 add scheme_id int,  scheme_desc varchar(100)

update #fo_fut_brok3 set scheme_id = 0, scheme_desc = ''
update #fo_fut_brok3 set scheme_desc = 'FUT MIN ' + CONVERT(VARCHAR, FORMAT(BROKD1,'0.##')) + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD1,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_fut_brok3 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_fut_brok where  ucc is not null and scheme_id = 0

delete from #fo_fut_brok3 where  ucc is not null and scheme_id = 0


--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_fut_brok)
--and getdate() between SP_Date_From and SP_Date_To and SP_Inst_Type = 'FUT'

insert into Scheme_Mapping
select ucc, 'T', 'FUT', secu, scheme_id, 'TRD', 0, 1.000, 'V', 'V', BROKD1, BROKMD1, 0.0000, 0.0000, 0.0000, 0.0000, -1.000,'PRICE', 'L','V', 0.0000, -1.000, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_fut_brok3 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc


-- Future percentrage is ZERO, Future minimum and Future maximum
 
select party, excd, ucc, secu = (case when secu = '' then 'ALL' else secu end), BROKP1, BROKD1, BROKMD1 into #fo_fut_brok4 from mcdx.dbo.VWNCBROK v where futlot = 'Y'  and BROKP1 = 0 and BROKD1 <> 0 and BROKMD1 = 0
and excd = 'L' and ismig = 1
and secu not in ('LIQUIDBEES','579GS2030','585GS2030','619GS2034','727GS2026','757GS2033')
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and v.ucc = s.sp_party_code
				and (case when v.secu = '' then 'ALL' else v.secu end) = s.sp_scrip
				)

alter table #fo_fut_brok4 add scheme_id int,  scheme_desc varchar(100)

update #fo_fut_brok4 set scheme_id = 0, scheme_desc = ''
update #fo_fut_brok4 set scheme_desc = 'FUT MIN ' + CONVERT(VARCHAR, FORMAT(BROKD1,'0.##')) -- + ' MAX ' + CONVERT(VARCHAR, FORMAT(BROKMD1,'0.##'))
update a set a.scheme_id = b.SM_Scheme_Id from #fo_fut_brok4 a, Scheme_Master b where a.scheme_desc = b.SM_Scheme_Desc

--select * from #fo_fut_brok where  ucc is not null and scheme_id = 0

delete from #fo_fut_brok4 where  ucc is not null and scheme_id = 0

--select * from scheme_mapping where sp_party_code in (select distinct ucc from #fo_fut_brok)
--and getdate() between SP_Date_From and SP_Date_To

insert into nsecurfo.dbo.Scheme_Mapping
select ucc, 'T', 'FUT', secu, scheme_id, 'TRD', 0, 1.000, 'V', 'V', BROKD1, BROKMD1, 0.0000, 0.0000, 0.0000, 0.0000, -1.000,'PRICE', 'L','V', 0.0000, -1.000, 0.0000, -1.0000,
	   '2021-04-01','2049-12-31 23:59:00.000','DEMO',getdate(), '', ''
from #fo_fut_brok4 f where ucc is not null
and ucc not in (select distinct sp_party_code from scheme_mapping S where getdate() between S.SP_Date_From and S.SP_Date_To and s.sp_inst_type = 'FUT'
				and f.ucc = s.sp_party_code
				and f.secu = s.sp_scrip
				)
order by scheme_id, ucc

-----------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
*/

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RecalAllStampDuty
-- --------------------------------------------------

CREATE  Proc  RecalAllStampDuty (@DateFrom VARCHAR (20),@DateTo as varchar(20))  
As        
    
Declare        
@Sauda_Date  varchar(11),  
@DateCur Cursor        
        
Set @DateCur = Cursor for        
Select  Distinct  left(Sauda_Date,11)  from fosettlement where Sauda_Date between @DateFrom and @DateTo  
Open @DateCur        
        
Fetch Next From @DateCur into @Sauda_Date  
While @@Fetch_Status = 0         
Begin        
        
 EXECUTE CalculateStampDuty  @Sauda_Date  
      
 Fetch Next From @DateCur into @Sauda_Date  
End        
Close @DateCur        
DeAllocate @DateCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ReCalcBrok
-- --------------------------------------------------


CREATE  Proc  ReCalcBrok 
(
	@sauda_date VARCHAR (11),
	@Partycode as varchar(12),
	@StatusId	Varchar(50),
	@strModule      Varchar(50)
)
As      
  
 
  
if @Partycode=''  
 begin  
  set @Partycode = '%'  
 end  
  
Exec PROC_TRADE_TRANSFER_RECAL  @sauda_date,@Partycode,'%','%','%',0,'%' ,@StatusId,@strModule     
    
Exec ReCalculateStampDuty @sauda_date ,@Partycode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECALCULATESTAMPDUTY
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[RECALCULATESTAMPDUTY] (@SAUDADATE VARCHAR(11),@PARTY_CODE VARCHAR(10))       
AS      

DECLARE @INTSYMBOLWISETAX INT
SET @INTSYMBOLWISETAX = 0
SELECT @INTSYMBOLWISETAX= COUNT(1) FROM FOTAXES WHERE @SAUDADATE BETWEEN FROM_DATE AND TO_DATE AND LTRIM(RTRIM(ISNULL(SYMBOL,''))) <> ''

SELECT   S.PARTY_CODE,
         S.SYMBOL,
         (CONVERT(NUMERIC,CEILING(SUM((TRADEQTY * PRICE * BOOKTYPE * BROKER_NOTE / INSTRUMENT) / F.UNIT))) / CONVERT(NUMERIC,SUM(TRADEQTY))) DUTYPERTRD
INTO     #TMPSTAMPDUTY1
FROM     FOSETTLEMENT S,
         FOTAXES F
WHERE    S.SAUDA_DATE BETWEEN F.FROM_DATE AND F.TO_DATE
	 AND S.PARTY_CODE = @PARTY_CODE
         AND F.TRANS_CAT = 'TRD'
         AND F.BASIS = 'VALUE'
         AND AUCTIONPART <> 'CA'
         AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
         AND TRADEQTY > 0
	 AND S.SYMBOL = CASE WHEN @INTSYMBOLWISETAX>1 THEN F.SYMBOL ELSE S.SYMBOL END
GROUP BY S.PARTY_CODE,S.SYMBOL


         
UPDATE F
SET    F.BROKER_CHRG = TMP.DUTYPERTRD * F.TRADEQTY
FROM   FOSETTLEMENT F,
       #TMPSTAMPDUTY1 TMP
WHERE  F.PARTY_CODE = TMP.PARTY_CODE
       AND F.SYMBOL = TMP.SYMBOL
       AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
       AND AUCTIONPART <> 'CA'
	   AND F.SELL_BUY = 1
                          
EXEC STAMPDUTY_ROUNDING_FURTHER @SAUDADATE
  
IF (SELECT COUNT(1) FROM  TAXES_SETTING WHERE   TAXES_TYPE ='STAMP_DUTY' AND @SAUDADATE BETWEEN DATE_FROM AND DATE_TO  AND COMPUTE_FLAG = 1) > 0
BEGIN
	UPDATE FOSETTLEMENT      
	SET    BROKER_CHRG = ROUND((PRICE * TRADEQTY * BOOKTYPE / INSTRUMENT * TAXES_PERC / 100),4)  
	FROM   CLIENT1 (NOLOCK),      
		   CLIENT2 (NOLOCK),      
		   TAXES_SETTING (NOLOCK)      
	WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE      
		   AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE      
		   AND L_STATE = TAXES_SETTING.STATE_CODE      
		   AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO  
		   AND COMPUTE_FLAG = 1    
		   AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDADATE  AND @SAUDADATE + ' 23:59' 
		   AND CLIENT2.PARTY_CODE = @PARTY_CODE     
END   
           
UPDATE FOSETTLEMENT
SET    BROKER_CHRG = 0
FROM   CLIENT2 C (NOLOCK)
WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE
       AND C.PARTY_CODE = @PARTY_CODE
       AND BROKERNOTE = 0
       AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
       AND TURN_TAX > 0
                      
UPDATE FOSETTLEMENT
SET    BROKER_CHRG = 0
FROM   FOCLIENTTAXES
WHERE  FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
       AND FUT_BROKER_NOTE = 0
       AND LEFT(SAUDA_DATE,11) = @SAUDADATE
       AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE
                                 
-- TRADE TIME SLAB BASED TURN OVER TAX COMPUTATION
IF (SELECT COUNT(1)  FROM   TAXES_SETTING WHERE  @SAUDADATE BETWEEN DATE_FROM AND DATE_TO  AND COMPUTE_FLAG = 1) > 0
  BEGIN
	    UPDATE FOSETTLEMENT
	    SET    TURN_TAX = (TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT) * TAXES_PERC / TAXES_UNIT
	    FROM   TAXES_SETTING (NOLOCK)
	    WHERE  SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
	           AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
	           AND CONVERT(BIGINT,REPLACE(CONVERT(VARCHAR,SAUDA_DATE,108),':','')) BETWEEN TRADE_TIME_FROM AND TRADE_TIME_TO
	           AND PARTY_CODE = @PARTY_CODE
	    
	    UPDATE FOSETTLEMENT
	    SET    TURN_TAX = 0
	    FROM   CLIENT2 C (NOLOCK)
	    WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE
	           AND TURNOVER_TAX = 0
	           AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
	           AND TURN_TAX > 0
		   AND C.PARTY_CODE = @PARTY_CODE
	    
	    UPDATE FOSETTLEMENT
	    SET    TURN_TAX = 0
	    FROM   FOCLIENTTAXES C
	    WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE
	           AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
	           AND FUT_TURNOVER_TAX = 0
	           AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
	          AND TURN_TAX > 0
		   AND C.PARTY_CODE = @PARTY_CODE
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RemissorPop
-- --------------------------------------------------


CREATE Proc RemissorPop 
(@fromDate Varchar(11),
 @todate Varchar(11) )
As
Declare 
@@SDate Varchar(11),
@@SettCur Cursor 
Set @@SettCur = Cursor For
	Select Distinct Left(Convert(Varchar,Sauda_Date,109),11) From FoSettlement 
  where Sauda_Date >= @FromDate And Sauda_Date <= @ToDate + ' 23:59'
Order By Left(Convert(Varchar,Sauda_Date,109),11) 
Open @@SettCur 
Fetch Next From @@SettCur into @@SDate
While @@Fetch_Status = 0 
Begin
	Exec Remmissor_Sharing @@SDate
	Fetch Next From @@SettCur into @@SDate
End
Close @@SettCur
DeAllocate @@SettCur

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Remmissor_Sharing
-- --------------------------------------------------


CREATE Proc Remmissor_Sharing (@Sauda_Date Varchar(11))
As

Delete From Remissor_Trans_Temp Where Sauda_Date Like @Sauda_Date + '%'

Insert Into Remissor_Trans_Temp
Select Sauda_Date,Party_Code,RemCode,Branch_Cd,
TrdBrok,DelBrok,TrdTurnOver,DelTurnOver,
RemBrokerage=(Case When SharingType = 'G' 
		   Then ( Case When TransType = 'TRD' 
		 	       Then (Case When TrdBrokNew > 0 
					  Then Round(TrdBrokNew*Sharing/100,2)
				          Else 0 
				     End )
			       Else (Case When DelBrokNew > 0 
					  Then Round(DelBrokNew*Sharing/100,2)
					  Else 0 
				     End )	
			  End )
		   When SharingType = 'R' 
		   Then ( Case When TransType = 'TRD' 
		 	       Then (Case When TrdBrokNew > Round(TrdTurnOver*Sharing/100,2)
				          Then TrdBrokNew - Round(TrdTurnOver*Sharing/100,2)
					  Else 0 
				     End )	
			       Else (Case When DelBrokNew > Round(DelTurnOver*Sharing/100,2)
				          Then DelBrokNew - Round(DelTurnOver*Sharing/100,2)
					  Else 0 
				     End )
			  End )
		   When SharingType = 'T' 
		   Then ( Case When TransType = 'TRD' 
		 	       Then (Case When TrdBrokNew > Round(TrdTurnOver*Sharing/100,2)
				          Then Round(TrdTurnOver*Sharing/100,2)
					  Else 0 
				     End )	
			       Else (Case When DelBrokNew > Round(DelTurnOver*Sharing/100,2)
				          Then Round(DelTurnOver*Sharing/100,2)
					  Else 0 
				     End )
			  End )
		   Else 0
	      End ),
SharingType,Sharing,TransType,Charges
From 
(
Select Sauda_Date,S.Party_Code,RemCode,Branch_Cd,SharingType,Val_Per,Sharing,TransType,Charges,
TrdBrok=(Case When TransType = 'TRD' 
              Then Sum(PBrokAmt+SBrokAmt)
              Else 0
	 End),
DelBrok=0,
TrdBrokNew=(Case When TransType = 'TRD' 
	      Then Sum(PBrokAmt+SBrokAmt)
		  -Sum((((PRate+Strike_Price)*PQty*Numerator/Denominator)+((SRate+Strike_Price)*SQty*Numerator/Denominator))*Charges/100)
              Else 0
	 End),
DelBrokNew=0,
TrdTurnOver=(Case When TransType = 'TRD' 
		  Then Sum(((PRate+Strike_Price)*PQty*Numerator/Denominator)+((SRate+Strike_Price)*SQty*Numerator/Denominator))
                  Else 0 
             End ),
DelTurnOver=0
from FoBillValan S, Remissor_Master R, Client1 C1, Client2 C2
Where C1.Cl_Code = C2.Cl_Code 
And C2.Party_Code = S.Party_Code 
And S.Party_Code = R.Party_Code
And S.Sauda_Date Between FromDate And ToDate
And S.Sauda_Date  Like @Sauda_Date + '%'
And TradeType = 'BT'
Group By Sauda_Date,S.Party_Code,RemCode,Branch_Cd,SharingType,Val_Per,Sharing,TransType,Charges ) A
Where TrdTurnOver > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RMSProc_RiskUpdate
-- --------------------------------------------------
CREATE Proc [dbo].[RMSProc_RiskUpdate]  
(  
      @MarginDate Varchar(11),  
      @priceflag varchar(25) = 'Strike_Price + Premium'  
)  
  
as  
  

  
  
  
---------------------------------------  
-- FETCHING CLIENT MASTER  
---------------------------------------  
  
  
Create Table #MarginClients  
(  
      Party_Code varchar(10),  
      Cl_Code varchar(10),  
      Short_Name varchar(64),  
      Long_Name varchar(100),  
      Branch_Cd varchar(10),  
      Family varchar(10),  
      Sub_Broker varchar(10),  
      Trader varchar(20),  
      Approver varchar(30)  
)  
  
  
      set transaction isolation level read uncommitted  
      insert into #MarginClients  
      select   
            Party_code = isnull(c2.party_code,''),   
            Cl_code = isnull(c1.Cl_code,''),  
            Short_name = isnull(c1.short_name,''),  
            Long_Name = isnull(c1.long_name,''),   
            Branch_Cd = isnull(c1.branch_cd,''),   
            Family = isnull(c1.family,''),   
            sub_broker=isnull(c1.sub_broker,''),  
            Trader=isnull(c1.trader,''),  
            Approver=isnull(c5.approver,'')  
      from  
            client1 c1 (nolock),  
            client2 c2 (nolock),  
            client5 c5 (nolock)  
      where  
            c1.cl_code = c2.cl_code  
            and c5.cl_code = c1.cl_code  
  
  
---------------------------------------  
-- FETCHING CLIENT COLLATERAL  
---------------------------------------  
  
  
Create Table #MarginCollateral  
(  
      Party_code varchar(10),  
      Cash money,  
      NonCash money,  
      ActCash money,  
      ActNonCash money,  
      EffectiveColl money,  
      TotalFD money,  
      TotalBG money,  
      TotalSec money  
)  
  
  
            set transaction isolation level read uncommitted  
            Insert into #MarginCollateral    
            select   
            a.party_code,  
            cash = isnull(a.orgcash,0),   
            noncash=isnull(a.orgnoncash,0),    
            actcash = isnull(a.cash,0),   
            actnoncash=isnull(a.noncash,0),    
            effectivecoll = isnull(a.effectivecoll,0),  
            totalfd = isnull(a.totalfd,0),  
            totalbg = isnull(a.totalbg,0),  
            totalsec = isnull(a.totalsec,0)    
            from   
            msajag.dbo.collateral a,   
            #MarginClients MC (nolock)   
            where a.exchange = 'NCE'    
            and a.segment like 'FUT%'    
            and a.party_code = MC.Party_Code  
            and a.trans_date like @MarginDate + '%'    
                
  
  
---------------------------------------  
-- FETCHING CLIENT BILL  
---------------------------------------  
  
  
Create Table #MarginBill  
(  
      Party_code varchar(10),  
      BillAmount money  
)  
  
                    
  set transaction isolation level read uncommitted  
  insert into #MarginBill  
  select   
        a.party_code,  
        amount=isnull(sum((case when a.sell_buy=2 then isnull(a.amount,0) else (0-isnull(a.amount,0)) end)),0)    
  from   
        foaccbill a (Nolock) ,  
        #MarginClients MC (Nolock)  
  where 
        billdate like @MarginDate + '%'      
        And a.party_code = MC.Party_Code  
  group by 
        a.party_code      
    
  
  
---------------------------------------  
-- FETCHING CLIENT LEDGER  
---------------------------------------  
  
Declare @yrStartDate Datetime  
  
Select   
@yrStartDate = SDTCUR   
from   
	ACCOUNTNCE.DBO.parameter  
where   
@MarginDate BETWEEN SDTCUR AND LDTCUR  

  
  
  
Create Table #MarginLedger  
(  
      Party_code varchar(10),  
      LedgerAmount money  
)  
  
  set transaction isolation level read uncommitted  
  insert into #MarginLedger  
  select Cltcode, LedgerAmount = IsNull(sum( case when upper(led.drcr) = 'C' then led.vamt else -led.Vamt end), 0)    
  from  
  (  
              select             
                    a.CltCode, a.Drcr, sum(a.vamt) Vamt  
              from             
                    ACCOUNTNCE.DBO.Ledger a  (nolock),  
                    #MarginClients LC                       
              where             
                    a.CltCode = LC.Party_code  
                    and a.vdt <= @Margindate +' 23:59:59'     
                    and a.Vdt >= @yrStartDate  
              Group By             
                    a.CltCode,a.DrcR    
  ) led  
  Group by led.Cltcode  


  
---------------------------------------  
-- FETCHING SPAN MARGINS  
---------------------------------------  
  
   
Create Table #MarginSPan  
(  
      Party_code varchar(10),  
      MarginAmount money,  
      MtmMargin money,  
      SpanReq money,  
      NetOptValue money  
)  
  
            set transaction isolation level read uncommitted  
            insert into #MarginSpan  
            Select   
            MC.Party_code,  
            MarginAmount = isnull(B.marginamount,0),  
            MtmMargin = isnull(b.mtmmargin,0),  
            SpanReq = 0,  
            NetOptValue = 0  
            from  
            #MarginClients MC (nolock)  
            left outer Join  
                  (  
                        SELECT   
                              a.Party_Code,   
                              MarginAmount = sum(isnull(a.pspanmargin,0)),  
                              MtmMargin = sum(isnull(a.MToM,0))  
                        from   
                              foMarginNew a (nolock),  
                              #MarginClients LC (nolock)  
                        where   
                              a.Cl_type like  'C%'  
                              and a.Party_code = LC.Party_Code  
                              and MDate like @MarginDate + '%'  
                        group by   
                              a.Party_code  
                  ) B  
               on   
               (  
                     b.party_code = MC.Party_code  
                )  
              
---------------------------------------  
-- FETCHING TURNOVER  
---------------------------------------  
  
   
Create Table #MarginTurnover  
(  
      Party_code varchar(10),  
      FuturesTurnover money,  
      OptionTurnover money,  
      ExerciseTurnover money  
)  
  
  

  set transaction isolation level read uncommitted  
  insert into #MarginTurnover  
  Select   
  Party_Code,  
  FuturesTurnover = sum(FutValue),  
  OptionTurnover =   
            sum  (  
                    case when @priceflag =  'Strike_Price + Premium' then OptValue1  
                           when @priceflag = 'Premium'  then OptValue2  
                           when @priceflag =  'Strike_Price'  then OptValue3  
                    else   
                          0   
                    end  
              ),  
  ExerciseTurnover =   
          sum    (  
                    case when @priceflag =  'Strike_Price + Premium'  then ExValue1  
                           when @priceflag = 'Premium'  then ExValue2  
                           when @priceflag =  'Strike_Price'   then ExValue3  
                    else   
                          0   
                    end  
              )      
  from        
        (  
              select   
                    a.party_code,    
                    FutValue = (case when left(a.inst_type,3) = 'FUT' then (case when auctionpart <> 'CA'  then sum((Strike_Price+Price)* TradeQty) else 0 end) else 0 end),  
                    OptValue1  =  case when auctionpart Not in ('CA','EA') and left(a.inst_type,3) = 'OPT'   then sum((Strike_Price+Price)* TradeQty) else 0 end,  
                    OptValue2 =  case when auctionpart Not in ('CA','EA') and left(a.inst_type,3) = 'OPT'   then sum((Price)* TradeQty) else 0 end,  
                    OptValue3 =  case when auctionpart Not in ('CA','EA') and left(a.inst_type,3) = 'OPT'   then sum((Strike_Price)* TradeQty) else 0 end,  
                    ExValue1  =  case when auctionpart = 'EA'  and left(a.inst_type,3) = 'OPT'  then sum((Strike_Price+Price)* TradeQty) else 0 end,  
                    ExValue2 =  case when auctionpart = 'EA'  and left(a.inst_type,3) = 'OPT' then sum((Price)* TradeQty) else 0 end,  
                    ExValue3 =  case when auctionpart = 'EA'  and left(a.inst_type,3) = 'OPT' then sum((Strike_Price)* TradeQty) else 0 end  
              from  
                    FoSettlement A (nolock),   
                    #MarginClients MC (nolock)  
              where   
                    a.sauda_date like @MarginDate + '%'  
                    and a.party_code = MC.Party_code  
              group by A.Party_code, left(a.inst_type, 3), a.auctionpart  
        )      Turn  
  group by Turn.Party_code  


  
  
---------------------------------------  
-- FETCHING BILLDETAILS  
---------------------------------------  
Create Table #MarginBillDetails  
(  
      Party_code varchar(10),   
      mtmamount Money,  
      expirymtmamount Money,   
      premiumamount Money,   
      exallocamount Money,   
      brokerage Money,    
      service_tax Money,  
      turn_tax Money,    
      sebi_tax Money,  
      stampduty Money,  
      insurance_charge Money,   
      other_charge Money,  
      expirybrok Money,  
      expiryservice_tax Money,   
      cfbrok Money,   
      cfsertax Money,  
      cfcharge Money,  
      clearingcharge Money   
)  
  
  
    set transaction isolation level read uncommitted  
    insert into #MarginBillDetails  
    Select
	a.Party_code,
	mtmamount = sum(Case When Inst_Type Like 'FUT%' And AuctionPart <> 'EA' then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT else 0 end),
	expirymtmamount = sum(Case When Inst_Type Like 'FUT%' And AuctionPart = 'EA' then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT else 0 end),
	premiumamount = sum(Case When Inst_Type Like 'OPT%' And AuctionPart <> 'EA' then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT else 0 end),
	exallocamount = sum(Case When Inst_Type Like 'OPT%' And AuctionPart = 'EA' then SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT else 0 end),
	brokerage = sum(case when AuctionPart <> 'EA' then PbrokAmt+SBrokAmt else 0 end),
	service_tax = sum(case when AuctionPart <> 'EA' then Service_Tax else 0 end ),
	turn_tax = sum(turn_tax),
	sebi_tax = sum(sebi_tax),
	stampduty = sum(Broker_note),
	insurance_charge = sum(Ins_Chrg),
	other_charge = sum(Other_Chrg),
	expirybrok = sum(case when AuctionPart = 'EA' then PbrokAmt+SBrokAmt else 0 end),
	expiryservice_tax = sum(case when AuctionPart = 'EA' then Service_Tax else 0 end ),
        cfbrok = 0,
        cfsertax = 0,
        cfCharge = 0,
        ClearingCharge = 0
    From  
	 FoBillValan  a (nolock),   
         #MarginClients MC (Nolock)     
    Where
	Sauda_Date like @MarginDate + '%'
	And TradeType = 'BT'
	And a.Party_code = MC.Party_code 
   Group By
	a.Party_code

---------------------------------------  
-- FETCHING EXPOSURE VALUES
---------------------------------------  

create table #FORISKMGMTEXPOSURE_TBL
(
	MarginDate Datetime,
	Party_Code varchar(10),
	Inst_type varchar(7),
	Symbol varchar(12),
	ExpiryDate datetime,
	Strike_Pirce money,
	Option_Type varchar(2),
	Cl_Rate money,
	PQty int,
	Sqty int,
	Cl_Date datetime
)

set transaction isolation level read uncommitted
Insert into #FORISKMGMTEXPOSURE_TBL
Select 
	@MarginDate,F.Party_Code,
	F.Inst_Type,F.Symbol,F.ExpiryDate,F.Strike_Price,F.Option_Type,
	C.Cl_Rate,
	Pqty = Sum(Case When Sell_Buy = 1 then tradeqty else 0 end),
	Sqty = Sum(Case When Sell_Buy = 2 then tradeqty else 0 end),
	MarginDt = Left(Getdate(),11)
From
	FoSettlement F (nolock), FoClosing C (nolock), #MarginClients MC (nolock)
Where
	f.Party_code = Mc.Party_Code
	and sauda_date <= @MarginDate +' 23:59:00' 
	and f.expirydate >= @MarginDate +' 23:59:00'
	and f.inst_type = c .inst_type
	and f.symbol = c.symbol
	and left(f.expirydate,11) = left(c.expirydate,11)
	and f.strike_price = c.strike_price
	and f.option_type = c.option_type
Group By
	F.Party_code,F.Inst_Type,F.Symbol,F.ExpiryDate,F.Strike_Price,
	F.Option_Type,C.Cl_Rate



Create Table #TmpExposure
(
      Party_Code varchar(10),
      Symbol varchar(12),
      longfut money,
      shortfut money,
      shortopt money,
      longopt money,
      callopt money,
      putopt money      
)



            set transaction isolation level read uncommitted
            Insert into #TmpExposure
		 select a.party_code,a.Symbol,     
                  longfut =  isnull(Sum( Case when Postype = '+' and Inst_type Like 'FUT'    
                                   Then (exposurevalue) Else 0 End), 0),   
                  shortfut = isnull(Sum( Case When postype = '-' and inst_type like 'FUT%'     
                                    Then (exposurevalue) Else 0 End), 0),  
                  shortopt = isnull(Sum( Case When postype = '-' and inst_type like 'OPT%'    
                                    Then (exposurevalue) Else 0 End), 0),   
                  longopt =  isnull(Sum( Case When postype = '+' and inst_type like 'OPT%'     
                                    Then (exposurevalue) Else 0 End), 0),  
                  Callopt =  IsNull(Sum( Case When inst_type like 'OPT%' and option_type like 'C%'    
                                    Then (exposurevalue) Else 0 End), 0),    
                  Putopt =   isnull(Sum ( Case When inst_type like 'OPT%' and option_type like 'P%'     
                                    Then (exposurevalue) Else 0 End) ,0)   
            from 
                  (
                        SELECT 
                              T.PARTY_CODE,
                              T.symbol,
                              inst_type = LEFT(T.INST_TYPE,3),
                              option_type=left(T.option_type,1),  
                              EXPOSUREVALUE=SUM(T.PQTY*T.CL_RATE-T.SQTY*T.CL_RATE),  
                              NET_QTY = SUM(T.PQTY-T.SQTY),  
                              Postype = (case when sum(T.pqty-T.sqty) > 0   
                                                  then '+'   
                                                  else '-'  
                                                    end)  
                        FROM 
                              #FORISKMGMTEXPOSURE_TBL  T (nolock),
                              #MarginClients MC (nolock)
                        Where 
                              T.Party_Code = MC.Party_Code
                        GROUP BY 
                              T.PARTY_CODE,
                              T.symbol,
                              LEFT(T.INST_TYPE,3),
                              left(T.option_type,1)  
                        having sum(T.pqty-T.sqty) <> 0  
                  ) A  
            Group by 
            a.Party_code, 
            A.Symbol    




Declare @@PartyCur cursor
Declare @@ExpCur cursor
Declare @@UniqParty varchar(10)
Declare @@PartyCode varchar(10)
Declare @@Symbol varchar(12)
Declare @@LongFut money
Declare @@ShortFut money
Declare @@LongOpt money
Declare @@ShortOpt money
Declare @@CallOpt money
Declare @@PutOpt money

Declare @@ExpLongFut money
Declare @@ExpShortFut money
Declare @@ExpLongOpt money
Declare @@ExpShortOpt money
Declare @@hedgeexposure money
Declare @@netfuturesexposure money
Declare @@netcallexposure money
Declare @@netputexposure money

Create Table #MarginExposure
(  
      Party_code varchar(10),   
      long_futuresexposure money, 
      short_futuresexposure money,
      short_optionsexposure money,
      long_optionsexposure money,
      hedge_optionsexposure money
)  


Set @@PartyCur = Cursor for

      Select 
            Distinct Party_Code 
      from 
            #TmpExposure
      where 
            longfut <> 0
            or shortfut <> 0
            or shortopt <> 0
            or longopt <> 0
            or callopt <> 0
            or putopt <> 0

Open @@PartyCur
Fetch Next From @@PartyCur into @@UniqParty
 
While @@Fetch_Status = 0
begin

      Set @@ExpLongFut = 0
      Set @@ExpShortFut = 0
      Set @@ExpLongOpt = 0
      Set @@ExpShortOpt = 0
      Set @@hedgeexposure = 0
      Set @@netfuturesexposure  = 0
      Set @@netcallexposure = 0
      Set @@netputexposure = 0

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
	Set @@ExpCur = Cursor For                      
	Select * from #TmpExposure where Party_Code = @@UniqParty
	Open @@ExpCur
	Fetch next from @@ExpCur into @@PartyCode, @@Symbol, @@LongFut, @@ShortFut, @@LongOpt,
	@@ShortOpt, @@CallOpt, @@PutOpt
                                  
            While @@Fetch_Status = 0                      
            Begin                      
                              

                  Set @@ExpLongFut = @@ExpLongFut + @@LongFut
                  Set @@ExpShortFut = @@ExpShortFut + @@ShortFut
                  Set @@ExpLongOpt = @@ExpLongOpt + @@LongOpt
                  Set @@ExpShortOpt = @@ExpShortOpt + @@ShortOpt
                    
                        If @@PutOpt < 0
                        BEGIN
                              If Abs(@@LongFut) > @@PutOpt
                              begin
                                      SET @@netfuturesexposure = @@netfuturesexposure + @@longfut + @@putopt
                              END
                              Else
                              BEGIN
                                      SET @@netfuturesexposure = @@netfuturesexposure
                              End
                        End

                    
                        If @@callopt > 0
                        BEGIN
                              If Abs(@@shortfut) > @@callopt
                              BEGIN
                                      sET @@netfuturesexposure = @@netfuturesexposure + @@shortfut + @@callopt
                              END
                              Else
                              BEGIN
                                      SET @@netfuturesexposure = @@netfuturesexposure
                              End
                        End                        
                        
                        If @@netfuturesexposure > 0
                        BEGIN
                              If @@callopt < 0
                              BEGIN
                                    If Abs(@@callopt) > @@netfuturesexposure
                                    BEGIN
                                          SET @@netcallexposure = @@netcallexposure + @@netfuturesexposure + @@callopt
                                    END
                                    Else
                                    BEGIN
                                          set @@netcallexposure = @@netcallexposure
                                    End
                              End
                        END
                        Else
                        BEGIN
                              If @@netfuturesexposure < 0
                              begin
                                    If @@callopt < 0
                                    begin
                                          set @@netcallexposure = @@netcallexposure + @@callopt
                                    End
                              End
                        End

                          
                        If @@callopt = 0
                        BEGIN
                              SET @@netcallexposure = @@netcallexposure
                        End
                                                
                                                
                        If @@netfuturesexposure < 0
                        BEGIN
                              If @@putopt > 0
                              BEGIN
                                    If Abs(@@putopt) > Abs(@@netfuturesexposure)
                                    begin
                                          set @@netputexposure = @@netputexposure + @@netfuturesexposure + @@putopt
                                    End
                                    Else
                                    begin
                                          Set @@netputexposure = @@netputexposure
                                    End
                              End
                        END
                        Else
                        BEGIN
                              If @@netfuturesexposure > 0
                              begin
                                    If @@putopt > 0
                                    begin
                                          set @@netputexposure = @@netputexposure + @@putopt
                                    End
                              End
                        END                        
                        
                        If @@putopt = 0 
                        BEGIN
                            SET @@netputexposure = @@netputexposure
                        End                        

                                  
                  Fetch next from @@ExpCur into @@PartyCode, @@Symbol, @@LongFut, @@ShortFut, @@LongOpt, @@ShortOpt, @@CallOpt, @@PutOpt
            end                   
            Close @@ExpCur                      
            DeAllocate @@ExpCur     



                        Set @@hedgeexposure = @@netfuturesexposure + @@netcallexposure + @@netputexposure


                        Insert into #MarginExposure 
                        Values
                        (
                              @@PartyCode,
                              @@ExpLongFut,
                              @@ExpShortFut,
                              @@ExpShortOpt,
                              @@ExpLongOpt,
                              @@hedgeexposure
                        )
      

      Fetch Next From @@PartyCur into @@UniqParty
End
Close @@PartyCur
Deallocate @@PartyCur
---------------------------------------  
-- AND FINALLY  
---------------------------------------  
  
  
/****** Object:  Index Cltcode on Table [dbo].[acmast]    Script Date: 08/23/2005 22:08:09 ******/  
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginClients]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginBillDetails]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginBill]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginLedger]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginCollateral]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginSpan]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginTurnover]([party_code])   
 CREATE  INDEX [Cltcode] ON [dbo].[#MarginExposure]([party_code])     
  
                        set transaction isolation level read uncommitted  
                        Select   
                              Party_code = a.party_code,  
                              Short_name = a.short_name,  
                              Long_Name = a.long_name,  
                              Branch_Cd = a.branch_cd,  
                              Family = a.family,  
                              Sub_Broker = a.sub_broker,  
                              Trader = a.trader,  
                              CustomerExec = a.Approver,  
                              MarginDate = @MarginDate,  
                                
                              dailymtmamt = isnull(B.MtmAmount,0),  
                              finaldaymtmamt = isnull(b.expirymtmamount,0),  
                              premiumamt = isnull(b.premiumamount,0),  
                              exallocamt = isnull(b.exallocamount,0),  
                              brokerage = isnull(b.brokerage,0),  
                              servicetax = isnull(b.service_tax,0),  
                              turntax = isnull(b.turn_tax,0),  
                              sebitax = isnull(b.sebi_tax,0),  
				insurancecharge = isnull(b.insurance_charge,0),  
				stampduty = isnull(b.stampDuty,0),  
				othercharges = isnull(b.other_charge,0),  
				expirybrokerage = isnull(b.expirybrok,0),  
				expiryservicetax = isnull(b.expiryservice_tax,0),  
				cfbrokerage = isnull(b.cfbrok,0),  
				cfservicetax = isnull(b.cfsertax,0),  
				cfcharges = isnull(b.cfcharge,0),  
				clearingcharges = isnull(b.clearingcharge,0),  
                                
                              billamount = isnull(c.billamount,0),  
                                
                              ledgeramount = isnull(d.ledgeramount,0),  
                                
                              cash_coll = isnull(e.cash,0),  
                              noncash_coll = isnull(e.noncash,0),  
                              effectivecoll = isnull(e.effectivecoll,0),  
                              haircutcash_coll = isnull(e.actcash,0),  
                              haircutnoncash_coll = isnull(e.actnoncash,0),  
                              totalfd = isnull(e.totalfd,0),  
                              totalbg = isnull(e.totalbg,0),  
                              totalsecurities = isnull(e.totalsec,0),  
                                
                              initialmargin_MG13 = isnull(f.marginamount,0),  
                              MTOMmargin_MG13 = isnull(f.mtmmargin,0),  
                              spanmargin = isnull(f.spanreq,0),  
                                
                              long_futuresexposure = isnull(h.long_futuresexposure,0),  
                              short_futuresexposure = isnull(h.short_futuresexposure,0),  
                              futuresexposure = 0,  
                              long_optionsexposure = isnull(h.long_optionsexposure,0),  
                              short_optionsexposure = isnull(h.short_optionsexposure,0),  
                              optionsexposure = 0,  
                              hedgeexposure = isnull(h.hedge_Optionsexposure,0),  
                              optionsMTOM = isnull(f.netoptvalue,0),  
                                
                              futuresturnover = isnull(g.FuturesTurnover,0),  
                              optionsturnover = isnull(g.optionturnover,0),  
                              exallocturnover = isnull(g.exerciseturnover,0),  
                                
                              bsecm_exposure = 0,  
                              nsecm_exposure = 0,  
                              dummy1 = 0,  
                              dummy2= 0,  
                              lst_update_dt = getdate()  
                       into #RMS_MarginFinal                    
                       from   
                        #MarginClients a (nolock)  
                        left outer join   
                              #MarginBillDetails b (nolock)  
                                    on (a.Party_code = b.Party_Code)  
                        left outer join   
                              #MarginBill c (nolock)  
                                    on (a.Party_code = c.Party_Code)  
                        left outer join   
                              #MarginLedger d (nolock)  
                                    on (a.Party_code = d.Party_Code)  
                        left outer join   
                              #MarginCollateral e (nolock)  
                                    on (a.Party_code = e.Party_Code)  
                        left outer join   
                              #MarginSpan f (nolock)  
                                    on (a.Party_code = f.Party_Code)  
                        left outer join   
                              #MarginTurnover g (nolock)  
                                    on (a.Party_code = g.Party_Code)  
                       left outer join   
                              #MarginExposure h (nolock)  
                                    on (a.Party_code = h.Party_Code)  
                          
  
  
Drop table #MarginClients   
Drop Table #MarginBillDetails  
Drop table #MarginBill   
Drop table #MarginLedger  
Drop table #MarginCollateral  
Drop table #MarginSpan  
Drop table #MarginTurnover  
Drop Table #MarginExposure
Drop Table #TmpExposure  
  


      Delete from FoRiskManagement_tbl where MarginDate like @MarginDate + '%'  
      Insert into FoRiskManagement_Tbl  
      select 
            * 
      from 
            #RMS_MarginFinal  
      where
            billamount <> 0
            or brokerage <> 0
            or bsecm_exposure <> 0
            or cash_coll <> 0
            or cfbrokerage <> 0
            or cfcharges <> 0
            or cfservicetax <> 0
            or clearingcharges <> 0
            or dailymtmamt <> 0
            or effectivecoll <> 0
            or exallocamt <> 0
            or exallocturnover <> 0
            or expirybrokerage <> 0
            or expiryservicetax <> 0
            or finaldaymtmamt <> 0
            or futuresexposure <> 0
            or futuresturnover <> 0
            or haircutcash_coll <> 0
            or haircutnoncash_coll <> 0
            or hedgeexposure <> 0
            or initialmargin_MG13 <> 0
            or insurancecharge <> 0
            or ledgeramount <> 0
            or long_futuresexposure <> 0
            or long_optionsexposure <> 0
            or MTOMmargin_MG13 <> 0
            or noncash_coll <> 0
            or nsecm_exposure <> 0
            or optionsexposure <> 0
            or optionsMTOM <> 0
            or optionsturnover <> 0
            or othercharges <> 0
            or premiumamt <> 0
            or sebitax <> 0
            or servicetax <> 0
            or short_futuresexposure <> 0
            or short_optionsexposure <> 0
            or spanmargin <> 0
            or stampduty <> 0
            or totalbg <> 0
            or totalfd <> 0
            or totalsecurities <> 0
            or turntax <> 0


drop table #RMS_MarginFinal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accallpartyledvoucherdisp
-- --------------------------------------------------
/* Report : Allpartyledger           
    Filename :  Voucherdisp.Asp          
*/          
/* Displays Details Of A Voucher For A Party For A Date */          
--exec Rpt_accallpartyledvoucherdisp '3', '200400001901', 'May  5 2004', '41', '', '10100063'        
CREATE Procedure [dbo].[Rpt_accallpartyledvoucherdisp]          
@Vtyp Smallint ,          
@Vno Varchar (12),          
@Vdt Varchar(12) ,          
@Booktype Varchar(2),          
@Branch Varchar(10),          
@Cltcode Varchar(10)          
          
As          
If @Branch = 'Full' Or @Branch = '' Or @Branch = '%'          
Begin          
 Select  Vamt , L.Vtyp , L.Vno , L.Vdt , L.Drcr , Cltcode, Acname,  L.Lno , Drcrflag = (Case When Upper(L.Drcr) = 'D' Then 'Dr' Else 'Cr' End) ,           
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,           
 Dddt  =  Convert(Varchar, Dddt, 103)            
 From ACCOUNTNCE.DBO.Ledger L Left Outer Join ACCOUNTNCE.DBO.Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno       
--and L.Lno = L1.Lno          
 Where L.Vtyp = @Vtyp          
 And L.Vno = @Vno            
 And L.Vdt Like  Ltrim(Vdt) + '%'          
 And L.Booktype = @Booktype --and L.Cltcode = @Cltcode          
 Order By L.Drcr Desc , L.Lno           
End          
Else          
Begin          
 Select  Vamt = L2.Camt , L.Vtyp , L2.Vno , Vdt , L2.Drcr , L2.Cltcode, A.Acname, L2.Lno ,           
 Drcrflag = (Case When Upper(L2.Drcr) = 'D' Then 'Dr' Else 'Cr' End),           
 Nar = Narration, Bank = Isnull(Bnkname, ''), Branch = Isnull(Brnname, '') , Isnull(Dd, '') Dd  , Isnull(Ddno, '') Ddno,           
 Dddt  =  Convert(Varchar, Dddt, 103)            
 From ACCOUNTNCE.DBO.Ledger L Left Outer Join ACCOUNTNCE.DBO.Ledger1 L1 On L1.Vtyp = L.Vtyp And L1.Booktype = L.Booktype And L1.Vno = L.Vno,       
--and L.Lno = L1.Lno,          
 ACCOUNTNCE.DBO.Ledger2 L2 Left Outer Join ACCOUNTNCE.DBO.Acmast A On L2.Cltcode = A.Cltcode          
 Where L.Vtyp = @Vtyp          
 And L.Vno = @Vno            
 And L.Vdt Like  Ltrim(Vdt) + '%'          
 And L.Booktype = @Booktype --and L.Cltcode = @Cltcode          
 And L.Vtyp = L2.Vtype And L.Booktype = L2.Booktype And L.Vno = L2.Vno And L.Lno = L2.Lno          
        And Costcode = (Select Costcode From ACCOUNTNCE.DBO.Costmast Where Costname = Rtrim(@Branch))          
 Order By L2.Drcr Desc , L2.Lno           
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_AccAllPartyledvoucherdisp_New
-- --------------------------------------------------
CREATE Procedure [dbo].[rpt_AccAllPartyledvoucherdisp_New]    
@vtyp smallint,    
@vno varchar(12),    
@vdt varchar(12) ,    
@booktype varchar(2),    
@branch varchar(10),    
@cltcode varchar(10),    
@ReportPara varchar(5)    
    
AS    
    
    
--*** rpt_accallpartyledvoucherdisp ***--    
If @ReportPara = 'NAR'    
 Begin    
  Select nar=isnull((select l3.narr from ACCOUNTNCE.DBO.ledger3 l3     
   Where L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND l.booktype = l3.booktype and l3.naratno=0),'')    
  From ACCOUNTNCE.DBO.ledger l    
  Where vtyp=@vtyp     
  and vno=@vno    
  and vdt like ltrim(@vdt) + '%'    
  and l.BookType = @booktype    
 End    
    
    
If @ReportPara = 'VOU' And (@branch = 'full' or @branch= '' or @branch = '%')    
 Begin    
  Select  vamt ,l.vtyp , l.vno , l.vdt , l.drcr , cltcode,acname,  l.lno ,drcrflag = (case when upper(l.drcr)='D' then 'Dr' else 'Cr' end) ,     
  nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,     
  dddt  =  convert(varchar,dddt,103)      
  From ACCOUNTNCE.DBO.ledger l left outer join ACCOUNTNCE.DBO.ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno    
  Where l.vtyp=@vtyp    
  and l.vno= @vno      
  and l.vdt like  ltrim(vdt) + '%'    
  and l.BookType = @booktype and l.cltcode = @cltcode    
  Order By l.drcr desc , l.lno     
 End    
Else If @ReportPara = 'VOU'   
 Begin    
  Select  vamt=l2.camt ,l.vtyp , l2.vno , vdt , l2.drcr , l2.cltcode, a.acname, l2.lno ,     
  drcrflag = (case when upper(l2.drcr)='D' then 'Dr' else 'Cr' end),     
  nar=narration, bank = isnull(bnkname,''), branch = isnull(brnname,'') , isnull(dd,'') dd  ,isnull(ddno,'') ddno,     
  dddt  =  convert(varchar,dddt,103)      
  From ACCOUNTNCE.DBO.ledger l left outer join ACCOUNTNCE.DBO.ledger1 l1 on l1.vtyp = l.vtyp and l1.booktype = l.booktype and l1.vno = l.vno and l.lno = l1.lno,    
  ACCOUNTNCE.DBO.ledger2 l2 left outer join ACCOUNTNCE.DBO.acmast a on l2.cltcode = a.cltcode    
  Where l.vtyp=@vtyp    
  and l.vno= @vno      
  and l.vdt like  ltrim(vdt) + '%'    
  and l.BookType = @booktype and l.cltcode = @cltcode    
  and l.vtyp = l2.vtype and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno    
         and costcode = (select costcode from ACCOUNTNCE.DBO.costmast where costname = rtrim(@branch))    
  Order By l2.drcr desc , l2.lno     
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accbalsheetchkrecords
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_accbalsheetchkrecords    Script Date: 01/15/2005 1:25:32 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_accbalsheetchkrecords    Script Date: 12/16/2003 2:31:40 Pm ******/  
CREATE Procedure [dbo].[Rpt_accbalsheetchkrecords]  
  
@incomeorexp Char(1),  
@statusid Char(15),  
@statuname Char(15)  
  
  
  
As  
  
  
Select Count(*) From ACCOUNTNCE.DBO.acmast A, ACCOUNTNCE.DBO.ledger L   
Where A.cltcode=l.cltcode And A.grpcode Like @incomeorexp+ '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acccompanyname
-- --------------------------------------------------
Create Proc Rpt_acccompanyname
@Sharedb Varchar(15)
As
Select Companyname From Multicompany Where Sharedb = @Sharedb

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accpandl
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 01/15/2005 1:26:21 Pm ******/      
      
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 12/16/2003 2:31:41 Pm ******/      
      
      
/****** Object:  Stored Procedure Dbo.rpt_accpandl    Script Date: 06/26/2002 6:15:44 Pm ******/      
/* Ch By Mousami On 15 Apr 2002       
     Added Branch Login Effect */      
      
      
CREATE Procedure  [dbo].[Rpt_accpandl]      
      
@fromdt Varchar(11),      
@todt Varchar(11),      
@statusid Varchar(15),      
@statusname Varchar(25)      
      
      
As      
      
If @statusid='broker'      
Begin      
 Select G1.grpname,g1.grpcode,       
 Vamt=isnull(( Select Sum(case When Drcr ='c' Then Vamt*-1 Else Vamt End )from ACCOUNTNCE.DBO.ledger L ,ACCOUNTNCE.DBO.AcMast A ,ACCOUNTNCE.DBO.grpmast G       
       Where L.cltcode = A.cltcode And G.grpcode =g1.grpcode And L.vdt >= @fromdt + ' 00:00:00'      
       And L.vdt <=@todt + ' 23:59:59' And Substring(a.grpcode,1,1) = Substring(g.grpcode,1,1)),0)       
 From ACCOUNTNCE.DBO.grpmast G1       
 Where G1.grpcode='n0000000000' Or  G1.grpcode='x0000000000'       
 Order By G1.grpcode      
End      
Else      
Begin      
 Select G1.grpname,g1.grpcode,       
 Vamt=isnull(( Select Sum(case When L.drcr ='c' Then Vamt*-1 Else Vamt End )from      
  ACCOUNTNCE.DBO.ledger L ,ACCOUNTNCE.DBO.AcMast A ,ACCOUNTNCE.DBO.grpmast G ,  ACCOUNTNCE.DBO.ledger2_Report L2 ,  ACCOUNTNCE.DBO.costmast C , ACCOUNTNCE.DBO.category C1      
   Where L.cltcode = A.cltcode And G.grpcode =g1.grpcode And L.vdt >= @fromdt + ' 00:00:00'      
     And L.vdt <=@todt  + ' 23:59:59'       
     And L.vno=l2.vno And L.vtyp=l2.vtype And L.lno=l2.lno And L.drcr=l2.drcr      
 And C.costcode=l2.costcode      
 And C.catcode=c1.catcode      
 And L.booktype=l2.booktype      
 And C1.category='branch'      
    And C.costname=@statusname      
  And Substring(a.grpcode,1,1) = Substring(g.grpcode,1,1)),0)       
  From ACCOUNTNCE.DBO.grpmast G1       
  Where G1.grpcode='n0000000000' Or  G1.grpcode='x0000000000'       
  Order By G1.grpcode      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------
/*this Procedure Gives Us The Discription For Supplied Vtype*/  
CREATE Procedure   
[dbo].[Rpt_accvdesc]   
@Vtype Smallint  
As  
Select Vdesc From ACCOUNTNCE.DBO.Vmast Where   
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ADMIN_LOG
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ADMIN_LOG]  
(  
 @LOGTYPE VARCHAR(20),  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @REPORTORDER INT,  
 @TXTNAME VARCHAR(25)  
)  
AS  
  
/*  
POSSIBLE VALUES OF @LOGTYPE   
   
 MENURIGHTS  
 CATEGORY  
 ADMIN_USER  
 USERLOG  
  
*/  
  
IF @LOGTYPE ='MENURIGHTS'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - REPORT NAME + DATE  
  2 - CATEGORY + DATE  
 */  	
 SELECT   
  REPORTORDER =   
   CASE WHEN @REPORTORDER = 1 THEN REPORTNAME ELSE RIGHT(CATEGORYNAME,LEN(CATEGORYNAME)-1) END  
   + CONVERT(VARCHAR,YEAR(CREATEDON)) + CONVERT(VARCHAR,MONTH(CREATEDON)) + CONVERT(VARCHAR,DAY(CREATEDON)) +  CONVERT(VARCHAR,CREATEDON,108),  
  REPORTNAME,  
  LOGINCATEGORY,  
  CATEGORYNAME,  
  EDITFLAG =  ISNULL(CASE   
    WHEN EDIT_FLAG ='D' THEN 'CATEGORY DELETED'   
    WHEN EDIT_FLAG ='A' THEN 'CATEGORY ADDEDED'  
    WHEN EDIT_FLAG ='E' THEN  
    CASE WHEN LEFT(CATEGORYNAME,1) ='-'   
     THEN 'RIGHTS REMOVED'  
     ELSE 'RIGHTS ADDED'  
     END  
       END,'') ,  
  CREATEDBY,  
  CREATEDON =  CONVERT(VARCHAR,CREATEDON,109),  
  MACHINEIP  
 FROM  
 (  
  SELECT   
   REPORTNAME = TBLREPORTS.FLDREPORTNAME,  
   LOGINCATEGORY = TBLADMIN.FLDNAME,  
   CATEGORYNAME = LTRIM(RTRIM(DBO.FUN_GET_TBLREPORT (FLDCATEGORYCODE_OLD,FLDCATEGORYCODE_NEW))),  
   EDIT_FLAG,  
   CREATEDBY = CREATED_BY,  
   CREATEDON = CREATED_ON,  
   MACHINEIP = MACHINE_IP  
  FROM  
   TBLCATMENU_LOG (NOLOCK),  
   TBLREPORTS (NOLOCK),  
   TBLADMIN (NOLOCK)  
  WHERE  
   TBLADMIN.FLDAUTO_ADMIN = FLDADMINAUTO  
   AND TBLCATMENU_LOG.FLDREPORTCODE = TBLREPORTS.FLDREPORTCODE  
   AND TBLCATMENU_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
 ) TBLLOG  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='CATEGORY'  
BEGIN  
 SELECT    
  REPORTORDER = FLDCATEGORYNAME +  
  + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) + CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) ,  
  FLDCATEGORYNAME,  
  FLDDESC ,  
  EDIT_FLAG = CASE WHEN EDIT_FLAG ='A' THEN 'ADDED' ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLCATEGORY_LOG (NOLOCK)   
 WHERE   
  CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDCATEGORYNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='REPORTLOG'  
BEGIN  
 SELECT   
  FLDREPORTNAME,FLDPATH,FLDTARGET,TB.FLDDESC,FLDGRPNAME,  
  FLDSTATUS,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLREPORTS_LOG TB, TBLREPORTGRP TG  
 WHERE   
  TB.FLDREPORTGRP =TG.FLDREPORTGRP  
  AND TB.FLDMENUGRP = TG.FLDMENUGRP  
  AND CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDREPORTNAME LIKE @TXTNAME + '%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='ADMIN_USER'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
 */  
 SELECT   
	REPORTORDER = FLDNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDNAME ELSE EDIT_FLAG END , 
	
  USERNAME=FLDNAME,FLDPASSWORD,COMPANY=FLDCOMPANY,  
  LOGINCATEGORY=FLDSTATUS,DESCRIPTION=FLDDESC,PASSWORD_EXP_DT = LEFT(PWD_EXPIRY_DATE,11),  
  MAXWRONGATTEMP_ALLOWD = FLDMAXATTEMPT,  
  USERSTATUS=CASE WHEN FLDUSERSTATUS =0 THEN 'ENABLED' ELSE 'DISABLED' END ,  
  ACCESSLVL= CASE WHEN FLDACCESSLVL ='F' THEN 'FREE ACCESS' ELSE 'LIMITED' END ,  
  IP_FILTER = FLDIPADD,  
  FIRST_LOGIN_FLAG= FLDFIRSTLOGIN,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')  
 FROM   
  TBLADMIN_LOG (NOLOCK)   
 WHERE  
   TBLADMIN_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='USERLOG'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
  
 */  
 SELECT   
  REPORTORDER = FLDUSERNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDUSERNAME ELSE EDIT_FLAG END ,  
  USERNAME=FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,  
  FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2, FLDPHONE1, FLDPHONE2,
  FLDCATEGORY,	
  PWDEXPIRYDAYS = ISNULL(B.FLDPWDEXPIRY,''),  
  PWDEXPIRY = ISNULL(B.FLDPWDEXPIRY,''),  
  MAXATTEMPT = ISNULL(B.FLDMAXATTEMPT,0),  
  USERSTATUSDB = CASE WHEN ISNULL(B.FLDSTATUS,0) =0 THEN 'ENABLED' WHEN B.FLDSTATUS = 1 THEN 'DISABLED' ELSE 'UNAUTHORISED' END ,   
  ATTEMPTCNT = ISNULL(B.FLDATTEMPTCNT,0),   
  LOGINFLAG = CASE WHEN ISNULL(B.FLDLOGINFLAG,0) = 0 THEN 'LOGGED OUT' ELSE 'LOGGED IN' END,   
  ACCESSLVL = CASE WHEN ISNULL(B.FLDACCESSLVL,'F') = 'F' THEN 'FREE ACCESS' ELSE 'LIMITED' END,   
  IPADD = ISNULL(B.FLDIPADD,''),   
  TIMEOUT = ISNULL(B.FLDTIMEOUT,0),   
  FIRSTLOGIN = CASE WHEN ISNULL(B.FLDFIRSTLOGIN,'N') = 'N' THEN 'NO' ELSE 'YES' END,   
  FORCELOGOUT = CASE WHEN ISNULL(B.FLDFORCELOGOUT,0) = 0 THEN 'ALLOW ACCESS' ELSE 'DO NOT ALLOW' END,   
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')   
 FROM   
  TBLPRADNYAUSERS_LOG A (NOLOCK)   
  LEFT OUTER JOIN TBLUSERCONTROLMASTER_JRNL B (NOLOCK) 
 ON   
  (B.FLDUSERID = A.FLDAUTO AND B.FLDUPDTDT = A.CREATED_ON)     
 WHERE  
   A.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDUSERNAME LIKE @TXTNAME+'%'   
 ORDER BY 1  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_AREALISTING
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_AREALISTING]
	(
    @FROMAREACODE VARCHAR(15),
	@TOAREACODE VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    if @FROMAREACODE = '' begin set @FROMAREACODE = '0'  end
    if @TOAREACODE = '' begin set @TOAREACODE = 'zzzzzz' end
    if @FROMBRANCH = '' begin set @FROMBRANCH = '0'  end
    if @TOBRANCH = '' begin set @TOBRANCH = 'zzzzzz' end

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			Areacode = UPPER(Areacode),
			Description = UPPER(Description),
			Branch_Code = UPPER(Branch_Code)

From 
    AREA

Where
    Areacode between @FROMAREACODE and @TOAREACODE
    AND Branch_Code between @FROMBRANCH and @TOBRANCH
    

Order by
		Areacode,Description,Branch_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BANKDETAILS
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_BANKDETAILS] 
	( 
	@PARTYCODE VARCHAR(10) 
	)

	--EXEC RPT_BANKDETAILS 'O123'
	
	AS
	
	SET NOCOUNT ON 
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT 
		BANKNAME = ISNULL(P.BANK_NAME,''),
		BRANCH = ISNULL(P.BRANCH_NAME,''),
		ACNUM = ISNULL(C.CLTDPID,''),
		ACTYPE = ISNULL(C.DEPOSITORY,'')
	FROM
		CLIENT4 C (NOLOCK)
			JOIN POBANK P (NOLOCK)
			ON (P.BANKID = C.BANKID)
	WHERE
		C.DEPOSITORY NOT IN ('CDSL','NSDL')
		AND C.PARTY_CODE = @PARTYCODE

------
UNION
------


	SELECT 
		BANKNAME = ISNULL(P.BANK_NAME,''),
		BRANCH = ISNULL(P.BRANCH_NAME,''),
		ACNUM = ISNULL(C.ACCNO,''),
		ACTYPE = ISNULL(C.ACCTYPE,'')
	FROM
		ACCOUNTNCE.DBO.MULTIBANKID C (NOLOCK)
			JOIN POBANK P (NOLOCK)
			ON (P.BANKID = C.BANKID)
	WHERE
		C.CLTCODE = @PARTYCODE

	ORDER BY 
		BANKNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_BillPrintingPlain
-- --------------------------------------------------

CREATE  PROC rpt_BillPrintingPlain
    
@fpartycode varchar(16),        
@tpartycode varchar(16),        
@fdatefrom  varchar(11),        
@tdatefrom  varchar(11),        
@statusid varchar(15),        
@statusname varchar(25),    
@strbranch varchar(12),    
@strsubbrokfrom varchar(12),    
@strsubbrokto varchar(12)        
        
                
AS                
                
SET TRANSACTION ISOLATION LEVEL  READ UNCOMMITTED    
    
if @strsubbrokto=''    
  begin    
      SET @strsubbrokto='ZZZZZZZZZZ'    
  end    
          
SELECT 

f.PARTY_CODE,                
f.INST_TYPE ,                
f.SYMBOL OrgSymbol,              
f.SYMBOL + Case When TradeType = 'BF' then ' (B-F)' else '' end  Symbol,                
convert(varchar(11),f.expirydate,109) expirydate,                
f.option_type ,                
f.strike_price ,                
cl_rate,                
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) > Sum(f.sqty) Then Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else 0 End Else 0 End Else Case When Sum(pqty) > 0 Then Sum(pamt)/Sum(pqty) Else          
            
 0 End End AS prate,              
 Case When TradeType = 'BF' Then Case When Sum(f.pqty) < Sum(f.sqty) Then Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else 0 End Else 0 End Else Case When Sum(sqty) > 0 Then Sum(samt)/Sum(sqty) Else          
            
 0 End End AS srate,              
billno,                
convert(varchar(11),SAUDA_DATE,103) SAUDA_DATE,                
                
pamt =  Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End,                
samt =  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End,                
service_tax = sum(f.service_tax ),                
sebi_tax    = Sum(f.sebi_tax),                
turn_tax    = Sum(f.turn_tax),                
broker_note = Sum(f.broker_note),                
Insurance_Chrg  = Sum(f.ins_chrg),                
other_chrg  = Sum(f.other_chrg) ,              
TradeType =  Case When TradeType = 'BF' then 1 else 2 end ,  
Branch_Cd ,
Sum(SBrokAmt + PBrokAmt) TotBrok

into #temp          
          
From FoBillValan f, client1 c1 , client2 c2, foscrip2 fos2                
                
 where f.Symbol = fos2.Symbol AND f.Inst_type = fos2.Inst_Type                 
                
 and f.Expirydate = fos2.Expirydate AND f.Strike_price = fos2.Strike_price                 
 and f.Option_type = fos2.Option_type                 
 and f.party_code >= @fpartycode and f.party_code <= @tpartycode                 
 and sauda_date >= @fdatefrom +' 00:00' and sauda_date <=@tdatefrom + ' 23:59'                
 and f.party_code=c2.party_code and c1.cl_code = c2.cl_code                 
 
               
group by                
f.PARTY_CODE,                
Branch_Cd ,  
f.INST_TYPE ,                
f.SYMBOL,                
convert(varchar(11),f.expirydate,109),                
f.option_type ,                
f.strike_price ,                
cl_rate,                
convert(varchar(11),SAUDA_DATE,103),billno,                
Service_Tax,                
Service_chrg,                
Insurance_Chrg,Ins_Chrg,sauda_date,f.expirydate,TradeType          
    
   
          
Order by year(sauda_date),month(sauda_date),day(sauda_date),f.party_code ,f.inst_type,  OrgSymbol ,              
 year(f.expirydate),  month(f.expirydate),day(f.expirydate),TradeType, f.option_type, f.strike_price, sauda_date,right(Sauda_date,7)                 
          
        
  
Select       
  
isnull(c1.Long_Name,'') as Party_Name,isnull(c1.L_Address1,'') as L_Address1,  
isnull(c1.L_Address2,'') as L_Address2,isnull(c1.L_Address3,'') as L_Address3,isnull(c1.L_city,'') as L_city,  
isnull(c1.L_Zip,'') as L_Zip, isnull(c1.pan_gir_no,'') as pan_gir_no,   
isnull(c1.Res_Phone1,'') as Res_Phone1,isnull(c1.Off_Phone1,'') as Off_Phone1 , c2.party_code   
      
into #Client      
      
From       
Client1 C1,Client2 C2,FoOwner      
Where       
 C1.Cl_Code =c2.Cl_Code and       
 party_code >= @fpartycode and party_code <= @tpartycode                 
  
 And Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)      
 And sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)      
 And Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)      
 And C1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)      
 And C2.Party_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)     
     
      
  
select   
#temp.PARTY_CODE,  INST_TYPE , OrgSymbol,Symbol,  expirydate, option_type ,                
strike_price , cl_rate, pqty,  sqty,   prate,  srate,   billno,                
SAUDA_DATE, pamt, samt, service_tax ,sebi_tax , turn_tax ,  
broker_note ,Insurance_Chrg , other_chrg,TradeType ,  
Party_Name,L_Address1,L_Address2,L_Address3,L_city,  
L_Zip, pan_gir_no, Res_Phone1, Off_Phone1 , Branch_Cd ,TotBrok   
   
from #Client , #temp  
  
where #Client.party_code = #temp.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_branchbroktable
-- --------------------------------------------------

CREATE  Procedure Rpt_branchbroktable      
@branch as Varchar(10),  
@valperc As Varchar(20),      
@val1 As Varchar(20),      
@trddel As Int      
As      
      
If @val1 = '%'      
      
Begin      
If @trddel = 0           
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code  
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where Trd_del In ('t','s','f','d') And Val_perc Like @valperc)        
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
      
      
If @trddel = 1          
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code      
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where Trd_del In ('t','s','f') And Val_perc Like @valperc)        
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
If @trddel = 2          
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code      
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where Trd_del In ('d') And Val_perc Like @valperc)        
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
End      
      
If @val1 <> '%'      
Begin      
If @trddel = 0       
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code      
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where      
(day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))      
And Trd_del In ('t','s','f','d') And Val_perc Like @valperc)        
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
      
      
If @trddel = 1      
      
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code      
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where      
 (day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))      
And Trd_del In ('t','s','f') And Val_perc Like @valperc)         
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
If @trddel = 2      
      
Begin      
Select Distinct B.Table_no,line_no,B.table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,      
Trd_del = (case When Trd_del = 't' Then 'trading'       
  When Trd_del = 'd' Then 'delivery'      
  When Trd_del = 'f' Then 'first Leg'      
  When Trd_del = 's' Then 'second Leg'      
    End), T.Branch_Code      
From Broktable B, BranchBrokTable T  
Where B.Table_No = T.Table_No   
And B.Table_no In (select Distinct B.Table_no From Broktable Where      
 (day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))      
And Trd_del In ('d') And Val_perc Like @valperc)        
and T.Branch_Code Like @branch  
Order By T.Branch_Code, B.Table_no,line_no,upper_lim      
End      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BRANCHLISTING
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_BRANCHLISTING]
	(
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
	)
	
 AS

    if @FROMBRANCH = '' begin set @FROMBRANCH = '0'  end
    if @TOBRANCH = '' begin set @TOBRANCH = 'zzzzzz' end

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

 SELECT
        BRANCHCODE 	= UPPER(B.BRANCH_CODE),
		BRANCHNAME 	= UPPER(ISNULL(B.BRANCH,'')),
		SUBBROKERCODE 	= UPPER(ISNULL(S.SUB_BROKER,'')),
		SUBBROKERNAME 	= UPPER(ISNULL(S.NAME,'')),
		TRADERCODE 	= UPPER(ISNULL(B2.BRANCH_CD,'')),
		TRADERNAME 	= UPPER(ISNULL(B2.LONG_NAME,''))

 FROM
		BRANCH B (NOLOCK)
			LEFT OUTER JOIN SUBBROKERS S (NOLOCK)
			ON (B.BRANCH_CODE = S.BRANCH_CODE)
			
			LEFT OUTER JOIN BRANCHES B2 (NOLOCK)
			ON (B2.BRANCH_CD = B.BRANCH_CODE)

 WHERE
		B.BRANCH_CODE >= @FROMBRANCH	
		AND B.BRANCH_CODE <= @TOBRANCH
                AND @STATUSNAME = (   
                	CASE 
                        WHEN @STATUSID = 'BRANCH' 
                        THEN B.BRANCH_CODE 
                        ELSE 'BROKER' END) 

 ORDER BY
		B.BRANCH_CODE,
		S.SUB_BROKER,
		B2.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_branchloginclientlist_NEW1
-- --------------------------------------------------


--Exec rpt_branchloginclientlist_NEW 'Branch','broker','broker','','0','z'  
--sp_helptext rpt_branchloginclientlist_NEW    
CREATE    Procedure  [dbo].[rpt_branchloginclientlist_NEW1]             
@fromdate as varchar(11),  
@todate as varchar(11),  
@order_by as varchar(80),              
@statusid varchar(15),              
@statusname varchar(25),              
@FilterValue varchar(10),              
@FromParty varchar(15),              
@ToParty varchar(15)              
as              
Declare @BranchCode varchar(15)              

if isnull(@filtervalue,'') = ''               
begin              
 select @BranchCode = '%'              
end              
else              
begin              
 select @BranchCode = @FilterValue              
end              
              
If @FromParty = ''              
Begin              
 set @FromParty ='00000000'              
End              
              
If @ToParty = ''              
Begin              
 set @ToParty = 'ZZZZZZZZ'              
End              
               
set transaction isolation level read uncommitted              

SELECT 
    c1.short_name, 
    c1.long_name, 
    isnull(c1.res_phone1,'-') AS res_phone1, 
    isnull(c1.off_phone1,'-') AS off_phone1, 
    c1.cl_code, 
    isnull(c1.email,'-') AS email, 
    isnull(c1.branch_cd,'-') AS branch_cd, 
    isnull(c1.family,'-') AS family, 
    isnull(c1.sub_broker,'-') AS sub_broker, 
    isnull(c1.trader,'-') AS trader, 
    c2.party_code, 
    c2.turnover_tax, 
    c2.sebi_turn_tax, 
    insurance_chrg,
    brokernote, 
    other_chrg, 
    isnull(c3.branch,'-') AS branch, 
    c4.short_name AS trader_name, 
    c5.name,
    c5.com_perc, 
    isnull(c1.pan_gir_no,'-') AS pan_gir_no, 
    isnull(convert(varchar(11),ActiveFrom),'-') AS ActiveFrom, 
    isnull(convert(varchar(11),InactiveFrom),'-') AS InactiveFrom, 
    Introducer = isnull(CL5.Introducer,'-'), 
    Approver = isnull(CL5.Approver,'-'), 
    isnull(C1.L_Address1,'-') AS L_Address1, 
    isnull(C1.L_Address2,'-') AS L_Address2, 
    Isnull(CL41.CltDpID,'-') AS AccNo, 
    isnull(POBankcode,'-') AS pobankcode, 
    isnull(POBankName,'-') AS pobankname, 
    isnull(PayMode,'-') AS PayMode, 
    BankID = IsNull(CL4.bankID,'-'), 
    ClientDPID=IsNull(CL4.CltDpID,'-'), 
    isnull(C1.L_Address3,'-') AS l_address3, 
    isnull(C1.L_City,'-') AS l_city, 
    isnull(C1.L_State,'-') AS l_state, 
    isnull(C1.L_Nation,'-') AS l_nation, 
    isnull(C1.L_Zip,'-') AS l_zip, 
    isnull(C1.Fax,'-') AS fax, 
    isnull(C1.Mobile_Pager,'-') AS mobile_pager, 
    CLBankID=isnull(CL41.BankID,'-'), 
    BankName = IsNull(B.Bank_Name,'-') 
FROM client1 c1 
LEFT OUTER JOIN 
    Client5 CL5 
    ON 
    ( 
        CL5.Cl_Code = C1.Cl_Code 
    )
    , 
    client2 c2 
LEFT OUTER JOIN 
    Client4 CL4 
    ON 
    ( 
        CL4.Party_Code = C2.party_Code 
        AND CL4.DefDP = 1 
        AND CL4.depository in ('CDSL','NSDL')
    ) 
LEFT OUTER JOIN 
    Client4 CL41 
    ON 
    ( 
        CL41.Cl_Code = C2.Cl_Code 
        AND CL41.depository not in ('CDSL','NSDL')
    ) 
LEFT OUTER JOIN 
    POBank B 
    ON 
    (
        Convert(Varchar,B.BankID)=CL41.Bankid
    )
    , 
    branch c3, 
    branches c4, 
    subbrokers c5, 
    ACCOUNTNCE.DBO.acmast AM 
WHERE c1.cl_code=c2.cl_code 
    AND c1.branch_cd=c3.branch_code 
    AND c1.trader=c4.short_name 
    AND c1.sub_broker=c5.sub_broker 
    AND c3.branch_code=c4.branch_cd 
    AND c3.branch_code like @BranchCode 
    AND c2.party_code >= @FromParty 
    AND c2.party_code <= @ToParty 
    AND AM.CltCode = C2.Party_code 
AND CL5.Cl_Code = C1.Cl_Code     
    AND CL5.SystumDate Between   
    CASE   
 When Len(@fromdate) > 1  
 Then @fromdate Else 'Jan  1 1900'   
 End  
    AND  
    CASE   
 When Len(@todate) > 1  
 Then @todate + ' 23:59' Else 'Dec 31 2049 23:59'   
        End  
    AND C1.Branch_cd Like (
    CASE 
        WHEN @StatusId = 'branch' 
        THEN @statusname 
        ELSE '%' 
    END
    ) 
    AND C1.Sub_broker Like (
    CASE 
        WHEN @StatusId = 'subbroker' 
        THEN @statusname 
        ELSE '%' 
    END
    ) 
    AND Trader Like (
    CASE 
        WHEN @StatusId = 'trader' 
        THEN @statusname 
        ELSE '%' 
    END
    ) 
    AND Family Like (
    CASE 
        WHEN @StatusId = 'family' 
        THEN @statusname 
        ELSE '%' 
    END
    ) 
    AND C2.Party_Code Like (
    CASE 
        WHEN @StatusId = 'client' 
        THEN @statusname 
        ELSE '%' 
    END
    )                            
              
 ORDER BY (  
    CASE   
        WHEN @order_by = 'Branch'   
        THEN c1.branch_cd   
        ELSE   
        CASE   
            WHEN @order_by = 'SubBroker'   
            THEN c1.sub_broker   
            ELSE   
            CASE   
                WHEN @order_by = 'PartyCode'   
                THEN c2.party_code   
                ELSE   
                CASE   
                    WHEN @order_by = 'Client'   
                    THEN c1.short_name   
                    ELSE   
                    CASE   
                        WHEN @order_by = 'Family'   
                        THEN c1.family   
                        ELSE   
                        CASE   
                            WHEN @order_by = 'Active'   
                            THEN convert(varchar(11),ActiveFrom)   
                            ELSE   
                            CASE   
                                WHEN @order_by = 'InActive'   
                                THEN convert(varchar(11),InactiveFrom)   
                            END   
                        END   
                    END   
                END   
            END   
        END   
    END   
    )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_brokcombined
-- --------------------------------------------------




create procedure rpt_brokcombined  
@type varchar(3)  
as  
if @type = 'INS'  
  
begin  
select distinct Std_rate,MF_tableno,brok2_tableno,brok_scheme  
from client2 c2,client1 c1 where c1.cl_code = c2.cl_code  
and c1.cl_type = 'INS'  
order by Std_rate,MF_tableno,brok2_tableno,brok_scheme  
  
end  
  
if @type = 'CLI'  
  
begin  
select distinct Std_rate,MF_tableno,brok2_tableno,brok_scheme  
from client2 c2,client1 c1 where c1.cl_code = c2.cl_code  
and c1.cl_type = 'CLI'  
order by Std_rate,MF_tableno,brok2_tableno,brok_scheme  
  
end  
  
if @type = 'ALL'  
  
begin  
select distinct Std_rate,MF_tableno,brok2_tableno,brok_scheme  
from client2 c2,client1 c1 where c1.cl_code = c2.cl_code  
order by Std_rate,MF_tableno,brok2_tableno,brok_scheme  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_broktable
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_broktable    Script Date: 01/15/2005 1:28:10 Pm ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_broktable    Script Date: 12/16/2003 2:31:44 Pm ******/    
    
    
    
/****** Object:  Stored Procedure Dbo.rpt_broktable    Script Date: 05/08/2002 12:35:08 Pm ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_broktable    Script Date: 01/14/2002 20:32:52 ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_broktable    Script Date: 12/26/2001 1:23:16 Pm ******/    
    
Create Procedure Rpt_broktable    
    
@valperc As Varchar(20),    
@val1 As Varchar(20),    
@trddel As Int    
As    
    
    
If @val1 = '%'    
    
Begin    
    
    
If @trddel = 0     
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where Table_no In (select Distinct Table_no From Broktable Where Trd_del In ('t','s','f','d') And Val_perc Like @valperc)      
Order By Table_no,line_no,upper_lim    
End    
    
    
If @trddel = 1    
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where  Table_no In (select Distinct Table_no From Broktable Where Trd_del In ('t','s','f') And Val_perc Like @valperc)      
Order By Table_no,line_no,upper_lim    
End    
If @trddel = 2    
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where Table_no In (select Distinct Table_no From Broktable Where Trd_del In ('d') And Val_perc Like @valperc)      
Order By Table_no,line_no,upper_lim    
End    
    
End    
    
    
    
If @val1 <> '%'    
    
Begin    
    
    
If @trddel = 0     
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where Table_no In (select Distinct Table_no From Broktable Where    
(day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))    
And Trd_del In ('t','s','f','d') And Val_perc Like @valperc)      
Order By Table_no,line_no,upper_lim    
End    
    
    
If @trddel = 1    
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where Table_no In (select Distinct Table_no From Broktable Where    
 (day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))    
And Trd_del In ('t','s','f') And Val_perc Like @valperc)       
Order By Table_no,line_no,upper_lim    
End    
If @trddel = 2    
    
Begin    
Select Table_no,line_no,table_name,upper_lim,val_perc,day_puc,day_sales,sett_purch,sett_sales,normal,round_to,    
Trd_del = (case When Trd_del = 't' Then 'trading'     
  When Trd_del = 'd' Then 'delivery'    
  When Trd_del = 'f' Then 'first Leg'    
  When Trd_del = 's' Then 'second Leg'    
    End)    
From Broktable    
Where  Table_no In (select Distinct Table_no From Broktable Where    
 (day_puc = Cast(@val1 As Numeric(18,6)) Or Day_sales = Cast(@val1 As Numeric(18,6)) Or Sett_purch = Cast(@val1 As Numeric(18,6)) Or Sett_sales = Cast(@val1 As Numeric(18,6)) Or Normal = Cast(@val1 As Numeric(18,6)))    
And Trd_del In ('d') And Val_perc Like @valperc)      
Order By Table_no,line_no,upper_lim    
End    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_broktabledetails
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_broktabledetails    Script Date: 10/17/02 2:10:08 PM ******/


/* Modified by amit on 06/08/2002 to display additional field and round to*/
/****** Object:  Stored Procedure dbo.rpt_broktabledetails    Script Date: 01/29/2002 10:53:13 PM ******/

/****** Object:  Stored Procedure dbo.rpt_broktabledetails    Script Date: 12/26/2001 1:23:16 PM ******/
CREATE  procedure rpt_broktabledetails

@tabno as int

as

select table_no,upper_lim,day_puc,day_sales,sett_purch,sett_sales,normal,trd_del,val_perc,line_no,table_name,round_to,
RoFig,ErrNum,NoZero,

rt = ( case when ( RoFig =0  and  ErrNum=0.5 and  NoZero=1) then 'ACTUAL'  else 
      		( case when ( RoFig =1  and  ErrNum=-0.1 and  NoZero=0) then 'NEXT 1P' else 
      			( case when ( RoFig =5  and  ErrNum=-0.1 and  NoZero=0) then 'NEXT 5P' else
				( case when ( RoFig =-1  and  ErrNum=0.1 and  NoZero=0) then 'PREV 1P' else
					( case when ( RoFig =-5  and  ErrNum=0.1 and  NoZero=0) then 'PREV 5P' else 
						( case when ( RoFig =5  and  ErrNum=-2.5 and  NoZero=0) then 'BANKERS'
	
						end )end )end )end )end )end )
from broktable
where table_no = @tabno
order by table_no,line_no,upper_lim

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_clientlist
-- --------------------------------------------------


CREATE   procedure rpt_clientlist  
  
@order_by as varchar(9)  
  
as  
  
if @order_by='Branch'  
  
begin  
  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom,  
CL5.Introducer,CL5.Approver   
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )   
  
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by c1.branch_cd,c2.party_code  
  
end  
  
  
if @order_by='SubBroker'  
  
begin  
  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom,  
CL5.Introducer,CL5.Approver   
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )   
  
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by c1.sub_broker,c2.party_code  
  
end  
  
if @order_by='Client'  
  
begin  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom,  
CL5.Introducer,CL5.Approver   
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )   
  
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by c1.short_name  
  
end  
  
if @order_by='Family'  
  
begin  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom,  
CL5.Introducer,CL5.Approver   
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )      
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by c1.family  
  
end  
  
if @order_by='Active'  
  
begin  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom,  
CL5.Introducer,CL5.Approver   
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )   
  
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by ActiveFrom asc  
  
end  
  
if @order_by='InActive'  
  
begin  
select distinct c1.short_name,c1.long_name,c1.res_phone1,c1.off_phone1,c1.cl_code,c1.email,  
c1.branch_cd,c1.family,c1.sub_broker,c1.trader,  
c2.party_code,c2.turnover_tax,c2.sebi_turn_tax,insurance_chrg,brokernote,other_chrg,  
c3.branch,c4.short_name as trader_name,c5.name,c5.com_perc,c1.pan_gir_no,  
convert(varchar(11),ActiveFrom) as ActiveFrom ,convert(varchar(11),InactiveFrom)   as InactiveFrom ,  
CL5.Introducer,CL5.Approver  
from client1 c1 Left Outer Join Client5 CL5 On ( CL5.Cl_Code = C1.Cl_Code )   
  
,client2 c2,branch c3,branches c4,subbrokers c5  
where c1.cl_code=c2.cl_code and  
c1.branch_cd=c3.branch_code and  
c1.trader=c4.short_name and  
c1.sub_broker=c5.sub_broker and  
c3.branch_code=c4.branch_cd  
  
order by InactiveFrom asc  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_clientlist_Report
-- --------------------------------------------------
CREATE Procedure  [dbo].[rpt_clientlist_Report]

(              

	@fromdate as varchar(11),

	@todate as varchar(11),

	@order_by as varchar(16),

	@statusid varchar(15),

	@statusname varchar(25),

	@FromParty varchar(10),

	@ToParty varchar(10),

	@FilterValue varchar(10),

	@FromCode varchar(10),

	@ToCode varchar(10)

)

AS



Declare 

	@RegionCodeFrom varchar(10) ,

	@RegionCodeTo varchar(10) ,

	@AreaCodeFrom varchar(10) ,

	@AreaCodeTo varchar(10) ,

	@BranchFrom varchar(10) ,

	@BranchTo varchar(10) ,

	@SubBrokerFrom varchar(10) ,

	@SubBrokerTo varchar(10) ,

	@TraderFrom varchar(10) ,

	@TraderTo varchar(10) 



Set @RegionCodeFrom =''

Set @AreaCodeFrom =''

Set @BranchFrom =''

Set @SubBrokerFrom =''

Set @TraderFrom =''



Set @RegionCodeTo =  'zzzzzzzzzzzz'

Set @AreaCodeTo = 'zzzzzzzzzzzzz'

Set @BranchTo = 'zzzzzzzzzzzzz'

Set @SubBrokerTo = 'zzzzzzzzzzzzz'

Set @TraderTo = 'zzzzzzzzzzzzz'



if @filtervalue = 'REGION' AND @ToCode <> ''                

	begin                

		Set @RegionCodeFrom = @FromCode

		Set @RegionCodeTo = @ToCode               

	end                

if @filtervalue = 'AREA'    AND @ToCode <> ''                 

	begin                

		Set @AreaCodeFrom = @FromCode

		Set @AreaCodeTo = @ToCode               

	end 

if @filtervalue = 'SUBBROKER'  AND @ToCode <> ''                   

	begin                

		Set @SubBrokerFrom = @FromCode

		Set @SubBrokerTo = @ToCode               

	end             

if @filtervalue = 'BRANCH'  AND @ToCode <> ''                   

	begin                

		Set @BranchFrom = @FromCode

		Set @BranchTo = @ToCode               

	end            

if @filtervalue = 'TRADER'   AND @ToCode <> ''                  

	begin                

		Set @TraderFrom = @FromCode

		Set @TraderTo = @ToCode               

	end         

        

If @ToParty = ''                

Begin                

 set @ToParty = 'zzzzzzzzzzzzz'                

End                

                 

set transaction isolation level read uncommitted                

  

SELECT   



OrderBy = (    

    CASE     

        WHEN @order_by = 'Branch'     

        THEN c1.branch_cd     

        ELSE     

        CASE     

            WHEN @order_by = 'SubBroker'     

            THEN c1.sub_broker     

            ELSE     

            CASE     

                WHEN @order_by = 'PartyCode'     

                THEN c2.party_code     

                ELSE     

                CASE     

                    WHEN @order_by = 'Client'     

                    THEN c1.short_name     

                    ELSE     

                    CASE     

                        WHEN @order_by = 'Family'     

                        THEN c1.family     

                        ELSE     

                        CASE     

                            WHEN @order_by = 'Active'     

                            THEN convert(varchar(11),ActiveFrom)     

                            ELSE     

                            CASE     

                                WHEN @order_by = 'InActive'     

                                THEN convert(varchar(11),InactiveFrom)     

                            END     

                        END     

                    END     

                END     

            END     

        END     

    END     

    )    ,

    c1.short_name,   

    c1.long_name,   

    isnull(c1.res_phone1,'-') AS res_phone1,   

    isnull(c1.off_phone1,'-') AS off_phone1,   

    c1.cl_code,   

    isnull(c1.email,'-') AS email,   

    isnull(c1.branch_cd,'-') AS branch_cd,   

    isnull(c1.family,'-') AS family,   

    isnull(c1.sub_broker,'-') AS sub_broker,   

    isnull(c1.trader,'-') AS trader,   

    c2.party_code,   

    c2.turnover_tax,   

    c2.sebi_turn_tax,   

    insurance_chrg,  

    brokernote,   

    other_chrg,   

    isnull(c3.branch,'-') AS branch,   

    c4.short_name AS trader_name,   

    c5.name,  

    c5.com_perc,   

  isnull(c1.pan_gir_no,'-') AS pan_gir_no,   

    isnull(convert(varchar(11),ActiveFrom),'-') AS ActiveFrom,   

    isnull(convert(varchar(11),InactiveFrom),'-') AS InactiveFrom,   

    Introducer = isnull(CL5.Introducer,'-'),   

    Approver = isnull(CL5.Approver,'-'),   

    isnull(C1.L_Address1,'-') AS L_Address1,   

    isnull(C1.L_Address2,'-') AS L_Address2,   

    Isnull(CL41.CltDpID,'-') AS AccNo,   

    isnull(POBankcode,'-') AS pobankcode,   

    isnull(POBankName,'-') AS pobankname,   

    isnull(PayMode,'-') AS PayMode,   

    BankID = IsNull(CL4.bankID,'-'),   

    ClientDPID=IsNull(CL4.CltDpID,'-'),   

    isnull(C1.L_Address3,'-') AS l_address3,   

    isnull(C1.L_City,'-') AS l_city,   

    isnull(C1.L_State,'-') AS l_state,   

    isnull(C1.L_Nation,'-') AS l_nation,   

    isnull(C1.L_Zip,'-') AS l_zip,   

    isnull(C1.Fax,'-') AS fax,   

    isnull(C1.Mobile_Pager,'-') AS mobile_pager,   

    CLBankID=isnull(CL41.BankID,'-'),   

    BankName = IsNull(B.Bank_Name,'-')   

FROM CLIENT1 C1 (nolock),   

    Client5 CL5 (nolock), 

    client2 c2 (nolock)   

LEFT OUTER JOIN   

    Client4 CL4   

    ON   

    (   

        CL4.Party_Code = C2.party_Code   

        AND CL4.DefDP = 1   

        AND CL4.depository in ('CDSL','NSDL')  

    )   

LEFT OUTER JOIN   

    Client4 CL41   

    ON   

    (   

        CL41.Cl_Code = C2.Cl_Code   

        AND CL41.depository not in ('CDSL','NSDL')  

    )   

LEFT OUTER JOIN   

    POBank B   

    ON   

    (  

        Convert(Varchar,B.BankID)=CL41.Bankid  

    )  

    ,   

    branch c3 (nolock),   

    branches c4 (nolock),   

    subbrokers c5 (nolock),   

    accountnce.dbo.acmast AM (nolock)  

WHERE c1.cl_code=c2.cl_code   

    AND c1.branch_cd=c3.branch_code   

    AND c1.trader=c4.short_name   

    AND c1.sub_broker=c5.sub_broker   

    AND c3.branch_code=c4.branch_cd   

    AND c2.party_code >= @FromParty   

    AND c2.party_code <= @ToParty

    AND AM.CltCode = C2.Party_code   

    AND CL5.Cl_Code = C1.Cl_Code   

   AND CL5.SystumDate Between 

    CASE 

	When Len(@fromdate) > 1

	Then @fromdate Else 'Jan  1 1900' 

	End

    AND

    CASE 

	When Len(@todate) > 1

	Then @todate + ' 23:59' Else 'Dec 31 2049 23:59' 

        End

    AND @STATUSNAME = (   

        CASE   

                WHEN @STATUSID = 'BRANCH'   

                THEN C1.BRANCH_CD   

                WHEN @STATUSID = 'SUBBROKER'   

                THEN C1.SUB_BROKER   

                WHEN @STATUSID = 'TRADER'   

                THEN C1.TRADER   

                WHEN @STATUSID = 'FAMILY'   

                THEN C1.FAMILY   

                WHEN @STATUSID = 'AREA'   

                THEN C1.AREA   

                WHEN @STATUSID = 'REGION'   

                THEN C1.REGION   

                WHEN @STATUSID = 'CLIENT'   

          THEN C2.PARTY_CODE   

                ELSE 'BROKER' END) 

	AND  C1.region between @RegionCodeFrom and @RegionCodeTo

	AND  C1.Area between @AreaCodeFrom and @AreaCodeTo

	AND  C1.branch_cd between @BranchFrom and @BranchTo

	AND  C1.sub_broker between @SubBrokerFrom and @SubBrokerTo

	AND  C1.Trader between @TraderFrom and @TraderTo



Order By 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_clientperiod_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[rpt_clientperiod_New]    
@fromdt datetime,     
@todt datetime,    
@cltcode varchar(10),    
@sortby varchar(3),    
@statusname varchar(25),    
@ReportPara varchar(5)    
    
AS    
    
--*** rpt_clientopenbal ***--    
If @ReportPara='1' And @sortby='vdt'     
 Begin    
  select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE  VDT < @todt     
  and CLTCODE=@cltcode    
  group by drcr     
 End     
Else If @ReportPara='1'    
 Begin    
  select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE  edt < @todt     
  and CLTCODE=@cltcode    
  group by drcr     
 End    
    
    
    
--*** rpt_clientperioddrcr ***--    
If @ReportPara='2' And @sortby = 'vdt'     
 Begin    
  select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE (VDT >=@fromdt AND VDT <=@todt + ' 23:59:59')    
  and CLTCODE=@cltcode    
  group by drcr     
 End     
Else If @ReportPara='2'   
 Begin    
  select drtot=isnull((case drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE (edt >=@fromdt AND edt <=@todt + ' 23:59:59')    
  and CLTCODE=@cltcode    
  group by drcr     
 End    
    
    
--*** rpt_clientperioddrcrbr ***--    
If @ReportPara='3' And @sortby = 'vdt'     
 Begin    
  select drtot=isnull((case l2.drcr when 'd' then sum(camt) end),0),     
  crtot=isnull((case l2.drcr when 'c' then sum(camt) end),0)     
  from  ACCOUNTNCE.DBO.ledger l,  ACCOUNTNCE.DBO.ledger2 l2,  ACCOUNTNCE.DBO.costmast c ,  ACCOUNTNCE.DBO.category ct    
  WHERE (VDT >=@fromdt AND VDT <=@todt + ' 23:59:59')    
  and l2.CLTCODE=@cltcode    
   and  c.costcode=l2.costcode and     
  l2.vtype=l.vtyp and    
  l2.vno=l.vno and    
  l2.lno=l.lno and    
  l2.booktype=l.booktype and  ct.category='branch'    
  and ct.catcode=c.catcode    
  and c.costname=@statusname    
  group by l2.drcr     
 End     
Else If @ReportPara='3'   
 Begin    
  select drtot=isnull((case l2.drcr when 'd' then sum(camt) end),0),     
  crtot=isnull((case l2.drcr when 'c' then sum(camt) end),0)     
  from  ACCOUNTNCE.DBO.ledger l,  ACCOUNTNCE.DBO.ledger2 l2,  ACCOUNTNCE.DBO.costmast c ,  ACCOUNTNCE.DBO.category ct    
  WHERE (edt >=@fromdt AND edt <=@todt + ' 23:59:59')    
  and l2.CLTCODE=@cltcode    
   and  c.costcode=l2.costcode and     
  l2.vtype=l.vtyp and    
  l2.vno=l.vno and    
  l2.lno=l.lno and    
  l2.booktype=l.booktype and ct.category='branch'    
  and ct.catcode=c.catcode    
  and c.costname=@statusname    
  group by l2.drcr     
 End    
    
    
--- *** rpt_detailperiodledger *** ---    
If @ReportPara='4' And @sortby='vdt'     
 Begin    
  select  left(convert(varchar,VDT,103),11), l.vtyp,vno,lno,drcr,    
  dramt=isnull((case drcr when 'd' then vamt end),0),     
  cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc,    
  nar=isnull(l.narration,''),    
  edt, edtdiff=datediff(d, l.edt , getdate() ) ,displayvdt = left(convert(varchar,VDT,109),11) ,bt.description ,bt.booktype    
  from ACCOUNTNCE.DBO. ledger l, ACCOUNTNCE.DBO.vmast v , ACCOUNTNCE.DBO. booktype bt     
  where  l.vdt >= @fromdt and l.vdt<=@todt + ' 23:59:59'    
  and cltcode = @cltcode and l.vtyp=v.vtype     
  and l.vtyp <> '18'    
  and l.vtyp = bt.vtyp    
  and l.booktype = bt.booktype    
  order by l.vdt, drcr,l.vtyp    
 End    
Else If @ReportPara='4'    
 Begin    
  select left( convert(varchar,edt,103),11),l.vtyp,vno,lno,drcr,    
  dramt=isnull((case drcr when 'd' then vamt end),0),     
  cramt=isnull((case drcr when 'c' then vamt end),0), balamt,Vdesc,    
  nar=isnull(l.narration,''),    
  edt, edtdiff=datediff(d, l.edt , getdate() )  ,bt.description ,bt.booktype    
  from ACCOUNTNCE.DBO. ledger l, ACCOUNTNCE.DBO.vmast v , ACCOUNTNCE.DBO. booktype bt    
  WHERE edt >= @fromdt and edt<=@todt + ' 23:59:59'    
  and CLTCODE=@cltcode and l.vtyp=v.vtype     
  and l.vtyp <> '18'    
  and l.vtyp = bt.vtyp    
  and l.booktype = bt.booktype    
  order by edt, drcr,l.vtyp    
    
End    
    
    
    
--- *** rpt_detailperiodledgerbr *** ---    
If @ReportPara='5' And @sortby='vdt'     
 Begin    
  select  left(convert(varchar,VDT,103),11), l.vtyp,l.vno,l.lno,l.drcr,    
  dramt=isnull((case l2.drcr when 'd' then camt end),0),     
  cramt=isnull((case l2.drcr when 'c' then camt end),0), balamt,Vdesc,    
  nar=isnull((select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=1) ,''),    
  edt, edtdiff=datediff(d, l.edt , getdate() ) ,displayvdt = left(convert(varchar,VDT,109),11) ,bt.description ,bt.booktype    
  from ACCOUNTNCE.DBO.ledger l, ACCOUNTNCE.DBO.vmast v , ACCOUNTNCE.DBO.booktype bt ,ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct    
  where  l.vdt >= @fromdt and l.vdt<=@todt + ' 23:59:59'    
  and l2.cltcode = @cltcode and l.vtyp=v.vtype     
  and l.vtyp <> '18'    
  and l.vtyp = bt.vtyp    
  and l.booktype = bt.booktype    
  and  c.costcode=l2.costcode and     
  l2.vtype=l.vtyp and    
  l2.vno=l.vno and    
  l2.lno=l.lno and    
  l2.booktype=l.booktype and ct.category='branch'    
  and ct.catcode=c.catcode    
  and c.costname=@statusname    
  order by l.vdt, l2.drcr,l.vtyp    
 End    
Else If @ReportPara='5'   
 Begin    
  select left( convert(varchar,edt,103),11),l.vtyp,l.vno,l.lno,l.drcr,    
  dramt=isnull((case l2.drcr when 'd' then camt end),0),     
  cramt=isnull((case l2.drcr when 'c' then camt end),0), balamt,Vdesc,    
  nar=isnull((select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l3.naratno=1) ,''),    
  edt, edtdiff=datediff(d, l.edt , getdate() )  ,bt.description ,bt.booktype    
  from ACCOUNTNCE.DBO. ledger l, ACCOUNTNCE.DBO.vmast v , ACCOUNTNCE.DBO. booktype bt ,ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct    
  WHERE edt >= @fromdt and edt<=@todt + ' 23:59:59'    
  and l2.CLTCODE=@cltcode and l.vtyp=v.vtype     
  and l.vtyp <> '18'    
  and l.vtyp = bt.vtyp    
  and l.booktype = bt.booktype    
  and  c.costcode=l2.costcode and     
  l2.vtype=l.vtyp and    
  l2.vno=l.vno and    
  l2.lno=l.lno and    
  l2.booktype=l.booktype and ct.category='branch'    
  and ct.catcode=c.catcode    
  and c.costname=@statusname    
  order by edt, l2.drcr,l.vtyp    
 End    
    
    
--- *** rpt_openbal *** ---    
If @ReportPara='6' And @sortby='vdt'     
 Begin    
  select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0),    
  crtotal=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE vdt >= @fromdt  and VDT <=  @todt  and CLTCODE= @cltcode     
  group by drcr     
 end     
Else If @ReportPara='6'   
 Begin    
  select drtotal=isnull((case drcr when 'd' then sum(vamt) end),0),    
  crtotal=isnull((case drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger     
  WHERE edt >= @fromdt  and edt <= @todt and CLTCODE= @cltcode     
  group by drcr     
 End     
    
    
--- *** rpt_openbalbr *** ---    
If @ReportPara='7' And @sortby='vdt'     
 Begin    
  select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0),    
  crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger l, ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct     
  WHERE vdt >= @fromdt  and VDT <=  @todt  and l.CLTCODE= @cltcode     
  And c.costcode=l2.costcode     
  And l2.vtype=l.vtyp    
  And l2.vno=l.vno    
  And l2.lno=l.lno    
  And l2.booktype=l.booktype and ct.category='branch'    
  And ct.catcode=c.catcode    
  And c.costname=@statusname    
  group by l.drcr     
 end     
Else If @ReportPara='7'   
 Begin    
  select drtotal=isnull((case l.drcr when 'd' then sum(vamt) end),0),    
  crtotal=isnull((case l.drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger l, ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct     
  WHERE edt >= @fromdt  and edt <= @todt and l.CLTCODE= @cltcode     
  And c.costcode=l2.costcode     
  And l2.vtype=l.vtyp    
  And l2.vno=l.vno    
  And l2.lno=l.lno    
  And l2.booktype=l.booktype and ct.category='branch'    
  And ct.catcode=c.catcode    
  And c.costname=@statusname    
  group by l.drcr     
 End     
    
    
    
--*** rpt_clientopenbalbr ***--    
If @ReportPara='8' And @sortby='vdt'     
 Begin    
  select drtot=isnull((case l.drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case l.drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger l, ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct      
  WHERE l.VDT < @todt     
  And l.CLTCODE=@cltcode    
  And c.costcode=l2.costcode     
  And l2.vtype=l.vtyp    
  And l2.vno=l.vno    
  And l2.lno=l.lno    
  And l2.booktype=l.booktype and ct.category='branch'    
  And ct.catcode=c.catcode    
  And c.costname=@statusname    
  group by l.drcr     
 End     
Else If @ReportPara='8'   
 Begin    
  select drtot=isnull((case l.drcr when 'd' then sum(vamt) end),0),     
  crtot=isnull((case l.drcr when 'c' then sum(vamt) end),0)     
  from ACCOUNTNCE.DBO.ledger l, ACCOUNTNCE.DBO.ledger2 l2, ACCOUNTNCE.DBO.costmast c , ACCOUNTNCE.DBO.category ct     
  WHERE  l.edt < @todt     
  And l.CLTCODE=@cltcode    
  And c.costcode=l2.costcode     
  And l2.vtype=l.vtyp    
  And l2.vno=l.vno    
  And l2.lno=l.lno    
  And l2.booktype=l.booktype and ct.category='branch'    
  And ct.catcode=c.catcode    
  And c.costname=@statusname    
  group by l.drcr     
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_commissionreport
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_commissionreport    Script Date: 1/17/2004 11:42:45 PM ******/







CREATE  PROCEDURE rpt_commissionreport
@type varchar(10),
@fromdt varchar(15),
@todt varchar(15),
@fromcd varchar(10),
@tocd varchar(10)

as

if @type = 'CLIENT'

begin

SELECT f.Party_Code,s.name,left(convert(varchar,f.billdate,109),11) as billdate,f.amount,
crdr=(case when f.sell_buy=1 then 'DR' else 'CR' end),s.com_perc,
year(billdate),month(billdate),day(billdate)
from foaccbill f,subbrokers s
where f.party_code=s.sub_broker and f.amount<>0
and f.billdate >= @fromdt 
and f.billdate <= @todt+' 23:59:59'
and f.party_code >= @fromcd
and f.party_code <= @tocd
order by f.party_code,year(billdate),month(billdate),day(billdate)


end


if @type = 'DATE'

begin

SELECT f.Party_Code,s.name,left(convert(varchar,f.billdate,109),11) as billdate,f.amount,
crdr=(case when f.sell_buy=1 then 'DR' else 'CR' end),s.com_perc,
year(billdate),month(billdate),day(billdate)
from foaccbill f,subbrokers s
where f.party_code=s.sub_broker and f.amount<>0
and f.billdate >= @fromdt 
and f.billdate <= @todt+' 23:59:59'
and f.party_code >= @fromcd
and f.party_code <= @tocd
order by year(billdate),month(billdate),day(billdate),f.party_code


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_COMMODITY_MULTIPLIER
-- --------------------------------------------------

CREATE	PROC [dbo].[RPT_COMMODITY_MULTIPLIER]
		(
		@FROMDATE	VARCHAR(11),
		@TODATE		VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)
		)

		AS

		/*
		EXEC  RPT_COMMODITY_MULTIPLIER 'JUL 30 2018','JUL 31 2018','0','ZZZZ'
		DECLARE	@FROMDATE	VARCHAR(11),
				@TODATE		VARCHAR(11),
				@FROMPARTY	VARCHAR(20),
				@TOPARTY	VARCHAR(20)

		SET		@FROMDATE	= 'JAN  1 2000'
		SET		@TODATE		= 'DEC 31 2018'
		SET		@FROMPARTY	= ''
		SET		@TOPARTY	= 'zzzzzzzzzzz'
		*/

		SET	@TODATE = @FROMDATE 

		SELECT	CLIENT_CODE = PARTY_CODE,
				CLIENT_NAME = C1.LONG_NAME,
				SEGMENT = 'NCE',
				COMMODITY = F.SYMBOL,
				EXPIRY = CONVERT(VARCHAR,F.EXPIRYDATE,103),
				STRIKE_PRICE = F.STRIKE_PRICE,
				OPTION_TYPE = F.OPTION_TYPE,
				QTY = (PQTY-SQTY)/BILLNO,
				LOT_SIZE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,0),ROUND(F.NUMERATOR/F.DENOMINATOR,0)))+' '+QTY_UNIT,
				PRICE_QUOTATION = REPLACE(REPLACE(PRICEUNIT,'RS/',''),'Quintal','1 Quintal'),
				MULTIPLIER = CONVERT(NUMERIC(18,0),ROUND(BILLNO*(F.NUMERATOR/F.DENOMINATOR),0)),
				RATE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(CL_RATE,4))),
				VALUE = CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(CL_RATE*ROUND(((PQTY-SQTY)/BILLNO)*BILLNO*(F.NUMERATOR/F.DENOMINATOR),0),2)))
		FROM	FOBILLVALAN F (NOLOCK),
				FOSCRIP2 F2 (NOLOCK),
				CLIENT1 C1 (NOLOCK)
		WHERE	F.PARTY_CODE = C1.CL_CODE
				AND SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
				--AND F.EXPIRYDATE >= @TODATE
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND F2.INST_TYPE = F.INST_TYPE
				AND F2.SYMBOL = F.SYMBOL
				AND F2.EXPIRYDATE = F.EXPIRYDATE
				AND F2.STRIKE_PRICE = F.STRIKE_PRICE
				AND F2.OPTION_TYPE = F.OPTION_TYPE	
				--AND TRADETYPE = 'BT'			
				AND (PQTY-SQTY) <> 0
		ORDER BY
				PARTY_CODE,
				F.SYMBOL,
				CONVERT(VARCHAR,F.EXPIRYDATE,103),
				F.STRIKE_PRICE,
				F.OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_conpath
-- --------------------------------------------------
CREATE Procedure [dbo].[Rpt_conpath]  
  
@exch Varchar(3),  
@segment Varchar(20)  
  
As  
  
Select Conpath From ACCOUNTNCE.DBO.owner Where Exchange=@exch And Segment Like Ltrim(@segment)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Contract_Summary
-- --------------------------------------------------



CREATE Proc rpt_Contract_Summary (@DateFrom Varchar(11),@DateTo Varchar(11),  @STATUSID VARCHAR(15),@STATUSNAME VARCHAR(25)) AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

SELECT 
    TransDate = Convert(Varchar,Sauda_Date,103), 
    ContractNo, 
    ClientCode = S.Party_Code, 
    ClientName = C1.Long_Name, 
    Purc_Amount = Sum(
    CASE 
        WHEN Sell_buy = 1 
        THEN NetRate*TradeQty*BookType/Instrument
        ELSE 0 
    END
    )+Sum(
    CASE 
        WHEN c2.Service_Chrg = 2 
        THEN 0 
        ELSE Service_Tax 
    END
    ), 
    Sale_Amount = Sum(
    CASE 
        WHEN Sell_buy = 2 
        THEN NetRate*TradeQty*BookType/Instrument
        ELSE 0 
    END
    )-Sum(
    CASE 
        WHEN c2.Service_Chrg = 2 
        THEN 0 
        ELSE Service_Tax 
    END
    ), 
    Brokerage = Sum(Brokapplied*TradeQty*BookType/Instrument), 
    StampDuty = Sum(
    CASE 
        WHEN BrokerNote = 1 
        THEN Broker_Chrg 
        ELSE 0 
    END
    ), 
    Stt = Sum(
    CASE 
        WHEN Insurance_Chrg = 1 
        THEN Ins_chrg 
        ELSE 0 
    END
    ), 
    NetAmount = (Sum(
    CASE 
        WHEN Sell_buy = 1 
        THEN NetRate*TradeQty 
        ELSE 0 
    END
    )+Sum(
    CASE 
        WHEN c2.Service_Chrg = 2 
        THEN 0 
        ELSE Service_Tax 
    END
    ) - Sum(
    CASE 
        WHEN Sell_buy = 2 
        THEN NetRate*TradeQty 
        ELSE 0 
    END
    )-Sum(
    CASE 
        WHEN c2.Service_Chrg = 2 
        THEN 0 
        ELSE Service_Tax 
    END
    )) + Sum(
    CASE 
        WHEN BrokerNote = 1 
        THEN Broker_Chrg 
        ELSE 0 
    END
    ) + Sum(
    CASE 
        WHEN Insurance_Chrg = 1 
        THEN Ins_chrg 
        ELSE 0 
    END
    ) ,
mm=Month(Sauda_Date),yy=Year(Sauda_Date),dd=Day(Sauda_Date)
FROM FoSettlement S With(noLock),
    Client1 c1 With(noLock),
    Client2 C2 With(noLock) 
WHERE C2.Party_code = S.Party_code 
        AND C1.Cl_Code = C2.Cl_Code 
        AND Sauda_Date BetWeen @DateFrom and @DateTo +' 23:59'
        AND @STATUSNAME = 
          (CASE 
                WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                WHEN @STATUSID = 'AREA' THEN C1.AREA
                WHEN @STATUSID = 'REGION' THEN C1.REGION
                WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
          ELSE 
                'BROKER'
          END)
GROUP BY Convert(Varchar,Sauda_Date,103),
    Month(Sauda_Date),
    Year(Sauda_Date),
    Day(Sauda_Date),
    ContractNo,
    S.Party_Code,
    C1.Long_Name 
ORDER BY 
    YY,MM,DD,
    ContractNo,
    S.Party_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_DAILYMARGINSTATEMENT
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_DAILYMARGINSTATEMENT]  
 (      
 @MDATE VARCHAR(11),      
 @FROMPARTY VARCHAR(15),      
 @TOPARTY VARCHAR(15),      
 @FROMBRANCH VARCHAR(15)  = '',  
 @TOBRANCH VARCHAR(15)  = 'zzzzzzzz',  
 @FROMSUBBROKER VARCHAR(15) = '',  
 @TOSUBBROKER VARCHAR(15) = 'zzzzzzzz',  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WITHCOLL INT = 0,  
 @DCNFLAG INT = 0  
 )      
   
 AS      
  
 --EXEC RPT_DAILYMARGINSTATEMENT 'FEB  2 2009', '','ZZZZZZZZZZ','','ZZZZZZZZZ','','ZZZZZZZZZ','BROKER','BROKER'  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
   
 SELECT DISTINCT PARTY_CODE   
 INTO #MCLIENT  
 FROM TBL_CLIENTMARGIN  
 WHERE MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'  
 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
 

  
 SELECT   
  PARTY_CODE = CL_CODE,  
  PARTYNAME = LONG_NAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_ZIP,  
  L_STATE,  
  L_NATION,  
  RES_PHONE = RES_PHONE1 + RES_PHONE2,  
  OFF_PHONE = OFF_PHONE1 + OFF_PHONE2,  
  EMAIL,  
  PAN_GIR_NO,  
  BRANCH_CD,  
  SUB_BROKER,  
  EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK)),  
  SEGMENT  = 'FUTURES'  
 INTO  
  #CLIENTMASTER  
 FROM  
  CLIENT1 C1 (NOLOCK)  
 WHERE  
  CL_CODE BETWEEN @FROMPARTY AND @TOPARTY  
  AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH  
  AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER  
  AND CL_CODE IN (SELECT PARTY_CODE FROM #MCLIENT)  
  AND @STATUSNAME = (  
  CASE     
   WHEN @STATUSID = 'BRANCH'     
   THEN C1.BRANCH_CD     
   WHEN @STATUSID = 'SUBBROKER'     
   THEN C1.SUB_BROKER     
   WHEN @STATUSID = 'TRADER'     
   THEN C1.TRADER     
   WHEN @STATUSID = 'FAMILY'     
   THEN C1.FAMILY     
   WHEN @STATUSID = 'AREA'     
   THEN C1.AREA     
   WHEN @STATUSID = 'REGION'     
   THEN C1.REGION     
   WHEN @STATUSID = 'CLIENT'     
   THEN CL_CODE     
   ELSE 'BROKER'   
  END) 
  
  
  
 CREATE TABLE #MARGIN_DETAIL  
  (  
  PARTY_CODE   VARCHAR(15),  
  MARGINDATE   DATETIME,  
  LED_MARGIN_AMT  MONEY,  
  NONCASH_AMT   MONEY,  
  BGFD_AMT   MONEY,  
  OTHER_MARGIN  MONEY,  
  TOTAL_MARGIN_AVL MONEY,  
  INITIALMARGIN  MONEY,  
  EXPOSURE_MARGIN  MONEY,  
  TOTAL_MARGIN  MONEY,  
  EXCESS_SHORTFALL MONEY,  
  ADD_MARGIN   MONEY,  
  MARGIN_STATUS  MONEY,  
  )  
  
  
 INSERT INTO #MARGIN_DETAIL  
 SELECT   
  PARTY_CODE  = T.PARTY_CODE,  
  MARGINDATE  = LEFT(MARGINDATE,11),  
  LED_MARGIN_AMT = SUM(LEDGERAMOUNT),  
  NONCASH_AMT  = SUM(NONCASH_COLL),  
  BGFD_AMT  = 0,  
  OTHER_MARGIN = 0,  
  TOTAL_MARGIN_AVL= 0,  
  INITIALMARGIN = SUM(INITIALMARGIN),  
  EXPOSURE_MARGIN = SUM(MTMMARGIN),  
  TOTAL_MARGIN = 0,  
  EXCESS_SHORTFALL= 0,  
  ADD_MARGIN  = SUM(ADDMARGIN),  
  MARGIN_STATUS = 0  
 FROM  
  TBL_CLIENTMARGIN T (NOLOCK),  
  #CLIENTMASTER  C (NOLOCK)  
 WHERE   
  MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'  
  AND T.PARTY_CODE = C.PARTY_CODE  
 GROUP BY  
  T.PARTY_CODE,  
  LEFT(MARGINDATE,11)  
  
 

  
   
 UPDATE   
  #MARGIN_DETAIL  
 SET  
  LED_MARGIN_AMT = (LED_MARGIN_AMT + MARGIN),  
  BGFD_AMT  = (FD + BG)  
 FROM  
  (  
  SELECT   
   PARTY_CODE,  
   MARGIN = SUM(  
     CASE   
      WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT  
      ELSE 0  
     END),  
   FD  = SUM(  
     CASE   
      WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT  
      ELSE 0  
     END),  
   BG  = SUM(  
     CASE   
      WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT  
      ELSE 0  
     END)  
  FROM   
   MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)  
  WHERE   
   PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER)  
   AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'  
   AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))  
   AND C.SEGMENT = 'FUTURES'  
  GROUP BY  
   PARTY_CODE  
  ) COLL  
 WHERE  
  #MARGIN_DETAIL.PARTY_CODE = COLL.PARTY_CODE  
  

  
  
 SELECT   
  PARTY_CODE  = M.PARTY_CODE,  
  MARGINDATE  = CONVERT(VARCHAR,MARGINDATE,103),  
  EXCHANGE,  
  SEGMENT   = 'F&O',  
  LED_MARGIN_AMT = SUM(LED_MARGIN_AMT),  
  NONCASH_AMT  = SUM(NONCASH_AMT),  
  BGFD_AMT  = SUM(BGFD_AMT),  
  OTHER_MARGIN = 0,  
  TOTAL_MARGIN_AVL= SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT),  
  INITIALMARGIN = SUM(INITIALMARGIN),  
  EXPOSURE_MARGIN = SUM(EXPOSURE_MARGIN),  
  TOTAL_MARGIN = SUM(INITIALMARGIN + EXPOSURE_MARGIN),  
  EXCESS_SHORTFALL= (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)),  
  ADD_MARGIN  = SUM(ADD_MARGIN),  
  MARGIN_STATUS = (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)) - SUM(ADD_MARGIN),  
  PARTYNAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_ZIP,  
  L_STATE,  
  L_NATION,  
  RES_PHONE,  
  OFF_PHONE,  
  EMAIL,  
  PAN_GIR_NO,  
  BRANCH_CD,  
  SUB_BROKER,  
  RPT_ORD = '1DET',  
  SCRIP_CD= CONVERT(VARCHAR(20),''),  
  QTY = CONVERT(NUMERIC(18,4),0),  
  SEC_AMOUNT = CONVERT(NUMERIC(18,4),0),  
  BGNO = CONVERT(VARCHAR(20),''),  
  BG_AMOUNT = CONVERT(NUMERIC(18,4),0),  
  BG_EXPIRYDATE = CONVERT(VARCHAR(11),''),  
  FDRNO = CONVERT(VARCHAR(20),''),  
  FDR_AMOUNT = CONVERT(NUMERIC(18,4),0),  
  FDR_EXPIRYDATE = CONVERT(VARCHAR(11),'')  
 INTO  
  #FINAL_REPORT  
 FROM   
  #MARGIN_DETAIL M (NOLOCK),  
  #CLIENTMASTER  C (NOLOCK)  
 WHERE  
  M.PARTY_CODE = C.PARTY_CODE  
 GROUP BY  
  M.PARTY_CODE,  
  CONVERT(VARCHAR,MARGINDATE,103),  
  EXCHANGE,  
  SEGMENT,  
  PARTYNAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_ZIP,  
  L_STATE,  
  L_NATION,  
  RES_PHONE,  
  OFF_PHONE,  
  EMAIL,  
  PAN_GIR_NO,  
  BRANCH_CD,  
  SUB_BROKER  
 /*HAVING   
  SUM(INITIALMARGIN + EXPOSURE_MARGIN) <> 0*/  
 ORDER BY  
  PARTY_CODE  
  

  
 
  
  
 IF (@WITHCOLL = 1)  
 BEGIN  
  SELECT   
   PARTY_CODE,  
   MARGINDATE,  
   SCRIP_CD,  
   QTY = SUM(QTY),  
   SEC_AMOUNT = SUM(SEC_AMOUNT),  
   BGNO,  
   BG_AMOUNT = SUM(BG_AMOUNT),  
   BG_EXPIRYDATE,  
   FDRNO,  
   FDR_AMOUNT = SUM(FDR_AMOUNT),  
   FDR_EXPIRYDATE,  
   COLL_TYPE = '2' + UPPER(COLL_TYPE)  
  INTO  
   #COLL_DETAIL  
  FROM  
   (  
   SELECT   
    PARTY_CODE,  
    MARGINDATE = CONVERT(VARCHAR,EFFDATE,103),  
    SCRIP_CD =(  
    CASE   
     WHEN COLL_TYPE = 'SEC'   
     THEN SCRIP_CD ELSE ''   
    END),  
    QTY =(  
    CASE   
     WHEN COLL_TYPE = 'SEC'   
     THEN QTY ELSE 0   
    END),  
    SEC_AMOUNT =(  
    CASE   
     WHEN COLL_TYPE = 'SEC'   
     THEN FINALAMOUNT ELSE 0   
    END),  
    BGNO =(  
    CASE   
     WHEN COLL_TYPE = 'BG'   
     THEN FD_BG_NO ELSE ''   
    END),  
    BG_AMOUNT =(  
    CASE   
     WHEN COLL_TYPE = 'BG'   
     THEN FINALAMOUNT ELSE 0   
    END),  
    BG_EXPIRYDATE = (  
    CASE   
     WHEN COLL_TYPE = 'BG'   
     THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE ''   
    END),  
    FDRNO =(  
    CASE   
     WHEN COLL_TYPE = 'FD'   
     THEN FD_BG_NO ELSE ''   
    END),  
    FDR_AMOUNT =(  
    CASE   
     WHEN COLL_TYPE = 'FD'   
     THEN FINALAMOUNT ELSE 0   
    END),  
    FDR_EXPIRYDATE = (  
    CASE   
     WHEN COLL_TYPE = 'FD'   
     THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE ''   
    END),  
    COLL_TYPE  
   FROM   
    MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)  
   WHERE  
    PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER)  
    AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'  
    AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))  
    AND C.SEGMENT = 'FUTURES'  
   ) COLL  
  GROUP BY  
   PARTY_CODE,  
   MARGINDATE,  
   SCRIP_CD,  
   BGNO,  
   BG_EXPIRYDATE,  
   FDRNO,  
   FDR_EXPIRYDATE,  
   UPPER(COLL_TYPE)  
  
  INSERT INTO #FINAL_REPORT  
  SELECT  
   PARTY_CODE  = M.PARTY_CODE,  
   MARGINDATE,  
   EXCHANGE,  
   SEGMENT   = 'F&O',  
   LED_MARGIN_AMT = 0,  
   NONCASH_AMT  = 0,  
   BGFD_AMT  = 0,  
   OTHER_MARGIN = 0,  
   TOTAL_MARGIN_AVL= 0,  
   INITIALMARGIN = 0,  
   EXPOSURE_MARGIN = 0,  
   TOTAL_MARGIN = 0,  
   EXCESS_SHORTFALL= 0,  
   ADD_MARGIN  = 0,  
   MARGIN_STATUS = 0,  
   PARTYNAME,  
   L_ADDRESS1,  
   L_ADDRESS2,  
   L_ADDRESS3,  
   L_CITY,  
   L_ZIP,  
   L_STATE,  
   L_NATION,  
   RES_PHONE,  
   OFF_PHONE,  
   EMAIL,  
   PAN_GIR_NO,  
   BRANCH_CD,  
   SUB_BROKER,  
   RPT_ORD = UPPER(COLL_TYPE),  
   SCRIP_CD,  
   QTY,  
   SEC_AMOUNT,  
   BGNO,  
   BG_AMOUNT,  
   BG_EXPIRYDATE,  
   FDRNO,  
   FDR_AMOUNT,  
   FDR_EXPIRYDATE  
  FROM  
   #COLL_DETAIL   M (NOLOCK),  
   #CLIENTMASTER  C (NOLOCK)  
  WHERE  
   M.PARTY_CODE = C.PARTY_CODE  
   AND M.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #FINAL_REPORT)  
 END  
  
 SELECT * FROM #FINAL_REPORT  
 ORDER BY PARTY_CODE,RPT_ORD    
  
 DROP TABLE #MARGIN_DETAIL  
 DROP TABLE #MCLIENT  
 DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_Delivery_Margin
-- --------------------------------------------------

--execute RPT_Delivery_Margin 'Feb 20 2008','Feb 29 2008','0','zzzz','Detail'   
  
  
CREATE  proceDURE [dbo].[RPT_Delivery_Margin]  
  
(  
@FROMDATE varchar(11),  
@TODATE varchar(11),  
@FromParty varchar(15),  
@ToParty varchar(15),  
@reportfor varchar(10)  
  
)  
  
 AS  
if @FromParty = '' begin set @FromParty = '0' end  
if @ToParty = '' begin set @ToParty = 'zzzzzzzz' end  
  
   
set transaction isolation level read uncommitted  
if @reportfor = 'Detail'  
Begin  
 Select  
  
   MDate_From = Convert(Varchar,d.MDate_From,103),  
         MDate_To = Convert(Varchar,d.MDate_To,103),  
         d.Party_Code,  
   d.Symbol,  
  d.Sett_No,  
  d.Sett_Type,  
  d.Margin,  
  C1.Long_name   
From   
   Client1 C1,  
   Delivery_Party_Margin d  
  
 Where  
  
         c1.Cl_code=d.Party_code   
        and MDate_From >= @FROMDATE And MDate_To <= @TODATE  
         And Party_Code between @FromParty and @ToParty  
Order By  
  
         d.Party_Code,  
         d.Symbol  
End   
Else  
begin  
select  
      MDate_From = Convert(Varchar,d.MDate_From,103),  
      MDate_To = Convert(Varchar,d.MDate_To,103),  
      d.Party_Code,  
      --d.Symbol,  
      d.Sett_No,  
      d.Sett_Type,  
      Margin = Sum(d.Margin),  
      C1.Long_name   
from  
      Client1 C1,  
      Delivery_Party_Margin d  
Where  
      MDate_From >= @FROMDATE And MDate_To <= @TODATE  
      And Party_Code between @FromParty and @ToParty 
      And d.party_code = C1.cl_code  
Group BY   
        d.MDate_From,  
        d.MDate_To,  
        d.Party_Code,  
        --d.Symbol,  
        d.Sett_No,  
        d.Sett_Type,  
        C1.Long_name   
Order By  
        d.Party_Code,  
        --d.Symbol,  
        C1.Long_name   
   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Delivery_Obligation
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[rpt_Delivery_Obligation]
(
	@date_frm varchar(11),
	@date_to varchar(11),
	@symbol varchar(12),
	@SettType varchar(2),
	@SettNo varchar(8),
	@ReportFor varchar(10)
)
 AS

 Set transaction isolation level read uncommitted

If @ReportFor = 'SUMMARY'

Begin

	 Select
		Report_Date = Convert(varchar,Report_Date,103),
		Sett_Type,
		Sett_No,
		Inst_Type,
		Symbol,
		Expiry_Date = Convert(varchar,Expiry_Date,103),
		Strike_Price,
		Option_Type,
		WareHouse,
		PayIn_Qty,
		PayOut_Qty,
		PayIn_Value,
		PayOut_Value,
		IsIn
From
		Delivery_Obl_Net

Where	 
		Report_Date between @date_frm and @date_to and
		symbol like @symbol +'%'

Order By 
		Sett_no,Sett_Type,Symbol

End

Else

Begin

	Select 

        Report_Date = Convert(varchar,Report_Date,103),
        Request_Date = Convert(varchar,Request_Date,103),     
        Inst_Type,
        Expiry_Date = Convert(varchar,Expiry_Date,103),
        Strike_Price,
        Option_Type,
        CRA_Level,
        WareHouse,
        MemberCode,
        Member_Ac_Type,
        Party_Code,
        Sell_Buy,
        Tot_Req_Qty,
        Qty_Req_Demat,
        Qty_Req_Non_Demat,
        Accept_Flag,
        Total_Allocated_Qty,
        Total_Rej_Qty

From 
        Delivery_Obl_Clt

Where 
		Sett_Type = @SettType and 
		Sett_No = @SettNo and 
		Symbol like @Symbol +'%'

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_Delivery_Sales_Tax_Details_Rpt
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_Delivery_Sales_Tax_Details_Rpt]
	(
    @party_frm VARCHAR(15),
	@party_to VARCHAR(15),
	@warehouse_frm VARCHAR(15),
	@warehouse_to VARCHAR(15)
	)
	
AS
    if @party_frm = '' begin set @party_frm = '0'  end
    if @party_to = '' begin set @party_to = 'zzzzzz' end
    if @warehouse_frm = '' begin set @warehouse_frm = '0'  end
    if @warehouse_to = '' begin set @warehouse_to = 'zzzzzz' end

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT
	  W.Party_Code,
	  W.WareHouse,
	  A.Long_Name,
	  A.Address

FROM

   Delivery_Sales_Tax_Cl_WareHouse W , Delivery_Sales_Tax_Cl_Address A

WHERE
      W.Party_Code = A.Party_Code
      AND W.Party_Code between @party_frm and @party_to 
      AND W.WareHouse between @warehouse_frm and @warehouse_to

Order By 
      
    W.Party_Code,
    W.WareHouse,
    A.Long_Name,
    A.Address

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_DelSettPosition
-- --------------------------------------------------
CREATE  Proc Rpt_DelSettPosition
	(
		@StatusId Varchar(15),
		@StatusName Varchar(25),
		@SettNo Varchar(7),
		@Sett_Type Varchar(2),
		@strOrder varchar(10) = 'PARTY'
	)  
As  


if @strOrder = 'PARTY'
begin
	Select 
		D.Party_Code,
		Long_Name,
		D.Symbol,
		ExpiryDate = Left(D.Expiry_Date,11),
		WareHouse ,
		ToDelQty=(Case When Sell_Buy = 'S' then Total_Allocated_Qty Else 0 end ), 
		ToRecQty=(Case When Sell_Buy = 'B' then Total_Allocated_Qty Else 0 end )   
	From
		Delivery_Obl_Clt D, Client1, Client2
	Where
		Sett_no = @SettNo and Sett_type = @Sett_Type   
		And D.Party_Code = Client2.Party_Code
		And Client1.Cl_Code = Client2.Cl_Code
		AND @STATUSNAME =   
		  (CASE   
			   WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD  
			   WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER  
			   WHEN @STATUSID = 'TRADER' THEN TRADER  
			   WHEN @STATUSID = 'FAMILY' THEN FAMILY  
			   WHEN @STATUSID = 'AREA' THEN AREA  
			   WHEN @STATUSID = 'REGION' THEN REGION  
			   WHEN @STATUSID = 'CLIENT' THEN D.PARTY_CODE  
		   ELSE   
		  'BROKER'  
		  END)   
	Order By
		 D.Party_Code,Long_Name,D.Symbol,WareHouse
		
end
else
begin
	Select 
		D.Party_Code,
		Long_Name,
		D.Symbol,
		ExpiryDate = Left(D.Expiry_Date,11),
		WareHouse ,
		ToDelQty=(Case When Sell_Buy = 'S' then Total_Allocated_Qty Else 0 end ), 
		ToRecQty=(Case When Sell_Buy = 'B' then Total_Allocated_Qty Else 0 end )   
	From
		Delivery_Obl_Clt D, Client1, Client2
	Where
		Sett_no = @SettNo and Sett_type = @Sett_Type   
		And D.Party_Code = Client2.Party_Code
		And Client1.Cl_Code = Client2.Cl_Code
		AND @STATUSNAME =   
		  (CASE   
			   WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD  
			   WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER  
			   WHEN @STATUSID = 'TRADER' THEN TRADER  
			   WHEN @STATUSID = 'FAMILY' THEN FAMILY  
			   WHEN @STATUSID = 'AREA' THEN AREA  
			   WHEN @STATUSID = 'REGION' THEN REGION  
			   WHEN @STATUSID = 'CLIENT' THEN D.PARTY_CODE  
		   ELSE   
		  'BROKER'  
		  END)   
	Order By
		 D.Symbol,WareHouse,D.Party_Code,Long_Name

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_edoprocess
-- --------------------------------------------------
CREATE proceDURE [dbo].[rpt_edoprocess]
	@fromdate as varchar(11),
	@todate as varchar(11),
	@RptType Varchar(10)
	AS
SET @fromdate = CONVERT(varchar,@fromdate,109)             
SET @todate   = CONVERT(varchar,@todate,109)   
  
set transaction isolation level read uncommitted

If (@RptType = 'Summary')
Begin
	select
		Business_Date ,
		Import_Trade,
		VBB ,
		STT ,
		Billing,
		Contract,
		Posting,
		PositionFile,
		MarginFile,
		MarginReturnFile,
		ClientMarginPop,
		ExchangeSTT,
		ExerciseAllocation,
		Open_Close,
 		ProcessDate,
		ProcessBy,
		LastUpdateDate,
		LastUpdateBy,
		MachineIP
	
	from
		V2_Business_Process(NOLOCK)
	WHERE
	 ProcessDate >= @fromdate   
   	 And   ProcessDate <= @todate + ' 23:59:59'     
 END
Else

If (@RptType = 'Detail')
Begin
	select
		SNO,
		Exchange ,
		Segment,
		BusinessDate,
		ProcessId,
		ProcessName,
		FileName,
		Start_End_Flag,
		ProcessDate,
		ProcessBy,
		MachineIP
	from
		V2_Process_Status_Log(NOLOCK)
	WHERE
	 ProcessDate >= @fromdate   
   	 And   ProcessDate <= @todate + ' 23:59:59'  

 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ERRORLOG
-- --------------------------------------------------




CREATE  Procedure  rpt_ERRORLOG          
@fromdate as varchar(11),
@todate as varchar(11)


AS    
SET @fromdate = CONVERT(varchar,@fromdate,109)             
SET @todate = CONVERT(varchar,@todate,109)     
          
set transaction isolation level read uncommitted                
  
SELECT   
	Cname,
	Mname,
	Sname,
	Errstr,   
	Errdate = CONVERT(varchar,Errdate,109) 
	    
FROM Errorlog(NOLOCK)  

where  
	Errdate >= @FROMDATE  
   	AND Errdate <= @TODATE + ' 23:59:59'  
Order by Errdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_explimit
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 01/15/2005 5:13:23 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 12/16/2003 2:36:34 PM ******/  
  
  
  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 09/10/2001 6:27:28 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 09/07/2001 10:36:21 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 9/7/01 5:07:36 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 9/7/2001 4:10:18 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 08/10/2001 4:53:52 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 8/7/01 4:29:14 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 7/25/01 10:06:07 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 7/1/01 2:26:38 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 06/26/2001 8:48:38 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 04/27/2001 4:32:38 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 3/21/01 12:50:14 PM ******/  
  
/****** Object:  Stored Procedure dbo.Rpt_explimit    Script Date: 20-Mar-01 11:38:55 PM ******/  
  
/*  
Written by neelambari on 13 feb 2001  
report : Nse > ExposureLimit  
*/  
  
CREATE PROCEDURE Rpt_explimit  
@partycode varchar(7),  
@Partyname varchar(21)  
AS  
select c3.party_code,c3.exchange,c3.markettype ,  
c3.margin, c3.nooftimes,c3.pmarginrate ,c1.short_name  
from client3 c3 ,client1 c1 where c3.party_code like @partycode+'%' and   
c1.cl_code=c3.cl_code and c1.Short_name like @partyname+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_family
-- --------------------------------------------------
/* Familywise Ledger */  
/* Finds Families From Client1 */  
Create Procedure Rpt_family
@Statusid Varchar(15),   
@Statusname  Varchar(25)  
As  
If @Statusid = 'Broker'  
	Begin  
		Select Distinct Family From Client1  
		Order By Family  
	End  
If @Statusid = 'Family'  
	Begin  
		Select Distinct Family From Client1  
		Where Family = @Statusname  
		Order By Family  
	End  
If @Statusid = 'Branch'
	Begin
		Select Distinct Family From Client1
		Where Branch_Cd = @Statusname
		Order by Family
	End
If @Statusid = 'SubBroker'
	Begin
		Select Distinct Family From Client1
		Where Sub_Broker = @Statusname
		Order by Family
	End
If @Statusid = 'Trader'
	Begin
		Select Distinct Family From Client1
		Where Trader = @Statusname
		Order by Family
	End
Else
	Begin
		Select Family From Client1
		Where 1 = 0
	End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_finyearlist
-- --------------------------------------------------
CREATE Procedure  [dbo].[Rpt_finyearlist]    
As    
Select Distinct  Smonth = Datename(Month, Sdtcur), Syear = Datename(Year, Sdtcur), Emonth = Datename(Month, Ldtcur),     
 Lyear = Datename(Year, Ldtcur) , Sdt = Convert(Varchar, Sdtcur, 103),     
Ldt = Convert(Varchar, Ldtcur, 103), Curyear From ACCOUNTNCE.DBO.Parameter    
Order By Curyear Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fobrokser1
-- --------------------------------------------------


/****** Object:  Stored Procedure dbo.rpt_fobrokser1    Script Date: 1/17/2004 11:42:48 PM ******/



/****** Object:  Stored Procedure dbo.rpt_fobrokser1    Script Date: 09/10/2001 6:27:28 PM ******/


CREATE   PROCEDURE rpt_fobrokser1
@fdate varchar(12),
@tdate varchar(12),
@fpartycode varchar(10),
@tpartycode varchar(10),
@flag varchar(1)
AS
if @flag = 0 
begin
	select brokapplied = (case when left(convert(varchar,f.sauda_date,109),11) not in (select distinct left(convert(varchar,expirydate,109),11) from foscrip2)
		then sum(brokapplied*tradeqty)+ (Case When C2.Service_Chrg = 1 Then sum(service_tax) else 0 end ) 
		else sum(brokapplied*tradeqty)+ (Case When C2.Service_Chrg = 1 Then sum(service_tax) else 0 end )
 + (select isnull(sum(nbrokapp*tradeqty),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code)
 + (Case When C2.Service_Chrg = 1 Then (select isnull(sum(nsertax),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code) else 0 end )
		end),

servicetax = (case when left(convert(varchar,f.sauda_date,109),11) not in (select distinct left(convert(varchar,expirydate,109),11) from foscrip2)
then (Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end )
else
(Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end ) + 
(Case When C2.Service_Chrg = 0 Then (select isnull(sum(nsertax),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code) else 0 end )
 end),
/*	     servicetax = (Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end ) */
	     Broker_chrg =(Case When Brokernote = 1 then sum(Broker_chrg) else 0 end ),
             sebi_tax =(Case When Sebi_Turn_tax = 1 then sum(sebi_tax) else 0 end),
             turn_tax =(Case When Turnover_tax = 1 Then sum(turn_tax) else 0 end ),
             other_chrg =(case when C2.Other_chrg = 1 then sum(F.other_chrg) else 0 end), sdate =left( convert(varchar,sauda_date,109),11),ndate=convert(varchar,sauda_date,101),
	F.party_code,Amount = sum(Amount)
	from fosettlement F,Client2 C2
	where sauda_date >= @fdate and sauda_date  <= @tdate + ' 23:59'
	and F.party_code  >=  @fpartycode  and F.party_code  <=  @tpartycode  
	And F.Party_code = C2.Party_code
	group by convert(varchar,sauda_date,101),left( convert(varchar,sauda_date,109),11), F.party_code,C2.Service_Chrg,Brokernote,Sebi_Turn_tax,Turnover_tax,C2.Other_chrg

	union all
	
              Select BrokApplied = Sum(Brokerage) ,Service_tax = Sum(Service_tax), Broker_chrg = 0,sebi_tax = 0,turn_tax = 0,other_chrg = 0, sdate =left( convert(varchar,sauda_date,109),11),ndate=convert(varchar,sauda_date,101),
	party_code,Amount = 0 from foCarryFwdBrok ff
	where sauda_date >= @fdate and sauda_date  <= @tdate + ' 23:59'
	and party_code  >=  @fpartycode  and party_code  <=  @tpartycode  
	group by convert(varchar,sauda_date,101),left( convert(varchar,sauda_date,109),11), party_code
	order by f.party_code,convert(varchar,sauda_date,101)

end 
else if @flag = 1 
begin

	/*select brokapplied = sum(brokapplied*tradeqty)+ (Case When C2.Service_Chrg = 1 Then sum(service_tax) else 0 end ),*/
	select brokapplied = (case when left(convert(varchar,f.sauda_date,109),11) not in (select distinct left(convert(varchar,expirydate,109),11) from foscrip2)
		then sum(brokapplied*tradeqty)+ (Case When C2.Service_Chrg = 1 Then sum(service_tax) else 0 end ) 
		else sum(brokapplied*tradeqty)+ (Case When C2.Service_Chrg = 1 Then sum(service_tax) else 0 end )
 + (select isnull(sum(nbrokapp*tradeqty),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code)
 + (Case When C2.Service_Chrg = 1 Then (select isnull(sum(nsertax),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code) else 0 end )
		end),


servicetax = (case when left(convert(varchar,f.sauda_date,109),11) not in (select distinct left(convert(varchar,expirydate,109),11) from foscrip2)
then (Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end )
else
(Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end ) + 
(Case When C2.Service_Chrg = 0 Then (select isnull(sum(nsertax),0) from fosettlement where left(convert(varchar,expirydate,109),11) = left(convert(varchar,f.sauda_date,109),11) and billflag > 3 and party_code = f.party_code) else 0 end )
 end),
/*	     servicetax = (Case When C2.Service_Chrg = 0 Then sum(service_tax) else 0 end ) */	Broker_chrg =(Case When Brokernote = 1 then sum(Broker_chrg) else 0 end ),
             sebi_tax =(Case When Sebi_Turn_tax = 1 then sum(sebi_tax) else 0 end),
             turn_tax =(Case When Turnover_tax = 1 Then sum(turn_tax) else 0 end ),
             other_chrg =(case when C2.Other_chrg = 1 then sum(F.other_chrg) else 0 end),sdate =left( convert(varchar,sauda_date,109),11),ndate=convert(varchar,sauda_date,101),
	F.party_code,Amount = sum(Amount)
	from fosettlement F,Client2 C2
	where sauda_date >= @fdate and sauda_date  <= @tdate + ' 23:59'
	and F.party_code  like ltrim(@fpartycode) + '%'
	And F.Party_code = C2.Party_code
	group by convert(varchar,sauda_date,101),left( convert(varchar,sauda_date,109),11), F.party_code,C2.Service_Chrg,Brokernote,Sebi_Turn_tax,Turnover_tax,C2.Other_chrg

	union all	

              Select BrokApplied = Sum(Brokerage) ,Service_tax = Sum(Service_tax), Broker_chrg = 0,sebi_tax = 0,turn_tax = 0,other_chrg = 0, sdate =left( convert(varchar,sauda_date,109),11),ndate=convert(varchar,sauda_date,101),
	party_code,Amount = 0 from foCarryFwdBrok f
	where sauda_date >= @fdate and sauda_date  <= @tdate + ' 23:59'
	and party_code  like ltrim(@fpartycode) + '%'
	group by convert(varchar,sauda_date,101),left( convert(varchar,sauda_date,109),11), party_code
	order by f.party_code,convert(varchar,sauda_date,101)

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_focashclient3
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 09/10/2001 6:27:28 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 09/07/2001 10:36:22 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 9/7/01 5:07:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 9/7/2001 4:10:18 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 08/10/2001 4:53:52 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 7/25/01 10:06:07 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 7/3/01 11:19:04 AM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 5/11/01 12:08:54 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 5/7/2001 9:02:47 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 5/5/2001 2:43:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 5/5/2001 1:24:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 4/30/01 5:50:07 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 10/26/00 6:04:40 PM ******/






/****** Object:  Stored Procedure dbo.rpt_focashclient3    Script Date: 12/27/00 8:59:09 PM ******/
CREATE  PROCEDURE rpt_focashclient3
@code varchar(10)
AS
select isnull(margin_recd ,0)
from client3 
where party_code = @code
and exchange = 'NSE' 
and markettype like 'Future%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclientdetailbill1
-- --------------------------------------------------
CREATE PROCEDURE rpt_foclientdetailbill1

@statusid varchar(15),
@statusname varchar(25),
@code varchar(10),
@sdate varchar(12),
@tdate varchar(12)
AS

if @statusid = 'broker'
begin
	select  party_code ,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl
	where party_code like ltrim(@code)
	and billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by party_code,billdate,yy,dd,mm
	order by party_code,yy,mm,dd

end 

if @statusid = 'branch'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl fo,client2 c2, client1 c1, branches b
	where fo.Party_Code = c2.party_code and 
	 b.short_name = c1.trader and
	 c1.cl_code = c2.cl_code and
	 b.branch_cd = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by fo.party_code,billdate,yy,dd,mm
	order by fo.party_code,yy,mm,dd
end 

if @statusid = 'subbroker'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl fo,client2 c2, client1 c1, subbrokers sb
	where fo.Party_Code = c2.party_code and 
	sb.sub_broker = @statusname and
	sb.sub_broker = c1.sub_broker and
	c1.cl_code = c2.cl_code and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by fo.party_code,billdate,yy,dd,mm
	order by fo.party_code,yy,mm,dd
end 

if @statusid = 'trader'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	c1.trader  = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by fo.party_code,billdate,yy,dd,mm
	order by fo.party_code,yy,mm,dd
end 

if @statusid = 'client'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	fo.party_code = @statusname and
	fo.party_code like ltrim(@code)
	and billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by fo.party_code,billdate,yy,dd,mm
	order by fo.party_code,yy,mm,dd
end 

if @statusid = 'family'
begin
	select  fo.party_code,billdate =left(convert(varchar,billdate,106),11),
	credit = sum(credit),
	debit  = sum(debit) ,yy,dd,mm
	from Rpt_FoColl fo,client2 c2, client1 c1
	where fo.Party_Code = c2.party_code and 
	c1.cl_code = c2.cl_code and
	c1.family  = @statusname and
	fo.party_code like ltrim(@code)
	and  billdate >= @sdate and billdate <= @tdate+ ' 23:59:59'
	group by fo.party_code,billdate,yy,dd,mm
	order by fo.party_code,yy,mm,dd
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclientwisemargin3
-- --------------------------------------------------

CREATE PROCEDURE rpt_foclientwisemargin3  
  
@statusid varchar(15),  
@statusname varchar(25),  
@code varchar(10),  
@branch varchar(20)  
AS  
  
if @statusid = 'broker'  
begin  
 select distinct s.party_code,  ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union   
  
 select distinct s.party_code,  ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union   
  
 select distinct s.party_code,  ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 union   
  
 select distinct s.cltcode as party_code,  ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, branch b  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
    Order By S.Party_code  
  
end   
  
if @statusid = 'branch'  
begin  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, branch b, branches b1  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch_code)) =@statusname  
 and ltrim(rtrim(b1.short_name)) =ltrim(rtrim(c1.trader))   
 and ltrim(rtrim(b1.branch_cd))  = ltrim(rtrim(b.branch_code))   
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
   union   
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, branch b, branches b1  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch_code)) =@statusname  
 and ltrim(rtrim(b1.short_name)) =ltrim(rtrim(c1.trader))   
 and ltrim(rtrim(b1.branch_cd))  = ltrim(rtrim(b.branch_code))   
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
   union   
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, branch b, branches b1  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch_code)) =@statusname  
 and ltrim(rtrim(b1.short_name)) =ltrim(rtrim(c1.trader))   
 and ltrim(rtrim(b1.branch_cd))  = ltrim(rtrim(b.branch_code))   
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
   union   
  
 select distinct s.cltcode as party_code , ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, branch b, branches b1  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(b.branch_code)) =@statusname  
 and ltrim(rtrim(b1.short_name)) =ltrim(rtrim(c1.trader))   
 and ltrim(rtrim(b1.branch_cd))  = ltrim(rtrim(b.branch_code))   
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 order by s.party_code  
end   
  
if @statusid = 'subbroker'  
begin  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, subbrokers sb, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(sb.sub_broker)) =ltrim(rtrim(c1.sub_broker))   
 and ltrim(rtrim(sb.sub_broker)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, subbrokers sb, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(sb.sub_broker)) =ltrim(rtrim(c1.sub_broker))   
 and ltrim(rtrim(sb.sub_broker)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
  
 union  
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, subbrokers sb, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(sb.sub_broker)) =ltrim(rtrim(c1.sub_broker))   
 and ltrim(rtrim(sb.sub_broker)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.cltcode as party_code , ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, subbrokers sb, branch b  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(sb.sub_broker)) =ltrim(rtrim(c1.sub_broker))   
 and ltrim(rtrim(sb.sub_broker)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 order by s.party_code  
  
end   
  
  
if @statusid = 'trader'  
begin  
  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.trader)) =@statusname    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union   
  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.trader)) =@statusname    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union   
  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.trader)) =@statusname    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union   
  
 select distinct s.cltcode as party_code ,  ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, branch b  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.trader)) =@statusname    
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 order by s.party_code  
  
end   
  
  
if @statusid = 'client'  
begin  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and c2.party_code= @statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and c2.party_code= @statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.party_code , ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and c2.party_code= @statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.cltcode as party_code , ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, branch b  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and c2.party_code= @statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 order by s.party_code  
end   
  
  
if @statusid = 'family'  
begin  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from fosettlement s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.family)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from msajag.dbo.Collateral s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.family)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.party_code ,  ltrim(rtrim(b.branch)) as branch  
 from nsefo.dbo.fomarginnew s,  client1 c1, client2 c2, branch b  
 where s.party_code like ltrim(@code)  
 and  s.party_code = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.family)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
  
 union  
  
 select distinct s.cltcode as party_code ,  ltrim(rtrim(b.branch)) as branch  
 from accountfo.dbo.ledger s,  client1 c1, client2 c2, branch b  
 where s.cltcode like ltrim(@code)  
 and  s.cltcode = c2.party_code   
 and ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c1.cl_code))    
 and ltrim(rtrim(c1.family)) =@statusname  
 and ltrim(rtrim(b.branch)) like @branch  
 and ltrim(rtrim(c1.branch_cd)) =  ltrim(rtrim(b.branch_code))   
 order by s.party_code  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclosingdetail1
-- --------------------------------------------------



CREATE   proceDURE [dbo].[rpt_foclosingdetail1]

	@tdate varchar(20),
	@instru_type varchar(4),
	@sym_frm varchar(12),
	@sym_to varchar(12),
	@srt_odr varchar(3)


AS

if @sym_to= '' begin set @sym_to = 'zzzzzzzz' end

set transaction isolation level read uncommitted
select
	ReportOrder = 
			Case 
				When    @srt_odr ='sym' 
				Then 
					Symbol + Convert(Varchar,ExpiryDate,112)
				Else
					Convert(Varchar,ExpiryDate,112) + Symbol
			End,
    Trade_Date= Left(Trade_Date,11),
	Expirydate=Left(Expirydate,11),
	Inst_type,
	Symbol,
	strike_price,
	Option_type,
	cl_rate
from
	FoClosing (nolock)
where
	Symbol BETWEEN @sym_frm AND @sym_to 
	AND  1 = Case 
					When @instru_type = 'BOTH' 
					Then
						1
					Else 
						Case When @instru_type = 'FUT' 
							Then 
								Case When Left(Inst_Type,3) = 'FUT' Then 1 else 2 End
							Else
								Case When Left(Inst_Type,3) = 'OPT' Then 1 else 2 End
							End
					End
	AND Left(Trade_Date,11) = @tdate 
Order By 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foclosingrate
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 09/10/2001 6:27:29 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 09/07/2001 10:36:22 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 9/7/01 5:07:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 9/7/2001 4:10:19 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 08/10/2001 4:53:52 PM ******/


/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 7/25/01 10:06:08 PM ******/



/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 7/18/2001 6:18:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 5/11/01 12:08:55 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 5/7/2001 9:02:47 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 5/5/2001 2:43:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 5/5/2001 1:24:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 4/30/01 5:50:09 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 10/26/00 6:04:41 PM ******/






/****** Object:  Stored Procedure dbo.rpt_foclosingrate    Script Date: 12/27/00 8:59:09 PM ******/
/*
Used In      : NSE FO
Report Name  : Closing Report
File Name    : closingdate
Tables Used  : foclosing
Function     : Returns tradedate
Written By   : Amolika Patil 
Modified By  : Amolika on 2nd Feb'2001 : Added order by trade_date for sorting 
Modified By  : Amolika on 12nd Feb'2001 : Added order by trade_date for sorting in descending order
*/
CREATE  PROCEDURE rpt_foclosingrate
AS
select distinct convert(varchar,trade_date,106) as tradedate, TRADE_DATE
from foclosing
ORDER BY TRADE_DATE desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_focollateralbank
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 09/10/2001 6:27:29 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 09/07/2001 10:36:22 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 9/7/01 5:07:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 9/7/2001 4:10:19 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 08/10/2001 4:53:53 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 7/25/01 10:06:08 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 5/11/01 12:08:55 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 5/7/2001 9:02:48 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 5/5/2001 2:43:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 5/5/2001 1:24:10 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 10/18/00 9:14:25 PM ******/






/****** Object:  Stored Procedure dbo.rpt_focollateralbank    Script Date: 12/27/00 8:59:09 PM ******/
CREATE  PROCEDURE rpt_focollateralbank
@code varchar(10)
AS
select isnull(sum(bk_guarantee_amt),0)
from bankguarantee
where exch_indicator = 'NSE'
and seg_indicator like 'Future%'
and party_code like ltrim(@code)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_focollateralfd
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 09/10/2001 6:27:29 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 09/07/2001 10:36:22 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 9/7/01 5:07:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 9/7/2001 4:10:19 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 08/10/2001 4:53:53 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 7/25/01 10:06:08 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 5/11/01 12:08:56 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 5/7/2001 9:02:48 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 5/5/2001 2:43:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 5/5/2001 1:24:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 10/18/00 9:14:25 PM ******/






/****** Object:  Stored Procedure dbo.rpt_focollateralfd    Script Date: 12/27/00 8:59:09 PM ******/
CREATE  PROCEDURE rpt_focollateralfd
@code varchar(10)
AS
select isnull(sum(fd_amt),0)
from fixeddeposits 
where exch_indicator = 'NSE'
and seg_indicator like 'Future%'
and party_code like ltrim(@code)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_focollateralnoncash
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 09/10/2001 6:27:29 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 09/07/2001 10:36:22 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 9/7/01 5:07:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 9/7/2001 4:10:19 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 08/10/2001 4:53:53 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 7/25/01 10:06:08 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 5/11/01 12:08:56 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 5/7/2001 9:02:48 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 5/5/2001 2:43:36 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 5/5/2001 1:24:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 10/18/00 9:14:25 PM ******/






/****** Object:  Stored Procedure dbo.rpt_focollateralnoncash    Script Date: 12/27/00 8:59:09 PM ******/
CREATE  PROCEDURE rpt_focollateralnoncash
@code varchar(10)
AS
select s2.scrip_cd, sum(s.qty*c.cl_rate) as amount, s.qty, c.cl_rate
from securities s, scrip2 s2, closing c
where s.scrip_cd = s2.scrip_cd
and s.series = s2.series
and party_code like ltrim(@code)+'%'
and s.scrip_cd = c.scrip_cd
and exch_indicator = 'NSE' 
and seg_indicator like 'F%'
and left(convert(varchar,sysdate,109),11)  = (select max(left(convert(varchar,sysdate,109),11)) from closing where left(convert(varchar,sysdate,109),11) <= left(convert(varchar,getdate(),109),11))
group by s2.scrip_cd, s.qty, c.cl_rate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fodate2
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 09/10/2001 6:27:29 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 09/07/2001 10:36:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 9/7/01 5:07:38 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 9/7/2001 4:10:20 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 08/10/2001 4:53:53 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 7/25/01 10:06:08 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 5/11/01 12:08:56 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 5/7/2001 9:02:48 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 5/5/2001 2:43:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 5/5/2001 1:24:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 4/30/01 5:50:11 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 10/26/00 6:04:42 PM ******/






/****** Object:  Stored Procedure dbo.rpt_fodate2    Script Date: 12/27/00 8:59:09 PM ******/
CREATE  PROCEDURE rpt_fodate2
@sdate varchar(12)
 
AS
select distinct left(convert(varchar,sauda_date,109),11) as billdate from fosettlement
where convert(varchar,sauda_date,106) = @sdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fodetail_New
-- --------------------------------------------------



CREATE  PROCEDURE rpt_fodetail_New
(
	@code varchar(10),    
	@sdate varchar(12),    
	@CashFlag Varchar(1),    
	@ReportPara Varchar(5),
	@cltype varchar (3) =''
)    

AS    

Declare @Exchange varchar(3)
Select @Exchange = Exchange from FoGlobals
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

--*** rpt_fobankdetail ***--    
If @ReportPara = '1'    
 Begin    
  select 
	Party_code, bank_code,bk_guarantee_no=FD_BG_NO,
	Receive_Date =convert(varchar,Receive_Date,106),
	convert(varchar,Maturity_Date,106) as maturitydate, 
	bk_guarantee_amt=FinalAmount    
  from
	Msajag.Dbo.CollateralDetails     
  where
	party_code = @code    
	and exchange = @Exchange
	and segment like 'Futures'    
	And Coll_Type = 'BG'    
	and EffDate like @sdate + '%'    
  Order By party_code,scrip_cd,Series    
 End     
    
    
--*** rpt_focolmargin ***--    
If @ReportPara = '2'    
 Begin    
  select
	party_code,
	amount=Sum(Finalamount)    
  from
	msajag.dbo.collateralDetails    
  where
	party_code = @code    
	and exchange = @Exchange      
	and segment like 'FUTURES'    
	and EffDate like @sdate + '%'    
	and Coll_Type = 'MARGIN'    
	and Cash_Ncash = @CashFlag    
  Group by Party_Code    
 End    
    
    
--*** rpt_fofd ***--    
If @ReportPara = '3'    
 Begin    
  select 
	party_code,
	Fd_Name=Bank_Code,
	FDR_No=Fd_Bg_No, 
	fd_amt=FinalAmount,     
	convert(varchar,Maturity_Date,106) as maturitydate,    
	convert(varchar,Receive_Date,106) as Receive_date    
  from 
	msajag.dbo.collateraldetails     
  where 
	Exchange = @Exchange    
	and Segment like 'Futures'    
	and party_code = @code    
	and coll_type = 'FD'    
	and effdate like @sdate + '%'    
 End     
    
    
    
--*** rpt_fomodbankguarantee ***--    
If @ReportPara = '4'    
 Begin    
  select 
	party_code,
	bk_guarantee_amt=Sum(FinalAmount)    
  from
	msajag.dbo.collateraldetails     
  where
	party_code = @CODE    
	and exchange = @Exchange     
	and segment like 'Futures'     
	and Coll_Type = 'BG'    
	and effDate Like  @sdate + '%'    
	and Cash_Ncash = @CashFlag    
  group by party_code     
 End    
    
    
    
--*** rpt_fomodfixeddeposits ***--    
If @ReportPara = '5'    
 Begin    
  select
	party_code,
	fd_amt=Sum(FinalAmount )    
  from
	msajag.dbo.collateralDetails     
  where 
	party_code =@code     
	and exchange = @Exchange     
	and segment like 'Futures'     
	and Coll_Type = 'FD'    
	and effDate Like  @sdate + '%'    
	and Cash_Ncash = @CashFlag    
  Group by Party_Code    
 End    
    
    
--*** rpt_fosecurities_new ***--    
If @ReportPara = '6'    
 Begin    
  select 
	party_code,
	scrip_cd,
	Series, 
	qty, 
	cl_rate, 
	Amount = FinalAmount    
  from
	Msajag.Dbo.CollateralDetails     
  where
	party_code = @code    
	and exchange = @Exchange     
	and segment like 'Futures'    
	And Coll_Type = 'SEC'    
	and EffDate like @sdate + '%'    
	and Cash_Ncash = @CashFlag    
  Order By party_code,scrip_cd,Series    
 End    
    
    
  
If @ReportPara = '7' And @cltype = 'EXC'     
 Begin    
  select 
	c.party_code, 
	coll_date= Trans_Date, 
	cash, 
	noncash, 
	cl_type    
  from 
	msajag.dbo.collateral c, client1 c1, client2 c2    
  where 
	c.party_code like ltrim(@code)+'%'     
	and c.exchange = @Exchange    
	and c.segment = 'FUTURES'    
	and c1.cl_type = @cltype    
	and c1.cl_code = c2.cl_code    
	and c.party_code = c2.party_code    
	and left(convert(varchar,Trans_Date,109),11) = @sdate    
 End     
Else If @ReportPara = '7'   
 Begin    
  select 
	c.party_code, 
	coll_date= Trans_Date , 
	cash, 
	noncash , 
	cl_type    
  from 
	msajag.dbo.collateral c, client1 c1, client2 c2    
  where 
	c.party_code like ltrim(@code)+'%'     
	and c.exchange = @Exchange   
	and c.segment = 'FUTURES'    
	and c1.cl_type like ltrim(@cltype)+'%'    
	and c1.cl_type <> 'EXC'    
	and c1.cl_code = c2.cl_code    
	and c.party_code = c2.party_code    
	and left(convert(varchar,Trans_Date,109),11) = @sdate  
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_folistclient
-- --------------------------------------------------


CREATE  PROCEDURE rpt_folistclient
@statusid varchar(15),
@statusname varchar(25)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

if @statusid='broker'
  begin
    select distinct "<option value="+rtrim(party_code)+">"+rtrim(party_code)+"</option>" , party_code
    from CLIENT2
    order by party_code
  end

if @statusid='branch'
  begin
    select distinct "<option value="+rtrim(Party_Code)+">"+rtrim(Party_Code)+"</option>" , Party_Code
    from client2 c2, client1 c1, branches b
    where c1.cl_code = c2.cl_code and
	  ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and	  
	  ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname))
    order by Party_Code
  end 	

if @statusid='subbroker'
  begin
    select distinct "<option value="+rtrim(Party_Code)+">"+rtrim(Party_Code)+"</option>" , Party_Code
    from client2 c2,client1 c1,subbrokers sb
    where  c1.cl_code = c2.cl_code and
	  ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and
	  ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))
	  order by Party_Code
  end 

if @statusid='trader'
  begin
    select distinct "<option value="+rtrim(Party_Code)+">"+rtrim(Party_Code)+"</option>" , Party_Code
    from client2 c2, client1 c1
    where 
	c1.cl_code = c2.cl_code and ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))  
    order by Party_Code
  end	

if @statusid='client'
  begin
    select distinct "<option value="+rtrim(Party_Code)+">"+rtrim(Party_Code)+"</option>" , Party_Code
    from  client2 c2, client1 c1 
    where  c1.cl_code=c2.cl_code and
	 c2.party_code=@statusname 
	order by Party_Code
  end

if @statusid='family'
  begin
    select distinct "<option value="+rtrim(Party_Code)+">"+rtrim(Party_Code)+"</option>" , Party_Code
    from client2 c2, client1 c1
    where c1.cl_code = c2.cl_code and ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname))
    order by Party_Code
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_folistclient_beforeconfirmation
-- --------------------------------------------------
CREATE  PROCEDURE rpt_folistclient_beforeconfirmation
@statusid varchar(15),
@statusname varchar(25)
AS
if @statusid='broker'
  begin
    select distinct '<option value='+rtrim(party_code)+'>'+rtrim(party_code)+'</option>' , party_code
    from fotrade  where reserved1 not in ('1','3')
    order by party_code
  end

if @statusid='branch'
  begin
    select distinct '<option value='+rtrim(fo.Party_Code)+'>'+rtrim(fo.Party_Code)+'</option>' , fo.Party_Code
    from fotrade fo,client2 c2, client1 c1, branches b
    where fo.Party_Code = c2.party_code and 
	  ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and
	  c1.cl_code = c2.cl_code and
	  ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname)) and fo.reserved1 not in ('1','3')
    order by fo.Party_Code
  end 	

if @statusid='subbroker'
  begin
    select distinct '<option value='+rtrim(fo.Party_Code)+'>'+rtrim(fo.Party_Code)+'</option>' , fo.Party_Code
    from fotrade fo,client2 c2,client1 c1,subbrokers sb
    where fo.Party_Code = c2.party_code and 
	  c1.cl_code = c2.cl_code and
	  ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and
	  ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker)) and fo.reserved1 not in ('1','3')
	  order by fo.Party_Code
  end 

if @statusid='trader'
  begin
    select distinct '<option value='+rtrim(fo.Party_Code)+'>'+rtrim(fo.Party_Code)+'</option>' , fo.Party_Code
    from fotrade fo,client2 c2, client1 c1
    where fo.Party_Code = c2.party_code and c1.cl_code = c2.cl_code and ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))      and fo.reserved1 not in ('1','3')
    order by fo.Party_Code
  end	

if @statusid='client'
  begin
    select distinct '<option value='+rtrim(fo.Party_Code)+'>'+rtrim(fo.Party_Code)+'</option>' , fo.Party_Code
    from fotrade fo, client2 c2, client1 c1 
    where fo.Party_Code=c2.party_code and
	  c1.cl_code=c2.cl_code and
	 c2.party_code=@statusname and fo.reserved1 not in ('1','3')
	order by fo.Party_Code
  end

if @statusid='family'
  begin
    select distinct '<option value='+rtrim(fo.Party_Code)+'>'+rtrim(fo.Party_Code)+'</option>' , fo.Party_Code
    from fotrade fo,client2 c2, client1 c1
    where fo.Party_Code = c2.party_code and c1.cl_code = c2.cl_code and ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname)) and fo.reserved1 not in ('1','3')
    order by fo.Party_Code
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_folistclient_desc_beforeconfirmation
-- --------------------------------------------------
CREATE PROCEDURE rpt_folistclient_desc_beforeconfirmation    
@statusid varchar(15),    
@statusname varchar(25)    
AS    
  
set transaction isolation level read uncommitted  
   
if @statusid='broker'    
  begin    
    select distinct  party_code    
    from fotrade    
    order by party_code desc    
  end    
    
if @statusid='branch'    
  begin    
    select distinct  fo.Party_Code    
    from fotrade fo,client2 c2, client1 c1, branches b    
    where fo.Party_Code = c2.party_code and     
   ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and    
   c1.cl_code = c2.cl_code and    
   ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname))    
    order by fo.Party_Code desc    
  end      
    
if @statusid='subbroker'    
  begin    
    select distinct   fo.Party_Code    
    from fotrade fo,client2 c2,client1 c1,subbrokers sb    
    where fo.Party_Code = c2.party_code and     
   c1.cl_code = c2.cl_code and    
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and    
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))    
   order by fo.Party_Code desc    
  end      
    
if @statusid='trader'    
  begin    
    select distinct   fo.Party_Code    
    from fotrade fo,client2 c2, client1 c1    
    where fo.Party_Code = c2.party_code and c1.cl_code = c2.cl_code and ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))    
    order by fo.Party_Code desc    
  end     
    
if @statusid='client'    
  begin    
    select distinct  fo.Party_Code    
    from fotrade fo, client2 c2, client1 c1     
    where fo.Party_Code=c2.party_code and    
   c1.cl_code=c2.cl_code and    
  c2.party_code=@statusname     
 order by fo.Party_Code desc    
  end    
    
if @statusid='family'    
  begin    
    select distinct  fo.Party_Code    
    from fotrade fo,client2 c2, client1 c1    
    where fo.Party_Code = c2.party_code and c1.cl_code = c2.cl_code and ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname))    
    order by fo.Party_Code desc    
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fomargindetail
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 1/17/2004 11:42:48 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 09/10/2001 6:27:30 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 09/07/2001 10:36:24 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 9/7/01 5:07:38 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 9/7/2001 4:10:20 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 08/10/2001 4:53:53 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 8/7/01 4:29:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 7/25/01 10:06:08 PM ******/



/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 7/18/2001 6:18:12 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 7/3/01 11:19:06 AM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 5/11/01 12:08:57 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 5/7/2001 9:02:49 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 5/5/2001 2:43:37 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 5/5/2001 1:24:12 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 4/30/01 5:50:12 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 10/26/00 6:04:42 PM ******/






/****** Object:  Stored Procedure dbo.rpt_fomargindetail    Script Date: 12/27/00 8:59:10 PM ******/
/*Modified by Amolika on 13th April'2001 : Added like to partycode */
/*
Used In      : NSE FO
Report Name  : Margin Report
File Name    : margin.asp
Tables Used  : margin, fosettlement
Function     : Returns details for a particular date
Written By   : Amolika Patil 
Modified by AMolika on 9thfeb'2001 :  Changed the date format
*/
CREATE  PROCEDURE rpt_fomargindetail
@code varchar(10),
@sdate varchar(12)
AS
/*select m.party_code, m.inst_type, m.symbol, convert(varchar,m.expirydate,106) as expirydate 
,spreadqty, nonspreadqty, spreadmargin, nonspreadmargin,isnull(spreadmth,0) as spreadmth,totalqty,cl_rate
from fomargin m
where m.party_code = @code
and convert(varchar,m.margin_date,106) = @sdate
order by inst_type, symbol
*/

select m.party_code, m.inst_type, m.symbol, convert(varchar,m.expirydate,106) as expirydate 
,spreadqty, nonspreadqty, spreadmargin, nonspreadmargin,isnull(spreadmth,0) as spreadmth,totalqty,cl_rate
from fomargin m
where m.party_code LIKE LTRIM(@code)+'%'
and  LEFT(convert(varchar,m.margin_date,109),11)  = @sdate
order by inst_type, symbol

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foname
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 1/17/2004 11:42:49 PM ******/








/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 09/10/2001 6:27:30 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 09/07/2001 10:36:25 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 9/7/01 5:07:39 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 9/7/2001 4:10:21 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 7/25/01 10:06:09 PM ******/



/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 7/18/2001 6:18:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 7/3/01 11:19:07 AM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 5/11/01 12:08:58 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 5/7/2001 9:02:50 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 5/5/2001 2:43:38 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 5/5/2001 1:24:15 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 4/30/01 5:50:14 PM ******/

/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 10/26/00 6:04:43 PM ******/






/****** Object:  Stored Procedure dbo.rpt_foname    Script Date: 12/27/00 8:59:10 PM ******/
/*
Used In      : NSE FO
Report Name  : Bill Report
File Name    : BillReport
Tables Used  : client1, client2
Function     : Returns name of the given partycode
Written By   : Amolika Patil 
*/
CREATE  PROCEDURE rpt_foname
@code varchar(10)
AS
select c1.short_name 
from client1 c1, client2 c2 
where c1.cl_code = c2.cl_code
and c2.party_code = @code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foname1
-- --------------------------------------------------
CREATE PROCEDURE rpt_foname1  @code varchar(10)  AS  
if @code <> 'All'  
begin  
        select short_name   
        from client1 c1, client2 c2   
        where c2.party_code = @code and c1.cl_code = c2.cl_code  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fonetposition_span
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fonetposition_span    Script Date: 1/17/2004 11:42:49 PM ******/





CREATE   procedure rpt_fonetposition_span

@sdate varchar(12),
@partycode varchar(10) ,
@symbol varchar(10)



AS
/*
select party_code,inst_type,symbol,left(convert(varchar,expirydate,106),11) as expirydate,
sum(pqty) as pqty,
sum(sqty) as sqty, strike_price, option_type
from spannetposition
where expirydate >= @sdate
and party_code  like ltrim(@partycode) + '%'
and symbol like ltrim(@symbol) + '%'
and sauda_date < @sdate + ' 23:59'
group by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type
order by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type
*/

select party_code,inst_type,symbol,left(convert(varchar,expirydate,106),11) as expirydate,
sum(pqty) as pqty,
sum(sqty) as sqty, strike_price, option_type
from  spannetposition
where expirydate >= @sdate + ' 23:59'
and party_code  like ltrim(@partycode) + '%'
and symbol like ltrim(@symbol) + '%'
and sauda_date < @sdate + ' 23:59'
group by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type
order by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fonetposition_span3DaysNew
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fonetposition_span3DaysNew    Script Date: 1/17/2004 11:42:49 PM ******/





CREATE  Procedure rpt_fonetposition_span3DaysNew
  
@sdate varchar(12),  
@Party_Code Varchar(10),
@ExpMonth Int,
@Flag int
  
AS  
If @Flag = 1 
Begin

TRUNCATE TABLE FOSPANRECORD 
insert into FOSPANRECORD 
select party_code,inst_type,symbol,expirydate,
pqty = ( case when sell_buy = 1 then sum(tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(tradeqty) else 0 end ), strike_price, option_type,sauda_date as sauda_date
from fosettlement where reserved1 <> 1
and expirydate > @sdate + ' 23:59'  
and sauda_date < @sdate + ' 23:59'  
And Party_Code Like @Party_Code 
group by party_code,inst_type,symbol,expirydate,sell_buy, strike_price, option_type,sauda_date

select party_code,inst_type,symbol,left(convert(varchar,expirydate,106),11) as expirydate,  
sum(pqty) as pqty,  
sum(sqty) as sqty, strike_price, option_type  
from FOSPANRECORD
Where Month(expirydate) = @ExpMonth
group by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type  
Having Sum(PQty) - Sum(SQty) <> 0  
order by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type  
End
Else
Begin

select party_code,inst_type,symbol,left(convert(varchar,expirydate,106),11) as expirydate,  
sum(pqty) as pqty,  
sum(sqty) as sqty, strike_price, option_type  
from FOSPANRECORD 
Where Month(expirydate) > @ExpMonth
group by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type  
Having Sum(PQty) - Sum(SQty) <> 0 
order by party_code,symbol,inst_type,left(convert(varchar,expirydate,106),11), strike_price, option_type  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_FoRms_Report
-- --------------------------------------------------
CREATE    Proc  [dbo].[rpt_FoRms_Report] (@MarginDateFrom Varchar(11),@MarginDateTo Varchar(11),    
@IntMarType Varchar(20),@BranchCd Varchar(10), @SubBroker Varchar(10),@PartyFrom Varchar(10),@PartyTo Varchar(10),    
@StatusName Varchar(25),@StatusId varchar(10), @RiskShortage Varchar(10)    
)    
As    
    
create TABLE [#FoRms_TBL]    
 (    
 [Party_Code] [varchar] (15)   ,    
 [Short_Name] [varchar] (100)   ,    
 [Long_Name] [varchar] (100)   ,    
 [Branch_Cd] [varchar] (20)   ,    
 [Family] [varchar] (20)   ,    
 [Sub_Broker] [varchar] (20)   ,    
 [Trader] [varchar] (20)   ,    
 [Customerexec] [varchar] (100)   ,    
 [Margindate] [datetime]  ,    
 [Dailymtmamt] [money]  ,    
 [Finaldaymtmamt] [money]  ,    
 [Premiumamt] [money]  ,    
 [Exallocamt] [money]  ,    
 [Brokerage] [money]  ,    
 [Servicetax] [money]  ,    
 [Turntax] [money]  ,    
 [Sebitax] [money]  ,    
 [Insurancecharge] [money]  ,    
 [Stampduty] [money]  ,    
 [Othercharges] [money]  ,    
 [Expirybrokerage] [money]  ,    
 [Expiryservicetax] [money]  ,    
 [Cfbrokerage] [money]  ,    
 [Cfservicetax] [money]  ,    
 [Cfcharges] [money]  ,    
 [Clearingcharges] [money]  ,    
 [Billamount] [money]  ,    
 [Ledgeramount] [money]  ,    
 [Cash_Coll] [money]  ,    
 [Noncash_Coll] [money]  ,    
 [Effectivecoll] [money]  ,    
 [Haircutcash_Coll] [money]  ,    
 [Haircutnoncash_Coll] [money]  ,    
 [Totalfd] [money]  ,    
 [Totalbg] [money]  ,    
 [Totalsecurities] [money]  ,    
 [Initialmargin_Mg13] [money]  ,    
 [Mtommargin_Mg13] [money]  ,    
 [Spanmargin] [money]  ,    
 [Long_Futuresexposure] [money]  ,    
 [Short_Futuresexposure] [money]  ,    
 [Futuresexposure] [money]  ,    
 [Long_Optionsexposure] [money]  ,    
 [Short_Optionsexposure] [money]  ,    
 [Optionsexposure] [money]  ,    
 [Hedgeexposure] [money]  ,    
 [Optionsmtom] [money]  ,    
 [Futuresturnover] [money]  ,    
 [Optionsturnover] [money]  ,    
 [Exallocturnover] [money]  ,    
 [Bsecm_Exposure] [money]  ,    
 [Nsecm_Exposure] [money]  ,    
 [Dummy1] [money]  ,    
 [Dummy2] [varchar] (20)   ,    
 [Lst_Update_Dt] [datetime]  ,    
 [mmargindate] [varchar] (11)   ,    
 [finalimargin] [money]  ,    
 [finaltotal] [money]  ,    
 [TotMarginForReporting] [money]  ,    
 [MarginPer] [money]  ,    
 [finalspamargin] [money],      
)    
    
    
CREATE INDEX [indxFoRmsTbl] ON [dbo].[#FoRms_TBL] ([mmargindate], [Party_Code])    
    
    
set transaction isolation level read uncommitted    
    
Insert into #FoRms_TBL    
    
SELECT foriskmanagement_tbl.*,    
 left(convert(varchar,margindate,109),11) as mmargindate,    
 spanmargin , 0, initialmargin_MG13, 50, initialmargin_MG13    
From     
 foriskmanagement_tbl    
Where    
 MarginDate Between @MarginDateFrom and @MarginDateTo    
 And Party_Code Between @PartyFrom and @PartyTo    
 And Branch_Cd Like Case When @BranchCd <> 'ALL' Then @BranchCd Else '%' End    
 And Sub_Broker Like Case When @SubBroker <> 'ALL' Then @SubBroker Else '%' End    
 And @StatusName =     
          (case     
                when @StatusId = 'BRANCH' then Branch_Cd    
                when @StatusId = 'SUBBROKER' then Sub_Broker    
                when @StatusId = 'Trader' then Trader    
                when @StatusId = 'Family' then Family    
                when @StatusId = 'Client' then Party_Code    
          else     
                'BROKER'    
          End)    
 And    
     
 (    
  (@RiskShortage = 'Excess' and EffectiveColl + LedgerAmount - InitialMargin_MG13 > 1 )    
     
  OR    
     
  (@RiskShortage = 'Short' And EffectiveColl + LedgerAmount - InitialMargin_MG13 <= 1)    
     
  Or    
     
  (@RiskShortage = 'Both' And  1= 1)    
     
 )    
    
     
if @IntMarType <> 'mgimar'    
 Begin    
    
  set transaction isolation level read uncommitted    
    
  Update #FoRms_TBL    
   Set finalimargin = finaliMargin *(1+PmarginRate/100),    
    TotMarginForReporting = TotMarginForReporting *(1+PmarginRate/100),    
    finalspamargin = finalspamargin *(1+PmarginRate/100)    
  From     
   Client3 (nolock)    
  Where   
   Client3.Party_Code = #FoRms_TBL.Party_Code    
       
    
 End    
    
Update #FoRms_TBL Set finalTotal = finaliMargin - optionsMTOM    
    
set transaction isolation level read uncommitted    
    

Update #FoRms_TBL    
  Set TotMarginForReporting = -TotMarginForReporting  - isnull(mtom,0),    
   finalspamargin = -TotMarginForReporting  - isnull(mtom,0)    
From  FomarginNew (nolock)    
Where    
 left(FomarginNew.mdate,11) = left(#FoRms_TBL.mmargindate,11)     
 And #FoRms_TBL.Party_Code = FomarginNew.Party_Code    
     
    
    
set transaction isolation level read uncommitted    
    
Select     
 Sum(case when drcr = 'C' then vamt else -vamt end) Payment,     
 CltCode     
Into #Payment    
From     
 ACCOUNTNCE.DBO.ledger (nolock),  #FoRms_TBL (nolock)    
where     
 vdt Like left(#FoRms_TBL.mmargindate,11) + '%'    
 and CltCode = Party_Code    
 and Vtyp in (1,2,3,4,24)     
     
group by CltCode    
    
    
set transaction isolation level read uncommitted    
    
Select     
 Margin_Percent,    
 FM.Party_Code     
Into #MarginPercent    
From FoMarginPercent FM (nolock), #FoRms_TBL (nolock)    
Where     
 Stat <> 'D'     
 And Effective_DateFrom = (     
      Select     
       Max(Effective_DateFrom)     
      From FoMarginPercent     
       Where Party_Code = FM.Party_Code     
       And Effective_DateFrom <= left(#FoRms_TBL.mmargindate,11) +' 23:59:59' And Stat <> 'D'    
       )    
 And FM.Party_Code = #FoRms_TBL.Party_Code    
     
    
    
Update #FoRms_TBL    
 Set MarginPer = Margin_Percent    
From    
 #MarginPercent    
Where    
 #MarginPercent.Party_Code = #FoRms_TBL.Party_Code    
    
    
    
    
Select     
 f.long_futuresexposure Prv_long_futuresexposure,    
 f.short_futuresexposure Prv_short_futuresexposure,    
 f.long_optionsexposure Prv_long_optionsexposure ,    
 f.short_optionsexposure Prv_short_optionsexposure,    
 f.Party_Code Prv_Party_Code    
Into #PrvFoRms    
from     
 foriskmanagement_tbl f (nolock) , #FoRms_TBL (nolock)    
where     
 F.margindate in    
  (select top 1 margindate     
  from foriskmanagement_tbl     
  where margindate < #FoRms_TBL.mmargindate    
  and party_code = #FoRms_TBL.Party_Code order by 1 desc)     
 and F.party_code = #FoRms_TBL.Party_Code    
    
    
    
    
    
Select foGlobals.Exchange,#FoRms_TBL.*,    
 isnull(#Payment.Payment,0) Payment,     
 isnull(Prv_long_futuresexposure,0)  Prv_long_futuresexposure,    
 isnull(Prv_short_futuresexposure,0) Prv_short_futuresexposure,    
 isnull(Prv_long_optionsexposure,0)  Prv_long_optionsexposure,    
 isnull(Prv_short_optionsexposure,0) Prv_short_optionsexposure,    
 isnull(mtom,0) exposuremtom ,isnull(NonSpreadMargin,0)OptBuyPrem    
 from      
 #FoRms_TBL     
  Left Outer Join  #Payment On (#FoRms_TBL.Party_Code = Cltcode)    
  Left Outer Join  #PrvFoRms On (Prv_Party_Code = #FoRms_TBL.Party_Code)    
  Left Outer Join  FoMarginNew F (nolock)     
  On ( F.Party_Code = #FoRms_TBL.Party_Code    
  and Left(F.MDate,11) = Left(#FoRms_TBL.MMarginDate,11) ), foGlobals    
Where  @MarginDateFrom between year_start_dt and year_end_dt    
Order By #FoRms_TBL.Party_Code    
    
  
  
  
Truncate table  #FoRms_TBL    
Drop table #FoRms_TBL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_FoRms_Report_Combine
-- --------------------------------------------------

CREATE   Proc  [dbo].[rpt_FoRms_Report_Combine]             
(            
 @MarginDateFrom Varchar(11),@MarginDateTo Varchar(11),            
 @IntMarType Varchar(20),@BranchCd Varchar(10), @SubBroker Varchar(10),@PartyFrom Varchar(10),            
 @PartyTo Varchar(10),@StatusName Varchar(25),@StatusId varchar(10), @RiskShortage Varchar(10),            
 @strOrder varchar(10),@strReport varchar(10)         
)            
As            
            
            
CREATE TABLE [#FoRms_TBL_Combine]         
(        
 [Exchange] [varchar] (3)   ,        
 [Party_Code] [varchar] (15)   ,        
 [Short_Name] [varchar] (100)   ,        
 [Long_Name] [varchar] (100)   ,        
 [Branch_Cd] [varchar] (20)   ,        
 [Family] [varchar] (20)   ,        
 [Sub_Broker] [varchar] (20)   ,        
 [Trader] [varchar] (20)   ,        
 [Customerexec] [varchar] (100)   ,        
 [Margindate] [datetime]  ,        
 [Dailymtmamt] [money]  ,        
 [Finaldaymtmamt] [money]  ,        
 [Premiumamt] [money]  ,        
 [Exallocamt] [money]  ,        
 [Brokerage] [money]  ,        
 [Servicetax] [money]  ,        
 [Turntax] [money]  ,        
 [Sebitax] [money]  ,        
 [Insurancecharge] [money]  ,        
 [Stampduty] [money]  ,        
 [Othercharges] [money]  ,        
 [Expirybrokerage] [money]  ,        
 [Expiryservicetax] [money]  ,        
 [Cfbrokerage] [money]  ,        
 [Cfservicetax] [money]  ,        
 [Cfcharges] [money]  ,        
 [Clearingcharges] [money]  ,        
 [Billamount] [money]  ,        
 [Ledgeramount] [money]  ,        
 [Cash_Coll] [money]  ,        
 [Noncash_Coll] [money]  ,        
 [Effectivecoll] [money]  ,        
 [Haircutcash_Coll] [money]  ,        
 [Haircutnoncash_Coll] [money]  ,        
 [Totalfd] [money]  ,        
 [Totalbg] [money]  ,        
 [Totalsecurities] [money]  ,        
 [Initialmargin_Mg13] [money]  ,        
 [Mtommargin_Mg13] [money]  ,        
 [Spanmargin] [money]  ,        
 [Long_Futuresexposure] [money]  ,        
 [Short_Futuresexposure] [money]  ,        
 [Futuresexposure] [money]  ,        
 [Long_Optionsexposure] [money]  ,        
 [Short_Optionsexposure] [money]  ,        
 [Optionsexposure] [money]  ,        
 [Hedgeexposure] [money]  ,        
 [Optionsmtom] [money]  ,        
 [Futuresturnover] [money]  ,        
 [Optionsturnover] [money]  ,        
 [Exallocturnover] [money]  ,        
 [Bsecm_Exposure] [money]  ,        
 [Nsecm_Exposure] [money]  ,        
 [Dummy1] [money]  ,        
 [Dummy2] [varchar] (20)   ,        
 [Lst_Update_Dt] [datetime]  ,        
 [mmargindate] [varchar] (11)   ,        
 [finalimargin] [money]  ,        
 [finaltotal] [money]  ,        
 [TotMarginForReporting] [money]  ,        
 [MarginPer] [money]  ,    
 [SrNo] [int]  ,       
 [finalspamargin] [money]  ,        
 [Payment] [money]  ,        
 [Prv_long_futuresexposure] [money]  ,        
 [Prv_short_futuresexposure] [money]  ,        
 [Prv_long_optionsexposure] [money]  ,        
 [Prv_short_optionsexposure] [money]  ,        
 [exposuremtom] [money]  ,        
 [OptBuyPrem] [money]          
)         
        
CREATE  INDEX [idxParty] ON [dbo].[#FoRms_TBL_Combine] ([Party_Code])        
        
        
        
            
Insert into  #FoRms_TBL_Combine            
(            
 Exchange,Party_Code,Short_Name,Long_Name,Branch_Cd,Family,Sub_Broker,Trader,Customerexec,Margindate,            
 Dailymtmamt,Finaldaymtmamt,Premiumamt,Exallocamt,Brokerage,Servicetax,Turntax,Sebitax,            
 Insurancecharge,Stampduty,Othercharges,Expirybrokerage,Expiryservicetax,Cfbrokerage,            
 Cfservicetax,Cfcharges,Clearingcharges,Billamount,Ledgeramount,Cash_Coll,Noncash_Coll,            
 Effectivecoll,Haircutcash_Coll,Haircutnoncash_Coll,Totalfd,Totalbg,Totalsecurities,            
 Initialmargin_Mg13,Mtommargin_Mg13,Spanmargin,Long_Futuresexposure,Short_Futuresexposure, 
 Futuresexposure,Long_Optionsexposure,Short_Optionsexposure,Optionsexposure,Hedgeexposure,            
 Optionsmtom,Futuresturnover,Optionsturnover,Exallocturnover,Bsecm_Exposure,Nsecm_Exposure,            
 Dummy1,Dummy2,Lst_Update_Dt,mmargindate,finalimargin,finaltotal,    
 TotMarginForReporting,MarginPer,            
 finalspamargin,Payment,Prv_long_futuresexposure,Prv_short_futuresexposure,            
 Prv_long_optionsexposure,Prv_short_optionsexposure,exposuremtom,OptBuyPrem            
)            
    
Exec NCE.DBO.rpt_FoRms_Report @MarginDateFrom, @MarginDateTo,@IntMarType,@BranchCd,@SubBroker,@PartyFrom,@PartyTo,@StatusName,@StatusId,@RiskShortage            
              
Insert into  #FoRms_TBL_Combine            
(            
 Exchange,Party_Code,Short_Name,Long_Name,Branch_Cd,Family,Sub_Broker,Trader,Customerexec,Margindate,            
 Dailymtmamt,Finaldaymtmamt,Premiumamt,Exallocamt,Brokerage,Servicetax,Turntax,Sebitax,            
 Insurancecharge,Stampduty,Othercharges,Expirybrokerage,Expiryservicetax,Cfbrokerage,            
 Cfservicetax,Cfcharges,Clearingcharges,Billamount,Ledgeramount,Cash_Coll,Noncash_Coll,            
 Effectivecoll,Haircutcash_Coll,Haircutnoncash_Coll,Totalfd,Totalbg,Totalsecurities,            
 Initialmargin_Mg13,Mtommargin_Mg13,Spanmargin,Long_Futuresexposure,Short_Futuresexposure,            
 Futuresexposure,Long_Optionsexposure,Short_Optionsexposure,Optionsexposure,Hedgeexposure,            
 Optionsmtom,Futuresturnover,Optionsturnover,Exallocturnover,Bsecm_Exposure,Nsecm_Exposure,            
 Dummy1,Dummy2,Lst_Update_Dt,mmargindate,finalimargin,finaltotal,    
 TotMarginForReporting,MarginPer,            
 finalspamargin,Payment,Prv_long_futuresexposure,Prv_short_futuresexposure,            
 Prv_long_optionsexposure,Prv_short_optionsexposure,exposuremtom,OptBuyPrem            
)            
Exec MCDX.dbo.rpt_FoRms_Report @MarginDateFrom, @MarginDateTo,@IntMarType,@BranchCd,@SubBroker,@PartyFrom,@PartyTo,@StatusName,@StatusId,@RiskShortage            
     
       
If @strReport <> 'DETAIL'        
 Begin        
 Select Party_Code,Short_Name=Max(Short_Name),Long_Name=Max(Long_Name),Branch_Cd=Max(Branch_Cd),      
 Family=Max(Family),Sub_Broker=Max(Sub_Broker),Trader=Max(Trader),Customerexec=Max(Customerexec),Margindate,            
 Dailymtmamt=sum(Dailymtmamt),Finaldaymtmamt=sum(Finaldaymtmamt),Premiumamt=sum(Premiumamt),Exallocamt=sum(Exallocamt),Brokerage=sum(Brokerage),Servicetax=sum(Servicetax),Turntax=sum(Turntax),Sebitax=sum(Sebitax),            
 Insurancecharge=sum(Insurancecharge),Stampduty=sum(Stampduty),Othercharges=sum(Othercharges),Expirybrokerage=sum(Expirybrokerage),Expiryservicetax=sum(Expiryservicetax),Cfbrokerage=sum(Cfbrokerage),            
 Cfservicetax=sum(Cfservicetax),Cfcharges=sum(Cfcharges),Clearingcharges=sum(Clearingcharges),Billamount=sum(Billamount),Ledgeramount=sum(Ledgeramount),Cash_Coll=sum(Cash_Coll),Noncash_Coll=sum(Noncash_Coll),            
 Effectivecoll= sum(Effectivecoll),Haircutcash_Coll=sum(Haircutcash_Coll),Haircutnoncash_Coll=sum(Haircutnoncash_Coll),Totalfd=sum(Totalfd),Totalbg=sum(Totalbg),Totalsecurities=sum(Totalsecurities),            
 Initialmargin_Mg13=sum(Initialmargin_Mg13),Mtommargin_Mg13=sum(Mtommargin_Mg13),Spanmargin=sum(Spanmargin),Long_Futuresexposure=sum(Long_Futuresexposure),Short_Futuresexposure=sum(Short_Futuresexposure),            
 Futuresexposure=sum(Futuresexposure),Long_Optionsexposure=sum(Long_Optionsexposure),Short_Optionsexposure=sum(Short_Optionsexposure),Optionsexposure=sum(Optionsexposure),Hedgeexposure=sum(Hedgeexposure),            
 Optionsmtom=sum(Optionsmtom),Futuresturnover=sum(Futuresturnover),Optionsturnover=sum(Optionsturnover),Exallocturnover=sum(Exallocturnover),Bsecm_Exposure=sum(Bsecm_Exposure),Nsecm_Exposure=sum(Nsecm_Exposure),            
 Dummy1=Max(Dummy1),Dummy2=Max(Dummy2),mmargindate,finalimargin=sum(finalimargin),finaltotal=sum(finaltotal),TotMarginForReporting=SUM(abs(TotMarginForReporting))*-1,MarginPer=sum(MarginPer),            
 finalspamargin=sum(finalspamargin),Payment=sum(Payment),Prv_long_futuresexposure=sum(Prv_long_futuresexposure),Prv_short_futuresexposure=sum(Prv_short_futuresexposure),            
 Prv_long_optionsexposure=sum(Prv_long_optionsexposure),Prv_short_optionsexposure=sum(Prv_short_optionsexposure),exposuremtom=sum(exposuremtom),OptBuyPrem=sum(OptBuyPrem)          
 from #FoRms_TBL_Combine         
 Group By Party_Code,Margindate, mmargindate        
 Order By Party_Code        
 End        
Else        
Begin            
If @strOrder = 'PARTY'            
 Begin            
  Select * from #FoRms_TBL_Combine  Order By Party_Code, Exchange            
 End            
else            
 Begin            
  Select * from #FoRms_TBL_Combine  Order By Exchange,Party_Code            
 End            
End            
          
       
Truncate Table #FoRms_TBL_Combine        
Drop Table #FoRms_TBL_Combine

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_foserieswiseinfo1
-- --------------------------------------------------

CREATE PROCEDURE rpt_foserieswiseinfo1 
(
	@sdate varchar(20), 
	@instru_type varchar(4),
	@sym_frm varchar(12),
	@sym_to varchar(12)
)
AS  

 if @sym_to= '' begin set @sym_to = 'zzzzzzzz' end

 set transaction isolation level read uncommitted

select 
     
     Expirydate = convert(varchar,Expirydate,106),  
     Inst_Type, 
     Symbol,
     strike_price,
     option_type, 
     sec_name,   
     start_date = convert(varchar,startdate,106),  
     maturitydate = convert(varchar,Maturitydate,106),
     expirydate as expdate,  
     PriceUnit,
     Numerator,
     Denominator,
     RegularLot,
     Qty_Unit,
     Delivery_Lot,
     Delivery_Unit
  from 
       Foscrip2 (nolock)  
  where 
          Symbol BETWEEN @sym_frm AND @sym_to 
	        AND  1 = Case 
	  When @instru_type = 'BOTH' 
	Then
		1
	Else 
		Case When @instru_type = 'FUT' 
			Then 
				Case When Left(Inst_Type,3) = 'FUT' Then 1 else 2 End
			Else
				Case When Left(Inst_Type,3) = 'OPT' Then 1 else 2 End
			End
	End
         AND Left(Expirydate,11) = @sdate 
  Order By 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fosettno
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 1/17/2004 11:42:49 PM ******/






/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 11/27/2001 11:58:51 AM ******/




/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 08/10/01 4:38:31 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 7/25/01 10:06:10 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 7/18/2001 6:18:18 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 7/3/01 11:19:09 AM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 5/11/01 12:09:00 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 5/7/2001 9:02:51 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 5/5/2001 2:43:39 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 5/5/2001 1:24:17 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 4/30/01 5:50:16 PM ******/
/****** Object:  Stored Procedure dbo.rpt_fosettno    Script Date: 10/26/00 6:04:44 PM ******/
/*Modified by Amolika on 7th feb'2001: Added condition for partycode & sdate*/
CREATE  PROCEDURE [dbo].[rpt_fosettno]
@settno varchar(7),
@code varchar(10),
@sdate varchar(12)
AS
/*select distinct left(convert(varchar,l.vdt,109),11) as vdt,l3.narr 
from ledger3 l3 ,ledger l
where l.vtyp = l3.vtyp
and l.vno = l3.vno
and narr like '%' + ltrim(@settno)+'%'
*/
select distinct left(convert(varchar,l.vdt,109),11) as vdt,l3.narr 
from ACCOUNTNCE.DBO.ledger3 l3 ,ACCOUNTNCE.DBO.ledger l
where l.vtyp = l3.vtyp
and l.vno = l3.vno
and narr like '%' + ltrim(@settno)+'%'
and cltcode = @code
and left(convert(varchar,vdt,109),11) = @sdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSpan_clientmargin
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 1/17/2004 11:42:38 PM ******/








/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 7/25/01 10:06:10 PM ******/



/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 7/18/2001 6:18:18 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOSpan_clientmargin    Script Date: 7/3/01 11:19:09 AM ******/
CREATE  Procedure RPT_FOSpan_clientmargin (@Sdate Varchar(11), @partycode varchar(10)) as 
select 
pqty = ( case when s.Sell_Buy = 1 then sum(s.Tradeqty) else 0 end ),
sqty = ( case when s.Sell_Buy = 2 then sum(s.Tradeqty) else 0 end )  ,
netrate = isnull((  select FoTrade4432.Price from FoTrade4432
                                where FoTrade4432.Tradedate = ( select max(Tradedate) from FoTrade4432 
                    where FoTrade4432.Tradedate < @SDate + ' 23:59') 
        and FoTrade4432.Inst_Type = s.Inst_type
                                  and FoTrade4432.symbol=s.Symbol     and FoTrade4432.strike_price=s.Strike_price and FoTrade4432.option_type=s.Option_type 
                                  and convert(varchar,FoTrade4432.expirydate,103) = convert(varchar,s.Expirydate,103)
                                 
                ),0),
Price = isnull(( select FoTrade4432.Price from FoTrade4432
                         where left(convert(varchar,FoTrade4432.Tradedate,109),11)  like @SDate 
                         and FoTrade4432.Inst_Type = s.Inst_type and FoTrade4432.symbol=s.Symbol 
	           and FoTrade4432.strike_price=s.Strike_price and FoTrade4432.option_type=s.Option_type 
                         and convert(varchar,FoTrade4432.expirydate,103) = convert(varchar,s.Expirydate,103)
                     
           ),0),
s.Party_Code,s.Inst_type,s.Symbol,convert(varchar,s.Expirydate,106) as expirydate,
sdate = left(convert(varchar,sauda_date,109),11),s.Sell_buy ,Service_Tax=0,Brok=0,s.Expirydate as expdate,
s.Strike_price, s.Option_type
from FoSettlement s,FoTrade4432 c,foscrip2 
where c.Inst_Type = s.Inst_type and
      c.Symbol = s.Symbol 
 and c.strike_price=s.Strike_price and c.option_type=s.Option_type  and
      left(convert(varchar,c.Tradedate,109),11) = left(convert(varchar,sauda_date,109),11) and 
      left(convert(varchar,sauda_date,109),11) <= ( select max(sauda_date)
                                                   from fosettlement 
                                                   where sauda_date+1 <= @Sdate + ' 23:59'
                                                 )
     and convert(varchar,c.expirydate,103) = convert(varchar,s.Expirydate,103)
                         and foscrip2.inst_type=c.inst_type
               and foscrip2.symbol=c.symbol   
and s.Party_Code like ltrim(@partycode)+'%'
                         and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
 and foscrip2.strike_price=c.strike_price and foscrip2.option_type=c.option_type 
                    /*     and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate      this was modified on 2nd feb 2001 the below line was added */
                        and foscrip2.maturitydate > @Sdate + ' 23:59:00'
and left(foscrip2.inst_type,3) = 'FUT'
and left(c.inst_type,3) = 'FUT'
and left(s.Inst_type,3) = 'FUT'
group by left(convert(varchar,sauda_date,109),11),s.Party_Code,s.Inst_type,s.Symbol,s.Expirydate,s.Sell_buy,convert(varchar,s.Expirydate,103),convert(varchar,c.expirydate,103),
s.Strike_price, s.Option_type
union all
select 
pqty = ( case when s.Sell_Buy = 1 then sum(s.Tradeqty) else 0 end ),
sqty = ( case when s.Sell_Buy = 2 then sum(s.Tradeqty) else 0 end ),
isnull(s.price,0),
isnull(c.Price,0),
s.Party_Code,
s.Inst_type,
s.Symbol,
convert(varchar,s.Expirydate,106) as expirydate,
sdate=left(convert(varchar,sauda_date,109),11),
s.Sell_buy,
service_tax = sum(SERVICE_TAX),
Brok=Sum(Brokapplied*s.Tradeqty) ,s.Expirydate as expdate,
s.Strike_price, s.Option_type
from FoSettlement s,FoTrade4432 c,foscrip2
where c.Inst_Type = s.Inst_type and
  c.Symbol = s.Symbol 
 and c.strike_price=s.Strike_price and c.option_type=s.Option_type and
      left(convert(varchar,c.Tradedate,109),11) = left(convert(varchar,sauda_date,109),11) and
          left(convert(varchar,sauda_date,109),11) = ( select left(convert(varchar,max(sauda_date),109),11) 
                                                      from fosettlement 
            where left(convert(varchar,sauda_date,109),11) like @SDate
                                                     ) 
and convert(varchar,c.expirydate,103) = convert(varchar,s.Expirydate,103)
           and foscrip2.inst_type=c.inst_type
           and foscrip2.symbol=c.symbol   
           and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
and s.Party_Code like ltrim(@partycode)+'%'
 and foscrip2.strike_price=c.strike_price and foscrip2.option_type=c.option_type 
       /*    and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate  this was modified on 2nd feb 2001 the below line was added * */
          and foscrip2.maturitydate > @Sdate +' 23:59:00'
/*and left(foscrip2.inst_type,3) = 'FUT'
and left(c.inst_type,3) = 'FUT'
and left(s.Inst_type,3) = 'FUT'
*/
   group by left(convert(varchar,sauda_date,109),11),s.price,c.Price,s.Party_Code,s.Inst_type,
s.Symbol,s.Expirydate,left(convert(varchar,sauda_date,109),11),s.Sell_Buy ,convert(varchar,c.expirydate,103), 
convert(varchar,s.Expirydate,103),
s.Strike_price, s.Option_type
order by s.Party_code, s.expdate,s.Inst_type,s.Symbol

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospancllistmargin
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 1/17/2004 11:42:49 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospancllistmargin    Script Date: 7/25/01 10:06:10 PM ******/


/****** Object:  Stored Procedure dbo.rpt_focllistmargin    Script Date: 8/10/2001 6:40:48 PM ******/

/****** Object:  Stored Procedure dbo.rpt_focllistmargin    Script Date: 7/3/01 11:19:05 AM ******/

/****** Object:  Stored Procedure dbo.rpt_focllistmargin    Script Date: 5/11/01 12:08:55 PM ******/
CREATE  PROCEDURE rpt_fospancllistmargin

@cltype varchar(3)

AS

select distinct "<option value="+rtrim(s.party_code)+">"+rtrim(s.party_code)+"</option>" 
from fospanmarginnew s
where cl_type like ltrim(@cltype)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospandetail_new
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 1/17/2004 11:42:49 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 7/25/01 10:06:10 PM ******/



/****** Object:  Stored Procedure dbo.rpt_fospandetail_new    Script Date: 7/18/2001 6:18:18 PM ******/

CREATE  PROCEDURE rpt_fospandetail_new

@code varchar(10),
@sdate varchar(12)

AS

select  newspanmargin = isnull(newspanmargin,0)
from spandetailview m
where m.party_code LIKE LTRIM(@code)+'%'
and convert(varchar,m.mdate,106)  = @sdate
group by m.party_code, newspanmargin

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_FoSpanMargin
-- --------------------------------------------------

CREATE  Proc Rpt_FoSpanMargin
	(
		@Sauda_Date Varchar(11),
		@StatusId varchar(15),
		@StatusName varchar(25),
		@PartyFrom Varchar(10),
		@PartyTo Varchar(10)
	)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

If @PartyTo ='' Begin Set @PartyTo = 'zzzzzzzzzz' End

Select
	Party_Code = IsNull(S_Party_Code,E_Party_Code),
	PartyName = IsNull(s_PartyName,E_PartyName),
	Symbol = IsNull(S_Symbol,E_Symbol),
	S_SpanMargin =IsNull(S_SpanMargin,0),
	S_Premium = IsNull(S_Premium,0),
	S_AddMarginPerc = isnull(S_AddMarginPerc,0),
	S_TotalMargin = IsNull(S_TotalMargin,0),
	E_MarginPerc = IsNull(E_MarginPerc,0),
	E_MarginAmt = IsNull(E_MarginAmt,0)
From 

(
	Select
		S_Party_Code = FoMargin_Span.Party_Code,
		S_PartyName = Long_Name,
		S_Symbol = FoMargin_Span.Symbol,
		S_SpanMargin = SpanMargin,
		S_Premium = Premium,
		S_AddMarginPerc = PMarginRate,
		S_TotalMargin = TotalMargin
	From
		FoMargin_Span,Client1 , Client2
	Where
		Client1.Cl_Code = Client2.Cl_Code
		And Client2.Party_Code = FoMargin_Span.Party_Code	
		And FoMargin_Span.Cl_Type ='CL'
		And MDate Like @Sauda_Date +'%'
		And Client2.Party_Code Between @PartyFrom and @PartyTo
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN Client1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN Client1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN Client1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN Client1.FAMILY
			WHEN @STATUSID = 'AREA' THEN Client1.AREA
			WHEN @STATUSID = 'REGION' THEN Client1.REGION
			WHEN @STATUSID = 'CLIENT' THEN Client2.PARTY_CODE
			ELSE 
		'BROKER'
		END)
) FoMrg

Full Outer Join 
(
	Select
		E_Party_Code = FoMargin_Exp_Details.Party_Code,
		E_PartyName = Long_Name,
		E_Symbol = Symbol,
		E_MarginPerc = Margin_Perc,
		E_MarginAmt = MarginAmt
	
	From
		FoMargin_Exp_Details,Client1 , Client2
	Where
		Client1.Cl_Code = Client2.Cl_Code
		And Client2.Party_Code = FoMargin_Exp_Details.Party_Code
		And Sauda_Date Like @Sauda_Date +'%'
		And Client2.Party_Code Between @PartyFrom and @PartyTo
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN Client1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN Client1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN Client1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN Client1.FAMILY
			WHEN @STATUSID = 'AREA' THEN Client1.AREA
			WHEN @STATUSID = 'REGION' THEN Client1.REGION
			WHEN @STATUSID = 'CLIENT' THEN Client2.PARTY_CODE
			ELSE 
		'BROKER'
		END)
) ExpMrg
ON (E_Party_Code = S_Party_Code And E_Symbol = S_Symbol)
Order By 1,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospanmargindetail_new
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospanmargindetail_new    Script Date: 1/17/2004 11:42:49 PM ******/






/****** Object:  Stored Procedure dbo.rpt_fospanmargindetail_new    Script Date: 8/31/01 2:55:34 PM ******/
CREATE  PROCEDURE rpt_fospanmargindetail_new

@statusid varchar(15),
@statusname varchar(25),
@code varchar(10),
@sdate varchar(12),
@tdate varchar(12)
AS

if @statusid = 'broker'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m
	where m.party_code LIKE LTRIM(@code)
	and m.mdate  between @sdate and @tdate
	group by m.party_code, spanmargin
end 


if @statusid = 'branch'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m,  client1 c1, client2 c2, branches b
	where m.party_code = c2.party_code 
	and c2.cl_code = c1.Cl_code  
	and b.branch_cd=@statusname
	and b.short_name=c1.trader
	and m.party_code LIKE LTRIM(@code)
	and m.mdate   between @sdate and @tdate
	group by m.party_code, spanmargin
end 

if @statusid = 'subbroker'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m,  client1 c1, client2 c2, subbrokers  sb
	where m.party_code = c2.party_code 
	and c2.cl_code = c1.Cl_code  
	and sb.sub_broker=c1.sub_broker
	and sb.sub_broker=@statusname
	and m.party_code LIKE LTRIM(@code)
	and m.mdate  between @sdate and @tdate
	group by m.party_code, spanmargin
end 

if @statusid = 'trader'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m,  client1 c1, client2 c2 
	where m.party_code = c2.party_code 
	and c2.cl_code = c1.Cl_code  
	and c1.trader=@statusname  
	and m.party_code LIKE LTRIM(@code)
	and m.mdate  between @sdate and @tdate
	group by m.party_code, spanmargin
end 

if @statusid = 'client'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m,  client1 c1, client2 c2 
	where m.party_code = c2.party_code 
	and c2.cl_code = c1.Cl_code  
	and c2.party_code= @statusname
	and m.party_code LIKE LTRIM(@code)
	and m.mdate  between @sdate and @tdate
	group by m.party_code, spanmargin
end 

if @statusid = 'family'
begin
	select sum(m.finaltotalmargin) as finaltotalmargin,sum(m.totalmargin) as totalmargin, spanmargin = isnull(spanmargin,0)
	from spanmargindetailview m,  client1 c1, client2 c2 
	where m.party_code = c2.party_code 
	and c2.cl_code = c1.Cl_code  
	and c1.family=@statusname
	and m.party_code LIKE LTRIM(@code)
	and m.mdate  between @sdate and @tdate
	group by m.party_code, spanmargin
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospanmarginnew
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospanmarginnew    Script Date: 1/17/2004 11:42:49 PM ******/






CREATE  PROCEDURE rpt_fospanmarginnew

@code varchar(10),
@sdate varchar(12)

AS

select  newspanmargin = isnull(newspanmargin,0)
from spandetailview m
where m.party_code LIKE LTRIM(@code)+'%'
and convert(varchar,m.mdate,106)  = @sdate
group by m.party_code, newspanmargin

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospanmembermarginnew
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 1/17/2004 11:42:49 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 7/25/01 10:06:10 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 8/10/2001 6:40:51 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 7/3/01 11:19:06 AM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanmembermarginnew    Script Date: 5/11/01 12:08:57 PM ******/
CREATE  PROCEDURE rpt_fospanmembermarginnew

@sdate varchar(12)

AS

select party_code, totalmargin, cl_type, spanmargin
from fospanmarginnew
where left(convert(varchar,MDATE,109),11) = @sdate
and cl_type = 'CL'
order by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_fospanoptmembermargin
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 1/17/2004 11:42:49 PM ******/








/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 09/07/2001 10:36:26 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 08/10/2001 4:53:54 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 8/7/01 4:29:17 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fospanoptmembermargin    Script Date: 7/25/01 10:06:10 PM ******/


/****** Object:  Stored Procedure dbo.rpt_fooptmembermargin    Script Date: 8/10/2001 6:40:53 PM ******/

/****** Object:  Stored Procedure dbo.rpt_fooptmembermargin    Script Date: 7/3/01 11:19:08 AM ******/

CREATE  PROCEDURE rpt_fospanoptmembermargin

@sdate varchar(10)

AS

select 
pqty = isnull(sum(s.pqty),0),
sqty = isnull(sum(s.sqty),0),
s.cl_rate,
s.Party_Code,s.Inst_Type,s.Symbol, left(convert(varchar,S.EXPIRYDATE,109),11) as expirydate ,s.strike_price,s.option_type,
service_tax=(case  when s.billflag > 3 then 
                            Sum( s.NSerTax  )
                           else
                               0 
               end),
Brok= (case  when s.billflag > 3 then 
                           Sum(abs(s.NBrokApp))
                           else
                               0 
               end)
from OptionExAllocView s
where s.expirydate like  @sdate + '%'
and s.option_type = 'CE'
and s.strike_price< s.cl_rate
/*and s.party_code = @partycode*/
group by party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,s.billflag,s.cl_rate

union all

select 
pqty = isnull(sum(s.pqty),0),
sqty = isnull(sum(s.sqty),0),
s.cl_rate,
s.Party_Code,s.Inst_Type,s.Symbol, left(convert(varchar,S.EXPIRYDATE,109),11) as expirydate,s.strike_price,s.option_type,
service_tax=(case  when s.billflag > 3 then 
                            Sum( s.NSerTax  )
                           else
                               0 
               end),
Brok= (case  when s.billflag > 3 then 
                           Sum(abs(s.NBrokApp))
                           else
                               0 
               end)
from OptionExAllocView s
where s.expirydate like @sdate + '%'
and s.option_type = 'PE'
and s.strike_price > s.cl_rate
/*and s.party_code = @partycode*/
group by party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,s.strike_price,s.option_type,s.billflag,s.cl_rate
order by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOTAXES_DETAILS
-- --------------------------------------------------



CREATE Proc RPT_FOTAXES_DETAILS

AS 

SELECT 
	FromDate = Convert(varchar,From_Date,112),
	From_Date = left(Convert(Varchar,From_Date,109),11),
	To_Date = left(Convert(Varchar,To_Date,109),11),
	Trans_Cat,
	Inst_Type,
	Insurance_Chrg = CONVERT(VARCHAR,Insurance_Chrg) + ' %',
	Turnover_Tax = CONVERT(VARCHAR,Turnover_Tax) +' %',
	Other_Chrg = CONVERT(VARCHAR,Other_Chrg) +' %',
	Sebiturn_Tax = CONVERT(VARCHAR,Sebiturn_Tax) +' %',
	Broker_Note = CONVERT(VARCHAR,Broker_Note) +' '+ BASIS +' ON '+ CONVERT(VARCHAR,UNIT),
	Service_Tax = convert(varchar,Service_Tax) +' %',
	Cess_Tax = convert(varchar,Cess_Tax) + ' %',
	EDUCESS_TAX = convert(varchar,EDUCESS_TAX) + ' %',
	CurTaxFlag = Case When Getdate() Between From_Date and To_Date then 1 else 0 end
From 
        FoTaxes (nolock) , FoGlobals
Where
	From_Date Between Year_Start_Dt and Year_end_Dt

Order By 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOtest1FoTotalMtom_clientmargin
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 1/17/2004 11:42:38 PM ******/









/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 09/10/2001 6:27:31 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 09/07/2001 10:36:27 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 9/7/01 5:07:41 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 9/7/2001 4:10:23 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 08/10/2001 4:53:55 PM ******/


/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 8/7/01 4:29:18 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 7/25/01 10:06:10 PM ******/



/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 7/18/2001 6:18:19 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom_clientmargin    Script Date: 7/3/01 11:19:09 AM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 5/20/01 2:52:25 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 5/11/01 12:09:00 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 5/7/2001 9:02:51 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 5/5/2001 2:43:39 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 5/5/2001 1:24:17 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 4/30/01 5:50:17 PM ******/

/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 10/26/00 6:04:44 PM ******/






/****** Object:  Stored Procedure dbo.RPT_FOtest1FoTotalMtom    Script Date: 12/27/00 8:59:11 PM ******/
/*
Modified by Amolika on 3rd Feb'2001 
/*Modified by Amolika on 7th feb'2001 : Added Partycode as input*/
*/
/*ALTER Procedure rpt_fotest1FoTotalMtom (@Sdate Varchar(11)) as 
select 
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty) else 0 end )  ,
netrate = isnull((  select foclosing_billreport.cl_rate from foclosing_billreport
                                where foclosing_billreport.trade_date = ( select max(trade_date) from foclosing_billreport 
                    where foclosing_billreport.trade_date < @SDate + ' 23:59') 
        and foclosing_billreport.Inst_Type = s.inst_type
                                  and foclosing_billreport.symbol=s.symbol   
                                  and convert(varchar,foclosing_billreport.expirydate,103) = convert(varchar,s.expirydate,103)
                                 
                ),0),
cl_rate = isnull(( select foclosing_billreport.cl_rate from foclosing_billreport
                         where left(convert(varchar,foclosing_billreport.trade_date,109),11)  like @SDate 
                         and foclosing_billreport.Inst_Type = s.inst_type and foclosing_billreport.symbol=s.symbol 
                         and convert(varchar,foclosing_billreport.expirydate,103) = convert(varchar,s.expirydate,103)
                     
           ),0),
Party_Code,s.Inst_Type,s.Symbol,convert(varchar,S.EXPIRYDATE,106) as expirydate,
sdate = left(convert(varchar,sauda_date,109),11),sell_buy ,Service_Tax=0,Brok=0, s.expirydate as expdate
from FoSettlement s,foclosing_billreport c,foscrip2 
where c.Inst_Type = s.inst_type and
      c.Symbol = s.symbol and
      left(convert(varchar,c.trade_date,109),11) = left(convert(varchar,sauda_date,109),11) and 
      left(convert(varchar,sauda_date,109),11) <= ( select max(sauda_date)
                                                   from fosettlement 
                                                   where sauda_date+1<= @Sdate+ ' 23:59'
                                                 )
     and convert(varchar,c.expirydate,103) = convert(varchar,s.expirydate,103)
                         and foscrip2.inst_type=c.inst_type
               and foscrip2.symbol=c.symbol   
                         and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
                         and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate       
group by left(convert(varchar,sauda_date,109),11),party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,sell_Buy,convert(varchar,s.expirydate,103),convert(varchar,c.expirydate,103)
union all
select 
pqty = ( case when sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(s.tradeqty) else 0 end ),
isnull(s.price,0),
isnull(c.cl_rate,0),
Party_Code,
s.Inst_Type,
s.Symbol,
convert(varchar,S.EXPIRYDATE,106) as expirydate,
sdate=left(convert(varchar,sauda_date,109),11),
sell_buy,
service_tax = sum(SERVICE_TAX),
Brok=Sum(Brokapplied*tradeqty) , s.expirydate as expdate
from FoSettlement s,foclosing_billreport c,foscrip2
where c.Inst_Type = s.inst_type and
  c.Symbol = s.symbol and
      left(convert(varchar,c.trade_date,109),11) = left(convert(varchar,sauda_date,109),11) and
          left(convert(varchar,sauda_date,109),11) = ( select left(convert(varchar,max(sauda_date),109),11) 
                                                      from fosettlement 
            where left(convert(varchar,sauda_date,109),11) like @SDate
                                                     ) 
and convert(varchar,c.expirydate,103) = convert(varchar,s.expirydate,103)
           and foscrip2.inst_type=c.inst_type
           and foscrip2.symbol=c.symbol   
           and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
           and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate 
    
group by left(convert(varchar,sauda_date,109),11),s.price,c.cl_rate,party_code,s.Inst_Type,
s.Symbol,S.EXPIRYDATE,left(convert(varchar,sauda_date,109),11),sell_Buy ,convert(varchar,c.expirydate,103), convert(varchar,s.expirydate,103)
order by s.expdate,party_code,s.inst_type,s.symbol
*/
CREATE  Procedure RPT_FOtest1FoTotalMtom_clientmargin (@Sdate Varchar(11), @partycode varchar(10)) as 
select 
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty) else 0 end )  ,
netrate = isnull((  select foclosing_billreport.cl_rate from foclosing_billreport
                                where foclosing_billreport.trade_date = ( select max(trade_date) from foclosing_billreport 
                    where foclosing_billreport.trade_date < @SDate + ' 23:59') 
        and foclosing_billreport.Inst_Type = s.inst_type
                                  and foclosing_billreport.symbol=s.symbol     and foclosing_billreport.strike_price=s.strike_price and foclosing_billreport.option_type=s.option_type 
                                  and convert(varchar,foclosing_billreport.expirydate,103) = convert(varchar,s.expirydate,103)
                                 
                ),0),
cl_rate = isnull(( select foclosing_billreport.cl_rate from foclosing_billreport
                         where left(convert(varchar,foclosing_billreport.trade_date,109),11)  like @SDate 
                         and foclosing_billreport.Inst_Type = s.inst_type and foclosing_billreport.symbol=s.symbol 
	           and foclosing_billreport.strike_price=s.strike_price and foclosing_billreport.option_type=s.option_type 
                         and convert(varchar,foclosing_billreport.expirydate,103) = convert(varchar,s.expirydate,103)
                     
           ),0),
Party_Code,s.Inst_Type,s.Symbol,convert(varchar,S.EXPIRYDATE,106) as expirydate,
sdate = left(convert(varchar,sauda_date,109),11),sell_buy ,Service_Tax=0,Brok=0,s.expirydate as expdate,
s.Strike_price, s.Option_type
from FoSettlement s,foclosing_billreport c,foscrip2 
where c.Inst_Type = s.inst_type and
      c.Symbol = s.symbol 
 and c.strike_price=s.strike_price and c.option_type=s.option_type  and
      left(convert(varchar,c.trade_date,109),11) = left(convert(varchar,sauda_date,109),11) and 
      left(convert(varchar,sauda_date,109),11) <= ( select max(sauda_date)
                                                   from fosettlement 
                                                   where sauda_date+1 <= @Sdate + ' 23:59'
                                                 )
     and convert(varchar,c.expirydate,103) = convert(varchar,s.expirydate,103)
                         and foscrip2.inst_type=c.inst_type
               and foscrip2.symbol=c.symbol   
and s.party_code like ltrim(@partycode)+'%'
                         and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
 and foscrip2.strike_price=c.strike_price and foscrip2.option_type=c.option_type 
                    /*     and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate      this was modified on 2nd feb 2001 the below line was added */
                        and foscrip2.maturitydate > @Sdate + ' 23:59:00'
and left(foscrip2.inst_type,3) = 'FUT'
and left(c.inst_type,3) = 'FUT'
and left(s.inst_type,3) = 'FUT'
group by left(convert(varchar,sauda_date,109),11),party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,sell_Buy,convert(varchar,s.expirydate,103),convert(varchar,c.expirydate,103),
s.Strike_price, s.Option_type
union all
select 
pqty = ( case when sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(s.tradeqty) else 0 end ),
isnull(s.price,0),
isnull(c.cl_rate,0),
Party_Code,
s.Inst_Type,
s.Symbol,
convert(varchar,S.EXPIRYDATE,106) as expirydate,
sdate=left(convert(varchar,sauda_date,109),11),
sell_buy,
service_tax = sum(SERVICE_TAX),
Brok=Sum(Brokapplied*tradeqty) ,s.expirydate as expdate,
s.Strike_price, s.Option_type
from FoSettlement s,foclosing_billreport c,foscrip2
where c.Inst_Type = s.inst_type and
  c.Symbol = s.symbol 
 and c.strike_price=s.strike_price and c.option_type=s.option_type and
      left(convert(varchar,c.trade_date,109),11) = left(convert(varchar,sauda_date,109),11) and
          left(convert(varchar,sauda_date,109),11) = ( select left(convert(varchar,max(sauda_date),109),11) 
                                                      from fosettlement 
            where left(convert(varchar,sauda_date,109),11) like @SDate
                                                     ) 
and convert(varchar,c.expirydate,103) = convert(varchar,s.expirydate,103)
           and foscrip2.inst_type=c.inst_type
           and foscrip2.symbol=c.symbol   
           and convert(varchar,c.expirydate,103) = convert(varchar,foscrip2.expirydate,103)
and s.party_code like ltrim(@partycode)+'%'
 and foscrip2.strike_price=c.strike_price and foscrip2.option_type=c.option_type 
       /*    and left(convert(varchar,foscrip2.maturitydate,109),11) <> @sdate  this was modified on 2nd feb 2001 the below line was added * */
          and foscrip2.maturitydate > @Sdate +' 23:59:00'
/*and left(foscrip2.inst_type,3) = 'FUT'
and left(c.inst_type,3) = 'FUT'
and left(s.inst_type,3) = 'FUT'
*/
   group by left(convert(varchar,sauda_date,109),11),s.price,c.cl_rate,party_code,s.Inst_Type,
s.Symbol,S.EXPIRYDATE,left(convert(varchar,sauda_date,109),11),sell_Buy ,convert(varchar,c.expirydate,103), 
convert(varchar,s.expirydate,103),
s.Strike_price, s.Option_type
order by party_code, s.expdate,s.inst_type,s.symbol

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_FTpartydetails
-- --------------------------------------------------




/****** Object:  Stored Procedure dbo.rpt_FTpartydetails    Script Date: 10/17/02 1:53:08 PM ******/
CREATE    procedure rpt_FTpartydetails 
  
@partycode as varchar(20)

    
as 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

select cl2.cl_code,cl2.party_code,cl2.dummy1,  
turnover_tax =  (case when cl2.Turnover_tax=0 then 'N'  
   when cl2.Turnover_tax=1 then 'Y'  
  end),  
sebi_turn_tax =  (case when cl2.sebi_turn_tax=0 then 'N'  
   when cl2.sebi_turn_tax=1 then 'Y'  
  end),  
Service_chrg = (case when cl2.service_chrg=0 then 'Exclusive'  
   when cl2.service_chrg=1 then 'Incl in Brok'  
   when cl2.service_chrg=2 then 'Inclusive'  
  end),  
Insurance_Chrg = (case when cl2.Insurance_Chrg=0 then 'N'  
   when cl2.Insurance_Chrg =1 then 'Y'  
  end),  
Other_chrg =(case when cl2.Other_chrg=0 then 'N'  
   when cl2.Other_chrg=1 then 'Y'  
  end),  
cl2.table_no,cl2.sub_tableno,cl2.demat_tableno,cl2.p_to_p
,cl2.Std_rate,cl2.demat_tableno,cl2.ALBMDelchrg,cl2.ALBMDelivery,cl2.AlbmCF_tableno,cl2.MF_tableno,cl2.SB_tableno, 
cl2.brok1_tableno,cl2.brok2_tableno,
brok3_table_no= (case when cl2.brok3_tableno=0 then 'Treat as Brokerage'
when cl2.brok3_tableno=1 then 'Treat as Charges'	else 'Not Selected' end),
dummy1= (case when cl2.dummy1=0 then 'Premium'	when cl2.dummy1=1 then 'Strike'
 when cl2.dummy1=2 then 'Strike + Premium' 
else		 'Not Selected'	end), cl2.Dummy2 ,

brokernote= (case when cl2.brokernote=0 then 'N'  
   when cl2.brokernote=1 then 'Y'  
  end),  
brok_scheme = (case when cl2.brok_scheme=0 then 'Default'  
   when cl2.brok_scheme=1 then 'Max Logic (F/S) - Buy Side'  
  /* when cl2.brok_scheme=2 then 'Max Rate'  */
   when cl2.brok_scheme=3 then 'Max Logic (F/S) - Sell Side'  
   when cl2.brok_scheme=4 then 'Flat Brokerage Default'  
   when cl2.brok_scheme=5 then 'Flat Brokerage (Max Logic) - Buy Side'  
   when cl2.brok_scheme=6 then 'Flat Brokerage (Max Logic) - Sell Side'  
  end),  
brok3_table_no= (case when cl2.brok3_tableno=0 then 'Treat as Brokerage'  
   when cl2.brok3_tableno=1 then 'Treat as Charges'  
  else  
   'Not Selected'  
  end),  
dummy1= (case when cl2.dummy1=0 then 'Premium'  
   when cl2.dummy1=1 then 'Strike'  
   when cl2.dummy1=2 then 'Strike + Premium'  
  else  
   'Not Selected'  
  end),  
cl2.Dummy2,  
cl1.long_name,cl1.l_address1,cl1.l_address2, cl1.l_address3, 
cl1.L_city,cl1.L_State,cl1.L_Nation,cl1.L_Zip,cl1.Fax, Res_Phone1, Res_Phone2, Off_Phone1, Off_Phone2, cl1.Email,  
cl1.Branch_cd,cl1.Cl_type,cl1.Cl_Status,cl1.Family,cl1.Sub_Broker,cl1.Mobile_Pager,cl1.pan_gir_no,cl1.trader,  
s1.name,b1.branch  ,
conttype= (case when cl2.InsCont='S' then 'Scripwise'  
   when cl2.InsCont='O' then 'Orderwise'  
   when cl2.InsCont='N' then 'Normal'  
  else  
   'Not available'  
  end),
participant = (case when cl1.Cl_type='INS' then cl2.BankId
 		else  '' 
                            end) , 

custodian = (case when cl1.Cl_type='INS' then CL2.CLTDPNO
 		else  '' 
                            end) , 

Printf = (case when cl2.Printf=0 then 'Print'  
 		else  
                'Dont Print'  
              end) ,

contprt = (case when cl2.Printf =0 then 'Detail Bill And Contract'  
   when cl2.Printf =1 then 'Dont Print Bill And Contract'  
   when cl2.Printf =2 then 'Summarised Contract and Detail Bill'  
   when cl2.Printf =3 then 'Summarised Bill and Detail Contract'  
   when cl2.Printf =4 then 'Both Summarised'  
  end) ,
convert(varchar(11),c5.ActiveFrom) as ActiveFrom ,  
InactiveFrom = (case when convert(varchar(11),c5.InactiveFrom) ='Jan  1 1900' then 'N.A.'  
 		else  
               convert(varchar(11),c5.InactiveFrom)
              end),
/*convert(varchar(11),c5.InactiveFrom)   as InactiveFrom,*/
C5.Introducer,C5.Approver ,

isnull(c5.Passportdtl,'') as Passportdtl, isnull(c5.PassportDateOfIssue,'') as PassportDateOfIssue,  isnull(c5.PassportPlaceOfIssue,'') as PassportPlaceOfIssue,  isnull(c5.PASSPORTEXPDATE,'') as PASSPORTEXPDATE,
isnull(c5.Drivelicendtl,'') as Drivelicendtl, isnull(c5.LicenceNoDateOfIssue,'') as LicenceNoDateOfIssue, isnull(c5.LicenceNoPlaceOfIssue,'') as LicenceNoPlaceOfIssue, isnull(c5.DRIVEEXPDATE,'') as DRIVEEXPDATE,
isnull(c5.Rationcarddtl,'') as Rationcarddtl, isnull(c5.RationCardDateOfIssue,'') as RationCardDateOfIssue, isnull(c5.RationCardPlaceOfIssue,'') as RationCardPlaceOfIssue,
isnull(c5.VotersIDdtl,'') as VotersIDdtl, isnull(c5.VoterIdDateOfIssue,'') as VoterIdDateOfIssue, isnull(c5.VoterIdPlaceOfIssue,'') as VoterIdPlaceOfIssue

from client2 cl2, client1 cl1 Left Outer Join Client5 C5 On ( C5.Cl_Code = cl1.Cl_Code ) ,
subbrokers s1,branch b1
where cl1.cl_code = cl2.cl_code  
and s1.sub_broker = cl1.sub_broker  
and cl2.party_code =@partycode
and b1.branch_code = cl1.branch_cd

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_GST_BREAKUP
-- --------------------------------------------------

CREATE PROC RPT_GST_BREAKUP
(
	@FROM_DATE DATETIME,
	@TO_DATE DATETIME,
	@FROMSTATE	VARCHAR(2)='',
	@TOSTATE	VARCHAR(2)='zz',
	@RPT_TYPE	VARCHAR(1) = 'S'
)

AS

-- EXEC RPT_GST_BREAKUP 'JUN 19 2017','JUN 19 2017 23:59', '', 'ZZZ', 'S'
-- EXEC RPT_GST_BREAKUP 'JUN 19 2017','JUN 19 2017 23:59', '', 'ZZZ', 'D'

SELECT 
N.PARTY_CODE,
TRADEDATE = CONVERT(DATETIME,LEFT(N.SAUDA_DATE,11)), 
G.BRANCH_CD,
G.SUB_BROKER,
GST_LOCATION,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(ExSer_Tax),
ORGTARGETSTATE=L_STATE, 
TARGETSTATE=L_STATE, 
SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0)
INTO #GSTDATA
FROM TBL_CLIENT_GST_DATA G, TBL_GST_LOCATION L, FOBILLVALAN N 
WHERE N.PARTY_CODE = G.PARTY_CODE
AND GST_LOCATION = LOC_CODE
AND SAUDA_DATE BETWEEN G.EFF_FROM_DATE AND G.EFF_TO_DATE 
AND SAUDA_DATE BETWEEN @FROM_DATE AND @TO_DATE 
GROUP BY N.PARTY_CODE,G.BRANCH_CD, G.SUB_BROKER,GST_LOCATION,
LEFT(N.SAUDA_DATE,11),L_STATE,STATE 

INSERT INTO #GSTDATA
SELECT N.PARTY_CODE, 
TRADEDATE = CONVERT(DATETIME,LEFT(N.SAUDA_DATE,11)), 
BRANCH_CD=Branch_Code,
N.SUB_BROKER,
GST_LOCATION='',
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(ExSer_Tax),
ORGTARGETSTATE=L_STATE,
TARGETSTATE=L_STATE, SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0)
FROM CLIENT1 G, FOBILLVALAN N, FOOWNER,
TBL_STATE_GST_DATA T
WHERE N.PARTY_CODE = G.CL_CODE
AND FOOWNER.STATE = STATE_NAME 
AND SAUDA_DATE BETWEEN @FROM_DATE AND @TO_DATE 
AND G.CL_CODE NOT IN (SELECT PARTY_CODE FROM #GSTDATA WHERE G.CL_CODE = #GSTDATA.PARTY_CODE)
GROUP BY N.PARTY_CODE,N.Branch_Code, N.SUB_BROKER,LEFT(N.SAUDA_DATE,11),L_STATE,FOOWNER.STATE 

UPDATE #GSTDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM STATE_MASTER WHERE STATE <> 'OTHER')

UPDATE #GSTDATA SET 
STATE_CODE=D.STATE_CODE,
GST_PER=D.GST_PER,
CGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.CGST_PER ELSE 0 END),
IGST_PER=(CASE WHEN SOURCESTATE <> TARGETSTATE THEN D.IGST_PER ELSE 0 END),
SGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 0 THEN D.SGST_PER ELSE 0 END),
UGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 1 THEN D.UGST_PER ELSE 0 END),
AGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.AGST_PER ELSE 0 END)
FROM TBL_STATE_GST_DATA D
WHERE D.STATE_NAME = SOURCESTATE
AND TRADEDATE BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

UPDATE #GSTDATA SET 
CGST_PER = SERVICE_TAX * CGST_PER / GST_PER,
SGST_PER = SERVICE_TAX * SGST_PER / GST_PER,
IGST_PER = SERVICE_TAX * IGST_PER / GST_PER,
UGST_PER = SERVICE_TAX * UGST_PER / GST_PER,
AGST_PER = SERVICE_TAX * AGST_PER / GST_PER

UPDATE #GSTDATA SET SGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + UGST_PER + AGST_PER)
WHERE SGST_PER > 0 
UPDATE #GSTDATA SET UGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + SGST_PER + AGST_PER)
WHERE UGST_PER > 0 

IF @RPT_TYPE ='D' 
BEGIN
	SELECT TRADEDATE=LEFT(TRADEDATE,11), PARTY_CODE, 
	BRANCH_CD, SUB_BROKER,GST_LOCATION, STATE_CODE, SOURCESTATE, 
	ORGTARGETSTATE, TARGETSTATE, 
	TOTALGST = SERVICE_TAX,
	CGST_PER, SGST_PER, IGST_PER, UGST_PER,
	TOTALGST_REV = (CASE WHEN EXSERVICE_TAX > 0 THEN EXSERVICE_TAX ELSE 0 END), 	
	CGST_PER_REV = (CASE WHEN EXSERVICE_TAX > 0 THEN CGST_PER ELSE 0 END),
	SGST_PER_REV = (CASE WHEN EXSERVICE_TAX > 0 THEN SGST_PER ELSE 0 END),
	IGST_PER_REV = (CASE WHEN EXSERVICE_TAX > 0 THEN IGST_PER ELSE 0 END),
	UGST_PER_REV = (CASE WHEN EXSERVICE_TAX > 0 THEN UGST_PER ELSE 0 END),
	SDATE=TRADEDATE
	FROM #GSTDATA
	WHERE STATE_CODE >= @FROMSTATE AND STATE_CODE <= @TOSTATE 
	ORDER BY SDATE, STATE_CODE, PARTY_CODE 
END
ELSE
BEGIN
	SELECT TRADEDATE=LEFT(TRADEDATE,11), SOURCESTATE, 
	TOTALGST = SUM(CGST_PER) + SUM(SGST_PER) + SUM(IGST_PER) + SUM(UGST_PER),	
	CGST_AMT=SUM(CGST_PER),
	SGST_AMT=SUM(SGST_PER),
	IGST_AMT=SUM(IGST_PER),
	UGST_AMT=SUM(UGST_PER),
	TOTALGST_REV = SUM(CASE WHEN EXSERVICE_TAX > 0 THEN CGST_PER ELSE 0 END)
				 + SUM(CASE WHEN EXSERVICE_TAX > 0 THEN SGST_PER ELSE 0 END)
				 + SUM(CASE WHEN EXSERVICE_TAX > 0 THEN IGST_PER ELSE 0 END)
				 + SUM(CASE WHEN EXSERVICE_TAX > 0 THEN UGST_PER ELSE 0 END),
	CGST_AMT_REV=SUM(CASE WHEN EXSERVICE_TAX > 0 THEN CGST_PER ELSE 0 END),
	SGST_AMT_REV=SUM(CASE WHEN EXSERVICE_TAX > 0 THEN SGST_PER ELSE 0 END),
	IGST_AMT_REV=SUM(CASE WHEN EXSERVICE_TAX > 0 THEN IGST_PER ELSE 0 END),
	UGST_AMT_REV=SUM(CASE WHEN EXSERVICE_TAX > 0 THEN UGST_PER ELSE 0 END),
	SDATE=TRADEDATE
	FROM #GSTDATA G 
	WHERE STATE_CODE >= @FROMSTATE AND STATE_CODE <= @TOSTATE 
	GROUP BY TRADEDATE, SOURCESTATE 
	ORDER BY SDATE, SOURCESTATE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_GST_BREAKUP_DETAIL
-- --------------------------------------------------

CREATE PROC RPT_GST_BREAKUP_DETAIL
(  
 @FROM_DATE DATETIME,  
 @TO_DATE DATETIME,  
 @FROMSTATE VARCHAR(2)='',  
 @TOSTATE VARCHAR(2)='ZZ',  
 @FILLER1 VARCHAR(2)='',  
 @FILLER2 VARCHAR(2)=''    
)  
  
AS  

SET @TOSTATE = (CASE WHEN @TOSTATE = '' THEN 'ZZ' ELSE @TOSTATE END) 
--EXEC RPT_GST_BREAKUP_DETAIL 'JUN 19 2017', 'JUN 19 2017', '', 'ZZZ', '', ''
SET @TO_DATE = LEFT(@TO_DATE,11) + ' 23:59:59'
EXEC RPT_GST_BREAKUP @FROM_DATE, @TO_DATE, @FROMSTATE, @TOSTATE, 'D'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_GST_BREAKUP_SUMMARY
-- --------------------------------------------------


CREATE PROC RPT_GST_BREAKUP_SUMMARY 
(  
 @FROM_DATE DATETIME,  
 @TO_DATE DATETIME,  
 @FROMSTATE VARCHAR(2)='',  
 @TOSTATE VARCHAR(2)='ZZ',  
 @FILLER1 VARCHAR(2)='',  
 @FILLER2 VARCHAR(2)=''    
)  
  
AS  

SET @TOSTATE = (CASE WHEN @TOSTATE = '' THEN 'ZZ' ELSE @TOSTATE END) 
--EXEC RPT_GST_BREAKUP_SUMMARY 'JUN 19 2017', 'JUN 19 2017', '', 'ZZZ', '', ''
SET @TO_DATE = LEFT(@TO_DATE,11) + ' 23:59:59'
EXEC RPT_GST_BREAKUP @FROM_DATE, @TO_DATE, @FROMSTATE, @TOSTATE, 'S'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_HISTORYDATA
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_HISTORYDATA] 
(
	@SAUDA_DATEFROM VARCHAR(11),
	@SAUDA_DATETO VARCHAR(11),
	@EXPIRY_DATEFROM VARCHAR(11),
	@EXPIRY_DATETO VARCHAR(11),
	@FECHFOR VARCHAR(10)
)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @SAUDA_DATETO = '' BEGIN SET @SAUDA_DATETO = 'DEC 31 2049 23:59' END
IF @EXPIRY_DATETO = '' BEGIN SET @EXPIRY_DATETO = 'DEC 31 2049 23:59' END

IF @FECHFOR = 'CURRENT'
BEGIN
	Select 
		ExpiryDate = Left(ExpiryDate,11) , 
		TradeDateFrom = Left(Min(Sauda_Date),11), 
		TradeDateTo = Left(Max(Sauda_Date),11),
		convert(varchar,ExpiryDate,112) 
	From 
		Fosettlement (nolock)
	Where 
		Sauda_Date >= @SAUDA_DATEFROM
		And Sauda_Date <= @SAUDA_DATETO + ' 23:59:59'
		And ExpiryDate >= @EXPIRY_DATEFROM
		And ExpiryDate <= @EXPIRY_DATETO + ' 23:59:59'
	Group by 
		Left(ExpiryDate,11),convert(varchar,ExpiryDate,112)
	Order by 
		convert(varchar,ExpiryDate,112)
	
END
ELSE
BEGIN
	Select 
		ExpiryDate = Left(ExpiryDate,11) , 
		TradeDateFrom = Left(Min(Sauda_Date),11), 
		TradeDateTo = Left(Max(Sauda_Date),11),
		convert(varchar,ExpiryDate,112) 
	From 
		Pradnya.dbo.DataIn_History_Fosettlement_NCDX (nolock)
	Where 
		Sauda_Date >= @SAUDA_DATEFROM
		And Sauda_Date <= @SAUDA_DATETO +' 23:59:59'
		And ExpiryDate >= @EXPIRY_DATEFROM
		And ExpiryDate <= @EXPIRY_DATETO +' 23:59:59'
	Group by 
		Left(ExpiryDate,11),convert(varchar,ExpiryDate,112)
	Order by 
		convert(varchar,ExpiryDate,112)
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ledgerbillentry
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_ledgerbillentry    Script Date: 01/15/2005 5:25:55 PM ******/    
    
/****** Object:  Stored Procedure dbo.rpt_ledgerbillentry    Script Date: 12/16/2003 2:37:02 PM ******/    
    
    
    
    
/****** Object:  Stored Procedure dbo.rpt_ledgerbillentry    Script Date: 2/17/01 5:19:50 PM ******/    
    
    
/****** Object:  Stored Procedure dbo.rpt_ledgerbillentry    Script Date: 04/27/2001 4:32:44 PM ******/    
    
    
/*changed by mousami on 12 dec 2001     
    now settnoetc is taken from ledger3     
     instead of ledger1 so removed bnkname column    
  */    
/*changed by mousami  on 16 oct  2001     
    added hardcoding as l3.naratno=0    
    in else part of narration.    
    If line no of ledger and ledger3 does not match then  take main narration     
    for main narration line number is 0    
*/     
    
/*changed by mousami on  aug 2 2001     
    added ledger3 join so that we can get narration from ledger3 which gives details about to which exchange a particular bill belongs to     
*/    
    
/*selects details of bill entry for a client code from ledger */    
/*    
changed by mousami on 01/03/2001    
added hardcoding for account databse */    
     
CREATE PROCEDURE [dbo].[rpt_ledgerbillentry]    
@vtyp smallint,     
@vno varchar(12),    
@lno numeric,    
@drcr varchar(1),    
@cltcode varchar(10)    
AS    
    
    
SELECT   narr=isnull((case when (select l3.narr from ACCOUNTNCE.DBO.ledger3 l  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l.naratno = l3.naratno) is  not null    
                 then (select l3.narr from ACCOUNTNCE.DBO.ledger3 l  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype  AND l.naratno = l3.naratno)     
                 else (select l3.narr from ACCOUNTNCE.DBO.ledger3 l  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype and  l3.naratno = 0 )     
                 end),'')    
fROM ACCOUNTNCE.DBO.LEDGER3 L3    
WHERE l3.vtyp = @vtyp  and l3.vno = @vno    
and l3.naratno = @lno      
    
/* old    
SELECT BNKNAME, L.VTYP,L.VNO,L.LNO,L.DRCR, L.CLTCODE ,    
 narr=isnull((case when (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l.lno = l3.naratno) is  not null    
                 then (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype  AND l.lno = l3.naratno)     
                 else (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype and  l3.naratno = 0 )     
                 end),'')    
fROM ACCOUNTNCE.DBO.LEDGER L, ACCOUNTNCE.DBO.LEDGER1 L1    
WHERE l1.vtyp = @vtyp  and l1.vno = @vno    
and l1.lno = @lno  and l1.drcr = @drcr    
and l.vtyp='15' and cltcode= @cltcode    
and l.vtyp=l1.vtyp and l.vno = l1.vno    
and l.lno = l1.lno and l.drcr = l1.drcr    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENT
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[RPT_LISTCLIENT] 
(      
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@PARTYCODE VARCHAR(15),      
	@TOPARTYCODE VARCHAR(15)      
) AS      

	SELECT
		PARTY_CODE
	FROM
		CLIENT1 (NOLOCK),
		CLIENT2 (NOLOCK)
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
	        AND @STATUSNAME = (       
	        CASE       
	                WHEN @STATUSID = 'BRANCH'       
	                THEN BRANCH_CD       
	                WHEN @STATUSID = 'SUBBROKER'       
	                THEN SUB_BROKER       
	                WHEN @STATUSID = 'TRADER'       
	                THEN TRADER       
	                WHEN @STATUSID = 'FAMILY'       
	                THEN FAMILY       
	                WHEN @STATUSID = 'AREA'       
	                THEN AREA       
	                WHEN @STATUSID = 'REGION'       
	                THEN REGION       
	                WHEN @STATUSID = 'CLIENT'       
	  		THEN PARTY_CODE       
	                ELSE 'BROKER' END) 
		AND PARTY_CODE BETWEEN  @PARTYCODE AND @TOPARTYCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_ListClientName
-- --------------------------------------------------
CREATE  PROCEDURE rpt_ListClientName  
@statusid varchar(15),  
@statusname varchar(25),  
@partyName varchar(50),  
@TopartyName varchar(50)  
AS  
  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
  Select distinct c2.Party_Code, c1.Long_Name  
  FROM CLIENT1 C1 WITH(NOLOCK),   
       CLIENT2 C2 WITH(NOLOCK)   
  WHERE C2.CL_CODE = C1.CL_CODE   
        AND @STATUSNAME =   
                  (CASE   
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
                  ELSE   
                        'BROKER'  
                END)  
    and C1.Long_Name Between ltrim(rtrim(@partyName))  and ltrim(rtrim(@TopartyName))  
    order by c1.Long_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINACCESS
-- --------------------------------------------------

  
CREATE  PROCEDURE  [dbo].[RPT_LOGINACCESS]               
@FROMDATE AS VARCHAR(11),  
@TODATE AS VARCHAR(11),  
@REPORTTYPE VARCHAR(10),  
@SEARCHBY VARCHAR(10)  
  
  
AS      
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)               
SET @TODATE = CONVERT(VARCHAR,@TODATE,109)       
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
    
IF @REPORTTYPE = 'SUCCESS'  
BEGIN   
 SELECT     
       
  L.USERID,     
  L.USERNAME,  
  C.FLDCATEGORYNAME,  
  L.STATUSNAME,  
  L.STATUSID,  
  L.IPADD,  
  L.ACTION,  
  ADDDT = CONVERT(VARCHAR,L.ADDDT,109)   
        
       
 FROM V2_LOGIN_LOG L(NOLOCK)    
    
       
 LEFT OUTER JOIN     
     TBLCATEGORY C(NOLOCK)       
     ON     
     (     
         L.CATEGORY = C.FLDCATEGORYCODE     
      )   
 WHERE    
  ADDDT >= @FROMDATE    
     AND ADDDT <= @TODATE + ' 23:59:59'    
  AND STATUSNAME = CASE WHEN @SEARCHBY ='ADMIN' THEN 'ADMIN' ELSE STATUSNAME END  
 ORDER BY ADDDT    
END  
ELSE  
BEGIN  
 SELECT LOGIN_ID,LOGIN_PWD,IPADD,ERR_TYPE,LOGIN_DT   
 FROM V2_LOGIN_ERR_LOG  
 WHERE LOGIN_DT BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
 AND LOGIN_TYPE = @SEARCHBY  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_loginclient
-- --------------------------------------------------
/****** Object:  Stored Procedure dbo.rpt_loginclient    Script Date: 01/15/2005 5:25:57 PM ******/  
  
/****** Object:  Stored Procedure dbo.rpt_loginclient    Script Date: 12/16/2003 2:37:02 PM ******/  
  
  
/****** Object:  Stored Procedure dbo.rpt_loginclient    Script Date: 10/17/02 1:53:09 PM ******/  
/*Created by amit on 06/08/2002 client detail report  */  
CREATE PROCEDURE rpt_loginclient   
@statusid varchar(15),  
@statusname varchar(25)  
AS  
if @statusid='broker'  
  begin  
    select distinct  party_code  
    from client2  
    order by party_code  
  end  
if @statusid='branch'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2, client1 c1, branches b  
    where ltrim(rtrim(b.short_name)) = ltrim(rtrim(c1.trader)) and  
   c1.cl_code = c2.cl_code and  
   ltrim(rtrim(b.branch_cd)) = ltrim(rtrim(@statusname))   
    order by c2.Party_Code  
  end    
if @statusid='subbroker'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2,client1 c1,subbrokers sb  
    where c1.cl_code = c2.cl_code and  
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(@statusname)) and  
   ltrim(rtrim(sb.sub_broker)) = ltrim(rtrim(c1.sub_broker))    
   order by c2.Party_Code  
  end   
if @statusid='trader'  
  begin  
    select distinct  c2.Party_Code  
    from client2 c2, client1 c1  
    where c1.cl_code = c2.cl_code and ltrim(rtrim(c1.trader))  = ltrim(rtrim(@statusname))    
    order by c2.Party_Code  
  end   
if @statusid='client'  
  begin  
    select distinct c2.Party_Code  
    from client2 c2, client1 c1   
    where c1.cl_code=c2.cl_code and  
  c2.party_code=@statusname   
 order by c2.Party_Code  
  end  
if @statusid='family'  
  begin  
    select distinct c2.Party_Code  
    from client2 c2, client1 c1  
    where c1.cl_code = c2.cl_code and ltrim(rtrim(c1.family))  = ltrim(rtrim(@statusname))  
    order by c2.Party_Code  
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_loginclientName
-- --------------------------------------------------
CREATE PROCEDURE rpt_loginclientName  
@statusid varchar(15),  
@statusname varchar(25)  
  
AS  

  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
  Select distinct c2.Party_Code, c1.Long_Name  
  FROM CLIENT1 C1 WITH(NOLOCK),   
       CLIENT2 C2 WITH(NOLOCK)   
  WHERE C2.CL_CODE = C1.CL_CODE   
        AND @STATUSNAME =   
                  (CASE   
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
                  ELSE   
                        'BROKER'  
                END)  
    --and C1.Long_Name Between ltrim(rtrim(@partyName))  and ltrim(rtrim(@TopartyName))  
    order by c1.Long_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MISSINGCLIENTINVBB
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_MISSINGCLIENTINVBB]
	(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMDATE VARCHAR(11),
	@FROMPARTY VARCHAR(15),
	@TOPARTY VARCHAR(15),
	@CLIENTTYPE VARCHAR(3),
	@FUTNRM INT,
	@FUTFINAL INT,
	@OPTNRM INT,
	@OPTFINAL INT
	)

	AS

	--EXEC RPT_MISSINGCLIENTINVBB 'BROKER','BROKER','Jun 12 2006','','ZZZZZZ','T',0,0,0,0

	IF @CLIENTTYPE = 'T'
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5,
			FOSETTLEMENT S
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND S.PARTY_CODE = C2.PARTY_CODE
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)
			
			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO
					AND (1 = (CASE WHEN SP_INST_TYPE = 'FUT' AND SP_TRD_TYPE = 'TRD' THEN @FUTNRM ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'FUT' AND SP_TRD_TYPE = 'DEL' THEN @FUTFINAL ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'OPT' AND SP_TRD_TYPE = 'TRD' THEN @OPTNRM ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'OPT' AND SP_TRD_TYPE = 'DEL' THEN @OPTFINAL ELSE 0 END))
					)

			AND (1 = (CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA' THEN @FUTNRM ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' THEN @FUTFINAL ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'EA' THEN @OPTNRM ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA' THEN @OPTFINAL ELSE 0 END))

			AND S.SAUDA_DATE LIKE @FROMDATE + '%'
			AND AUCTIONPART <> 'CA'

		ORDER BY
			C2.PARTY_CODE
	   END
	ELSE
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)
			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO)

			AND C5.ACTIVEFROM >=
				(CASE WHEN @CLIENTTYPE = 'A' 
					THEN @FROMDATE
					ELSE 'JAN  1 1900 23:59:59'
					END)

			AND C5.INACTIVEFROM <=
				(CASE WHEN @CLIENTTYPE = 'I' 
					THEN @FROMDATE
					ELSE 'DEC 31 2049 23:59:59'
					END)

		ORDER BY
			C2.PARTY_CODE
	   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_netbalancesbs
-- --------------------------------------------------
--sp_helptext Rpt_netbalancesbs      
  
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 01/15/2005 1:42:25 Pm ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 12/16/2003 2:31:55 Pm ******/    
--rpt_netBalancesBS 'Apr 1 2005','May 31 2005','A0314020000','broker','broker'  
/****** Object:  Stored Procedure Dbo.rpt_netbalancesbs    Script Date: 06/26/2002 6:15:44 Pm ******/    
/* Query To Get Net Income And Expenses For The Given Period */    
/* Written On 13-06-2002 By Vns */    
/* Flag Can Have Values 'a' - For Income */    
/*                      'l' - For Expenses */    
--rpt_netBalancesBS_2 'Apr  1 2005','May 31 2005','A0307000000','broker','broker'    
CREATE Proc [dbo].[Rpt_netbalancesbs]  
@fromdt Varchar(11),    
@todt Varchar(11),    
@grpcode Varchar(11),    
@statusid Varchar(15),    
@statusname Varchar(25)    
  
As    
--Print len(rtrim(@grpcode))  
If Len(@GrpCode) < 11  
 Begin  
  Select Type='G', Grp=substring(a.grpcode,1,len(rtrim(@grpcode))), Grpname=grpname, Bal= Isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
  From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A, ACCOUNTNCE.DBO.grpmast G    
  Where L.cltcode = A.cltcode And Substring(a.grpcode,1,len(rtrim(@grpcode))) = Rtrim(@grpcode)     
  And Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
  And G.grpcode = Substring(a.grpcode, 1, len(rtrim(@grpcode)))        --+ )   rtrim(@grpcode) + Right('0000000000', 11-(len(rtrim(@grpcode))+2))  
  Group By Substring(a.grpcode,1,len(rtrim(@grpcode))), Grpname    
  Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
      
  Union All    
      
  Select Type = 'D', Grp=l.cltcode, Grpname=l.acname, Bal= Isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
  From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A    
  Where Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
  And L.cltcode = A.cltcode And A.grpcode = @grpcode  +rtrim(right('0000000000',11-len(rtrim(@grpcode))))     
  Group By L.cltcode, L.acname    
  Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
      
  Order By Type,grp, Grpname  
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_netbs01
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 01/15/2005 1:42:24 Pm ******/    
    
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 12/16/2003 2:31:55 Pm ******/    
    
    
/****** Object:  Stored Procedure Dbo.rpt_netbs01    Script Date: 06/26/2002 6:15:44 Pm ******/    
/* Query To Get Net Income And Expenses For The Given Period */    
/* Written On 22-06-2002 By Vns */    
/* Flag Can Have Values 'a' - For Assets */    
/*                      'l' - For Liabilities */    
    
CREATE Proc [dbo].[Rpt_netbs01]    
@fromdt Varchar(11),    
@todt Varchar(11),    
@statusid Varchar(15),    
@statusname Varchar(25)    
    
As    
    
Select Type='g', Grp=substring(a.grpcode,1,3), Grpname=grpname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A, ACCOUNTNCE.DBO.grpmast G    
Where L.cltcode = A.cltcode And Substring(a.grpcode,1,1) In ('a','l')    
And Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
And G.grpcode = Substring(a.grpcode,1,3)+ '00000000' And A.cltcode <> '99999'    
Group By Substring(a.grpcode,1,3), Grpname    
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
    
Union All    
    
Select Type = 'd', Grp=l.cltcode, Grpname=l.acname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)    
From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A    
Where Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'    
And L.cltcode = A.cltcode And A.grpcode In ('a0000000000', 'l0000000000')     
Group By L.cltcode, L.acname    
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0    
Order By Grp, Grpname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_netpandl01
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_netpandl01    Script Date: 01/15/2005 1:42:26 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_netpandl01    Script Date: 12/16/2003 2:31:55 Pm ******/  
  
/****** Object:  Stored Procedure Dbo.rpt_netpandl01    Script Date: 06/26/2002 6:15:44 Pm ******/  
/* Query To Get Net Income And Expenses For The Given Period */  
/* Written On 13-06-2002 By Vns */  
/* Flag Can Have Values 'n' - For Income */  
/*                      'x' - For Expenses */  
  
CREATE Proc [dbo].[Rpt_netpandl01]  
@fromdt Varchar(11),  
@todt Varchar(11),  
@statusid Varchar(15),  
@statusname Varchar(25)  
  
As  
  
Select Type='g', Grp=substring(a.grpcode,1,3), Grpname=grpname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0), Left(a.grpcode,1)  
From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A, ACCOUNTNCE.DBO.grpmast G  
Where L.cltcode = A.cltcode And Substring(a.grpcode,1,1) In ('n','x')  
And Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'  
And G.grpcode = Substring(a.grpcode,1,3)+ '00000000'  
Group By Substring(a.grpcode,1,3), Grpname, Left(a.grpcode,1)  
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0  
  
Union All  
  
Select Type = 'd', Grp=l.cltcode, Grpname=l.acname, Bal=isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0), Left(a.grpcode,1)  
From ACCOUNTNCE.DBO.ledger L, ACCOUNTNCE.DBO.acmast A  
Where Vdt >= @fromdt + ' 00:00:00' And Vdt <= @todt + ' 23:59:59'  
And L.cltcode = A.cltcode And A.grpcode In ('n0000000000', 'x0000000000')  
Group By L.cltcode, L.acname, Left(a.grpcode,1)  
Having Abs(isnull(sum(case When Drcr = 'd' Then Vamt Else -vamt End),0)) > 0  
Order By Grp, Grpname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_openingbal_New
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[rpt_openingbal_New]    
@vdt varchar(12),    
@partycode varchar(10),    
@cltype varchar(3),    
@ReportPara Varchar(5)    
    
AS    
    
    
--*** rpt_openingbal ***--    
If @ReportPara = '1'    
 Begin    
  Select VDT , vtyp,vno,lno,drcr,    
  vamt, balamt,Vdesc,    
  nar=isnull((case when (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l.lno = l3.naratno) is  not null    
                 then (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype  AND l.lno = l3.naratno)     
                 else (select l3.narr from ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype and l3.naratno=0 )     
                 end),''),    
  edt, edtdiff=datediff(d, l.edt , getdate() )     
  from ACCOUNTNCE.DBO. ledger l, ACCOUNTNCE.DBO.vmast v    
  where  vdt  like  ltrim(@vdt) + '%'  and   vtyp='18'    
  and cltcode = @partycode and l.vtyp=v.vtype     
  order by vdt, drcr,vtyp    
 End     
    
    
    
--*** rpt_openingbalbr ***--    
If @ReportPara = '2'    
 Begin    
  select VDT , l.vtyp,l.vno,l.lno,l2.drcr,    
  vamt=camt, balamt,Vdesc,    
  nar=isnull((case when (select l3.narr from  ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype AND l.lno = l3.naratno) is  not null    
                 then (select l3.narr from  ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype  AND l.lno = l3.naratno)     
                 else (select l3.narr from  ACCOUNTNCE.DBO.ledger3 l3  where L.VTYP = L3.VTYP AND L.VNO = L3.VNO and l.booktype = l3.booktype and l3.naratno=0 )     
                 end),''),    
  edt, edtdiff=datediff(d, l.edt , getdate() )     
  from  ACCOUNTNCE.DBO.ledger l,  ACCOUNTNCE.DBO.vmast v,   ACCOUNTNCE.DBO.ledger2 l2,  ACCOUNTNCE.DBO.costmast c ,  ACCOUNTNCE.DBO.category ct    
  where  vdt  like  ltrim(@vdt) + '%'  and   vtyp='18'    
  and l.cltcode = @partycode and l.vtyp=v.vtype     
  and l.vtyp=v.vtype and    
  l2.vtype=l.vtyp and    
  l2.vno=l.vno and    
  l2.lno=l.lno and    
  l2.booktype=l.booktype and ct.category='branch'    
  and c.costcode=l2.costcode     
  order by vdt, l2.drcr,l.vtyp    
 End    
    
    
    
--*** rpt_fomodcollateral2 ***--    
If @ReportPara = '3' And @cltype = 'EXC'     
 Begin    
  select c.party_code, coll_date= Trans_Date, cash, noncash , cl_type    
  from msajag.dbo.collateral c, client1 c1, client2 c2    
  where c.party_code like ltrim(@partycode)+'%'     
  and c.exchange = 'NSE'     
  and c.segment = 'FUTURES'    
  and c1.cl_type = @cltype    
  and c1.cl_code = c2.cl_code    
  and c.party_code = c2.party_code    
  and left(convert(varchar,Trans_Date,109),11) = @vdt    
 End     
Else If @ReportPara = '3'   
 Begin    
  select c.party_code, coll_date= Trans_Date , cash, noncash , cl_type    
  from msajag.dbo.collateral c, client1 c1, client2 c2    
  where c.party_code like ltrim(@partycode)+'%'     
  and c.exchange = 'NSE'     
  and c.segment = 'FUTURES'    
  and c1.cl_type like ltrim(@cltype)+'%'    
  and c1.cl_type <> 'EXC'    
  and c1.cl_code = c2.cl_code    
  and c.party_code = c2.party_code    
  and left(convert(varchar,Trans_Date,109),11) = @vdt    
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_partydetdailyNew
-- --------------------------------------------------
CREATE  PROCEDURE rpt_partydetdailyNew
(
	@statusid varchar(15),
	@statusname varchar(25),
	@fparty varchar(10),
	@tparty varchar(10),
	@sauda varchar(11),
	@branchcd varchar(10) ='%'
)
AS

if @branchcd ='' begin set @branchcd ='%' end
if @tparty ='' begin set @tparty ='zzzzzzzzzz' end

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

select 
	C2.party_code,
	c2.cl_code,
	c2.exchange,
	c2.tran_cat,
	c1.email,
	c1.res_phone1,
	c1.short_name,
	c1.L_address1,
	c1.L_address2,
	c1.L_address3,
	c1.L_city,
	c1.L_zip,
	c1.family,
	c1.long_name,
	Trader = IsNull(C1.Trader,'')
From
	client1 c1 (nolock),
	client2 c2 (nolock),
	(
		Select
			Distinct FOPDD_PARTY_CODE From FO_POS_DETAILS_DAS (nolock)
		Where 
			FOPDD_SAUDA_DATE Between @sauda And @sauda + ' 23:59'
			And FOPDD_PARTY_CODE Between @fparty and @tparty
		
		Union 
		
		Select
			Distinct FOTDD_PARTY_CODE From FO_TRADE_DETAILS_DAS  (nolock)
		Where 
			FOTDD_SAUDA_DATE Between @sauda And @sauda + ' 23:59'
			And FOTDD_PARTY_CODE Between @fparty and @tparty

/*
		Union 
		

		Select
			Distinct LEDDD_PARTY_CODE From LEDGER_DETAILS_DAS  (nolock)
		Where 
			LEDDD_SAUDA_DATE Between @sauda And @sauda + ' 23:59'
			And LEDDD_PARTY_CODE Between @fparty and @tparty
*/

	) f 
Where
	f.FOPDD_PARTY_CODE = c2.party_code     
	And c1.cl_code = c2.cl_code
	And c1.branch_cd like @branchcd
	And C2.party_code between @fparty and @tparty
        And @STATUSNAME = 
	( 
        CASE 
                WHEN @STATUSID = 'BRANCH' 
                THEN C1.BRANCH_CD 
                WHEN @STATUSID = 'SUBBROKER' 
                THEN C1.SUB_BROKER 
                WHEN @STATUSID = 'TRADER' 
                THEN C1.TRADER 
                WHEN @STATUSID = 'FAMILY' 
                THEN C1.FAMILY 
                WHEN @STATUSID = 'AREA' 
                THEN C1.AREA 
                WHEN @STATUSID = 'REGION' 
                THEN C1.REGION 
                WHEN @STATUSID = 'CLIENT' 
                THEN C2.PARTY_CODE 
                ELSE 'BROKER' END
	) 
Order By party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_partymapping
-- --------------------------------------------------








CREATE     proceDURE [dbo].[rpt_partymapping]
	@date varchar(11),
	@OrderType Varchar(10),
	@RptType Varchar(10)

	AS
  
set transaction isolation level read uncommitted

If (@RptType = 'Summary')
Begin
	select
		RptOrder = (Case When @OrderType = 'PARTY' 
				Then Party_Code
				Else ContractNo
				End),	
		party_code,
		contractno,
		User_Id,
		branch_id,
		symbol,
		sell_buy,
		tradeqty = sum(tradeqty),
		avgrate = sum(price * tradeqty)/sum(tradeqty),
		inst_type,
		strike_price,
		option_type,
		Expirydate = left(convert(varchar,expirydate,109),11) 
	
	from
		fosettlement  S (Nolock),
		Client1 C1 (Nolock)
	where 
		S.Party_code = C1.CL_Code
		And sauda_date like @date +'%'
		and tradeqty > 0
	
	group by
		party_code,
		user_id,
		branch_id,
		contractno,
		symbol,
		sell_buy,
		inst_type,
		strike_price,
		option_type,
		left(convert(varchar,expirydate,109),11) 
		
	order by 
		contractno, 
		Party_code,
		RptOrder
End
Else
Begin
	select
		RptOrder = (Case When @OrderType = 'PARTY' 
				Then Party_Code
				Else ContractNo
				End),	
		party_code,
		contractno,
		User_Id,
		branch_id,
		symbol,
		sell_buy,
		tradeqty = tradeqty,
		avgrate = price,
		inst_type,
		strike_price,
		option_type,
		Expirydate = left(convert(varchar,expirydate,109),11) 
	
	from
		fosettlement  S (Nolock),
		Client1 C1 (Nolock)
	where 
		S.Party_code = C1.CL_Code
		And sauda_date like @date +'%'
		and tradeqty > 0
	
	order by 
		contractno, 
		Party_code,
		RptOrder

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PODPBANK_DETAILS
-- --------------------------------------------------

CREATE  PROC RPT_PODPBANK_DETAILS
	(
	@BANKTYPE VARCHAR(5)
	)

	AS

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (@BANKTYPE = 'PO')
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANK_NAME, 
			BRANCH_NAME 
		FROM 
			POBANK (NOLOCK)
	END
	ELSE
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANKNAME, 
			BANKTYPE 
		FROM 
			BANK (NOLOCK)
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_positiondetails_beforeconfirmation
-- --------------------------------------------------
CREATE procedure rpt_positiondetails_beforeconfirmation  
  
@statusid varchar(15),  
@statusname varchar(25),  
@codefrom as varchar(20),  
@codeto as varchar(20),  
@sdate as varchar(12)  
  
as   
  
  
  
  
/* condition for broker begins here */  
  
if @statusid = 'broker'  
begin  
  
  
select a.party_code,Long_Name=IsNull(Long_Name,'N/A'),inst_type,a.symbol,left(convert(varchar,expirydate,106),11) as expirydate,  
strike_price,option_type,tradeqty,price, trade_amount = (case when (reserved1 in ('1','3') or reserved1 is not null or reserved1='') then (tradeqty*(strike_price+price)) else 0 end),  
Brok=0 ,  
service_tax=0,  
amount=(case when  (reserved1 in ('1','3') or reserved1 is not null or reserved1='') then (tradeqty*(strike_price+price)) else 0 end),  
trade_no = trade_no,  
substring(convert(varchar,activitytime,109),13,8) 'Sauda_DATE' ,year(expirydate),month(expirydate),day(expirydate),sell_buy,activitytime AS SDT,user_id,  
inexstax=0,BuyAmount=(Case When Sell_buy = 1 Then TradeQty*Price Else 0 End),SellAmount=(Case When Sell_buy = 2 Then TradeQty*Price Else 0 End),ParticipantCode  
from fotrade a Left Outer Join ( Select Long_Name, Party_Code From Client2 C2, Client1 C1 Where C1.Cl_Code = C2.Cl_Code ) C  
On (A.Party_code = C.Party_Code)  
where a.party_code between @codefrom and @codeto   
and activitytime like @sdate+'%'  
and tradeqty <> 0   
order by 1,3,year(expirydate) desc,month(expirydate) desc,day(expirydate) desc,2,5,6,sauda_date  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_client2_log
-- --------------------------------------------------
/****** Object:  Stored Procedure Dbo.rpt_proc_client2_log    Script Date: 01/15/2005 1:44:14 Pm ******/  
  
/*proc To Writew Log Of Activities In The Client2/client5 Table*/  
/*called From The Add/edit Client Asp Page*/  
/*written By Shyam.*/  
  
CREATE   Procedure  
  
Rpt_proc_client2_log  
  
@cl_code Varchar (10),  
@party_code Varchar (10),  
  
@script_name Varchar (500),  
@session_id Varchar (30),  
@local_addr Varchar (20),  
@remote_addr Varchar (20),  
@remote_host Varchar (50),  
--@request_method Varchar (20),  
--@content_type Varchar (50),  
--@content_length Int,  
@status_name Varchar (50),  
@user_name Varchar (100),  
--@module Varchar (50),  
@action Varchar (100)  
  
As  
  
Insert Into  
 Client2_log  
  Select  
   C2.cl_code,   
   C2.exchange,   
   C2.tran_cat,   
   C2.scrip_cat,   
   C2.party_code,   
   C2.table_no,   
   C2.sub_tableno,   
   C2.margin,   
   C2.turnover_tax,   
   C2.sebi_turn_tax,   
   C2.insurance_chrg,   
   C2.service_chrg,   
   C2.std_rate,   
   C2.p_to_p,   
   C2.exposure_lim,   
   C2.demat_tableno,   
   C2.bankid,   
   C2.cltdpno,   
   C2.printf,   
   C2.albmdelchrg,   
   C2.albmdelivery,   
   C2.albmcf_tableno,   
   C2.mf_tableno,   
   C2.sb_tableno,   
   C2.brok1_tableno,   
   C2.brok2_tableno,   
   C2.brok3_tableno,   
   C2.brokernote,   
   C2.other_chrg,   
   C2.brok_scheme,   
   C2.contcharge,   
   C2.mincontamt,   
   C2.addledgerbal,   
   C2.dummy1,   
   C2.dummy2,   
   C2.inscont,   
   C2.sertaxmethod,   
   C2.dummy6,   
   C2.dummy7,   
   C2.dummy8,   
   C2.dummy9,   
   C2.dummy10,   
   C5.activefrom,   
   C5.inactivefrom,   
   Dpf.debitflag,   
   Dpf.interflag,   
   @script_name,   
   @session_id,   
   @local_addr,   
   @remote_addr,   
   @remote_host,   
--   @request_method,   
--   @content_type,   
--   @content_length,   
   @status_name,   
   @user_name,   
--   Getdate(),   
   Left(convert(varchar, Getdate(), 109), 50),   
--   @module,   
   @action   
  From  
   Client2 C2, Client5 C5, Delpartyflag Dpf  
  Where  
   C2.cl_code = C5.cl_code And  
   C2.cl_code = Dpf.party_code And  
   C2.cl_code = @cl_code And   
   C2.party_code = @party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBill
-- --------------------------------------------------



CREATE      PROC
[dbo].[rpt_proc_FO_NewBill]

	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY

	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),

	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'

	@OneOrMany VarChar(20),

	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Symbol VarChar(20),		--]

	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS

	@WithNetPos VarChar(50),
	@Dummy002 VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare

	@strSelect VarChar(8000),
	@strSelectTemp VarChar(8000),
	@strFrom VarChar(8000),
	@strWhere VarChar(8000),
	@strGroupBy VarChar(8000),
	@strOrderBy VarChar(8000),
	@strCompute VarChar(8000),
	@strComputeSub VarChar(8000),

	@IsSubLevel VarChar(3),
	@CodeID VarChar(20),
	@Comma VarChar(1)

	Set @InstType = @InstType+"%" 
	If @OptionType = '' Begin Set @OptionType = "%" End
	--If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE
	If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End
	If @Symbol = '' Begin Set @Symbol = "%" End
	
	If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End
	If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End
	If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End

	Set @strSelect = ''
	Set @strSelectTemp = ''
	Set @strFrom = ''

	Set @strWhere = ''
	Set @strGroupBy = ''
	Set @strOrderBy = ''
	Set @strCompute = ''
	Set @strCompute = ''
	Set @strComputeSub = ''
	Set @IsSubLevel = 'YES'

	If (@ReportName = 'BILL')
	Begin
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End
		
		Set @strSelect = @strSelect + "SELECT "
		Set @strCompute = @strCompute + "COMPUTE "

		--@WhatCode WILL ALWAYS BE 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		If ((@WhatCode = 'CLIENT') AND (@OneOrMany = 'SUMMARY'))
		Begin
			Set @strSelectTemp = ''
			--@GroupLevel/@SubGroupLevel WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name, 25) AS party_name, client_type, Convert(VarChar,sauda_date,103) AS sauda_date, YY=Year(sauda_date),MM=Month(Sauda_Date),DD=Day(Sauda_Date), "
				Set @strComputeSub = @strComputeSub + "party_code "
			End

			Set @strSelect = @strSelect + @strSelectTemp
			Set @strSelectTemp = ''

		End /*If (@WhatCode = 'CLIENT')*/

		--@Ex_Rate AND @Ex_ReportBy WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		If (@Ex_Rate = 'MKTRATE')
		Begin
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--AMT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum((SBillAmt - PBillAmt) - ((service_tax) + (turn_tax) + (sebi_tax) + (broker_note) + "
				Set @strSelectTemp = @strSelectTemp + " (ins_chrg) + (other_chrg) + (cl_chrg-excl_chrg))) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* AMT */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS billamt "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/

		Set @strFrom = @strFrom + " INTO ##FOBILLNEW "
		Set @strFrom = @strFrom + "FROM "
		Set @strFrom = @strFrom + "FoBillValan (nolock)"
	
		Set @strWhere = @strWhere + "WHERE "

		--Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "
		--Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "
		--If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End
		--Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "
		--Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND "

		  If (@FromCode = '' AND @ToCode = '')      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" + @CodeID + ",'') LIKE '%' AND "      
		  End      
		  Else      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') >= '" + @FromCode + "' AND "      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') <= '" + @ToCode + "' AND "      
		  End  

		If (@FromDate = '' AND @ToDate = '')
		Begin
			Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "
			Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "
		End

		If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))
		Begin
			Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "
			Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "
		End

 /*LOGIN CONDITIONS*/      	
	
	Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "
	Set @strWhere = @strWhere + "		(CASE "
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	Set @strWhere = @strWhere + "			ELSE "
	Set @strWhere = @strWhere + "		'BROKER'"
	Set @strWhere = @strWhere + "		END)    "

/*END - LOGIN CONDITIONS*/


		Set @Comma = ''


		Set @strGroupBy = @strGroupBy + @Comma

		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))
		Begin
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code, Left(party_name, 25), client_type, Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date "
				--Set @Comma = ', '
				--If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				--If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				--If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
		End /*If (@OneOrMany = 'DETAIL')*/

		Set @strOrderBy = @strGroupBy
		Set @strGroupBy = "GROUP BY " + @strGroupBy
		Set @strOrderBy = "ORDER BY " + @strOrderBy

	End/*If (@ReportName = "NETPOSITION")*/


	Print 'ReportName : ' + @ReportName
	Print 'StatusID : ' + @StatusID
	Print 'StatusName : ' + @StatusName
	Print 'GroupLevel : ' + @GroupLevel
	Print 'GroupSubLevel : ' + @GroupSubLevel
	Print 'OrderLevel : ' + @OrderLevel
	Print 'OrderSubLevel : ' + @OrderSubLevel
	
	Print 'FromDate : ' + @FromDate
	Print 'ToDate : ' + @ToDate
	Print 'WhatCode : ' + @WhatCode
	Print 'FromCode : ' + @FromCode
	Print 'ToCode : ' + @ToCode
	
	Print 'InstType : ' + @InstType
	Print 'OptionType : ' + @OptionType
	Print 'StrikePrice : ' + Convert(VarChar,@StrikePrice)
	Print 'ExpiryDate : ' + @ExpiryDate
	Print 'Symbol : ' + @Symbol
	
	Print 'BillType : ' + @Ex_BillType
	Print 'AuctionPart : ' + @Ex_AuctionPart
	Print 'ReportBy : ' + @Ex_ReportBy
	Print 'Rate : ' + @Ex_Rate
	Print 'MoneyType : ' + @Ex_MoneyType
	Print 'Position : ' + @Ex_Position
	
	Print 'Dummy001 : ' + @WithNetPos
	Print 'Dummy002 : ' + @Dummy002 

	Print 'Dummy003 : ' + @Dummy003
	Print 'Dummy004 : ' + @Dummy004
	Print 'Dummy005 : ' + @Dummy005
	Print 'Dummy006 : ' + @Dummy006
	Print 'Dummy007 : ' + @Dummy007
	Print 'Dummy008 : ' + @Dummy008
	Print 'Dummy009 : ' + @Dummy009
	Print 'Dummy010 : ' + @Dummy010

	Print '=============================================================================================='


	If @strComputeSub <> '' 
	Begin 
		Set @strComputeSub = "BY " + @strComputeSub 
		Set @strComputeSub = @strCompute + @strComputeSub
	End

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)

	If (@IsSubLevel = 'YES')
	Begin
		---Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)
		SET @STRSQL = @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy
	End
	Else
	Begin
		--Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)
		SET @STRSQL = @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy
	End

	/*
	Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute
	Print @strSelect 
	Print @strFrom
	Print @strWhere
	Print @strGroupBy
	Print @strOrderBy
	Print @strComputeSub
	Print @strCompute
	*/


	IF object_id('tempdb.dbo.##FOBILLNEW') Is Not Null
	DROP TABLE ##FOBILLNEW

	EXEC (@STRSQL)
	
	
	CREATE TABLE #FOBILL
		(
		PARTY_CODE	VARCHAR(20),
		PARTY_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(3),
		SAUDA_DATE	VARCHAR(11),
		YY			VARCHAR(6),
		MM			VARCHAR(2),
		DD			VARCHAR(2),
		BILLAMT		NUMERIC(18,4)	
		)
		
	INSERT INTO #FOBILL
	EXEC ("SELECT * FROM ##FOBILLNEW")
	
	--SELECT * FROM #FOBILL
	--RETURN

	DECLARE @PARTYCODE 		VARCHAR(20)
	DECLARE @SAUDADATE		VARCHAR(11)
	DECLARE @PARTYWISE_CURSOR CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT PARTY_CODE FROM #FOBILL ORDER BY PARTY_CODE
	
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE ---, @SAUDADATE

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT * FROM #FOBILL
		WHERE PARTY_CODE = @PARTYCODE --AND SAUDA_DATE = @SAUDADATE
		ORDER BY 
			PARTY_CODE

		SELECT 
			SUM=SUM(BILLAMT)
		FROM 
			#FOBILL	
		WHERE 
			PARTY_CODE = @PARTYCODE
			--AND SAUDA_DATE = @SAUDADATE
		GROUP BY
			PARTY_CODE
		ORDER BY
			PARTY_CODE
				 
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE --, @SAUDADATE
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR

	IF ((SELECT COUNT(1) FROM #FOBILL)>0)
	BEGIN
		SELECT 
			SUM=SUM(BILLAMT)
		FROM 
			#FOBILL	
	END
	
	DROP TABLE #FOBILL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILL_PARENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: 24 JUL 2003 06:54:21 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: MAY 13 2003 14:01:54 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: APR 10 2003 19:14:34 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: APR 07 2003 12:32:59 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: APR 05 2003 12:17:09 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: APR 05 2003 11:41:00 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWBILL    SCRIPT DATE: APR 03 2003 12:21:07 ******/
-- SQL FOR THE NEW FO REPORT MODULE - BILL REPORT
--WRITTEN BY						:			SHYAM.
--START DATE						: 			APR 03 2003.
-------------------------------------------------------------------------------------------------------------------
--				MODIFICATION HISTORY
-------------------------------------------------------------------------------------------------------------------
--	.1	BY SHYAM ON FEB 27 2003
--	**********************************************
--	WRITE MODIFICATION SUMMARY HERE
--	**********************************************
-------------------------------------------------------------------------------------------------------------------
CREATE       PROC
[DBO].[RPT_PROC_FO_NEWBILL_PARENT]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@WITHNETPOS VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'YES'
	IF (@REPORTNAME = 'BILL')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "
		--@WHATCODE WILL ALWAYS BE 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF ((@WHATCODE = 'CLIENT') AND (@ONEORMANY = 'SUMMARY'))
		BEGIN
			SET @STRSELECTTEMP = ''
			--@GROUPLEVEL/@SUBGROUPLEVEL WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME, 25) AS PARTY_NAME, CLIENT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF (@WHATCODE = 'CLIENT')*/
		--@EX_RATE AND @EX_REPORTBY WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--AMT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((SBILLAMT - PBILLAMT) - ((SERVICE_TAX - EXSER_TAX ) + (TURN_TAX) + (SEBI_TAX) + (BROKER_NOTE) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (INS_CHRG) + (OTHER_CHRG) + (CL_CHRG-EXCL_CHRG))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* AMT */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BILLAMT "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
		--SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		--SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		--IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		--SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		--SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END  
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/

		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, LEFT(PARTY_NAME, 25), CLIENT_TYPE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "
				--SET @COMMA = ', '
				--IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				--IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				--IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @WITHNETPOS
	PRINT 'DUMMY002 : ' + @DUMMY002 
	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010
	PRINT '=============================================================================================='
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END
	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + '  HAVING SUM(SBILLAMT - PBILLAMT) <> 0  ' + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + '  HAVING SUM(SBILLAMT - PBILLAMT) <> 0  ' + @STRORDERBY + @STRCOMPUTE)
	END
	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE
	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBillDetail
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_PROC_FO_NEWBILLDETAIL]
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @FROMPARTYCODE VARCHAR(20),  
 @TOPARTYCODE VARCHAR(20),  
 @CLIENTTYPE VARCHAR (20),  
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50),  
 @DUMMY006 VARCHAR(50),  
 @DUMMY007 VARCHAR(50),  
 @DUMMY008 VARCHAR(50),  
 @DUMMY009 VARCHAR(50),  
 @DUMMY010 VARCHAR(50)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END  
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END  
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END  
IF (@FROMDATE = '' OR @TODATE = '')  
BEGIN   
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN   
END  
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')  
BEGIN   
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM FOBILLVALAN   
END   
SELECT  
 LEFT(F.PARTY_NAME, 25) AS PARTY_NAME,  
 F.PARTY_CODE,   
 F.CLIENT_TYPE,   
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP,     
 C1.RES_PHONE1,  
 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
 F.INST_TYPE,   
 F.SYMBOL,  
 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
 F.STRIKE_PRICE,   
 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
 CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,  
 CL_RATE AS CLOSINGRATE,   

	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
		       THEN CASE WHEN SUM(PQTY) > 0 
			         THEN SUM(PAMT*DENOMINATOR/NUMERATOR)/SUM(PQTY) 
			         ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(PQTY) > 0 
		       THEN SUM((PRATE*PQTY+(PBROKAMT*DENOMINATOR/NUMERATOR)))/SUM(PQTY) 
		       ELSE 0 
		  END 
	END AS PRATE,
	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
	               THEN CASE WHEN SUM(SQTY) > 0 
				 THEN SUM(SAMT*DENOMINATOR/NUMERATOR)/SUM(SQTY) 
				 ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(SQTY) > 0 
		       THEN SUM((SRATE*SQTY-(SBROKAMT*DENOMINATOR/NUMERATOR)))/SUM(SQTY)
		       ELSE 0
		  END 
	END AS SRATE,

 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,  
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,  
 CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,  
 CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,  
 SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,  
 SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG)) ) AS CLEARING_CHRG, /* CLEARING CHARGES */
 SUM(((F.SERVICE_TAX - F.EXSER_TAX)) ) AS SERVICE_TAX, /* SERVICE TAX */
 SUM(((F.SEBI_TAX)) ) AS SEBI_TAX, /* SEBI TAX */
 SUM(((F.TURN_TAX)) ) AS TURN_TAX, /* TURNOVER TAX */
 SUM(((F.BROKER_NOTE)) ) AS STAMP_DUTY, /* STAMP DUTY */
 SUM(((F.INS_CHRG)) ) AS STT, /* INS CHARGES */
 SUM(((F.OTHER_CHRG)) ) AS OTHER_CHRG, /* OTHERCHARGES */
 CASE WHEN F.TRADETYPE = 'BF' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'   
               ELSE CASE WHEN MAX(AUCTIONPART) = 'EA' AND INST_TYPE LIKE 'FUT%'   
        THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
        ELSE CASE WHEN MAX(AUCTIONPART) = 'EA' AND INST_TYPE LIKE 'OPT%'   
                                                     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
                           ELSE F.TRADETYPE   
                 END   
          END   
               END AS TRADETYPE,  
 F.TRADETYPE AS TRADETYPEPRINT  
INTO #FOBILL
FROM  
 FOBILLVALAN F (NOLOCK),   
 CLIENT1 C1 (NOLOCK),   
 CLIENT2 C2 (NOLOCK) 
WHERE  
	 C1.CL_CODE = C2.CL_CODE AND  
	 C2.PARTY_CODE = F.PARTY_CODE AND   
	 F.CLIENT_TYPE LIKE @CLIENTTYPE AND  
	 F.PARTY_CODE >= @FROMPARTYCODE AND  
	 F.PARTY_CODE <= @TOPARTYCODE AND  
	 F.SAUDA_DATE >= @FROMDATE + ' 00:00:00' AND  
	 F.SAUDA_DATE <= @TODATE + ' 23:59:59' AND  
	 F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%' THEN 'BT' ELSE '%' END ) AND  
	@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)

GROUP BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,  
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,   
 F.TRADETYPE,   
 C1.RES_PHONE1,  
 F.SAUDA_DATE,  
 C1.EMAIL,  
 CL_RATE,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP  
  
HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

ORDER BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SAUDA_DATE,  
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,   
 F.TRADETYPE  
  
/*
COMPUTE  
 SUM(CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END), /* PAMT */   
 SUM(CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END), /* SAMT */  
 SUM(SUM((F.PBILLAMT) ) - SUM((F.SBILLAMT) )),  /*DIFF = PAMT-SAMT*/  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) )), /* TOTAL OF CHARGES */  
 SUM(SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )), /* DIFF - TOTAL OF CHARGES */  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG)) )), /* TOTAL OF CLEARING CHARGES */  
 SUM(SUM(((F.SERVICE_TAX - F.EXSER_TAX)) )), /* TOTAL OF SERVICE TAX */  
 SUM(SUM(((F.SEBI_TAX)) )), /* TOTAL OF SEBI TAX */  
 SUM(SUM(((F.TURN_TAX)) )), /* TOTAL OF TURNOVER TAX */  
 SUM(SUM(((F.BROKER_NOTE)) )), /* TOTAL OF STAMP DUTY */  
 SUM(SUM(((F.INS_CHRG)) )), /* TOTAL OF INS CHARGES */  
 SUM(SUM(((F.OTHER_CHRG)) )) /* TOTAL OF OTHERCHARGES */  
 BY F.PARTY_CODE   
*/

	DECLARE @PARTYCODE 		VARCHAR(20)
	DECLARE @SAUDADATE		VARCHAR(11)
	DECLARE @PARTYWISE_CURSOR CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT PARTY_CODE, SAUDADATE=(CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END) FROM #FOBILL ORDER BY PARTY_CODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE, @SAUDADATE

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT * FROM #FOBILL
		WHERE PARTY_CODE = @PARTYCODE AND SAUDADATE = (CASE WHEN @DUMMY001 = 1 THEN @SAUDADATE ELSE SAUDADATE END) 	
		ORDER BY 
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END,
			PARTY_CODE

		SELECT 
			SUM=SUM(PBILLAMT),
			SUM=SUM(SBILLAMT),
			SUM=SUM(DIFF),
			SUM=SUM(CHRG_TOTAL),
			SUM=SUM(FINALFIGURE),
			SUM=SUM(CLEARING_CHRG),
			SUM=SUM(SERVICE_TAX),
			SUM=SUM(SEBI_TAX),
			SUM=SUM(TURN_TAX),
			SUM=SUM(STAMP_DUTY),
			SUM=SUM(STT),
			SUM=SUM(OTHER_CHRG),
			PARTY_CODE
		FROM 
			#FOBILL	
		WHERE 
			PARTY_CODE = @PARTYCODE
			AND SAUDADATE = (CASE WHEN @DUMMY001 = 1 THEN @SAUDADATE ELSE SAUDADATE END)	
		GROUP BY
			PARTY_CODE,
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END
		ORDER BY
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END,
			PARTY_CODE
				 
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE, @SAUDADATE
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR
	
	DROP TABLE #FOBILL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewBillDetail_New
-- --------------------------------------------------



CREATE  PROC [dbo].[RPT_PROC_FO_NEWBILLDETAIL_NEW]
 (	
 @StatusID VarChar(20),    
 @StatusName VarChar(50),  
 @FromDate VarChar(11),  
 @ToDate VarChar(11),  
 @FromPartyCode VarChar(20),  
 @ToPartyCode VarChar(20),  
 @ClientType VarChar (20),  
 @Dummy001 VarChar(50),    
 @Dummy002 VarChar(50),    
 @Dummy003 VarChar(50),    
 @Dummy004 VarChar(50),    
 @Dummy005 VarChar(50),    
 @Dummy006 VarChar(50),    
 @Dummy007 VarChar(50),    
 @Dummy008 VarChar(50),    
 @Dummy009 VarChar(50),    
 @Dummy010 VarChar(50)    
 )
  
AS    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
If @ClientType = '' Begin Set @ClientType = '%' End    
If @FromPartyCode = '' Begin Set @FromPartyCode = '%' End    
If @ToPartyCode = '' Begin Set @ToPartyCode = '%' End    
    
If (@FromDate = '' OR @ToDate = '')    
Begin     
 Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From FoBillValan     
  
End    
    
If (@FromPartyCode = '' OR @ToPartyCode = '' OR @FromPartyCode = '%' OR @ToPartyCode = '%')    
Begin     
 Select @FromPartyCode = Min(party_code), @ToPartyCode = Max(party_code) From FoBillValan     
End     
    
Declare @PartyCount varchar (10)  
Select  
 Top 1 @PartyCount = Party_Code   
From  
 Tbl_MTomPremiumBill_Report   
Where  
 BillDate LIKE @FromDate +'%'  
  
CREATE TABLE #FOBILL
	(
	PARTY_NAME	VARCHAR(100),
	PARTY_CODE	VARCHAR(20),
	CL_TYPE		VARCHAR(5),       
	L_ADDRESS1	VARCHAR(100),
	L_ADDRESS2	VARCHAR(100),
	L_ADDRESS3	VARCHAR(100),
	L_CITY		VARCHAR(100),
	L_STATE		VARCHAR(100),
	L_NATION	VARCHAR(50),
	L_ZIP		VARCHAR(50),
	RES_PHONE1	VARCHAR(100),
	EMAIL		VARCHAR(100),
	INST_TYPE	VARCHAR(6),
	SYMBOL		VARCHAR(30),
	EXPIRYDATE	VARCHAR(11),
	STRIKE_PRICE NUMERIC(18,4),
	OPTION_TYPE	VARCHAR(5),
	SAUDADATE	VARCHAR(11),
	CLOSINGRATE	NUMERIC(18,4),
	PRATE		NUMERIC(18,4),
	SRATE		NUMERIC(18,4),
	PQTY		INT,      
	SQTY		INT,
	SBILLAMT	NUMERIC(20,4),
	PBILLAMT	NUMERIC(20,4),
	DIFF		NUMERIC(20,4),
	CHRG_TOTAL	NUMERIC(20,4),
	FINALFIGURE	NUMERIC(20,4),
	CLCHRG		NUMERIC(20,4),
	SERVICE_TAX	NUMERIC(20,4),
	SEBI_TAX	NUMERIC(20,4),
	TURN_TAX	NUMERIC(20,4),
	STAMPDUTY	NUMERIC(20,4),
	INSURANCE_CHRG	NUMERIC(20,4),
	OTHER_CHRG	NUMERIC(20,4),
	TRADETYPE	VARCHAR(100),
	tradetypeprint	VARCHAR(100)
	)
if @PartyCount <> ''  
 BEGIN  
  INSERT INTO #FOBILL
  SELECT    
   Left(C1.Long_name, 25) AS party_name,    
   f.party_code,     
   C1.cl_type,     
   c1.l_address1,     
   c1.l_address2,    
   c1.l_address3,    
   c1.L_city,   
   c1.L_State,   
   c1.L_Nation,   
   c1.L_Zip,   
   c1.res_phone1,    
   Case When Len(c1.email) = 0 Then '_' Else c1.email End AS email,    
   f.inst_type,     
   f.symbol,    
   Convert(VarChar, f.expirydate, 103) AS expirydate,    
   f.strike_price,     
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,    
   Convert(VarChar, f.billdate, 103) AS saudadate,    
   f.Cl_Rate AS ClosingRate,    
    
   /*Case When Sum(pqty)-Sum(Sqty) > 0 Then (Netwithbrok) Else 0 End AS prate,    
   Case When Sum(pqty)-Sum(Sqty) < 0 Then (Netwithbrok) Else 0 End AS srate,  */  
    
  Case When Sum(pqty)-Sum(Sqty) > 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) / Sum(pqty+Sqty) Else 0 End AS prate,      
  Case When Sum(pqty)-Sum(Sqty) < 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) / Sum(pqty+Sqty) Else 0 End AS srate,      
    
    
    
   (Case When Sum(pqty)-Sum(Sqty) > 0 Then Sum(pqty)-Sum(Sqty) Else 0 End) AS pqty,    
   (Case When Sum(pqty)-Sum(Sqty) < 0 Then Abs(Sum(pqty)-Sum(Sqty)) Else 0 End) AS sqty,    
    
  Case When bfdayflag = 'B-F' then  
   Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) > 0   
         Then   abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
   Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) > 0   
         Then   abs(sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
   AS sbillamt ,  
    
  Case When bfdayflag = 'B-F' then  
    Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) < 0   
         Then  abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
    Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) < 0   
         Then  abs( sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
   AS pbillamt,    
    
   Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) - sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok)))  AS diff,    
    
   Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg) AS chrg_total,    
    
   Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -  Sum((((SQty-PQty)*(NetRate-f.Cl_Rate)*Numerator/Denominator)-(Brok)) ) AS finalfigure,      
    
     0 clchrg, /* CLEARING CHARGES */    
     Sum(Service_Tax), /* SERVICE TAX */    
     Sum(f.sebi_tax), /* SEBI TAX */    
     Sum(f.turn_tax), /* TURNOVER TAX */    
     Sum(f.stampduty), /* STAMP DUTY */    
     Sum(f.insurance_chrg), /* INS CHARGES */    
     Sum(f.other_chrg), /* OTHERCHARGES */    
      
   Case When f.bfdayflag = 'B-F' Then '<FONT Style="COLOR: #ff0000;">' + f.bfdayflag + '</FONT>'     
                 Else Case When AuctionPart = 'EA' And f.Inst_Type Like 'FUT%'     
                                    Then '<FONT Style="COLOR:BLUE;">' + 'FF'  + '</FONT>'     
          Else Case When AuctionPart = 'EA' And f.Inst_Type Like 'OPT%'     
                                           Then '<FONT Style="COLOR:GREEN;">' + 'EA'  + '</FONT>'     
                             Else f.bfdayflag     
                  End     
                                    End     
                 End AS tradetype,    
   f.bfdayflag AS tradetypeprint   
    
   FROM    
   tbl_mtompremiumbill_report F (nolock),     
   client1 c1 (nolock),     
   client2 c2 (nolock)  
    
      
  WHERE    
   c1.cl_code = c2.cl_code AND    
   c2.party_code = f.party_code AND    f.party_code >= @FromPartyCode AND    
   f.party_code <= @ToPartyCode AND    
   f.billdate >= @FromDate + ' 00:00:00' AND    
   f.billdate <= @ToDate + ' 23:59:59' AND   
  @statusName = (case  when @Statusid = 'branch' then isnull(c1.branch_cd,'')  
      when @Statusid = 'subbroker' then isnull(c1.sub_broker,'')  
      when @Statusid = 'trader' then isnull(c1.trader,'')  
      when @Statusid = 'family' then isnull(c1.Family,'')  
      when @Statusid = 'area' then isnull(c1.area,'')  
      when @Statusid = 'region' then isnull(c1.region,'')  
      when @Statusid = 'client' then isnull(c2.party_code,'')  
      when @Statusid = 'broker' then @statusname  
     end)  
    
  Group By    
   f.party_code,     
   c1.long_name,     
   c1.cl_type,     
   f.symbol,     
   f.inst_type,     
   f.expirydate,     
   f.strike_price,     
   f.option_type,     
   f.bfdayflag,     
   f.billdate,   
   C1.Email,   
   F.AuctionPart,   
   C1.L_Address1,   
   C1.L_Address2,   
   C1.L_Address3,   
   c1.L_city,   
   c1.L_State,   
   c1.L_Nation,   
   c1.L_Zip,   
   C1.Res_Phone1,   
   Cl_Rate,   
   Case When f.bfdayflag <> 'B-F' then PQty else '' end,  
   Case When f.bfdayflag <> 'B-F' then sQty else '' end,  
   Case When f.bfdayflag <> 'B-F' then Netwithbrok else 0 end    
    
  Having Case When  bfdayflag = 'B-F' Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))  Else 1 End <> 0  
    
  OR  
  Case When  bfdayflag = 'B-F' Then Sum(SQty-PQty)  Else 1 End <> 0  
        
  ORDER BY     
   Case When @Dummy001 = 1 Then f.billdate Else '' End,  
   f.party_code,     
   c1.long_name,     
   c1.cl_type,     
   f.symbol,     
   f.inst_type,     
   f.expirydate,     
   f.strike_price,     
   f.option_type,     
   f.bfdayflag DESC,     
   Case When @Dummy001 = 0 Then f.billdate Else '' End  
   /* 
  COMPUTE    
  Sum(  
  Case When bfdayflag = 'B-F' then  
   Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) > 0   
         Then   abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
   Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) > 0   
         Then   abs(sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
  ),  
  Sum(  
  Case When bfdayflag = 'B-F' then  
    Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) < 0   
         Then  abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
    Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) < 0   
         Then  abs( sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
  ),  
    
  Sum( Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) - sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))) ),   
    
  Sum(Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)),   
    
   Sum( Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -  Sum((((SQty-PQty)*(NetRate-f.Cl_Rate)*Numerator/Denominator)-(Brok)) )), /* DIFF - TOTAL OF CHARGES */    
    
   Sum(0), /* TOTAL OF CLEARING CHARGES */    
   Sum(Sum(Service_Tax)), /* TOTAL OF SERVICE TAX */    
   Sum(Sum(f.sebi_tax)), /* TOTAL OF SEBI TAX */    
   Sum(Sum(f.turn_tax)), /* TOTAL OF TURNOVER TAX */    
   Sum(Sum(f.stampduty)), /* TOTAL OF STAMP DUTY */    
   Sum(Sum(f.insurance_chrg)),/* TOTAL OF INS CHARGES */    
   Sum(Sum(f.Other_Chrg)) /* TOTAL OF OTHERCHARGES */     
    
   BY   
   Case When @Dummy001 = 1 Then f.billdate Else '' End,  
   f.party_code
   */     
 END  
ELSE  
 BEGIN  
  INSERT INTO #FOBILL
  SELECT    
   Left(C1.Long_name, 25) AS party_name,    
   f.party_code,     
   C1.cl_type,     
   c1.l_address1,     
   c1.l_address2,    
   c1.l_address3,    
   c1.L_city,   
   c1.L_State,   
   c1.L_Nation,   
   c1.L_Zip,   
   c1.res_phone1,    
   Case When Len(c1.email) = 0 Then '_' Else c1.email End AS email,    
   f.inst_type,     
   f.symbol,    
   Convert(VarChar, f.expirydate, 103) AS expirydate,    
   f.strike_price,     
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,    
   Convert(VarChar, f.billdate, 103) AS saudadate,    
   f.Cl_Rate AS ClosingRate,    
    
   /*Case When Sum(pqty)-Sum(Sqty) > 0 Then (Netwithbrok) Else 0 End AS prate,    
   Case When Sum(pqty)-Sum(Sqty) < 0 Then (Netwithbrok) Else 0 End AS srate,  */  
    
  Case When Sum(pqty)-Sum(Sqty) > 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) / Sum(pqty+Sqty) Else 0 End AS prate,      
  Case When Sum(pqty)-Sum(Sqty) < 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) / Sum(pqty+Sqty) Else 0 End AS srate,      
    
    
    
   (Case When Sum(pqty)-Sum(Sqty) > 0 Then Sum(pqty)-Sum(Sqty) Else 0 End) AS pqty,    
   (Case When Sum(pqty)-Sum(Sqty) < 0 Then Abs(Sum(pqty)-Sum(Sqty)) Else 0 End) AS sqty,    
    
  Case When bfdayflag = 'B-F' then  
   Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) > 0   
         Then   abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
   Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) > 0   
         Then   abs(sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
   AS sbillamt ,  
    
  Case When bfdayflag = 'B-F' then  
    Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok)))< 0   
         Then  abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
    Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) < 0   
         Then  abs( sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
   AS pbillamt,    
    
   Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) - sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  AS diff,    
    
   Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg) AS chrg_total,    
    
   Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -  Sum((((SQty-PQty)*(NetRate-f.Cl_Rate)*Numerator/Denominator)-(Brok)) ) AS finalfigure,      
    
     0 clchrg, /* CLEARING CHARGES */    
     Sum(Service_Tax), /* SERVICE TAX */    
     Sum(f.sebi_tax), /* SEBI TAX */    
     Sum(f.turn_tax), /* TURNOVER TAX */    
     Sum(f.stampduty), /* STAMP DUTY */    
     Sum(f.insurance_chrg), /* INS CHARGES */    
     Sum(f.other_chrg), /* OTHERCHARGES */    
      
   Case When f.bfdayflag = 'B-F' Then '<FONT Style="COLOR: #ff0000;">' + f.bfdayflag + '</FONT>'     
                 Else Case When AuctionPart = 'EA' And f.Inst_Type Like 'FUT%'     
                                    Then '<FONT Style="COLOR:BLUE;">' + 'FF'  + '</FONT>'     
          Else Case When AuctionPart = 'EA' And f.Inst_Type Like 'OPT%'     
                                           Then '<FONT Style="COLOR:GREEN;">' + 'EA'  + '</FONT>'     
                             Else f.bfdayflag     
                  End     
                                    End     
                 End AS tradetype,    
   f.bfdayflag AS tradetypeprint   
    
   FROM    
   tbl_mtompremiumbill F (nolock),     
   client1 c1 (nolock),     
   client2 c2 (nolock)  
    
      
  WHERE    
   c1.cl_code = c2.cl_code AND    
   c2.party_code = f.party_code AND    f.party_code >= @FromPartyCode AND    
   f.party_code <= @ToPartyCode AND    
   f.billdate >= @FromDate + ' 00:00:00' AND    
   f.billdate <= @ToDate + ' 23:59:59' AND   
  @statusName = (case  when @Statusid = 'branch' then isnull(c1.branch_cd,'')  
      when @Statusid = 'subbroker' then isnull(c1.sub_broker,'')  
      when @Statusid = 'trader' then isnull(c1.trader,'')  
      when @Statusid = 'family' then isnull(c1.Family,'')  
      when @Statusid = 'area' then isnull(c1.area,'')  
      when @Statusid = 'region' then isnull(c1.region,'')  
      when @Statusid = 'client' then isnull(c2.party_code,'')  
      when @Statusid = 'broker' then @statusname  
     end)  
    
  Group By    
   f.party_code,     
   c1.long_name,     
   c1.cl_type,     
   f.symbol,     
   f.inst_type,     
   f.expirydate,     
   f.strike_price,     
   f.option_type,     
   f.bfdayflag,     
   f.billdate,   
   C1.Email,   
   F.AuctionPart,   
   C1.L_Address1,   
   C1.L_Address2,   
   C1.L_Address3,   
   c1.L_city,   
   c1.L_State,   
   c1.L_Nation,   
   c1.L_Zip,   
   C1.Res_Phone1,   
   Cl_Rate,   
   Case When f.bfdayflag <> 'B-F' then PQty else '' end,  
   Case When f.bfdayflag <> 'B-F' then sQty else '' end,  
   Case When f.bfdayflag <> 'B-F' then Netwithbrok else 0 end    
    
  Having Case When  bfdayflag = 'B-F' Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))  Else 1 End <> 0  
    
  OR  
  Case When  bfdayflag = 'B-F' Then Sum(SQty-PQty)  Else 1 End <> 0  
        
  ORDER BY     
   Case When @Dummy001 = 1 Then f.billdate Else '' End,  
   f.party_code,     
   c1.long_name,     
   c1.cl_type,     
   f.symbol,     
   f.inst_type,     
   f.expirydate,     
   f.strike_price,     
   f.option_type,     
   f.bfdayflag DESC,     
   Case When @Dummy001 = 0 Then f.billdate Else '' End  
  /*  
  COMPUTE    
  Sum(  
  Case When bfdayflag = 'B-F' then  
   Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) > 0   
         Then   abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
   Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) > 0   
         Then   abs(sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
  ),  
  Sum(  
  Case When bfdayflag = 'B-F' then  
    Case When sum((((SQty-PQty)*(NetRate-f.CL_Rate) *Numerator/Denominator)-(Brok))) < 0   
         Then  abs(Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))))  
         Else 0   
    End    
  else  
    Case When sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)) < 0   
         Then  abs( sum(((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok)))  
         Else 0   
    End    
  end  
  ),  
    
  Sum( Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) - sum((((SQty-PQty)*(NetRate-f.CL_Rate)*Numerator/Denominator) -(Brok))) ),   
    
  Sum(Sum(Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)),   
    
   Sum( Sum ((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -  Sum((((SQty-PQty)*(NetRate-f.Cl_Rate)*Numerator/Denominator)-(Brok)) )), /* DIFF - TOTAL OF CHARGES */    
    
   Sum(0), /* TOTAL OF CLEARING CHARGES */    
   Sum(Sum(Service_Tax)), /* TOTAL OF SERVICE TAX */    
   Sum(Sum(f.sebi_tax)), /* TOTAL OF SEBI TAX */    
   Sum(Sum(f.turn_tax)), /* TOTAL OF TURNOVER TAX */    
   Sum(Sum(f.stampduty)), /* TOTAL OF STAMP DUTY */    
   Sum(Sum(f.insurance_chrg)),/* TOTAL OF INS CHARGES */    
   Sum(Sum(f.Other_Chrg)) /* TOTAL OF OTHERCHARGES */     
    
   BY   
   Case When @Dummy001 = 1 Then f.billdate Else '' End,  
   f.party_code
   */     
 END  
  
  
	DECLARE @PARTYCODE 		VARCHAR(20)
	DECLARE @SAUDADATE		VARCHAR(11)
	DECLARE @PARTYWISE_CURSOR CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT PARTY_CODE, SAUDADATE=(CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END) FROM #FOBILL ORDER BY PARTY_CODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE, @SAUDADATE

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT * FROM #FOBILL
		WHERE PARTY_CODE = @PARTYCODE AND SAUDADATE = (CASE WHEN @DUMMY001 = 1 THEN @SAUDADATE ELSE SAUDADATE END) 	
		ORDER BY 
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END,
			PARTY_CODE

		SELECT 
			SUM=SUM(PBILLAMT),
			SUM=SUM(SBILLAMT),
			SUM=SUM(DIFF),
			SUM=SUM(CHRG_TOTAL),
			SUM=SUM(FINALFIGURE),
			SUM=SUM(CLCHRG),
			SUM=SUM(SERVICE_TAX),
			SUM=SUM(SEBI_TAX),
			SUM=SUM(TURN_TAX),
			SUM=SUM(STAMPDUTY),
			SUM=SUM(INSURANCE_CHRG),
			SUM=SUM(OTHER_CHRG),
			PARTY_CODE,
			SAUDADATE=CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END
		FROM 
			#FOBILL	
		WHERE 
			PARTY_CODE = @PARTYCODE
			AND SAUDADATE = (CASE WHEN @DUMMY001 = 1 THEN @SAUDADATE ELSE SAUDADATE END)	
		GROUP BY
			PARTY_CODE,
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END
		ORDER BY
			CASE WHEN @DUMMY001 = 1 THEN SAUDADATE ELSE '' END,
			PARTY_CODE
				 
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @PARTYCODE, @SAUDADATE
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR
	
	DROP TABLE #FOBILL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL_NEW_PARENT
-- --------------------------------------------------
CREATE    PROC  
[DBO].[RPT_PROC_FO_NEWBILLDETAIL_NEW_PARENT]
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),
 @FROMPARTYCODE VARCHAR(20),  
 @TOPARTYCODE VARCHAR(20),
 @CLIENTTYPE VARCHAR (20),  
  
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50),  
 @DUMMY006 VARCHAR(50),  
 @DUMMY007 VARCHAR(50),  
 @DUMMY008 VARCHAR(50),  
 @DUMMY009 VARCHAR(50),  
 @DUMMY010 VARCHAR(50)  
AS  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END  
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END  
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END  
  
IF (@FROMDATE = '' OR @TODATE = '')  
BEGIN   
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT   

END  
  
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')  
BEGIN   
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM FOBILLVALAN_PARENT   
END   
  
DECLARE @PARTYCOUNT VARCHAR (10)
SELECT
	TOP 1 @PARTYCOUNT = PARTY_CODE 
FROM
	TBL_MTOMPREMIUMBILL_REPORT 
WHERE
	BILLDATE LIKE @FROMDATE +'%'

IF @PARTYCOUNT <> ''
	BEGIN
		SELECT  
		 LEFT(C1.LONG_NAME, 25) AS PARTY_NAME,  
		 F.PARTY_CODE,   
		 C1.CL_TYPE,   
		 C1.L_ADDRESS1,   
		 C1.L_ADDRESS2,  
		 C1.L_ADDRESS3,  
		 C1.L_CITY, 
		 C1.L_STATE, 
		 C1.L_NATION, 
		 C1.L_ZIP, 
		 C1.RES_PHONE1,  
		 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
		 F.INST_TYPE,   
		 F.SYMBOL,  
		 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
		 F.STRIKE_PRICE,   
		 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
		 CONVERT(VARCHAR, F.BILLDATE, 103) AS SAUDADATE,  
		 F.CL_RATE AS CLOSINGRATE,  
		
		 /*CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN (NETWITHBROK) ELSE 0 END AS PRATE,  
		 CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN (NETWITHBROK) ELSE 0 END AS SRATE,  */
		
		CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) / SUM(PQTY+SQTY) ELSE 0 END AS PRATE,    
		CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) / SUM(PQTY+SQTY) ELSE 0 END AS SRATE,    
		
		
		
		 (CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(PQTY)-SUM(SQTY) ELSE 0 END) AS PQTY,  
		 (CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN ABS(SUM(PQTY)-SUM(SQTY)) ELSE 0 END) AS SQTY,  
		
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		 AS SBILLAMT ,
		
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS( SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		 AS PBILLAMT,  
		
		 SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR)  AS DIFF,  
		
		 SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG) AS CHRG_TOTAL,  
		
		 SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -  SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) *NUMERATOR/DENOMINATOR) AS FINALFIGURE,    
		
		   0 CLCHRG, /* CLEARING CHARGES */  
		   SUM(SERVICE_TAX), /* SERVICE TAX */  
		   SUM(F.SEBI_TAX), /* SEBI TAX */  
		   SUM(F.TURN_TAX), /* TURNOVER TAX */  
		   SUM(F.STAMPDUTY), /* STAMP DUTY */  
		   SUM(F.INSURANCE_CHRG), /* INS CHARGES */  
		   SUM(F.OTHER_CHRG), /* OTHERCHARGES */  
		  
		 CASE WHEN F.BFDAYFLAG = 'B-F' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.BFDAYFLAG + '</FONT>'   
		               ELSE CASE WHEN AUCTIONPART = 'EA' AND F.INST_TYPE LIKE 'FUT%'   
		                                  THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
		        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.INST_TYPE LIKE 'OPT%'   
		                                         THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
		                           ELSE F.BFDAYFLAG   
		                END   
		                                  END   
		               END AS TRADETYPE,  
		 F.BFDAYFLAG AS TRADETYPEPRINT 
		
		 FROM  
		 TBL_MTOMPREMIUMBILL_REPORT F (NOLOCK),   
		 CLIENT1 C1 (NOLOCK),   
		 CLIENT2 C2 (NOLOCK)
		
		  
		WHERE  
		 C1.CL_CODE = C2.CL_CODE AND  
		 C2.PARTY_CODE = F.PARTY_CODE AND    F.PARTY_CODE >= @FROMPARTYCODE AND  
		 F.PARTY_CODE <= @TOPARTYCODE AND  
		 F.BILLDATE >= @FROMDATE + ' 00:00:00' AND  
		 F.BILLDATE <= @TODATE + ' 23:59:59' AND 
		@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(C1.BRANCH_CD,'')
						WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(C1.SUB_BROKER,'')
						WHEN @STATUSID = 'TRADER' THEN ISNULL(C1.TRADER,'')
						WHEN @STATUSID = 'FAMILY' THEN ISNULL(C1.FAMILY,'')
						WHEN @STATUSID = 'AREA' THEN ISNULL(C1.AREA,'')
						WHEN @STATUSID = 'REGION' THEN ISNULL(C1.REGION,'')
						WHEN @STATUSID = 'CLIENT' THEN ISNULL(C2.PARTY_CODE,'')
						WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
					END)
		
		GROUP BY  
		 F.PARTY_CODE,   
		 C1.LONG_NAME,   
		 C1.CL_TYPE,   
		 F.SYMBOL,   
		 F.INST_TYPE,   
		 F.EXPIRYDATE,   
		 F.STRIKE_PRICE,   
		 F.OPTION_TYPE,   
		 F.BFDAYFLAG,   
		 F.BILLDATE, 
		 C1.EMAIL, 
		 F.AUCTIONPART, 
		 C1.L_ADDRESS1, 
		 C1.L_ADDRESS2, 
		 C1.L_ADDRESS3, 
		 C1.L_CITY, 
		 C1.L_STATE, 
		 C1.L_NATION, 
		 C1.L_ZIP, 
		 C1.RES_PHONE1, 
		 CL_RATE, 
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN PQTY ELSE '' END,
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN SQTY ELSE '' END,
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN NETWITHBROK ELSE 0 END  
		
		
		HAVING CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))  ELSE 1 END <> 0
		
		OR
		CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM(SQTY-PQTY)  ELSE 1 END <> 0
		    
		ORDER BY   
 		 CASE WHEN @DUMMY001 = 1 THEN F.BILLDATE ELSE '' END,
		 F.PARTY_CODE,   
		 C1.LONG_NAME,   
		 C1.CL_TYPE,   
		 F.SYMBOL,   
		 F.INST_TYPE,   
		 F.EXPIRYDATE,   
		 F.STRIKE_PRICE,   
		 F.OPTION_TYPE,   
		 F.BFDAYFLAG DESC,   
		 CASE WHEN @DUMMY001 = 0 THEN F.BILLDATE ELSE '' END
		
		COMPUTE  
		SUM(
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		),
		SUM(
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS( SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		),
		
		SUM( SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) ), 
		
		SUM(SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)), 
		
		 SUM( SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -  SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) *NUMERATOR/DENOMINATOR)), /* DIFF - TOTAL OF CHARGES */  
		
		 SUM(0), /* TOTAL OF CLEARING CHARGES */  
		 SUM(SUM(SERVICE_TAX)), /* TOTAL OF SERVICE TAX */  
		 SUM(SUM(F.SEBI_TAX)), /* TOTAL OF SEBI TAX */  
		 SUM(SUM(F.TURN_TAX)), /* TOTAL OF TURNOVER TAX */  
		 SUM(SUM(F.STAMPDUTY)), /* TOTAL OF STAMP DUTY */  
		 SUM(SUM(F.INSURANCE_CHRG)),/* TOTAL OF INS CHARGES */  
		 SUM(SUM(F.OTHER_CHRG)) /* TOTAL OF OTHERCHARGES */   
		
		 BY 
		 CASE WHEN @DUMMY001 = 1 THEN F.BILLDATE ELSE '' END,
		 F.PARTY_CODE   
		
		END
ELSE
	BEGIN
		SELECT  
		 LEFT(C1.LONG_NAME, 25) AS PARTY_NAME,  
		 F.PARTY_CODE,   
		 C1.CL_TYPE,   
		 C1.L_ADDRESS1,   
		 C1.L_ADDRESS2,  
		 C1.L_ADDRESS3,  
		 C1.L_CITY, 
		 C1.L_STATE, 
		 C1.L_NATION, 
		 C1.L_ZIP, 
		 C1.RES_PHONE1,  
		 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
		 F.INST_TYPE,   
		 F.SYMBOL,  
		 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
		 F.STRIKE_PRICE,   
		 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
		 CONVERT(VARCHAR, F.BILLDATE, 103) AS SAUDADATE,  
		 F.CL_RATE AS CLOSINGRATE,  
		
		 /*CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN (NETWITHBROK) ELSE 0 END AS PRATE,  
		 CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN (NETWITHBROK) ELSE 0 END AS SRATE,  */
		
		CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) / SUM(PQTY+SQTY) ELSE 0 END AS PRATE,    
		CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) / SUM(PQTY+SQTY) ELSE 0 END AS SRATE,    
		
		
		
		 (CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(PQTY)-SUM(SQTY) ELSE 0 END) AS PQTY,  
		 (CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN ABS(SUM(PQTY)-SUM(SQTY)) ELSE 0 END) AS SQTY,  
		
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		 AS SBILLAMT ,
		
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS( SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		 AS PBILLAMT,  
		
		 SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR)  AS DIFF,  
		
		 SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG) AS CHRG_TOTAL,  
		
		 SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -  SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) *NUMERATOR/DENOMINATOR) AS FINALFIGURE,    
		
		   0 CLCHRG, /* CLEARING CHARGES */  
		   SUM(SERVICE_TAX), /* SERVICE TAX */  
		   SUM(F.SEBI_TAX), /* SEBI TAX */  
		   SUM(F.TURN_TAX), /* TURNOVER TAX */  
		   SUM(F.STAMPDUTY), /* STAMP DUTY */  
		   SUM(F.INSURANCE_CHRG), /* INS CHARGES */  
		   SUM(F.OTHER_CHRG), /* OTHERCHARGES */  
		  
		 CASE WHEN F.BFDAYFLAG = 'B-F' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.BFDAYFLAG + '</FONT>'   
		               ELSE CASE WHEN AUCTIONPART = 'EA' AND F.INST_TYPE LIKE 'FUT%'   
		                                  THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
		        ELSE CASE WHEN AUCTIONPART = 'EA' AND F.INST_TYPE LIKE 'OPT%'   
		                                         THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
		                           ELSE F.BFDAYFLAG   
		                END   
		                                  END   
		               END AS TRADETYPE,  
		 F.BFDAYFLAG AS TRADETYPEPRINT 
		
		 FROM  
		 TBL_MTOMPREMIUMBILL F (NOLOCK),   
		 CLIENT1 C1 (NOLOCK),   
		 CLIENT2 C2 (NOLOCK)
		
		  
		WHERE  
		 C1.CL_CODE = C2.CL_CODE AND  
		 C2.PARTY_CODE = F.PARTY_CODE AND    F.PARTY_CODE >= @FROMPARTYCODE AND  
		 F.PARTY_CODE <= @TOPARTYCODE AND  
		 F.BILLDATE >= @FROMDATE + ' 00:00:00' AND  
		 F.BILLDATE <= @TODATE + ' 23:59:59' AND 
		@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(C1.BRANCH_CD,'')
						WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(C1.SUB_BROKER,'')
						WHEN @STATUSID = 'TRADER' THEN ISNULL(C1.TRADER,'')
						WHEN @STATUSID = 'FAMILY' THEN ISNULL(C1.FAMILY,'')
						WHEN @STATUSID = 'AREA' THEN ISNULL(C1.AREA,'')
						WHEN @STATUSID = 'REGION' THEN ISNULL(C1.REGION,'')
						WHEN @STATUSID = 'CLIENT' THEN ISNULL(C2.PARTY_CODE,'')
						WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
					END)
		
		GROUP BY  
		 F.PARTY_CODE,   
		 C1.LONG_NAME,   
		 C1.CL_TYPE,   
		 F.SYMBOL,   
		 F.INST_TYPE,   
		 F.EXPIRYDATE,   
		 F.STRIKE_PRICE,   
		 F.OPTION_TYPE,   
		 F.BFDAYFLAG,   
		 F.BILLDATE, 
		 C1.EMAIL, 
		 F.AUCTIONPART, 
		 C1.L_ADDRESS1, 
		 C1.L_ADDRESS2, 
		 C1.L_ADDRESS3, 
		 C1.L_CITY, 
		 C1.L_STATE, 
		 C1.L_NATION, 
		 C1.L_ZIP, 
		 C1.RES_PHONE1, 
		 CL_RATE, 
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN PQTY ELSE '' END,
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN SQTY ELSE '' END,
		 CASE WHEN F.BFDAYFLAG <> 'B-F' THEN NETWITHBROK ELSE 0 END  
		
		
		HAVING CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))  ELSE 1 END <> 0
		
		OR
		CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM(SQTY-PQTY)  ELSE 1 END <> 0
		    
		ORDER BY   
		 CASE WHEN @DUMMY001 = 1 THEN F.BILLDATE ELSE '' END,
		 F.PARTY_CODE,   
		 C1.LONG_NAME,   
		 C1.CL_TYPE,   
		 F.SYMBOL,   
		 F.INST_TYPE,   
		 F.EXPIRYDATE,   
		 F.STRIKE_PRICE,   
		 F.OPTION_TYPE,   
		 F.BFDAYFLAG DESC,   
		 CASE WHEN @DUMMY001 = 0 THEN F.BILLDATE ELSE '' END   
		
		COMPUTE  
		SUM(
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) > 0 
			      THEN   ABS(SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		),
		SUM(
		CASE WHEN BFDAYFLAG = 'B-F' THEN
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS(SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		ELSE
			 CASE WHEN SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) < 0 
			      THEN  ABS( SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR))
			      ELSE 0 
			 END  
		END
		),
		
		SUM( SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) - SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE) -(BROK))*NUMERATOR/DENOMINATOR) ), 
		
		SUM(SUM(SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)), 
		
		 SUM( SUM ((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -  SUM(((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) *NUMERATOR/DENOMINATOR)), /* DIFF - TOTAL OF CHARGES */  
		
		 SUM(0), /* TOTAL OF CLEARING CHARGES */  
		 SUM(SUM(SERVICE_TAX)), /* TOTAL OF SERVICE TAX */  
		 SUM(SUM(F.SEBI_TAX)), /* TOTAL OF SEBI TAX */  
		 SUM(SUM(F.TURN_TAX)), /* TOTAL OF TURNOVER TAX */  
		 SUM(SUM(F.STAMPDUTY)), /* TOTAL OF STAMP DUTY */  
		 SUM(SUM(F.INSURANCE_CHRG)),/* TOTAL OF INS CHARGES */  
		 SUM(SUM(F.OTHER_CHRG)) /* TOTAL OF OTHERCHARGES */   
		
		 BY 
		 CASE WHEN @DUMMY001 = 1 THEN F.BILLDATE ELSE '' END,
		 F.PARTY_CODE
		
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL_PARENT
-- --------------------------------------------------
CREATE     PROC  
[DBO].[RPT_PROC_FO_NEWBILLDETAIL_PARENT]  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @FROMPARTYCODE VARCHAR(20),  
 @TOPARTYCODE VARCHAR(20),  
 @CLIENTTYPE VARCHAR (20),  
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50),  
 @DUMMY006 VARCHAR(50),  
 @DUMMY007 VARCHAR(50),  
 @DUMMY008 VARCHAR(50),  
 @DUMMY009 VARCHAR(50),  
 @DUMMY010 VARCHAR(50)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END  
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END  
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END  
IF (@FROMDATE = '' OR @TODATE = '')  
BEGIN   
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT   
END  
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')  
BEGIN   
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM FOBILLVALAN_PARENT   
END   
SELECT  
 LEFT(F.PARTY_NAME, 25) AS PARTY_NAME,  
 F.PARTY_CODE,   
 F.CLIENT_TYPE,   
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP,     
 C1.RES_PHONE1,  
 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
 F.INST_TYPE,   
 F.SYMBOL,  
 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
 F.STRIKE_PRICE,   
 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
 CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,  
 CL_RATE AS CLOSINGRATE,   

	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
		       THEN CASE WHEN SUM(PQTY) > 0 
			         THEN SUM(PAMT*DENOMINATOR/NUMERATOR)/SUM(PQTY) 
			         ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(PQTY) > 0 
		       THEN SUM((PRATE*PQTY+(PBROKAMT*DENOMINATOR/NUMERATOR)))/SUM(PQTY) 
		       ELSE 0 
		  END 
	END AS PRATE,
	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
	               THEN CASE WHEN SUM(SQTY) > 0 
				 THEN SUM(SAMT*DENOMINATOR/NUMERATOR)/SUM(SQTY) 
				 ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(SQTY) > 0 
		       THEN SUM((SRATE*SQTY-(SBROKAMT*DENOMINATOR/NUMERATOR)))/SUM(SQTY)
		       ELSE 0
		  END 
	END AS SRATE,


 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,  
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,  
 CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,  
 CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,  
 SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,  
 SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG)) ), /* CLEARING CHARGES */  
 SUM(((F.SERVICE_TAX - F.EXSER_TAX)) ), /* SERVICE TAX */  
 SUM(((F.SEBI_TAX)) ), /* SEBI TAX */  
 SUM(((F.TURN_TAX)) ), /* TURNOVER TAX */  
 SUM(((F.BROKER_NOTE)) ), /* STAMP DUTY */  
 SUM(((F.INS_CHRG)) ), /* INS CHARGES */  
 SUM(((F.OTHER_CHRG)) ), /* OTHERCHARGES */  
 CASE WHEN F.TRADETYPE = 'BF' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'   
               ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'   
           THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
        ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%'   
                                                     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
                           ELSE F.TRADETYPE   
                 END   
          END   
               END AS TRADETYPE,  
 F.TRADETYPE AS TRADETYPEPRINT  
FROM  
 FOBILLVALAN_PARENT F (NOLOCK),   
 CLIENT1 C1 (NOLOCK),   
 CLIENT2 C2 (NOLOCK) 
WHERE  
	 C1.CL_CODE = C2.CL_CODE AND  
	 C2.PARTY_CODE = F.PARTY_CODE AND   
	 F.CLIENT_TYPE LIKE @CLIENTTYPE AND  
	 F.PARTY_CODE >= @FROMPARTYCODE AND  
	 F.PARTY_CODE <= @TOPARTYCODE AND  
	 F.SAUDA_DATE >= @FROMDATE + ' 00:00:00' AND  
	 F.SAUDA_DATE <= @TODATE + ' 23:59:59' AND  
	 F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%' THEN 'BT' ELSE '%' END ) AND  
	@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)

GROUP BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,  
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,   
 F.TRADETYPE,   
 C1.RES_PHONE1,  
 F.SAUDA_DATE,  
 C1.EMAIL,  
 CL_RATE,  
 AUCTIONPART,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP  
  
HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 
ORDER BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SAUDA_DATE,  
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,   
 F.TRADETYPE  
  
COMPUTE  
 SUM(CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END), /* PAMT */   
 SUM(CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END), /* SAMT */  
 SUM(SUM((F.PBILLAMT) ) - SUM((F.SBILLAMT) )),  /*DIFF = PAMT-SAMT*/  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) )), /* TOTAL OF CHARGES */  
 SUM(SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )), /* DIFF - TOTAL OF CHARGES */  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG)) )), /* TOTAL OF CLEARING CHARGES */  
 SUM(SUM(((F.SERVICE_TAX - F.EXSER_TAX)) )), /* TOTAL OF SERVICE TAX */  
 SUM(SUM(((F.SEBI_TAX)) )), /* TOTAL OF SEBI TAX */  
 SUM(SUM(((F.TURN_TAX)) )), /* TOTAL OF TURNOVER TAX */  
 SUM(SUM(((F.BROKER_NOTE)) )), /* TOTAL OF STAMP DUTY */  
 SUM(SUM(((F.INS_CHRG)) )), /* TOTAL OF INS CHARGES */  
 SUM(SUM(((F.OTHER_CHRG)) )) /* TOTAL OF OTHERCHARGES */  
 BY F.PARTY_CODE   
 PRINT 'STATUS ID : ' + @STATUSID  
 PRINT 'STATUS NAME : ' + @STATUSNAME  
 PRINT 'FROM DATE : ' + @FROMDATE  
 PRINT 'TO DATE : ' + @TODATE  
 PRINT 'FROM PARTY CODE : ' + @FROMPARTYCODE  
 PRINT 'TO PARTY CODE : ' + @TOPARTYCODE  
 PRINT 'CLIENT TYPE : ' + @CLIENTTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary
-- --------------------------------------------------



CREATE PROC
[dbo].[rpt_proc_FO_NewClientSummary]
	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),
	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@OneOrMany VarChar(20),
	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Symbol VarChar(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@WithNetPos VarChar(50),
	@Dummy002 VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare
	@strSelect VarChar(8000),
	@strSelectTemp VarChar(8000),
	@strFrom VarChar(8000),
	@strWhere VarChar(8000),
	@strGroupBy VarChar(8000),
	@strOrderBy VarChar(8000),
	@strCompute VarChar(8000),
	@strComputeSub VarChar(8000),
	@IsSubLevel VarChar(3),
	@CodeID VarChar(20),
	@Comma VarChar(1)
	Set @InstType = @InstType+"%" 
	If @OptionType = '' Begin Set @OptionType = "%" End
	--If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE
	If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End
	If @Symbol = '' Begin Set @Symbol = "%" End
	
	If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End
	If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End
	If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End
	Set @strSelect = ''
	Set @strSelectTemp = ''
	Set @strFrom = ''
	Set @strWhere = ''
	Set @strGroupBy = ''
	Set @strOrderBy = ''
	Set @strCompute = ''
	Set @strCompute = ''
	Set @strComputeSub = ''
	Set @IsSubLevel = 'NO'
	If (@ReportName = 'CLIENTSUMMARY')
	Begin
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End
		
		Set @strSelect = @strSelect + "SELECT "
		--@OneOrMany AND @WhatCode WILL ALWAYS BE 'SUMMARY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))
		Begin
			Set @strSelectTemp = ''
			--@GroupLevel/@SubGroupLevel WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, party_name AS party_name, client_type, email, "
			End
			Set @strSelect = @strSelect + @strSelectTemp
			Set @strSelectTemp = ''
		End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))*/
		--@Ex_Rate AND @Ex_ReportBy WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		If (@Ex_Rate = 'MKTRATE')
		Begin
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--DAILY MARK TO MARKET SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND inst_type LIKE 'FUT%') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS dailymtomsettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--FINAL FUTURES SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND inst_type LIKE 'FUT%') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS finalfuturessettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--PREMIUM SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND inst_type LIKE 'OPT%' And TradeType = 'BT') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS premiumsettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--OPTIONS EXERCISE/ASSIGNMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND inst_type LIKE 'OPT%' And TradeType = 'BT') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt + SBrokAmt + PBrokAmt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS optionsexerciseassignment, "
				Set @strSelect = @strSelect + @strSelectTemp
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "-(Sum(pbrokamt + sbrokamt) + Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) "
				Set @strSelectTemp = @strSelectTemp + "+ Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "
				Set @strSelectTemp = @strSelectTemp + "AS brokandmisc, "
				Set @strSelect = @strSelect + @strSelectTemp
				--CLEARING CHARGES
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "-(Sum(cl_chrg) - Sum(ExCl_Chrg)) "
				Set @strSelectTemp = @strSelectTemp + "AS clearingcharges "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/
		If (@Ex_Rate = 'NETRATE')
		Begin
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--DAILY MARK TO MARKET SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND inst_type LIKE 'FUT%') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS dailymtomsettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--FINAL FUTURES SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND inst_type LIKE 'FUT%') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS finalfuturessettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--PREMIUM SETTLEMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart <> 'EA' AND inst_type LIKE 'OPT%' And TradeType = 'BT') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS premiumsettlement, "
				Set @strSelect = @strSelect + @strSelectTemp
				--OPTIONS EXERCISE/ASSIGNMENT
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(Case When (auctionpart = 'EA' AND inst_type LIKE 'OPT%' And TradeType = 'BT') Then "
				Set @strSelectTemp = @strSelectTemp + " Sbillamt - Pbillamt Else 0 End) "
				Set @strSelectTemp = @strSelectTemp + "AS optionsexerciseassignment, "
				Set @strSelect = @strSelect + @strSelectTemp
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "-(Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) "
				Set @strSelectTemp = @strSelectTemp + "+ Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "
				Set @strSelectTemp = @strSelectTemp + "AS brokandmisc, "
				Set @strSelect = @strSelect + @strSelectTemp
				--CLEARING CHARGES
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "-(Sum(cl_chrg) - Sum(ExCl_Chrg)) "
				Set @strSelectTemp = @strSelectTemp + "AS clearingcharges "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/
		Set @strFrom = @strFrom + "FROM "
		Set @strFrom = @strFrom + "FoBillValan (nolock)"
	
		Set @strWhere = @strWhere + "WHERE "
		--Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "
		--Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "
		--If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End
		--Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "
		--Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND "
		  If (@FromCode = '' AND @ToCode = '')      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" + @CodeID + ",'') LIKE '%' AND "      
		  End      
		  Else      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') >= '" + @FromCode + "' AND "      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') <= '" + @ToCode + "' AND "      
		  End  
		If (@FromDate = '' AND @ToDate = '')
		Begin
			Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "
			Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "
		End
		If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))
		Begin
			Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "
			Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "
		End
 /*LOGIN CONDITIONS*/      	
	
	Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "
	Set @strWhere = @strWhere + "		(CASE "
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	Set @strWhere = @strWhere + "			ELSE "
	Set @strWhere = @strWhere + "		'BROKER'"
	Set @strWhere = @strWhere + "		END)    "

/*END - LOGIN CONDITIONS*/

		Set @Comma = ''
		Set @strGroupBy = @strGroupBy + @Comma
		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))
		Begin
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "
				Set @Comma = ', '
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
		End /*If (@OneOrMany = 'DETAIL')*/
		Set @strOrderBy = @strGroupBy
		Set @strGroupBy = "GROUP BY " + @strGroupBy
		Set @strOrderBy = "ORDER BY " + @strOrderBy
	End/*If (@ReportName = "NETPOSITION")*/
	Print 'ReportName : ' + @ReportName
	Print 'StatusID : ' + @StatusID
	Print 'StatusName : ' + @StatusName
	Print 'GroupLevel : ' + @GroupLevel
	Print 'GroupSubLevel : ' + @GroupSubLevel
	Print 'OrderLevel : ' + @OrderLevel
	Print 'OrderSubLevel : ' + @OrderSubLevel
	
	Print 'FromDate : ' + @FromDate
	Print 'ToDate : ' + @ToDate
	Print 'WhatCode : ' + @WhatCode
	Print 'FromCode : ' + @FromCode
	Print 'ToCode : ' + @ToCode
	
	Print 'InstType : ' + @InstType
	Print 'OptionType : ' + @OptionType
	Print 'StrikePrice : ' + Convert(VarChar,@StrikePrice)
	Print 'ExpiryDate : ' + @ExpiryDate
	Print 'Symbol : ' + @Symbol
	
	Print 'BillType : ' + @Ex_BillType
	Print 'AuctionPart : ' + @Ex_AuctionPart
	Print 'ReportBy : ' + @Ex_ReportBy
	Print 'Rate : ' + @Ex_Rate
	Print 'MoneyType : ' + @Ex_MoneyType
	Print 'Position : ' + @Ex_Position
	
	Print 'Dummy001 : ' + @WithNetPos
	Print 'Dummy002 : ' + @Dummy002 
	Print 'Dummy003 : ' + @Dummy003
	Print 'Dummy004 : ' + @Dummy004
	Print 'Dummy005 : ' + @Dummy005
	Print 'Dummy006 : ' + @Dummy006
	Print 'Dummy007 : ' + @Dummy007
	Print 'Dummy008 : ' + @Dummy008
	Print 'Dummy009 : ' + @Dummy009
	Print 'Dummy010 : ' + @Dummy010
	Print '=============================================================================================='
	If @strComputeSub <> '' 
	Begin 
		Set @strComputeSub = "BY " + @strComputeSub 
		Set @strComputeSub = @strCompute + @strComputeSub
	End
	If (@IsSubLevel = 'YES')
	Begin
		Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)
	End
	Else
	Begin
		Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)
	End
	Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute
	Print @strSelect 
	Print @strFrom
	Print @strWhere
	Print @strGroupBy
	Print @strOrderBy
	Print @strComputeSub
	Print @strCompute

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary_Ledger
-- --------------------------------------------------


CREATE  PROC [dbo].[rpt_proc_FO_NewClientSummary_Ledger]     
	@PARTY_CODE VARCHAR(10),
	@RPTDATE VARCHAR(11),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(10)    
AS    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE     
@OPENBALANCE   MONEY,    
@LEDBALANCE   MONEY,    
@PAYREC       MONEY,    
@MINLEDBAL   MONEY,    
@MINMARGIN   MONEY,    
@MARGIN          MONEY,    
@AVLCOLL      MONEY,    
@SPANMAR      MONEY,    
@VARMARGIN       MONEY,    
@TOTCASH     MONEY,    
@TOTNONCASH      MONEY,    
@TOTCOLL  MONEY,    
@EFFCOLL    MONEY,    
@SPREADMARGIN MONEY,    
@NONSPREADMARGIN MONEY,    
@MTOMMARGIN MONEY,    
@MarginPer MONEY,
@DATACUR   CURSOR    
    
    
SET @LEDBALANCE   = 0     
SET @PAYREC       = 0     
SET @MINLEDBAL = 0    
SET @AVLCOLL      = 0     
SET @SPANMAR      = 0     
SET @VARMARGIN       = 0     
SET @TOTCASH       = 0     
SET @TOTNONCASH      = 0     
SET @TOTCOLL    = 0     
SET @EFFCOLL      = 0     
SET @MINMARGIN = 0    
    
/* LEDGER BALANCE */    
SELECT @LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L  (nolock) , ACCOUNTMCDX.DBO.PARAMETER P  (nolock)    
WHERE VDT < @RPTDATE AND VDT >= SDTCUR AND VDT<= ldtcur    
AND CLTCODE = @PARTY_CODE And @RPTDATE BetWeen SDTCUR And ldtcur     
    
/* OPEN BALANCE */    
SELECT @OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L    (nolock)  
WHERE VDT LIKE @RPTDATE + '%' AND VTYP = 18 AND CLTCODE = @PARTY_CODE     
    
SELECT @LEDBALANCE = @LEDBALANCE + @OPENBALANCE    
    
/* PAYMENT RECEIVED FOR THE DAY */    
SELECT @PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L  (nolock)  WHERE VDT LIKE @RPTDATE + '%' AND CLTCODE = @PARTY_CODE     
AND VTYP NOT IN (15,18)    
    
/* MARGIN AMOUNT */    
SELECT @MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
FROM ACCOUNTMCDX.DBO.MARGINLEDGER L  (nolock) , ACCOUNTMCDX.DBO.PARAMETER P  (nolock)  WHERE VDT <= @RPTDATE + ' 23:59' AND PARTY_CODE = @PARTY_CODE     
AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VDT < @RPTDATE AND VDT >= SDTCUR AND CURYEAR = 1     
    
/* SPAN AND VAR MARGIN */    
SELECT @SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) , @VARMARGIN = -ISNULL(SUM(MTOM),0) , @SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0), @NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0),@MTOMMARGIN = -ISNULL(SUM(MTOM),0) FROM FOMARGINNEW     
WHERE MDATE LIKE @RPTDATE + '%' AND PARTY_CODE = @PARTY_CODE AND CL_TYPE like  'C%'     
    
/* COLLATERAL DETAILS */    
SELECT @TOTCASH = ISNULL(SUM(CASH),0), @TOTNONCASH = ISNULL(SUM(NONCASH),0), @TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
@EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), @AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0) FROM MSAJAG.DBO.COLLATERAL     
WHERE PARTY_CODE = @PARTY_CODE AND TRANS_DATE LIKE @RPTDATE + '%' AND EXCHANGE = @EXCHANGE    
AND SEGMENT = @SEGMENT     
    
SELECT @MarginPer = 0

/*
SELECT @MarginPer = Margin_Percent From FoMarginPercent 
Where Party_Code = @PARTY_CODE And Effective_DateFrom = 
( select Max(Effective_DateFrom) From FoMarginPercent 
Where Party_Code = @PARTY_CODE And Effective_DateFrom <= @RPTDATE )
*/

If @MarginPer = 0 OR @MarginPer Is Null      
 SELECT @MarginPer = 100      
      
SELECT       
PARTY_CODE              = @PARTY_CODE,      
MARGINDATE                = @RPTDATE,       
LEDBALANCE  = @LEDBALANCE,      
PAYREC   = @PAYREC,      
MINLEDBAL         = @MINLEDBAL,      
MINMARGIN        = @SPREADMARGIN + @NONSPREADMARGIN + @VARMARGIN,      
MARGIN              = @MARGIN,      
AVLCOLL  = @AVLCOLL,      
SPANMAR  = @SPANMAR,      
VARMARGIN   = 0,      
TOTCASH  = @TOTCASH,      
TOTCOLLNONCASH        = @TOTNONCASH,      
TOTNONCASH  = @TOTNONCASH,      
TOTCOLL  = @TOTCOLL,      
EFFCOLL  = Case When @LEDBALANCE + @PAYREC + @TOTCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
    Then Case When @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          Then @LEDBALANCE + @TOTCASH      
          Else @TOTNONCASH       
             End      
    Else      
            Case When @TOTNONCASH > abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
                     Then abs((@SPREADMARGIN+@VARMARGIN)*@MarginPer/100)        
          Else @TOTNONCASH       
             End       
        End + @TOTCASH ,      
SPREADMARGIN  = @SPREADMARGIN ,      
NONSPREADMARGIN = @NONSPREADMARGIN,
MTOMMARGIN = @MTOMMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER_PARENT
-- --------------------------------------------------
CREATE   PROC [DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER_PARENT]     
@PARTY_CODE VARCHAR(10),@RPTDATE VARCHAR(11),@EXCHANGE VARCHAR(3),@SEGMENT VARCHAR(10)    
AS    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE     
@OPENBALANCE   MONEY,    
@LEDBALANCE   MONEY,    
@PAYREC       MONEY,    
@MINLEDBAL   MONEY,    
@MINMARGIN   MONEY,    
@MARGIN          MONEY,    
@AVLCOLL      MONEY,    
@SPANMAR      MONEY,    
@VARMARGIN       MONEY,    
@TOTCASH     MONEY,    
@TOTNONCASH      MONEY,    
@TOTCOLL  MONEY,    
@EFFCOLL    MONEY,    
@SPREADMARGIN MONEY,    
@NONSPREADMARGIN MONEY,    
@MTOMMARGIN MONEY,    
@MARGINPER MONEY,
@DATACUR   CURSOR    
    
    
SET @LEDBALANCE   = 0     
SET @PAYREC       = 0     
SET @MINLEDBAL = 0    
SET @AVLCOLL      = 0     
SET @SPANMAR      = 0     
SET @VARMARGIN       = 0     
SET @TOTCASH       = 0     
SET @TOTNONCASH      = 0     
SET @TOTCOLL    = 0     
SET @EFFCOLL      = 0     
SET @MINMARGIN = 0    
    
/* LEDGER BALANCE */    
SELECT @LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L  (NOLOCK) , ACCOUNTMCDX.DBO.PARAMETER P  (NOLOCK)    
WHERE VDT < @RPTDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
AND CLTCODE = @PARTY_CODE AND @RPTDATE BETWEEN SDTCUR AND LDTCUR     
    
/* OPEN BALANCE */    
SELECT @OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L    (NOLOCK)  
WHERE VDT LIKE @RPTDATE + '%' AND VTYP = 18 AND CLTCODE = @PARTY_CODE     
    
SELECT @LEDBALANCE = @LEDBALANCE + @OPENBALANCE    
    
/* PAYMENT RECEIVED FOR THE DAY */    
SELECT @PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
FROM ACCOUNTMCDX.DBO.LEDGER L  (NOLOCK)  WHERE VDT LIKE @RPTDATE + '%' AND CLTCODE = @PARTY_CODE     
AND VTYP NOT IN (15,18)    
    
/* MARGIN AMOUNT */    
SELECT @MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
FROM ACCOUNTMCDX.DBO.MARGINLEDGER L  (NOLOCK) , ACCOUNTMCDX.DBO.PARAMETER P  (NOLOCK)  WHERE VDT <= @RPTDATE + ' 23:59' AND PARTY_CODE = @PARTY_CODE     
AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VDT < @RPTDATE AND VDT >= SDTCUR AND CURYEAR = 1     
    
/* SPAN AND VAR MARGIN */    
SELECT @SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) , @VARMARGIN = -ISNULL(SUM(MTOM),0) , @SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0), @NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0),@MTOMMARGIN = -ISNULL(SUM(MTOM),0) FROM FOMARGINNEW     
WHERE MDATE LIKE @RPTDATE + '%' AND PARTY_CODE = @PARTY_CODE AND CL_TYPE LIKE  'C%'     
    
/* COLLATERAL DETAILS */    
SELECT @TOTCASH = ISNULL(SUM(CASH),0), @TOTNONCASH = ISNULL(SUM(NONCASH),0), @TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
@EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), @AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0) FROM MSAJAG.DBO.COLLATERAL     
WHERE PARTY_CODE = @PARTY_CODE AND TRANS_DATE LIKE @RPTDATE + '%' AND EXCHANGE = @EXCHANGE    
AND SEGMENT = @SEGMENT     
    
SELECT @MARGINPER = 0

/*
SELECT @MARGINPER = MARGIN_PERCENT FROM FOMARGINPERCENT 
WHERE PARTY_CODE = @PARTY_CODE AND EFFECTIVE_DATEFROM = 
( SELECT MAX(EFFECTIVE_DATEFROM) FROM FOMARGINPERCENT 
WHERE PARTY_CODE = @PARTY_CODE AND EFFECTIVE_DATEFROM <= @RPTDATE )
*/

IF @MARGINPER = 0 OR @MARGINPER IS NULL      
 SELECT @MARGINPER = 100      
      
SELECT       
PARTY_CODE              = @PARTY_CODE,      
MARGINDATE                = @RPTDATE,       
LEDBALANCE  = @LEDBALANCE,      
PAYREC   = @PAYREC,      
MINLEDBAL         = @MINLEDBAL,      
MINMARGIN        = 0, --@SPREADMARGIN + @NONSPREADMARGIN + @VARMARGIN,      
MARGIN              = @MARGIN,      
AVLCOLL  = @AVLCOLL,      
SPANMAR  = @SPANMAR,      
VARMARGIN   = 0,      
TOTCASH  = @TOTCASH,      
TOTCOLLNONCASH        = @TOTNONCASH,      
TOTNONCASH  = @TOTNONCASH,      
TOTCOLL  = @TOTCOLL,      
EFFCOLL  = CASE WHEN @LEDBALANCE + @PAYREC + @TOTCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
    THEN CASE WHEN @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH      
          THEN @LEDBALANCE + @TOTCASH      
          ELSE @TOTNONCASH       
             END      
    ELSE      
            CASE WHEN @TOTNONCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
                     THEN ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)        
          ELSE @TOTNONCASH       
             END       
        END + @TOTCASH ,      
SPREADMARGIN  = @SPREADMARGIN ,      
NONSPREADMARGIN = @NONSPREADMARGIN,
MTOMMARGIN = @MTOMMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewClientSummary_NetPos
-- --------------------------------------------------



CREATE  PROC
[dbo].[rpt_proc_FO_NewClientSummary_NetPos]
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@SaudaDate VarChar(11),
	@PartyCode VarChar(20),
	@Dummy001 VarChar(50),
	@Dummy002 VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT
		inst_type, symbol, 
		Left(expirydate,11) AS expirydate, 
		strike_price, 
		option_type, 
		Sum(pqty-sqty) AS openposition,
		Sum(sbillamt-pbillamt) - (Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg))  AS profitorloss
	FROM
		fobillvalan (nolock)
	WHERE
		party_code = @PartyCode AND
		sauda_date LIKE @SaudaDate + '%'
	GROUP BY
		inst_type, symbol, expirydate, strike_price, option_type			
	HAVING Sum(pqty-sqty) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS_PARENT
-- --------------------------------------------------
CREATE   PROC
[DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS_PARENT]
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@SAUDADATE VARCHAR(11),
	@PARTYCODE VARCHAR(20),
	@DUMMY001 VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT
		INST_TYPE, SYMBOL, 
		LEFT(EXPIRYDATE,11) AS EXPIRYDATE, 
		STRIKE_PRICE, 
		OPTION_TYPE, 
		SUM(PQTY-SQTY) AS OPENPOSITION,
		SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX - EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))  AS PROFITORLOSS
	FROM
		FOBILLVALAN_PARENT  (NOLOCK)
	WHERE
		PARTY_CODE = @PARTYCODE AND
		SAUDA_DATE LIKE @SAUDADATE + '%'
	GROUP BY
		INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
	HAVING SUM(PQTY-SQTY) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_PARENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWCLIENTSUMMARY    SCRIPT DATE: 24 JUL 2003 06:54:22 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWCLIENTSUMMARY    SCRIPT DATE: MAR 28 2003 14:57:55 ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWCLIENTSUMMARY    SCRIPT DATE: MAR 21 2003 15:49:52 ******/
-- SQL FOR THE NEW FO REPORT MODULE - CLIENT SUMMARY REPORT
--WRITTEN BY						:			SHYAM.
--START DATE						: 			MAR 19 2003.
-------------------------------------------------------------------------------------------------------------------
--				MODIFICATION HISTORY
-------------------------------------------------------------------------------------------------------------------
--	.1	BY SHYAM ON FEB 27 2003
--	**********************************************
--	WRITE MODIFICATION SUMMARY HERE
--	**********************************************
-------------------------------------------------------------------------------------------------------------------
CREATE  PROC
[DBO].[RPT_PROC_FO_NEWCLIENTSUMMARY_PARENT]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@WITHNETPOS VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@REPORTNAME = 'CLIENTSUMMARY')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		--@ONEORMANY AND @WHATCODE WILL ALWAYS BE 'SUMMARY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			--@GROUPLEVEL/@SUBGROUPLEVEL WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, PARTY_NAME AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))*/
		--@EX_RATE AND @EX_REPORTBY WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--DAILY MARK TO MARKET SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--FINAL FUTURES SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--PREMIUM SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--OPTIONS EXERCISE/ASSIGNMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX - EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLEARING CHARGES
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		IF (@EX_RATE = 'NETRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--DAILY MARK TO MARKET SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--FINAL FUTURES SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--PREMIUM SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--OPTIONS EXERCISE/ASSIGNMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(SERVICE_TAX - EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLEARING CHARGES
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
		--SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		--SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		--IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		--SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		--SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END  
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @WITHNETPOS
	PRINT 'DUMMY002 : ' + @DUMMY002 
	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010
	PRINT '=============================================================================================='
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END
	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
	END
	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE
	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewInTheMoney
-- --------------------------------------------------



CREATE  PROC [dbo].[rpt_proc_FO_NewInTheMoney]
	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),
	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@OneOrMany VarChar(20),
	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Symbol VarChar(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@Dummy001 VarChar(50),
	@Dummy002 VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare
	@strSelect VarChar(8000),
	@strSelectTemp VarChar(8000),
	@strFrom VarChar(8000),
	@strWhere VarChar(8000),
	@strGroupBy VarChar(8000),
	@strOrderBy VarChar(8000),
	@strCompute VarChar(8000),
	@strComputeSub VarChar(8000),
	@IsSubLevel VarChar(3),
	@CodeID VarChar(20),
	@Comma VarChar(1)
	Set @InstType = @InstType+"%" 
	If @OptionType = '' Begin Set @OptionType = "%" End
	--If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE
	If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End
	If @Symbol = '' Begin Set @Symbol = "%" End
	
	If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End
	If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End
	If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End
	Set @strSelect = ''
	Set @strSelectTemp = ''
	Set @strFrom = ''
	Set @strWhere = ''
	Set @strGroupBy = ''
	Set @strOrderBy = ''
	Set @strCompute = ''
	Set @strCompute = ''
	Set @strComputeSub = ''
	Set @IsSubLevel = 'NO'
	If (@FromDate = '' AND @ToDate = '')
	Begin 
		Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From FoBillValan 
	End 
	If (@ReportName = 'INTHEMONEY')
	Begin
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End
		If (@WhatCode = 'AREA') Begin Set @CodeID = 'Area' End
		If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End
		If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End
		If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End
		If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End
		If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End
		
		Set @strSelect = @strSelect + "SELECT "
		Set @strCompute = @strCompute + "COMPUTE "
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))
		Begin
			Set @strSelectTemp = ''
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "party_code "
				End
			End
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "symbol, inst_type, expirydate, strike_price, option_type "
				End
			End
	
			If (@GroupLevel = 'DATE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "sauda_date "
				End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "inst_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "inst_type "
				End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,25) AS party_name, client_type, email, symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "
				Set @strSelectTemp = @strSelectTemp + "option_type, Convert(VarChar,sauda_date,103) AS sauda_date, "
				Set @IsSubLevel = 'YES'
			End
			Set @strSelect = @strSelect + @strSelectTemp
			Set @strSelectTemp = ''
		End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
			If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,25) AS party_name, client_type, email, " End
			If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End
			If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "Area, " End
			If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End
			If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End
			If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End
		End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		
		If (@Ex_Rate = 'MKTRATE')
		Begin
			--If (@Ex_ReportBy = 'BOTH') ARE OMITED
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--PQTY
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + " Sum(pqty) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* P.QTY */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS pqty, "
				Set @strSelect = @strSelect + @strSelectTemp
		
				--SQTY
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "Sum(sqty) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* S.QTY */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS sqty, "
				Set @strSelect = @strSelect + @strSelectTemp
				--NETQTY
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(pqty) - Sum(sqty)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS netqty, "
				Set @strSelect = @strSelect + @strSelectTemp
				--CLOSING RATE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + " Sum(cmclosing) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSING RATE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closingrate, "
				Set @strSelect = @strSelect + @strSelectTemp
				--NET RATE
				--Set @strSelectTemp = ''
				--Set @strSelectTemp = @strSelectTemp + " (Sum(PRate*PQty) - Sum(SRate*SQty)) "
				--Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				--Set @strSelectTemp = @strSelectTemp + "AS netrate, "
				--Set @strSelect = @strSelect + @strSelectTemp
				--NET RATE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + " (Abs(Sum((cmclosing-strike_price)))) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS netrate, "
				Set @strSelect = @strSelect + @strSelectTemp
				--SETTLEMENT AMT.
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + " (Abs(Sum((cmclosing-strike_price))) * (Sum(pqty) - Sum(sqty))) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* SETTLEMENT AMT. */ "	--FOR THE SUB TOTAL - LAST ONE W/O THE COMMA
				Set @strSelectTemp = @strSelectTemp + "AS settlementamt "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/	
		Set @strSelectTemp = ""
		
		SET @strFrom = @strFrom + "INTO ##FOSAUDASUMMARY "
		Set @strFrom = @strFrom + "FROM "
		Set @strFrom = @strFrom + "FoBillValan (nolock)"
	
		Set @strWhere = @strWhere + "WHERE "
	
		/* MONEY TYPE OPTIONS */
		If (@Ex_MoneyType = "I")
		Begin
			Set @strWhere = @strWhere + "Convert(money, cmclosing) > Convert(money, strike_price) AND "
		End
		If (@Ex_MoneyType = "O")
		Begin
			Set @strWhere = @strWhere + "Convert(money, cmclosing) < Convert(money, strike_price) AND "
		End
		If (@Ex_MoneyType = "A")
		Begin
			Set @strWhere = @strWhere + "Convert(money, cmclosing) = Convert(money, strike_price) AND "
		End
		/* END MONEY TYPE OPTIONS */
		/* POSITION TYPE OPTIONS */
		If (@Ex_Position = "L")
		Begin
			Set @strWhere = @strWhere + "pqty > 0 AND sqty = 0 AND "
		End
		If (@Ex_Position = "S")
		Begin
			Set @strWhere = @strWhere + "sqty > 0 AND pqty = 0 AND "
		End
		/* END POSITION TYPE OPTIONS */
		Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "
		Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "
		If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End
		Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "
		Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND /*expirydate >= getdate() AND*/ "
		If (@FromCode = '' AND @ToCode = '')
		Begin
			Set @strWhere = @strWhere + " isnull('" + @CodeID + "','') LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + " isnull('" + @CodeID + "','') >= '" + @FromCode + "' AND "
			Set @strWhere = @strWhere + " isnull('" + @CodeID + "','') <= '" + @ToCode + "' AND "
		End
		If (@FromDate = '' AND @ToDate = '')
		Begin
			Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "
			Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "
		End
		If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))
		Begin
			Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "
			Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "
		End
 /*LOGIN CONDITIONS*/      	
	
	Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "
	Set @strWhere = @strWhere + "		(CASE "
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	Set @strWhere = @strWhere + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	Set @strWhere = @strWhere + "			ELSE "
	Set @strWhere = @strWhere + "		'BROKER'"
	Set @strWhere = @strWhere + "		END)    "

/*END - LOGIN CONDITIONS*/

		Set @Comma = ''
		Set @strGroupBy = @strGroupBy + @Comma
		
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))
		Begin
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "
				Set @Comma = ', '
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
			
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strGroupBy = @strGroupBy + "symbol, inst_type, expirydate, strike_price, option_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "inst_type "*/ End
			End
	
			If (@GroupLevel = 'DATE')
			Begin
				Set @strGroupBy = @strGroupBy + "sauda_date "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strGroupBy = @strGroupBy + "inst_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, symbol, inst_type, expirydate, strike_price, "
				Set @strGroupBy = @strGroupBy + "option_type, sauda_date "
			End
		End /*If (@OneOrMany = 'DETAIL')*/
		Else /*If (@OneOrMany = 'DETAIL')*/
		Begin /*Else OF If (@OneOrMany = 'DETAIL')*/
			If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End
			If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "Area " End
			If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End
			If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End
			If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End
			If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End
		End /*Else OF If (@OneOrMany = 'DETAIL')*/
		Set @strOrderBy = @strGroupBy
		Set @strGroupBy = "GROUP BY " + @strGroupBy + " Having Sum(pqty) - Sum(sqty) <> 0 "
		Set @strOrderBy = "ORDER BY " + @strOrderBy
	End/*If (@ReportName = "NETPOSITION")*/
	Print 'ReportName : ' + @ReportName
	Print 'StatusID : ' + @StatusID
	Print 'StatusName : ' + @StatusName
	Print 'GroupLevel : ' + @GroupLevel
	Print 'GroupSubLevel : ' + @GroupSubLevel
	Print 'OrderLevel : ' + @OrderLevel
	Print 'OrderSubLevel : ' + @OrderSubLevel
	
	Print 'FromDate : ' + @FromDate
	Print 'ToDate : ' + @ToDate
	Print 'WhatCode : ' + @WhatCode
	Print 'FromCode : ' + @FromCode
	Print 'ToCode : ' + @ToCode
	
	Print 'InstType : ' + @InstType
	Print 'OptionType : ' + @OptionType
	Print 'StrikePrice : ' + Convert(VarChar,@StrikePrice)
	Print 'ExpiryDate : ' + @ExpiryDate
	Print 'Symbol : ' + @Symbol
	
	Print 'BillType : ' + @Ex_BillType
	Print 'AuctionPart : ' + @Ex_AuctionPart
	Print 'ReportBy : ' + @Ex_ReportBy
	Print 'Rate : ' + @Ex_Rate
	Print 'MoneyType : ' + @Ex_MoneyType
	Print 'Position : ' + @Ex_Position
	
	Print 'Dummy001 : ' + @Dummy001
	Print 'Dummy002 : ' + @Dummy002
	Print 'Dummy003 : ' + @Dummy003
	Print 'Dummy004 : ' + @Dummy004
	Print 'Dummy005 : ' + @Dummy005
	Print 'Dummy006 : ' + @Dummy006
	Print 'Dummy007 : ' + @Dummy007
	Print 'Dummy008 : ' + @Dummy008
	Print 'Dummy009 : ' + @Dummy009
	Print 'Dummy010 : ' + @Dummy010
	Print '=============================================================================================='
	If @strComputeSub <> '' 
	Begin 
		Set @strComputeSub = "BY " + @strComputeSub 
		Set @strComputeSub = @strCompute + @strComputeSub
	End
	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	If (@IsSubLevel = 'YES')
	Begin
		--Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute)
		SET @STRSQL = (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy)
	End
	Else
	Begin
		--Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strCompute)
		SET @STRSQL = (@strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy)
	End
	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY
	PRINT @STRSQL
	EXEC (@STRSQL)
	/*
	Print @strSelect + @strFrom + @strWhere + @strGroupBy + @strOrderBy + @strComputeSub + @strCompute
	Print @strSelect 
	Print @strFrom
	Print @strWhere
	Print @strGroupBy
	Print @strOrderBy
	Print @strComputeSub
	Print @strCompute
	*/


	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	
	IF @GROUPSUBLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
	END
	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	
	INSERT INTO #TMPSUMMARY
	EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	

	DECLARE @PARTYWISE_CURSOR	CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY " 
		SET @STRSQL = @STRSQL + "WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		SET @STRSQL = @STRSQL + " SELECT SUM=SUM(PQTY),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SQTY),"
		SET @STRSQL = @STRSQL + " SUM=(SUM(PQTY)-SUM(SQTY)),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CLOSINGRATE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(NETRATE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SETTLEMENTAMT) "
		SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR

	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN"
	SET @STRSQL = @STRSQL + " SELECT SUM=SUM(PQTY),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SQTY),"
	SET @STRSQL = @STRSQL + " SUM=(SUM(PQTY)-SUM(SQTY)),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CLOSINGRATE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(NETRATE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SETTLEMENTAMT) "
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWINTHEMONEY_PARENT
-- --------------------------------------------------
CREATE    PROC
[DBO].[RPT_PROC_FO_NEWINTHEMONEY_PARENT]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@DUMMY001 VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT 
	END 
	IF (@REPORTNAME = 'INTHEMONEY')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END
		IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END
		IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END
		IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END
		IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
				END
			END
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "
				END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
			IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END
		END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			--IF (@EX_REPORTBY = 'BOTH') ARE OMITED
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--PQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		
				--SQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SQTY) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NETQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLOSING RATE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CMCLOSING) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLOSING RATE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSINGRATE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NET RATE
				--SET @STRSELECTTEMP = ''
				--SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PRATE*PQTY) - SUM(SRATE*SQTY)) "
				--SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				--SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETRATE, "
				--SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NET RATE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE)))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETRATE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--SETTLEMENT AMT.
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE))) * (SUM(PQTY) - SUM(SQTY))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* SETTLEMENT AMT. */ "	--FOR THE SUB TOTAL - LAST ONE W/O THE COMMA
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SETTLEMENTAMT "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/	
		SET @STRSELECTTEMP = ""
		
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
	
		/* MONEY TYPE OPTIONS */
		IF (@EX_MONEYTYPE = "I")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) > CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		IF (@EX_MONEYTYPE = "O")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) < CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		IF (@EX_MONEYTYPE = "A")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) = CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		/* END MONEY TYPE OPTIONS */
		/* POSITION TYPE OPTIONS */
		IF (@EX_POSITION = "L")
		BEGIN
			SET @STRWHERE = @STRWHERE + "PQTY > 0 AND SQTY = 0 AND "
		END
		IF (@EX_POSITION = "S")
		BEGIN
			SET @STRWHERE = @STRWHERE + "SQTY > 0 AND PQTY = 0 AND "
		END
		/* END POSITION TYPE OPTIONS */
		SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND /*EXPIRYDATE >= GETDATE() AND*/ "
		IF (@FROMCODE = '' AND @TOCODE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') >= '" + @FROMCODE + "' AND "
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') <= '" + @TOCODE + "' AND "
		END
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/

		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
			
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "
				SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		ELSE /*IF (@ONEORMANY = 'DETAIL')*/
		BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
			IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END
		END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING SUM(PQTY) - SUM(SQTY) <> 0 "
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @DUMMY001
	PRINT 'DUMMY002 : ' + @DUMMY002
	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010
	PRINT '=============================================================================================='
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END
	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
	END
	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE
	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewM2M
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_PROC_FO_NEWM2M]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@DISPDIFFONLY VARCHAR(10),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@M2MTYPE VARCHAR(50),
	@M2MFOR VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DECLARE	@MEMBERCODE VARCHAR(15)

	SELECT @MEMBERCODE = MEMBERCODE FROM FOOWNER 
	IF @TOCODE='' OR @TOCODE='Z' SET @TOCODE = 'ZZZZZZZ'

	IF @M2MFOR = 'SCRIP'
	BEGIN
	
	
					
		SELECT 
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		INTO 
			#M2M_SCRIP
		FROM
			(
			SELECT
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTICIPANTCODE = @MEMBERCODE AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					
				GROUP BY
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY 
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		/*
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)
			*/
		SELECT * FROM #M2M_SCRIP
		ORDER BY 
			INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		SELECT  
			SUM = SUM (M_EXE),
			SUM = SUM (M_PREM),
			SUM = SUM (M_DAILY),
			SUM = SUM (F_EXE),
			SUM = SUM (F_PREM),
			SUM = SUM (F_DAILY),
			SUM = SUM (DIFF_EXE),
			SUM = SUM (DIFF_PREM),
			SUM = SUM (DIFF_DAILY)
		FROM 
			#M2M_SCRIP
		DROP TABLE #M2M_SCRIP
	END	/*IF @M2MFOR = 'SCRIP'*/
	IF @M2MFOR = 'PARTY'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		INTO
			#M2M_PARTY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER) AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE
				) FOEA
				
				ON ( FOEA_PARTY_CODE = PARTY_CODE )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME
		/*			
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)
			*/
		SELECT * FROM #M2M_PARTY
		ORDER BY 
			Party_Code,Party_Name
		SELECT  
			SUM = SUM (M_EXE),
			SUM = SUM (M_PREM),
			SUM = SUM (M_DAILY),
			SUM = SUM (F_EXE),
			SUM = SUM (F_PREM),
			SUM = SUM (F_DAILY),
			SUM = SUM (DIFF_EXE),
			SUM = SUM (DIFF_PREM),
			SUM = SUM (DIFF_DAILY)
		FROM 
			#M2M_PARTY
		DROP TABLE #M2M_PARTY			

	END	/*IF @M2MFOR = 'PARTY'*/
	IF @M2MFOR = 'BOTH'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		INTO
			#M2M_BOTH
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER) AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME,
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_PARTY_CODE = PARTY_CODE AND 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME,INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		/*
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)
			*/
		SELECT * FROM #M2M_BOTH
		ORDER BY 	
			Party_Code,Party_Name,inst_type ,Symbol,Expiry_Date,Option_Type,Strike_Price
		SELECT 
			SUM = SUM (M_EXE),
			SUM = SUM (M_PREM),
			SUM = SUM (M_DAILY),
			SUM = SUM (F_EXE),
			SUM = SUM (F_PREM),
			SUM = SUM (F_DAILY),
			SUM = SUM (DIFF_EXE),
			SUM = SUM (DIFF_PREM),
			SUM = SUM (DIFF_DAILY)
		FROM 
			#M2M_BOTH	

		DROP TABLE #M2M_BOTH			
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWM2M_PARENT
-- --------------------------------------------------
CREATE  PROC
[DBO].[RPT_PROC_FO_NEWM2M_PARENT]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@DISPDIFFONLY VARCHAR(10),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@M2MTYPE VARCHAR(50),
	@M2MFOR VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE
        @MEMBERCODE VARCHAR(15)
	SELECT @MEMBERCODE = MEMBERCODE FROM FOOWNER 
	IF @TOCODE='' SET @TOCODE = 'ZZZ'

	IF @M2MFOR = 'SCRIP'
	BEGIN
		SELECT 
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN_PARENT
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY 
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)
	END	/*IF @M2MFOR = 'SCRIP'*/
	IF @M2MFOR = 'PARTY'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN_PARENT
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE
				) FOEA
				
				ON ( FOEA_PARTY_CODE = PARTY_CODE )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)

	END	/*IF @M2MFOR = 'PARTY'*/
	IF @M2MFOR = 'BOTH'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN_PARENT
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME,
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_PARTY_CODE = PARTY_CODE AND 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME,INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWNETPOSITION
-- --------------------------------------------------


CREATE   PROC [dbo].[RPT_PROC_FO_NEWNETPOSITION]
(
 @REPORTNAME VARCHAR(50),    
 @STATUSID VARCHAR(20),    
 @STATUSNAME VARCHAR(50),    
 @GROUPLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT    
 @GROUPSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS    
 @ORDERLEVEL VARCHAR(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @ORDERSUBLEVEL VARCHAR(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
 @FROMDATE VARCHAR(11),    
 @TODATE VARCHAR(11),    
 @WHATCODE VARCHAR(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
 @FROMCODE VARCHAR(20),    
 @TOCODE VARCHAR(20),    
 @FROMPARTYCODE VARCHAR(20), --]--> FOR THE FROM AND TO PARTY CODES    
 @TOPARTYCODE VARCHAR(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
 @ONEORMANY VARCHAR(20),    
 @INSTTYPE VARCHAR(20),  --]    
 @OPTIONTYPE VARCHAR(20), --]    
 @STRIKEPRICE MONEY,  --]--> PRIMARY SEARCH FIELDS.    
 @EXPIRYDATE VARCHAR(11), --]    
 @SYMBOL VARCHAR(20),  --]    
 --REPORT SPECIFIC SEARCH FEILDS    
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)        
 @EX_BILLTYPE VARCHAR(1), --(SINGLE/MULTIPLE) - BILL      ]    
 @EX_AUCTIONPART VARCHAR(20), --SAUDASUMMARY       ]    
 @EX_REPORTBY VARCHAR(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
 @EX_RATE VARCHAR(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
 @EX_MONEYTYPE VARCHAR(1), --(IN/AT/OUT) - IN THE MONEY      ]    
 @EX_POSITION VARCHAR (1), --(LONG/SHORT) - IN THE MONEY     ]    
 @CMCLOSING VARCHAR (2), --(LONG/SHORT) - IN THE MONEY     ]    
 --END REPORT SPECIFIC SEARCH FEILDS    
 @POSITIONAS VARCHAR(50),  --ACTUAL/LOT  
 @DUMMY002 VARCHAR(50),    
 @DUMMY003 VARCHAR(50),    
 @DUMMY004 VARCHAR(50),    
 @DUMMY005 VARCHAR(50),    
 @DUMMY006 VARCHAR(50),    
 @DUMMY007 VARCHAR(50),    
 @DUMMY008 VARCHAR(50),    
 @DUMMY009 VARCHAR(50),    
 @DUMMY010 VARCHAR(50)    
 )
AS    

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE    
 @STRSELECT VARCHAR(8000),    
 @STRSELECTTEMP VARCHAR(8000),    
 @STRFROM VARCHAR(8000),    
 @STRWHERE VARCHAR(8000),    
 @STRGROUPBY VARCHAR(8000),    
 @STRORDERBY VARCHAR(8000),    
 @STRCOMPUTE VARCHAR(8000),    
 @STRCOMPUTESUB VARCHAR(8000),    
 @ISSUBLEVEL VARCHAR(3),    
 @CODEID VARCHAR(20),    
 @COMMA VARCHAR(1)    
 SET @INSTTYPE = @INSTTYPE+"%"     
 IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END    
 --IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE    
 IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END    
 IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END    
     
 IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END    
 IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END    
 IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END    
 SET @STRSELECT = ''    
 SET @STRSELECTTEMP = ''    
 SET @STRFROM = ''    
 SET @STRWHERE = ''    
 SET @STRGROUPBY = ''    
 SET @STRORDERBY = ''    
 SET @STRCOMPUTE = ''    
 SET @STRCOMPUTE = ''    
 SET @STRCOMPUTESUB = ''    
 SET @ISSUBLEVEL = 'NO'    
 IF (@FROMDATE = '' AND @TODATE = '')    
 BEGIN     
  SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN     
 END   
ELSE  
	BEGIN
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11)
		FROM FOBILLVALAN (NOLOCK)
		WHERE SAUDA_DATE <= @FROMDATE + ' 23:59'
	END 

 IF (@REPORTNAME = 'NETPOSITION')    
 BEGIN    
  IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END    
  IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END    
  IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END    
  IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END    
  IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END    
  IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END    
  IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END    
      
  IF @CMCLOSING <> ''     
   BEGIN    
    SET @STRSELECT = @STRSELECT + "SELECT CMCLOSING, "     
   END    
  ELSE    
   BEGIN    
    SET @STRSELECT = @STRSELECT + "SELECT "     
   END    
  SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "    
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))    
  BEGIN    
   SET @STRSELECTTEMP = ''    
   IF (@GROUPLEVEL = 'PARTY')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE,  "    
    IF (@GROUPSUBLEVEL = 'PARTY')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + " MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL,"    
     SET @ISSUBLEVEL = 'YES'    
    END   
    IF (@GROUPSUBLEVEL = 'SCRIP')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL,SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO), "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'DATE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "    
     SET @ISSUBLEVEL = 'YES'    
    END   
    IF (@GROUPSUBLEVEL = 'INSTTYPE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
        
    IF (@ISSUBLEVEL = 'YES')    
    BEGIN    
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "    
    END    
   END    
   IF (@GROUPLEVEL = 'SCRIP')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO),"    
    IF (@GROUPSUBLEVEL = 'PARTY')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'DATE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'INSTTYPE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@ISSUBLEVEL = 'YES')    
    BEGIN    
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
    END    
   END    
     
   IF (@GROUPLEVEL = 'DATE')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "    
    IF (@GROUPSUBLEVEL = 'PARTY')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'SCRIP')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, BILLNO=MAX(BILLNO),"    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'INSTTYPE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@ISSUBLEVEL = 'YES')    
    BEGIN    
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "    
    END    
   END    
     
   IF (@GROUPLEVEL = 'INSTTYPE')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "    
    IF (@GROUPSUBLEVEL = 'PARTY')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'SCRIP')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL,  CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "    
     SET @ISSUBLEVEL = 'YES'    
    END    
    IF (@GROUPSUBLEVEL = 'DATE')    
    BEGIN    
     SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "    
     SET @ISSUBLEVEL = 'YES'    

    END    
    IF (@ISSUBLEVEL = 'YES')    
    BEGIN    
     SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "    
    END    
   END    
     
   IF (@GROUPLEVEL = 'PSD')    
   BEGIN    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, BILLNO=MAX(BILLNO),"    
	  SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,CONVERT(DATETIME,'" + @FROMDATE +"',103),103) AS SAUDA_DATE, "    
    SET @ISSUBLEVEL = 'YES'    
   END    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   SET @STRSELECTTEMP = ''    
  END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/    
  ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/    
  BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/    
   IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) CLIENT_TYPE, MAX(EMAIL) EMAIL, " END    
   IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + " AREA, " END    
   IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + " REGION, " END    
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + " BRANCH_CODE, " END    
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + " SUB_BROKER, " END    
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + " TRADER, " END    
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + " FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END    
  END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/    
  --PQTY    
  SET @STRSELECTTEMP = ''    
  IF @POSITIONAS = 'LOT'
	  BEGIN
		  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) " 
	  END
  ELSE
	  BEGIN
		  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) " 
	  END
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ " --FOR THE SUB TOTAL    
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "    
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  --SQTY    
  SET @STRSELECTTEMP = ''    
  IF @POSITIONAS = 'LOT'
        BEGIN
		  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
	END
  ELSE
	BEGIN
		  SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END) "
        END

  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ " --FOR THE SUB TOTAL    
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "    
  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  --EX_REPORTBY IS ALYAYS 'PRICE' FOR THIS REPORT, SO THE CODE BLOCS FOR 'IF (@EX_REPORTBY = 'PRICE')' AND    
  IF (@EX_REPORTBY = 'STRIKE')    
  BEGIN    
   --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
   SET @STRSELECTTEMP = ''    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "       
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "    
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
   SET @STRSELECTTEMP = ''    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "       
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "    
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   --NETQTY - FOR THE NET POS REPORT    
   SET @STRSELECTTEMP = ''    
  IF @POSITIONAS = 'LOT'
        BEGIN
	   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "    
	END
  ELSE
	BEGIN
	   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
	END
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   --NET VALUE- FOR THE NET POS REPORT    
   SET @STRSELECTTEMP = ''    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "       
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) - "    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END "       
   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END END)) "    
   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   --AVG. PRICE - FOR THE NET POS REPORT    
   SET @STRSELECTTEMP = ''    
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
	
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "   
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (PQTY*STRIKE_PRICE*) ELSE 0 END "       
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE) ELSE 0 END END)) - "    
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "    
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "CASE WHEN TRADETYPE = 'BT' THEN (SQTY*STRIKE_PRICE) ELSE 0 END "       
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE) ELSE 0 END END)) ) /  "    
			   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "    
	
		END
	ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END

   SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
   SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "    
   SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  END    
      
  IF (@EX_RATE = 'MKTRATE')    
  BEGIN    
   --IF (@EX_REPORTBY = 'BOTH') ARE OMITED    
   IF (@EX_REPORTBY = 'PRICE')    
   BEGIN    
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NETQTY - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    

  IF @POSITIONAS = 'LOT'
        BEGIN
	   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "    
	END
  ELSE
	BEGIN
	   SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
	END

    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NET VALUE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --AVG. PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN PRATE*PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SRATE*SQTY ELSE 0 END))/ "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "    
		END
	ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END
			
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "    
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
   IF (@EX_REPORTBY = 'BOTH')    
   BEGIN    
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
     
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR ELSE 0 END) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NETQTY - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    

   IF @POSITIONAS = 'LOT'
	 BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "    
	 END
   ELSE
	BEGIN
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
	END	

    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NET VALUE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --AVG. PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+PRATE) *PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE+SRATE) *SQTY ELSE 0 END))/ "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "    
		END
	ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
  END /*IF (@EX_RATE = 'NETRATE')*/    
  /*EX_RATE IS ALYAYS 'NETRATE' IN THIS REPORT, SO THE CODE BLOC FOR 'IF (@EX_RATE = 'NETRATE') IS OMITTED*/    
  IF (@EX_RATE = 'NETRATE')    
  BEGIN    
   --IF (@EX_REPORTBY = 'BOTH') ARE OMITED    
   IF (@EX_REPORTBY = 'PRICE')    
   BEGIN    
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
        
    --NETQTY - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
   IF @POSITIONAS = 'LOT'
	 BEGIN
            SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "    
         END
   ELSE
         BEGIN
            SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
         END
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NET VALUE- FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA        SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --AVG. PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN PAMT *DENOMINATOR/NUMERATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SAMT *DENOMINATOR/NUMERATOR ELSE 0 END))/ "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "    
		END
	ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
   IF (@EX_REPORTBY = 'BOTH')    
   BEGIN    
    --PAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT ELSE 0 END) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
     
    --SAMT - NETRATE + PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT ELSE 0 END) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - NETRATE + PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NETQTY - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    

   IF @POSITIONAS = 'LOT'
	 BEGIN
	    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "    
         END
   ELSE
	 BEGIN
	    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN  CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN  CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
         END

    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --NET VALUE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
    SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT ELSE 0 END)) "    
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET VALUE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
    --AVG. PRICE - FOR THE NET POS REPORT    
    SET @STRSELECTTEMP = ''    
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
		BEGIN
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) <> 0 "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY)+PAMT *DENOMINATOR/NUMERATOR ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY)+SAMT *DENOMINATOR/NUMERATORELSE 0 END))/ "    
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "    
		END
	ELSE
		BEGIN
			SET @STRSELECTTEMP = '0'
		END
    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE - FOR THE NET POS REPORT */ " --FOR THE SUB TOTAL -  - LAST ONE FOR THE NET POS REPORT W/O ENDING COMMA    
    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "    
    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
   END    
  END /*IF (@EX_RATE = 'NETRATE')*/      
  --NET OPEN VALUE (CL. PRICE)    
  SET @STRSELECTTEMP = ''    
  SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN (PQTY - SQTY) ELSE 0 END)*(CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN CL_RATE * NUMERATOR / DENOMINATOR ELSE 0 END))  "    
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET OPEN VALUE (CL. PRICE) */ " --FOR THE SUB TOTAL    
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETOPENVALUE, "    

  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  --CL. PRICE    
  SET @STRSELECTTEMP = ''    
  SET @STRSELECTTEMP = @STRSELECTTEMP + "  (CASE WHEN SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN PQTY+SQTY ELSE 0 END)) <> 0 THEN ABS(SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN (PQTY + SQTY) ELSE 0 END)*(CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN CL_RATE ELSE 0 END)) / SUM((CASE WHEN SAUDA_DATE LIKE '" + @TODATE + "%' THEN PQTY + SQTY ELSE 0 END))) ELSE 0 END )"    
  SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CL. PRICE */ " --FOR THE SUB TOTAL    
  SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEPRICE "      

  SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  SET @STRSELECTTEMP = ""    
  SET @STRFROM = @STRFROM + " INTO ##FOSAUDASUMMARY "
  SET @STRFROM = @STRFROM + "FROM "    
  SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK)"    
     
  SET @STRWHERE = @STRWHERE + "WHERE "    
     
  SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "    
  SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "    
  IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END    
  SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "    
  SET @STRWHERE = @STRWHERE + "EXPIRYDATE >= '" + @TODATE + "' AND "    
  SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "    
  IF (@FROMCODE = '' AND @TOCODE = '')    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') LIKE '%' AND "    
  END    
  ELSE    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') >= '" + @FROMCODE + "' AND "    
   SET @STRWHERE = @STRWHERE + "ISNULL(" + @CODEID + ",'') <= '" + @TOCODE + "' AND "    
  END    
  IF (@FROMDATE = '' AND @TODATE = '')    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "    
  END    
  ELSE    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "    
  END    
  IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))    
  BEGIN    
   SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "    
   SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "    
  END    
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "
	
/*END - LOGIN CONDITIONS*/
  SET @COMMA = ''    
  SET @STRGROUPBY = @STRGROUPBY + @COMMA    
      
  IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))    
  BEGIN    
   IF (@GROUPLEVEL = 'PARTY')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "    
    SET @COMMA = ', '    
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END    
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END    
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END    
   END    
       
   IF (@GROUPLEVEL = 'SCRIP')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
    SET @COMMA = ', '    
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END    
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END    
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY  END    
   END    
     
   IF (@GROUPLEVEL = 'DATE')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "    
    SET @COMMA = ', '    
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END    
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END    
    IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END    
   END    
     
   IF (@GROUPLEVEL = 'INSTTYPE')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "    
    SET @COMMA = ', '    
    IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END    
    IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END    
    IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END    
   END    
     
   IF (@GROUPLEVEL = 'PSD')    
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE,  SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "    
    SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE "    
--    SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "    
   END    
  END /*IF (@ONEORMANY = 'DETAIL')*/    
  ELSE /*IF (@ONEORMANY = 'DETAIL')*/    
  BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/    
   IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END    
   IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + " AREA " END    
   IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + " REGION " END    
   IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + " BRANCH_CODE " END    
   IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " SUB_BROKER " END    
   IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " TRADER " END    
   IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + " FAMILY " END    
  END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/    
  SET @STRORDERBY = @STRGROUPBY     
  IF @CMCLOSING <> ''     
   BEGIN    
    SET @STRGROUPBY = @STRGROUPBY  + ",CMCLOSING "    
   END    
IF @STRGROUPBY=''
BEGIN
  SET @STRGROUPBY =  " HAVING (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) <> 0 "    
END
ELSE
BEGIN
  SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY  + " HAVING (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)-SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) <> 0 "    
END 
  SET @STRORDERBY = "ORDER BY " + @STRORDERBY    
 END/*IF (@REPORTNAME = "NETPOSITION")*/    
 IF @STRCOMPUTESUB <> ''     
 BEGIN     
  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB     
  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB    
 END    
    
 IF LTRIM(RTRIM(@STRORDERBY)) ='ORDER BY'
    BEGIN
	SET @STRORDERBY = @STRORDERBY + " 1 "
    END

IF LTRIM(RTRIM(@STRGROUPBY)) = 'GROUP BY'
BEGIN
  SET @STRGROUPBY =''
END

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
 IF (@ISSUBLEVEL = 'YES')    
 BEGIN    
	  --PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
	  --EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
	  SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY)
 END    
 ELSE    
 BEGIN    
	  --PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
	  --EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
	  SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY)
 END    




	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY

	PRINT @STRSQL
	EXEC (@STRSQL)
	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	
	IF @GROUPSUBLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
	END
	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	
	--select * from ##FOSAUDASUMMARY
	INSERT INTO #TMPSUMMARY
	EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	

	DECLARE @PARTYWISE_CURSOR	CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY " 
		SET @STRSQL = @STRSQL + "WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		--PRINT @STRSQL
		EXEC (@STRSQL)

		SET @STRSQL = "SELECT "
		SET @STRSQL = @STRSQL + "SUM = SUM(PQTY), "  
		SET @STRSQL = @STRSQL + "SUM = SUM(SQTY), "  
		SET @STRSQL = @STRSQL + "SUM = SUM(PAMT), "  
		SET @STRSQL = @STRSQL + "SUM = SUM(SAMT), "  
		SET @STRSQL = @STRSQL + "SUM = SUM(NETQTY), "
		SET @STRSQL = @STRSQL + "SUM = SUM(NETVALUE), "
		SET @STRSQL = @STRSQL + "SUM = SUM(0), "
		SET @STRSQL = @STRSQL + "SUM = SUM(NETOPENVALUE), "
		SET @STRSQL = @STRSQL + "SUM = SUM(0) "
		SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
		
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR


	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " SELECT "
	SET @STRSQL = @STRSQL + " SUM = SUM(PQTY), "  
	SET @STRSQL = @STRSQL + " SUM = SUM(SQTY), "  
	SET @STRSQL = @STRSQL + " SUM = SUM(PAMT), "  
	SET @STRSQL = @STRSQL + " SUM = SUM(SAMT), "  
	SET @STRSQL = @STRSQL + " SUM = SUM(NETQTY), "
	SET @STRSQL = @STRSQL + " SUM = SUM(NETVALUE), "
	SET @STRSQL = @STRSQL + " SUM = SUM(0), "
	SET @STRSQL = @STRSQL + " SUM = SUM(NETOPENVALUE), "
	SET @STRSQL = @STRSQL + " SUM = SUM(0) "
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "

	--PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWNETPOSITION_PARENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWNETPOSITION    SCRIPT DATE: 3/2/2009 5:38:25 PM ******/


CREATE      PROC [DBO].[RPT_PROC_FO_NEWNETPOSITION_PARENT]
(
	 @REPORTNAME VARCHAR(50),    
	 @STATUSID VARCHAR(20),    
	 @STATUSNAME VARCHAR(50),    
	 @GROUPLEVEL VARCHAR(10), 	--FOR TOP LEVEL REPORT    
	 @GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS    
	 @ORDERLEVEL VARCHAR(10), 	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	 @ORDERSUBLEVEL VARCHAR(10), 	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	 @FROMDATE VARCHAR(11),    
	 @TODATE VARCHAR(11),    
	 @WHATCODE VARCHAR(20),  	--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
	 @FROMCODE VARCHAR(20),    
	 @TOCODE VARCHAR(20),    
	 @FROMPARTYCODE VARCHAR(20), 	--> FOR THE FROM AND TO PARTY CODES    
	 @TOPARTYCODE VARCHAR(20), 	--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
	 @ONEORMANY VARCHAR(20),    
	 @INSTTYPE VARCHAR(20),  
	 @OPTIONTYPE VARCHAR(20),
	 @STRIKEPRICE MONEY,  		--> PRIMARY SEARCH FIELDS.    
	 @EXPIRYDATE VARCHAR(11),
	 @SYMBOL VARCHAR(20), 
	 @EX_BILLTYPE VARCHAR(1), 	--> (SINGLE/MULTIPLE) - BILL
	 @EX_AUCTIONPART VARCHAR(20), 	--> SAUDASUMMARY 
	 @EX_REPORTBY VARCHAR(20), 	--> (MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
	 @EX_RATE VARCHAR(20),  	--> (PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
	 @EX_MONEYTYPE VARCHAR(1), 	--> (IN/AT/OUT) - IN THE MONEY   
	 @EX_POSITION VARCHAR (1), 	--> (LONG/SHORT) - IN THE MONEY  
	 @CMCLOSING VARCHAR (2)='', 	--> (LONG/SHORT) - IN THE MONEY 
	 --END REPORT SPECIFIC SEARCH FEILDS    
	 @DUMMY001 VARCHAR(1),    
	 @DUMMY002 VARCHAR(1),    
	 @DUMMY003 VARCHAR(1),    
	 @DUMMY004 VARCHAR(1),    
	 @DUMMY005 VARCHAR(1),    
	 @DUMMY006 VARCHAR(1),    
	 @DUMMY007 VARCHAR(1),    
	 @DUMMY008 VARCHAR(1),    
	 @DUMMY009 VARCHAR(1),    
	 @DUMMY010 VARCHAR(1), 
	 @DUMMY011 VARCHAR(1)=''    
)
AS
DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)

	SET @INSTTYPE = @INSTTYPE+"%" 
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'

	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_REPORTBY = 'EXCHG' BEGIN SET @EX_REPORTBY = "BOTH" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT 
	END 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END    
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END    
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END    
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END    
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END    
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END    
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END 
	
	IF @CMCLOSING <> ''     
	BEGIN    
		SET @STRSELECT = @STRSELECT + "SELECT CMCLOSING, "     
	END    
	ELSE    
	BEGIN    
		SET @STRSELECT = @STRSELECT + "SELECT "     
	END    
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "    
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))    
	BEGIN    
		SET @STRSELECTTEMP = ''    
		IF (@GROUPLEVEL = 'PARTY')  
		BEGIN    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN_PARENT.EMAIL) EMAIL, "    
			IF (@GROUPSUBLEVEL = 'PARTY')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN_PARENT.EMAIL) EMAIL ,"    
				SET @ISSUBLEVEL = 'YES'    
			END   
			IF (@GROUPSUBLEVEL = 'SCRIP')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "    
				SET @ISSUBLEVEL = 'YES'    
			END    		
			IF (@ISSUBLEVEL = 'YES')    
			BEGIN    
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "    
			END    
		END    
		IF (@GROUPLEVEL = 'SCRIP')    
		BEGIN    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "    
			IF (@GROUPSUBLEVEL = 'PARTY')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN_PARENT.EMAIL) EMAIL, "    
				SET @ISSUBLEVEL = 'YES'    
			END    
			IF (@ISSUBLEVEL = 'YES')    
			BEGIN    
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,112), EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
			END    
		END    
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
		SET @STRSELECTTEMP = ''    
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN_PARENT.EMAIL) EMAIL , " END    
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + " AREA, " END    
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + " REGION, " END    
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + " BRANCH_CODE, " END    
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + " SUB_BROKER, " END    
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + " TRADER, " END    
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + " FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END    
	END 

	--PQTY
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--SQTY
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SQTY) "
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	IF (@EX_REPORTBY = 'STRIKE')
	BEGIN
		--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE*NUMERATOR/DENOMINATOR) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE*NUMERATOR/DENOMINATOR) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NETQTY - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NET VALUE- FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) - "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) "			

		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--AVG. PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				IF (@EX_RATE = 'MKTRATE')
					BEGIN
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE*NUMERATOR/DENOMINATOR) - (SQTY*SRATE*NUMERATOR/DENOMINATOR)) )/ "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
						/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE*NUMERATOR/DENOMINATOR)/SUM(PQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE*NUMERATOR/DENOMINATOR)/SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
					END
				ELSE
					BEGIN
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM((PAMT - SAMT) )/ "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
						/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
					END
			END
		ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	END
	
	IF (@EX_RATE = 'MKTRATE')
	BEGIN
		--IF (@EX_REPORTBY = 'BOTH') ARE OMITED
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PRATE*PQTY*NUMERATOR/DENOMINATOR)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SRATE*SQTY*NUMERATOR/DENOMINATOR)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PRATE*PQTY*NUMERATOR/DENOMINATOR) - SUM(SRATE*SQTY*NUMERATOR/DENOMINATOR)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE*NUMERATOR/DENOMINATOR) - (SQTY*SRATE*NUMERATOR/DENOMINATOR)) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE*NUMERATOR/DENOMINATOR)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE*NUMERATOR/DENOMINATOR)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE+PRATE) *PQTY*NUMERATOR/DENOMINATOR) - SUM((STRIKE_PRICE+SRATE) *SQTY*NUMERATOR/DENOMINATOR)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE*NUMERATOR/DENOMINATOR) - (SQTY*SRATE*NUMERATOR/DENOMINATOR)) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE*NUMERATOR/DENOMINATOR)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE*NUMERATOR/DENOMINATOR)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END
	IF (@EX_RATE = 'NETRATE')
	BEGIN
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE- FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PAMT) - SUM(SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM((PAMT-SAMT) ))/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) - SUM((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM((PAMT - SAMT) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"*/
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END	/*IF (@EX_RATE = 'NETRATE')*/		
	--NET OPEN VALUE (CL. PRICE)
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM((PQTY - SQTY)*CL_RATE*NUMERATOR/DENOMINATOR)  "
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETOPENVALUE, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--CL. PRICE
	SET @STRSELECTTEMP = ''
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + "  (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END )"
	END
	ELSE
	BEGIN
		SET @STRSELECTTEMP = '0'
	END

	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEPRICE "		

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " , EXPIRYORD = CONVERT(VARCHAR,EXPIRYDATE,112) "       
	END

	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	SET @STRSELECTTEMP = ""

	SET @STRFROM = @STRFROM + "FROM "
	SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK), FOOWNER (NOLOCK) "

	SET @STRWHERE = @STRWHERE + "WHERE MEMBERCODE = PARTICIPANTCODE AND "    	
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
	IF (@FROMCODE = '' AND @TOCODE = '')
	BEGIN
		SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "
		SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "
	END
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
	END
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
	BEGIN
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
	END
	/*LOGIN CONDITIONS*/
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	SET @COMMA = ''    
	SET @STRGROUPBY = @STRGROUPBY + @COMMA    
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))    
	BEGIN    
		IF (@GROUPLEVEL = 'PARTY')    
		BEGIN    
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE  "    
			SET @COMMA = ', '    
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END    
		END    			
		IF (@GROUPLEVEL = 'SCRIP')    
		BEGIN    
			SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
			SET @COMMA = ', '    
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END    
		END    
	END
	ELSE 
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE  " END    
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + " AREA " END    
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + " REGION " END    
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + " BRANCH_CODE " END    
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " SUB_BROKER " END    
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " TRADER " END    
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + " FAMILY " END    
	END

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")

		IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
		BEGIN
			SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "      
		END	
	END
	/*
	ELSE
			SET @STRGROUPBY = @STRGROUPBY + " CONVERT(VARCHAR,EXPIRYDATE,112)"
	*/

	SET @STRORDERBY = @STRGROUPBY
	IF @CMCLOSING <> ''     
	BEGIN    
		SET @STRGROUPBY = @STRGROUPBY  + ",CMCLOSING "    
	END
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING SUM(PQTY - SQTY) <> 0 "
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END	
	IF LTRIM(RTRIM(@STRGROUPBY)) = 'GROUP BY'
	BEGIN
		SET @STRGROUPBY =''
	END
	
	IF (@ISSUBLEVEL = 'YES')    
	BEGIN    
		PRINT (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
		EXEC (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
	END    
	ELSE    
	BEGIN    
		PRINT (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
		EXEC (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewReports
-- --------------------------------------------------

--EXEC rpt_proc_FO_NewReports 'SAUDASUMMARY', 'BROKER', 'BROKER', 'PARTY', 'PARTY', '', '', 'Mar 30 2023', 'Mar 30 2023', 'CLIENT', '0', 'ZZZZZZZZZ', '', '', 'DETAIL', '', '', -1, '', 'NATURALGAS', '', '', 'PRICE', 'MKTRATE', '', '', '', '', '', '', '', '', '', '', '', ''  

CREATE      PROC        
[dbo].[rpt_proc_FO_NewReports]      
 @ReportName VarChar(50),        
 @StatusID VarChar(20),        
 @StatusName VarChar(50),        
 @GroupLevel VarChar(10), --FOR TOP LEVEL REPORT        
 @GroupSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS        
 @OrderLevel VarChar(10), --FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @OrderSubLevel VarChar(10), --FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY        
 @FromDate VarChar(11),        
 @ToDate VarChar(11),        
 @WhatCode varChar(20),  --REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT        
 @FromCode VarChar(20),        
 @ToCode VarChar(20),        
 @FromPartyCode VarChar(20), --]--> FOR THE FROM AND TO PARTY CODES        
 @ToPartyCode VarChar(20), --]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'        
 @OneOrMany VarChar(20),        
 @InstType VarChar(20),  --]        
 @OptionType VarChar(20), --]        
 @StrikePrice Money,  --]--> PRIMARY SEARCH FIELDS.        
 @ExpiryDate VarChar(11), --]        
 @Symbol VarChar(20),  --]        
 --REPORT SPECIFIC SEARCH FEILDS        
 --PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)            
 @Ex_BillType VarChar(1), --(SINGLE/MULTIPLE) - BILL      ]        
 @Ex_AuctionPart VarChar(20), --SAUDASUMMARY       ]        
 @Ex_ReportBy VarChar(20), --(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC        
 @Ex_Rate VarChar(20),  --(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS        
 @Ex_MoneyType VarChar(1), --(IN/AT/OUT) - IN THE MONEY      ]        
 @Ex_Position VarChar (1), --(LONG/SHORT) - IN THE MONEY     ]        
 --END REPORT SPECIFIC SEARCH FEILDS        
 @Dummy001 VarChar(50),        
 @Dummy002 VarChar(50),        
 @Dummy003 VarChar(50),        
 @Dummy004 VarChar(50),        
 @Dummy005 VarChar(50),        
 @Dummy006 VarChar(50),        
 @Dummy007 VarChar(50),        
 @Dummy008 VarChar(50),        
 @Dummy009 VarChar(50),        
 @Dummy010 VarChar(50)        
AS        
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
    
    
if @Ex_ReportBy ='EXCHG'    
Begin    
 Set @Ex_ReportBy ='BOTH'     
End    
    
Declare        
 @strSelect VarChar(8000),        
 @strSelectTemp VarChar(8000),        
 @strFrom VarChar(8000),        
 @strWhere VarChar(8000),        
 @strGroupBy VarChar(8000),        
 @strOrderBy VarChar(8000),        
 @strCompute VarChar(8000),        
 @strComputeSub VarChar(8000),        
 @strHaving Varchar(2000),        
 @IsSubLevel VarChar(3),        
 @CodeID VarChar(20),        
 @Comma VarChar(1)        
 Set @InstType = @InstType+"%"         
 If @OptionType = '' Begin Set @OptionType = "%" End        
 --If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE        
 If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End        
 If @Symbol = '' Begin Set @Symbol = "%" End        
 If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End        
 If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End        
 If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End        
 Set @strSelect = ''        
 Set @strSelectTemp = ''        
 Set @strFrom = ''        
 Set @strWhere = ''        
 Set @strGroupBy = ''        
 Set @strOrderBy = ''        
 Set @strCompute = ''        
 Set @strComputeSub = ''        
 Set @IsSubLevel = 'NO'        
        
        
            
 if (@GroupSubLevel ='DATE' and @GroupLevel = 'SCRIP')         
  begin        
   Set @GroupLevel = 'DATE'   
   Set @GroupSubLevel ='SCRIP'         
        
  end        
           
        
        
 If (@FromDate = '' AND @ToDate = '')        
 Begin         
  Select @FromDate = Left(Convert(Varchar,Min(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From FoBillValan         
 End         
 --Select @FromDate = Left(Convert(Varchar,isnull(min(Sauda_Date),@fromdate),109),11) From FoBillValan where Sauda_Date >=  @FromDate     
  Select @FromDate = Left(Convert(Varchar,min(Sauda_Date),109),11) From FoBillValan where Sauda_Date >=  @FromDate     
    
 If (@ReportName = 'SAUDASUMMARY')        
 Begin        
  If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End        
  If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End        
  If (@WhatCode = 'AREA') Begin Set @CodeID = 'Area' End        
  If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End        
  If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End        
  If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End        
  If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End        
          
  Set @strSelect = @strSelect + "SELECT "        
  Set @strCompute = @strCompute + "COMPUTE "        
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))        
  Begin        
   Set @strSelectTemp = ''        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type, email, "        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'INSTTYPE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "inst_type, "        
     Set @IsSubLevel = 'YES'        
    End        
            
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "party_code "        
    End        
   End        
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'INSTTYPE')        
    Begin        
     --Set @strSelectTemp = @strSelectTemp + "inst_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "symbol, inst_type, expirydate, strike_price, option_type "        
    End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'INSTTYPE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "inst_type, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + " Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date) "        
    End        
   End        
         
   If (@GroupLevel = 'INSTTYPE')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "inst_type, "        
    If (@GroupSubLevel = 'PARTY')        
    Begin        
  Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type,  email, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@GroupSubLevel = 'SCRIP')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "symbol, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "        
     Set @IsSubLevel = 'YES'        
   End        
    If (@GroupSubLevel = 'DATE')        
    Begin        
     Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "        
     Set @IsSubLevel = 'YES'        
    End        
    If (@IsSubLevel = 'YES')        
    Begin        
     Set @strComputeSub = @strComputeSub + "inst_type "        
    End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strSelectTemp = @strSelectTemp + "party_code, Left(party_name,20) AS party_name, client_type, email, symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "        
    Set @strSelectTemp = @strSelectTemp + "option_type, Convert(VarChar,sauda_date,103) AS sauda_date,YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "        
    Set @IsSubLevel = 'YES'        
   End        
   Set @strSelect = @strSelect + @strSelectTemp        
   Set @strSelectTemp = ''        
  End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
   If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, Left(party_name,20) AS party_name, client_type, email, " End        
   If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "Area, " End        
   If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End        
   If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End        
   If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End        
   If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End        
  End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/        
  --OPENQTY        
  Set @strSelectTemp = ''        
  if @GroupLevel = 'DATE' OR @GroupSubLevel ='DATE'    
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When /*sauda_date like '" + @FromDate + "%' And*/ tradetype = 'BF' Then pqty-sqty Else 0 End)) "         
   ----Set @strCompute = @strCompute + "Sum(0), /* OPEN QTY */ " --FOR THE SUB TOTAL        
      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  End        
  Else        
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When sauda_date like '" + @FromDate + "%' And  tradetype = 'BF' Then pqty-sqty Else 0 End)) "         
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPEN QTY */ " --FOR THE SUB TOTAL        
  End        
  Set @strSelectTemp = @strSelectTemp + "AS openqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --PQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* P.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS pqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --SQTY        
  Set @strSelectTemp = ''        
  Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "        
  Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* S.QTY */ " --FOR THE SUB TOTAL        
  Set @strSelectTemp = @strSelectTemp + "AS sqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  If (@Ex_Rate = 'MKTRATE')        
  Begin        
   If (@Ex_ReportBy = 'STRIKE')        
   Begin        
    --PAMT - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty*Numerator/Denominator) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
          
    --PRATE - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty*Numerator/Denominator) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty*Numerator/Denominator) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty*Numerator/Denominator) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + " Then ((Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) End)) ) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SRATE - MKTRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
  Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (prate*pqty*Numerator/Denominator) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then (prate*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (srate*sqty) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT'  Then ((strike_price+prate)*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty*Numerator/Denominator) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty*Numerator/Denominator) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then ((strike_price+prate)*pqty) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price+srate)*sqty) Else 0 End)) )/ "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'MKTRATE')*/        
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   If (@Ex_ReportBy = 'STRIKE')        
   Begin        
    --PAMT - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --PRATE - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt*Denominator/Numerator) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SRATE - NETRATE + STRIKE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt*Denominator/Numerator) Else 0 End) End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - NETRATE + STRIKE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty*Numerator/Denominator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt) Else 0 End) End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*pqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (pamt*Denominator/Numerator) Else 0 End) End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When Inst_Type LIKE 'OPT%' Then "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (strike_price*sqty) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "Else "        
    Set @strSelectTemp = @strSelectTemp + "(Case When tradetype = 'BT' Then (samt*Denominator/Numerator) Else 0 End) End)) ) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'PRICE')        
   Begin        
    --PAMT - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp       
    --PRATE - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt*Denominator/Numerator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End)"        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SAMT - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - NETRATE + PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then"        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt*Denominator/Numerator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SQTY - NETRATE + PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then (pamt*Denominator/Numerator) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (samt*Denominator/Numerator) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
   If (@Ex_ReportBy = 'BOTH')        
   Begin        
    --PAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*pqty*Numerator/Denominator)+pamt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS pamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --PRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then pqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT'  Then ((strike_price*pqty)+pamt*Denominator/Numerator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End)) Else 0 End) "         
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS prate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
         
    --SAMT - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty*Numerator/Denominator)+samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SAMT - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS samt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --SRATE - MKTRATE + BOTH        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then sqty Else 0 End) > 0 Then "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt*Denominator/Numerator) Else 0 End) "        
    Set @strSelectTemp = @strSelectTemp + "/ "        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SRATE - MKTRATE + BOTH */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS srate, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETQTY        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETQTY */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netqty, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --NETAMT        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*pqty*Numerator/Denominator)+pamt) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty*Numerator/Denominator)+samt) Else 0 End)) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* NETAMT */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS netamt, "        
    Set @strSelect = @strSelect + @strSelectTemp        
    --AVG. PRICE        
    Set @strSelectTemp = ''        
    Set @strSelectTemp = @strSelectTemp + "(Case When Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End) <> 0 "        
    Set @strSelectTemp = @strSelectTemp + "Then ((Sum(Case When tradetype = 'BT' Then ((strike_price*pqty)+pamt*Denominator/Numerator) Else 0 End)) - "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then ((strike_price*sqty)+samt*Denominator/Numerator) Else 0 End))) / "        
    Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then (pqty) Else 0 End) - Sum(Case When tradetype = 'BT' Then (sqty) Else 0 End)) Else 0 End) "        
    Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL        
    Set @strSelectTemp = @strSelectTemp + "AS avgprice, "        
    Set @strSelect = @strSelect + @strSelectTemp        
   End        
  End /*If (@Ex_Rate = 'NETRATE')*/        
  --CLOSEQTY        
  Set @strSelectTemp = ''        
  if @GroupLevel = 'DATE' OR @GroupSubLevel ='DATE'    
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When /*sauda_date like '" + @FromDate + "%' And*/ tradetype = 'BF' Then pqty-sqty Else 0 End)) + "         
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "         
     ---Set @strCompute = @strCompute + "Sum(0), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
	      Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL        
  End        
  Else        
  Begin        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When sauda_date like '" + @FromDate + "%' And tradetype = 'BF' Then pqty-sqty Else 0 End)) + "         
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then pqty Else 0 End)) - "        
   Set @strSelectTemp = @strSelectTemp + "(Sum(Case When tradetype = 'BT' Then sqty Else 0 End)) "         
     ---Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL   
	 Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLOSEQTY */ " --FOR THE SUB TOTAL      
  End        
    Set @strSelectTemp = @strSelectTemp + "AS closeqty, "        
  Set @strSelect = @strSelect + @strSelectTemp        
  --PROFIT/LOSS        
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp +" Sum(SBillAmt - PBillAmt)  - (Sum(service_tax- ExSer_Tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* PROFIT/LOSS */ "        
   Set @strSelectTemp = @strSelectTemp + "AS profitorloss, "        
   if (@GroupSubLevel ='SCRIP' or @GroupLevel = 'SCRIP')      and (@FromDate  = @ToDate )    
    begin        
     Set @strSelectTemp = @strSelectTemp + " cl_rate = (Case When Sum(PQty+SQty) <> 0 Then  Abs(Sum((pqty + sqty)*Cl_Rate) / Sum(pqty + sqty)) Else 0 End ) "         
    end        
   else        
    begin        
     Set @strSelectTemp = @strSelectTemp + " cl_rate = 0 "         
    end        
   Set @strSelect = @strSelect + @strSelectTemp        
  End        
  Else        
  Begin        
   Set @strSelectTemp = ''        
   Set @strSelectTemp = @strSelectTemp +" Sum(SBillAmt - PBillAmt + PBrokAmt + SBrokAmt) "        
   Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* PROFIT/LOSS */ "        
   Set @strSelectTemp = @strSelectTemp + "AS profitorloss, "        
        
   if (@GroupSubLevel ='SCRIP' or @GroupLevel = 'SCRIP')      and (@FromDate  = @ToDate )    
    begin        
     Set @strSelectTemp = @strSelectTemp + " cl_rate = (Case When Sum(PQty+SQty) <> 0 Then  Abs(Sum((pqty + sqty)*Cl_Rate) / Sum(pqty + sqty)) Else 0 End ) "         
    end        
   else        
    begin        
     Set @strSelectTemp = @strSelectTemp + " cl_rate = 0 "         
    end        
           
   Set @strSelect = @strSelect + @strSelectTemp        
  End        
  Set @strSelectTemp = ""        
 SET @STRFROM = @STRFROM + " INTO ##FOSAUDASUMMARY "
 Set @strFrom = @strFrom + "FROM "   
 Set @strFrom = @strFrom + "FoBillValan (nolock)"               
  --Set @strFrom = "FROM FoBillValan (nolock)"          
         
  Set @strWhere = @strWhere + "WHERE "         
  Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "        
  Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "        
  If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End        
  Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "        
  Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND "        
  Set @strWhere = @strWhere + "AuctionPart Like '" + @Ex_AuctionPart + "' AND  "        
  --Set @strWhere = @strWhere + "TradeType Like (Case When AuctionPart = 'EA' Then 'BT' Else '%' End ) And "          
  If (@FromCode = '' AND @ToCode = '')          
  Begin          
   Set @strWhere = @strWhere + " isnull(" + @CodeID + ",'') LIKE '%' AND "          
  End          
  Else          
  Begin          
   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') >= '" + @FromCode + "' AND "          
   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') <= '" + @ToCode + "' AND "          
  End      
  If (@FromDate = '' AND @ToDate = '')        
  Begin        
   Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "        
  End        
  Else        
  Begin        
   Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "        
   Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "        
  End        
  If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))        
  Begin        
   Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "        
   Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "        
  End        
          
 /*LOGIN CONDITIONS*/           
     
 Set @strWhere = @strWhere + "'" + @STATUSNAME + "' = "    
 Set @strWhere = @strWhere + "  (CASE "    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"    
 Set @strWhere = @strWhere + "   WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"    
 Set @strWhere = @strWhere + "   ELSE "    
 Set @strWhere = @strWhere + "  'BROKER'"    
 Set @strWhere = @strWhere + "  END)    "    
    
/*END - LOGIN CONDITIONS*/    
  Set @Comma = ''        
  Set @strGroupBy = @strGroupBy + @Comma        
          
  If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))        
  Begin        
   If (@GroupLevel = 'PARTY')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
    If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End        
   End        
           
   If (@GroupLevel = 'SCRIP')        
   Begin        
    Set @strGroupBy = @strGroupBy + "symbol, inst_type, expirydate, strike_price, option_type "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
    If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "inst_type "*/ End        
   End        
         
   If (@GroupLevel = 'DATE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End        
    If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End        
   End        
         
   If (@GroupLevel = 'INSTTYPE')        
   Begin        
    Set @strGroupBy = @strGroupBy + "inst_type "        
    Set @Comma = ', '        
    If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code, party_name, client_type, email " End        
    If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, expirydate, strike_price, option_type " End        
    If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date),sauda_date " End        
   End        
         
   If (@GroupLevel = 'PSD')        
   Begin        
    Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email, symbol, inst_type, expirydate, strike_price, "        
    Set @strGroupBy = @strGroupBy + "option_type,Year(sauda_date),Month(Sauda_Date),Day(Sauda_Date) ,sauda_date "        
   End        
  End /*If (@OneOrMany = 'DETAIL')*/        
  Else /*If (@OneOrMany = 'DETAIL')*/        
  Begin /*Else OF If (@OneOrMany = 'DETAIL')*/        
   If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code, party_name, client_type, email " End        
   If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "Area " End        
   If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End       If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End        
   If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End        
   If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End        
   If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family,FamilyName " End        
  End /*Else OF If (@OneOrMany = 'DETAIL')*/        
  Set @strOrderBy = @strGroupBy        
  Set @strGroupBy = "GROUP BY " + @strGroupBy        
  Set @strOrderBy = "ORDER BY " + @strOrderBy        
         
  Set @strHaving = ' Having '         
  If (@Ex_Rate = 'NETRATE')        
  Begin        
   Set @strHaving = @strHaving +" Sum(SBillAmt - PBillAmt) - (Sum(service_tax) + Sum(turn_tax) + Sum(sebi_tax) + Sum(broker_note) + Sum(ins_chrg) + Sum(other_chrg)) <> 0 "        
  End        
  Else        
  Begin        
   Set @strHaving = @strHaving + " Sum(SBillAmt - PBillAmt + PBrokAmt + SBrokAmt) <> 0 "        
  End         
 End/*If (@ReportName = "SAUDASUMMARY")*/        
 Print 'ReportName : ' + @ReportName        
 Print 'StatusID : ' + @StatusID        
 Print 'StatusName : ' + @StatusName        
 Print 'GroupLevel : ' + @GroupLevel        
 Print 'GroupSubLevel : ' + @GroupSubLevel        
 Print 'OrderLevel : ' + @OrderLevel        
 Print 'OrderSubLevel : ' + @OrderSubLevel        
         
 Print 'FromDate : ' + @FromDate        
 Print 'ToDate : ' + @ToDate        
 Print 'WhatCode : ' + @WhatCode        
 Print 'FromCode : ' + @FromCode        
 Print 'ToCode : ' + @ToCode        
         
Print 'InstType : ' + @InstType        
 Print 'OptionType : ' + @OptionType        
 Print 'StrikePrice : ' + Convert(VarChar,@StrikePrice)        
 Print 'ExpiryDate : ' + @ExpiryDate        
 Print 'Symbol : ' + @Symbol        
         
 Print 'BillType : ' + @Ex_BillType        
 Print 'AuctionPart : ' + @Ex_AuctionPart        
 Print 'ReportBy : ' + @Ex_ReportBy        
 Print 'Rate : ' + @Ex_Rate        
 Print 'MoneyType : ' + @Ex_MoneyType        
 Print 'Position : ' + @Ex_Position        
         
 Print 'Dummy001 : ' + @Dummy001        
 Print 'Dummy002 : ' + @Dummy002        
 Print 'Dummy003 : ' + @Dummy003        
 Print 'Dummy004 : ' + @Dummy004        
 Print 'Dummy005 : ' + @Dummy005        
 Print 'Dummy006 : ' + @Dummy006        
 Print 'Dummy007 : ' + @Dummy007        
 Print 'Dummy008 : ' + @Dummy008        
 Print 'Dummy009 : ' + @Dummy009        
 Print 'Dummy010 : ' + @Dummy010        
 Print '==============================================================================================' 


   
 ---Print @strSelect         
    


     
 If @strComputeSub <> ''         
 Begin         
  Set @strComputeSub = "BY " + @strComputeSub         
  Set @strComputeSub = @strCompute + @strComputeSub        
 End        

 DECLARE @STRSQL VARCHAR(MAX)
 DECLARE @STRSQL_NEW VARCHAR(MAX)

 If (@IsSubLevel = 'YES')        
 Begin 
  ---Print (@strSelect + @strFrom + @strWhere + @strGroupBy + /*@strHaving +*/ @strOrderBy + @strComputeSub + @strCompute)        
  --Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + /*@strHaving +*/ @strOrderBy + @strComputeSub + @strCompute)        
    SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY)
 End        
 Else        
 Begin 
  ---Print (@strSelect + @strFrom + @strWhere + @strGroupBy + /*@strHaving +*/  @strOrderBy + @strCompute)        
  --Exec (@strSelect + @strFrom + @strWhere + @strGroupBy + /*@strHaving +*/  @strOrderBy + @strCompute)        
  SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING)
 End        
 /*
 Print @strSelect + @strFrom + @strWhere + @strGroupBy + /*@strOrderBy +*/  @strComputeSub + @strCompute        
 Print @strSelect         
 Print @strFrom        
 Print @strWhere        
 Print @strGroupBy        
 Print @strOrderBy        
 Print @strComputeSub        
 Print @strCompute
 */
 
 	PRINT @STRSQL
 
	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY
	EXEC (@STRSQL)
	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL IN ( 'PARTY','PSD') 
	BEGIN
		--SET @GROUPLEVEL_NEW = 'PARTY_CODE'
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @GROUPLEVEL_NEW = 'PARTY_CODE' END      
		IF (@WHATCODE = 'AREA') BEGIN SET @GROUPLEVEL_NEW = 'AREA' END      
		IF (@WHATCODE = 'REGION') BEGIN SET @GROUPLEVEL_NEW = 'REGION' END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @GROUPLEVEL_NEW = 'BRANCH_CODE' END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @GROUPLEVEL_NEW = 'SUB_BROKER' END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @GROUPLEVEL_NEW = 'TRADER' END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @GROUPLEVEL_NEW = 'FAMILY' END      
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT("0"+CONVERT(VARCHAR,DD),2)'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	
	IF @GROUPSUBLEVEL IN ( 'PARTY','PSD') 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
		IF @GROUPLEVEL = 'PARTY' BEGIN SET @GROUPLEVEL_NEW = 'PARTY_CODE' END
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT("0"+CONVERT(VARCHAR,DD),2)'
		IF @GROUPLEVEL = 'PARTY' BEGIN SET @GROUPLEVEL_NEW = 'PARTY_CODE' END
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
		IF @GROUPLEVEL = 'PARTY' BEGIN SET @GROUPLEVEL_NEW = 'PARTY_CODE' END
	END

	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	
	IF (@GROUPLEVEL = 'DATE')
	BEGIN
		INSERT INTO #TMPSUMMARY
		EXEC ("SELECT DISTINCT GROUPCODE=CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT('0'+CONVERT(VARCHAR,DD),2) FROM ##FOSAUDASUMMARY ORDER BY CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT('0'+CONVERT(VARCHAR,DD),2) ")
	END
	ELSE
	BEGIN
		INSERT INTO #TMPSUMMARY
		EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	END	
	

	--DECLARE @PARTYWISE_CURSOR	CURSOR

	--SET @PARTYWISE_CURSOR = CURSOR FOR
	--SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	--OPEN @PARTYWISE_CURSOR 
	--FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	--WHILE @@FETCH_STATUS = 0
	BEGIN
		--SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY ORDER BY YY,MM,DD " ---changed by Hrushikesh-31 02 2023
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY ORDER BY 2,3,4"
		--SET @STRSQL = @STRSQL + " ORDER BY "+ @GROUPLEVEL_NEW +" "
		--SET @STRSQL = @STRSQL + "WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		--SET @STRSQL = @STRSQL + " SELECT sum=SUM(0),sum=SUM(PQTY),sum=SUM(SQTY),sum=SUM(PAMT),sum=(CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END),"
		--SET @STRSQL = @STRSQL + " sum=SUM(SAMT),sum=(CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END),"
		--SET @STRSQL = @STRSQL + " sum=SUM(NETQTY),"
		--SET @STRSQL = @STRSQL + " sum=SUM(NETAMT),sum=SUM(0),"
		--SET @STRSQL = @STRSQL + " sum=SUM(0),"
		--SET @STRSQL = @STRSQL + " sum=SUM(PROFITORLOSS) "
		--SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		--SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		--SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
				 
	---	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	--CLOSE @PARTYWISE_CURSOR
	--DEALLOCATE @PARTYWISE_CURSOR

	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " SELECT sum=SUM(0),sum=SUM(PQTY),sum=SUM(SQTY),sum=SUM(PAMT),sum=(CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " sum=SUM(SAMT),sum=(CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " sum=SUM(NETQTY),"
	SET @STRSQL = @STRSQL + " sum=SUM(NETAMT),sum=SUM(0),"
	SET @STRSQL = @STRSQL + " sum=SUM(0),"
	SET @STRSQL = @STRSQL + " sum=SUM(PROFITORLOSS) "
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "
	
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewReports_bak_26042024
-- --------------------------------------------------


create PROCEDURE [dbo].[rpt_proc_FO_NewReports_bak_26042024]
(
	 @REPORTNAME VARCHAR(50),      
	 @STATUSID VARCHAR(20),      
	 @STATUSNAME VARCHAR(50),      
	 @GROUPLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT      
	 @GROUPSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS      
	 @ORDERLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @ORDERSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @FROMDATE VARCHAR(11),      
	 @TODATE VARCHAR(11),      
	 @WHATCODE VARCHAR(20),  		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	 @FROMCODE VARCHAR(20),      
	 @TOCODE VARCHAR(20),      
	 @FROMPARTYCODE VARCHAR(20), 		--]--> FOR THE FROM AND TO PARTY CODES      
	 @TOPARTYCODE VARCHAR(20), 		--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	 @ONEORMANY VARCHAR(20),      
	 @INSTTYPE VARCHAR(20),  		--]      
	 @OPTIONTYPE VARCHAR(20), 		--]      
	 @STRIKEPRICE MONEY,  			--]--> PRIMARY SEARCH FIELDS.      
	 @EXPIRYDATE VARCHAR(11), 		--]      
	 @SYMBOL VARCHAR(20), 			 --]      
	 @EX_BILLTYPE VARCHAR(1), 		--(SINGLE/MULTIPLE) - BILL      ]      
	 @EX_AUCTIONPART VARCHAR(20), 		--SAUDASUMMARY       ]      
	 @EX_REPORTBY VARCHAR(20), 		--(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	 @EX_RATE VARCHAR(20), 			--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	 @EX_MONEYTYPE VARCHAR(1), 		--(IN/AT/OUT) - IN THE MONEY      ]      
	 @EX_POSITION VARCHAR (1), 		--(LONG/SHORT) - IN THE MONEY     ]      
	 --END REPORT SPECIFIC SEARCH FEILDS      
	 @DUMMY001 VARCHAR(50),      
	 @DUMMY002 VARCHAR(50),      
	 @DUMMY003 VARCHAR(50),      
	 @DUMMY004 VARCHAR(50),      
	 @DUMMY005 VARCHAR(50),      
	 @DUMMY006 VARCHAR(50),      
	 @DUMMY007 VARCHAR(50),      
	 @DUMMY008 VARCHAR(50),      
	 @DUMMY009 VARCHAR(50),      
	 @DUMMY010 VARCHAR(50)      
)

AS      

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE      
	@STRSELECT VARCHAR(8000),      
	@STRSELECTTEMP VARCHAR(8000),      
	@STRSELECTAVRGRT VARCHAR(8000),      
	@STRSELECTCLOSEQTY VARCHAR(8000),      
	@STRFROM VARCHAR(8000),      
	@STRWHERE VARCHAR(8000),      
	@STRGROUPBY VARCHAR(8000),      
	@STRORDERBY VARCHAR(8000),      
	@STRCOMPUTE VARCHAR(8000),      
	@STRCOMPUTESUB VARCHAR(8000),      
	@STRHAVING VARCHAR(2000),      
	@ISSUBLEVEL VARCHAR(3),      
	@CODEID VARCHAR(20),      
	@COMMA VARCHAR(1)      
	SET @INSTTYPE = @INSTTYPE+"%"       
	SET @STRSELECT = ''      
	SET @STRSELECTTEMP = ''
	SET @STRSELECTAVRGRT = '' 
	SET @STRSELECTCLOSEQTY = ''     
	SET @STRFROM = ''      
	SET @STRWHERE = ''      
	SET @STRGROUPBY = ''      
	SET @STRORDERBY = ''      
	SET @STRCOMPUTE = ''      
	SET @STRCOMPUTESUB = ''      
	SET @ISSUBLEVEL = 'NO'      
	
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END     
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      

	IF @TODATE = ''      
	BEGIN       
		SELECT @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK)
	END 
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,ISNULL(MIN(SAUDA_DATE),@FROMDATE),109),11) FROM FOBILLVALAN  (NOLOCK) WHERE SAUDA_DATE >=  @FROMDATE 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
	SET @STRSELECT = @STRSELECT + "SELECT "      
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      	
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
			END      
		END      
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			END      
		END       
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS  EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "      
			END      
		END             
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
			END
		END       
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YEAR(SAUDA_DATE) AS YY,MONTH(SAUDA_DATE) AS MM,DAY(SAUDA_DATE) AS DD, "      
			SET @ISSUBLEVEL = 'YES'      
		END      
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		SET @STRSELECTTEMP = ''      
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END      
	END 
	--OPENQTY      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--PQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--SQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

	IF (@EX_RATE = 'MKTRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "    
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END 	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) )/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
	END 
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP         
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END  	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP     
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
	END

	--CLOSEQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''  

   
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END

	--PROFIT/LOSS      

	/*SET @STRSELECTTEMP = 'CONVERT (NUMERIC(36, 12),' 
	SET @STRSELECTTEMP = @STRSELECTTEMP + @STRSELECTAVRGRT + ')* CONVERT(INT,'+  @STRSELECTCLOSEQTY  + ') * MAX(NUMERATOR)/MAX(DENOMINATOR)'
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "  */    
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
	SET @STRSELECTTEMP = ''   
     

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  AND (@FROMDATE  = @TODATE )  
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ), EXTRA=0 "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0, EXTRA=0 "       
	END      
	--SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0)  "       

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " , EXPIRYORD = CONVERT(VARCHAR,EXPIRYDATE,112) "       
	END

	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ""   

	SET @STRFROM = @STRFROM + " INTO ##FOSAUDASUMMARY "
	SET @STRFROM = @STRFROM + "FROM "      
	SET @STRFROM = @STRFROM + "FOBILLVALAN_CHRG (NOLOCK)"      
	
	SET @STRWHERE = @STRWHERE + "WHERE "       
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "      
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "      
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "      
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "      
	SET @STRWHERE = @STRWHERE + "AUCTIONPART LIKE '" + @EX_AUCTIONPART + "' AND  "      
	SET @STRWHERE = @STRWHERE + "PQTY +SQTY > 0 AND "        

	IF (@FROMCODE = '' AND @TOCODE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
	END  
	IF (@FROMDATE = '' AND @TODATE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
	END      
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
	END      
        
	/*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	/*END - LOGIN CONDITIONS*/
	
	SET @COMMA = ''      
	SET @STRGROUPBY = @STRGROUPBY + @COMMA      
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBY =   + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
		END      	
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
		END      	
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "      
		END      
	END 
	ELSE
	BEGIN 
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY " END      
	END 

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")

		IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
		BEGIN
			SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "      
		END	
	END

	SET @STRORDERBY = @STRGROUPBY      
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY      
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY      
       
	SET @STRHAVING = ' HAVING '       
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' THEN PQTY ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' THEN SQTY ELSE 0 END) > 0"
    
	 IF @STRCOMPUTESUB <> ''       
	 BEGIN       
		  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	 END           

	SET @STRCOMPUTE = REPLACE(@STRCOMPUTE,'SUM()','SUM(0)')
	SET @STRCOMPUTESUB = REPLACE(@STRCOMPUTESUB,'SUM()','SUM(0)')
	
	SET @STRSELECT = REPLACE(@STRSELECT,'SYMBOL' , 'REPLACE(SYMBOL,''&'',''_'') AS SYMBOL')
	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	IF (@ISSUBLEVEL = 'YES')      
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY)
	END      
	ELSE      
	BEGIN      
		--PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		--EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		SET @STRSQL = (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING)
	END      

	PRINT @STRSQL
	
	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY

	EXEC (@STRSQL)


	/*
	DECLARE @s varchar(1000)

	IF object_id('tempdb.dbo.##MyGlobalTemp') Is Not Null
	 DROP TABLE ##MyGlobalTemp

	SET @s = 
	'SELECT *
	INTO ##MyGlobalTemp
	FROM (select name from sys.databases) as T'

	Exec (@s)
	go

	SELECT *
	FROM ##MyGlobalTemp 	
	*/	
		
	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT("0"+CONVERT(VARCHAR,DD),2)'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	ELSE IF @GROUPLEVEL = 'PSD' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	
	IF @GROUPSUBLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT("0"+CONVERT(VARCHAR,DD),2)'
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
	END

	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	 
	IF (@GROUPLEVEL = 'DATE')
	BEGIN
		INSERT INTO #TMPSUMMARY
		EXEC ("SELECT DISTINCT GROUPCODE=CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT('0'+CONVERT(VARCHAR,DD),2) FROM ##FOSAUDASUMMARY ORDER BY CONVERT(VARCHAR,YY)+CONVERT(VARCHAR,MM)+RIGHT('0'+CONVERT(VARCHAR,DD),2) ")
	END
	ELSE
	BEGIN
		INSERT INTO #TMPSUMMARY
		EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	END	
	
	 
	DECLARE @PARTYWISE_CURSOR	CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY " 
		SET @STRSQL = @STRSQL + "WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		SET @STRSQL = @STRSQL + " SELECT sum=SUM(0),sum=SUM(PQTY),sum=SUM(SQTY),sum=SUM(PAMT),sum=(CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END),"
		SET @STRSQL = @STRSQL + " sum=SUM(SAMT),sum=(CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END),"
		SET @STRSQL = @STRSQL + " sum=SUM(NETQTY),"
		SET @STRSQL = @STRSQL + " sum=SUM(NETAMT),sum=SUM(0),"
		SET @STRSQL = @STRSQL + " sum=SUM(0),"
		SET @STRSQL = @STRSQL + " sum=SUM(PROFITORLOSS) "
		SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
				 
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR
	 
	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " SELECT sum=SUM(0),sum=SUM(PQTY),sum=SUM(SQTY),sum=SUM(PAMT),sum=(CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " sum=SUM(SAMT),sum=(CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " sum=SUM(NETQTY),"
	SET @STRSQL = @STRSQL + " sum=SUM(NETAMT),sum=SUM(0),"
	SET @STRSQL = @STRSQL + " sum=SUM(0),"
	SET @STRSQL = @STRSQL + " sum=SUM(PROFITORLOSS) "
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "
	 
	PRINT @STRSQL
	EXEC (@STRSQL)


	/*	
	SET @STRSQL = @STRSQL + " SELECT * FROM #FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " SELECT SUM(OPENQTY),SUM(PQTY),(CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " SUM(PAMT),"
	SET @STRSQL = @STRSQL + " SUM(SQTY),(CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END),"
	SET @STRSQL = @STRSQL + " SUM(SAMT),SUM(NETQTY),"
	SET @STRSQL = @STRSQL + " SUM(0),SUM(NETAMT),"
	SET @STRSQL = @STRSQL + " SUM(CLOSEQTY),SUM(0),"
	SET @STRSQL = @STRSQL + " SUM(PROFITORLOSS) "
	SET @STRSQL = @STRSQL + " FROM #FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " GROUP BY " +
	CASE 
		WHEN @GROUPLEVEL = 'PARTY' THEN " PARTY_CODE "
		WHEN @GROUPLEVEL = 'SCRIP' THEN " SYMBOL "
		WHEN @GROUPLEVEL = 'DATE'  THEN " YY,MM,DD "
		WHEN @GROUPLEVEL = 'INSTTYPE'  THEN " INST_TYPE "
		ELSE " PARTY_CODE "
	END	
	SET @STRSQL = @STRSQL + " DROP TABLE #FOSAUDASUMMARY "
	SET @STRSQL = " DROP TABLE #FOSAUDASUMMARY "
	EXEC(@STRSQL)
	*/

	--PRINT @GROUPLEVEL
	--PRINT @GROUPSUBLEVEL
	--PRINT @STRSQL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTS_PARENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWREPORTS    SCRIPT DATE: 2/9/2009 12:20:14 PM ******/

--EXEC RPT_PROC_FO_NEWREPORTS 'SAUDASUMMARY', 'BROKER', 'BROKER', 'PARTY', 'PARTY', '', '', 'JAN 1 2007', 'JAN 1 2008', 'CLIENT', '0', 'ZZZ', '', '', 'SUMMARY', '', '', -1, '', '', '', '', 'PRICE', 'MKTRATE', '', '', '', '', '', '', '', '', '', '', '',''



CREATE PROCEDURE [DBO].[RPT_PROC_FO_NEWREPORTS_PARENT]
(
	 @REPORTNAME VARCHAR(50),      
	 @STATUSID VARCHAR(20),      
	 @STATUSNAME VARCHAR(50),      
	 @GROUPLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT      
	 @GROUPSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS      
	 @ORDERLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @ORDERSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @FROMDATE VARCHAR(11),      
	 @TODATE VARCHAR(11),      
	 @WHATCODE VARCHAR(20),  		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	 @FROMCODE VARCHAR(20),      
	 @TOCODE VARCHAR(20),      
	 @FROMPARTYCODE VARCHAR(20), 		--]--> FOR THE FROM AND TO PARTY CODES      
	 @TOPARTYCODE VARCHAR(20), 		--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	 @ONEORMANY VARCHAR(20),      
	 @INSTTYPE VARCHAR(20),  		--]      
	 @OPTIONTYPE VARCHAR(20), 		--]      
	 @STRIKEPRICE MONEY,  			--]--> PRIMARY SEARCH FIELDS.      
	 @EXPIRYDATE VARCHAR(11), 		--]      
	 @SYMBOL VARCHAR(20), 			 --]      
	 @EX_BILLTYPE VARCHAR(1), 		--(SINGLE/MULTIPLE) - BILL      ]      
	 @EX_AUCTIONPART VARCHAR(20), 		--SAUDASUMMARY       ]      
	 @EX_REPORTBY VARCHAR(20), 		--(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	 @EX_RATE VARCHAR(20), 			--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	 @EX_MONEYTYPE VARCHAR(1), 		--(IN/AT/OUT) - IN THE MONEY      ]      
	 @EX_POSITION VARCHAR (1), 		--(LONG/SHORT) - IN THE MONEY     ]      
	 --END REPORT SPECIFIC SEARCH FEILDS      
	 @DUMMY001 VARCHAR(50),      
	 @DUMMY002 VARCHAR(50),      
	 @DUMMY003 VARCHAR(50),      
	 @DUMMY004 VARCHAR(50),      
	 @DUMMY005 VARCHAR(50),      
	 @DUMMY006 VARCHAR(50),      
	 @DUMMY007 VARCHAR(50),      
	 @DUMMY008 VARCHAR(50),      
	 @DUMMY009 VARCHAR(50),      
	 @DUMMY010 VARCHAR(50)      
)
AS      

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE      
	@STRSELECT VARCHAR(8000),      
	@STRSELECTTEMP VARCHAR(8000),      
	@STRSELECTAVRGRT VARCHAR(8000),      
	@STRSELECTCLOSEQTY VARCHAR(8000),      
	@STRFROM VARCHAR(8000),      
	@STRWHERE VARCHAR(8000),      
	@STRGROUPBY VARCHAR(8000),      
	@STRORDERBY VARCHAR(8000),      
	@STRCOMPUTE VARCHAR(8000),      
	@STRCOMPUTESUB VARCHAR(8000),      
	@STRHAVING VARCHAR(2000),      
	@ISSUBLEVEL VARCHAR(3),      
	@CODEID VARCHAR(20),      
	@COMMA VARCHAR(1)      
	SET @INSTTYPE = @INSTTYPE+"%"       
	SET @STRSELECT = ''      
	SET @STRSELECTTEMP = ''
	SET @STRSELECTAVRGRT = '' 
	SET @STRSELECTCLOSEQTY = ''     
	SET @STRFROM = ''      
	SET @STRWHERE = ''      
	SET @STRGROUPBY = ''      
	SET @STRORDERBY = ''      
	SET @STRCOMPUTE = ''      
	SET @STRCOMPUTESUB = ''      
	SET @ISSUBLEVEL = 'NO'      
	
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END     
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      

	IF @TODATE = ''      
	BEGIN       
		SELECT @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT (NOLOCK)
	END       
	
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE SAUDA_DATE >=  @FROMDATE 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
	SET @STRSELECT = @STRSELECT + "SELECT "      
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      	
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
			END      
		END      
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,112), EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			END      
		END       
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS  EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "      
			END      
		END             
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
			END
		END       
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			SET @ISSUBLEVEL = 'YES'      
		END      
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		SET @STRSELECTTEMP = ''      
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END      
	END 

	--OPENQTY      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--PQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--SQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

	IF (@EX_RATE = 'MKTRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "    
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) " */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"     

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "  
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END 	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " ( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*PRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*SRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) )/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*(STRIKE_PRICE+PRATE))/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*(STRIKE_PRICE+SRATE))/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
	END 
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE PAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE SAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE PAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE SAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END  	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " ( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */
	
			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(PAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(SAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE 0 END + PAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE 0 END + SAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
	END

	--CLOSEQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''  

   
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END

	--PROFIT/LOSS      

	/*SET @STRSELECTTEMP = 'CONVERT (NUMERIC(18,4),' 
	SET @STRSELECTTEMP = @STRSELECTTEMP + @STRSELECTAVRGRT + ')* CONVERT(INT,'+  @STRSELECTCLOSEQTY  + ') * MAX(NUMERATOR)/MAX(DENOMINATOR)'
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "*/      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
	SET @STRSELECTTEMP = ''   
     

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  AND (@FROMDATE  = @TODATE )  
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),0 "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0,0 "       
	END      

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " , EXPIRYORD = CONVERT(VARCHAR,EXPIRYDATE,112) "       
	END

	SET @STRCOMPUTE = @STRCOMPUTE + ",SUM(0)  "       
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ""   

	SET @STRFROM = @STRFROM + "FROM "      
	SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK)"      
	
	SET @STRWHERE = @STRWHERE + "WHERE "       
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "      
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "      
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "      
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "      
	SET @STRWHERE = @STRWHERE + "AUCTIONPART LIKE '" + @EX_AUCTIONPART + "' AND  "      
	SET @STRWHERE = @STRWHERE + "PQTY +SQTY > 0 AND "        

	IF (@FROMCODE = '' AND @TOCODE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
	END  
	IF (@FROMDATE = '' AND @TODATE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
	END      
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
	END      
        
	/*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	/*END - LOGIN CONDITIONS*/
	
	SET @COMMA = ''      
	SET @STRGROUPBY = @STRGROUPBY + @COMMA      
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBY =   + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
		END      	
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
		END      	
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "      
		END      
	END 
	ELSE
	BEGIN 
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY " END      
	END 

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")

		IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
		BEGIN
			SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "      
		END	
	END

	SET @STRORDERBY = @STRGROUPBY      
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY      
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY      
       
	SET @STRHAVING = ' HAVING '       
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' THEN PQTY ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' THEN SQTY ELSE 0 END) > 0"
    
	 IF @STRCOMPUTESUB <> ''       
	 BEGIN       
		  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	 END           

	SET @STRCOMPUTE = REPLACE(@STRCOMPUTE,'SUM()','SUM(0)')
	SET @STRCOMPUTESUB = REPLACE(@STRCOMPUTESUB,'SUM()','SUM(0)')
	
	IF (@ISSUBLEVEL = 'YES')      
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
	END      
	ELSE 
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
	END   
 
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewReportsSearch
-- --------------------------------------------------





CREATE       PROC
rpt_proc_FO_NewReportsSearch
@StatusID VarChar (20),
@StatusName VarChar (20),
@strIdentifier VarChar(20),
@strSearchString VarChar(50),
@strReportFor VarChar(25),
@strFromCode VarChar(25),
@strToCode VarChar(25),
@strFromPartyCode VarChar(25),
@strToPartyCode VarChar(25),
@strFromDate VarChar(25),
@strToDate VarChar(25),
@strInstType VarChar(25),
@strSymbol VarChar(25),
@strExpiryDate VarChar(25),
@strOptionType VarChar(25),
@strStrikePrice Money,
@strAuctionPart VarChar(25),
@strDummy001 VarChar(25),
@strDummy002 VarChar(25),
@strDummy003 VarChar(25),
@strDummy004 VarChar(25),
@strDummy005 VarChar(25),
@strDummy006 VarChar(25),
@strDummy007 VarChar(25),
@strDummy008 VarChar(25),
@strDummy009 VarChar(25),
@blnFromUpdatePage VarChar(25)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
--EXEC rpt_proc_FO_NewReportsSearch 'broker', 'broker', 'instType', '', 'CLIENT', '0', 'ZZZ', '', '', 'Feb 16 2006', 'Feb 16 2006', '', '', '', '', -1, '', '', '', '', '', '', '', '', '', '', 'FALSE'

Declare
	@strSQL VarChar(8000),
	@strWhatToList VarChar(50)
	Set @strInstType = @strInstType+"%" 
	If (@strReportFor = 'REGION')  Begin Set @strWhatToList = "region" End
	If (@strReportFor = 'AREA')  Begin Set @strWhatToList = "Area" End
	If (@strReportFor = 'BRANCH')  Begin Set @strWhatToList = "branch_code" End
	If (@strReportFor = 'SUBBROKER')  Begin Set @strWhatToList = "sub_broker" End
	If (@strReportFor = 'TRADER')  Begin Set @strWhatToList = "trader" End
	If (@strReportFor = 'FAMILY')  Begin Set @strWhatToList = "family" End
	If (@strReportFor = 'CLIENT')  Begin Set @strWhatToList = "party_code" End
	If (@blnFromUpdatePage = 'FALSE')
	Begin
		--FROM CODE
		If (@strIdentifier = 'FROMCODE')
		Begin
			If (@strReportFor = 'CLIENT')
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code, party_name FROM fobillvalan (nolock) WHERE "
			End
			Else
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM fobillvalan  (nolock) WHERE "
			End
			--Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM fobillvalan WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
		
			If @strToCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		--TO CODE
		If (@strIdentifier = 'TOCODE')
		Begin
			If (@strReportFor = 'CLIENT')
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code, party_name FROM fobillvalan  (nolock) WHERE "
			End
			Else
			Begin
				Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM fobillvalan  (nolock) WHERE "
			End
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		--FROM DATE
		If (@strIdentifier = 'FROMDATE')
		Begin
			--Set @strWhatToList = 'sauda_date'
			Set @strSQL = "SELECT DISTINCT sauda_date, Convert(VarChar, sauda_date, 103) AS from_code FROM fobillvalan  (nolock) WHERE "
			Set @strSQL = @strSQL + "sauda_date LIKE '" + @strSearchString + "%' "
		
			If @strToDate <> '' Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
		
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
		
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--TO DATE
		If (@strIdentifier = 'TODATE')
		Begin
			--Set @strWhatToList = 'sauda_date'
			Set @strSQL = "SELECT DISTINCT sauda_date, Convert(VarChar, sauda_date, 103) AS from_code FROM fobillvalan  (nolock) WHERE "
			Set @strSQL = @strSQL + "sauda_date LIKE '" + @strSearchString + "%' "
		
			If @strFromDate <> '' Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
	
			If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
	
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + "' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + "' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--INSTTYPE
		If (@strIdentifier = 'INSTTYPE')
		Begin
			--Set @strWhatToList = 'inst_type'
			Set @strSQL = "SELECT DISTINCT F2.inst_type AS from_code FROM FoScrip2 F2  (nolock) WHERE "
			Set @strSQL = @strSQL + "F2.inst_type LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			--If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			--If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			--If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--SYMBOL
		If (@strIdentifier = 'SYMBOL')
		Begin
			--Set @strWhatToList = 'symbol'
			Set @strSQL = "SELECT DISTINCT F2.symbol AS from_code FROM FoScrip2 F2  (nolock) WHERE "
			Set @strSQL = @strSQL + "F2.symbol LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			--If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			--If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			--If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--EXPIRY DATE
		If (@strIdentifier = 'EXPIRYDATE')
		Begin
			--Set @strWhatToList = 'expirydate'
			Set @strSQL = "SELECT DISTINCT Convert(VarChar, F2.expirydate, 103) AS from_code FROM FoScrip2 F2  (nolock) WHERE "
			Set @strSQL = @strSQL + "F2.expirydate LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			--If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			--If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			--If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate = '" + @strExpiryDate + "' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--OPTION TYPE
		If (@strIdentifier = 'OPTIONTYPE')
		Begin
			--Set @strWhatToList = 'option_type'
			Set @strSQL = "SELECT DISTINCT F2.option_type AS from_code FROM FoScrip2 F2  (nolock) WHERE "
			Set @strSQL = @strSQL + "F2.option_type LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			--If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			--If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			--If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
	
		--STRIKE PRICE
		If (@strIdentifier = 'STRIKEPRICE')
		Begin
			--Set @strWhatToList = 'strike_price'
			Set @strSQL = "SELECT DISTINCT F2.strike_price AS from_code FROM FoScrip2 F2  (nolock) WHERE "
			Set @strSQL = @strSQL + "Convert(VarChar, F2.strike_price) LIKE '" + @strSearchString + "%' "
		
			--If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
	
			--If (@strFromCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
			--If (@strToCode <> '') Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
			
			--If (@strFromDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date >= '" + @strFromDate + " 00:00:00' " End
			--If (@strToDate <> '') Begin Set @strSQL = @strSQL + " AND sauda_date <= '" + @strToDate + " 23:59:59' " End
			If (@strInstType <> '') Begin Set @strSQL = @strSQL + " AND inst_type Like  '" + @strInstType + "' " End
			If (@strSymbol <> '') Begin Set @strSQL = @strSQL + " AND symbol = '" + @strSymbol + "' " End
			If (@strExpiryDate <> '') Begin Set @strSQL = @strSQL + " AND expirydate LIKE '" + @strExpiryDate + "%' " End
			If (@strOptionType <> '') Begin Set @strSQL = @strSQL + " AND option_type = '" + @strOptionType + "' " End
			--If (@strStrikePrice <> -1) Begin Set @strSQL = @strSQL + " AND strike_price = " + Convert(VarChar, @strStrikePrice) + " " End
		End
		IF @STATUSID = 'BROKER'
		BEGIN
		  Set @strsql = @strsql + " AND 1=1 "
		END
		ELSE
		BEGIN
		  Set @strsql = @strsql + " AND isnull(area,'') LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(region,'') LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(branch_code,'') LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(sub_broker,'') LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(trader,'') LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(family,'') LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "  
		  Set @strsql = @strsql + "isnull(party_code,'') LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "  
		END
		  /*END - LOGIN CONDITIONS*/  
	End --If (@blnFromUpdatePage = 'FALSE')
	Else --If (@blnFromUpdatePage = 'FALSE')
	Begin
		If (@strIdentifier = 'FROMCODE')
		Begin
			Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM client2 WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strToCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " <= '" + @strToCode + "' " End
		End
		If (@strIdentifier = 'TOCODE')
		Begin
			Set @strSQL = "SELECT DISTINCT " + @strWhatToList + " AS from_code FROM client2 WHERE "
			Set @strSQL = @strSQL + @strWhatToList + " LIKE '" + @strSearchString + "%' "
			If @strFromCode <> '' Begin Set @strSQL = @strSQL + " AND " + @strWhatToList + " >= '" + @strFromCode + "' " End
		End
	End --Else Of If (@blnFromUpdatePage = 'FALSE')
	Set @strSQL = @strSQL + "ORDER BY (1)"
	Print @strIdentifier + '-->Identifier'
	Print @strSearchString + '-->Search String'
	Print @strReportFor + '-->Report For'
	Print @strFromCode + '-->From Code'
	Print @strToCode + '-->To Code'
	Print @strFromPartyCode + '-->From Party Code'
	Print @strToPartyCode + '-->To Party Code'
	Print @strFromDate + '-->From Date'
	Print @strToDate + '-->To Date'
	Print @strInstType + '-->Inst. Type'
	Print @strSymbol + '-->Symbol'
	Print @strExpiryDate + '-->Expiry Date'
	Print @strOptionType + '-->Option Type'
	Print Convert(VarChar, @strStrikePrice) + '-->Strike Price'
	Print @strAuctionPart + '-->Auc Part'
	Print @strSQL
	Exec(@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTSSEARCH_PARENT
-- --------------------------------------------------
CREATE       PROC
[DBO].[RPT_PROC_FO_NEWREPORTSSEARCH_PARENT]
@STATUSID VARCHAR (20),
@STATUSNAME VARCHAR (20),
@STRIDENTIFIER VARCHAR(20),
@STRSEARCHSTRING VARCHAR(50),
@STRREPORTFOR VARCHAR(25),
@STRFROMCODE VARCHAR(25),
@STRTOCODE VARCHAR(25),
@STRFROMPARTYCODE VARCHAR(25),
@STRTOPARTYCODE VARCHAR(25),
@STRFROMDATE VARCHAR(25),
@STRTODATE VARCHAR(25),
@STRINSTTYPE VARCHAR(25),
@STRSYMBOL VARCHAR(25),
@STREXPIRYDATE VARCHAR(25),
@STROPTIONTYPE VARCHAR(25),
@STRSTRIKEPRICE MONEY,
@STRAUCTIONPART VARCHAR(25),
@STRDUMMY001 VARCHAR(25),
@STRDUMMY002 VARCHAR(25),
@STRDUMMY003 VARCHAR(25),
@STRDUMMY004 VARCHAR(25),
@STRDUMMY005 VARCHAR(25),
@STRDUMMY006 VARCHAR(25),
@STRDUMMY007 VARCHAR(25),
@STRDUMMY008 VARCHAR(25),
@STRDUMMY009 VARCHAR(25),
@BLNFROMUPDATEPAGE VARCHAR(25)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
--EXEC RPT_PROC_FO_NEWREPORTSSEARCH 'BROKER', 'BROKER', 'INSTTYPE', '', 'CLIENT', '0', 'ZZZ', '', '', 'FEB 16 2006', 'FEB 16 2006', '', '', '', '', -1, '', '', '', '', '', '', '', '', '', '', 'FALSE'

DECLARE
	@STRSQL VARCHAR(8000),
	@STRWHATTOLIST VARCHAR(50)
	SET @STRINSTTYPE = @STRINSTTYPE+"%" 
	IF (@STRREPORTFOR = 'REGION')  BEGIN SET @STRWHATTOLIST = "REGION" END
	IF (@STRREPORTFOR = 'AREA')  BEGIN SET @STRWHATTOLIST = "AREA" END
	IF (@STRREPORTFOR = 'BRANCH')  BEGIN SET @STRWHATTOLIST = "BRANCH_CODE" END
	IF (@STRREPORTFOR = 'SUBBROKER')  BEGIN SET @STRWHATTOLIST = "SUB_BROKER" END
	IF (@STRREPORTFOR = 'TRADER')  BEGIN SET @STRWHATTOLIST = "TRADER" END
	IF (@STRREPORTFOR = 'FAMILY')  BEGIN SET @STRWHATTOLIST = "FAMILY" END
	IF (@STRREPORTFOR = 'CLIENT')  BEGIN SET @STRWHATTOLIST = "PARTY_CODE" END
	IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		--FROM CODE
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM FOBILLVALAN_PARENT (NOLOCK) WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE "
			END
			--SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN_PARENT WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--TO CODE
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE "
			END
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--FROM DATE
		IF (@STRIDENTIFIER = 'FROMDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTODATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
		
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--TO DATE
		IF (@STRIDENTIFIER = 'TODATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM FOBILLVALAN_PARENT  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRFROMDATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
	
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
	
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + "' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + "' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--INSTTYPE
		IF (@STRIDENTIFIER = 'INSTTYPE')
		BEGIN
			--SET @STRWHATTOLIST = 'INST_TYPE'
			SET @STRSQL = "SELECT DISTINCT F2.INST_TYPE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.INST_TYPE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			--IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--SYMBOL
		IF (@STRIDENTIFIER = 'SYMBOL')
		BEGIN
			--SET @STRWHATTOLIST = 'SYMBOL'
			SET @STRSQL = "SELECT DISTINCT F2.SYMBOL AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.SYMBOL LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			--IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--EXPIRY DATE
		IF (@STRIDENTIFIER = 'EXPIRYDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'EXPIRYDATE'
			SET @STRSQL = "SELECT DISTINCT CONVERT(VARCHAR, F2.EXPIRYDATE, 103) AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.EXPIRYDATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			--IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE = '" + @STREXPIRYDATE + "' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--OPTION TYPE
		IF (@STRIDENTIFIER = 'OPTIONTYPE')
		BEGIN
			--SET @STRWHATTOLIST = 'OPTION_TYPE'
			SET @STRSQL = "SELECT DISTINCT F2.OPTION_TYPE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.OPTION_TYPE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			--IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--STRIKE PRICE
		IF (@STRIDENTIFIER = 'STRIKEPRICE')
		BEGIN
			--SET @STRWHATTOLIST = 'STRIKE_PRICE'
			SET @STRSQL = "SELECT DISTINCT F2.STRIKE_PRICE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "CONVERT(VARCHAR, F2.STRIKE_PRICE) LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			--IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		IF @STATUSID = 'BROKER'
		BEGIN
		  SET @STRSQL = @STRSQL + " AND 1=1 "
		END
		ELSE
		BEGIN
		  SET @STRSQL = @STRSQL + " AND ISNULL(AREA,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'AREA' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(REGION,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'REGION' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(BRANCH_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'BRANCH' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(SUB_BROKER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(TRADER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'TRADER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(FAMILY,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'FAMILY' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(PARTY_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'CLIENT' THEN '" + @STATUSNAME + "' ELSE '%' END) "  
		END
		  /*END - LOGIN CONDITIONS*/  
	END --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	ELSE --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		END
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
		END
	END --ELSE OF IF (@BLNFROMUPDATEPAGE = 'FALSE')
	SET @STRSQL = @STRSQL + "ORDER BY (1)"
	PRINT @STRIDENTIFIER + '-->IDENTIFIER'
	PRINT @STRSEARCHSTRING + '-->SEARCH STRING'
	PRINT @STRREPORTFOR + '-->REPORT FOR'
	PRINT @STRFROMCODE + '-->FROM CODE'
	PRINT @STRTOCODE + '-->TO CODE'
	PRINT @STRFROMPARTYCODE + '-->FROM PARTY CODE'
	PRINT @STRTOPARTYCODE + '-->TO PARTY CODE'
	PRINT @STRFROMDATE + '-->FROM DATE'
	PRINT @STRTODATE + '-->TO DATE'
	PRINT @STRINSTTYPE + '-->INST. TYPE'
	PRINT @STRSYMBOL + '-->SYMBOL'
	PRINT @STREXPIRYDATE + '-->EXPIRY DATE'
	PRINT @STROPTIONTYPE + '-->OPTION TYPE'
	PRINT CONVERT(VARCHAR, @STRSTRIKEPRICE) + '-->STRIKE PRICE'
	PRINT @STRAUCTIONPART + '-->AUC PART'
	PRINT @STRSQL
	EXEC(@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewTurnOver
-- --------------------------------------------------


CREATE PROC [dbo].[rpt_proc_FO_NewTurnOver]      
	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),
	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@OneOrMany VarChar(20),
	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Symbol VarChar(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@ULCLRate VarChar(50),
	@ClTransactions VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare
	@strSelect VarChar(8000),
	@strSelectTemp VarChar(8000),
	@strFrom VarChar(8000),
	@strWhere VarChar(8000),
	@strGroupBy VarChar(8000),
	@strOrderBy VarChar(8000),
	@strCompute VarChar(8000),
	@strComputeSub VarChar(8000),
	@IsSubLevel VarChar(3),
	@CodeID VarChar(20),
	@Comma VarChar(1)
	Set @InstType = @InstType+"%" 
	If @OptionType = '' Begin Set @OptionType = "%" End
	--If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE
	If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End
	If @Symbol = '' Begin Set @Symbol = "%" End
	
	If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End
	If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End
	If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End
	Set @strSelect = ''
	Set @strSelectTemp = ''
	Set @strFrom = ''
	Set @strWhere = ''
	Set @strGroupBy = ''
	Set @strOrderBy = ''
	Set @strCompute = ''
	Set @strCompute = ''
	Set @strComputeSub = ''
	Set @IsSubLevel = 'NO'
	If (@FromDate = '' AND @ToDate = '')
	Begin 
		Select @FromDate = Left(Convert(Varchar,Max(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From FoBillValan (nolock)
	End 
	If (@ReportName = 'TURNOVER')
	Begin
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End
		If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End
		If (@WhatCode = 'AREA') Begin Set @CodeID = 'Area' End
		If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End
		If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End
		If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End
		If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End
		
		Set @strSelect = @strSelect + "SELECT "
		Set @strCompute = @strCompute + "COMPUTE "
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))
		Begin
			Set @strSelectTemp = ''
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type, max(email) as email, "
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "party_code "
				End
			End
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) as email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "symbol, inst_type,ORDDATE=CONVERT(VARCHAR,EXPIRYDATE,112), expirydate, strike_price, option_type "
				End
			End

			If (@GroupLevel = 'DATE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + " CONVERT(VARCHAR,SAUDA_DATE,112) "
				End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "inst_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "inst_type "
				End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type, max(email) as email, symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "
				Set @strSelectTemp = @strSelectTemp + "option_type, Convert(VarChar,sauda_date,103) AS sauda_date, "
				Set @IsSubLevel = 'YES'
			End
			Set @strSelect = @strSelect + @strSelectTemp
			Set @strSelectTemp = ''
		End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
			If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as client_type,max(email) email, " End
			If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End
			If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "Area, " End
			If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End
			If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End
			If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End
		End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		
		If (@Ex_Rate = 'MKTRATE')
		Begin
			--FUTURES TRADED VALUE - MKTRATE - COMMON
			Set @strSelectTemp = ''
			Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart <> 'EA'  AND auctionpart <> 'CA' "
			Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
			Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
			Set @strSelectTemp = @strSelectTemp + "AS futurestradedvalue, "
			Set @strSelect = @strSelect + @strSelectTemp
			If (@Ex_ReportBy = 'STRIKE')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + STRIKE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then ((pqty+sqty)*strike_price*Numerator/Denominator) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + STRIKE
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull((pqty+sqty)*Strike_Price*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + PRICE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator))) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + PRICE
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'BOTH')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty+sqty)*strike_price*Numerator/Denominator) + (pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator)) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate)*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + BOTH
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+PRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+pRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'EXCHG')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator))) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + BOTH
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA') "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(Strike_Price*pqty*Numerator/Denominator + Strike_Price*sqty*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/
		--BROKERAGE
		
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "isnull(Sum(pbrokamt + sbrokamt),0) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* BROKERAGE */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS brokerage, "
		Set @strSelect = @strSelect + @strSelectTemp
		--SERVICE TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "isnull(Sum(TOT_SERVICETAX),0) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SERVICE TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS servicetax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--TURNOVER TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(turn_tax) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* TURNOVER TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS turnovertax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--SEBI TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(sebi_tax) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SEBI TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS sebitax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--STAMP DUTY
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(broker_note) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* STAMP DUTY */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS stampduty, "
		Set @strSelect = @strSelect + @strSelectTemp
		--CLEARING CHARGES
		Set @strSelectTemp = ''
		--Set @strSelectTemp = @strSelectTemp + "Sum(cl_chrg - excl_chrg) "
		Set @strSelectTemp = @strSelectTemp + "Sum(Other_Chrg) "      
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLEARING CHARGES */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS clearingcharges, "
		Set @strSelect = @strSelect + @strSelectTemp
		--COMMODITY TRANS TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(Ins_chrg) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* COMMODITY TRANS TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS CTT "
		
		IF @GroupLevel = 'DATE' OR @GroupSubLevel = 'DATE'
		BEGIN
			SET @strSelectTemp = @strSelectTemp + ", CONVERT(VARCHAR,SAUDA_DATE,112) AS ORDDATE "
		END

		IF @GroupLevel = 'SCRIP' OR @GroupSubLevel = 'SCRIP'
		BEGIN
			SET @strSelectTemp = @strSelectTemp + ", CONVERT(VARCHAR,EXPIRYDATE,112) AS ORDDATE "
		END
		Set @strSelect = @strSelect + @strSelectTemp
		
		--SBC CHRG      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(SBC_CHRG) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "," + " SUM(" + @STRSELECTTEMP + ") /* SBC CHRG */ " --FOR THE SUB TOTAL      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " AS SBC_CHRG "      
		SET @STRSELECT = @STRSELECT + "," + @STRSELECTTEMP
		
  		Set @strFrom = @strFrom + "INTO ##FOSAUDASUMMARY "
		Set @strFrom = @strFrom + "FROM "
		--Set @strFrom = @strFrom + "FOBILLVALAN_DEL_VIEW "
		Set @strFrom = @strFrom + "FOBILLVALAN_CHRG "
	
		Set @strWhere = @strWhere + "WHERE "
		Set @strWhere = @strWhere + "tradetype = 'BT' AND "
	
		Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "
		Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "
		If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End
		Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "
		Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND "
		  If (@FromCode = '' AND @ToCode = '')      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" + @CodeID + ",'') LIKE '%' AND "      
		  End      
		  Else      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') >= '" + @FromCode + "' AND "      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') <= '" + @ToCode + "' AND "      
		  End      
		If (@FromDate = '' AND @ToDate = '')
		Begin
			Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "
			Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "
		End
		If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))
		Begin
			Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "
			Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "
		End
		  /*LOGIN CONDITIONS*/      
		if @statusid = 'broker'
		begin
		  Set @strWhere = @strWhere + "1=1 "
		end
		else
		begin
		  Set @strWhere = @strWhere + "isnull(area,'') LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(region,'') LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(branch_code,'') LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(sub_broker,'') LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(trader,'') LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(family,'') LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(party_code,'') LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "      
		end
		  /*END - LOGIN CONDITIONS*/      
		Set @Comma = ''
		Set @strGroupBy = @strGroupBy + @Comma
		
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))
		Begin
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code "
				Set @Comma = ', '
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
			
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strGroupBy = @strGroupBy + "symbol, inst_type, expirydate, strike_price, option_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "inst_type "*/ End
			End
	
			If (@GroupLevel = 'DATE')
			Begin
				Set @strGroupBy = @strGroupBy + "sauda_date "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strGroupBy = @strGroupBy + "inst_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code,  symbol, inst_type, expirydate, strike_price, "
				Set @strGroupBy = @strGroupBy + "option_type, sauda_date "
			End
		End /*If (@OneOrMany = 'DETAIL')*/
		Else /*If (@OneOrMany = 'DETAIL')*/
		Begin /*Else OF If (@OneOrMany = 'DETAIL')*/
			If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code " End
			If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End
			If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "Area " End
			If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End
			If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End
			If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End
		End /*Else OF If (@OneOrMany = 'DETAIL')*/

		IF @GroupLevel = 'DATE' OR @GroupSubLevel = 'DATE'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('SAUDA_DATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,SAUDA_DATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1))) + " "
			END	
		END

		IF @GroupLevel = 'SCRIP' OR @GroupSubLevel = 'SCRIP'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "
			END	
		END
		
		Set @strOrderBy = @strGroupBy
		Set @strGroupBy = "GROUP BY " + @strGroupBy
		Set @strOrderBy = "ORDER BY " + @strOrderBy
	End/*If (@ReportName = "NETPOSITION")*/

	If @strComputeSub <> '' 
	Begin 
		Set @strComputeSub = "BY " + @strComputeSub 
		Set @strComputeSub = @strCompute + @strComputeSub
	End

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	 If (@IsSubLevel = 'YES')      
	 Begin      
	  	--Print (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy + '  ' + @strComputeSub + '  ' + @strCompute)      
	 	--Exec (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy + '  ' + @strComputeSub + '  ' + @strCompute)      
		SET @STRSQL = (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy)
	 End      
	 Else      
	 Begin      
	  	--Print (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy + '  ' + @strCompute)      
	  	--Exec (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy + '  ' + @strCompute)      
		SET @STRSQL = (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy)
	 End      
	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY

	PRINT @STRSQL
	EXEC (@STRSQL)


	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	IF @GROUPLEVEL = 'PSD' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	IF @GROUPSUBLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
	END
	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	
	INSERT INTO #TMPSUMMARY
	EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	
	DECLARE @PARTYWISE_CURSOR CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY " 
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		SET @STRSQL = @STRSQL + " SELECT "
		SET @STRSQL = @STRSQL + " SUM=SUM(FUTURESTRADEDVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(OPTIONSTRADEDVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(EXCERCISEVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(ASSIGNMENTVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CLOSEOUTVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(TOTAL),"
		SET @STRSQL = @STRSQL + " SUM=SUM(BROKERAGE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SERVICETAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(TURNOVERTAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SEBITAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(STAMPDUTY),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CLEARINGCHARGES),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CTT),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SBC_CHRG)"
		SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
		
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR

	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " SELECT "
	SET @STRSQL = @STRSQL + " SUM=SUM(FUTURESTRADEDVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(OPTIONSTRADEDVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(EXCERCISEVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(ASSIGNMENTVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CLOSEOUTVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(TOTAL),"
	SET @STRSQL = @STRSQL + " SUM=SUM(BROKERAGE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SERVICETAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(TURNOVERTAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SEBITAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(STAMPDUTY),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CLEARINGCHARGES),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CTT),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SBC_CHRG)"
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_proc_FO_NewTurnOver_IPFT_NXT
-- --------------------------------------------------


CREATE PROC [dbo].[rpt_proc_FO_NewTurnOver_IPFT_NXT]      
	@ReportName VarChar(50),
	@StatusID VarChar(20),
	@StatusName VarChar(50),
	@GroupLevel VarChar(10),	--FOR TOP LEVEL REPORT
	@GroupSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@OrderLevel VarChar(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@OrderSubLevel VarChar(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FromDate VarChar(11),
	@ToDate VarChar(11),
	@WhatCode varChar(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FromCode VarChar(20),
	@ToCode VarChar(20),
	@FromPartyCode VarChar(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@ToPartyCode VarChar(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@OneOrMany VarChar(20),
	@InstType VarChar(20),		--]
	@OptionType VarChar(20),	--]
	@StrikePrice Money,		--]-->	PRIMARY SEARCH FIELDS.
	@ExpiryDate VarChar(11),	--]
	@Symbol VarChar(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@Ex_BillType VarChar(1),	--(SINGLE/MULTIPLE) - BILL						]
	@Ex_AuctionPart VarChar(20),	--SAUDASUMMARY							]
	@Ex_ReportBy VarChar(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@Ex_Rate VarChar(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@Ex_MoneyType VarChar(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@Ex_Position VarChar (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@ULCLRate VarChar(50),
	@ClTransactions VarChar(50),
	@Dummy003 VarChar(50),
	@Dummy004 VarChar(50),
	@Dummy005 VarChar(50),
	@Dummy006 VarChar(50),
	@Dummy007 VarChar(50),
	@Dummy008 VarChar(50),
	@Dummy009 VarChar(50),
	@Dummy010 VarChar(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare
	@strSelect VarChar(8000),
	@strSelectTemp VarChar(8000),
	@strFrom VarChar(8000),
	@strWhere VarChar(8000),
	@strGroupBy VarChar(8000),
	@strOrderBy VarChar(8000),
	@strCompute VarChar(8000),
	@strComputeSub VarChar(8000),
	@IsSubLevel VarChar(3),
	@CodeID VarChar(20),
	@Comma VarChar(1)
	Set @InstType = @InstType+"%" 
	If @OptionType = '' Begin Set @OptionType = "%" End
	--If @StrikePrice = '', -1 IS PASSED FROM THE ASP PAGE
	If @ExpiryDate = '' Begin Set @ExpiryDate = "%" End
	If @Symbol = '' Begin Set @Symbol = "%" End
	
	If @Ex_AuctionPart = '' Begin Set @Ex_AuctionPart = "%" End
	If @Ex_ReportBy = '' Begin Set @Ex_ReportBy = "%" End
	If @Ex_Rate = '' Begin Set @Ex_Rate = "%" End
	Set @strSelect = ''
	Set @strSelectTemp = ''
	Set @strFrom = ''
	Set @strWhere = ''
	Set @strGroupBy = ''
	Set @strOrderBy = ''
	Set @strCompute = ''
	Set @strCompute = ''
	Set @strComputeSub = ''
	Set @IsSubLevel = 'NO'
	If (@FromDate = '' AND @ToDate = '')
	Begin 
		Select @FromDate = Left(Convert(Varchar,Max(Sauda_Date),109),11), @ToDate = Left(Convert(Varchar,Max(Sauda_Date),109),11) From FoBillValan (nolock)
	End 
	If (@ReportName = 'TURNOVER')
	Begin
		If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @CodeID = 'party_code' End
		If (@WhatCode = 'REGION') Begin Set @CodeID = 'region' End
		If (@WhatCode = 'AREA') Begin Set @CodeID = 'Area' End
		If (@WhatCode = 'BRANCH') Begin Set @CodeID = 'branch_code' End
		If (@WhatCode = 'SUBBROKER') Begin Set @CodeID = 'sub_broker' End
		If (@WhatCode = 'TRADER') Begin Set @CodeID = 'trader' End
		If (@WhatCode = 'FAMILY') Begin Set @CodeID = 'family' End
		
		Set @strSelect = @strSelect + "SELECT "
		Set @strCompute = @strCompute + "COMPUTE "
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'CLIENT'))
		Begin
			Set @strSelectTemp = ''
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type, max(email) as email, "
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "party_code "
				End
			End
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) as email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "symbol, inst_type,ORDDATE=CONVERT(VARCHAR,EXPIRYDATE,112), expirydate, strike_price, option_type "
				End
			End

			If (@GroupLevel = 'DATE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'INSTTYPE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "inst_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + " CONVERT(VARCHAR,SAUDA_DATE,112) "
				End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strSelectTemp = @strSelectTemp + "inst_type, "
				If (@GroupSubLevel = 'PARTY')
				Begin
					Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type,max(email) email, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'SCRIP')
				Begin
					Set @strSelectTemp = @strSelectTemp + "symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, option_type, "
					Set @IsSubLevel = 'YES'
				End
				If (@GroupSubLevel = 'DATE')
				Begin
					Set @strSelectTemp = @strSelectTemp + "Convert(VarChar,sauda_date,103) AS sauda_date, "
					Set @IsSubLevel = 'YES'
				End
				If (@IsSubLevel = 'YES')
				Begin
					Set @strComputeSub = @strComputeSub + "inst_type "
				End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strSelectTemp = @strSelectTemp + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as  client_type, max(email) as email, symbol, inst_type, Convert(VarChar,expirydate,103) AS expirydate, strike_price, "
				Set @strSelectTemp = @strSelectTemp + "option_type, Convert(VarChar,sauda_date,103) AS sauda_date, "
				Set @IsSubLevel = 'YES'
			End
			Set @strSelect = @strSelect + @strSelectTemp
			Set @strSelectTemp = ''
		End /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Else /*If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		Begin /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
			If (@WhatCode = 'CLIENT') Begin Set @strSelect = @strSelect + "party_code, max(Left(party_name,25)) AS party_name,max(client_type) as client_type,max(email) email, " End
			If (@WhatCode = 'REGION') Begin Set @strSelect = @strSelect + "region, " End
			If (@WhatCode = 'AREA') Begin Set @strSelect = @strSelect + "Area, " End
			If (@WhatCode = 'BRANCH') Begin Set @strSelect = @strSelect + "branch_code, " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strSelect = @strSelect + "sub_broker, " End
			If (@WhatCode = 'TRADER') Begin Set @strSelect = @strSelect + "trader, " End
			If (@WhatCode = 'FAMILY') Begin Set @strSelect = @strSelect + "family, Left(Familyname,25) AS familyname, " End
		End /*Else OF If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))*/
		
		If (@Ex_Rate = 'MKTRATE')
		Begin
			--FUTURES TRADED VALUE - MKTRATE - COMMON
			Set @strSelectTemp = ''
			Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart <> 'EA'  AND auctionpart <> 'CA' "
			Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
			Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
			Set @strSelectTemp = @strSelectTemp + "AS futurestradedvalue, "
			Set @strSelect = @strSelect + @strSelectTemp
			If (@Ex_ReportBy = 'STRIKE')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + STRIKE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then ((pqty+sqty)*strike_price*Numerator/Denominator) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + STRIKE
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull((pqty+sqty)*Strike_Price*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'PRICE')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + PRICE
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator))) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + PRICE
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*srate*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*prate*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'BOTH')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty+sqty)*strike_price*Numerator/Denominator) + (pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator)) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate)*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + BOTH
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+PRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*(strike_price+SRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*(strike_price+pRate)*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull((prate+strike_Price)*pqty + (srate+strike_price)*sqty,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
			If (@Ex_ReportBy = 'EXCHG')
			Begin
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA' "
				Set @strSelectTemp = @strSelectTemp + "Then (((pqty*prate*Numerator/Denominator)+(sqty*srate*Numerator/Denominator))) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS optionstradedvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				If (@ULCLRate = 'EX')
				Begin
					Set @strSelectTemp = ''
					Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
					Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
					Set @strSelect = @strSelect + @strSelectTemp
					Set @strSelectTemp = '0 '
					Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
					Set @strSelect = @strSelect + @strSelectTemp
				End
				Else /*Of If (@ULCLRate = 'EX')*/
				Begin
					--ASSIGNED AMT - ASG/BOTH + BOTH
					If (@ULCLRate = 'ASG')
					Begin
						Set @strSelectTemp = '0 '
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
	
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End
					Else /*Of If (@ULCLRate = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L Cl. Rate
 
					Begin
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type LIKE 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
						Set @strSelectTemp = @strSelectTemp + "Then (sqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS excercisevalue, "
						Set @strSelect = @strSelect + @strSelectTemp
						Set @strSelectTemp = ''
						Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA')"
						Set @strSelectTemp = @strSelectTemp + "Then (pqty*strike_price*Numerator/Denominator) Else 0 End)) "
						Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						Set @strSelectTemp = @strSelectTemp + "AS assignmentvalue, "
						Set @strSelect = @strSelect + @strSelectTemp
					End /*Of the Else Of If (@ULCLRate = 'ASG')*/
				End /*Of The Else Of If (@ULCLRate = 'EX')*/
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When inst_type LIKE 'FUT%' AND auctionpart = 'EA' AND auctionpart <> 'CA' "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS closeoutvalue, "
				Set @strSelect = @strSelect + @strSelectTemp
				Set @strSelectTemp = ''
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'FUT%' AND auctionpart <> 'CA' ) "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart <> 'EA') "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(prate*pqty*Numerator/Denominator + srate*sqty*Numerator/Denominator,0) Else 0 End)) + "
				Set @strSelectTemp = @strSelectTemp + "(Sum(Case When (inst_type like 'OPT%' AND auctionpart <> 'CA' AND auctionpart = 'EA') "
				Set @strSelectTemp = @strSelectTemp + "Then IsNull(Strike_Price*pqty*Numerator/Denominator + Strike_Price*sqty*Numerator/Denominator,0) Else 0 End))  "
				Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				Set @strSelectTemp = @strSelectTemp + "AS total, "
				Set @strSelect = @strSelect + @strSelectTemp
			End
		End	/*If (@Ex_Rate = 'NETRATE')*/
		--BROKERAGE
		
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "isnull(Sum(pbrokamt + sbrokamt),0) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* BROKERAGE */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS brokerage, "
		Set @strSelect = @strSelect + @strSelectTemp
		--SERVICE TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "isnull(Sum(TOT_SERVICETAX),0) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SERVICE TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS servicetax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--TURNOVER TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(turn_tax) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* TURNOVER TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS turnovertax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--SEBI TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(sebi_tax) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* SEBI TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS sebitax, "
		Set @strSelect = @strSelect + @strSelectTemp
		--STAMP DUTY
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(broker_note) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* STAMP DUTY */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS stampduty, "
		Set @strSelect = @strSelect + @strSelectTemp
		--IPFT CHRG
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(IPFT_CHRG) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* IPFT CHRG */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS IPFTCHRG, "
		Set @strSelect = @strSelect + @strSelectTemp
		--CLEARING CHARGES
		Set @strSelectTemp = ''
		--Set @strSelectTemp = @strSelectTemp + "Sum(cl_chrg - excl_chrg) "
		Set @strSelectTemp = @strSelectTemp + "Sum(Other_Chrg) "      
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + "), /* CLEARING CHARGES */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS clearingcharges, "
		Set @strSelect = @strSelect + @strSelectTemp
		--COMMODITY TRANS TAX
		Set @strSelectTemp = ''
		Set @strSelectTemp = @strSelectTemp + "Sum(Ins_chrg) "
		Set @strCompute = @strCompute + "Sum(" + @strSelectTemp + ") /* COMMODITY TRANS TAX */ "	--FOR THE SUB TOTAL
		Set @strSelectTemp = @strSelectTemp + "AS CTT "
		
		IF @GroupLevel = 'DATE' OR @GroupSubLevel = 'DATE'
		BEGIN
			SET @strSelectTemp = @strSelectTemp + ", CONVERT(VARCHAR,SAUDA_DATE,112) AS ORDDATE "
		END

		IF @GroupLevel = 'SCRIP' OR @GroupSubLevel = 'SCRIP'
		BEGIN
			SET @strSelectTemp = @strSelectTemp + ", CONVERT(VARCHAR,EXPIRYDATE,112) AS ORDDATE "
		END
		Set @strSelect = @strSelect + @strSelectTemp
		
		--SBC CHRG      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(SBC_CHRG) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "," + " SUM(" + @STRSELECTTEMP + ") /* SBC CHRG */ " --FOR THE SUB TOTAL      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " AS SBC_CHRG "      
		SET @STRSELECT = @STRSELECT + "," + @STRSELECTTEMP
		
  		Set @strFrom = @strFrom + "INTO ##FOSAUDASUMMARY "
		Set @strFrom = @strFrom + "FROM "
		--Set @strFrom = @strFrom + "FOBILLVALAN_DEL_VIEW "
		Set @strFrom = @strFrom + "FOBILLVALAN_CHRG T left join TBL_ADDITIONAL_TAX_DATA IPFT on IPFT.party_code=T.party_code"
	
		Set @strWhere = @strWhere + "WHERE "
		Set @strWhere = @strWhere + "tradetype = 'BT' AND "
	
		Set @strWhere = @strWhere + "inst_type LIKE '" + @InstType + "' AND "
		Set @strWhere = @strWhere + "option_type LIKE '" + @OptionType + "' AND "
		If (@StrikePrice > -1) Begin Set @strWhere = @strWhere + "strike_price = " + Convert(VarChar,@StrikePrice) + " AND " End
		Set @strWhere = @strWhere + "Left(Convert(VarChar,expirydate,109),11) LIKE '" + @ExpiryDate + "' AND "
		Set @strWhere = @strWhere + "symbol LIKE '" + @Symbol + "' AND "
		  If (@FromCode = '' AND @ToCode = '')      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" + @CodeID + ",'') LIKE '%' AND "      
		  End      
		  Else      
		  Begin      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') >= '" + @FromCode + "' AND "      
		   Set @strWhere = @strWhere + " isnull(" +@CodeID + ",'') <= '" + @ToCode + "' AND "      
		  End      
		If (@FromDate = '' AND @ToDate = '')
		Begin
			Set @strWhere = @strWhere + "sauda_date LIKE '%' AND "
		End
		Else
		Begin
			Set @strWhere = @strWhere + "sauda_date >= '" + @FromDate + " 00:00:00' AND "
			Set @strWhere = @strWhere + "sauda_date <= '" + @ToDate + " 23:59:59' AND "
		End
		If ((@FromPartyCode <> '' AND @ToPartyCode <> ''))
		Begin
			Set @strWhere = @strWhere + "party_code >= '" + @FromPartyCode + "' AND "
			Set @strWhere = @strWhere + "party_code <= '" + @ToPartyCode + "' AND "
		End
		  /*LOGIN CONDITIONS*/      
		if @statusid = 'broker'
		begin
		  Set @strWhere = @strWhere + "1=1 "
		end
		else
		begin
		  Set @strWhere = @strWhere + "isnull(area,'') LIKE (Case When '" + @StatusID + "' = 'area' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(region,'') LIKE (Case When '" + @StatusID + "' = 'region' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(branch_code,'') LIKE (Case When '" + @StatusID + "' = 'branch' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(sub_broker,'') LIKE (Case When '" + @StatusID + "' = 'subbroker' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(trader,'') LIKE (Case When '" + @StatusID + "' = 'trader' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(family,'') LIKE (Case When '" + @StatusID + "' = 'family' Then '" + @StatusName + "' Else '%' End) AND "      
		  Set @strWhere = @strWhere + "isnull(party_code,'') LIKE (Case When '" + @StatusID + "' = 'client' Then '" + @StatusName + "' Else '%' End) "      
		end
		  /*END - LOGIN CONDITIONS*/      
		Set @Comma = ''
		Set @strGroupBy = @strGroupBy + @Comma
		
		If ((@OneOrMany = 'DETAIL') OR (@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT'))
		Begin
			If (@GroupLevel = 'PARTY')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code "
				Set @Comma = ', '
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
			
			If (@GroupLevel = 'SCRIP')
			Begin
				Set @strGroupBy = @strGroupBy + "symbol, inst_type, expirydate, strike_price, option_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy /*+ @Comma + "inst_type "*/ End
			End
	
			If (@GroupLevel = 'DATE')
			Begin
				Set @strGroupBy = @strGroupBy + "sauda_date "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, inst_type, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'INSTTYPE') Begin Set @strGroupBy = @strGroupBy + @Comma + "inst_type " End
			End
	
			If (@GroupLevel = 'INSTTYPE')
			Begin
				Set @strGroupBy = @strGroupBy + "inst_type "
				Set @Comma = ', '
				If (@GroupSubLevel = 'PARTY') Begin Set @strGroupBy = @strGroupBy + @Comma + "party_code " End
				If (@GroupSubLevel = 'SCRIP') Begin Set @strGroupBy = @strGroupBy + @Comma + "symbol, expirydate, strike_price, option_type " End
				If (@GroupSubLevel = 'DATE') Begin Set @strGroupBy = @strGroupBy + @Comma + "sauda_date " End
			End
	
			If (@GroupLevel = 'PSD')
			Begin
				Set @strGroupBy = @strGroupBy + "party_code,  symbol, inst_type, expirydate, strike_price, "
				Set @strGroupBy = @strGroupBy + "option_type, sauda_date "
			End
		End /*If (@OneOrMany = 'DETAIL')*/
		Else /*If (@OneOrMany = 'DETAIL')*/
		Begin /*Else OF If (@OneOrMany = 'DETAIL')*/
			If ((@WhatCode = 'BROKER') OR (@WhatCode = 'CLIENT')) Begin Set @strGroupBy = @strGroupBy + "party_code " End
			If (@WhatCode = 'REGION') Begin Set @strGroupBy = @strGroupBy + "region " End
			If (@WhatCode = 'AREA') Begin Set @strGroupBy = @strGroupBy + "Area " End
			If (@WhatCode = 'BRANCH') Begin Set @strGroupBy = @strGroupBy + "branch_code " End
			If (@WhatCode = 'SUBBROKER') Begin Set @strGroupBy = @strGroupBy + "sub_broker " End
			If (@WhatCode = 'TRADER') Begin Set @strGroupBy = @strGroupBy + "trader " End
			If (@WhatCode = 'FAMILY') Begin Set @strGroupBy = @strGroupBy + "family, familyname " End
		End /*Else OF If (@OneOrMany = 'DETAIL')*/

		IF @GroupLevel = 'DATE' OR @GroupSubLevel = 'DATE'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('SAUDA_DATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,SAUDA_DATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1))) + " "
			END	
		END

		IF @GroupLevel = 'SCRIP' OR @GroupSubLevel = 'SCRIP'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "
			END	
		END
		
		Set @strOrderBy = @strGroupBy
		Set @strGroupBy = "GROUP BY " + @strGroupBy
		Set @strOrderBy = "ORDER BY " + @strOrderBy
	End/*If (@ReportName = "NETPOSITION")*/

	If @strComputeSub <> '' 
	Begin 
		Set @strComputeSub = "BY " + @strComputeSub 
		Set @strComputeSub = @strCompute + @strComputeSub
	End

	DECLARE @STRSQL VARCHAR(MAX)
	DECLARE @STRSQL_NEW VARCHAR(MAX)
	 If (@IsSubLevel = 'YES')      
	 Begin      
	  	--Print (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy + '  ' + @strComputeSub + '  ' + @strCompute)      
	 	--Exec (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy + '  ' + @strComputeSub + '  ' + @strCompute)      
		SET @STRSQL = (@strSelect + @strFrom + '  ' + @strWhere + '  ' + @strGroupBy + '  ' + @strOrderBy)
	 End      
	 Else      
	 Begin      
	  	--Print (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy + '  ' + @strCompute)      
	  	--Exec (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy + '  ' + @strCompute)      
		SET @STRSQL = (@strSelect + @strFrom + '  ' + @strWhere + '  ' +  @strGroupBy + '  ' + @strOrderBy)
	 End      
	IF object_id('tempdb.dbo.##FOSAUDASUMMARY') Is Not Null
	DROP TABLE ##FOSAUDASUMMARY

	PRINT @STRSQL
	EXEC (@STRSQL)


	DECLARE @GROUPLEVEL_NEW		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL_NEW	VARCHAR(100)
	DECLARE @GROUPLEVEL1		VARCHAR(100)
	DECLARE @GROUPSUBLEVEL1		VARCHAR(100)
	
	SET @STRSQL_NEW = ""
	
	IF @GROUPLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPLEVEL = 'DATE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'INST_TYPE'
	END
	IF @GROUPLEVEL = 'PSD' 
	BEGIN
		SET @GROUPLEVEL_NEW = 'PARTY_CODE'
	END
	IF @GROUPSUBLEVEL = 'PARTY' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'PARTY_CODE'
	END
	ELSE IF @GROUPSUBLEVEL = 'SCRIP' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SYMBOL'
	END
	ELSE IF @GROUPSUBLEVEL = 'DATE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'SAUDA_DATE'
	END
	ELSE IF @GROUPSUBLEVEL = 'INSTTYPE' 
	BEGIN
		SET @GROUPSUBLEVEL_NEW = 'INST_TYPE'
	END
	
	CREATE TABLE #TMPSUMMARY
	( GROUPCODE VARCHAR(30) )
	
	INSERT INTO #TMPSUMMARY
	EXEC ('SELECT DISTINCT '+ @GROUPLEVEL_NEW +' FROM ##FOSAUDASUMMARY ORDER BY '+ @GROUPLEVEL_NEW)
	
	DECLARE @PARTYWISE_CURSOR CURSOR

	SET @PARTYWISE_CURSOR = CURSOR FOR
	SELECT DISTINCT GROUPCODE FROM #TMPSUMMARY ORDER BY GROUPCODE
	OPEN @PARTYWISE_CURSOR 
	FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @STRSQL = "SELECT * FROM ##FOSAUDASUMMARY " 
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "
		SET @STRSQL = @STRSQL + " SELECT "
		SET @STRSQL = @STRSQL + " SUM=SUM(FUTURESTRADEDVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(OPTIONSTRADEDVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(EXCERCISEVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(ASSIGNMENTVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CLOSEOUTVALUE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(TOTAL),"
		SET @STRSQL = @STRSQL + " SUM=SUM(BROKERAGE),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SERVICETAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(TURNOVERTAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SEBITAX),"
		SET @STRSQL = @STRSQL + " SUM=SUM(STAMPDUTY),"
		SET @STRSQL = @STRSQL + " SUM=SUM(IPFTCHRG),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CLEARINGCHARGES),"
		SET @STRSQL = @STRSQL + " SUM=SUM(CTT),"
		SET @STRSQL = @STRSQL + " SUM=SUM(SBC_CHRG)"
		SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
		SET @STRSQL = @STRSQL + " WHERE "+ @GROUPLEVEL_NEW +" = '"+ @GROUPLEVEL1 +"' "		
		SET @STRSQL = @STRSQL + " GROUP BY "+ @GROUPLEVEL_NEW +" "
		PRINT @STRSQL
		EXEC (@STRSQL)
		
		FETCH NEXT FROM @PARTYWISE_CURSOR INTO @GROUPLEVEL1
	END

	CLOSE @PARTYWISE_CURSOR
	DEALLOCATE @PARTYWISE_CURSOR

	SET @STRSQL = "IF (SELECT COUNT(1) FROM ##FOSAUDASUMMARY) > 0 BEGIN "
	SET @STRSQL = @STRSQL + " SELECT "
	SET @STRSQL = @STRSQL + " SUM=SUM(FUTURESTRADEDVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(OPTIONSTRADEDVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(EXCERCISEVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(ASSIGNMENTVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CLOSEOUTVALUE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(TOTAL),"
	SET @STRSQL = @STRSQL + " SUM=SUM(BROKERAGE),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SERVICETAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(TURNOVERTAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SEBITAX),"
	SET @STRSQL = @STRSQL + " SUM=SUM(STAMPDUTY),"
	SET @STRSQL = @STRSQL + " SUM=SUM(IPFTCHRG),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CLEARINGCHARGES),"
	SET @STRSQL = @STRSQL + " SUM=SUM(CTT),"
	SET @STRSQL = @STRSQL + " SUM=SUM(SBC_CHRG)"
	SET @STRSQL = @STRSQL + " FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " END "
	SET @STRSQL = @STRSQL + " ELSE "
	SET @STRSQL = @STRSQL + " SELECT * FROM ##FOSAUDASUMMARY "
	SET @STRSQL = @STRSQL + " DROP TABLE ##FOSAUDASUMMARY "
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWTURNOVER_PARENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_PROC_FO_NEWTURNOVER    SCRIPT DATE: 2/11/2009 5:34:49 PM ******/




CREATE  PROC
	[DBO].[RPT_PROC_FO_NEWTURNOVER_PARENT]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@ULCLRATE VARCHAR(50),
	@CLTRANSACTIONS VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN_PARENT (NOLOCK)
	END 
	IF (@REPORTNAME = 'TURNOVER')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END
		IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END
		IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END
		IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END
		IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
				END
			END
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,112), EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "CONVERT(VARCHAR,SAUDA_DATE,112) "
				END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
			IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END
		END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			--FUTURES TRADED VALUE - MKTRATE - COMMON
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUTURESTRADEDVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			IF (@EX_REPORTBY = 'STRIKE')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + STRIKE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((PQTY+SQTY)*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + STRIKE
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PQTY+SQTY)*STRIKE_PRICE*NUMERATOR/DENOMINATOR,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + PRICE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE*NUMERATOR/DENOMINATOR)+(SQTY*SRATE*NUMERATOR/DENOMINATOR))) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + PRICE
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'BOTH')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY+SQTY)*STRIKE_PRICE*NUMERATOR/DENOMINATOR) + (PQTY*PRATE*NUMERATOR/DENOMINATOR)+(SQTY*SRATE*NUMERATOR/DENOMINATOR)) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + BOTH
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PRATE+STRIKE_PRICE)*PQTY + (SRATE+STRIKE_PRICE)*SQTY,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'EXCHG')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY*PRATE*NUMERATOR/DENOMINATOR)+(SQTY*SRATE*NUMERATOR/DENOMINATOR))) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + BOTH
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE*NUMERATOR/DENOMINATOR) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(PRATE*PQTY*NUMERATOR/DENOMINATOR + SRATE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(STRIKE_PRICE*PQTY*NUMERATOR/DENOMINATOR + STRIKE_PRICE*SQTY*NUMERATOR/DENOMINATOR,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		--BROKERAGE
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(PBROKAMT + SBROKAMT),0) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKERAGE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SERVICE TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(SERVICE_TAX- EXSER_TAX),0) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SERVICETAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--TURNOVER TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(TURN_TAX) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TURNOVERTAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SEBI TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SEBI_TAX) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SEBI TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SEBITAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--STAMP DUTY
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(BROKER_NOTE) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* STAMP DUTY */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS STAMPDUTY, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--CLEARING CHARGES
		SET @STRSELECTTEMP = ''
		--SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CL_CHRG - EXCL_CHRG) "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(OTHER_CHRG) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* CLEARING CHARGES */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "

		IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL = 'DATE'
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + ", CONVERT(VARCHAR,SAUDA_DATE,112) "
		END

		IF @GROUPLEVEL = 'SCRIP' OR @GROUPSUBLEVEL = 'SCRIP'
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + ", CONVERT(VARCHAR,EXPIRYDATE,112) "
		END

		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN_PARENT (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
		SET @STRWHERE = @STRWHERE + "TRADETYPE = 'BT' AND "
	
		SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END      
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/
		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
			
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "
				SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		ELSE /*IF (@ONEORMANY = 'DETAIL')*/
		BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
			IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END
		END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/

		IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL = 'DATE'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('SAUDA_DATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,SAUDA_DATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('SAUDA_DATE',@STRGROUPBY)-1))) + " "
			END	
		END

		IF @GROUPLEVEL = 'SCRIP' OR @GROUPSUBLEVEL = 'SCRIP'
		BEGIN
			SET @STRGROUPBY = REPLACE(UPPER(@STRGROUPBY)," ","")	
			IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
			BEGIN
				SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "
			END	
		END

		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/

	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END

	 IF (@ISSUBLEVEL = 'YES')      
	 BEGIN      
	  PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
	  EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
	 END      
	 ELSE      
	 BEGIN      
	  PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
	  EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
	 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_REGIONLISTING
-- --------------------------------------------------



CREATE  PROC [dbo].[RPT_REGIONLISTING]
	(
    	@FROMREGION VARCHAR(15),
	@TOREGION VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    if @FROMREGION = '' begin set @FROMREGION = '0'  end
    if @TOREGION = '' begin set @TOREGION = 'zzzzzz' end
    if @FROMBRANCH = '' begin set @FROMBRANCH = '0'  end
    if @TOBRANCH = '' begin set @TOBRANCH = 'zzzzzz' end

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			Regioncode = UPPER(Regioncode),
			Description = UPPER(Description),
			Branch_Code = UPPER(Branch_Code)

From 
    Region

Where
    Regioncode between @FROMREGION and @TOREGION
    AND Branch_Code between @FROMBRANCH and @TOBRANCH
    

Order by
		Regioncode,Description,Branch_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RELAINCE_EOD
-- --------------------------------------------------


---EXEC RPT_RELAINCE_EOD 'JAN 1 2006','JAN 31 2007','0','ZZZZZ',0


CREATE    PROC RPT_RELAINCE_EOD
	(
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@FROMCODE VARCHAR(15),
	@TOCODE VARCHAR(15),
	@RPTTYPE INT
	)

	AS

	
	IF @RPTTYPE = 1
		BEGIN

	        SET NOCOUNT ON 
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
		SELECT
			F.PARTY_CODE,
			TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),
			YY = YEAR(SAUDA_DATE),
			MM = MONTH(SAUDA_DATE),
			DD = DAY(SAUDA_DATE),
			COMMODITY = SYMBOL,
			EXPIRY = CONVERT(VARCHAR,EXPIRYDATE,103),
			BUYQTY = -SUM(CASE WHEN SELL_BUY = 1 
					THEN TRADEQTY 
					ELSE 0 END),
			SELLQTY = SUM(CASE WHEN SELL_BUY = 2 
					THEN TRADEQTY 
					ELSE 0 END),
			NETQTY = CONVERT(NUMERIC(18,4),0),
			PRICE = SUM(PRICE*TRADEQTY)/SUM(TRADEQTY),
			BUYAMT = -SUM(CASE WHEN SELL_BUY = 1 
					THEN (PRICE*TRADEQTY)
					ELSE 0
					END),
			SELLAMT = SUM(CASE WHEN SELL_BUY = 2 
					THEN (PRICE*TRADEQTY)
					ELSE 0
					END),
			NETAMT = CONVERT(NUMERIC(18,4),0),
			PNLAMT = 0,
			BROKRAGE = SUM(BROKAPPLIED*TRADEQTY),
			SERVICETAXNEW = SUM(F.SERVICE_TAX),
			SERVICETAX = CONVERT(NUMERIC(18,4),0),
			EDUCESS = CONVERT(NUMERIC(18,4),0),
			STAMPDUTY = SUM(CASE WHEN BROKERNOTE = 1
					THEN (BROKER_CHRG)
					ELSE 0   
					END),
			TURNTAX = SUM(CASE WHEN TURNOVER_TAX = 1
					THEN (TURN_TAX)    
					ELSE 0   
					END),
			SERVICE_TAX = FS.SERVICE_TAX,
			CESS_TAX	
		
		INTO	
			#COMCONFIRMATION
	
		FROM
			FOSETTLEMENT F (NOLOCK),
			CLIENT1 C1 (NOLOCK),
			CLIENT2 C2 (NOLOCK),
			FOGLOBALS FS (NOLOCK)
		
		WHERE
			F.PARTY_CODE = C2.PARTY_CODE
			AND C1.CL_CODE = C2.CL_CODE
			AND F.PARTY_CODE >= @FROMCODE
			AND F.PARTY_CODE <= @TOCODE
			AND F.SAUDA_DATE >= @FROMDATE
			AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'
			AND CONVERT(DATETIME,@FROMDATE) >= LEFT(CONVERT(VARCHAR,FS.year_start_dt,109),11)
			AND CONVERT(DATETIME,@TODATE)   <= LEFT(CONVERT(VARCHAR,FS.year_end_dt,109),11)
		
		GROUP BY
			CONVERT(VARCHAR,SAUDA_DATE,103),
			YEAR(SAUDA_DATE),
			MONTH(SAUDA_DATE),
			DAY(SAUDA_DATE),
			f.PARTY_CODE,
			SYMBOL,
			CONVERT(VARCHAR,EXPIRYDATE,103),
			FS.SERVICE_TAX,
			CESS_TAX
	
		
		ORDER BY
			YEAR(SAUDA_DATE),
			MONTH(SAUDA_DATE),
			DAY(SAUDA_DATE),
			F.PARTY_CODE,
			SYMBOL

		UPDATE 
			#COMCONFIRMATION
			SET 
			NETQTY = CONVERT(MONEY,(BUYQTY + SELLQTY)),
			NETAMT = CONVERT(MONEY,(BUYAMT + SELLAMT)),
			EDUCESS = SERVICETAXNEW-(SERVICETAXNEW*100/(100+CESS_TAX)),
			SERVICETAX = SERVICETAXNEW - (SERVICETAXNEW-(SERVICETAXNEW*100/(100+CESS_TAX)))	

			/*
			EDUCESS = (BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) - 
					((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX)))*100/(100+CESS_TAX)),
			SERVICETAX = (BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) -
				  	((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) - 
					((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX)))*100/(100+CESS_TAX)))
			*/
	
	        SET NOCOUNT ON 
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT * FROM #COMCONFIRMATION


		END

	ELSE

		BEGIN
	        SET NOCOUNT ON 
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
		SELECT
			F.PARTY_CODE,
			TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),
			YY = YEAR(SAUDA_DATE),
			MM = MONTH(SAUDA_DATE),
			DD = DAY(SAUDA_DATE),
			COMMODITY = SYMBOL,
			EXPIRY = CONVERT(VARCHAR,EXPIRYDATE,103),
			BUYQTY = -(CASE WHEN SELL_BUY = 1 
					THEN TRADEQTY 
					ELSE 0 END),
			SELLQTY = (CASE WHEN SELL_BUY = 2 
					THEN TRADEQTY 
					ELSE 0 END),
			NETQTY = CONVERT(NUMERIC(18,4),0),
			PRICE = PRICE,
			BUYAMT = -(CASE WHEN SELL_BUY = 1 
					THEN (PRICE*TRADEQTY)
					ELSE 0
					END),
			SELLAMT = (CASE WHEN SELL_BUY = 2 
					THEN (PRICE*TRADEQTY)
					ELSE 0
					END),
			NETAMT = CONVERT(NUMERIC(18,4),0),
			PNLAMT = 0,
			BROKRAGE = (BROKAPPLIED*TRADEQTY),
			SERVICETAXNEW = F.SERVICE_TAX,
			SERVICETAX = CONVERT(NUMERIC(18,4),0),
			EDUCESS = CONVERT(NUMERIC(18,4),0),
			STAMPDUTY = (CASE WHEN BROKERNOTE = 1
					THEN (BROKER_CHRG)
					ELSE 0   
					END),
			TURNTAX = (CASE WHEN TURNOVER_TAX = 1
					THEN (TURN_TAX)    
					ELSE 0   
					END),
			SERVICE_TAX = FS.SERVICE_TAX,
			CESS_TAX
	
		INTO 
			#COMCONFIRMATION_DET	

		FROM
			FOSETTLEMENT F (NOLOCK),
			CLIENT1 C1 (NOLOCK),
			CLIENT2 C2 (NOLOCK),
			FOGLOBALS FS (NOLOCK)
		
		WHERE
			F.PARTY_CODE = C2.PARTY_CODE
			AND C1.CL_CODE = C2.CL_CODE
			AND F.PARTY_CODE >= @FROMCODE
			AND F.PARTY_CODE <= @TOCODE
			AND F.SAUDA_DATE >= @FROMDATE
			AND F.SAUDA_DATE <= @TODATE + ' 23:59:59'
			AND CONVERT(DATETIME,@FROMDATE) >= LEFT(CONVERT(VARCHAR,FS.year_start_dt,109),11)
			AND CONVERT(DATETIME,@TODATE)   <= LEFT(CONVERT(VARCHAR,FS.year_end_dt,109),11)
		
		
		ORDER BY
			YEAR(SAUDA_DATE),
			MONTH(SAUDA_DATE),
			DAY(SAUDA_DATE),
			F.PARTY_CODE,
			SYMBOL
	
		UPDATE 
			#COMCONFIRMATION_DET
			SET 
			NETQTY = CONVERT(MONEY,(BUYQTY + SELLQTY)),
			NETAMT = CONVERT(MONEY,(BUYAMT + SELLAMT)),
			EDUCESS = SERVICETAXNEW-(SERVICETAXNEW*100/(100+CESS_TAX)),
			SERVICETAX = SERVICETAXNEW - (SERVICETAXNEW-(SERVICETAXNEW*100/(100+CESS_TAX)))

			/*
			EDUCESS = (BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) - 
					((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX)))*100/(100+CESS_TAX)),
			SERVICETAX = (BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) -
				  	((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX))) - 
					((BROKRAGE - (BROKRAGE*100/(100+SERVICE_TAX)))*100/(100+CESS_TAX)))
			*/
	

	        SET NOCOUNT ON 
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT * FROM #COMCONFIRMATION_DET


		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_Remissor_Trans_Statement
-- --------------------------------------------------
CREATE Proc Rpt_Remissor_Trans_Statement      
(@FromDate Varchar(11), @ToDate Varchar(11), @FromRemCode Varchar(10), @ToRemCode Varchar(10),@Flag Varchar(1),
@statusid varchar(15),@statusname varchar(25))      
As      
If Upper(@Flag) = 'D'       
Begin      
 Select RemCode, RemName=R1.Long_Name,R.Party_Code, Party_Name=C1.Long_Name,SharingType,      
 Start_Date=Convert(Varchar,Sauda_Date,103),      
 TrdBrk=Sum(Case When TransType = 'TRD' Then ClientTrdBrokerage Else 0 End),      
 DelBrk=Sum(Case When TransType = 'DEL' Then ClientDelBrokerage Else 0 End),      
 TrdTurnOver=Sum(Case When TransType = 'TRD' Then TrdTurnOver Else 0 End),      
 DelTurnOver=Sum(Case When TransType = 'DEL' Then DelTurnOver Else 0 End),      
 TrdSharing=max(Case When TransType = 'TRD' Then Sharing Else 0 End),      
 DelSharing=max(Case When TransType = 'DEL' Then Sharing Else 0 End),      
 TrdRemSharing=sum(Case When TransType = 'TRD' Then RemShareBrokeRage Else 0 End),      
 DelRemSharing=sum(Case When TransType = 'DEL' Then RemShareBrokeRage Else 0 End),      
 TotalRemSharing=Sum(RemShareBrokeRage),      
 DD=Day(Sauda_Date), MM=Month(Sauda_Date), YY=Year(Sauda_Date)      
 from Remissor_Trans_Temp R, Client1 C1, Client2 C2, Client1 R1, Client2 R2      
 Where R.Party_Code = C2.Party_Code      
 And C1.Cl_Code = C2.Cl_Code      
 And R.RemCode = R2.Party_Code      
 And R1.Cl_Code = R2.Cl_Code      
 And Sauda_Date >= @FromDate      
 And Sauda_Date <= @ToDate + ' 23:59:59'      
 And RemCode >= @FromRemCode       
 And RemCode <= @ToRemCode       
 And c1.Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)  
 And c1.sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)  
 And c1.Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)  
 And c1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)  
 And c1.Cl_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)  

 Group By RemCode,R1.Long_Name,R.Party_Code,C1.Long_Name,SharingType,Convert(Varchar,Sauda_Date,103),      
 Day(Sauda_Date), Month(Sauda_Date), Year(Sauda_Date)      
 Order BY RemCode,R.Party_Code, Day(Sauda_Date), Month(Sauda_Date), Year(Sauda_Date)      
End      
Else      
Begin      
 Select RemCode, RemName=R1.Long_Name,R.Party_Code, Party_Name=C1.Long_Name,SharingType,      
 TrdBrk=Sum(Case When TransType = 'TRD' Then ClientTrdBrokerage Else 0 End),      
 DelBrk=Sum(Case When TransType = 'DEL' Then ClientDelBrokerage Else 0 End),      
 TrdTurnOver=Sum(Case When TransType = 'TRD' Then TrdTurnOver Else 0 End),      
 DelTurnOver=Sum(Case When TransType = 'DEL' Then DelTurnOver Else 0 End),      
 TrdSharing=max(Case When TransType = 'TRD' Then Sharing Else 0 End),      
 DelSharing=max(Case When TransType = 'DEL' Then Sharing Else 0 End),      
 TrdRemSharing=sum(Case When TransType = 'TRD' Then RemShareBrokeRage Else 0 End),      
 DelRemSharing=sum(Case When TransType = 'DEL' Then RemShareBrokeRage Else 0 End),      
 TotalRemSharing=Sum(RemShareBrokeRage)      
 from Remissor_Trans_temp R, Client1 C1, Client2 C2, Client1 R1, Client2 R2      
 Where R.Party_Code = C2.Party_Code      
 And C1.Cl_Code = C2.Cl_Code      
 And R.RemCode = R2.Party_Code      
 And R1.Cl_Code = R2.Cl_Code      
 And Sauda_Date >= @FromDate      
 And Sauda_Date <= @ToDate + ' 23:59:59'      
 And RemCode >= @FromRemCode       
 And RemCode <= @ToRemCode       
 And c1.Branch_Cd Like (Case When @statusid = 'branch' then @statusname else  '%' end)  
 And c1.sub_broker Like (Case When @statusid = 'sub_broker' then @statusname else  '%' end)  
 And c1.Trader Like (Case When @statusid = 'trader' then @statusname else  '%' end)  
 And c1.Family Like (Case When @statusid = 'family' then @statusname else  '%' end)  
 And c1.Cl_Code Like (Case When @statusid = 'client' then @statusname else  '%' end)  

 Group By RemCode,R1.Long_Name,R.Party_Code,C1.Long_Name,SharingType      
 Order BY RemCode,R.Party_Code      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SAUDADETAILS
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_SAUDADETAILS]  
		(  
		@FROMDATE VARCHAR(11),  
		@TODATE VARCHAR(11),  
		@FROMPARTY VARCHAR(15),  
		@TOPARTY VARCHAR(15),  
		@STATUSID VARCHAR(10),  
		@STATUSNAME VARCHAR(20)  
		)  
  
 AS  
  
 --EXEC RPT_SAUDADETAILS 'JAN  1 2007','JAN  1 2008','','ZZZZZZZZZZZZZZZ','BROKER','BROKER'  
/*  
 Commodity Query to fetch the Trade Details  
 Report Format :  
 OrderNo,TradeNo,ClientCode,ClientName,ContractDate,ScripName,BuySell,Quantity,ExecRate,NetRate  
   
 Note : Change the hard corderd date condition as per your need  
   
*/  

  IF @FROMPARTY = '' BEGIN SET @FROMPARTY = '0' END
  IF @TOPARTY = '' BEGIN SET @TOPARTY = 'ZZZZZZ'END  
  
Set Transaction Isolation Level read uncommitted

Select  
		OrderNo  = Order_No,  
		TradeNo  = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Trade_No,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U',''),  
		ClientCode = Client2.Party_Code,  
		ClientName = Client1.Long_Name,  
		ContractDate = Convert(Varchar,Sauda_Date,103),  
		FoSettlement.Inst_type,  
		FoSettlement.Symbol,  
		FoSettlement.ExpiryDate,  
		FoSettlement.Strike_Price,  
		FoSettlement.Option_Type,  
		BuySell = Case When Sell_Buy =1 Then 'Buy' else 'Sell' End,  
		Quantity = Sum(TradeQty),  
		ExecRate = Price,  
		NetRate = NetRate,  
		Brokerage = Sum(TradeQty * BrokApplied * BookType/ Instrument),  
		NetAmount = Sum(NetRate * TradeQty  * BookType/ Instrument)  
  
Into   
   #FoSett  

From  
    FoSettlement, Client1, Client2, FoScrip2   

Where  
		Client1.Cl_Code = Client2.Cl_Code  
		And FoSettlement.Party_Code = Client2.Party_Code  
		And FoSettlement.Inst_Type = FoScrip2.Inst_Type  
		And FoSettlement.Symbol = FoScrip2.Symbol  
		And FoSettlement.ExpiryDate = FoScrip2.ExpiryDate  
		And FoSettlement.Option_Type = FoScrip2.Option_Type  
		And FoSettlement.Strike_Price = FoScrip2.Strike_Price  
		And TradeQty > 0  
		And Sauda_Date Between @FROMDATE and @TODATE + ' 23:59'  
		AND FoSettlement.Party_Code >= @FROMPARTY  
		AND FoSettlement.Party_Code <= @TOPARTY
  
Group By  
		Order_No,  
		Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Trade_No,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U',''),  
		Client2.Party_Code,  
		Client1.Long_Name,  
		Convert(Varchar,Sauda_Date,103),  
		FoSettlement.Inst_type,  
		FoSettlement.Symbol,  
		FoSettlement.ExpiryDate,  
		FoSettlement.Strike_Price,  
		FoSettlement.Option_Type,  
		Sell_Buy,  
		Price,  
		NetRate
  
  
IF (SELECT COUNT(1) FROM PRADNYA.DBO.DATAIN_HISTORY_FOSETTLEMENT_NCDX WHERE SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:00') > 0  
BEGIN  
 INSERT INTO #FoSett 
 
 Select  
  OrderNo  = Order_No,  
  TradeNo  = Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Trade_No,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U',''),  
  ClientCode = Client2.Party_Code,  
  ClientName = Client1.Long_Name,  
  ContractDate = Convert(Varchar,Sauda_Date,103),  
  H.Inst_type,  
  H.Symbol,  
  H.ExpiryDate,  
  H.Strike_Price,  
  H.Option_Type,  
  BuySell = Case When Sell_Buy =1 Then 'Buy' else 'Sell' End,  
  Quantity = Sum(TradeQty),  
  ExecRate = Price,  
  NetRate = NetRate,  
  Brokerage = Sum(TradeQty * BrokApplied * BookType/ Instrument),  
  NetAmount = Sum(NetRate * TradeQty  * BookType/ Instrument)

 From  
    PRADNYA.DBO.HISTORY_FOSETTLEMENT_NCDX H, Client1, Client2, FoScrip2
   
 Where  
  Client1.Cl_Code = Client2.Cl_Code  
  And H.Party_Code = Client2.Party_Code  
  And H.Inst_Type = FoScrip2.Inst_Type  
  And H.Symbol = FoScrip2.Symbol  
  And H.ExpiryDate = FoScrip2.ExpiryDate  
  And H.Option_Type = FoScrip2.Option_Type  
  And H.Strike_Price = FoScrip2.Strike_Price  
  And TradeQty > 0  
  And Sauda_Date Between @FROMDATE and @TODATE + ' 23:59'  
  AND H.Party_Code >= @FROMPARTY  
  AND H.Party_Code <= @TOPARTY
 
 Group By  
		Order_No,  
		Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Trade_No,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U',''),  
		Client2.Party_Code,  
		Client1.Long_Name,  
		Convert(Varchar,Sauda_Date,103),  
		H.Inst_type,  
		H.Symbol,  
		H.ExpiryDate,  
		H.Strike_Price,  
		H.Option_Type,  
		Sell_Buy,  
		Price,  
		NetRate  
END  
  
  
IF (SELECT COUNT(1) FROM CHARGES_DETAIL WHERE CD_Sauda_Date BETWEEN @FROMDATE AND @TODATE + ' 23:59:00') > 0  
BEGIN  
 UPDATE     
   #FoSett    
 SET    
   Brokerage =   
  CD_Tot_Brok  + (Case When Service_Chrg = 1 Then CD_Tot_SerTax Else 0 End)  
 FROM    
  CHARGES_DETAIL , Client2   
 WHERE    
  Convert(Varchar,CD_Sauda_Date,103) = ContractDate   
  And CD_Party_Code = ClientCode  
  And CD_Inst_Type = Inst_Type  
  And CD_Symbol = Symbol    
  And CD_Expiry_Date = ExpiryDate    
  And CD_Option_Type = Option_Type    
  And CD_Strike_Price = Strike_Price    
  And CD_Trade_No = TradeNo    
  And CD_Order_No = OrderNo   
  And Client2.Party_Code = CD_Party_Code  
  AND CD_Party_Code >= @FROMPARTY  
  AND CD_Party_Code <= @TOPARTY  
END  
  
  
Select   
 *   
From   
 #FoSett   
Order By  
 ContractDate,  
 ClientCode,  
 Inst_type,  
 Symbol,  
 ExpiryDate,  
 Strike_Price,  
 Option_Type,  
 BuySell,  
 ExecRate  
  
  
Drop Table #FoSett

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SBUMASTER
-- --------------------------------------------------
CREATE PROC RPT_SBUMASTER 
(
	@Sbu_CodeFROM VARCHAR(10),
	@Sbu_CodeTO   VARCHAR(10)
	
)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @Sbu_CodeFROM = '' BEGIN SET @Sbu_CodeFROM = '0' END
IF @Sbu_CodeTO = '' BEGIN SET @Sbu_CodeTO = 'ZZZ' END

BEGIN
	Select 
		Sbu_Code,Sbu_Name,Sbu_Addr1,Sbu_Addr2,Sbu_Addr3,Sbu_State,Sbu_City,Sbu_Zip,Sbu_Phone1,Sbu_Phone2,Sbu_Type,Sbu_Party_Code  
	From 
		SBU_MASTER (nolock)
	Where 
		sbu_code >= @Sbu_CodeFROM
		And sbu_code <= @Sbu_CodeTO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_spansalepur
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.rpt_spansalepur    Script Date: 1/17/2004 11:42:54 PM ******/





CREATE    procedure rpt_spansalepur
@partycode varchar(12),
@sdate varchar(10)
AS
select distinct  Party_code,Symbol,expirydate,inst_type,option_type,strike_price ,pqty,sqty from bbgspansalepur
where  pqty <> sqty and expirydate >= @sdate and Party_Code like @partycode + '%'
group by Party_Code,Symbol,expirydate,inst_type,option_type,strike_price,pqty,sqty

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STAMP_DUTY_DETAILS
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_STAMP_DUTY_DETAILS]
(
	@SAUDA_DATE VARCHAR(11),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@RPTTYPE VARCHAR(10),----ALL-0/MATCH-1/MISMATCH-2
	@RPTON VARCHAR(10) --PARTY-P/SCRIP-S/PARTY&SCRIP-PS
)
AS

SELECT   
	 @SAUDA_DATE = CASE WHEN LEN(@SAUDA_DATE) = 10 AND CHARINDEX('/', @SAUDA_DATE) > 0          
     THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)          
     ELSE @SAUDA_DATE END    

	 IF @FPARTY =''          
	 BEGIN          
	  SET @FPARTY ='0'          
	 END          
	 IF @TPARTY =''          
	 BEGIN          
	  SET @TPARTY ='ZZZZZZZ'          
	 END
IF @RPTON='P'
BEGIN
	IF @RPTTYPE='2'
	BEGIN
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 20 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE,TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(TOTALSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE ) A 
		GROUP BY PARTY_CODE
		HAVING ABS(SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)) > 0

	END
	IF @RPTTYPE='1'
	BEGIN
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 20 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE,TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(TOTALSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE ) A 
		GROUP BY PARTY_CODE
		HAVING SUM(TOTALSTAMP_EX) = SUM(TOTALSTAMP_BO)
	END
	IF @RPTTYPE='0'
	BEGIN
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 20 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE,TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=sum(TOTALSTAMP)--SUM(BUYSQSTAMP+BUYDELSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE ) A 
		GROUP BY PARTY_CODE
	END
END
IF @RPTON='S'
BEGIN
	IF @RPTTYPE='2'
	BEGIN
		SELECT  SYMBOL,INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		
		GROUP BY INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A 

		GROUP BY INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE
		HAVING ABS(SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)) > 0
	END
	IF @RPTTYPE='1'
	BEGIN
		SELECT  SYMBOL,INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 
		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A 

		GROUP BY INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE
		HAVING ABS(SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)) = 0 AND SUM(TOTALSTAMP_EX)<>0
	END
	IF @RPTTYPE='0'
	BEGIN
		SELECT  SYMBOL,INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT SYMBOL, INST_TYPE, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A 

		GROUP BY INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE 
	END
END

IF @RPTON='PS'
BEGIN
	IF @RPTTYPE='2'
	BEGIN 
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE
		HAVING ABS(SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)) > 0
	END
	IF @RPTTYPE='1'
	BEGIN 
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE
		HAVING ABS(SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)) = 0 AND SUM(TOTALSTAMP_EX)<>0
	END
	IF @RPTTYPE='0'
	BEGIN 
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		TOTALSTAMP_EX=SUM(TOTALSTAMP_EX),TOTALSTAMP_BO=SUM(TOTALSTAMP_BO), DIFF = SUM(TOTALSTAMP_EX-TOTALSTAMP_BO)
		FROM (
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=SUM(TOTALSTAMP),TOTALSTAMP_BO=CONVERT(NUMERIC(18,2),0)
		FROM TBL_STAMP_EXCHG
		WHERE SAUDA_DATE = @SAUDA_DATE AND 
		RECTYPE = 30 AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRY_DATE, STRIKE_PRICE, OPTION_TYPE 
		UNION ALL
		SELECT PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE=left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,
		TOTALSTAMP_EX=CONVERT(NUMERIC(18,2),0), TOTALSTAMP_BO=SUM(BUYSTAMP+SELLSTAMP)
		FROM TBL_STAMP_DATA 
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND PARTY_CODE >= @FPARTY  AND PARTY_CODE <= @TPARTY 

		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, left(EXPIRYDATE,11), STRIKE_PRICE, OPTION_TYPE ) A  
		GROUP BY PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE 
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_StampDuty_New
-- --------------------------------------------------

--Exec Rpt_StampDuty_New 'Aug  1 2001','Aug 31 2006'

CREATE  Proc [dbo].[Rpt_StampDuty_New] 
(
@Start_Date Varchar(11), 
@End_Date Varchar(11)
)      
    
As      

Select    
	Sauda_Date = Left(Sauda_Date,11),
	Totamt = Sum(tradeqty * Price * Booktype / Instrument),  
	Cl_Type,     
	L_State
Into  	
	#StampDuty    
From    
	fosettlement, 
	Client2, 
	Client1       
Where    
	Sauda_date >= @Start_Date 
	And Sauda_date <= @End_Date + ' 23:59'      
	And fosettlement.party_code = Client2.party_code           
	And Client1.Cl_code = Client2.Cl_code           
	And auctionpart not like 'C%'  
	--and auctionpart not like 'E%'    
	And TradeQty > 0          
group by    
	Cl_Type, 
	L_State, 
	Left(Sauda_Date,11)
  
---------------------------------------------------------------------------  

Insert Into #StampDuty      
Select    
	Sauda_Date = Left(Sauda_Date,11),
	Totamt = Sum(tradeqty * Price * Booktype / Instrument),  
	Cl_Type,    
	L_State
From     
	Pradnya.dbo.History_Fosettlement_Nce, Client2, Client1
Where  
	Sauda_date >= @Start_Date 
	And Sauda_date <= @End_Date + ' 23:59'      
	And Pradnya.dbo.History_Fosettlement_nce.party_code = Client2.party_code           
	And Client1.Cl_code = Client2.Cl_code           
	And auctionpart not like 'C%'  
	--and auctionpart not like 'E%'          
	And TradeQty > 0          
Group By    
	Cl_Type, 
	L_State, 
	Left(Sauda_Date,11)

---------------------------------------------------------------------------  
 
Select         
	Sauda_Date,
	TotalAmt = convert(numeric(18,4), sum(totamt)),      
	Cl_Type, 
	L_State
Into  
	#StampDuty_Report      
From     
	#StampDuty     
Where  
	L_State = 'MAHARASHTRA'      
Group by    
	Cl_Type, 
	L_State, 
	Sauda_Date

---------------------------------------------------------------------------  

Insert Into #StampDuty_Report      
Select         
	Sauda_Date,
	TotalAmt = sum(totamt),      
	Cl_Type,    
	L_State = Foowner.State
From     
	#StampDuty, Foowner  
Where  
	Not Exists (Select State From State_Master Where State = L_State )      
Group by     
	Cl_Type, 
	Foowner.State, 
	Sauda_Date
 
---------------------------------------------------------------------------  

Insert Into #StampDuty_Report      
Select         
	Sauda_Date,
	TotalAmt = sum(totamt),      
	Cl_Type,    
	L_State = 'OTHER'
From  
	#StampDuty    
Where  
	Exists (Select State_Master.State From State_Master, Foowner   
	Where State_Master.State = L_State And State_Master.State <> Foowner.State)      
Group by  
	Cl_Type, 
	L_State, 
	Sauda_Date

---------------------------------------------------------------------------  
      
Select       
	/*Sauda_Date	     = Year(Sauda_Date),
	DateOfMonth 	     = Month(Sauda_Date),*/
	TotTurn              = isnull(Sum(TotalAmt),0),      
	TotTurnOtherState    = isnull(Sum(Case When L_State <> 'MAHARASHTRA' Then TotalAmt Else 0 End),0),      
	TotTurnMahState      = isnull(Sum(Case When L_State = 'MAHARASHTRA' Then TotalAmt Else 0 End),0),
	TotStampMahState     = isnull(Sum(Case When L_State = 'MAHARASHTRA' 
					Then Ceiling((TotalAmt*0.001)/100)
					Else 0 End),0),
	TotStampOtherState   = isnull(Sum(Case When L_State <> 'MAHARASHTRA' 
					Then Ceiling((TotalAmt*0.001)/100)
					Else 0 End),0)
From  
	#StampDuty_Report      
      
/*Group By 
	Year(Sauda_Date),
	Month(Sauda_Date)

Order By 
	Sauda_Date,
	DateOfMonth
*/
---------------------------------------------------------------------------  

Drop Table #StampDuty_Report      
Drop Table #StampDuty      
    
---------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_StampDuty_New_Report
-- --------------------------------------------------
  
-- EXEC Rpt_StampDuty_New_Report 'May 15 2000','May 15 2009','%'  
  
  
CREATE Proc [dbo].[Rpt_StampDuty_New_Report] (@Start_Date Varchar(11), @End_Date Varchar(11), @State Varchar(50))        
    
 As          
  
 Select          
  Totamt = sum(case    
    when AuctionPart = 'EA'     
    then    
    (Case    
    When Inst_Type Like 'OPT%' And AuctionPart = 'EA'       
     Then    
  TradeQty * Strike_Price  
    Else    
  TradeQty * Price * Booktype / Instrument    
    End)     
   else 0    
   end),     
  Totalamt = sum(case    
    when AuctionPart = ''     
    then    
    (Case    
    When Inst_Type Like 'OPT%' And AuctionPart = 'EA'       
     Then    
  TradeQty * Strike_Price      
    Else    
  TradeQty * Price * Booktype / Instrument   
    End)     
   else 0    
   end),    
  BrokChrg = sum(case    
   when     
  AuctionPart = 'EA'     
  then    
   (CASE WHEN BrokerNote = 1 THEN Broker_Chrg ELSE 0 END)  
  Else    
  0    
  End),     
  BrokerChrg = sum(case    
   when     
  AuctionPart = ''     
  then    
   (CASE WHEN BrokerNote = 1 THEN Broker_Chrg ELSE 0 END)       
  Else    
  0    
  End),    
  ATSTAMP = Convert(Numeric(18,4),0),                  
  ADSTAMP = Convert(Numeric(18,4),0),    
  Cl_Type,           
  L_State             
 Into        
  #StampDuty          
 From          
  fosettlement, Client2, Client1             
 where          
  Sauda_date >= @Start_Date and Sauda_date <= @End_Date + ' 23:59'            
  and fosettlement.party_code = Client2.party_code                 
  and Client1.Cl_code = Client2.Cl_code                 
  And TradeQty > 0 And Price > 0           
  and auctionpart not like 'C%'            
  And L_State Like @State   
 group by          
  Cl_Type, L_State              
 
  
        
 Insert Into #StampDuty            
 Select          
  Totamt = sum(case    
    when AuctionPart = 'EA'     
    then    
    (Case    
    When Inst_Type Like 'OPT%' And AuctionPart = 'EA'       
     Then    
  TradeQty * Strike_Price      
    Else    
  TradeQty * Price * Booktype / Instrument   
    End)     
   else 0    
   end),     
  Totalamt = sum(case    
    when AuctionPart = ''     
    then    
    (Case    
    When Inst_Type Like 'OPT%' And AuctionPart = 'EA'       
     Then    
  TradeQty * Strike_Price      
    Else    
  TradeQty * Price * Booktype / Instrument   
    End)     
   else 0    
   end),     
  BrokChrg = sum(case    
   when     
  AuctionPart = 'EA'     
  then    
    (CASE WHEN BrokerNote = 1 THEN Broker_Chrg ELSE 0 END)       
  Else    
  0    
  End),     
      
  BrokerChrg = sum(case    
   when     
  AuctionPart = ''     
  then    
   (CASE WHEN BrokerNote = 1 THEN Broker_Chrg ELSE 0 END)        
  Else    
  0    
  End),    
  ATSTAMP = Convert(Numeric(18,4),0),                  
  ADSTAMP = Convert(Numeric(18,4),0),    
  Cl_Type,          
  L_State             
 From           
  Pradnya.dbo.History_Fosettlement_nce, Client2, Client1           
 where        
  Sauda_date >= @Start_Date and Sauda_date <= @End_Date + ' 23:59'            
  and Pradnya.dbo.History_Fosettlement_nce.party_code = Client2.party_code                 
  and Client1.Cl_code = Client2.Cl_code                 
  And TradeQty > 0 And Price > 0                    
  And L_State Like @State    
  and auctionpart not like 'C%'            
  And BrokerNote = 1  
 group by          
  Cl_Type, L_State       
     
     
 UPDATE #StampDuty SET     
 ATSTAMP = (Totalamt * TRDSTAMPDUTY / 100),    
 ADSTAMP = (Totamt * DELSTAMPDUTY / 100)    
 FROM STATE_MASTER    
 WHERE L_STATE = STATE    
     
 UPDATE #StampDuty SET     
 ATSTAMP = (Totalamt * TRDSTAMPDUTY / 100),    
 ADSTAMP = (Totamt * DELSTAMPDUTY / 100)    
 FROM STATE_MASTER    
 WHERE STATE = 'MAHARASHTRA'    
 AND L_STATE NOT IN (SELECT STATE FROM STATE_MASTER)    
       
 Select     
 L_State,      
 ProDelAmt = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type = 'PRO'     
   Then TotAmt    
   Else 0    
     End)),    
 ProTrdAmt = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type = 'PRO'     
   Then TotalAmt    
   Else 0    
     End)),    
 NrmTrdAmt = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type <> 'PRO'     
   Then TotalAmt    
   Else 0    
     End)),    
 NrmDelAmt = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type <> 'PRO'     
   Then TotAmt    
   Else 0    
     End)),    
 ProTrd = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type = 'PRO'    
   Then BrokerChrg    
   Else 0    
     End)),    
 ProDel = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type = 'PRO'     
   Then BrokChrg    
   Else 0    
     End)),    
 NrmTrd = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type <> 'PRO'     
   Then BrokerChrg    
   Else 0    
     End)),    
 NrmDel = Convert(Numeric(18,4),     
     Sum(Case When Cl_Type <> 'PRO'     
   Then BrokChrg    
   Else 0    
     End)),    
 ProTrd1 = convert(numeric(18,4),       
  Sum(Case When Cl_Type = 'PRO'      
     Then ATSTAMP      
     Else 0    
    End)),    
 ProDel1 = convert(numeric(18,4),       
  Sum(Case When Cl_Type = 'PRO'       
        Then ADSTAMP    
       Else 0    
     End)),        
     
 NrmTrd1 = convert(numeric(18,4),       
  Sum(Case When Cl_Type = 'PRO'       
       Then 0      
       Else ATSTAMP    
    End)),    
     
 NrmDel1 = convert(numeric(18,4),       
  Sum(Case When Cl_Type = 'PRO'       
       Then 0             
       Else ADSTAMP         
     End)),     
 TotalAmt = convert(numeric(18,4), sum(totamt + TotalAmt))      
     
 Into #StampDuty_Report              
 From #StampDuty        
 Group by L_State     
     
 Select Exchange='NCE', Segment='FUTURES',*,TotalStampDuty = (ProTrd1+ProDel1+NrmTrd1+NrmDel1) From #StampDuty_Report              
 Order by L_State    


 Drop Table #StampDuty_Report          
 Drop Table #StampDuty

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_StateMaster
-- --------------------------------------------------
CREATE  Proc [dbo].[rpt_StateMaster]
	(
	@srt_odr varchar(7)
	)

	AS

set transaction isolation level read uncommitted
select
	ReportOrder = 
			Case 
				When @srt_odr ='state'  Then State
				When @srt_odr ='edtTrd' Then Convert(Varchar,TrdStampDuty)
				When @srt_odr ='edtDel' Then Convert(Varchar,DelStampDuty)
			End,
	State,
	TrdStampDuty,
	DelStampDuty,
	ProStampDuty,
	Min_Multiplier,
	For_Turnover,
	Maximum_Limit
from
	state_master (nolock)  

Order By
	1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_todaydate
-- --------------------------------------------------
Create Procedure Rpt_todaydate  
As  
Select Convert(Varchar, Getdate(), 103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TRADEDETAILS
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_TRADEDETAILS]
	(
	@FROMDATE	VARCHAR(11),
	@TODATE		VARCHAR(11),
	@SELLBUY	CHAR(1),
	@VALUE		MONEY = 0
	)

	AS

	-- RPT_TRADEDETAILS 'JAN  1 2000','DEC 31 2010','1',0

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT 
		COMPANY,
		MEMBERCODE,
		USER_ID,
		SYMBOL,
		EXPIRYDATE=LEFT(EXPIRYDATE,11),
		TRADETIME = CPID,
		TRADEDATE =LEFT(SAUDA_DATE,11),
		TRADENO = TRADE_NO,
		PRICE,
		TRADEQTY,
		VALUE = (TRADEQTY*PRICE),
		LONG_NAME = C1.LONG_NAME,
		PARTY_CODE = F.PARTY_CODE,
		ADDRESS = L_ADDRESS1+'  '+L_ADDRESS2+' '+L_ADDRESS3+' '+L_CITY+' '+L_ZIP,
		CONTRACTNO,
		PAN_GIR_NO
	FROM
		FOSETTLEMENT F (NOLOCK),
		CLIENT1 C1 (NOLOCK),
		CLIENT2 C2 (NOLOCK),
		FOOWNER O (NOLOCK)
	WHERE
		F.PARTY_CODE = C2.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
		AND SELL_BUY = @SELLBUY
		AND (TRADEQTY*PRICE) > @VALUE
		AND TRADEQTY > 0
	ORDER BY
		LEFT(SAUDA_DATE,11),
		F.PARTY_CODE,
		SYMBOL,
		LEFT(EXPIRYDATE,11)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_translogreport
-- --------------------------------------------------

CREATE  proceDURE [dbo].[rpt_translogreport]
	(
		@fromparty varchar(20),
		@toparty varchar(20),
		@symbol varchar(12),
		@expdate varchar(12),
		@sauda varchar(12),
		@contno varchar(12)
	) as

	select 
		FromParty,
		ToParty,
		Option_type,
		Inst_type,
		Symbol,left(convert(varchar,expirydate,109),11) as 	Expirydate,
		Strike_price,
		Qty,
		Sell_Buy,
		left(convert(varchar,sauda_date,109),11) as Sauda_date,
		ContractNo,
		left(convert(varchar,SplitDate,109),11)	as splitdate,
		TradeNo 
	from 
		Contlogin 
	where 
		FromParty like @fromparty +'%'
		And toparty like @toparty +'%'
		and symbol like @symbol +'%'
		and expirydate like @expdate+'%' 
		and sauda_date like @sauda +'%'
		and contractno like @contno +'%'

	order by 
	fromparty,
	inst_type,
	symbol,
	expirydate,
	strike_price,
	option_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_TransStatementBen
-- --------------------------------------------------
CREATE    Proc Rpt_TransStatementBen             
(@FromDate varchar(11), @ToDate varchar(11), @FromParty varchar(10), @ToParty varchar(10), @FromScrip varchar(12), @ToScrip varchar(12),            
@CltDpId varchar(16), @DpId varchar(10), @Flag Int, @StatusID Varchar(50), @StatusName VarChar(50) )            
As             



If Len(@DpID) < 8       
 Select @DpId = '%'      
      
If Len(@CltDpId) < 8       
 Select @CltDpId = '%'      

     
  
Set Transaction isolation level read uncommitted              
select * into #Del_TransStat From Delivery_Transaction With(NoLock)               
Where Party_Code >= @FromParty And Party_Code <= @ToParty              
and Symbol >= @FromScrip And Symbol <= @ToScrip              
And TransDate >= @FromDate and TransDate <= @ToDate              
  
CREATE   
  INDEX [DELHOLD] ON [dbo].[#Del_TransStat] ([transdate], [Party_Code], [Symbol], [holdername], [DrCr], [BDpType], [BDpId], [BCltDpId])  
  
  
if @Flag = 1             
Begin            
 Select  TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo, DpId=BDpId, CltDpId=BCltDpID, TrType,             
  Reason = (Case When HolderName Like 'Margin%' Then 'Trans To Margin' Else 'Trans To Ben' End),            
   BDpId, BCltDpId, TransDate1 = TransDate,FLAG=1            
 Into #Del_TransStat_1
 from  #Del_TransStat D,             
  Client2 C2,             
  Client1 C1            
 where  drcr = 'D'             
 And  ShareType <> 'AUCTION'             
 And  ISIN Like 'IN%'            
 and  Delivered = 'G'             
 And  Filler2 = 0             
 And  C2.Cl_Code = C1.Cl_Code             
 And  C2.Party_Code = D.Party_Code             
 And  TransDate >= @FromDate             
 And  TransDate <= @ToDate            
 And  d.Party_Code >= @FromParty             
 And  d.Party_Code <= @ToParty            
 And  D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And  HolderName Like '%' + RTrim(LTRim(@CltDpId)) + '%'            
 And HolderName Not Like 'MARGIN%'                
 --And Sett_No <> '2000000'            
 AND  c1.branch_cd like  (case when @statusid = 'branch'   then @statusname else '%' end)            
 AND  c1.sub_broker like  (case when @statusid = 'subbroker'  then @statusname else '%' end)            
 AND  c1.trader like   (case when @statusid = 'trader'   then @statusname else '%' end)            
 AND  c1.family like   (case when @statusid = 'family'   then @statusname else '%' end)            
 AND  c2.party_code like  (case when @statusid = 'client'   then @statusname else '%' end)             
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId, HolderName              
            
 Union All 
 Select  TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo, DpId=DpId, CltDpId=CltDpID, TrType,    
  Reason , BDpId, BCltDpId, TransDate1 = TransDate,FLAG=2              
 from  #Del_TransStat D,             
  Client2 C2,  
  Client1 C1            
 where  drcr = 'C'             
 And  ShareType <> 'AUCTION'             
 And  ISIN Like 'IN%'            
 /*and Delivered = '0'*/ And Filler2 = 1             
 And  C2.Cl_Code = C1.Cl_Code             
 And  C2.Party_Code = D.Party_Code             
 And  TransDate >= @FromDate            
 And  TransDate <= @ToDate            
 And  d.Party_Code >= @FromParty             
 And  d.Party_Code <= @ToParty            
 And  D.Symbol >= @FromScrip             
 And  D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 AND FILLER1 NOT IN ('SPLIT','BONUS')            
 AND  c1.branch_cd like  (case when @statusid = 'branch'   then @statusname else '%' end)            
 AND  c1.sub_broker like  (case when @statusid = 'subbroker'  then @statusname else '%' end)            
 AND  c1.trader like   (case when @statusid = 'trader'   then @statusname else '%' end)            
 AND  c1.family like   (case when @statusid = 'family'   then @statusname else '%' end)            
 AND  c2.party_code like  (case when @statusid = 'client'   then @statusname else '%' end)             
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId ,Reason            
            
 Union All       
            
 Select  TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo=0, DpId='', CltDpId='', TrType,             
  Reason , BDpId, BCltDpId, TransDate1 = TransDate,FLAG=3              
 from  #Del_TransStat D, Client2 C2, Client1 C1            
 where  drcr = 'C'             
 And  ShareType <> 'AUCTION'             
 And  ISIN Like 'IN%'            
 and  Delivered = '0'             
 And  Filler2 = 1             
 And  C2.Cl_Code = C1.Cl_Code             
 And  C2.Party_Code = D.Party_Code             
 And  TransDate >= @FromDate             
 And  TransDate <= @ToDate            
 And  d.Party_Code >= @FromParty             
 And  d.Party_Code <= @ToParty            
 And  D.Symbol >= @FromScrip             
 And  D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 AND  FILLER1 IN ('SPLIT','BONUS')            
 AND  c1.branch_cd like  (case when @statusid = 'branch'   then @statusname else '%' end)            
 AND  c1.sub_broker like  (case when @statusid = 'subbroker'  then @statusname else '%' end)            
 AND  c1.trader like   (case when @statusid = 'trader'   then @statusname else '%' end)            
 AND  c1.family like   (case when @statusid = 'family'   then @statusname else '%' end)            
 AND  c2.party_code like  (case when @statusid = 'client'   then @statusname else '%' end)             
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId ,Reason            
            
 Union All
 select  TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,            
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = 0, DQty = Sum(Qty), SlipNo=(CASE WHEN FILLER1 = 'SPLIT' THEN 0 ELSE SLIPNO END),             
  DpId =  (Case  When TrType in (1000,907,908)  Then ''             
            When filler1 = 'split'    Then ''            
            when filler1 Like 'Change To%'  Then ''              
           Else DpId end),             
  CltDpId = (Case  When TrType in (1000,907,908)  then ''             
    When filler1 = 'split'    Then ''           
                         when filler1 Like 'Change To%'  Then ''            
      else CltDpId    
      end),            
  TrType,             
  Reason =  (Case  When TrType in (1000,907,908)  Then 'Trans To Pool - ' + ISett_No + '-' + ISett_Type             
           Else             
    (case  when filler1 = 'split'    then 'CORPORATE ACTION'             
                when filler1 Like 'Change To%'      then Filler1            
              Else             
    (Case  When Reason = 'DEMAT'           Then 'Pay-Out'             
    Else  Reason             
    End)             
    end)            
    End),             
  BDpId, BCltDpId, TransDate1 = TransDate,FLAG=4              
 from  #Del_TransStat D,             
  Client2 C2,             
  Client1 C1            
 where  filler2 = 1             
 and  drcr = 'D'             
 and  Delivered <> '0'             
 And  ShareType <> 'AUCTION'             
 And  ISIN Like 'IN%'            
 And  C2.Cl_Code = C1.Cl_Code             
 And  C2.Party_Code = D.Party_Code             
 And  TransDate >= @FromDate             
 And  TransDate <= @ToDate            
 And  d.Party_Code >= @FromParty             
 And  d.Party_Code <= @ToParty            
 And  D.Symbol >= @FromScrip             
 And  D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 AND  c1.branch_cd like  (case when @statusid = 'branch'   then @statusname else '%' end)            
 AND  c1.sub_broker like  (case when @statusid = 'subbroker'  then @statusname else '%' end)            
 AND  c1.trader like   (case when @statusid = 'trader'   then @statusname else '%' end)            
 AND  c1.family like   (case when @statusid = 'family'   then @statusname else '%' end)            
 AND  c2.party_code like  (case when @statusid = 'client'   then @statusname else '%' end)             
 And  HolderName Not Like 'MARGIN%'            
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId , FILLER1, reason            
            
 Union All
 Select  TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
  D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = 0, DQty = Sum(Qty), SlipNo, DpId=dp.DpId, CltDpId=dp.dpcltno, TrType,             
  Reason = (Case When HolderName Like 'Margin%' Then 'Trans To Margin' Else 'Trans To Ben' End),            
   BDpId, BCltDpId, TransDate1 = TransDate,FLAG=1            
 from  #Del_TransStat D,             
  Client2 C2,             
  Client1 C1,             
  deliverydp dp            
 where  drcr = 'D'             
 And  ShareType <> 'AUCTION'             
 And  ISIN Like 'IN%'            
 and  Delivered = 'G'             
 And  Filler2 = 0             
 And  C2.Cl_Code = C1.Cl_Code             
 And  C2.Party_Code = D.Party_Code             
 And  TransDate >= @FromDate             
 And  TransDate <= @ToDate            
 And  d.Party_Code >= @FromParty             
 And  d.Party_Code <= @ToParty            
 And  D.Symbol >= @FromScrip             
 And  D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 And Description not like '%POOL%'          
 and  (holdername like 'ben ' + Dp.DpCltNo             
  Or holdername like 'Margin ' + Dp.DpCltNo)          
 AND  c1.branch_cd like  (case when @statusid = 'branch'   then @statusname else '%' end)            
 AND  c1.sub_broker like  (case when @statusid = 'subbroker'  then @statusname else '%' end)            
 AND  c1.trader like   (case when @statusid = 'trader'   then @statusname else '%' end)            
 AND  c1.family like   (case when @statusid = 'family'   then @statusname else '%' end)            
 AND  c2.party_code like  (case when @statusid = 'client'   then @statusname else '%' end)             
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
  c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,           
  D.Symbol, ISIN, SlipNo, TrType, dp.dpid, dpcltno , ISett_No, ISett_Type, BDpId, BCltDpId, HolderName              

	Select TransDate=Convert(Varchar,Convert(DateTime,@FromDate),103),
	Sett_No='',Sett_Type='',Party_Code,Long_Name,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,l_city,L_State,
	L_ZIP,Family,Symbol,Scrip_Name,ISIN,
	CQty=(Case When Sum(CQty-DQty) > 0 Then Sum(CQty-DQty) Else 0 End),
	DQty=(Case When Sum(DQty-CQty) > 0 Then Sum(DQty-CQty) Else 0 End),
	SlipNo='0',DpId='',CltDpId='',TrType='0',Reason='OPENING BALANCE',BDpId='',BCltDpId='',
	TransDate1=Convert(DateTime,@FromDate),FLAG=0
	From #Del_TransStat_1
	Where TransDate1 < @FromDate 
	Group By Party_Code,Long_Name,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,l_city,L_State,
	L_ZIP,Family,Symbol,Scrip_Name,ISIN
	Union All
	select * from  #Del_TransStat_1
	Where TransDate1 >= @FromDate and TransDate1 <= @ToDate
	Union All
	Select TransDate=Convert(Varchar,Convert(DateTime,@ToDate),103),
	Sett_No='',Sett_Type='',Party_Code,Long_Name,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,l_city,L_State,
	L_ZIP,Family,Symbol,Scrip_Name,ISIN,
	CQty=(Case When Sum(CQty-DQty) > 0 Then Sum(CQty-DQty) Else 0 End),
	DQty=(Case When Sum(DQty-CQty) > 0 Then Sum(DQty-CQty) Else 0 End),
	SlipNo='0',DpId='',CltDpId='',TrType='0',Reason='CLOSING BALANCE',BDpId='',BCltDpId='',
	TransDate1=Convert(DateTime,@ToDate),FLAG=6
	From #Del_TransStat_1
	Where TransDate1 <= @ToDate
	Group By Party_Code,Long_Name,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,l_city,L_State,
	L_ZIP,Family,Symbol,Scrip_Name,ISIN
	Order By Party_Code, Symbol, ISIN, TransDate1, FLAG, Sett_No, Sett_Type
End            
Else            
begin            
 Select TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo, DpId=BDpId, CltDpId=BCltDpID, TrType,             
 Reason = (Case When HolderName Like 'Margin%'             
                 Then 'Trans To Margin'             
                 Else 'Trans To Ben'             
           End),            
 BDpId, BCltDpId, TransDate1 = TransDate,FLAG=1
 Into #Del_TransStat_2
 from #Del_TransStat D, Client2 C2, Client1 C1            
 where drcr = 'D' And ShareType <> 'AUCTION' And ISIN Like 'IN%'            
 and Delivered = 'G' And Filler2 = 0             
 And C2.Cl_Code = C1.Cl_Code And C2.Party_Code = D.Party_Code             
 And TransDate >= @FromDate And TransDate <= @ToDate            
 And d.Party_Code >= @FromParty And d.Party_Code <= @ToParty            
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And HolderName Like '%' + RTrim(LTRim(@CltDpId)) + '%'            
 And HolderName Not Like 'MARGIN%'                
 --And Sett_No <> '2000000'                
 AND c1.branch_cd like (case when @statusid = 'branch' then @statusname else '%' end)            
 AND c1.sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end)            
 AND c1.trader like (case when @statusid = 'trader' then @statusname else '%' end)            
 AND c1.family like (case when @statusid = 'family' then @statusname else '%' end)            
 AND c2.party_code like (case when @statusid = 'client' then @statusname else '%' end)             
            
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId, HolderName             

 Union All 
 Select TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo, DpId=DpId, CltDpId=CltDpID, TrType,             
 Reason , BDpId, BCltDpId, TransDate1 = TransDate,FLAG=2              
 from #Del_TransStat D, Client2 C2, Client1 C1            
 where drcr = 'C' And ShareType <> 'AUCTION' And ISIN Like 'IN%'            
 And Filler2 = 1             
 And C2.Cl_Code = C1.Cl_Code And C2.Party_Code = D.Party_Code             
 And TransDate >= @FromDate And TransDate <= @ToDate            
 And d.Party_Code >= @FromParty And d.Party_Code <= @ToParty            
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 AND FILLER1 NOT IN ('SPLIT','BONUS')            
            
 AND c1.branch_cd like (case when @statusid = 'branch' then @statusname else '%' end)            
 AND c1.sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end)            
 AND c1.trader like (case when @statusid = 'trader' then @statusname else '%' end)            
 AND c1.family like (case when @statusid = 'family' then @statusname else '%' end)            
 AND c2.party_code like (case when @statusid = 'client' then @statusname else '%' end)             
            
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,         
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId ,Reason            

 Union All           

 Select TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = Sum(Qty), DQty = 0, SlipNo=0, DpId='', CltDpId='', TrType,             
 Reason , BDpId, BCltDpId, TransDate1 = TransDate,FLAG=3              
 from #Del_TransStat D, Client2 C2, Client1 C1            
 where drcr = 'C' And ShareType <> 'AUCTION' And ISIN Like 'IN%'            
 and Delivered = '0' And Filler2 = 1             
 And C2.Cl_Code = C1.Cl_Code And C2.Party_Code = D.Party_Code             
 And TransDate >= @FromDate And TransDate <= @ToDate            
 And d.Party_Code >= @FromParty And d.Party_Code <= @ToParty            
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 AND FILLER1 IN ('SPLIT','BONUS')            
            
 AND c1.branch_cd like (case when @statusid = 'branch' then @statusname else '%' end)            
 AND c1.sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end)            
 AND c1.trader like (case when @statusid = 'trader' then @statusname else '%' end)            
 AND c1.family like (case when @statusid = 'family' then @statusname else '%' end)            
 AND c2.party_code like (case when @statusid = 'client' then @statusname else '%' end)             
            
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId ,Reason            

 Union All          
 select TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,            
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = 0, DQty = Sum(Qty), SlipNo=(CASE WHEN FILLER1 = 'SPLIT' THEN 0 ELSE SLIPNO END),             
 DpId = (Case When TrType in (1000,907,908) then ''             
          When filler1 = 'split'  Then ''            
          when filler1 Like 'Change To%' Then ''            
          Else DpId end),             
 CltDpId = (Case When TrType in (1000,907,908) then ''             
   When filler1 = 'split'  Then ''             
                when filler1 Like 'Change To%' Then ''             
   else CltDpId end),TrType,             
 Reason = (Case When TrType in (1000,907,908)            
         Then 'Trans To Pool - ' + ISett_No + '-' + ISett_Type             
         Else (case when filler1 = 'split'             
              then 'CORPORATE ACTION'             
              when filler1 Like 'Change To%'            
              then Filler1               
              /*when filler1 Like 'Change From%'            
              then 'Pay-Out'   */            
              Else (Case When Reason = 'DEMAT' Then 'Pay-Out' Else Reason End) end)            
           End), BDpId, BCltDpId, TransDate1 = TransDate,FLAG=4              
 from #Del_TransStat D, Client2 C2, Client1 C1            
 where filler2 = 1 and drcr = 'D' and Delivered <> '0'             
 And ShareType <> 'AUCTION' And ISIN Like 'IN%'            
 And C2.Cl_Code = C1.Cl_Code And C2.Party_Code = D.Party_Code             
 And TransDate >= @FromDate And TransDate <= @ToDate            
 And d.Party_Code >= @FromParty And d.Party_Code <= @ToParty            
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId               
 AND c1.branch_cd like (case when @statusid = 'branch' then @statusname else '%' end)            
 AND c1.sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end)            
 AND c1.trader like (case when @statusid = 'trader' then @statusname else '%' end)            
 AND c1.family like (case when @statusid = 'family' then @statusname else '%' end)            
 AND c2.party_code like (case when @statusid = 'client' then @statusname else '%' end)             
 And HolderName Not Like 'MARGIN%'            
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, ISIN, SlipNo, DpId, CltDpId, TrType, ISett_No, ISett_Type, BDpId, BCltDpId ,FILLER1, reason            

 Union All            
 Select TransDate=Convert(Varchar,TransDate,103), Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, Scrip_Name = D.WareHouse+'( ' + ISIN + ')', ISIN, CQty = 0, DQty = Sum(Qty), SlipNo, DpId=dp.DpId, CltDpId=dp.dpcltno, TrType,             
 Reason = (Case When HolderName Like 'Margin%'             
                 Then 'Trans To Margin'             
                 Else 'Trans To Ben'             
           End),            
 BDpId, BCltDpId, TransDate1 = TransDate,FLAG=1            
 from #Del_TransStat D, Client2 C2, Client1 C1, deliverydp dp            
 where drcr = 'D' And ShareType <> 'AUCTION' And ISIN Like 'IN%'            
 and Delivered = 'G' And Filler2 = 0             
 And C2.Cl_Code = C1.Cl_Code And C2.Party_Code = D.Party_Code             
 And TransDate >= @FromDate And TransDate <= @ToDate            
 And d.Party_Code >= @FromParty And d.Party_Code <= @ToParty            
 And D.Symbol >= @FromScrip And D.Symbol <= @ToScrip            
 And BDpId like @DpId And BCltDpId like @CltDpId         
 and ( holdername like 'ben ' + Dp.DpCltNo Or holdername like 'Margin ' + Dp.DpCltNo )            
 AND c1.branch_cd like (case when @statusid = 'branch' then @statusname else '%' end)            
 AND c1.sub_broker like (case when @statusid = 'subbroker' then @statusname else '%' end)            
 AND c1.trader like (case when @statusid = 'trader' then @statusname else '%' end)            
 AND c1.family like (case when @statusid = 'family' then @statusname else '%' end)            
 AND c2.party_code like (case when @statusid = 'client' then @statusname else '%' end)             
 Group By TransDate,WareHouse, Sett_No, Sett_Type, D.Party_Code, C1.Long_Name,             
 c1.L_ADDRESS1, c1.L_ADDRESS2, c1.L_ADDRESS3, c1.l_city, c1.L_State, c1.L_ZIP, c1.Family,            
 D.Symbol, ISIN, SlipNo, TrType, dp.dpid, dpcltno , ISett_No, ISett_Type, BDpId, BCltDpId, HolderName            

	Select TransDate=Convert(Varchar,Convert(DateTime,@FromDate),103),
	Sett_No='',Sett_Type='',Party_Code='',Long_Name='',L_ADDRESS1='',L_ADDRESS2='',L_ADDRESS3='',
	l_city='',L_State='', L_ZIP='',Family='',Symbol,Scrip_Name,ISIN,
	CQty=(Case When Sum(CQty-DQty) > 0 Then Sum(CQty-DQty) Else 0 End),
	DQty=(Case When Sum(DQty-CQty) > 0 Then Sum(DQty-CQty) Else 0 End),
	SlipNo='0',DpId='',CltDpId='',TrType='0',Reason='OPENING BALANCE',BDpId='',BCltDpId='',
	TransDate1=Convert(DateTime,@FromDate),FLAG=0
	From #Del_TransStat_2
	Where TransDate1 < @FromDate 
	Group By Symbol,Scrip_Name,ISIN
	Union All
	select * from  #Del_TransStat_2
	Where TransDate1 >= @FromDate and TransDate1 <= @ToDate
	Union All
	Select TransDate=Convert(Varchar,Convert(DateTime,@ToDate),103),
	Sett_No='',Sett_Type='',Party_Code='',Long_Name='',L_ADDRESS1='',L_ADDRESS2='',L_ADDRESS3='',
	l_city='',L_State='', L_ZIP='',Family='',Symbol,Scrip_Name,ISIN,
	CQty=(Case When Sum(CQty-DQty) > 0 Then Sum(CQty-DQty) Else 0 End),
	DQty=(Case When Sum(DQty-CQty) > 0 Then Sum(DQty-CQty) Else 0 End),
	SlipNo='0',DpId='',CltDpId='',TrType='0',Reason='CLOSING BALANCE',BDpId='',BCltDpId='',
	TransDate1=Convert(DateTime,@ToDate),FLAG=6
	From #Del_TransStat_2
	Where TransDate1 <= @ToDate
	Group By Symbol,Scrip_Name,ISIN
	Order By Symbol, ISIN, TransDate1, Flag, Sett_No, Sett_Type, Party_Code            
End            
          
Drop Table #Del_TransStat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TURNOVER
-- --------------------------------------------------
CREATE PROCEDURE RPT_TURNOVER
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11)
)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	TIME_SLAB = CASE 
			WHEN TRADE_TIME_FROM=0 
			THEN '00:00:00' 
			ELSE 
				LEFT(CONVERT(VARCHAR,TRADE_TIME_FROM),2) + ':' 
				+ SUBSTRING(CONVERT(VARCHAR,TRADE_TIME_FROM),3,2)+':'
				+ RIGHT(CONVERT(VARCHAR,TRADE_TIME_FROM),2) 
			END
			+ ' - ' 
				+ LEFT(CONVERT(VARCHAR,TRADE_TIME_TO),2) + ':' 
				+ SUBSTRING(CONVERT(VARCHAR,TRADE_TIME_TO),3,2)+':'
				+ RIGHT(CONVERT(VARCHAR,TRADE_TIME_TO),2) ,
	TURNOVER,
	TAXES_PERC,
	TURN_TAX
FROM
(
	SELECT
		TRADE_TIME_FROM , 
		TRADE_TIME_TO, 
		TURNOVER = SUM(TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT) ,
		TAXES_PERC=TAXES_PERC/TAXES_UNIT*100,
	 	TURN_TAX = SUM((TRADEQTY * PRICE * BOOKTYPE / INSTRUMENT) * TAXES_PERC / TAXES_UNIT)
	FROM   
		FOSETTLEMENT (NOLOCK), TAXES_SETTING (NOLOCK)
	WHERE  
		SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'
		AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
		AND CONVERT(BIGINT,REPLACE(CONVERT(VARCHAR,SAUDA_DATE,108),':','')) BETWEEN TRADE_TIME_FROM AND TRADE_TIME_TO
	GROUP BY TRADE_TIME_FROM , TRADE_TIME_TO,TAXES_PERC,TAXES_UNIT
) TTAX
 ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION
-- --------------------------------------------------



CREATE    PROC [dbo].[RPT_UCCFILEGENERATION]  
(  
@FROMDATE VARCHAR(11),  
@TODATE VARCHAR(11),  
@PARTYFROM VARCHAR(10),  
@PARTYTO VARCHAR(10),  
@OPTIONVAL VARCHAR(2)  
)  
  
AS  
  
SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF @PARTYTO='' BEGIN SET @PARTYTO = 'zzzzzz' end  
  
  
Create Table #ClientList  
(Party_Code Varchar(10))  
  
CREATE INDEX [indxcl2] ON #ClientList ([Party_code])  
  
/*-----------------------------------------------------------------------------  
  Fetching Traded Client List to #ClientLis  
-----------------------------------------------------------------------------*/  
if @OPTIONVAL = 'T'  
 Begin  
  Insert Into #ClientList  
  Select  
   Distinct Party_Code  
  From  
   FoSettlement (nolock)  
  Where  
   Sauda_Date Between @FromDate and @TODATE + ' 23:59'  
   And Party_Code Between @PartyFrom and @PartyTo  
  
  Insert Into #ClientList  
  Select  
   Distinct Party_Code  
  From  
   Pradnya.dbo.History_FoSettlement_NCDX (nolock)  
  Where  
   Sauda_Date Between @FromDate and @TODATE + ' 23:59'  
   And Party_Code Between @PartyFrom and @PartyTo  
 End   
Else  
 Begin  
  Insert Into #ClientList  
  Select  
    Party_Code  
  From  
   Client2  
  Where  
   Party_Code Between @PartyFrom and @PartyTo  
 End  
  
/*-----------------------------------------------------------------------------  
   Fetching Data To #UCC_NSE  
-----------------------------------------------------------------------------*/  


  
SELECT   
 DISTINCT   
 Segment = '20',  
 ClientCode = c2.party_code,  
 LongName = left(ISNULL((CASE WHEN ADDEMAILID LIKE '%@%' OR ADDEMAILID IS NULL THEN C1.LONG_NAME ELSE ADDEMAILID END), ''),60),  
 --Category = isnull(c1.cl_type, ''),  
 CATEGORY = (CASE WHEN isnull(C1.cl_status,'') in ('NOR','NRI','ROR','PRO','IND')   
    THEN 'IND'   
    ELSE isnull(C1.cl_status,'')   
    END),
 fulladdress = ISNULL(rtrim(c1.l_address1), '') + ' ' + ISNULL(rtrim(c1.l_address2), '') + ' ' + ISNULL(rtrim(c1.l_address3), '') + ' ' + ISNULL(rtrim(c1.L_city), '') + ' ' + ISNULL(rtrim(c1.L_State), ''),  
 Address1 = ISNULL(rtrim(Left(c1.l_address1,30)), ''),  
 Address2 = ISNULL(rtrim(Left(c1.l_address2,30)), ''),  
 Address3 = ISNULL(rtrim(Left(c1.l_address3,30)), ''),  
 City 	= ISNULL(rtrim(Replace(Replace(Replace(c1.L_city,'.',''),',',''),';','')), ''),  
 state 	= ISNULL(rtrim(c1.L_State), ''),  
 Nation = ISNULL(rtrim(c1.L_Nation), ''),  
 Zip = ISNULL(c1.l_zip, ''),  
 Phone1 = ' ',  
 OFFPHONE = (Case When isnull(C1.Off_phone1,'') <> ''   
		  Then Replace(Replace(Replace(Replace(Replace(Replace(C1.Off_phone1,'/',''),'(',''),')',''),'-',''),':',''),';','')  
		  When isnull(C1.Off_phone2,'') <> ''   
		  Then Replace(Replace(Replace(Replace(Replace(Replace(C1.Off_phone2,'/',''),'(',''),')',''),'-',''),':',''),';','')  
		  Else ''
    		End),
 RESPHONE = (Case When isnull(C1.res_phone1,'') <> ''   
		  Then Replace(Replace(Replace(Replace(Replace(Replace(C1.res_phone1,'/',''),'(',''),')',''),'-',''),':',''),';','')  
		  When isnull(C1.res_phone2,'') <> ''   
		  Then Replace(Replace(Replace(Replace(Replace(Replace(C1.res_phone2,'/',''),'(',''),')',''),'-',''),':',''),';','')  
		  Else ''
		End),
 Aggrementdate =   
  (CASE WHEN c5.client_agre_dt IS NULL THEN '' ELSE CASE WHEN (left(convert(varchar,c5.client_agre_dt,109),11) ='Jan  1 1900') then '' else  CASE WHEN (CONVERT(Int, DATENAME(day, c5.client_agre_dt)) < 10) THEN ('0' + DATENAME(day, c5.client_agre_dt)) ELSE


 (DATENAME(day, c5.client_agre_dt)) END    + '-' + (LEFT(DATENAME(month, c5.client_agre_dt), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.client_agre_dt))) END END),  
 DOB =   
  (CASE WHEN c5.birthdate IS NULL   
   THEN ''   
   ELSE CASE WHEN (left(convert(varchar,c5.birthdate,109),11) ='Jan  1 1900')   
   THEN ''   
   Else CASE WHEN (CONVERT(Int, DATENAME(day, c5.birthdate)) < 10)   
   THEN ('0' + DATENAME(day, c5.birthdate)) ELSE (DATENAME(day, c5.birthdate))   
   END + '-' + (LEFT(DATENAME(month, c5.birthdate), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.birthdate))) END   
   END),  
 PAN = ISNULL(c1.pan_gir_no, ''),  
 WARD = ISNULL(c1.ward_no, ''),  
 Passportno = ISNULL(c5.passportdtl, ''),  
 Passportplace = ISNULL(c5.passportplaceOfissue, ''),  
 passportdate =   
  (CASE WHEN c5.passportdateOfissue IS NULL   
   THEN ''   
   ELSE  CASE WHEN (left(convert(varchar,c5.passportdateOfissue,109),11) ='Jan  1 1900')   
   Then '' else  CASE WHEN (CONVERT(Int, DATENAME(day, c5.passportdateOfissue)) < 10)   
   THEN ('0' + DATENAME(day, c5.passportdateOfissue)) ELSE (DATENAME(day, c5.passportdateOfissue))   
   END + '-' + (LEFT(DATENAME(month, c5.passportdateOfissue), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.passportdateOfissue))) END   
   END),  
 PassportExpdate =   
  (CASE WHEN c5.passportExpdate IS NULL   
   THEN ''   
   ELSE  CASE WHEN (left(convert(varchar,c5.passportExpdate,109),11) ='Jan  1 1900')   
   then '' else  CASE WHEN (CONVERT(Int, DATENAME(day, c5.passportExpdate)) < 10)   
   THEN ('0' + DATENAME(day, c5.passportExpdate)) ELSE (DATENAME(day, c5.passportExpdate))   
   END + '-' + (LEFT(DATENAME(month, c5.passportExpdate), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.passportExpdate))) END   
   END),  
 Drivinglicno = ISNULL(c5.drivelicendtl, ''),  
 Drivinglicplace = ISNULL(c5.licenceNoplaceOfissue, ''),  
 Drivinglicdate =   
  (CASE  WHEN c5.licenceNodateOfissue IS NULL   
   THEN '' ELSE CASE WHEN (left(convert(varchar,c5.licenceNodateOfissue,109),11) ='Jan  1 1900')   
   THEN '' ELSE CASE WHEN (CONVERT(Int, DATENAME(day, c5.licenceNodateOfissue)) < 10)   
   THEN ('0' + DATENAME(day, c5.licenceNodateOfissue)) ELSE (DATENAME(day, c5.licenceNodateOfissue))   
   END + '-' + (LEFT(DATENAME(month, c5.licenceNodateOfissue), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.licenceNodateOfissue))) END   
   END),  
 DrivinglicExpdate =   
  (CASE  WHEN c5.DriveExpDate IS NULL   
   THEN '' ELSE CASE WHEN (left(convert(varchar,c5.DriveExpDate,109),11) ='Jan  1 1900')   
   THEN '' ELSE CASE WHEN (CONVERT(Int, DATENAME(day, c5.DriveExpDate)) < 10)   
   THEN ('0' + DATENAME(day, c5.DriveExpDate)) ELSE (DATENAME(day, c5.DriveExpDate))   
   END + '-' + (LEFT(DATENAME(month, c5.DriveExpDate), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.DriveExpDate))) END   
   END),  
   
 voterid = ISNULL(c5.votersiddtl, ''),  
 voteridplace = ISNULL(c5.voteridplaceOfissue, ''),  
 voteriddate =   
  (CASE WHEN c5.voteriddateOfissue IS NULL   
   THEN '' ELSE CASE WHEN (left(convert(varchar,c5.voteriddateOfissue,109),11) ='Jan  1 1900')   
   then '' else CASE WHEN (CONVERT(Int, DATENAME(day, c5.voteriddateOfissue)) < 10)   
   THEN ('0' + DATENAME(day, c5.voteriddateOfissue)) ELSE (DATENAME(day, c5.voteriddateOfissue))   
   END + '-' + (LEFT(DATENAME(month, c5.voteriddateOfissue), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.voteriddateOfissue))) END   
   END),  
 rationcardid = ISNULL(c5.Rationcarddtl, ''),  
 rationcardidplace = ISNULL(c5.RationCardPlaceOfIssue, ''),  
 rationcardiddate =   
  (CASE WHEN c5.RationCardDateOfIssue IS NULL   
   THEN '' ELSE CASE WHEN (left(convert(varchar,c5.RationCardDateOfIssue,109),11) ='Jan  1 1900')   
   then '' else CASE WHEN (CONVERT(Int, DATENAME(day, c5.RationCardDateOfIssue)) < 10)   
   THEN ('0' + DATENAME(day, c5.RationCardDateOfIssue)) ELSE (DATENAME(day, c5.RationCardDateOfIssue))   
   END + '-' + (LEFT(DATENAME(month, c5.RationCardDateOfIssue), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.RationCardDateOfIssue))) END   
   END),   
 regno = ISNULL(c5.regr_no, ''),  
 regauthority = ISNULL(c5.regr_auth, ''),  
 regpalce = ISNULL(c5.regr_place, ''),  
 regdate =   
  (CASE WHEN c5.regr_date IS NULL   
   THEN '' ELSE CASE WHEN (left(convert(varchar,c5.regr_date,109),11) ='Jan  1 1900')   
   then '' else CASE WHEN (CONVERT(Int, DATENAME(day, c5.regr_date)) < 10)   
   THEN ('0' + DATENAME(day, c5.regr_date)) ELSE (DATENAME(day, c5.regr_date))   
   END + '-' + (LEFT(DATENAME(month, c5.regr_date), 3)) + '-' + (CONVERT(VarChar, YEAR(c5.regr_date))) END   
   END),                                      
 Introducer = ISNULL(c1.trader, ''),  
 introrelation = ISNULL(c5.INTROD_RELATION, ''),  
 introclid = ISNULL(c5.INTROD_CLIENT_ID, ''),  
 otheraccno = ISNULL(c5.ANY_OTHER_ACC, ''),  
 settmode = ISNULL(c5.SETT_MODE, ''),  
 othertmclient = ISNULL(c5.DEALING_WITH_OTHRER_TM, ''),  
 uccclientcode = ISNULL(Uc.party_code, ''),  
 MapinId = Space(15),  
 endofrecdflag = ISNULL('E', ''),  
 DetailRecord = 'I',  
 bankacctype = Space(2),   
 bankaccount = Space(20),   
 benfaccount = Space(16),   
 bankname = Space(50),  
 bankfulladdress = Space(50),   
 Dpbankname = Space(50),  
 NSDL_DepositoryName = Space(4),   
 NSDL_DepositoryParticipantId = Space(8),  
 NSDL_DepositoryParticipantName = Space(25),   
 NSDL_BeneficiaryAccountID = Space(8),  
 CDSL_DepositoryName = Space(4),   
 CDSL_DepositoryParticipantId = Space(8),  
 CDSL_DepositoryParticipantName = Space(25),   
 CDSL_BeneficiaryAccountID = Space(8),  
 Cl_AccountNo = Space(25),   
 DpId = Space(16),   
 depository = Space(8),  
 inactivefrom = c5.inactivefrom, 
 StateCode = IsNull(s.State_Code,''),
 ActiveDelClient = 'A'
  
INTO   #UCC_NSE  
FROM   
 Client1 C1
 Left join State_Master s on s.State = C1.L_State,   
 Client2 C2,   
 Client5 C5,  
 #ClientList Left Outer Join Ucc_Client uc on (uc.Party_Code = #ClientList.Party_Code)  
 
WHERE   
 C1.cl_code = C2.cl_code   
 And C1.cl_code = c5.cl_code   
 And #ClientList.Party_Code = C2.Party_Code  
 And C1.cl_type <> 'REM'  
 And C5.SystumDate Between   
   Case When @optionval = 'A' then @FromDate else 'Jan  1 1900' End  
    And  
   Case When @optionval = 'A' then @ToDate + ' 23:59' else 'Dec 31 2049 23:59' End  
 And C5.ActiveFrom Between  
   Case When @optionval = 'S' then @FromDate else 'Jan  1 1900' End  
    And  
   Case When @optionval = 'S' then @ToDate + ' 23:59' else 'Dec 31 2049 23:59' End  
 And C5.InActiveFrom Between  
   Case When @optionval = 'I' then @FromDate else 'Jan  1 1900' End  
    And  
   Case When @optionval = 'I' then @ToDate + ' 23:59' else 'Dec 31 2049 23:59' End  
  
/*-----------------------------------------------------------------------------  
  Updating #UCC_NSE for Account Details  
-----------------------------------------------------------------------------*/  
Update   
 #UCC_NSE   
 Set bankacctype =   
  (CASE WHEN left(c4.depository,6) = 'SAVING'   
   THEN '10' ELSE CASE WHEN left(c4.depository,7) = 'CURRENT'   
   THEN '11' ELSE '99' END   
   END),  
 bankaccount =   
  (CASE WHEN left(c4.depository,7) IN ('SAVING','CURRENT','NRE','NRO')   
   THEN cltdpid ELSE ' '   
   END),  
 Cl_AccountNo=CLTDPID  
FROM   
 Client4 C4   
WHERE   
 c4.depository NOT in ('CDSL', 'NSDL')  
 And C4.Party_Code = clientcode  
  
/*-----------------------------------------------------------------------------  
  Updating #UCC_NSE for DP Details  
-----------------------------------------------------------------------------*/  
  
Update   
 #UCC_NSE   
 Set benfaccount =  ISNULL(cltdpid,' '),   
 DpId = IsNull(C4.BankId,''),   
 depository = IsNull(C4.depository,'')  
FROM   
 Client4 C4  
WHERE   
 C4.depository in ('CDSL', 'NSDL')   
 And C4.Party_Code = clientcode   
 And defdp = 1  
  
/*-----------------------------------------------------------------------------  
  Updating #UCC_NSE for Bank Name  
-----------------------------------------------------------------------------*/  
  
Update   
 #UCC_NSE   
 Set bankname = ISNULL(Left(bank_name,50), ' '),   
 bankfulladdress = ISNULL(Left(branch_name,50), ' ')  
FROM   
 (SELECT   
  PARTY_CODE,  
  BANK_NAME,   
  BRANCH_NAME   
 FROM   
  client4 C4,   
  pobank P  
 WHERE   
  Convert(VarChar, p.bankid) = C4.BANKID  
  AND depository NOT IN ('CDSL', 'NSDL')) A  
WHERE   
 Party_Code = clientcode  
  
/*-----------------------------------------------------------------------------  
  Updating #UCC_NSE Multiple DP Details  
-----------------------------------------------------------------------------*/  
/*  
Update   
 #UCC_NSE   
 Set NSDL_DepositoryName = Case When M.DpType ='NSDL' Then M.DpType else '' End,   
 NSDL_DepositoryParticipantId = Case When M.DpType ='NSDL' Then Left(M.DPID,8) else '' End ,  
 NSDL_DepositoryParticipantName = Case When M.DpType ='NSDL' Then Left(M.Introducer,25) else '' End ,   
 NSDL_BeneficiaryAccountID = Case When M.DpType ='NSDL' Then Left(M.cltdpno,8) else '' End  
From   
 MultiCltID M  
WHERE   
 M.def=1   
 And M.Party_Code = clientcode   
*/  
/*-----------------------------------------------------------------------------  
  Updating #UCC_NSE Multiple DP Details  
-----------------------------------------------------------------------------*/  
/*  
Update   
 #UCC_NSE   
 Set NSDL_DepositoryName = Case When M.DpType ='CDSL' Then M.DpType else '' End,   
 NSDL_DepositoryParticipantId = Case When M.DpType ='CDSL' Then Left(M.DPID,8) else '' End ,  
 NSDL_DepositoryParticipantName = Case When M.DpType ='CDSL' Then Left(M.Introducer,25) else '' End ,   
 NSDL_BeneficiaryAccountID = Case When M.DpType ='CDSL' Then Left(M.cltdpno,8) else '' End  
From   
 MultiCltID M  
WHERE   
 M.def=1   
 And M.Party_Code = clientcode   
*/  
/*-----------------------------------------------------------------------------  
   Fetching Final OutPut  
-----------------------------------------------------------------------------*/  
  
  
SELECT * FROM #UCC_NSE ORDER BY ClientCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION_NEW
-- --------------------------------------------------








CREATE PROC [dbo].[RPT_UCCFILEGENERATION_NEW]
	(  
	@FROMDATE VARCHAR(11),  
	@TODATE VARCHAR(11),  
	@PARTYFROM VARCHAR(10),  
	@PARTYTO VARCHAR(10),  
	@OPTIONVAL VARCHAR(2),
	@FROMBRANCH VARCHAR(15),  
	@TOBRANCH VARCHAR(15),  
	@CLTYPE VARCHAR(2),
	@UCC_FLAG VARCHAR(1) = '',
	@BULK_MODIFY_FLAG INT = 0
	)  
  
	AS  
  
	--- EXEC RPT_UCCFILEGENERATION_NEW 'JAN  1 2000','DEC 31 2013','0','A99999999','A','','ZZZZZZZZZZ','','',1
	
	SET NOCOUNT ON  
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

	DECLARE @SEGMENT	VARCHAR(4)
	DECLARE	@KRA_TYPE	VARCHAR(5)
	DECLARE @EXCHANGE	VARCHAR(11)
	DECLARE @R_COUNT	INT
	DECLARE @DBNAME		VARCHAR(10)
	
	SET @DBNAME		= DB_NAME()
	SET @KRA_TYPE	= 'CDSL'
	IF @DBNAME		= 'MSAJAG'
	BEGIN
		SET @SEGMENT = 'CM'
		SET	@EXCHANGE = 'NSECAPITAL'
	END
	ELSE IF	@DBNAME	= 'NSEFO'
	BEGIN
		SET @SEGMENT = 'FO'
		SET	@EXCHANGE = 'NSEFUTURES'
	END
	ELSE IF	@DBNAME	= 'NSECURFO'
	BEGIN
		SET @SEGMENT = 'CDS'
		SET	@EXCHANGE = 'NSXFUTURES'
	END
	ELSE IF	@DBNAME	= 'NSESLBS'
	BEGIN
		SET @SEGMENT = 'SLB'
		SET	@EXCHANGE = 'NSESLBS'
	END
	ELSE IF	@DBNAME	= 'NSEDEBT'
	BEGIN
		SET @SEGMENT = 'NDB'
		SET	@EXCHANGE = 'NSEDEBT'
	END
	ELSE IF	@DBNAME	= 'NCE'
	BEGIN
		SET @SEGMENT = 'COM'
		SET	@EXCHANGE = 'NCEFUTURES'
	END


	SELECT @KRA_TYPE = ISNULL(KRA_TYPE,'') FROM MSAJAG..OWNER (NOLOCK)
  
	IF @PARTYTO='' BEGIN SET @PARTYTO = 'ZZZZZZ' END
	IF @TOBRANCH='' BEGIN SET @TOBRANCH ='ZZZZZZ' END
  
	CREATE TABLE #CLIENTLIST  
	(PARTY_CODE VARCHAR(10))  

	CREATE INDEX [INDXCL2] ON #CLIENTLIST ([PARTY_CODE])
	
	/*-----------------------------------------------------------------------------  
	FETCHING TRADED CLIENT LIST TO #CLIENTLIS  
	-----------------------------------------------------------------------------*/  
  
	IF @OPTIONVAL = 'T'  
	BEGIN  

		IF @SEGMENT IN('CM','SLB')
		BEGIN
			INSERT INTO #CLIENTLIST
			SELECT  
				DISTINCT PARTY_CODE  
			FROM  
				CMBILLVALAN (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'
				AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
				AND TRADETYPE NOT IN ( 'SCF','ICF','IR' )
		END

		IF @SEGMENT IN('FO','CDS','NDB','COM')
		BEGIN
			INSERT INTO #CLIENTLIST
			SELECT  
				DISTINCT PARTY_CODE  
			FROM  
				FOBILLVALAN (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'
				AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
				AND TRADETYPE IN ( 'BT' )
		END
	END
	ELSE IF @OPTIONVAL = 'M'
	BEGIN
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE  
		FROM  
			MSAJAG..CLIENT_DETAILS C (NOLOCK), 
			MSAJAG..CLIENT_BROK_DETAILS B (NOLOCK)
		WHERE  
			C.CL_CODE = B.CL_CODE 
			--AND EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL'
			AND EXCHANGE+SEGMENT = @EXCHANGE
			AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
			AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
			AND C.MODIFIDEDON BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
			AND LEFT(SYSTEMDATE,11) <> LEFT(MODIFIDEDON,11)
	END
	ELSE  
	BEGIN  
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE  
		FROM  
			CLIENT2 (NOLOCK)
		WHERE  
			PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
	END

	--DELETE FROM #CLIENTLIST WHERE LEFT(PARTY_CODE,3) = 'MUM'

	/*-----------------------------------------------------------------------------  
	FOR PARENT LEVEL UCC
	-----------------------------------------------------------------------------*/  
	/*	
	UPDATE	#CLIENTLIST
	SET		PARTY_CODE = ISNULL(PARENTCODE,'')
	FROM	CLIENT2 C2 (NOLOCK)
	WHERE	C2.PARTY_CODE = #CLIENTLIST.PARTY_CODE  
	*/
	/*-----------------------------------------------------------------------------  
	FETCHING DATA TO #UCC_NSE  
	-----------------------------------------------------------------------------*/  

	SELECT
		SEGMENT = (
		CASE
			WHEN @SEGMENT = 'CM' THEN 'C'
			WHEN @SEGMENT = 'FO' THEN 'F'
			WHEN @SEGMENT = 'CDS' THEN 'X'
			WHEN @SEGMENT = 'SLB' THEN 'S'
			WHEN @SEGMENT = 'NDB' THEN 'D'
			WHEN @SEGMENT = 'COM' THEN 'CO'
			ELSE ''
		END),		
		CLIENT_CODE = C1.CL_CODE,
		CLIENT_NAME = (
		CASE 
			WHEN ISNULL(ADDEMAILID,'') <> '' AND ADDEMAILID NOT LIKE '%@%' 
			THEN LEFT(REPLACE(REPLACE(REPLACE(ISNULL(ADDEMAILID,''),'.',''),',',''),';',''),150)
			ELSE LEFT(REPLACE(REPLACE(REPLACE(ISNULL(C1.LONG_NAME,''),'.',''),',',''),';',''),150)
		END),
		CATEGORY = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA') THEN '1'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PSF','PAR','PF','LLP') THEN '2'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('HUF') THEN '3'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('BC','BCP','DBC','COR','CC','PPB','COM') THEN '4'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('TS','TRU') THEN '5'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('MF') THEN '6'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('DFI') THEN '7'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('BNK','BK') THEN '8'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('IC') THEN '9'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('SB') THEN '10'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NRI','NRE','NRO','NOR') THEN '11'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FII') THEN '12'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('OCB') THEN '13'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FDI','NTP') THEN '14'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PMS') THEN '15'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NPS') THEN '16'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('QFG') THEN '17'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('QFI') THEN '18'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NGO') THEN '19'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FVC') THEN '20'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP1') THEN '22'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP2') THEN '23'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP3') THEN '24'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP4') THEN '25'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP5') THEN '26'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP6') THEN '27'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP7') THEN '28'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP8') THEN '29'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FP9') THEN '30'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FN')  THEN '31'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NBF') THEN '32'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('AIF','AIF3') THEN '33'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('DVC') THEN '34'
			
			ELSE '99'
		END),	
		PAN = C1.PAN_GIR_NO,
		GENDER = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','FP4','FP5','FP6','FN') THEN ISNULL(C1.SEX,'')
			--WHEN ISNULL(C1.CL_STATUS,'') = 'PRO' THEN 'NA'
			ELSE ''
		END),
		GUARDIANS_NAME = CONVERT(VARCHAR(150),''),
		MARITAL_STATUS = CONVERT(VARCHAR(3),''),
		NATIONALITY = CONVERT(VARCHAR(2),''),
		OTHER_NATIONALITY = CONVERT(VARCHAR(50),''),
		
		EMAIL = LTRIM(RTRIM(MSAJAG.DBO.PIECE(MSAJAG.DBO.PIECE(C1.EMAIL,';',1),',',1))),
		COR_ADDRESS1 = REPLACE(ISNULL(C1.L_ADDRESS1,''),'''',''),
		COR_ADDRESS2 = REPLACE(ISNULL(C1.L_ADDRESS2,''),'''',''),
		COR_ADDRESS3 = REPLACE(ISNULL(C1.L_ADDRESS3,''),'''',''),
		COR_CITY = ISNULL(C1.L_CITY,''),
		COR_STATE = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C1.L_NATION,''),ISNULL(C1.L_STATE,''),'',''),''),
		COR_STATE_OTHER = (
		CASE
			WHEN ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C1.L_NATION,''),ISNULL(C1.L_STATE,''),'',''),'') = '99' THEN 
			CASE
				WHEN (ISNULL(C1.L_STATE,'') = 'OTHER' OR ISNULL(C1.L_STATE,'') = '') THEN CONVERT(VARCHAR(75),'NOT APPLICABLE')
				ELSE ISNULL(C1.L_STATE,'')
			END		
			ELSE CONVERT(VARCHAR(75),'')
		END),

		COR_COUNTRY = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('COUNTRY',ISNULL(C1.L_NATION,''),ISNULL(C1.L_STATE,''),'',''),''),
		COR_L_ZIP = ISNULL(C1.L_ZIP,''),
		ADDRESS_FLAG = (
		CASE
			WHEN ISNULL(LTRIM(RTRIM(C1.L_ADDRESS1)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS1)),'') AND ISNULL(LTRIM(RTRIM(C1.L_ADDRESS2)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS2)),'') AND ISNULL(LTRIM(RTRIM(C1.L_ADDRESS3)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS3)),'') THEN 'Y'
			ELSE 'N'
		END),	
		PER_ADDRESS1 = REPLACE(ISNULL(C1.P_ADDRESS1,''),'''',''),
		PER_ADDRESS2 = REPLACE(ISNULL(C1.P_ADDRESS2,''),'''',''),
		PER_ADDRESS3 = REPLACE(ISNULL(C1.P_ADDRESS3,''),'''',''),
		PER_CITY = ISNULL(C1.P_CITY,''),
		PER_STATE = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C1.P_NATION,''),ISNULL(C1.P_STATE,''),'',''),''),
		PER_STATE_OTHER = (
		CASE
			WHEN ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C1.P_NATION,''),ISNULL(C1.P_STATE,''),'',''),'') = '99' THEN 
			CASE
				WHEN (ISNULL(C1.P_STATE,'') = 'OTHER' OR ISNULL(C1.P_STATE,'') = '') THEN CONVERT(VARCHAR(75),'NOT APPLICABLE')
				ELSE ISNULL(C1.P_STATE,'')
			END		
			ELSE CONVERT(VARCHAR(75),'')
		END),
		PER_COUNTRY = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('COUNTRY',ISNULL(C1.P_NATION,''),ISNULL(C1.P_STATE,''),'',''),''),
		PER_L_ZIP = ISNULL(C1.P_ZIP,''),
		ISD_CODE_RES = (
		CASE
			WHEN UPPER(ISNULL(C1.L_NATION,'')) <> 'INDIA' THEN 
			CASE
				WHEN ISNULL(C1.RES_PHONE1_STD,'') <> '' THEN ISNULL(C1.RES_PHONE1_STD,'')
				WHEN ISNULL(C1.RES_PHONE2_STD,'') <> '' THEN ISNULL(C1.RES_PHONE2_STD,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),
		STD_CODE_RES = (
		CASE
			WHEN UPPER(ISNULL(C1.L_NATION,'')) = 'INDIA' THEN 
			CASE
				WHEN ISNULL(C1.RES_PHONE1_STD,'') <> '' THEN ISNULL(C1.RES_PHONE1_STD,'')
				WHEN ISNULL(C1.RES_PHONE2_STD,'') <> '' THEN ISNULL(C1.RES_PHONE2_STD,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),

		PHONENO_RES = LEFT(
		CASE 
			WHEN ISNULL(C1.RES_PHONE1,'') <> '' THEN REPLACE(REPLACE(C1.RES_PHONE1,':',''),';','')
			WHEN ISNULL(C1.RES_PHONE2,'') <> ''	THEN REPLACE(REPLACE(C1.RES_PHONE2,':',''),';','')
			ELSE ''
		END,60),			
		MOBILENO = ISNULL(C1.MOBILE_PAGER,''),
		ISD_CODE_OFF = (
		CASE
			WHEN UPPER(ISNULL(C1.L_NATION,'')) <> 'INDIA' THEN 
			CASE
				WHEN ISNULL(C1.OFF_PHONE1_STD,'') <> '' THEN ISNULL(C1.OFF_PHONE1_STD,'')
				WHEN ISNULL(C1.OFF_PHONE2_STD,'') <> '' THEN ISNULL(C1.OFF_PHONE2_STD,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),
		STD_CODE_OFF = (
		CASE
			WHEN UPPER(ISNULL(C1.L_NATION,'')) = 'INDIA' THEN 
			CASE
				WHEN ISNULL(C1.OFF_PHONE1_STD,'') <> '' THEN ISNULL(C1.OFF_PHONE1_STD,'')
				WHEN ISNULL(C1.OFF_PHONE2_STD,'') <> '' THEN ISNULL(C1.OFF_PHONE2_STD,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),
		PHONENO_OFF = LEFT(
		CASE
			WHEN ISNULL(C1.OFF_PHONE1,'') <> '' THEN REPLACE(REPLACE(C1.OFF_PHONE1,':',''),';','')
			WHEN ISNULL(C1.OFF_PHONE2,'') <> ''	THEN REPLACE(REPLACE(C1.OFF_PHONE2,':',''),';','')
			ELSE ''
		END,60),
		DOB = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('MF','DFI','BNK','BK','IC','FII','NPS','FP1','FP2','FP3','FN') THEN ''
			ELSE (
			CASE
				WHEN C1.DOB IS NULL THEN ''   
				WHEN LEFT(C1.DOB,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR(11),C1.DOB,106),' ','-')
			END)	
		END),
		UID = CONVERT(VARCHAR(12),''),
		
		BANK_NAME_1 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_1 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_1 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_1 = CONVERT(VARCHAR(2),''),

		BANK_NAME_2 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_2 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_2 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_2 = CONVERT(VARCHAR(2),''),

		BANK_NAME_3 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_3 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_3 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_3 = CONVERT(VARCHAR(2),''),
		
		DP_NAME_1 = CONVERT(VARCHAR(4),''),
		DP_ID_1	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_1 = CONVERT(VARCHAR(16),''),

		DP_NAME_2 = CONVERT(VARCHAR(4),''),
		DP_ID_2	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_2 = CONVERT(VARCHAR(16),''),

		DP_NAME_3 = CONVERT(VARCHAR(4),''),
		DP_ID_3	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_3 = CONVERT(VARCHAR(16),''),
		
		CIN_NO = CONVERT(VARCHAR(21),''),
		GROSS_ANNUAL_INCOME = CONVERT(VARCHAR(1),''),
		GROSS_ANNUAL_INCOME_DATE = CONVERT(VARCHAR(11),''),
		NET_WORTH = CONVERT(VARCHAR(20),''),
		NET_WORTH_DATE = CONVERT(VARCHAR(11),''),
		
		POLITICALLY_EXPOSED_PERSON = CONVERT(VARCHAR(1),''),
		PLACE_INCORPORATION = CONVERT(VARCHAR(75),''),
		OCCUPATION = CONVERT(VARCHAR(2),''),
		OCCUPATION_OTHER = CONVERT(VARCHAR(75),''),
		DATE_COMMENCEMENT = CONVERT(VARCHAR(11),''),
		CP_CODE = ISNULL(PARTICIPANT_CODE,''),
		REGISTRATION_NO = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','FN','NBF') THEN ''
			ELSE ISNULL(C1.REGR_NO,'')
		END),
		REGISTRATION_AUTHORITY = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','FN','NBF') THEN ''
			ELSE ISNULL(C1.REGR_AUTHORITY,'')
		END),
		REGISTRATION_PALCE = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','FN','NBF') THEN ''
			ELSE ISNULL(C1.REGR_AT, '')
		END),
		REGISTRATION_DATE = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','FN','NBF') THEN ''
			ELSE	  
			CASE 
				WHEN C1.REGR_ON IS NULL THEN ''   
				WHEN (LEFT(CONVERT(VARCHAR,C1.REGR_ON,109),11) = 'JAN  1 1900') THEN '' 
				ELSE REPLACE(CONVERT(VARCHAR(11),C1.REGR_ON,106),' ','-')
			END
		END),
		INPERSON_VERIFICATION = CONVERT(VARCHAR(1),''),
		CLIENT_AGREEMENT_DATE = (
		CASE
			WHEN @SEGMENT = 'SLB' THEN
			CASE
				WHEN CLIENT_AGREEMENT_ON IS NULL OR (LEFT(CONVERT(VARCHAR,CLIENT_AGREEMENT_ON,109),11) = 'JAN  1 1900') THEN REPLACE(CONVERT(VARCHAR(11),CB.SYSTEMDATE,106),' ','-')
				/*WHEN CLIENT_AGREEMENT_ON IS NULL THEN ''   
				WHEN (LEFT(CONVERT(VARCHAR,CLIENT_AGREEMENT_ON,109),11) = 'JAN  1 1900') THEN ''*/ 
				ELSE REPLACE(CONVERT(VARCHAR(11),CLIENT_AGREEMENT_ON,106),' ','-')
			END
			ELSE ''
		END),
		UCC_CODE = CONVERT(VARCHAR(10),''),
		UPDATIONFLAG	= CONVERT(VARCHAR(1),''),
		RELATIONSHIP	= CONVERT(VARCHAR(1),''),
		TYPEOFFACILITY	= CONVERT(VARCHAR(1),''),

		PAN_EXEMPT_PROOF_TYPE = CONVERT(VARCHAR(1),''),
		PAN_EXEMPT_PROOF_NO	= CONVERT(VARCHAR(25),''),
		PAN_EXEMPT_PROOF_ISSUE_PLACE = CONVERT(VARCHAR(100),''),
		PAN_EXEMPT_PROOF_ISSUE_DATE = CONVERT(VARCHAR(11),''),

		CLIENT_STATUS = (
		CASE
			WHEN CB.INACTIVE_FROM >= GETDATE() THEN 'A'
			ELSE 'I'
		END),
		CLIENT_STATUS_REMARKS = CONVERT(VARCHAR(200),''),
		CLIENT_TYPE_CORPORATE = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('BC','BCP','DBC','COR','CC','PPB','COM') THEN 'Y'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','PSF','PAR','PF','HUF','TS','TRU','NRI','NRE','NRO','NOR','QFI','LLP','FN') THEN ''
			ELSE 'N'
		END),

		CONTACT_PERSON_NAME_1 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_1 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_1 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_1 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_1 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_1 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_1 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_1 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_2 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_2 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_2 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_2 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_2 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_2 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_2 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_2 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_3 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_3 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_3 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_3 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_3 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_3 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_3 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_3 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_4 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_4 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_4 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_4 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_4 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_4 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_4 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_4 = CONVERT(VARCHAR(60),''),
			
		CONTACT_PERSON_NAME_5 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_5 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_5 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_5 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_5 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_5 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_5 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_5 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_6 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_6 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_6 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_6 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_6 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_6 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_6 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_6 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_7 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_7 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_7 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_7 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_7 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_7 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_7 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_7 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_8 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_8 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_8 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_8 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_8 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_8 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_8 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_8 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_9 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_9 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_9 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_9 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_9 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_9 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_9 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_9 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_10 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_10 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_10 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_10 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_10 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_10 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_10 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_10 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_11 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_11 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_11 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_11 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_11 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_11 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_11 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_11 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_12 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_12 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_12 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_12 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_12 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_12 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_12 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_12 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_13 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_13 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_13 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_13 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_13 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_13 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_13 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_13 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_14 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_14 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_14 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_14 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_14 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_14 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_14 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_14 = CONVERT(VARCHAR(60),''),
			
		CONTACT_PERSON_NAME_15 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_15 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_15 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_15 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_15 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_15 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_15 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_15 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_16 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_16 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_16 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_16 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_16 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_16 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_16 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_16 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_17 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_17 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_17 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_17 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_17 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_17 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_17 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_17 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_18 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_18 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_18 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_18 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_18 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_18 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_18 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_18 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_19 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_19 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_19 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_19 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_19 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_19 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_19 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_19 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_20 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_20 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_20 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_20 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_20 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_20 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_20 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_20 = CONVERT(VARCHAR(60),''),	
		POA_FUND_FLAG = CONVERT(VARCHAR(1),'N'),
		POA_SEC_FLAG = CONVERT(VARCHAR(1),'N'),
		
		CUSTODIAN_NAME = CONVERT(VARCHAR(150),''),
		CUSTODIAN_PAN = CONVERT(VARCHAR(10),''),
		CUSTODIAN_EMAIL = CONVERT(VARCHAR(60),''),
		CUSTODIAN_ADDRESS = CONVERT(VARCHAR(255),''),
		CUSTODIAN_CITY = CONVERT(VARCHAR(50),''),
		CUSTODIAN_STATE = CONVERT(VARCHAR(2),''),
		CUSTODIAN_STATE_OTHERS = CONVERT(VARCHAR(75),''),
		CUSTODIAN_COUNTRY = CONVERT(VARCHAR(3),''),
		CUSTODIAN_PINCODE = CONVERT(VARCHAR(10),''),
		CUSTODIAN_MOBILENO = CONVERT(VARCHAR(17),''),
		CUSTODIAN_OFFICE_ISD_CODE = CONVERT(VARCHAR(14),''),
		CUSTODIAN_OFFICE_STD_CODE = CONVERT(VARCHAR(10),''),
		CUSTODIAN_OFFICE_TEL_NO = CONVERT(VARCHAR(60),''),
	
		END_FLAG = 'E',
		ORD_FLAG = 1,
		ERROR_FLAG = 'N',
		ERROR_MSG = CONVERT(VARCHAR(1500),'')
	INTO
		#UCC_NSE
	FROM
		MSAJAG..CLIENT_DETAILS C1 (NOLOCK),
		MSAJAG..CLIENT_BROK_DETAILS CB (NOLOCK)
	WHERE
		C1.CL_CODE = CB.CL_CODE
		AND EXCHANGE+SEGMENT = @EXCHANGE
		AND C1.CL_TYPE <> 'REM'
		AND EXISTS (
					SELECT 
						DISTINCT PARTY_CODE 
					FROM 
						#CLIENTLIST C
					WHERE 
						C.PARTY_CODE = C1.CL_CODE )
		AND 1 = (
		CASE   
			WHEN @CLTYPE='' THEN 1   
			WHEN @CLTYPE='I' THEN (CASE WHEN C1.CL_TYPE = 'INS' THEN 1 ELSE 0 END)
			WHEN @CLTYPE='C' THEN (CASE WHEN C1.CL_TYPE <> 'INS' THEN 1 ELSE 0 END)
			ELSE 0
		END)
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH 
		AND CB.SYSTEMDATE BETWEEN   
			CASE WHEN @OPTIONVAL = 'A' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'A' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  
		AND CB.ACTIVE_DATE BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END
		AND CB.INACTIVE_FROM NOT BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE '' END  
		AND CB.INACTIVE_FROM BETWEEN  
			CASE WHEN @OPTIONVAL = 'I' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'I' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  
				   
	/*----------------------------
	  UPDATE FOR CLIENT DETAILS
	-----------------------------*/
	
	UPDATE 
		#UCC_NSE 
	SET	
		PER_ADDRESS1 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS1
		END),	
		PER_ADDRESS2 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS2
		END),
		PER_ADDRESS3 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS3
		END),
		PER_CITY = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_CITY
		END),
		PER_STATE = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_STATE
		END),
		PER_STATE_OTHER = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_STATE_OTHER
		END),
		PER_COUNTRY = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_COUNTRY
		END),
		PER_L_ZIP = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_L_ZIP
		END),
		CLIENT_TYPE_CORPORATE = (
		CASE
			WHEN CATEGORY IN ('1','11','18','2','3','5','31') THEN ''
			WHEN CATEGORY IN ('4') THEN 'Y'
			ELSE 'N'
		END)
		
	/*----------------------------
	  UPDATE BANK DETAILS
	-----------------------------*/

	IF @SEGMENT		= 'CM'
	BEGIN
		UPDATE
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM
			ACCOUNT..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND D.DEFAULTBANK = 1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNT..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNT..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	END
	ELSE IF	@SEGMENT = 'FO'
	BEGIN
		UPDATE
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM
			ACCOUNTFO..MULTIBANKID D (NOLOCK) INNER JOIN NSEFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND D.DEFAULTBANK = 1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')	

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTFO..MULTIBANKID D (NOLOCK) INNER JOIN NSEFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTFO..MULTIBANKID D (NOLOCK) INNER JOIN NSEFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	END
	ELSE IF	@SEGMENT = 'CDS'
	BEGIN
		UPDATE
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM
			ACCOUNTCURFO..MULTIBANKID D (NOLOCK) INNER JOIN NSECURFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND D.DEFAULTBANK = 1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTCURFO..MULTIBANKID D (NOLOCK) INNER JOIN NSECURFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTCURFO..MULTIBANKID D (NOLOCK) INNER JOIN NSECURFO..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

	END
	ELSE IF	@SEGMENT = 'SLB'
	BEGIN
		UPDATE
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM
			ACCOUNTSLBS..MULTIBANKID D (NOLOCK) INNER JOIN NSESLBS..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND D.DEFAULTBANK = 1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTSLBS..MULTIBANKID D (NOLOCK) INNER JOIN NSESLBS..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTSLBS..MULTIBANKID D (NOLOCK) INNER JOIN NSESLBS..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	END	  
	ELSE IF	@SEGMENT = 'COM'
	BEGIN
		UPDATE
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM
			ACCOUNTNCE..MULTIBANKID D (NOLOCK) INNER JOIN NCE..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND D.DEFAULTBANK = 1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')	

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTNCE..MULTIBANKID D (NOLOCK) INNER JOIN NCE..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS,'')+ (CASE WHEN ISNULL(P.CITY,'') <> '' THEN ' '+ ISNULL(P.CITY,'') ELSE '' END),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTNCE..MULTIBANKID D (NOLOCK) INNER JOIN NCE..POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	END

	/*
	UPDATE 
		#UCC_NSE 
	SET	
		BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
		BANK_BRANCH_ADD_2 = ISNULL(P.BRANCH_NAME,''),
		BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
		BANK_ACCOUNT_TYPE_2 = (
		CASE 
			WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
			WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
			ELSE '99'
		END)
	FROM 
		ACCOUNT..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.CLTCODE
		AND D.ACCNO <> #UCC_NSE.BANK_ACCOUNT_NO_1
		AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16')

	UPDATE 
		#UCC_NSE 
	SET	
		BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
		BANK_BRANCH_ADD_3 = ISNULL(P.BRANCH_NAME,''),
		BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
		BANK_ACCOUNT_TYPE_3 = (
		CASE 
			WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
			WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
			ELSE '99'
		END)
	FROM 
		ACCOUNT..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.CLTCODE
		AND D.ACCNO <> #UCC_NSE.BANK_ACCOUNT_NO_1
		AND D.ACCNO <> #UCC_NSE.BANK_ACCOUNT_NO_2
		AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16')
	*/	
		
	/*----------------------------
	  UPDATE DP BANK DETAILS
	-----------------------------*/

	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_1 = ISNULL(D.DEPOSITORY,''),
		DP_ID_1 = (
		CASE
			WHEN ISNULL(D.DEPOSITORY,'') = 'CDSL' THEN ''
			ELSE D.BANKID
		END),
		BEN_ACCOUNT_NO_1 = D.CLTDPID
	FROM 
		CLIENT4 D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.BANKID = P.BANKID
	WHERE 
		RTRIM(LTRIM(#UCC_NSE.CLIENT_CODE)) = RTRIM(LTRIM(D.PARTY_CODE))
		AND D.DEPOSITORY IN ('NSDL','CDSL') 
		AND D.DEFDP = 1
		AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	
	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_2 = D.DPTYPE,
		DP_ID_2 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'CDSL' THEN ''
			ELSE D.DPID
		END),
		BEN_ACCOUNT_NO_2 = D.CLTDPNO
	FROM 
		MULTICLTID D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.Dpid = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.PARTY_CODE
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_1
		AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')

	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_3 = D.DPTYPE,
		DP_ID_3 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'CDSL' THEN ''
			ELSE D.DPID
		END),
		BEN_ACCOUNT_NO_3 = D.CLTDPNO
	FROM 
		MULTICLTID D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.Dpid = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.PARTY_CODE
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_1
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_2
		AND #UCC_NSE.CATEGORY NOT IN ('6','7','8','9','12','16','21','22','23','24')
	
	UPDATE
		#UCC_NSE
	SET
		POA_SEC_FLAG = 'Y'
	FROM
		MULTICLTID D (NOLOCK) 
	WHERE
		D.PARTY_CODE = #UCC_NSE.CLIENT_CODE
		AND DEF = 1

	/*-----------------------------------------------------------------------------
	  UPDATE #UCC_NSE FOR CIN DETAILS
	------------------------------------------------------------------------------*/

	UPDATE
		#UCC_NSE
	SET
		CIN_NO = ISNULL(CM.CIN,'')
	FROM
		MSAJAG..CLIENT_MASTER_NOMINEE_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE
		AND #UCC_NSE.CATEGORY = '4'


	UPDATE
		#UCC_NSE
	SET
		UID = LEFT(ISNULL(AADHAR_UID,''),12),
		GUARDIANS_NAME = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') THEN ISNULL(CM.FATHERNAME,'')
			ELSE ''
		END),
		MARITAL_STATUS = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') THEN 
			CASE
				WHEN ISNULL(CM.MARITALSTATUS,'') IN ('02','S') THEN 'S'
				WHEN ISNULL(CM.MARITALSTATUS,'') IN ('01','M') THEN 'M'
				ELSE ISNULL(CM.MARITALSTATUS,'')
			END	
			ELSE ''
		END),
		NATIONALITY = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') AND ISNULL(CM.NATIONALITY,'')<>'99' THEN '1'
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') AND ISNULL(CM.NATIONALITY,'')='99' THEN '2'
			ELSE ''
		END),
		OTHER_NATIONALITY = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') 
			THEN 
			CASE 
				WHEN REPLACE(ISNULL(CM.NATIONALITY,''),'0','') = '2' THEN ISNULL(CM.NATIONALITY_OTHER,'')
				WHEN ISNULL(CM.NATIONALITY,'')='99' THEN CM.NATIONALITY_OTHER
				ELSE '' 
			END
			ELSE ''
		END),		
		GROSS_ANNUAL_INCOME = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','21','22','23','24') THEN ''
			ELSE REPLACE(ISNULL(CM.GROSS_INCOME,''),'0','')
		END),	
		GROSS_ANNUAL_INCOME_DATE = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','21','22','23','24') THEN ''
			ELSE
			CASE
				WHEN ISNULL(CM.GROSS_INCOME,'') = '' THEN ''
				WHEN CM.GROSS_DATE IS NULL THEN ''
				WHEN LEFT(CM.GROSS_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR(11),CM.GROSS_DATE,106),' ','-')
			END
		END),
		NET_WORTH = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','21','22','23','24') THEN '' 
			ELSE 
			CASE 
				WHEN ISNULL(CM.NET_WORTH,0) = 0 THEN ''
				ELSE CONVERT(VARCHAR,ISNULL(CM.NET_WORTH,0))
			END
		END),
		NET_WORTH_DATE = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','21','22','23','24') THEN '' 
			ELSE
			CASE
				WHEN ISNULL(CM.NET_WORTH,0) = 0 THEN ''
				WHEN CM.NET_WORTH_DATE IS NULL THEN ''
				WHEN LEFT(CM.NET_WORTH_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR(11),CM.NET_WORTH_DATE,106),' ','-')
			END
		END),	
		POLITICALLY_EXPOSED_PERSON = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','21','22','23','24') THEN '' 
			ELSE
			CASE
				WHEN ISNULL(PEP,'') = 'NA' THEN '0'
				WHEN ISNULL(PEP,'') = 'PEP' THEN '1'
				WHEN ISNULL(PEP,'') = 'RPEP' THEN '2'
				ELSE RIGHT(ISNULL(PEP,''),1)
			END
		END),
		PLACE_INCORPORATION = (
		CASE
			WHEN #UCC_NSE.CATEGORY NOT IN ('1','11','18','25','26','27','31') THEN ISNULL(PLACEOFINCORPRATION,'')
			ELSE ''
		END),
		OCCUPATION = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') THEN 
			CASE
				WHEN @KRA_TYPE = 'NSDL' THEN REPLACE(ISNULL(CM.OCCUPATION,''),'0','')
				ELSE 
				CASE
					WHEN ISNULL(CM.OCCUPATION,'') = '01' THEN '2'
					--WHEN OCCUPATION = '02' AND ISNULL(DESCRIPTION,'') LIKE '%Public%' THEN '01'
					--WHEN OCCUPATION = '02' AND ISNULL(DESCRIPTION,'') LIKE '%Government%' THEN '03'
					WHEN ISNULL(CM.OCCUPATION,'') = '02' THEN '1' 
					WHEN ISNULL(CM.OCCUPATION,'') = '03' THEN '4'
					WHEN ISNULL(CM.OCCUPATION,'') = '04' THEN '5'
					WHEN ISNULL(CM.OCCUPATION,'') = '05' THEN '6'
					WHEN ISNULL(CM.OCCUPATION,'') = '06' THEN '7'
					WHEN ISNULL(CM.OCCUPATION,'') = '07' THEN '8'
					WHEN ISNULL(CM.OCCUPATION,'') = '08' THEN '9'
					ELSE ISNULL(CM.OCCUPATION,'')
				END
			END						
			ELSE ''
		END),
		OCCUPATION_OTHER = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('1','11','18','25','26','27','31') THEN
			(CASE 
				WHEN REPLACE(ISNULL(CM.OCCUPATION,''),'0','') = '99' THEN ISNULL(CM.OCCUPATION_OTHER,'')
				ELSE ''
			END)	
			ELSE ''
		END),
		DATE_COMMENCEMENT = (
		CASE
			WHEN #UCC_NSE.CATEGORY NOT IN ('1','11','12','17','18','21','22','23','24','25','26','27','28','29','30','31') THEN 
			CASE
				WHEN CM.DATEOFCOMMENCMENT IS NULL THEN ''
				WHEN LEFT(CM.DATEOFCOMMENCMENT,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR(11),CM.DATEOFCOMMENCMENT,106),' ','-')
			END
		ELSE ''	
		END), /*,
		UPDATIONFLAG	= ISNULL(CM.UPDATIONFLAG,''),
		RELATIONSHIP	= '', --ISNULL(CM.RELATIONSHIP,''),
		TYPEOFFACILITY	= ISNULL(CM.TYPEOFFACILITY,'')	
		*/
		PAN_EXEMPT_PROOF_TYPE = (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(PANEXEMPTPROOF,'') ELSE '' END),
		PAN_EXEMPT_PROOF_NO	= (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(PROOF_NUMBER,'') ELSE '' END),
		PAN_EXEMPT_PROOF_ISSUE_PLACE = (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(ISSUE_PLACE,'') ELSE '' END),
		PAN_EXEMPT_PROOF_ISSUE_DATE = (
		CASE
			WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN
			CASE			
				WHEN CM.ISSUE_DATE IS NULL THEN ''
				WHEN LEFT(CM.ISSUE_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR(11),CM.ISSUE_DATE,106),' ','-')
			END		
			ELSE ''
		END),
		INPERSON_VERIFICATION = ISNULL(IN_PERSON,'')
	FROM
		#UCC_NSE,
		MSAJAG..CLIENT_MASTER_UCC_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE
		
		
	UPDATE
		#UCC_NSE
	SET
		OTHER_NATIONALITY = LEFT(ISNULL(DESCRIPTION,''),50)
	FROM
		MSAJAG..CLIENT_STATIC_CODES C (NOLOCK)
	WHERE
		C.CODE = #UCC_NSE.OTHER_NATIONALITY
		AND KRA_TYPE = @KRA_TYPE
		

	/*-----------------------------------------------------------------------------
	FOR ONLY SLBS SEGMENT 
	------------------------------------------------------------------------------*/  

	UPDATE
		#UCC_NSE
	SET
		UCC_CODE = ISNULL(UC.UCC_CODE,'')
	FROM 
		UCC_CLIENT UC (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = UC.PARTY_CODE
		AND @SEGMENT = 'SLB'

	/*-----------------------------------------------------------------------------
	  UPDATING FOR EMAIL / SMS SERVICES DETAILS
	------------------------------------------------------------------------------*/  

	UPDATE
		#UCC_NSE
		SET   
			UPDATIONFLAG	= (CASE WHEN #UCC_NSE.CATEGORY IN ('6','7','8','9','12','16','22','23','24') THEN ISNULL(CM.UPDATIONFLAG,'') ELSE '' END),
			RELATIONSHIP	= '', --ISNULL(CM.RELATIONSHIP,''),
			TYPEOFFACILITY	= ISNULL(CM.TYPEOFFACILITY,'')
	FROM
		MSAJAG..CLIENT_MASTER_UCC_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE
		AND @SEGMENT <> 'SLB'

	/*-----------------------------------------------------------------------------
	  UPDATING FOR CLIENT CONTACT DETAILS
	------------------------------------------------------------------------------*/  

	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_1 = LEFT(ISNULL(CD.CONTACT_NAME,''),100),
		CONTACT_PERSON_DESIGNATION_1 = LEFT(ISNULL(CD.DESIGNATION,''),25),
		CONTACT_PERSON_PAN_1 = LEFT(ISNULL(CD.PANNO,''),10),
		CONTACT_PERSON_ADDRESS_1 = LEFT((ISNULL(rtrim(CD.ADDRESS1),'') + ' '
						+ ISNULL(rtrim(CD.ADDRESS2),'') + ' '   
						+ ISNULL(rtrim(CD.ADDRESS3),'') + ' '   
						+ ISNULL(rtrim(CD.CITY),'') + ' '   
						+ ISNULL(rtrim(CD.ZIP),'') + ' '
						+ ISNULL(rtrim(CD.STATE),'') + ' '
						+ ISNULL(rtrim(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_1 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN LEFT(ISNULL(CD.PHONE_NO,''),60)
			ELSE LEFT(ISNULL(CD.MOBILENO,''),60)
		END),
		CONTACT_PERSON_DIN_1 = LEFT(ISNULL(CD.DIN,''),8),
		CONTACT_PERSON_UID_1 = LEFT(ISNULL(CD.UID,''),12),
		CONTACT_PERSON_EMAIL_1 = LEFT(ISNULL(CD.EMAIL,''),60)
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 1
		AND #UCC_NSE.CATEGORY IN ('2','3','4','5','33')
		

	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_2 = LEFT(ISNULL(CD.CONTACT_NAME,''),100),
		CONTACT_PERSON_DESIGNATION_2 = LEFT(ISNULL(CD.DESIGNATION,''),25),
		CONTACT_PERSON_PAN_2 = LEFT(ISNULL(CD.PANNO,''),10),
		CONTACT_PERSON_ADDRESS_2 = LEFT((ISNULL(rtrim(CD.ADDRESS1),'') + ' '
						+ ISNULL(rtrim(CD.ADDRESS2),'') + ' '   
						+ ISNULL(rtrim(CD.ADDRESS3),'') + ' '   
						+ ISNULL(rtrim(CD.CITY),'') + ' '   
						+ ISNULL(rtrim(CD.ZIP),'') + ' '
						+ ISNULL(rtrim(CD.STATE),'') + ' '
						+ ISNULL(rtrim(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_2 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN LEFT(ISNULL(CD.PHONE_NO,''),60)
			ELSE LEFT(ISNULL(CD.MOBILENO,''),60)
		END),
		CONTACT_PERSON_DIN_2 = LEFT(ISNULL(CD.DIN,''),8),
		CONTACT_PERSON_UID_2 = LEFT(ISNULL(CD.UID,''),12),
		CONTACT_PERSON_EMAIL_2 = LEFT(ISNULL(CD.EMAIL,''),60)
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 2
		AND #UCC_NSE.CATEGORY IN ('2','3','4','5','33')
		

	/*
	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_3 = LEFT(ISNULL(CD.CONTACT_NAME,''),100),
		CONTACT_PERSON_DESIGNATION_3 = LEFT(ISNULL(CD.DESIGNATION,''),25),
		CONTACT_PERSON_PAN_3 = LEFT(ISNULL(CD.PANNO,''),10),
		CONTACT_PERSON_ADDRESS_3 = LEFT((ISNULL(rtrim(CD.ADDRESS1),'') + ' '
						+ ISNULL(rtrim(CD.ADDRESS2),'') + ' '   
						+ ISNULL(rtrim(CD.ADDRESS3),'') + ' '   
						+ ISNULL(rtrim(CD.CITY),'') + ' '   
						+ ISNULL(rtrim(CD.ZIP),'') + ' '
						+ ISNULL(rtrim(CD.STATE),'') + ' '
						+ ISNULL(rtrim(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_3 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN LEFT(ISNULL(CD.PHONE_NO,''),60)
			ELSE LEFT(ISNULL(CD.MOBILENO,''),60)
		END),
		CONTACT_PERSON_DIN_3 = LEFT(ISNULL(CD.DIN,''),8),
		CONTACT_PERSON_UID_3 = LEFT(ISNULL(CD.UID,''),12),
		CONTACT_PERSON_EMAIL_3 = LEFT(ISNULL(CD.EMAIL,''),60)
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 3
		AND #UCC_NSE.CATEGORY IN ('2','3','4','5','33')
	*/	


	UPDATE #UCC_NSE
	SET	CUSTODIAN_NAME = LEFT(LTRIM(RTRIM(ISNULL(C.LONG_NAME,''))),150),
		CUSTODIAN_PAN = LEFT(LTRIM(RTRIM(ISNULL(C.PANNO,''))),10),
		CUSTODIAN_EMAIL = LEFT(LTRIM(RTRIM(MSAJAG.DBO.PIECE(MSAJAG.DBO.PIECE(C.EMAIL,';',1),',',1))),60),
		CUSTODIAN_ADDRESS = LEFT(ISNULL(C.ADDRESS1,'') +' '+ ISNULL(C.ADDRESS2,''),255),
		CUSTODIAN_CITY = LEFT(ISNULL(C.CITY,''),50),
		CUSTODIAN_STATE = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C.NATION,''),ISNULL(C.STATE,''),'',''),''),
		CUSTODIAN_STATE_OTHERS = (
		CASE
			WHEN ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('STATE',ISNULL(C.NATION,''),ISNULL(C.STATE,''),'',''),'') = '99' THEN 
			CASE
				WHEN (ISNULL(C.STATE,'') = 'OTHER' OR ISNULL(C.STATE,'') = '') THEN CONVERT(VARCHAR(75),'NOT APPLICABLE')
				ELSE ISNULL(C.STATE,'')
			END		
			ELSE CONVERT(VARCHAR(75),'')
		END),
		CUSTODIAN_COUNTRY = ISNULL(MSAJAG.DBO.GETCOUNTRY_STATE_CITY_CODE('COUNTRY',ISNULL(C.NATION,''),ISNULL(C.STATE,''),'',''),''),
		CUSTODIAN_PINCODE = LEFT(ISNULL(C.ZIP,''),10),
		CUSTODIAN_MOBILENO = LEFT(LTRIM(RTRIM(ISNULL(C.MOBILENO,''))),17),
		CUSTODIAN_OFFICE_ISD_CODE = (
		CASE
			WHEN UPPER(ISNULL(C.NATION,'')) <> 'INDIA' THEN 
			CASE
				WHEN ISNULL(C.STD_ISD1,'') <> '' THEN ISNULL(C.STD_ISD1,'')
				WHEN ISNULL(C.STD_ISD2,'') <> '' THEN ISNULL(C.STD_ISD2,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),
		CUSTODIAN_OFFICE_STD_CODE = (
		CASE
			WHEN UPPER(ISNULL(C.NATION,'')) = 'INDIA' THEN 
			CASE
				WHEN ISNULL(C.STD_ISD1,'') <> '' THEN ISNULL(C.STD_ISD1,'')
				WHEN ISNULL(C.STD_ISD2,'') <> '' THEN ISNULL(C.STD_ISD2,'')
				ELSE ''
			END
			ELSE CONVERT(VARCHAR(14),'')
		END),
		CUSTODIAN_OFFICE_TEL_NO = LEFT(
		CASE
			WHEN ISNULL(C.OFF_PHONE1,'') <> '' THEN REPLACE(REPLACE(C.OFF_PHONE1,':',''),';','')
			WHEN ISNULL(C.OFF_PHONE2,'') <> ''	THEN REPLACE(REPLACE(C.OFF_PHONE2,':',''),';','')
			ELSE ''
		END,60)
	FROM 
		CUSTODIAN C (NOLOCK),
		CLIENT_BROK_DETAILS CB(NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CB.CL_CODE
		AND CB.CUSTODIAN_CODE = C.CUSTODIANCODE



	UPDATE #UCC_NSE
	SET	COR_ADDRESS1 = REPLACE(REPLACE(REPLACE(COR_ADDRESS1, CHAR(13), ''),CHAR(10),''),'''',''),
		COR_ADDRESS2 = REPLACE(REPLACE(REPLACE(COR_ADDRESS2, CHAR(13), ''),CHAR(10),''),'''',''),
		COR_ADDRESS3 = REPLACE(REPLACE(REPLACE(COR_ADDRESS3, CHAR(13), ''),CHAR(10),''),'''',''),
		PER_ADDRESS1 = REPLACE(REPLACE(REPLACE(PER_ADDRESS1, CHAR(13), ''),CHAR(10),''),'''',''),
		PER_ADDRESS2 = REPLACE(REPLACE(REPLACE(PER_ADDRESS2, CHAR(13), ''),CHAR(10),''),'''',''),
		PER_ADDRESS3 = REPLACE(REPLACE(REPLACE(PER_ADDRESS3, CHAR(13), ''),CHAR(10),''),'''',''),
		BANK_BRANCH_ADD_1 = REPLACE(REPLACE(REPLACE(BANK_BRANCH_ADD_1, CHAR(13), ''),CHAR(10),''),'''',''),
		BANK_NAME_1	=  REPLACE(REPLACE(REPLACE(BANK_NAME_1, CHAR(13), ''),CHAR(10),''),'''','')


	UPDATE
		#UCC_NSE
	SET
		ERROR_FLAG	= (
		CASE
			WHEN ISNULL(CLIENT_NAME,'') = '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') = '' THEN 'Y'
			WHEN ISNULL(PAN,'') = '' THEN 'Y'
			WHEN ISNULL(GENDER,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'Y'
			WHEN ISNULL(GUARDIANS_NAME,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'Y' 
			WHEN ISNULL(MARITAL_STATUS,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'Y' 
			WHEN ISNULL(NATIONALITY,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'Y'
			WHEN ISNULL(EMAIL,'') = '' AND ISNULL(CATEGORY,'') IN ('6','7','8','9','12','16','21','22','23','24') THEN 'Y'
			WHEN ISNULL(COR_ADDRESS1,'') = '' THEN 'Y'
			WHEN ISNULL(COR_CITY,'') = '' THEN 'Y'
			WHEN ISNULL(COR_STATE,'') = '' THEN 'Y'
			WHEN ISNULL(COR_COUNTRY,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_ADDRESS1,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_CITY,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_STATE,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_COUNTRY,'') = '' THEN 'Y'			
			WHEN ISNULL(PHONENO_RES,'') <> '' THEN
				CASE 
					WHEN COR_COUNTRY = '85' AND ISNULL(STD_CODE_RES,'') = '' THEN 'Y'
					WHEN COR_COUNTRY <> '85' AND ISNULL(ISD_CODE_RES,'') = '' THEN 'Y'
					ELSE 'N'
				END
			WHEN ISNULL(PHONENO_RES,'') = '' AND ISNULL(PHONENO_OFF,'') = '' AND ISNULL(MOBILENO,'') = '' THEN 'Y'		
			WHEN ISNULL(PHONENO_OFF,'') <> '' THEN
				CASE 
					WHEN COR_COUNTRY = '85' AND ISNULL(STD_CODE_OFF,'') = '' THEN 'Y'
					WHEN COR_COUNTRY <> '85' AND ISNULL(ISD_CODE_OFF,'') = '' THEN 'Y'
					ELSE 'N'
				END
			WHEN ISNULL(DOB,'') = '' AND ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','22','23','24') THEN 'Y'		
			WHEN (ISNULL(BANK_NAME_1,'') = '' OR ISNULL(BANK_BRANCH_ADD_1,'') = '' OR ISNULL(BANK_ACCOUNT_NO_1,'') = '') AND ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') THEN 'Y'
			WHEN ISNULL(CIN_NO,'') = '' AND ISNULL(CATEGORY,'') = '4' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(GROSS_ANNUAL_INCOME,'') = '' AND ISNULL(NET_WORTH,'') = '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(GROSS_ANNUAL_INCOME_DATE,'') = '' AND ISNULL(GROSS_ANNUAL_INCOME,'') <> '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(NET_WORTH_DATE,'') = '' AND ISNULL(NET_WORTH,'') <> '' THEN 'Y'			
			WHEN ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') AND ISNULL(OCCUPATION,'') = '' THEN 'Y'
			ELSE 'N'
		END),
		
		ERROR_MSG = ERROR_MSG + (
		CASE
			WHEN ISNULL(CLIENT_NAME,'') = '' THEN 'CLIENT NAME DETAILS MISSING' + '|'
			ELSE ''
		END) +
		CASE
			WHEN ISNULL(CATEGORY,'') = '' THEN 'CLIENT CATEGORY MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN PAN = '' THEN 'PAN NO DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(GENDER,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'GENDER DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(GUARDIANS_NAME,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'GUARDIAN (FATHER/HUSBAND/GUARDIAN NAME) DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(MARITAL_STATUS,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'MARITAL DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(NATIONALITY,'') = '' AND ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') THEN 'NATIONALITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(EMAIL,'') = '' AND ISNULL(CATEGORY,'') IN ('6','7','8','9','12','16','21','22','23','24') THEN 'EMAIL DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_ADDRESS1,'') = '' THEN 'CORRESPONDENCE ADDRESS DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_CITY,'') = '' THEN 'CORRESPONDENCE CITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_STATE,'') = '' THEN 'CORRESPONDENCE STATE DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_COUNTRY,'') = '' THEN 'CORRESPONDENCE COUNTRY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_ADDRESS1,'') = '' THEN 'PERMANENT ADDRESS DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_CITY,'') = '' THEN 'PERMANENT CITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_STATE,'') = '' THEN 'PERMANENT STATE DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_COUNTRY,'') = '' THEN 'PERMANENT COUNTRY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(PHONENO_RES,'') <> '' THEN
			CASE 
				WHEN COR_COUNTRY = '85' AND ISNULL(STD_CODE_RES,'') = '' THEN 'RES. STD CODE DETAILS MISSING' + '|'
				WHEN COR_COUNTRY <> '85' AND ISNULL(ISD_CODE_RES,'') = '' THEN 'RES. ISD CODE DETAILS MISSING' + '|'
				ELSE ''
			END
			ELSE ''
		END +
		CASE
			WHEN ISNULL(PHONENO_RES,'') = '' AND ISNULL(PHONENO_OFF,'') = '' AND ISNULL(MOBILENO,'') = '' THEN 'RES. PHONE, OFF. PHONE / MOBILE NO DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(PHONENO_OFF,'') <> '' THEN 
			CASE 
				WHEN COR_COUNTRY = '85' AND ISNULL(STD_CODE_OFF,'') = '' THEN 'RES. STD CODE DETAILS MISSING' + '|'
				WHEN COR_COUNTRY <> '85' AND ISNULL(ISD_CODE_OFF,'') = '' THEN 'RES. ISD CODE DETAILS MISSING' + '|'
				ELSE ''
			END
			ELSE ''
		END +
		CASE
			WHEN ISNULL(DOB,'') = '' AND ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','22','23','24') THEN 'DATE OF BIRTH DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN (ISNULL(BANK_NAME_1,'') = '' OR ISNULL(BANK_BRANCH_ADD_1,'') = '' OR ISNULL(BANK_ACCOUNT_NO_1,'') = '') AND ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') THEN 'BANK DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CIN_NO,'') = '' AND ISNULL(CATEGORY,'') = '4' THEN 'CIN DETAILS MISSING FOR CORPORATE CLIENT' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(GROSS_ANNUAL_INCOME,'') = '' AND ISNULL(NET_WORTH,'') = '' THEN 'ANNUAL INCOME / NET WORTH DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(GROSS_ANNUAL_INCOME_DATE,'') = '' AND ISNULL(GROSS_ANNUAL_INCOME,'') <> '' THEN 'ANNUAL INCOME DATE DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('6','7','8','9','12','16','21','22','23','24') AND ISNULL(NET_WORTH_DATE,'') = '' AND ISNULL(NET_WORTH,'') <> '' THEN 'NET WORTH DATE DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') IN ('1','11','18','25','26','27','31') AND ISNULL(OCCUPATION,'') = '' THEN 'OCCUPATION DETAILS MISSING' + '|'
			ELSE ''
		END	
	
	SELECT @R_COUNT = COUNT(1) FROM #UCC_NSE WHERE ERROR_FLAG = 'N'		
	
	IF (@BULK_MODIFY_FLAG = 0)
	BEGIN
		SELECT *,R_COUNT = @R_COUNT FROM #UCC_NSE (NOLOCK)
		WHERE ERROR_FLAG = (
		CASE
			WHEN @UCC_FLAG = '' THEN ERROR_FLAG
			ELSE @UCC_FLAG
		END)	
		ORDER BY ERROR_FLAG, CLIENT_CODE, ORD_FLAG
	END
	ELSE
	BEGIN
		SELECT 
			SEGMENT,
			CLIENT_CODE,
			GENDER,
			GUARDIANS_NAME,
			MARITAL_STATUS,
			NATIONALITY,
			OTHER_NATIONALITY,
			EMAIL,
			COR_ADDRESS1 = COR_ADDRESS1 + (CASE WHEN COR_ADDRESS2 <> '' THEN ' '+COR_ADDRESS2 ELSE '' END) + (CASE WHEN COR_ADDRESS3 <> '' THEN' '+COR_ADDRESS3 ELSE '' END),
			COR_CITY,
			COR_STATE,
			COR_STATE_OTHER,
			COR_COUNTRY,
			COR_L_ZIP,
			ADDRESS_FLAG,
			PER_ADDRESS1 = PER_ADDRESS1 + (CASE WHEN PER_ADDRESS2 <> '' THEN ' '+PER_ADDRESS2 ELSE '' END) + (CASE WHEN PER_ADDRESS3 <> '' THEN' '+PER_ADDRESS3 ELSE '' END),
			PER_CITY,
			PER_STATE,
			PER_STATE_OTHER,
			PER_COUNTRY,
			PER_L_ZIP,
			ISD_CODE_RES,
			STD_CODE_RES,
			PHONENO_RES,
			MOBILENO,
			ISD_CODE_OFF,
			STD_CODE_OFF,
			PHONENO_OFF,
			DOB,
			BANK_NAME_1,
			BANK_BRANCH_ADD_1,
			BANK_ACCOUNT_NO_1,
			DP_NAME_1,
			DP_ID_1,
			BEN_ACCOUNT_NO_1,
			CIN_NO,
			GROSS_ANNUAL_INCOME,
			GROSS_ANNUAL_INCOME_DATE,
			NET_WORTH,
			NET_WORTH_DATE,
			POLITICALLY_EXPOSED_PERSON,
			OCCUPATION,
			OCCUPATION_OTHER,
			CP_CODE,
			UPDATIONFLAG,
			RELATIONSHIP,
			TYPEOFFACILITY,
			CLIENT_TYPE_CORPORATE,
			CONTACT_PERSON_NAME_1,
			CONTACT_PERSON_DESIGNATION_1,
			CONTACT_PERSON_PAN_1,
			CONTACT_PERSON_ADDRESS_1,
			CONTACT_PERSON_DETAILS_1,
			CONTACT_PERSON_DIN_1,
			CONTACT_PERSON_UID_1,
			CONTACT_PERSON_EMAIL_1,
			CONTACT_PERSON_NAME_2,
			CONTACT_PERSON_DESIGNATION_2,
			CONTACT_PERSON_PAN_2,
			CONTACT_PERSON_ADDRESS_2,
			CONTACT_PERSON_DETAILS_2,
			CONTACT_PERSON_DIN_2,
			CONTACT_PERSON_UID_2,
			CONTACT_PERSON_EMAIL_2,
			POA_FUND_FLAG,
			POA_SEC_FLAG,

			CUSTODIAN_NAME,
			CUSTODIAN_PAN,
			CUSTODIAN_EMAIL,
			CUSTODIAN_ADDRESS,
			CUSTODIAN_CITY,
			CUSTODIAN_STATE,
			CUSTODIAN_STATE_OTHERS,
			CUSTODIAN_COUNTRY,
			CUSTODIAN_PINCODE,
			CUSTODIAN_MOBILENO,
			CUSTODIAN_OFFICE_ISD_CODE,
			CUSTODIAN_OFFICE_STD_CODE,
			CUSTODIAN_OFFICE_TEL_NO,

			END_FLAG,
			ORD_FLAG,
			ERROR_FLAG,
			ERROR_MSG,
			R_COUNT = @R_COUNT FROM #UCC_NSE (NOLOCK)
		WHERE ERROR_FLAG = (
		CASE
			WHEN @UCC_FLAG = '' THEN ERROR_FLAG
			ELSE @UCC_FLAG
		END)	
		ORDER BY ERROR_FLAG, CLIENT_CODE, ORD_FLAG
	END
			
	DROP TABLE #UCC_NSE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_VBB_Broktabledetails
-- --------------------------------------------------
CREATE Proc [dbo].[rpt_VBB_Broktabledetails]  
 (  
 @PARTYCODE VARCHAR(15)  
 )  
  
 As  
  
 If (Select Count(1) From Sysobjects Where Name ='Scheme_Mapping') > 0  
 Begin  
  
  Set NoCount On  
  Set Transaction Isolation Level Read Uncommitted   
    
  Select    
  SchemeDt = left(SP_Date_From,11) + ' -  ' + left(SP_Date_to,11),  
  SchemeType= case SP_Inst_Type when 'FUT' then 'Future' else 'Option' End + ' ' +   
   Case When SP_Trd_Type='TRD' then 'Normal Trade' else 'Exer.Assg/Exp.Closd' End,  
  Symbol = Sp_Scrip ,   
  ComputationType = case SP_Brok_ComputeType when  'I' then 'Incremental' else 'Variable' end,  
  BrokComputeOn = Case When SP_Brok_ComputeOn ='T' Then 'Turnover' Else  
     Case When SP_Brok_ComputeOn ='Q' Then 'Quantity' Else  
     Case When SP_Brok_ComputeOn ='L' Then 'Lot Size' Else  
     'Value Of Lot' End End End ,  
  ComputationLevel = Case When Sp_Computation_Level ='T' Then 'Trades' Else  
     Case When Sp_Computation_Level ='O' Then 'Order' Else  
     Case When Sp_Computation_Level ='S' Then 'Scrip' Else  
      'Contract' End End End,  
  Scheme = Case When Sp_Scheme_Type=0 then 'Default' else  
     Case When Sp_Scheme_Type=1 then 'Max Logic BS FL' else   
    'Max Logic SS FL' end end,  
  ValueRange = convert(varchar,sp_value_from) + ' - ' + case when sp_value_to = -1 then 'Un Limit' else  
   convert(varchar,sp_value_to) end,  
  Brok = 'Buy ' + convert(varchar,sp_buy_brok) + Case when sp_buy_brok_type ='V' then ' Value' else ' Perc' end  +
	 ' Sell ' + convert(varchar,sp_sell_brok) + Case when sp_sell_brok_type ='V' then ' Value' else ' Perc' end +
	 ' Min Brok ' + convert(varchar,SP_Min_BrokAmt) + ' Max Brok ' + convert(varchar,SP_Max_BrokAmt),
   
  ScrOrd = case when SP_Scrip='ALL' then 1 else 2 end,  
  RCount = 1  
  From Scheme_Mapping   
  Where SP_Party_Code = @PARTYCODE  
  Order By 1,3,ScrOrd  
   
 End  
 Else  
 Begin  
  Select  
  RCount = 0  
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_VBB_Scheme_Listing
-- --------------------------------------------------
CREATE Procedure  [dbo].[rpt_VBB_Scheme_Listing]

   @Scheme_Type varchar(3),
   @Computation_Type varchar(3)

AS
   set transaction isolation level read uncommitted

Select 

     SM_Scheme_ID,
     SM_Scheme_Desc, 
     SM_ComputationOn = case when SM_ComputationOn = 'v' then 'Value Of Lot' 
                             when SM_ComputationOn = 'T' then 'TurnOver'
                             when SM_ComputationOn = 'Q' then 'Quantity'
                             when SM_ComputationOn = 'L' then 'Lot Size'
                             end,
     SM_ComputationType = case when SM_ComputationType = 'V' then 'Variable'
                               when SM_ComputationType = 'I' then 'Incremental'
                               end,
     SM_Trd_Type,
     SM_TurnOverOn,
     SM_Value_From,
     SM_Value_To,
     SM_Res_Multiplier,
     SM_Buy_Brok_Type,
     SM_Sell_Brok_Type,
     SM_Buy_Brok,
     SM_Sell_Brok 

From 
     Scheme_master 

Where
	1 = Case 
		When @Scheme_Type = 'ALL' 
		Then 1
		Else 
			Case When SM_Trd_Type = @Scheme_Type then 1 else 2 End
		End AND					
	1 = Case 
		When @Computation_Type = 'ALL' 
		Then 1
		Else 
			Case When SM_ComputationType = @Computation_Type then 1 else 2 end
		End

  Order By 
         SM_Scheme_ID,
         SM_Value_From

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_VBB_Scheme_Mapping
-- --------------------------------------------------


CREATE Procedure  [dbo].[rpt_VBB_Scheme_Mapping]

   @Date_Frm Varchar(12),
   @Party_Frm Varchar(20),
   @Party_To Varchar(20),
   @Instru_type Varchar(5),
   @SP_Scrip Varchar(10),
   @scheme_type Varchar(8)


AS

	if @Party_To = '' begin set @Party_To = 'zzzzz' end
	if @SP_Scrip = '' begin set @SP_Scrip = 'ALL' end

   set transaction isolation level read uncommitted

Select 

   SP_Party_Code,
   Long_Name,
   SP_Computation_Level = case when SP_Computation_Level = 'T' then 'Trade' 
                               when SP_Computation_Level = 'O' then 'Order'
                               when SP_Computation_Level = 'S' then 'Scrip'
                               when SP_Computation_Level = 'C' then 'Contract'
                             end, 
   SP_Inst_Type,
   SP_Scrip,
   SP_Scheme_Id,
   SP_Trd_Type,
   SP_Scheme_Type = case when SP_Scheme_Type = '0' then 'Default'
                         when SP_Scheme_Type = '1' then 'Max BuyFL'
                         when SP_Scheme_Type = '3' then 'Max SellFL'
                        end,
   SP_Multiplier,
   SP_Buy_Brok_Type = case when SP_Buy_Brok_Type='P' then '%' else 'V' end,
   SP_Sell_Brok_Type  = case when SP_Sell_Brok_Type='P' then '%' else 'V' end,
   SP_Buy_Brok,
   SP_Sell_Brok,
   SP_Value_From,
   SP_Value_To,
   SP_TurnOverOn,
   SP_Brok_ComputeOn = case when SP_Brok_ComputeOn = 'v' then 'Value Of Lot' 
                           when SP_Brok_ComputeOn = 'L' then 'Lot Size'
                           when SP_Brok_ComputeOn = 'Q' then 'Quantity'
                           when SP_Brok_ComputeOn = 'T' then 'Turn Over'
                        end,
   SP_Brok_ComputeType = case when SP_Brok_ComputeType = 'V' then 'Variable' 
                             when SP_Brok_ComputeType = 'I' then 'Incremental' 
                        end,
   SP_Min_BrokAmt,
   SP_Max_BrokAmt,
   SP_Min_ScripAmt,
   SP_Max_ScripAmt,
   SP_Date_From = convert(varchar,SP_Date_From,106),
   SP_Date_To   = convert(varchar,SP_Date_To,106)

  From 
        Scheme_Mapping(nolock) , Client1(nolock) , client2(nolock)
 
 Where
      client1.cl_code= client2.cl_code and client2.party_code = sp_party_code 
      AND @Date_Frm BETWEEN  SP_Date_From AND SP_Date_To + ' 23:29'
      AND SP_Party_Code BETWEEN @Party_Frm AND @Party_To
      AND  1 = Case 
					When @instru_type = 'BOTH' 
					Then
						1
					Else 
						Case When SP_Inst_Type = @instru_type then 1 else 2 End
					End 
      AND 1 = Case 
					When @scheme_type = 'ALL' 
					Then
						1
					Else 
						Case When SP_Trd_Type = @scheme_type then 1 else 2 End
					End 

      AND SP_Scrip = @SP_Scrip

  Order By

        SP_Party_Code,
        SP_Date_From,
        SP_Inst_Type,
        SP_Trd_Type, 
        SP_Scrip,
        SP_Value_From

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddBranch_Execute
-- --------------------------------------------------




CREATE  PROC sp_AddBranch_Execute
@strSQL VarChar(8000)
AS
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddClient_Execute
-- --------------------------------------------------



/****** Object:  Stored Procedure dbo.sp_AddClient_Execute    Script Date: 1/17/2004 11:42:56 PM ******/







/****** Object:  Stored Procedure dbo.sp_AddClient_Execute    Script Date: May 12 2003 11:20:53 ******/
CREATE   PROC sp_AddClient_Execute
@strSQL VarChar(8000)
AS
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_AddEditScrip_Execute
-- --------------------------------------------------


-- Alter this sp under SRE-34143

CREATE  PROC [dbo].[sp_AddEditScrip_Execute]
@strSQL VarChar(8000)
AS
SET NOCOUNT ON;
	Print @strSQL
	Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_AUTHORIZED_USER
-- --------------------------------------------------


CREATE PROC [dbo].[SP_AUTHORIZED_USER]  
(  
 @VALUE VARCHAR(MAX),  
 @FLAG VARCHAR(10), --R = REJECT / A=APPROVE    
 @USERIPADD VARCHAR(15),  
 @ADMIN_NAME VARCHAR(15),  
 @IPADD VARCHAR(15)   
)  
  
  
AS  
SET NOCOUNT ON  
DECLARE   
 @@NEWDATE  VARCHAR(11),  
 @@MAXCOUNT TINYINT,  
    @@MAXCNT   TINYINT,  
 @@MAX_EDIT TINYINT,  
 @@FLDAUTO INT,   
 @@FLDADMINAUTO INT,  
 @REMARK VARCHAR(100),  
 @UNAME VARCHAR(100),  
 @DATA VARCHAR(MAX),    
 @EXCHSEG VARCHAR(500),   
 @@EXCHSEG VARCHAR(500),  
 @@EXCHANGE VARCHAR(3),  
 @@SEGMENT VARCHAR(25),  
 @@SHAREDB VARCHAR(25),   
 @@SHARESERVER VARCHAR(25),  
 @STREXCHSEG  VARCHAR(50),   
 @@DB VARCHAR(MAX),    
 @@LOG VARCHAR(MAX),  
 @@FLDLOG_DATA VARCHAR(MAX),  
 @LOOPID INT,   
 @LOOP_ID INT,  
   
 @@SEGORD TINYINT,  
 @@MAINREC AS CURSOR  
   
 CREATE TABLE #TEMP  
 (  
  UNAME VARCHAR(50),  
  REMARK VARCHAR(500),  
  EXCHSEG VARCHAR(500),  
  FLAG CHAR(1),  
  MAX_EDIT TINYINT   
 )  
 CREATE TABLE #FLDAUTO  
 (  
  FLDAUTO INT,  
  FLDADMINAUTO INT  
 )  
 CREATE TABLE #FLDLOG_DATA  
 (  
  FLDLOG_DATA VARCHAR(MAX)   
 )     
  
BEGIN TRAN  
 SELECT @@NEWDATE = CONVERT(VARCHAR,GETDATE(),109)  
 SELECT @@MAXCNT = ISNULL(MAX_REJECTION_ALLOW,0) FROM TBLGLOBALPARAMS  
   
 SET @LOOPID = 1  
  WHILE 1 = 1  
  BEGIN  
   SET @DATA = .DBO.PIECE(@VALUE, '', @LOOPID)  
     
   SET @UNAME = .DBO.PIECE(@DATA, '', 1)  
   SET @REMARK = .DBO.PIECE(@DATA, '', 2)  
   SET @EXCHSEG = .DBO.PIECE(@DATA, '', 3)  
      
   IF PATINDEX('%,%',@EXCHSEG) > 0   
    BEGIN  
    SET @LOOP_ID = 1  
     WHILE 1 = 1  
     BEGIN  
      SET @STREXCHSEG = .DBO.PIECE(@EXCHSEG,',',@LOOP_ID)  
      PRINT @STREXCHSEG  
      IF @STREXCHSEG = '' OR @STREXCHSEG IS NULL  
       BEGIN  
       BREAK  
       END  
      
      SELECT @@MAX_EDIT = ISNULL(MAX_EDIT,0) FROM TBLUSERS TU, TBLPRADNYAUSERS TP WHERE FLDUSERNAME = @UNAME AND TU.PRADNYAAUTO = TP.FLDAUTO   
      INSERT INTO #TEMP(UNAME, REMARK, EXCHSEG, FLAG, MAX_EDIT) VALUES (UPPER(@UNAME), UPPER(@REMARK), UPPER(@STREXCHSEG), UPPER(@FLAG), @@MAX_EDIT)  
     SET @LOOP_ID = @LOOP_ID + 1    
     END  
    END  
   ELSE  
    BEGIN  
    IF @DATA = '' OR @DATA IS NULL  
     BEGIN  
     BREAK  
     END  
    SELECT @@MAX_EDIT = ISNULL(MAX_EDIT,0) FROM TBLUSERS TU, TBLPRADNYAUSERS TP WHERE FLDUSERNAME = @UNAME AND TU.PRADNYAAUTO = TP.FLDAUTO   
    INSERT INTO #TEMP(UNAME, REMARK, EXCHSEG, FLAG, MAX_EDIT) VALUES (UPPER(@UNAME), UPPER(@REMARK), UPPER(@EXCHSEG), UPPER(@FLAG), @@MAX_EDIT)      
    END      
      
     
   SET @LOOPID = @LOOPID + 1   
  END  
  
  
 SET @@MAINREC = CURSOR FOR   
  SELECT   
   EXCHANGE, SEGMENT, SHAREDB, SHARESERVER, UNAME, REMARK, FLAG, MAX_EDIT   
  FROM   
   PRADNYA.DBO.MULTICOMPANY MC (NOLOCK), #TEMP TP  
  WHERE   
   PRIMARYSERVER = 1   
   AND MC.EXCHANGE +'~'+ MC.SEGMENT = TP.EXCHSEG   
  
 OPEN @@MAINREC  
  FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESERVER, @UNAME, @REMARK, @FLAG, @@MAX_EDIT   
  
 SET @@SEGORD = 1  
 WHILE @@FETCH_STATUS = 0  
  BEGIN   
  
  print'mk1'
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@DB = " INSERT INTO #FLDAUTO "  
   SET @@DB = @@DB + " SELECT FLDAUTO, FLDADMINAUTO INT FROM " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@UNAME+"' "  
   END   
  ELSE  
   BEGIN  
   SET @@DB = " INSERT INTO #FLDAUTO "  
   SET @@DB = @@DB + " SELECT FLDAUTO, FLDADMINAUTO INT FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@UNAME+"' "  
   END  
    
  EXEC(@@DB)   
  SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #FLDAUTO  
    print'mk2'
  IF @@MAX_EDIT = '' OR @@MAX_EDIT IS NULL  
   BEGIN  
   SET @@DB = " DELETE FROM TBLUSERS WHERE PRADNYAAUTO = " + CONVERT(VARCHAR,@@FLDAUTO) + " "
   SET @@DB = @@DB + " INSERT INTO TBLUSERS (PRADNYAAUTO,REMARK,MAX_EDIT,BLOCK) VALUES ( "+CONVERT(VARCHAR,@@FLDAUTO)+" ,'"+ @REMARK +"',1,'N') "  
   SET @@MAX_EDIT = 0   
   END  
  ELSE 
  print 'mk3' 
   BEGIN 
   SET @@DB = " INSERT INTO "  
   IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
    BEGIN  
    SET @@DB = @@DB + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS_LOG "  
    END  
   ELSE  
    BEGIN  
    SET @@DB = @@DB + " " + @@SHAREDB + ".DBO.TBLUSERS_LOG "  
    END   
	print 'mk4'
   SET @@DB = @@DB + "SELECT "  
   SET @@DB = @@DB + " TU.FLDAUTO,PRADNYAAUTO,'"+@REMARK+"',TU.MAX_EDIT,BLOCK,'"+@ADMIN_NAME+"','"+@@NEWDATE+"','"+@USERIPADD+"' "  
   SET @@DB = @@DB + "FROM "  
   IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
    BEGIN  
    SET @@DB = @@DB + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS TU "  
    END  
   ELSE  
    BEGIN  
    SET @@DB = @@DB + " " + @@SHAREDB + ".DBO.TBLUSERS TU "  
    END  
   SET @@DB = @@DB + " WHERE "  
   SET @@DB = @@DB + " PRADNYAAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "  
   --SET @@DB = @@DB + " AND '"+@FLAG+"' = 'R' "    
   END     
   print 'mk5'
  SET @@DB = @@DB + " UPDATE " --****if records is exist already then update count + 1 *****  
  SET @@DB = @@DB + "  TU "  
  SET @@DB = @@DB + " SET "  
  SET @@DB = @@DB + "  REMARK  = '"+@REMARK+"', "  
  SET @@DB = @@DB + "  MAX_EDIT = (CASE WHEN "+CONVERT(VARCHAR,@@MAX_EDIT)+" < "+CONVERT(VARCHAR,@@MAXCNT)+" THEN "+CONVERT(VARCHAR,@@MAX_EDIT+1)+" ELSE "+CONVERT(VARCHAR,@@MAXCNT)+" END), "  
  SET @@DB = @@DB + "  BLOCK  = (CASE WHEN "+CONVERT(VARCHAR,@@MAX_EDIT)+" = "+CONVERT(VARCHAR,@@MAXCNT)+" THEN 'Y' ELSE 'N' END) "  
  SET @@DB = @@DB + " FROM "  
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERS TU "  
   END  
  ELSE  
   BEGIN  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.TBLUSERS TU "  
   END  
  SET @@DB = @@DB + " WHERE "  
  SET @@DB = @@DB + " PRADNYAAUTO = '"+CONVERT(VARCHAR,@@FLDAUTO)+"' "  
  SET @@DB = @@DB + "  AND BLOCK = 'N' "  
  SET @@DB = @@DB + "  AND '"+@FLAG+"' = 'R' "   
   print 'mk6'
  SET @@DB = @@DB + " UPDATE "  
  SET @@DB = @@DB + "  TU "  
  SET @@DB = @@DB + " SET "  
  SET @@DB = @@DB + "  FLDSTATUS = CASE WHEN UPPER('"+@FLAG+"') = 'R' THEN 3 ELSE 0 END "  
  SET @@DB = @@DB + " FROM "  
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "  
   END  
  ELSE  
   BEGIN  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "  
   END   
  SET @@DB = @@DB + " WHERE "  
  SET @@DB = @@DB + "  FLDSTATUS IN ('1','2','3') "  
  SET @@DB = @@DB + "  AND TU.FLDUSERID = TP.FLDAUTO "  
  SET @@DB = @@DB + "  AND TP.FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "  
  
  --*****Start Authorization for Disabling user******  
  SET @@DB = @@DB + " UPDATE "  
  SET @@DB = @@DB + "  TU "  
  SET @@DB = @@DB + " SET "   
  SET @@DB = @@DB + "  FLDSTATUS = CASE WHEN UPPER('"+@FLAG+"') = 'R' THEN 0 ELSE 1 END "  
  SET @@DB = @@DB + " FROM "  
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU, "  
   SET @@DB = @@DB + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.USERDISABLED_LIST TD"  
   END  
  ELSE  
   BEGIN  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, "  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU, "  
   SET @@DB = @@DB + "  " + @@SHAREDB + ".DBO.USERDISABLED_LIST TD "  
   END  
  SET @@DB = @@DB + " WHERE "  
  SET @@DB = @@DB + "  TD.USERSTATUS = '1' "  
  SET @@DB = @@DB + "  AND TU.FLDUSERID = TP.FLDAUTO "  
  SET @@DB = @@DB + "  AND TP.FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "  
  SET @@DB = @@DB + "  AND TU.FLDUSERID = TD.USERID "  
  print 'mk7'
  SET @@DB = @@DB + " DELETE "  
   SET @@DB = @@DB + " USERDISABLED_LIST WHERE USERID = "+CONVERT(VARCHAR,@@FLDAUTO)+"  "  
  --****End Start Authorization for Disabling user****   
  print 'mk8'
  --****Start Log of Pradnyatable updation****  
  SET @@LOG = "INSERT INTO #FLDLOG_DATA SELECT   
   FLDPASSWORD +'~'+   
   CASE WHEN FLDFIRSTNAME = '' THEN '$' ELSE FLDFIRSTNAME END +'~'+  
   CASE WHEN FLDMIDDLENAME = '' THEN '$' ELSE FLDMIDDLENAME END +'~'+  
   CASE WHEN FLDLASTNAME = '' THEN '$' ELSE FLDLASTNAME END +'~'+  
   CASE WHEN FLDSEX = '' THEN '$' ELSE FLDSEX END +'~'+  
   CASE WHEN FLDADDRESS1 = '' THEN '$' ELSE FLDADDRESS1 END +'~'+  
   CASE WHEN FLDADDRESS2 = '' THEN '$' ELSE FLDADDRESS2 END  +'~'+  
   CASE WHEN FLDPHONE1 = '' THEN '$' ELSE FLDPHONE1 END +'~'+  
   CASE WHEN FLDPHONE2 = '' THEN '$' ELSE FLDPHONE2 END +'~'+  
   CASE WHEN CONVERT(VARCHAR,FLDCATEGORY) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDCATEGORY) END+'~'+  
   CASE WHEN CONVERT(VARCHAR,PWD_EXPIRY_DATE) = '' THEN '$' ELSE CONVERT(VARCHAR,PWD_EXPIRY_DATE) END +'~'+   
   CASE WHEN CONVERT(VARCHAR,FLDATTEMPTCNT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDATTEMPTCNT) END +'~'+  
   CASE WHEN CONVERT(VARCHAR,FLDSTATUS) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDSTATUS) END +'~'+  
   CASE WHEN CONVERT(VARCHAR,FLDLOGINFLAG) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDLOGINFLAG) END +'~'+  
   CASE WHEN FLDACCESSLVL = '' THEN '$' ELSE FLDACCESSLVL END +'~'+  
   CASE WHEN FLDIPADD  = '' THEN '$' ELSE FLDIPADD END+'~'+  
   CASE WHEN CONVERT(VARCHAR,FLDTIMEOUT) = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+  
   CASE WHEN FLDFIRSTLOGIN = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+   
   CASE WHEN CONVERT(VARCHAR,FLDFORCELOGOUT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDFORCELOGOUT) END +'~'+  
   CASE WHEN FLD_MAC_ID = '' THEN '$' ELSE FLD_MAC_ID END "  
  SET @@LOG = @@LOG + " FROM "  
    
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@LOG = @@LOG + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "  

   END  
  ELSE  
   BEGIN  
   SET @@LOG = @@LOG + " " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU "      
   END  
  SET @@LOG = @@LOG + " WHERE "    
  SET @@LOG = @@LOG + "  TP.FLDAUTO = FLDUSERID "    
  SET @@LOG = @@LOG + "  AND FLDUSERNAME = '"+ @UNAME +"' "    
  exec (@@LOG)    
  SELECT @@FLDLOG_DATA = FLDLOG_DATA FROM #FLDLOG_DATA         
     print 'mk9'
  SET @@LOG = " "  
  SET @@LOG = @@LOG + " INSERT INTO "--******CLASS USER LOG TABLE ********  
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@LOG = @@LOG + "  " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG  "  
   END  
  ELSE  
   BEGIN  
  
   SET @@LOG = @@LOG + "  " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG  "  
   END  
  SET @@LOG = @@LOG + " (  "  
  SET @@LOG = @@LOG + " FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  "  
  SET @@LOG = @@LOG + " FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  "  
  SET @@LOG = @@LOG + " ) "  
  SET @@LOG = @@LOG + " SELECT "  
  SET @@LOG = @@LOG + "  FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, "  
  SET @@LOG = @@LOG + "  FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, '"+@FLAG+"', '"+@ADMIN_NAME+"', '"+@@NEWDATE+"', '"+@IPADD+"', '"+@@FLDLOG_DATA +"' "  
  SET @@LOG = @@LOG + " FROM "  
  IF @@SHARESERVER <> @@SERVERNAME AND 1 <> 1    
   BEGIN  
   SET @@LOG = @@LOG + " " + @@SHARESERVER + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS "  
   END  
  ELSE  
   BEGIN  
   SET @@LOG = @@LOG + " " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS "  
   END  
  SET @@LOG = @@LOG + " WHERE "  
  SET @@LOG = @@LOG + "  FLDUSERNAME = '"+ @UNAME +"' "  
  
  SET @@LOG = @@LOG + "  INSERT INTO "  
  SET @@LOG = @@LOG + "   TBLUSERCONTROLMASTER_JRNL "  
  SET @@LOG = @@LOG + "  SELECT "  
  SET @@LOG = @@LOG + "   *,"+CONVERT(VARCHAR,@@FLDADMINAUTO)+",'"+@@NEWDATE+"' "  
  SET @@LOG = @@LOG + "  FROM "  
  SET @@LOG = @@LOG + "   TBLUSERCONTROLMASTER "  
  SET @@LOG = @@LOG + "  WHERE "  
  SET @@LOG = @@LOG + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" " --****End Log of Pradnyatable updation****  
    
 --PRINT(@@LOG)  
 EXEC(@@DB)  
  
  SET @@SEGORD = @@SEGORD + 1   
  FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESERVER, @UNAME, @REMARK, @FLAG, @@MAX_EDIT    
  END    
  
 DROP TABLE #TEMP  
 DROP TABLE #FLDAUTO   
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_ClientDetails
-- --------------------------------------------------

CREATE   procedure [dbo].[sp_ClientDetails]     
(
	@FromDate   Varchar(11),     
	@ToDate     Varchar(11),
	@FromParty  Varchar(10),     
	@ToParty    Varchar(10),
	@BrCode     varchar(10),
	@ClientType Varchar(3) ,
	@Statusid   varchar(15),     
	@Statusname varchar(25),    
	@ClStatus   varchar(20),    
	@DpStatus   varchar(20),    
	@withTranDt Varchar(10),
	@NonTradMonth int = 0	
)
AS    



IF  (LEN(@ToParty)=0)
SET @ToParty = 'zzzzzzzzzz'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Select
	C2.Party_Code, C1.Long_Name, C1.Branch_Cd, C1.Sub_broker, C1.Trader, 
	Status = (Case When InActiveFrom <= GetDate() Then 'Inactive' Else 'Active  ' End),     
	convert(varchar(10),ActiveFrom,103) as ActiveFrom ,     
	convert(varchar(10),InActiveFrom,103) as InActiveFrom, 
	Approver, 
	DpId = IsNull(C4.BankId,''),     
	CltdpId = IsNull(CltdpId,''), 
	Depository = IsNull(C4.Depository,''),    
	FirstDate = Convert(Varchar,''), 
	LastDate = Convert(Varchar,'')
Into
	#CltReport 
From
	Client1 C1 (nolock), Client5 C5 (nolock), Client2 C2 (nolock)
	Left Outer Join Client4 C4 (nolock)    
	On ( C4.Party_Code = C2.Party_Code And C4.DefDp = 1 And C4.Depository in('NSDL','CDSL'))     
Where C1.Cl_Code = C2.Cl_Code And C1.Cl_Code = C5.Cl_Code     
	AND C1.Branch_Cd Like (Case When @BrCode = '' Then '%' Else @BrCode End)    
	And C1.Cl_Status Like (Case When @ClientType ='' Then '%' Else @ClientType End)
	And InActiveFrom >= (Case When @ClStatus='ACTIVE' Then GetDate()+1 Else InActiveFrom End)    
	And InActiveFrom <= (Case When @ClStatus='INACTIVE' Then GetDate() Else InActiveFrom End)    
	And ActiveFrom >= @FromDate And ActiveFrom <= @Todate + ' 23:59'    
	And Len(IsNull(C4.BankId,'')) >= (Case When @DpStatus='WITH' Then 1 Else 0 End)    
	And Len(IsNull(C4.BankId,'')) <= (Case When @DpStatus='WITHOUT' Then 0 Else 16 End)
	And C2.Party_Code Between @FromParty And @ToParty

        AND @STATUSNAME =   
	  (CASE   
	   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
	   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
	   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
	   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
	   WHEN @STATUSID = 'AREA' THEN C1.AREA  
	   WHEN @STATUSID = 'REGION' THEN C1.REGION  
	   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
	   ELSE   
	  'BROKER'  
	  END)


If @withTranDt ='WITHTRANDT' 
Begin
	Create Table #ClientList
	(
		Party_Code Varchar(10),
		MinTranDate Datetime,
		MaxTranDate Datetime
	)

	Insert Into #ClientList
	Select 	
		Party_Code,
		MinTranDate=Min(Sauda_Date),
		MaxTranDate=Max(Sauda_Date) 
	From 
		FoBillValan (nolock)
	Where 
		party_code in (Select Party_Code From #CltReport)
	Group by 
		party_code
	
	Update
		#CltReport 
		Set FirstDate = Convert(Varchar,MinTranDate,103), 
		LastDate = Convert(Varchar,MaxTranDate,103)
	From  
		#ClientList
	Where
		#CltReport.Party_Code = #ClientList.Party_Code

	Drop table #ClientList
End

Create Table #NonTrClientList
(
	Party_Code Varchar(15)
)

If @ClStatus = 'NOTTRADED'
Begin

	DELETE #CltReport WHERE PARTY_CODE IN
	(
		select Party_code From  Client5 (nolock), Client2 (nolock)
		Where Client2.Cl_Code = Client5.Cl_Code
		And ActiveFrom > DATEADD(Month, -@NonTradMonth, @ToDate)
	)


	Insert Into #NonTrClientList
	Select 
		Distinct Party_Code
	From
		FoBillValan (nolock)
	Where
		Sauda_Date >= DATEADD(Month, -@NonTradMonth, @ToDate)
		And Sauda_Date <= @ToDate + ' 23:59:59'
		And party_code in (Select Party_Code From #CltReport)	
	
End

Select 
	Party_Code,
	Long_Name, 
	Branch_Cd, 
	Sub_broker,
	Trader, 
	Status,    
	ActiveFrom,
	InActiveFrom, 
	Approver,
	DpId = Case When @DpStatus='WITHDP' Then DpId Else '' End, 
	CltdpId = Case When @DpStatus='WITHDP' Then CltDpId Else '' End, 
	Depository = Case When @DpStatus='WITHDP' Then Depository Else '' End,    
	FirstDate  = Case When @withTranDt ='WITHTRANDT' Then convert(varchar,FirstDate,103) Else '' End,     
	LastDate = Case When @withTranDt ='WITHTRANDT' Then convert(varchar,LastDate,103) Else '' End  
From
	#CltReport
Where	
	party_code Not In (Select Party_Code From #NonTrClientList)    
Order By
	Branch_Cd, Long_Name     

Drop Table #CltReport
Drop Table #NonTrClientList

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLIENTMARGINDETAILS
-- --------------------------------------------------

CREATE   PROC SP_CLIENTMARGINDETAILS   
( 
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@FROMPARTY VARCHAR(20),      
	@TOPARTY VARCHAR(20),      
	@FROMDATE VARCHAR(11),      
	@TODATE VARCHAR(11),      
	@BRANCH VARCHAR(10),      
	@TRADER VARCHAR (10),    
	@ORDERBY INT,
	@INTBRANCHWISE INT,
	@INTMARGINFLAG INT = 0,
	@INTREPORTBY INT  = 2      
)
AS

  
IF @TOPARTY = ''  
      BEGIN  
            SET @TOPARTY = 'ZZZZZZZ'  
      END     

    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET NOCOUNT ON
if @INTREPORTBY = 1
BEGIN
	SELECT
		STRREPROTORDER = CASE 
					WHEN @ORDERBY = 2 
					THEN 
						PARENTCODE + CONVERT(VARCHAR,MARGINDATE,112)
					ELSE
						CONVERT(VARCHAR,MARGINDATE,112) + PARENTCODE
					END ,

		INTREPORTORDER2 = CASE WHEN @INTBRANCHWISE = 1 THEN FO.BRANCH_CD ELSE '' END,

		MARGINDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,109),11),BILLDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,103),11),PARTY_CODE=PARENTCODE,      
		FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,BILLAMOUNT = SUM(ISNULL(BILLAMOUNT,0)),LEDGERAMOUNT = SUM(ISNULL(LEDGERAMOUNT,0)),      
		CASH_COLL = SUM(ISNULL(CASH_COLL,0)),NONCASH_COLL=SUM(ISNULL(NONCASH_COLL,0)),      
		INITIALMARGIN = SUM(ISNULL(INITIALMARGIN,0)), MTMMARGIN = SUM(ISNULL(MTMMARGIN,0)),
		ADDMARGIN = SUM(ISNULL(ADDMARGIN,0)),
		YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE),
		UNCLEARAMOUNT=0
	     
	FROM
		TBL_CLIENTMARGIN FO (NOLOCK),
		CLIENT1 , CLIENT2_VIEW CLIENT2
	WHERE
		MARGINDATE >= @FROMDATE      
		AND MARGINDATE <= @TODATE + ' 23:59:00'      
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND PARENTCODE >= @FROMPARTY      
		AND PARENTCODE <= @TOPARTY      
		AND FO.BRANCH_CD LIKE @BRANCH    
		AND FO.TRADER LIKE @TRADER    
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND (CASE WHEN @INTMARGINFLAG = 1 THEN (ISNULL(INITIALMARGIN,0)+ISNULL(MTMMARGIN,0)+ISNULL(ADDMARGIN,0)) ELSE 1 END) > 0 
	  GROUP BY
			PARENTCODE,MARGINDATE,FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE)
	
	  ORDER BY  2,1
END
ELSE
BEGIN
	SELECT
		STRREPROTORDER = CASE 
					WHEN @ORDERBY = 2 
					THEN 
						FO.PARTY_CODE + CONVERT(VARCHAR,MARGINDATE,112)
					ELSE
						CONVERT(VARCHAR,MARGINDATE,112) + FO.PARTY_CODE
					END ,

		INTREPORTORDER2 = CASE WHEN @INTBRANCHWISE = 1 THEN FO.BRANCH_CD ELSE '' END,

		MARGINDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,109),11),BILLDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,103),11),FO.PARTY_CODE,      
		FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,BILLAMOUNT = ISNULL(BILLAMOUNT,0),LEDGERAMOUNT = ISNULL(LEDGERAMOUNT,0),      
		CASH_COLL = ISNULL(CASH_COLL,0),NONCASH_COLL=ISNULL(NONCASH_COLL,0),      
		INITIALMARGIN = ISNULL(INITIALMARGIN,0), MTMMARGIN = ISNULL(MTMMARGIN,0),
		ADDMARGIN = ISNULL(ADDMARGIN,0),
		YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE),
		UNCLEARAMOUNT=0      
	     
	FROM
		TBL_CLIENTMARGIN FO (NOLOCK),
		CLIENT1 , CLIENT2
	WHERE
		MARGINDATE >= @FROMDATE      
		AND MARGINDATE <= @TODATE + ' 23:59:00'      
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND FO.PARTY_CODE >= @FROMPARTY      
		AND FO.PARTY_CODE <= @TOPARTY      
		AND FO.BRANCH_CD LIKE @BRANCH    
		AND FO.TRADER LIKE @TRADER    
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND (CASE WHEN @INTMARGINFLAG = 1 THEN (ISNULL(INITIALMARGIN,0)+ISNULL(MTMMARGIN,0)+ISNULL(ADDMARGIN,0)) ELSE 1 END) > 0 
	  ORDER BY  2,1
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_CombinedRisk_Report
-- --------------------------------------------------

--exec sp_CombinedRisk 'broker','broker','00000','ZZZZZZ','','%',2


CREATE  Proc [dbo].[sp_CombinedRisk_Report]
@statusid varchar(15),    
@statusname varchar(25),    
@fromparty varchar(20),    
@toparty varchar(20),    
@fromdate varchar(11),    
@branch varchar(10),    
@reportType int    
    
As    
  
If @reportType = 1  
  
 Begin  
  
	  Select
		margindate = @fromdate,
		fo.party_code,
		Exchange='NCE',   
		fo.branch_cd,
		fo.sub_broker,
		fo.short_name,
		billamount = isnull(billamount,0),
		ledgeramount = isnull(ledgeramount,0),    
		cash_coll = isnull(cash_coll,0),
		noncash_coll=isnull(noncash_coll,0),    
		initialmargin = isnull(initialmargin,0),
		MTMMargin = IsNull(MTMMargin,0)
	  From 
		NCE.DBO.tbl_clientmargin fo,NCE.DBO.client2 c2, NCE.DBO.client1 c1
	  Where
		fo.party_code >= @fromparty
		And fo.party_code <= @toparty
		And margindate Like @fromdate +'%'
		And fo.branch_cd like @branch
		And fo.Party_Code = c2.party_code
		And C1.cl_code = c2.cl_code	
		AND @STATUSNAME =   
		  (CASE   
		        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
		        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
		        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
		        WHEN @STATUSID = 'AREA' THEN C1.AREA  
		        WHEN @STATUSID = 'REGION' THEN C1.REGION  
		        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
		  ELSE   
		        'BROKER'  
		  END)  

	  UNION ALL

	  Select
		margindate = @fromdate,
		fo.party_code,
		Exchange='MCX',   
		fo.branch_cd,
		fo.sub_broker,
		fo.short_name,
		billamount = isnull(billamount,0),
		ledgeramount = isnull(ledgeramount,0),    
		cash_coll = isnull(cash_coll,0),
		noncash_coll=isnull(noncash_coll,0),    
		initialmargin = isnull(initialmargin,0),
		MTMMargin = IsNull(MTMMargin,0)
	  From 
		MCDX.dbo.tbl_clientmargin fo,MCDX.dbo.client2 c2, MCDX.dbo.client1 c1
	  Where
		fo.party_code >= @fromparty
		And fo.party_code <= @toparty
		And margindate Like @fromdate +'%'
		And fo.branch_cd like @branch
		And fo.Party_Code = c2.party_code
		And C1.cl_code = c2.cl_code	
		AND @STATUSNAME =   
		  (CASE   
		        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
		        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
		        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
		        WHEN @STATUSID = 'AREA' THEN C1.AREA  
		        WHEN @STATUSID = 'REGION' THEN C1.REGION  
		        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
		  ELSE   
		        'BROKER'  
		  END)  
	
  Order By fo.party_code, Exchange
  
 End   
  
If @reportType = 2  
  
 Begin  



	Select
		margindate = @fromdate,
		party_code,
		branch_cd,
		sub_broker,
		Short_Name = min(Short_Name) ,
		billamount = Sum(billamount),
		ledgeramount = Sum(ledgeramount),
		cash_coll = Sum(cash_coll),
		noncash_coll = Sum(noncash_coll),
		initialmargin = Sum(initialmargin),
		MTMMargin = Sum(MTMMargin)
	From
	(
		  Select
			fo.party_code,
			fo.branch_cd,
			fo.sub_broker,
			Min(fo.short_name) Short_Name,
			billamount = Sum(isnull(billamount,0)),
			ledgeramount = Sum(isnull(ledgeramount,0)),    
			cash_coll = Sum(isnull(cash_coll,0)),
			noncash_coll = Sum(isnull(noncash_coll,0)),    
			initialmargin = Sum(isnull(initialmargin,0)),
			MTMMargin = Sum(IsNull(MTMMargin,0))
		  From 
			NCE.DBO.tbl_clientmargin fo,NCE.DBO.client2 c2, NCE.DBO.client1 c1
		  Where
			fo.party_code >= @fromparty
			And fo.party_code <= @toparty
			And margindate Like @fromdate +'%'
			And fo.branch_cd like @branch
			And fo.Party_Code = c2.party_code
			And C1.cl_code = c2.cl_code	
			AND @STATUSNAME =   
			  (CASE   
			        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
			        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
			        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
			        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
			        WHEN @STATUSID = 'AREA' THEN C1.AREA  
			        WHEN @STATUSID = 'REGION' THEN C1.REGION  
			        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
			  ELSE   
			        'BROKER'  
			  END)  
		Group By fo.party_code,fo.branch_cd,fo.sub_broker
	
		Union All
	
		Select
			fo.party_code,
			fo.branch_cd,
			fo.sub_broker,
			Min(fo.short_name) Short_Name,
			billamount = Sum(isnull(billamount,0)),
			ledgeramount = Sum(isnull(ledgeramount,0)),    
			cash_coll = Sum(isnull(cash_coll,0)),
			noncash_coll = Sum(isnull(noncash_coll,0)),    
			initialmargin = Sum(isnull(initialmargin,0)),
			MTMMargin = Sum(IsNull(MTMMargin,0))
		  From 
			MCDX.dbo.tbl_clientmargin fo, MCDX.dbo.client2 c2, MCDX.dbo.client1 c1
		  Where
			fo.party_code >= @fromparty
			And fo.party_code <= @toparty
			And margindate Like @fromdate +'%'
			And fo.branch_cd like @branch
			And fo.Party_Code = c2.party_code
			And C1.cl_code = c2.cl_code	
			AND @STATUSNAME =   
			  (CASE   
			        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
			        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
			        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
			        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
			        WHEN @STATUSID = 'AREA' THEN C1.AREA  
			        WHEN @STATUSID = 'REGION' THEN C1.REGION  
			        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
			  ELSE   
			        'BROKER'  
			  END)  
		Group By fo.party_code,fo.branch_cd,fo.sub_broker

	) ClTable

	Group By Party_code,branch_cd,sub_broker
	Order By Party_code,branch_cd,sub_broker






  
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CONTRACTMASTER_UPD
-- --------------------------------------------------


CREATE PROC [dbo].[SP_CONTRACTMASTER_UPD] 
(
	@UNAME	VARCHAR(50) = ''
)
AS    
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
  
BEGIN TRAN    
    
CREATE TABLE [#FOSCRIP2] (    
 [P_KEY] [INT] NOT NULL IDENTITY ,    
 [INST_TYPE] [VARCHAR] (6)  ,    
 [SYMBOL] [VARCHAR] (12)  ,    
 [SEC_NAME] [VARCHAR] (25)  ,    
 [EXPIRYDATE] [SMALLDATETIME]  ,    
 [STRIKE_PRICE] [MONEY]  ,    
 [OPTION_TYPE] [VARCHAR] (2)  ,    
 [STARTDATE] [SMALLDATETIME]  ,    
 [MATURITYDATE] [SMALLDATETIME]  ,    
 [SERIES] [VARCHAR] (2)  ,    
 [COR_ACT_LEVEL] [INT]  ,    
 [C_REGULAR_LOT] [INT]      
) ON [PRIMARY]    
    
  
IF (SELECT COUNT(1) FROM FOSCRIP_IMP (NOLOCK))=0 AND (SELECT COUNT(1) FROM FOSCRIP_BLK_IMP (NOLOCK)) <> 0  
BEGIN  
 DECLARE        
 @ROWDATA  VARCHAR(2000),  
 @FILEDATA CURSOR,  
 @SQL VARCHAR(2000)  
  
 TRUNCATE TABLE FOSCRIP_BLK_IMP  
   
 SET @FILEDATA = CURSOR FOR  SELECT * FROM  FILE_DATA (NOLOCK) WHERE LEN(TEXTDATA) > 20  
 OPEN @FILEDATA        
   
 FETCH NEXT FROM @FILEDATA INTO @ROWDATA  
 WHILE @@FETCH_STATUS = 0         
 BEGIN        

 SELECT @SQL =  'INSERT INTO FOSCRIP_BLK_IMP VALUES (' + ''''+ REPLACE(''+ @ROWDATA +'','|',''',''') + ''''+')'  
    
 EXEC (@SQL)  
   
 FETCH NEXT FROM @FILEDATA INTO @ROWDATA  
 END        
 CLOSE @FILEDATA        
 DEALLOCATE @FILEDATA  
  
 INSERT INTO FOSCRIP_IMP  
 SELECT COLUMN1,COLUMN2,COLUMN3,COLUMN4,COLUMN5,COLUMN6,COLUMN7,CONVERT(MONEY,COLUMN8),COLUMN9,COLUMN10,COLUMN11,COLUMN12,COLUMN13,  
 CONVERT(MONEY,COLUMN14),COLUMN15,COLUMN16,COLUMN17,COLUMN18,COLUMN19,COLUMN20,COLUMN21,COLUMN22,COLUMN23,COLUMN24,COLUMN25,COLUMN26,  
 COLUMN27,COLUMN28,COLUMN29,COLUMN30,COLUMN31,COLUMN32,COLUMN33,COLUMN34,COLUMN35,COLUMN36,COLUMN37,COLUMN38,COLUMN39,  
 COLUMN40,COLUMN41,COLUMN42,COLUMN43,COLUMN44,COLUMN45,COLUMN46,COLUMN47,COLUMN48,COLUMN49,COLUMN50,COLUMN51,COLUMN52,  
 COLUMN53,COLUMN54,COLUMN55,COLUMN56,COLUMN57,COLUMN58,COLUMN59,COLUMN60,COLUMN61,COLUMN62,COLUMN63,COLUMN64,COLUMN65,  
 COLUMN66,COLUMN67,CONVERT(MONEY,COLUMN68),COLUMN69  
 FROM FOSCRIP_BLK_IMP (NOLOCK)  
END  
  
  
  
INSERT INTO #FOSCRIP2    
SELECT     
 INST_TYPE = CONTRACT_INSTRUMENT_TYPE,    
 SYMBOL,     
 SEC_NAME = STOCK_NAME,    
 EXPIRYDATE = LEFT(EXPIRY_DATE,11) + ' 23:59',    
 STRIKE_PRICE = (CASE WHEN @UNAME = 'AUTO' THEN CASE WHEN STRIKE_PRICE < 1 THEN 0 ELSE STRIKE_PRICE / 10000000 END ELSE CASE WHEN STRIKE_PRICE < 1 THEN 0 ELSE STRIKE_PRICE / 100 END END),    
 OPTION_TYPE = CASE WHEN STRIKE_PRICE < 1 THEN '' ELSE OPTION_TYPE END ,    
 STARTDATE = ISSUE_START_DATE ,    
 MATURITYDATE = LEFT(CONVERT(DATETIME,CONTRACT_MATURITY_DATE),11) +' 23:59' ,    
 SERIES = CASE WHEN SERIES='XX' THEN '0' ELSE  SERIES END,    
 COR_ACT_LEVEL = CORPORATE_ACTION_LEVEL,    
 C_REGULAR_LOT = QUANTITY_MULTIPLIER --MINIMUMLOTQUANTITY    
FROM    
 FOSCRIP_IMP    
WHERE     
-- LEFT(DATEADD(S,CAST(EXPIRYDATE AS INT),'01-01-1980'),11) + ' 23:59' >= GETDATE() AND     
  
 SYMBOL IS NOT NULL  AND SYMBOL <> ''  
AND  CONTRACT_INSTRUMENT_TYPE NOT IN ('UNDCOM')    
    


 
DELETE     
	 FOSCRIP2      
FROM    
 	#FOSCRIP2    
WHERE     
	 FOSCRIP2.INST_TYPE = #FOSCRIP2.INST_TYPE    
	 AND FOSCRIP2.SYMBOL = #FOSCRIP2.SYMBOL    
	 AND LEFT(FOSCRIP2.EXPIRYDATE,11) = LEFT(#FOSCRIP2.EXPIRYDATE,11)    
	 AND FOSCRIP2.STRIKE_PRICE = #FOSCRIP2.STRIKE_PRICE    
	 AND FOSCRIP2.OPTION_TYPE = #FOSCRIP2.OPTION_TYPE    
    
DELETE     
 	FOSCRIP1    
FROM    
	 #FOSCRIP2    
WHERE     
	 FOSCRIP1.INST_TYPE = #FOSCRIP2.INST_TYPE    
	 AND FOSCRIP1.SYMBOL = #FOSCRIP2.SYMBOL    
	 AND LEFT(FOSCRIP1.EXPIRYDATE,11) = LEFT(#FOSCRIP2.EXPIRYDATE,11)    
	 AND FOSCRIP1.STRIKE_PRICE = #FOSCRIP2.STRIKE_PRICE    
	 AND FOSCRIP1.OPTION_TYPE = #FOSCRIP2.OPTION_TYPE    
    
--DECLARE @MAXPKEY INT    
--SELECT @MAXPKEY=ISNULL(MAX(P_KEY),0)    
--FROM FOSCRIP2     
    
INSERT INTO FOSCRIP2    
SELECT     
	 INST_TYPE,    
	 SYMBOL,     
	 SEC_NAME = INST_TYPE + SYMBOL ,    
	 EXPIRYDATE,    
	 STRIKE_PRICE ,    
	 OPTION_TYPE,    
	 STARTDATE ,    
	 MATURITYDATE ,    
	 SERIES = CASE WHEN LEFT(INST_TYPE,3) ='OPT' THEN 'O' ELSE 'S' END  ,    
	 COR_ACT_LEVEL = 0,    
	 C_REGULAR_LOT,    
	 C_ISSUE_MAT_DT = '' ,    
	 C_U_INST_TYPE='',    
	 C_U_SYMBOL='CONT_MST',    
	 C_U_SERIES='',    
	 C_U_EXPIRYDATE='',    
	 C_U_STRIKEPRICE=0,    
	 C_U_OPTION_TYPE='',    
	 C_U_CAL=0,
	 PriceUnit='',
	 PRICENUMERATOR=1,
	 PRICEDENOMINATOR=1,
	 C_REGULAR_LOT,
	 Qty_Unit=1,
	 LOTNUMERATOR=1,
	 LOTDENOMINATOR=1 
FROM     
 	#FOSCRIP2    
    
INSERT INTO FOSCRIP1    
SELECT     
	 INST_TYPE ,    
	 SYMBOL,     
	 EXPIRYDATE,    
	 STRIKE_PRICE,    
	 OPTION_TYPE    
FROM     
 #FOSCRIP2    
    
    
DROP TABLE #FOSCRIP2    
    
UPDATE FOSCRIP2 SET MATURITYDATE = LEFT(MATURITYDATE,11) + ' 23:59'    
WHERE MATURITYDATE <> LEFT(MATURITYDATE,11) + ' 23:59'    

--TRUNCATE TABLE FOSCRIP_IMP

COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_EBA_CLIENTMASTER_UPDATE
-- --------------------------------------------------

CREATE  Procedure [dbo].[SP_EBA_CLIENTMASTER_UPDATE]
(
	@PARTYCODE	VARCHAR	(10),
	@ADDRESS1	VARCHAR	(40),
	@ADDRESS2	VARCHAR	(40),
	@ADDRESS3	VARCHAR	(40),
	@CITY		VARCHAR	(40),
	@STATE		VARCHAR	(50),
	@ZIP		VARCHAR	(10),
	@TELE_OFF1	VARCHAR	(15),
	@TELE_OFF2	VARCHAR	(15),
	@TELE_RES	VARCHAR	(15),
	@FAX		VARCHAR	(15),
	@EMAIL		VARCHAR	(100)
)
AS

DECLARE @strStatus varchar(10),
	@strStatusDesc varchar(100)


Set @strStatus = ''

If (Select Count(1) From MSAJAG..Client_Details where Party_Code =@PARTYCODE) =0 
BEGIN
	Set @strStatus = 'FAIL'	
	Set @strStatusDesc = 'Party ' + @PARTYCODE + ' is not existing'
	Select @strStatus,@strStatusDesc
	return
END

	SET NOCOUNT ON
	
	BEGIN TRAN
	
	Insert Into MSAJAG..Client_Details_Log
	(cl_code,branch_cd,party_code,sub_broker,trader,long_name,short_name,l_address1,l_city,l_address2,l_state,l_address3,l_nation,
	l_zip,pan_gir_no,ward_no,sebi_regn_no,res_phone1,res_phone2,off_phone1,off_phone2,mobile_pager,fax,email,cl_type,
	cl_status,family,region,area,p_address1,p_city,p_address2,p_state,p_address3,p_nation,p_zip,p_phone,addemailid,
	sex,dob,introducer,approver,interactmode,passport_no,passport_issued_at,passport_issued_on,passport_expires_on,
	licence_no,licence_issued_at,licence_issued_on,licence_expires_on,rat_card_no,rat_card_issued_at,rat_card_issued_on,
	votersid_no,votersid_issued_at,votersid_issued_on,it_return_yr,it_return_filed_on,regr_no,regr_at,regr_on,regr_authority,
	client_agreement_on,sett_mode,dealing_with_other_tm,other_ac_no,introducer_id,introducer_relation,repatriat_bank,
	repatriat_bank_ac_no,chk_kyc_form,chk_corporate_deed,chk_bank_certificate,chk_annual_report,chk_networth_cert,
	chk_corp_dtls_recd,Bank_Name,Branch_Name,AC_Type,AC_Num,Depository1,DpId1,CltDpId1,Poa1,Depository2,
	DpId2,CltDpId2,Poa2,Depository3,DpId3,CltDpId3,Poa3,rel_mgr,c_group,sbu,Status,Imp_Status,ModifidedBy,
	ModifidedOn,Bank_id,Mapin_id,UCC_Code,Micr_No,Edit_By,Edit_on,Director_name,Paylocation,FmCode)
	Select
		cl_code,branch_cd,party_code,sub_broker,trader,long_name,short_name,l_address1,l_city,l_address2,
		l_state,l_address3,l_nation,l_zip,pan_gir_no,ward_no,sebi_regn_no,res_phone1,res_phone2,off_phone1,
		off_phone2,mobile_pager,fax,email,cl_type,cl_status,family,region,area,p_address1,p_city,p_address2,
		p_state,p_address3,p_nation,p_zip,p_phone,addemailid,sex,dob,introducer,approver,interactmode,passport_no,
		passport_issued_at,passport_issued_on,passport_expires_on,licence_no,licence_issued_at,licence_issued_on,
		licence_expires_on,rat_card_no,rat_card_issued_at,rat_card_issued_on,votersid_no,votersid_issued_at,
		votersid_issued_on,it_return_yr,it_return_filed_on,regr_no,regr_at,regr_on,regr_authority,client_agreement_on,
		sett_mode,dealing_with_other_tm,other_ac_no,introducer_id,introducer_relation,repatriat_bank,repatriat_bank_ac_no,
		chk_kyc_form,chk_corporate_deed,chk_bank_certificate,chk_annual_report,chk_networth_cert,chk_corp_dtls_recd,
		Bank_Name,Branch_Name,AC_Type,AC_Num,Depository1,DpId1,CltDpId1,Poa1,Depository2,DpId2,CltDpId2,Poa2,Depository3,
		DpId3,CltDpId3,Poa3,rel_mgr,c_group,sbu,Status,Imp_Status,ModifidedBy,ModifidedOn,Bank_id,Mapin_id,UCC_Code,
		Micr_No,'EBA',GetDate(),Director_name,Paylocation,FmCode 
	From MSAJAG..Client_Details 
	Where Party_Code =@PARTYCODE
	
	Update MSAJAG..Client_Details Set
		l_address1 = @ADDRESS1,
		l_address2 = @ADDRESS2,
		l_address3 = @ADDRESS3,
		l_city = @CITY,
		l_state = @STATE,
		l_zip = @ZIP,
		off_phone1 = @TELE_OFF1,
		off_phone2 = @TELE_OFF2,
		res_phone1 = @TELE_RES,
		fax = @FAX,
		email = @EMAIL
	Where Party_Code =@PARTYCODE
	
	if @@ERROR <> 0
	begin    
		Set @strStatus = 'FAIL'	
		Set @strStatusDesc = 'Client updation Party ' + @PartyCode + ' failed at Client Master 1. SQL Error ' + Convert(varchar,@@ERROR)
		rollback transaction    
		Select @strStatus,@strStatusDesc
		return
	end  
	Update NCE..Client1 Set
		l_address1 = @ADDRESS1,
		l_address2 = @ADDRESS2,
		l_address3 = @ADDRESS3,
		l_city = @CITY,
		l_state = @STATE,
		l_zip = @ZIP,
		off_phone1 = @TELE_OFF1,
		off_phone2 = @TELE_OFF2,
		res_phone1 = @TELE_RES,
		fax = @FAX,
		email = @EMAIL
	Where Cl_Code =@PARTYCODE 	
	
	if @@ERROR <> 0
	begin    
		Set @strStatus = 'FAIL'	
		Set @strStatusDesc = 'Client updation Party ' + @PartyCode + ' failed at Client Master 2. SQL Error ' + Convert(varchar,@@ERROR)
		rollback transaction    
		Select @strStatus,@strStatusDesc
		return
	end  
	
	Update MCDX..Client1 Set
		l_address1 = @ADDRESS1,
		l_address2 = @ADDRESS2,
		l_address3 = @ADDRESS3,
		l_city = @CITY,
		l_state = @STATE,
		l_zip = @ZIP,
		off_phone1 = @TELE_OFF1,
		off_phone2 = @TELE_OFF2,
		res_phone1 = @TELE_RES,
		fax = @FAX,
		email = @EMAIL
	Where Cl_Code =@PARTYCODE 
	if @@ERROR <> 0
	begin    
		Set @strStatus = 'FAIL'	
		Set @strStatusDesc = 'Client updation Party ' + @PartyCode + ' failed at Client Master 3. SQL Error ' + Convert(varchar,@@ERROR)
		rollback transaction    
		Select @strStatus,@strStatusDesc
		return	

	End
	
	Update MSAJAG..ClientMaster Set
		l_address1 = @ADDRESS1,
		l_address2 = @ADDRESS2,
		l_address3 = @ADDRESS3,
		l_city = @CITY,
		l_state = @STATE,
		l_zip = @ZIP,
		off_phone1 = @TELE_OFF1,
		off_phone2 = @TELE_OFF2,
		res_phone1 = @TELE_RES,
		fax = @FAX,
		email = @EMAIL
	Where Party_Code =@PARTYCODE 
	if @@ERROR <> 0
	begin    
		Set @strStatus = 'FAIL'	
		Set @strStatusDesc = 'Client updation Party ' + @PartyCode + ' failed at Client Master 3. SQL Error ' + Convert(varchar,@@ERROR)
		rollback transaction    
		Select @strStatus,@strStatusDesc
		return

	end  	
	
	Set @strStatus = 'SUCCESS'
	Set @strStatusDesc = 'Client ' + @PartyCode +  ' updated successfully'
	
	COMMIT TRAN
	
	Select @strStatus,@strStatusDesc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_FoExpMargin_Calc
-- --------------------------------------------------

CREATE Procedure sp_FoExpMargin_Calc 
(
	@Sauda_Date Varchar(11),
	@StatusName Varchar(20)
)
AS


/* ------- Creating Temp Table -----------*/

CREATE TABLE [#NetPosition] 
(
	[Party_Code] [varchar] (10)  ,
	[Inst_Type] [varchar] (6)  ,
	[Symbol] [varchar] (12)  ,
	[YearExpDate] [int]  ,
	[MonthExpDate] [int]  ,
	[Option_Type] [varchar] (2)  ,
	[Strike_Price] [money]  ,
	[NetPosition] [int],
	[Price] [Money],
	[MarginPerc] [Numeric] (9,4),
	[MarginAmt] [Money]
) 

CREATE INDEX [FoBill] ON [dbo].[#NetPosition] 
	(Party_Code,Inst_Type, Symbol, YearExpDate,MonthExpDate, Strike_Price, Option_Type)


/* ------- Fetching Fut Positions -----------*/
Insert Into #NetPosition
Select
	Party_Code,
	Inst_Type,
	Symbol,
	Year(Sauda_Date) as YearExpDate,
	Month(Sauda_Date) as MonthExpDate,
	Option_Type,
	Strike_Price,
	Abs(Sum(SQty-PQty)) As NetPosition ,
	Cl_Rate As Price,
	0 As MarginPerc,
	0 As MarginAmt

From
	FoBillValan
Where 
	Sauda_Date Like @Sauda_Date + '%'
	And Left(Inst_Type,3) = 'FUT'
Group By
	Party_Code,
	Inst_Type,
	Symbol,
	ExpiryDate,
	Option_Type,
	Strike_Price,
	Cl_Rate,
	Year(Sauda_Date),
	Month(Sauda_Date)



/* ------- Fetching Opt  Positions -----------*/
Insert Into #NetPosition
Select
	Party_Code,
	Inst_Type,
	Symbol,
	Year(Sauda_Date) as YearExpDate,
	Month(Sauda_Date) as MonthExpDate,
	Option_Type,
	Strike_Price,
	Abs(Sum(SQty-PQty)) As NetPosition ,
	0 As Price,
	0 As MarginPerc,
	0 As MarginAmt

From
	FoBillValan
Where 
	Sauda_Date Like @Sauda_Date + '%'
	And Left(Inst_Type,3) = 'OPT'
Group By
	Party_Code,
	Inst_Type,
	Symbol,
	ExpiryDate,
	Option_Type,
	Strike_Price,
	Year(Sauda_Date),
	Month(Sauda_Date)

/* ------- Updating UL Closing Rate for Opt Positions -----------*/
Update
	#NetPosition
Set
	Price = Cl_Rate 
From 
	Closing
Where
	Sysdate like @Sauda_Date + '%'
	And Inst_Type like 'OPT%'
	And Symbol = Scrip_Cd

/* ------- Fetching Exposure Margin Percentage for Nifty -----------*/
Update
	#NetPosition
Set
	MarginPerc = Margin_Perc 
From 
	FoMargin_Exp_Perc
Where 
	Margin_Year = YearExpDate
	And Margin_Month = MonthExpDate
	And Margin_Symbol = Symbol

/* ------- Fetching Exposure Margin Percentage for Nifty -----------*/
Update
	#NetPosition
Set
	MarginPerc = Margin_Perc 
From 
	FoMargin_Exp_Perc_Nifty
Where
	@Sauda_Date BetWeen Margin_From And Margin_To
	And Margin_Symbol = Symbol



/*----------- Computing Exposure Marging Amt ------------*/
Update
	#NetPosition
Set
	MarginAmt = NetPosition * Price * MarginPerc  / 100



/*----------- Saving Computed Exposure Marging Amt ------------*/
Insert Into FoMargin_Exp_Det_Log 
Select
	*,@StatusName,GetDate()
From
	FoMargin_Exp_Details
Where
	Sauda_Date Like @Sauda_Date + '%'

Delete FoMargin_Exp_Details Where Sauda_Date Like @Sauda_Date + '%'

Insert Into FoMargin_Exp_Details 
Select
	@Sauda_Date,
	Party_Code,
	Symbol,
	Sum(NetPosition),
	MarginPerc,
	Sum(MarginAmt),
	@StatusName,
	GetDate()
From #NetPosition
Where
	MarginAmt > 0
Group By
	Party_Code,
	Symbol,
	MarginPerc
	

Drop Table #NetPosition

/* --------------------------- E O F -------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_FoSpanMargin_Upd
-- --------------------------------------------------

CREATE Proc sp_FoSpanMargin_Upd (@Sauda_Date varchar(11)) AS

CREATE TABLE [#FoSpanmarginnew] 
(
	[Party_Code] [varchar] (10)  ,
	[Symbol] [varchar] (12),
	[Spanmargin] [money]  ,
	[Premium] [money]  ,
	[Totalmargin] [money]  ,
	[Pmarginrate] [decimal](18, 0)  ,
	[Newspanmargin] [money]  ,
	[FinalTotalMargin] [money]  ,
	[Mtom] [money]  
)

Insert Into #FoSpanmarginnew
Select 
	Party_Code = Acct,
	Symbol = cc,
	SpanMargin = case when (spanreq - anov) > 0 then (spanreq - anov) else 0 end ,
	Premium = 0,
	TotalMargin = 0,
	PmarginRate = 0,
	Newspanmargin = 0,
	TotalMargin= 0,
	MtoM = 0
From 
	SpanMargin_intraday
Where
	node='dReq'


Update 
	#FoSpanmarginnew
Set
	PmarginRate = Client3.pmarginrate
From
	Client3
Where 
	Client3.Party_Code = #FoSpanmarginnew.Party_Code


Update
	#FoSpanmarginnew
Set
	Newspanmargin = SpanMargin + (SpanMargin * PmarginRate /100)



Update
	#FoSpanmarginnew
Set
	Premium = NetPremium
From
	(	
	Select Party_Code,Symbol,NetPremium=Sum(NetPremium)
	From(
	
		Select 
			Party_Code,
			inst_Type,
			symbol,
			option_Type,
			strike_Price,
			NetPremium = Sum(Case When Sell_Buy = 1 
						Then TradeQty * Price
						Else -TradeQty * Price End)
		From
			FoSettlement
		Where
			Sauda_Date Like @Sauda_Date + '%'
			and Inst_type like 'OPT%' 
			and Auctionpart <> 'EA'
			and auctionpart <> 'CA'
			and price<>0
			and reserved1 <> 1
		Group By
			Party_Code,
			inst_Type,
			symbol,
			option_Type,
			strike_Price
		
	) T
	Group By Party_Code,Symbol
	) TrdPos
Where
	TrdPos.Party_Code = #FoSpanmarginnew.Party_Code
	and TrdPos.Symbol = #FoSpanmarginnew.symbol


Update
	#FoSpanmarginnew
Set
	TotalMargin = SpanMargin + Premium,
	FinalTotalMargin = (SpanMargin + Premium) + Newspanmargin


Delete FoMargin_Span Where Mdate Like @Sauda_Date + '%'

Insert Into FoMargin_Span
Select
	Party_Code,
	Symbol,
	Spanmargin,
	Premium,
	Totalmargin,
	Pmarginrate,
	Mdate=@Sauda_Date,
	Newspanmargin,
	FinalTotalMargin,
	Cl_Type='CL'
From
	#FoSpanmarginnew



Insert Into FoMargin_Span
Select
	Party_Code=(Select MemberCode from FoOwner),
	Symbol ='',
	Spanmargin= Sum(Spanmargin),
	Premium = Sum(Premium),
	Totalmargin = Sum(Totalmargin),
	Pmarginrate=0,
	Mdate=@Sauda_Date,
	Newspanmargin=Sum(Newspanmargin),
	FinalTotalMargin=Sum(FinalTotalMargin),
	Cl_Type='TM'
From
	#FoSpanmarginnew

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
CREATE PROC [dbo].[sp_generate_inserts]    
(    
 @table_name varchar(776),    -- The table/view for which the INSERT statements will be generated using the existing data    
 @target_table varchar(776) = NULL,  -- Use this parameter to specify a different table name into which the data will be inserted    
 @include_column_list bit = 1,  -- Use this parameter to include/ommit column list in the generated INSERT statement    
 @from varchar(800) = NULL,   -- Use this parameter to filter the rows based on a filter condition (using WHERE)    
 @include_timestamp bit = 0,   -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement    
 @debug_mode bit = 0,   -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination    
 @owner varchar(64) = NULL,  -- Use this parameter if you are not the owner of the table    
 @ommit_images bit = 0,   -- Use this parameter to generate INSERT statements by omitting the 'image' columns    
 @ommit_identity bit = 0,  -- Use this parameter to ommit the identity columns    
 @top int = NULL,   -- Use this parameter to generate INSERT statements only for the TOP n rows    
 @cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement    
 @cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement    
 @disable_constraints bit = 0,  -- When 1, disables foreign key constraints and enables them after the INSERT statements    
 @ommit_computed_cols bit = 0  -- When 1, computed columns will not be included in the INSERT statement    
     
)    
AS    
BEGIN    
 /*   
NOTE:  This procedure may not work with tables with too many columns.    
  Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types    
  Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results    
  IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed    
  you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts    
  like nchar and nvarchar    
      
    
Example 1: To generate INSERT statements for table 'titles':    
      
  EXEC sp_generate_inserts 'titles'    
    
Example 2:  To ommit the column list in the INSERT statement: (Column list is included by default)    
  IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below,    
  to avoid erroneous results    
      
  EXEC sp_generate_inserts 'titles', @include_column_list = 0    
    
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table:    
    
  EXEC sp_generate_inserts 'titles', 'titlesCopy'    
    
Example 4: To generate INSERT statements for 'titles' table for only those titles     
  which contain the word 'Computer' in them:    
  NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter    
    
  EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'"    
    
Example 5:  To specify that you want to include TIMESTAMP column's data as well in the INSERT statement:    
  (By default TIMESTAMP column's data is not scripted)    
    
  EXEC sp_generate_inserts 'titles', @include_timestamp = 1    
    
Example 6: To print the debug information:    
      
  EXEC sp_generate_inserts 'titles', @debug_mode = 1    
    
Example 7:  If you are not the owner of the table, use @owner parameter to specify the owner name    
  To use this option, you must have SELECT permissions on that table    
    
  EXEC sp_generate_inserts Nickstable, @owner = 'Nick'    
    
Example 8:  To generate INSERT statements for the rest of the columns excluding images    
  When using this otion, DO NOT set @include_column_list parameter to 0.    
    
  EXEC sp_generate_inserts imgtable, @ommit_images = 1    
    
Example 9:  To generate INSERT statements excluding (ommiting) IDENTITY columns:    
  (By default IDENTITY columns are included in the INSERT statement)    
    
  EXEC sp_generate_inserts mytable, @ommit_identity = 1    
    
Example 10:  To generate INSERT statements for the TOP 10 rows in the table:    
      
  EXEC sp_generate_inserts mytable, @top = 10    
    
Example 11:  To generate INSERT statements with only those columns you want:    
      
  EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'"    
    
Example 12:  To generate INSERT statements by omitting certain columns:    
      
  EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'"    
    
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements:    
      
  EXEC sp_generate_inserts titles, @disable_constraints = 1    
    
Example 14:  To exclude computed columns from the INSERT statement:    
  EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1    
***********************************************************************************************************/    
    
SET NOCOUNT ON    
    
--Making sure user only uses either @cols_to_include or @cols_to_exclude    
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL))    
 BEGIN    
  RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1)    
  RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified    
 END    
    
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format    
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0))    
 BEGIN    
  RAISERROR('Invalid use of @cols_to_include property',16,1)    
  PRINT 'Specify column names surrounded by single quotes and separated by commas'    
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"'    
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property    
 END    
    
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0))    
 BEGIN    
  RAISERROR('Invalid use of @cols_to_exclude property',16,1)    
  PRINT 'Specify column names surrounded by single quotes and separated by commas'    
  PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"'    
  RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property    
 END    
    
    
--Checking to see if the database name is specified along wih the table name    
--Your database context should be local to the table for which you want to generate INSERT statements    
--specifying the database name is not allowed    
IF (PARSENAME(@table_name,3)) IS NOT NULL    
 BEGIN    
  RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1)    
  RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed    
 END    
    
--Checking for the existence of 'user table' or 'view'    
--This procedure is not written to work on system tables    
--To script the data in system tables, just create a view on the system tables and script the view instead    
    
IF @owner IS NULL    
 BEGIN    
  IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL))     
   BEGIN    
    RAISERROR('User table or view not found.',16,1)    
    PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.'    
    PRINT 'Make sure you have SELECT permission on that table or view.'    
    RETURN -1 --Failure. Reason: There is no user table or view with this name    
   END    
 END    
ELSE    
 BEGIN    
  IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner)    
   BEGIN    
    RAISERROR('User table or view not found.',16,1)    
    PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.'    
    PRINT 'Make sure you have SELECT permission on that table or view.'    
    RETURN -1 --Failure. Reason: There is no user table or view with this name      
   END    
 END    
    
--Variable declarations    
DECLARE  @Column_ID int,       
  @Column_List varchar(8000),     
  @Column_Name varchar(128),     
  @Start_Insert varchar(786),     
  @Data_Type varchar(128),     
  @Actual_Values varchar(8000), --This is the string that will be finally executed to generate INSERT statements    
  @IDN varchar(128)  --Will contain the IDENTITY column's name in the table    
    
--Variable Initialization    
SET @IDN = ''    
SET @Column_ID = 0    
SET @Column_Name = ''    
SET @Column_List = ''    
SET @Actual_Values = ''    
    
IF @owner IS NULL     
 BEGIN    
  SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'     
 END    
ELSE    
 BEGIN    
  SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']'       
 END    
    
    
--To get the first column's ID    
    
SELECT @Column_ID = MIN(ORDINAL_POSITION)      
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
WHERE  TABLE_NAME = @table_name AND    
(@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
    
--Loop through all the columns of the table, to get the column names and their data types    
WHILE @Column_ID IS NOT NULL    
 BEGIN    
  SELECT  @Column_Name = QUOTENAME(COLUMN_NAME),     
  @Data_Type = DATA_TYPE     
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
  WHERE  ORDINAL_POSITION = @Column_ID AND     
  TABLE_NAME = @table_name AND    
  (@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
    
  IF @cols_to_include IS NOT NULL --Selecting only user specified columns    
  BEGIN    
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0     
   BEGIN    
    GOTO SKIP_LOOP    
   END    
  END    
    
  IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns    
  BEGIN    
   IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0     
   BEGIN    
    GOTO SKIP_LOOP    
   END    
  END    
    
  --Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column    
  IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1     
  BEGIN    
   IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column    
    SET @IDN = @Column_Name    
   ELSE    
    GOTO SKIP_LOOP       
  END    
      
  --Making sure whether to output computed columns or not    
  IF @ommit_computed_cols = 1    
  BEGIN    
   IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1     
   BEGIN    
    GOTO SKIP_LOOP         
   END    
  END    
      
  --Tables with columns of IMAGE data type are not supported for obvious reasons    
  IF(@Data_Type in ('image'))    
   BEGIN    
    IF (@ommit_images = 0)    
     BEGIN    
      RAISERROR('Tables with image columns are not supported.',16,1)    
      PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.'    
      PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.'    
      RETURN -1 --Failure. Reason: There is a column with image data type    
     END    
    ELSE    
     BEGIN    
     GOTO SKIP_LOOP    
     END    
   END    
    
  --Determining the data type of the column and depending on the data type, the VALUES part of    
  --the INSERT statement is generated. Care is taken to handle columns with NULL values. Also    
  --making sure, not to lose any data from flot, real, money, smallmomey, datetime columns    
  SET @Actual_Values = @Actual_Values  +    
  CASE     
   WHEN @Data_Type IN ('char','varchar','nchar','nvarchar')     
    THEN     
     'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('datetime','smalldatetime')     
    THEN     
     'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('uniqueidentifier')     
    THEN      
     'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')'    
   WHEN @Data_Type IN ('text','ntext')     
    THEN      
     'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')'         
   WHEN @Data_Type IN ('binary','varbinary')     
    THEN      
     'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'      
   WHEN @Data_Type IN ('timestamp','rowversion')     
    THEN      
     CASE     
      WHEN @include_timestamp = 0     
       THEN     
        '''DEFAULT'''     
       ELSE     
        'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')'      
     END    
   WHEN @Data_Type IN ('float','real','money','smallmoney')    
    THEN    
     'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ',2)' + ')),''NULL'')'     
   ELSE     
    'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' +  @Column_Name  + ')' + ')),''NULL'')'     
  END   + '+' +  ''',''' + ' + '    
      
  --Generating the column list for the INSERT statement    
  SET @Column_List = @Column_List +  @Column_Name + ','     
    
  SKIP_LOOP: --The label used in GOTO    
    
  SELECT  @Column_ID = MIN(ORDINAL_POSITION)     
  FROM  INFORMATION_SCHEMA.COLUMNS (NOLOCK)     
  WHERE  TABLE_NAME = @table_name AND     
  ORDINAL_POSITION > @Column_ID AND    
  (@owner IS NULL OR TABLE_SCHEMA = @owner)    
    
    
 --Loop ends here!    
 END    
    
--To get rid of the extra characters that got concatenated during the last run through the loop    
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1)    
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6)    
    
IF LTRIM(@Column_List) = ''     
 BEGIN    
  RAISERROR('No columns to select. There should at least be one column to generate the output',16,1)    
  RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter    
 END    
    
--Forming the final string that will be executed, to output the INSERT statements    
IF (@include_column_list <> 0)    
 BEGIN    
  SET @Actual_Values =     
   'SELECT ' +      
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +     
   '''' + RTRIM(@Start_Insert) +     
   ' ''+' + '''(' + RTRIM(@Column_List) +  '''+' + ''')''' +     
   ' +''VALUES(''+ ' +  @Actual_Values  + '+'')''' + ' ' +     
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')    
 END    
ELSE IF (@include_column_list = 0)    
 BEGIN    
  SET @Actual_Values =     
   'SELECT ' +     
   CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END +     
   '''' + RTRIM(@Start_Insert) +     
   ' '' +''VALUES(''+ ' +  @Actual_Values + '+'')''' + ' ' +     
   COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)')    
 END     
    
--Determining whether to ouput any debug information    
IF @debug_mode =1    
 BEGIN    
  PRINT '/*****START OF DEBUG INFORMATION*****'    
  PRINT 'Beginning of the INSERT statement:'    
  PRINT @Start_Insert    
  PRINT ''    
  PRINT 'The column list:'    
  PRINT @Column_List    
  PRINT ''    
  PRINT 'The SELECT statement executed to generate the INSERTs'    
  PRINT @Actual_Values    
  PRINT ''    
  PRINT '*****END OF DEBUG INFORMATION*****/'    
  PRINT ''    
 END    
      
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas'    
PRINT '--Build number: 22'    
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com'    
PRINT '--http://vyaskn.tripod.com'    
PRINT ''    
PRINT 'SET NOCOUNT ON'    
PRINT ''    
    
    
--Determining whether to print IDENTITY_INSERT or not    
IF (@IDN <> '')    
 BEGIN    
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON'    
  PRINT 'GO'    
  PRINT ''    
 END    
    
    
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)    
 BEGIN    
  IF @owner IS NULL    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'    
   END    
  ELSE    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily'    
   END    
    
  PRINT 'GO'    
 END    
    
PRINT ''    
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + ''''    
    
    
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes!    
EXEC (@Actual_Values)    
    
PRINT 'PRINT ''Done'''    
PRINT ''    
    
    
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL)    
 BEGIN    
  IF @owner IS NULL    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL'  AS '--Code to enable the previously disabled constraints'    
   END    
  ELSE    
   BEGIN    
    SELECT  'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints'    
   END    
    
  PRINT 'GO'    
 END    
    
PRINT ''    
IF (@IDN <> '')    
 BEGIN    
  PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF'    
  PRINT 'GO'    
 END    
    
PRINT 'SET NOCOUNT OFF'    
    
    
SET NOCOUNT OFF    
RETURN 0 --Success. We are done!    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GETDATE
-- --------------------------------------------------

CREATE PROCEDURE SP_GETDATE AS 

DECLARE @VOUTPUTDATE DATETIME

SET @VOUTPUTDATE = CAST(YEAR(GETDATE()) AS VARCHAR(4)) + '/' + 
      		   CAST(MONTH(GETDATE()) AS VARCHAR(2)) + '/01'
SET @VOUTPUTDATE = DATEADD(DD, -1, DATEADD(M, 1, @VOUTPUTDATE))

SELECT
	MONTHFIRSTDAY = '01/'+STUFF('00',3-LEN(MONTH(GETDATE())),LEN(MONTH(GETDATE())),MONTH(GETDATE())) + '/'+ CONVERT(VARCHAR,YEAR(GETDATE())), 
	CURRENTDATE = CONVERT(VARCHAR,GETDATE(),103),
	MONTHLASTDAY = CONVERT(VARCHAR,@VOUTPUTDATE,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_GetPositionSpan
-- --------------------------------------------------



CREATE Procedure Sp_GetPositionSpan
  (
	@Sdate varchar(11),  
	@PartyFrom Varchar(10),
	@PartyTo Varchar(10),
	@Mode Varchar(10)

  )
AS  

Declare @intMonth int,
	@intYear int

Select @intMonth=Month(convert(datetime,@Sdate)),@intYear=Year(convert(datetime,@Sdate))

If @PartyTo ='' Begin Set @PartyTo = 'zzzzzz' End

Set Transaction Isolation Level Read Uncommitted

if @Mode ='NORMAL'
Begin
	Select 
		Party_code,
		Inst_type,
		Symbol,
		Expirydate=left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price, 
		Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),
		Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )
	From
		Fosettlement 
	Where 
		Reserved1 <> 1
		And Expirydate > @sdate + ' 23:59'  
		And Sauda_date <= @sdate + ' 23:59'  
		And Party_Code BetWeen @PartyFrom and @PartyTo
	group by 
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
	Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0  
	Order By
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
End
Else if @Mode ='3DAYS1'
Begin
	Select 
		Party_code,
		Inst_type,
		Symbol,
		Expirydate=left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price, 
		Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),
		Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )
	From
		Fosettlement 
	Where 
		Reserved1 <> 1
		And Expirydate > @sdate + ' 23:59'  
		And Sauda_date <= @sdate + ' 23:59'  
		And Party_Code BetWeen @PartyFrom and @PartyTo
		And Month(expirydate) = @intMonth
		And Year(expirydate) = @intYear
	Group by 
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
	Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0  
	Order By
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
End
Else if @Mode ='3DAYS2'
Begin
	Select 
		Party_code,
		Inst_type,
		Symbol,
		Expirydate=left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price, 
		Pqty = Sum( case when sell_buy = 1 then tradeqty else 0 end ),
		Sqty = Sum( case when sell_buy = 2 then tradeqty else 0 end )
	From
		Fosettlement 
	Where 
		Reserved1 <> 1
		And Expirydate > @sdate + ' 23:59'  
		And Sauda_date <= @sdate + ' 23:59'  
		And Party_Code BetWeen @PartyFrom and @PartyTo
		And 
		(
			Month(expirydate) > @intMonth
			OR
			Year(expirydate) > @intYear
		)
	Group by 
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
	Having Sum( case when sell_buy = 1 then tradeqty else 0 end ) - Sum( case when sell_buy = 2 then tradeqty else 0 end ) <> 0  
	Order By
		Party_code,
		Inst_type,
		Symbol,
		left(convert(varchar,expirydate,106),11),
		Option_type,
		Strike_price
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS
-- --------------------------------------------------


CREATE PROC SP_MENU_RIGHTS 
(
	@NOPT INT, 
	@VALIDDATE VARCHAR(20)='',
	@NALERT INT=0
)
as 

CREATE TABLE #VERSION
(
	 ERRCODE1 VARCHAR(100),  
	 ERRCODE2 VARCHAR(20),  
	 ERRCODE3 VARCHAR(2),  
	 ERRCODE4 VARCHAR(10),  
	 ERRCODE5 VARCHAR(10),  
	 ERRCODE6 VARCHAR(100),  
	 ERRCODE7 VARCHAR(100),  
	 ERRCODE8 VARCHAR(100),  
	 ERRCODE9 VARCHAR(100),  
	 ERRCODE10 VARCHAR(10),  
	 ERRCODE11 VARCHAR(100), 
	 ERRCODE12 VARCHAR(100),
	 ERRCODE13 VARCHAR(100),  
	 ERRCODE14 VARCHAR(100)  
)

INSERT INTO #VERSION EXEC CHECKVERSION

IF @NOPT =1
BEGIN
	SELECT ERRCODE2,ERRCODE3 FROM #VERSION
END
ELSE
BEGIN

	SELECT CASE
		WHEN DATEDIFF(D,GETDATE(),@VALIDDATE)- @NALERT < 0
		THEN ERRCODE7 + ' ' + @VALIDDATE
		WHEN  CONVERT(VARCHAR,GETDATE(),112) >= CONVERT(VARCHAR,CONVERT(DATETIME,@VALIDDATE,112),112)
		THEN ERRCODE6
		ELSE ''	
	END AS USERMSG
	FROM #VERSION	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_MtomCheck
-- --------------------------------------------------

CREATE  PROC [DBO].[SP_MTOMCHECK] (@SAUDA_DATE VARCHAR(11)) AS  
  
DECLARE @EXALLOCAMT NUMERIC (18,4)  
DECLARE @PREMIUM NUMERIC (18,4)  
DECLARE @MTM NUMERIC (18,4)  
DECLARE @ERRFLAG INT,
@CNTFLAG INT
  
SET NOCOUNT OFF  
  
SET @ERRFLAG = 0
SET @CNTFLAG = 0  
SELECT   
 @EXALLOCAMT = ABS(ISNULL(SUM(ISNULL(FOEA_EXERCISED_ASSIGNED_VALUE,0)),0)),  
 @PREMIUM = ABS(ISNULL(SUM(ISNULL(FOEA_NETPREMIUM,0)),0)),  
 @MTM = ABS(ISNULL(SUM(ISNULL(FOEA_DAILY_MTM_SETTLEMENT_VALUE,0)+ISNULL(FOEA_FUTURES_FINAL_SETTLEMENT_VALUE,0)),0)),
 @CNTFLAG = ISNULL(COUNT(1),0)
FROM   
 FOEXERCISEALLOCATION (NOLOCK)  
WHERE   
 FOEA_POSITION_DATE LIKE @SAUDA_DATE  + '%'  
  
IF @CNTFLAG = 0   
BEGIN  
 SELECT 'ERROR','POSITION FILE IS NOT IMPORTED. PLEASE CHECK.'  
 SET @ERRFLAG = 1  
END  
  
IF @MTM <> 0   
BEGIN  
 IF NOT EXISTS (SELECT * FROM FOACCBILL WHERE BILLDATE LIKE @SAUDA_DATE + '%'  
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT  
        WHERE ACNAME = 'CLEARING HOUSE')    
     AND BRANCHCD = 'ZZZ'   
     AND ABS(AMOUNT) = @MTM)  
 BEGIN  
  SELECT 'ERROR','MTOM IS NOT MATCHING. PLEASE CHECK.'  
  SET @ERRFLAG = 1  
 END  
END  
  
IF @PREMIUM  <> 0  
BEGIN  
 IF NOT EXISTS (SELECT * FROM FOACCBILL WHERE BILLDATE LIKE @SAUDA_DATE + '%'  
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT  
        WHERE ACNAME = 'CLEARING PREMIUM ACCOUNT')    
     AND BRANCHCD = 'ZZZ'   
     AND ABS(AMOUNT) = @PREMIUM)  
 BEGIN  
  SELECT 'ERROR','PREMIUM IS NOT MATCHING. PLEASE CHECK.'  
  SET @ERRFLAG = 1  
 END  
END  
  
IF @EXALLOCAMT <>0  
BEGIN  
 IF NOT EXISTS (SELECT * FROM FOACCBILL WHERE BILLDATE LIKE @SAUDA_DATE + '%'  
     AND PARTY_CODE = (SELECT ACCODE FROM VALANACCOUNT  
        WHERE ACNAME = 'OPTION EXERCISE')    
     AND BRANCHCD = 'ZZZ'   
     AND ABS(AMOUNT) = @EXALLOCAMT)  
 BEGIN  
  SELECT 'ERROR','EXCECISE ALLOCATION IS NOT MATCHING. PLEASE CHECK.'  
  SET @ERRFLAG = 1  
 END  
END   
IF @ERRFLAG = 0  
BEGIN  
 SELECT 'SUCCESS',''  
END  
  
SET NOCOUNT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_STAMP_DUTY_FILE_UPLOAD
-- --------------------------------------------------

CReate PROCEDURE [dbo].[SP_STAMP_DUTY_FILE_UPLOAD]
( 
 @PARM VARCHAR(MAX) ,
 @PROGID VARCHAR(50)
)
 AS 
 BEGIN   
  		EXEC (@PARM) 
		SELECT '1' 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_StampDutyDetails
-- --------------------------------------------------
CREATE  Procedure sp_StampDutyDetails 
(
	@fromdate varchar(11),
	@todate varchar(11),
	@lstClType varchar(10) 
) as
    
    
Select  FoSettlement.party_code,   
	left(convert(varchar,sauda_date,101),11) sauda_date,    
	Amount = isnull(round(sum((tradeqty*price*BookType)/Instrument),2),0),
	Stampduty = sum(Broker_chrg),
	Dt=Day(FoSettlement.Sauda_Date),    
	Mt=Month(FoSettlement.Sauda_Date),    
	Yr=Year(FoSettlement.Sauda_Date)    
from     
	FoSettlement 
where     
	FoSettlement.Sauda_Date Between @fromdate and  @todate + ' 23:59:59'    
	--And AuctionPart not in ('CA')  
	
group by     
	 left(convert(varchar,sauda_date,101),11) ,    
	 Day(FoSettlement.Sauda_Date),Month(FoSettlement.Sauda_Date),Year(FoSettlement.Sauda_Date),FoSettlement.party_code    
order by    
	 left(convert(varchar,sauda_date,101),11),Yr,Mt,Dt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_StampDutyDetails_OLD
-- --------------------------------------------------
CREATE  Procedure sp_StampDutyDetails_OLD 
(
	@fromdate varchar(11),
	@todate varchar(11),
	@lstClType varchar(10) 
) as
    
    
Select     
	left(convert(varchar,sauda_date,101),11) sauda_date,    
	Amount = isnull(round(sum((tradeqty*price*BookType)/Instrument),2),0),
	Stampduty = CEILING(sum((tradeqty*price*BookType)/Instrument * cast(isnull(Broker_note,1) as money) / isnull(Unit,100000) )),
	Dt=Day(FoSettlement.Sauda_Date),    
	Mt=Month(FoSettlement.Sauda_Date),    
	Yr=Year(FoSettlement.Sauda_Date)    
from     
	FoSettlement left outer join FoTaxes     
	on (FoSettlement.Sauda_Date Between FoTaxes.From_Date and FoTaxes.To_Date  And FoTaxes.Symbol=''),
	Client1, Client2
where     
	FoSettlement.Sauda_Date Between @fromdate and  @todate + ' 23:59:59'    
	And Client1.Cl_Code = Client2.Cl_Code and Client2.Party_Code = FoSettlement.Party_Code
	And AuctionPart not in ('CA')  
	And Cl_Type like 
		CASE 
		WHEN @lstClType <>'All' 
		THEN @lstClType 
		ELSE '%' End
group by     
	 left(convert(varchar,sauda_date,101),11) ,    
	 Day(FoSettlement.Sauda_Date),Month(FoSettlement.Sauda_Date),Year(FoSettlement.Sauda_Date)    
order by    
	 left(convert(varchar,sauda_date,101),11),Yr,Mt,Dt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_STT_ANNEXURE_CUM
-- --------------------------------------------------



CREATE PROC SP_STT_ANNEXURE_CUM  
 (  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @PARTYFROM VARCHAR(10),  
 @PARTYTO VARCHAR(10),  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @STRBRANCH VARCHAR(12),  
 @STRBRANCHTO VARCHAR(12),  
 @STRSUBBROKFROM VARCHAR(12),  
 @STRSUBBROKTO VARCHAR(12),  
 @DIGIFLAG INT = 0   
 )  
    
 AS  
                 
 IF LEN(LTRIM(RTRIM(@PARTYTO))) = 0  
 BEGIN  
  SET @PARTYTO = 'ZZZZZZZZZ'  
 END  
   
 IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''  
 BEGIN  
  SET @STRBRANCHTO = 'ZZZZZZZZZZZZZZ'  
 END  
   
 IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''  
 BEGIN  
  SET @STRSUBBROKTO = 'ZZZZZZZZZZZ'  
 END  
   
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
          
SELECT PARTY_CODE,  TRANSACTIONCODE = '04', TURNOVER = SUM(TURNOVER), STT = SUM(STT)            
INTO #STT04 FROM         
(      
 SELECT SAUDA_DATE =LEFT(SAUDA_DATE,11), PARTY_CODE, TURNOVER = SUM(SAMTTRD), STT = ROUND(SUM(SSTTTRD),0)      
 FROM STT_CLIENTDETAIL   (NOLOCK)      
 WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'         
 AND  LEFT(INST_TYPE,3) = 'OPT'      
 GROUP BY LEFT(SAUDA_DATE,11),PARTY_CODE      
) STTDETAIL      
GROUP BY PARTY_CODE ORDER BY PARTY_CODE              
      
SELECT PARTY_CODE,  TRANSACTIONCODE = '05', TURNOVER = SUM(TURNOVER), STT = SUM(STT)            
INTO #STT05 FROM         
(      
 SELECT SAUDA_DATE =LEFT(SAUDA_DATE,11),PARTY_CODE,    
 TURNOVER = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SAMTTRD ELSE 0 END),   
 STT = ROUND(ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0)  
   - (ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0)  
   +  ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN SSTTTRD ELSE 0 END),0)  
   - ROUND(SUM(SSTTTRD),2)),0)  
 FROM STT_CLIENTDETAIL  (NOLOCK)      
 WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'         
 GROUP BY LEFT(SAUDA_DATE,11),PARTY_CODE      
 HAVING ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0) > 0  
) STTDETAIL      
GROUP BY PARTY_CODE   
ORDER BY PARTY_CODE  
  
  
SELECT             
 COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, 'NATIONAL STOCK EXCHANGE OF INDIA LIMITED' EXCHANGECODE,             
 MEMBERCODE,C2.PARTY_CODE, LONG_NAME,            
 L_ADDRESS1,            
 L_ADDRESS2,           
 L_ADDRESS3,           
 L_CITY ,     
 L_ZIP,         
 PAN_GIR_NO,' ' MAPIDID            
INTO   
 #CLIENT            
FROM             
 CLIENT1 C1 (NOLOCK),  
 CLIENT2 C2 (NOLOCK),  
 FOOWNER (NOLOCK),  
 CLIENT_PRINT_SETTINGS CP (NOLOCK)            
WHERE             
 C1.CL_CODE =C2.CL_CODE AND             
 PARTY_CODE >= @PARTYFROM AND PARTY_CODE <= @PARTYTO  AND                 
 BRANCH_CD >= @STRBRANCH AND  BRANCH_CD <= @STRBRANCHTO  AND                 
 SUB_BROKER >= @STRSUBBROKFROM  AND SUB_BROKER <= @STRSUBBROKTO AND                       
 C2.PRINTF = CP.PRINT_FLAG AND  
 CP.VALID_REPORT LIKE (CASE   
    WHEN @DIGIFLAG = 0 THEN '%'   
    WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
    WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
    ELSE CP.VALID_REPORT   
    END) AND  
 BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END) AND                 
 SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END) AND                 
 TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END) AND                 
 C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)  AND                 
 C1.CL_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)                
          
CREATE INDEX [PARTYCD] ON [DBO].[#CLIENT] ([PARTY_CODE])      
      
SELECT PARTY_CODE,'01' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT01  FROM #CLIENT       
SELECT PARTY_CODE,'02' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT02  FROM #CLIENT              
SELECT PARTY_CODE,'03' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT03  FROM #CLIENT   
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT04] ([PARTY_CODE])      
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT05] ([PARTY_CODE])      
     
INSERT INTO #STT04 SELECT PARTY_CODE,'04',0,0 FROM #CLIENT WHERE PARTY_CODE               
NOT IN (SELECT PARTY_CODE FROM #STT04)              
              
INSERT INTO #STT05 SELECT PARTY_CODE,'05',0,0 FROM #CLIENT WHERE PARTY_CODE               
NOT IN (SELECT PARTY_CODE FROM #STT05)              
          
SELECT S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT                 
INTO #STT00              
       
FROM              
              
(               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER, STT  FROM #STT01                  
  UNION              
  SELECT PARTY_CODE,TRANSACTIONCODE,TURNOVER, STT   FROM #STT02              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT03              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT04              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT05              
              
) S              
              
ORDER BY S.PARTY_CODE,TRANSACTIONCODE              
          
DROP TABLE #STT01      
DROP TABLE #STT02      
DROP TABLE #STT03      
DROP TABLE #STT04      
DROP TABLE #STT05      
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT00] ([PARTY_CODE])      
      
SELECT COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, EXCHANGECODE,             
 MEMBERCODE,LONG_NAME, L_ADDRESS1,L_ADDRESS2,L_ADDRESS3, L_CITY,L_ZIP,PAN_GIR_NO, ISNULL(U.MAPIDID, '') MAPINID,             
 S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT, CONVERT(VARCHAR, GETDATE(), 103) CURDATE              
FROM  #CLIENT C  , #STT00 S LEFT OUTER JOIN UCC_CLIENT U ON (U.PARTY_CODE = S.PARTY_CODE)            
WHERE S.PARTY_CODE = C.PARTY_CODE              
AND S.PARTY_CODE IN ( SELECT PARTY_CODE FROM #STT00 GROUP BY PARTY_CODE HAVING SUM(STT) > 0)          
      
DROP TABLE #STT00

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spCustomTable2HTML
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[spCustomTable2HTML] (      
@TABLENAME  NVARCHAR(MAX),      
@OUTPUT   NVARCHAR(MAX) OUTPUT,      
@TBL_STYLE NVARCHAR(1024) = '',      
@HDR_STYLE NVARCHAR(1024) = '')      
AS      
      
      
-- Author:  Ian Atkin (ian.atkin@ict.ox.ac.uk)      
      
-- Description       
--    Stored Procedure to take an arbitraty temporary table and return       
--    the equivalent HTML string .      
      
-- Version History      
--   1.0 - Initial Release For Symantec Connect (Sept 2011)      
      
      
      
-- @exec_str stores the dynamic SQL Query      
-- @ParmDefinition stores the parameter definition for the dynamic SQL      
DECLARE @exec_str  NVARCHAR(MAX)      
DECLARE @ParmDefinition NVARCHAR(500)      
      
      
--We need to use Dynamic SQL at this point so we can expand the input table name parameter      
SET @exec_str= N'      
DECLARE @exec_str  NVARCHAR(MAX)      
DECLARE @ParmDefinition NVARCHAR(500)      
      
--Make a copy of the original table adding an indexing columnWe need to add an index column to the table to facilitate sorting so we can maintain the      
--original table order as we iterate through adding HTML tags to the table fields.      
--New column called CustColHTML_ID (unlikely to be used by someone else!)      
--      
      
select CustColHTML_ID=0,* INTO #CustomTable2HTML FROM (' + @TABLENAME + ') A       
      
--Now alter the table to add the auto-incrementing index. This will facilitate row finding      
DECLARE @COUNTER INT      
SET @COUNTER=0      
UPDATE #CustomTable2HTML SET @COUNTER = CustColHTML_ID=@COUNTER+1       
      
-- @HTMLROWS will store all the rows in HTML format      
-- @ROW will store each HTML row as fields on each row are iterated through       
-- using dymamic SQL and a cursor      
-- @FIELDS will store the header row for the HTML Table      
      
DECLARE @HTMLROWS NVARCHAR(MAX) DECLARE @FIELDS NVARCHAR(MAX)       
SET @HTMLROWS='''' DECLARE @ROW NVARCHAR(MAX)       
      
-- Create the first HTML row for the table (the table header). Ignore our indexing column!      
SET @FIELDS=''<tr ' + @HDR_STYLE + '>''      
SELECT @FIELDS=COALESCE(@FIELDS, '' '','''')+''<td>'' + name + ''</td>''      
FROM tempdb.sys.Columns      
WHERE object_id=object_id(''tempdb..#CustomTable2HTML'')      
AND name not like ''CustColHTML_ID''      
SET @FIELDS=@FIELDS + ''</tr>''      
      
-- @ColumnName stores the column name as found by the table cursor      
-- @maxrows is a count of the rows in the table, and @rownum is for marking the      
-- ''current'' row whilst processing      
      
DECLARE @ColumnName  NVARCHAR(500)      
DECLARE @maxrows INT      
DECLARE @rownum INT      
      
--Find row count of our temporary table      
SELECT @maxrows=count(*) FROM  #CustomTable2HTML      
      
      
--Create a cursor which will look through all the column names specified in the temporary table      
--but exclude the index column we added (CustColHTML_ID)      
DECLARE col CURSOR FOR      
SELECT name FROM tempdb.sys.Columns      
WHERE object_id=object_id(''tempdb..#CustomTable2HTML'')      
AND name not like ''CustColHTML_ID''      
ORDER BY column_id ASC      
      
--For each row, generate dymanic SQL which requests the each column name in turn by       
--iterating through a cursor      
SET @rowNum=0      
SET @ParmDefinition=N''@ROWOUT NVARCHAR(MAX) OUTPUT,@rowNum_IN INT''      
      
While @rowNum < @maxrows      
BEGIN      
  SET @HTMLROWS=@HTMLROWS + ''<tr>''      
      
  SET @rowNum=@rowNum +1      
  OPEN col      
  FETCH NEXT FROM col INTO @ColumnName      
  WHILE @@FETCH_STATUS=0      
    BEGIN      
      --Get nth row from table      
      --SET @exec_str=''SELECT @ROWOUT=(select top 1 ['' + @ColumnName + ''] from (select top '' + cast(@rownum as varchar) + '' * from #CustomTable2HTML order by CustColHTML_ID ASC) xxx order by CustColHTML_ID DESC)''      
      SET @exec_str=''SELECT @ROWOUT=(select ['' + @ColumnName + ''] from #CustomTable2HTML where CustColHTML_ID=@rowNum_IN)''      
      
   EXEC sp_executesql       
   @exec_str,      
   @ParmDefinition,      
   @ROWOUT=@ROW OUTPUT,      
            @rowNum_IN=@rownum      
      
      SET @HTMLROWS =@HTMLROWS +  ''<td>'' + @ROW + ''</td>''      
      FETCH NEXT FROM col INTO @ColumnName      
    END      
  CLOSE col      
  SET @HTMLROWS=@HTMLROWS + ''</tr>''      
END      
      
SET @OUTPUT=''''      
IF @maxrows>0      
SET @OUTPUT= ''<table ' + @TBL_STYLE + '>'' + @FIELDS + @HTMLROWS + ''</table>''      
      
DEALLOCATE col      
'      
      
DECLARE @ParamDefinition nvarchar(max)      
SET @ParamDefinition=N'@OUTPUT NVARCHAR(MAX) OUTPUT'      
      
--PRINT @exec_str      
--Execute Dynamic SQL. HTML table is stored in @OUTPUT which is passed back up (as it's      
--a parameter to this SP)      
EXEC sp_executesql @exec_str,      
@ParamDefinition,      
@OUTPUT=@OUTPUT OUTPUT      
      
RETURN 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPTURNOVERANALYSISREPORT
-- --------------------------------------------------


/*  
-------------------------------------------------------------------------------------------------------------------------  
              SEBI AUDIT REPORTS   
-------------------------------------------------------------------------------------------------------------------------  
1. LIST OF ALL MEMBERS TRADED DURING THE MONTH "NOVEMBER 2007"  
SL NO.    MEMBER CODE          MEMBER NAME      TOTAL TURNOVER (BUY VALUE + SELL VALUE)     PERCENTAGE OF TOTAL TURNOVER  
  
  
2. LIST OF TOP 10 MEMBERS TRADED DURING THE MONTH "NOVEMBER 2007"  
SL NO.    MEMBER CODE          MEMBER NAME      TOTAL TURNOVER (BUY VALUE + SELL VALUE)     PERCENTAGE OF TOTAL TURNOVER  
  
  
3. LIST OF ALL SCRIPS TRADED DURING THE MONTH "NOVEMBER 2007"  
SL NO.    SCRIP CODE     SCRIP NAME     TURNOVER (BUY VALUE + SELL VALUE)      PERCENTAGE TO TOTAL TURNOVER  
  
  
4. LIST OF TOP 10 SCRIPS TRADED DURING THE MONTH "NOVEMBER 2007"  
SL NO.    SCRIP CODE     SCRIP NAME     TURNOVER (BUY VALUE + SELL VALUE)      PERCENTAGE TO TOTAL TURNOVER  
  
 TURNOVER ANYAIS REPORT  
1. LIST OF ALL MEMBERS     
2. TOP 10 MEMBERS  
3. LIST OF ALL SRIPS  
4. TOP 10 SCRIPTS  
  
FROM DATE  
TO DATE  
  
*/  
  
CREATE PROCEDURE [dbo].[SPTURNOVERANALYSISREPORT]  
(  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @REPORTOPTION INT  
) AS  
BEGIN  
  
 SET NOCOUNT ON  
  
 DECLARE @TOTALTURNOVER NUMERIC(24,2)  
  
 DECLARE @TURNOVERANALYSIS  TABLE(  
  PARTYCODE VARCHAR(10) DEFAULT(''),  
  PARTYNAME VARCHAR(100) DEFAULT(''),  
  SCRIPCODE VARCHAR(10) DEFAULT(''),  
  SCRIPNAME VARCHAR(50) DEFAULT(''),  
  TURNOVERBUY NUMERIC(24,2) DEFAULT(0),  
  TURNOVERSELL NUMERIC(24,2) DEFAULT(0),  
  TURNOVERTOTAL NUMERIC(24,2) DEFAULT(0),  
  TURNOVERPERCENTAGE NUMERIC(24,4) DEFAULT(0)  
 )  
  
 DECLARE @TURNOVERANALYSIS_1  TABLE(  
  PARTYCODE VARCHAR(10) DEFAULT(''),  
  PARTYNAME VARCHAR(100) DEFAULT(''),  
  SCRIPCODE VARCHAR(10) DEFAULT(''),  
  SCRIPNAME VARCHAR(50) DEFAULT(''),  
  TURNOVERBUY NUMERIC(24,2) DEFAULT(0),  
  TURNOVERSELL NUMERIC(24,2) DEFAULT(0),  
  TURNOVERTOTAL NUMERIC(24,2) DEFAULT(0),  
  TURNOVERPERCENTAGE NUMERIC(24,4) DEFAULT(0)  
 )  
  

 IF @REPORTOPTION = 1 OR @REPORTOPTION = 2  
 BEGIN  
  INSERT INTO @TURNOVERANALYSIS_1  
  (  
   PARTYCODE,  
   TURNOVERBUY,  
   TURNOVERSELL,  
   TURNOVERTOTAL  
  )  
   
  SELECT PARTYCODE = S.PARTY_CODE,  
      TURNOVERBUY = SUM(CASE WHEN S.SELL_BUY = 1 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
      TURNOVERSELL = SUM(CASE WHEN S.SELL_BUY = 2 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
      TURNOVERTOTAL = SUM(TRADEQTY * PRICE)  
  FROM FOSETTLEMENT S (NOLOCK)  
  WHERE      
	S.SAUDA_DATE >= @FROMDATE                          
	AND S.SAUDA_DATE <= @TODATE + ' 23:59'                          
	AND AUCTIONPART <> 'CA'
  GROUP BY S.PARTY_CODE  
   

  IF (SELECT COUNT(1) from pradnya..DataIn_History_FoSettlement_NCDX (nolock)    
	Where Sauda_Date BETWEEN @FROMDATE + '%' AND @FROMDATE + ' 23:59') > 0
	BEGIN
		  INSERT INTO @TURNOVERANALYSIS_1  
		  (  
		   PARTYCODE,  
		   TURNOVERBUY,  
		   TURNOVERSELL,  
		   TURNOVERTOTAL  
		  )  
		   
		  SELECT PARTYCODE = S.PARTY_CODE,  
		      TURNOVERBUY = SUM(CASE WHEN S.SELL_BUY = 1 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
		      TURNOVERSELL = SUM(CASE WHEN S.SELL_BUY = 2 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
		      TURNOVERTOTAL = SUM(TRADEQTY * PRICE)  
		  FROM PRADNYA.DBO.HISTORY_FOSETTLEMENT_NCDX S (NOLOCK)  
		  WHERE      
		      S.SAUDA_DATE >= @FROMDATE                          
		    AND S.SAUDA_DATE <= @TODATE + ' 23:59'                          
		    AND AUCTIONPART <> 'CA'
		  GROUP BY S.PARTY_CODE  
	END


	INSERT INTO @TURNOVERANALYSIS
	  (  
	   PARTYCODE,  
	   TURNOVERBUY,  
	   TURNOVERSELL,  
	   TURNOVERTOTAL  
	  ) 
	SELECT    
	   PARTYCODE,  
	   TURNOVERBUY = SUM(TURNOVERBUY),  
	   TURNOVERSELL = SUM(TURNOVERSELL),  
	   TURNOVERTOTAL = SUM(TURNOVERTOTAL)
	FROM @TURNOVERANALYSIS_1
	GROUP BY PARTYCODE
	


  --- UPDATE PARTY NAME  
  UPDATE @TURNOVERANALYSIS SET PARTYNAME = C1.LONG_NAME FROM @TURNOVERANALYSIS T, CLIENT1 C1, CLIENT2 C2  
   WHERE T.PARTYCODE = C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE  
  
  ---- TOTAL TURNOVER  
  SELECT @TOTALTURNOVER = SUM(TURNOVERTOTAL) FROM @TURNOVERANALYSIS  
   
  --- UPDATE INDIVIDUAL PARTY TURN OVER PERCENTAGE  
  UPDATE @TURNOVERANALYSIS SET TURNOVERPERCENTAGE = CONVERT(NUMERIC(24,4), ((TURNOVERTOTAL/@TOTALTURNOVER)*100.0000) )  
  
  SET  NOCOUNT OFF  
  
  IF @REPORTOPTION = 1  
   SELECT   
    [MEMBER CODE] = PARTYCODE,  
    [MEMBER NAME] = PARTYNAME,  
    [TURNOVER BUY] = TURNOVERBUY,  
    [TURNOVER SELL] = TURNOVERSELL,  
    [TOTAL TURNOVER] = TURNOVERTOTAL,  
    [TURNOVER PERCENTAGE] = TURNOVERPERCENTAGE  
    FROM @TURNOVERANALYSIS  
    ORDER BY PARTYNAME  
  ELSE IF @REPORTOPTION = 2  
   SELECT TOP 25   
    [MEMBER CODE] = PARTYCODE,  
    [MEMBER NAME] = PARTYNAME,  
    [TURNOVER BUY] = TURNOVERBUY,  
    [TURNOVER SELL] = TURNOVERSELL,  
    [TOTAL TURNOVER] = TURNOVERTOTAL,  
    [TURNOVER PERCENTAGE] = TURNOVERPERCENTAGE  
    FROM @TURNOVERANALYSIS   
    ORDER BY TURNOVERPERCENTAGE DESC  
  
 END    --- IF @REPORTOPTION = 1 OR @REPORTOPTION = 2  
 IF @REPORTOPTION = 3 OR @REPORTOPTION = 4  
 BEGIN  
  INSERT INTO @TURNOVERANALYSIS_1  
  (  
   SCRIPCODE,  
   TURNOVERBUY,  
   TURNOVERSELL,  
   TURNOVERTOTAL  
  )  
   
  SELECT SCRIPCODE = S.SYMBOL,  
      TURNOVERBUY = SUM(CASE WHEN S.SELL_BUY = 1 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
      TURNOVERSELL = SUM(CASE WHEN S.SELL_BUY = 2 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
      TURNOVERTOTAL = SUM(TRADEQTY * PRICE)  
  FROM FOSETTLEMENT S (NOLOCK)  
  WHERE      
	S.SAUDA_DATE >= @FROMDATE                          
	AND S.SAUDA_DATE <= @TODATE + ' 23:59'                          
	AND AUCTIONPART <> 'CA'
  GROUP BY S.SYMBOL  
   

  IF (SELECT COUNT(1) from pradnya..DataIn_History_FoSettlement_NCDX (nolock)    
	Where Sauda_Date BETWEEN @FROMDATE + '%' AND @FROMDATE + ' 23:59') > 0
	BEGIN
		  INSERT INTO @TURNOVERANALYSIS_1  
		  (  
		   SCRIPCODE,  
		   TURNOVERBUY,  
		   TURNOVERSELL,  
		   TURNOVERTOTAL  
		  )  
		   
		  SELECT SYMBOL = S.SYMBOL,  
		      TURNOVERBUY = SUM(CASE WHEN S.SELL_BUY = 1 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
		      TURNOVERSELL = SUM(CASE WHEN S.SELL_BUY = 2 THEN (S.TRADEQTY * S.PRICE*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
		      TURNOVERTOTAL = SUM(TRADEQTY * PRICE)  
		  FROM PRADNYA.DBO.HISTORY_FOSETTLEMENT_NCDX S (NOLOCK)  
		  WHERE      
		      S.SAUDA_DATE >= @FROMDATE                          
		    AND S.SAUDA_DATE <= @TODATE + ' 23:59'                          
		    AND AUCTIONPART <> 'CA'
		  GROUP BY S.SYMBOL  
	END
   

   
	INSERT INTO @TURNOVERANALYSIS
	  (  
	   SCRIPCODE,  
	   TURNOVERBUY,  
	   TURNOVERSELL,  
	   TURNOVERTOTAL  
	  ) 
	SELECT    
	   SCRIPCODE,  
	   TURNOVERBUY = SUM(TURNOVERBUY),  
	   TURNOVERSELL = SUM(TURNOVERSELL),  
	   TURNOVERTOTAL = SUM(TURNOVERTOTAL)
	FROM @TURNOVERANALYSIS_1
	GROUP BY SCRIPCODE
	
	

  --- UPDATE SCRIPNAME NAME  
  UPDATE @TURNOVERANALYSIS SET SCRIPNAME = SCRIPCODE
  
  ---- TOTAL TURNOVER  
  SELECT @TOTALTURNOVER = SUM(TURNOVERTOTAL) FROM @TURNOVERANALYSIS  
   
  --- UPDATE INDIVIDUAL SCRIP TURN OVER PERCENTAGE  
  UPDATE @TURNOVERANALYSIS SET TURNOVERPERCENTAGE = CONVERT(NUMERIC(24,4), ((TURNOVERTOTAL/@TOTALTURNOVER)*100.0000) )  
  
  SET  NOCOUNT OFF  
  
  IF @REPORTOPTION = 3  
   SELECT   
    [SCRIP CODE] = SCRIPCODE,  
    [SCRIP NAME] = SCRIPNAME,  
    [TURNOVER BUY] = TURNOVERBUY,  
    [TURNOVER SELL] = TURNOVERSELL,  
    [TOTAL TURNOVER] = TURNOVERTOTAL,  
    [TURNOVER PERCENTAGE] = TURNOVERPERCENTAGE  
    FROM @TURNOVERANALYSIS   
    ORDER BY SCRIPCODE  
  ELSE IF @REPORTOPTION = 4  
   SELECT TOP 25  
    [SCRIP CODE] = SCRIPCODE,  
    [SCRIP NAME] = SCRIPNAME,  
    [TURNOVER BUY] = TURNOVERBUY,  
    [TURNOVER SELL] = TURNOVERSELL,  
    [TOTAL TURNOVER] = TURNOVERTOTAL,  
    [TURNOVER PERCENTAGE] = TURNOVERPERCENTAGE  
    FROM @TURNOVERANALYSIS   
    ORDER BY TURNOVERPERCENTAGE DESC  
  
 END    --- IF @REPORTOPTION = 3 OR @REPORTOPTION = 4  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STAMPDUTY_ROUNDING_FURTHER
-- --------------------------------------------------


CREATE  PROC [DBO].[STAMPDUTY_ROUNDING_FURTHER] @SAUDA_DATE VARCHAR(11)      
AS      
      
DECLARE   
@BROKERNOTECUR   CURSOR,      
@SETTCUR      CURSOR,      
@DIFF       NUMERIC(18,4),      
@PARTY_CODE      VARCHAR(10),         
@ORDER_NO     VARCHAR(16),      
@TRADE_NO     VARCHAR(14),      
@INST_TYPE       VARCHAR(6) ,      
@SYMBOL          VARCHAR(12),      
@EXPIRYDATE      DATETIME,      
@STRIKE_PRICE    MONEY      ,      
@OPTION_TYPE     VARCHAR(2),       
@BROKER_CHRG   NUMERIC(18,4)  
  
      
SET @BROKERNOTECUR = CURSOR FOR      
  
SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE, DIFF = SUM(BROKER_CHRG) - ROUND(SUM(BROKER_CHRG),0)   
FROM FOSETTLEMENT  
WHERE CONVERT(VARCHAR,SAUDA_DATE,109) =  @SAUDA_DATE  
GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE  
HAVING SUM(BROKER_CHRG) <> ROUND(SUM(BROKER_CHRG),0)   
ORDER  BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE  
  
OPEN @BROKERNOTECUR      
FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,@STRIKE_PRICE,@DIFF      
WHILE @@FETCH_STATUS = 0   
BEGIN      
 SET @SETTCUR = CURSOR FOR      
 SELECT ORDER_NO, TRADE_NO, BROKER_CHRG FROM FOSETTLEMENT        
 WHERE  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND  @SAUDA_DATE  +' 23:59'     
 AND PARTY_CODE = @PARTY_CODE   
 AND INST_TYPE = @INST_TYPE  
 AND SYMBOL = @SYMBOL  
 AND EXPIRYDATE = @EXPIRYDATE  
 AND OPTION_TYPE = @OPTION_TYPE  
 AND STRIKE_PRICE = @STRIKE_PRICE  
 AND BROKER_CHRG > 0       
 ORDER BY BROKER_CHRG DESC      
 OPEN @SETTCUR      
 FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG  
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0   
 BEGIN      
  IF @DIFF < 0       
  BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = BROKER_CHRG + ABS(@DIFF)      
   FROM FOSETTLEMENT   
   WHERE   
   SAUDA_DATE BETWEEN  @SAUDA_DATE  AND  @SAUDA_DATE  +' 23:59'     
  AND PARTY_CODE = @PARTY_CODE   
  AND INST_TYPE = @INST_TYPE  
  AND SYMBOL = @SYMBOL  
  AND EXPIRYDATE = @EXPIRYDATE  
  AND OPTION_TYPE = @OPTION_TYPE  
  AND STRIKE_PRICE = @STRIKE_PRICE  
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
   SELECT @DIFF = 0       
  END      
 ELSE      
   BEGIN      
   IF @DIFF >= @BROKER_CHRG       
   BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = 0  
   FROM FOSETTLEMENT   
   WHERE   
   SAUDA_DATE BETWEEN  @SAUDA_DATE  AND  @SAUDA_DATE  +' 23:59'     
  AND PARTY_CODE = @PARTY_CODE   
  AND INST_TYPE = @INST_TYPE  
  AND SYMBOL = @SYMBOL  
  AND EXPIRYDATE = @EXPIRYDATE  
  AND OPTION_TYPE = @OPTION_TYPE  
  AND STRIKE_PRICE = @STRIKE_PRICE  
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
    SELECT @DIFF = @DIFF - @BROKER_CHRG       
   END       
    ELSE      
   BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = @BROKER_CHRG - @DIFF      
   FROM FOSETTLEMENT   
   WHERE   
   SAUDA_DATE BETWEEN  @SAUDA_DATE  AND  @SAUDA_DATE  +' 23:59'     
  AND PARTY_CODE = @PARTY_CODE   
  AND INST_TYPE = @INST_TYPE  
  AND SYMBOL = @SYMBOL  
  AND EXPIRYDATE = @EXPIRYDATE  
  AND OPTION_TYPE = @OPTION_TYPE  
  AND STRIKE_PRICE = @STRIKE_PRICE  
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
    SELECT @DIFF = 0      
   END          
   END       
   FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG  
 END      
 CLOSE @SETTCUR      
 DEALLOCATE @SETTCUR      
 FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,@STRIKE_PRICE,@DIFF   
END      
CLOSE @BROKERNOTECUR      
DEALLOCATE @BROKERNOTECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STAMPDUTY_ROUNDING_FURTHER_PARTY
-- --------------------------------------------------



CREATE PROC STAMPDUTY_ROUNDING_FURTHER_PARTY @SAUDA_DATE VARCHAR(11)      
AS      
      
DECLARE   
@BROKERNOTECUR   CURSOR,      
@SETTCUR      CURSOR,      
@DIFF       NUMERIC(18,4),      
@PARTY_CODE      VARCHAR(10),         
@ORDER_NO     VARCHAR(16),      
@TRADE_NO     VARCHAR(14),      
@BROKER_CHRG   NUMERIC(18,4)  
  
      
SET @BROKERNOTECUR = CURSOR FOR      
  
SELECT PARTY_CODE,DIFF = SUM(BROKER_CHRG) - ROUND(SUM(BROKER_CHRG),0)   
FROM FOSETTLEMENT  
WHERE SAUDA_DATE LIKE @SAUDA_DATE +'%'  
AND AUCTIONPART <> 'CA'  
GROUP BY PARTY_CODE  
HAVING SUM(BROKER_CHRG) <> ROUND(SUM(BROKER_CHRG),0)   
ORDER  BY PARTY_CODE  
  
OPEN @BROKERNOTECUR      
FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@DIFF      
WHILE @@FETCH_STATUS = 0   
BEGIN      
 SET @SETTCUR = CURSOR FOR      
 SELECT ORDER_NO, TRADE_NO, BROKER_CHRG FROM FOSETTLEMENT        
 WHERE Sauda_Date between  @Sauda_Date  And  @Sauda_Date  +' 23:59'      
 AND PARTY_CODE = @PARTY_CODE   
 AND BROKER_CHRG > 0       
AND AUCTIONPART <> 'CA'  
 ORDER BY BROKER_CHRG DESC      
 OPEN @SETTCUR      
 FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG  
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0   
 BEGIN      
  IF @DIFF < 0       
  BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = BROKER_CHRG + ABS(@DIFF)      
   FROM FOSETTLEMENT   
   WHERE   
  Sauda_Date between  @Sauda_Date  And  @Sauda_Date  +' 23:59'      
  AND PARTY_CODE = @PARTY_CODE   
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
   SELECT @DIFF = 0       
  END      
 ELSE      
   BEGIN      
   IF @DIFF >= @BROKER_CHRG       
   BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = 0  
   FROM FOSETTLEMENT   
   WHERE   
  Sauda_Date between  @Sauda_Date  And  @Sauda_Date  +' 23:59'      
  AND PARTY_CODE = @PARTY_CODE   
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
    SELECT @DIFF = @DIFF - @BROKER_CHRG       
   END       
    ELSE      
   BEGIN      
   UPDATE FOSETTLEMENT SET BROKER_CHRG = @BROKER_CHRG - @DIFF      
   FROM FOSETTLEMENT   
   WHERE   
  Sauda_Date between  @Sauda_Date  And  @Sauda_Date  +' 23:59'      
  AND PARTY_CODE = @PARTY_CODE   
  AND ORDER_NO = @ORDER_NO       
  AND TRADE_NO = @TRADE_NO      
    SELECT @DIFF = 0      
   END          
   END       
   FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG  
 END      
 CLOSE @SETTCUR      
 DEALLOCATE @SETTCUR      
 FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@DIFF   
END      
CLOSE @BROKERNOTECUR      
DEALLOCATE @BROKERNOTECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.stp_NeTGetTradeInfo
-- --------------------------------------------------
/*            
            
declare @d1 bigint            
declare @d2 varchar(200)            
exec stp_NeTGetTradeInfo_New 'JUN 24 2008','JUN 24 2008','NSE','0','ZZZ', @d1 OUTPUT, @d2 OUTPUT            
PRINT @D1            
print @d2            
            
*/            
            
CREATE PROC [dbo].[stp_NeTGetTradeInfo]        
(                  
 @FROMDATE VARCHAR(11),                  
 @TODATE VARCHAR(11),                  
 @EXCHANGE VARCHAR(3),                  
 @FROMPARTY VARCHAR(10),                  
 @TOPARTY VARCHAR(10),              
 @RETCODE BIGINT OUTPUT,              
 @RETMSG VARCHAR(200) OUTPUT              
)                  
AS             
            
            
            
 DECLARE @ERRORCODE INT              
 DECLARE @MESSAGE VARCHAR(255)              
 DECLARE @@MYFROMDATE DATETIME            
 DECLARE @@MYTODATE DATETIME              
 DECLARE @@RECCOUNT INT              
            
 SET @ERRORCODE = 0            
             
 if @FROMPARTY = ''            
 BEGIN            
 SET @FROMPARTY = '0000000000'            
 END            
             
            
 if @TOPARTY = ''            
 BEGIN            
 SET @TOPARTY = 'ZZZZZZZZZZ'            
 END            
             
            
 SELECT               
  @@MYFROMDATE = CONVERT(DATETIME,@FROMDATE,109)            
 IF @@ERROR <> 0              
 BEGIN              
  SET @ERRORCODE = -1              
  SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#001> : Invalid From Date Parameter Passed'              
  GOTO ERROR              
 END              
            
 SELECT               
  @@MYTODATE =  CONVERT(DATETIME,@TODATE,109)            
 IF @@ERROR <> 0              
 BEGIN              
  SET @ERRORCODE = -1              
  SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#002> : Invalid To Date Parameter Passed'              
  GOTO ERROR              
 END              
            
            
             
 IF (@@MYTODATE < @@MYFROMDATE)               
 BEGIN              
  SET @ERRORCODE = -1              
  SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#003> : From Date is Greater than To Date'              
  GOTO ERROR              
 END              
            
            
 IF (@TOPARTY < @FROMPARTY)               
 BEGIN              
  SET @ERRORCODE = -1              
  SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#004> : From Party / To Party Parameter is Invalid'              
  GOTO ERROR              
 END              
            
            
   SELECT               
    @@RECCOUNT = COUNT(1)               
   FROM               
    FOSETTLEMENT (NOLOCK)              
   WHERE              
    SAUDA_DATE >= @FROMDATE             
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'            
             
   IF @@RECCOUNT = 0              
   BEGIN              
    SET @ERRORCODE = -1              
    SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#005> : Trade Details Not Found'              
    GOTO ERROR              
   END              
            
            
            
IF @ERRORCODE = 0            
BEGIN            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
SELECT             
 EXCHANGENAME = 'NCDEX',            
 CLIENTID = PARTY_CODE,            
 [CONTRACT] = CONTRACTNO,            
 TRANSDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,101),10),            
 ORDERNUMBER = ORDER_NO,            
 TRADENUMBER = TRADE_NO,            
 SETTLEMENTNUMBER = '',            
 EQSYMBOL = SYMBOL,            
 FNOLOT = BILLNO,            
 FNOTYPE = 'COMFU',            
 EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,101),10),            
 [BUY/SELL] = (CASE WHEN SELL_BUY = 1 THEN 'B' ELSE 'S' END),            
 QUANTITY = TRADEQTY,            
 PREMIUM = PRICE,            
 BSTRIKEXS = STRIKE_PRICE,            
 AMOUNT = PRICE * TRADEQTY * BOOKTYPE / INSTRUMENT,            
 SERVICETAX = round(SERVICE_TAX,2),            
 BROKERAGE = round(BROKAPPLIED * TRADEQTY * BOOKTYPE / INSTRUMENT,2),            
 STT = round(INS_CHRG,2),            
 TURNOVERCHARGES = round(TURN_TAX,2),            
 STAMPDUTY = round(BROKER_CHRG,2),     
 OTHERCHARGES = round((OTHER_CHRG + SEBI_TAX),2),            
 REFDATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,101),10),            
 --BROKERID = PARTICIPANTCODE,            
 ACTIVITYX  =             
  CASE WHEN SELL_BUY=1 THEN 'BUY' ELSE 'SELL' END ,    
MULTIPLIER = BILLNO * BOOKTYPE / INSTRUMENT    
    
FROM            
 FOSETTLEMENT NOLOCK            
WHERE            
 SAUDA_DATE >= @FROMDATE            
 AND SAUDA_DATE <= @TODATE + ' 23:59:59'            
 AND TRADEQTY <> 0             
 AND PRICE > 0           
 AND RESERVED1 = '0'          
  order by party_code          
 SET @RETCODE = @@ROWCOUNT            
 SET @ERRORCODE = -1            
END              
            
            
  IF @@ERROR <> 0              
  BEGIN              
   SET @ERRORCODE = -1              
   SET @MESSAGE = 'stp_NeTGetTradeInfo <SQL#005> : Error while object Execution'              
   GOTO ERROR              
  END              
  ELSE              
  BEGIN              
   SET @ERRORCODE = 0              
   GOTO ERROR              
  END              
            
 ERROR:                  
                  
 IF @ERRORCODE <> -1              
 BEGIN                  
  SET @RETMSG = CAST(@RETCODE AS VARCHAR) + ' RECORDS FETCHED SUCCESSFULLY'              
  SET @RETCODE = 0            
  RETURN               
 END                  
 ELSE                  
 BEGIN                  
  SET @RETCODE = -1              
  SET @RETMSG = @MESSAGE              
  RETURN              
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_CHARGES_FINAL
-- --------------------------------------------------
CREATE    PROC [dbo].[STT_CHARGES_FINAL]            
          
(            
           @SAUDA_DATE VARCHAR(11),            
           @PARTYFROM  VARCHAR(10)  = '',            
           @PARTYTO    VARCHAR(11)  = 'ZZZZZZZZ',            
           @USERNAME   VARCHAR(50)  = ''            
)            
AS       
    
--exec STT_CHARGES_FINAL 'dec  4 2017'            
            
DECLARE  @TRDSELLTRANS    NUMERIC(18,4),            
      
           @OPTTRDSELLTRANS NUMERIC(18,4),            
      
           @OPTDELSELLTRANS NUMERIC(18,4),            
      
           @STT_ON          VARCHAR(7)            
      
      
                                   
      
  SET @TRDSELLTRANS = 0            
      
                                  
      
  SET @OPTTRDSELLTRANS = 0            
      
                                     
      
  SET @OPTDELSELLTRANS = 0                
                                     
    
  SELECT @TRDSELLTRANS = TRDSELLTRANS,            
      
         @OPTTRDSELLTRANS = OPTTRDSELLTRANS,            
      
         @OPTDELSELLTRANS = OPTDELSELLTRANS,            
      
         @STT_ON = STT_ON            
      
  FROM   FOGLOBALS            
      
  WHERE  YEAR_START_DT <= @SAUDA_DATE            
      
         AND YEAR_END_DT >= @SAUDA_DATE     
                    
                                        
  IF (@TRDSELLTRANS > 0            
      
       OR @OPTTRDSELLTRANS > 0            
      
       OR @OPTDELSELLTRANS > 0)            
      
    BEGIN     
        
    print 'Suresh'           
                
                  
      UPDATE FOSETTLEMENT            
      SET    INS_CHRG = 0            
      WHERE  SAUDA_DATE >= @SAUDA_DATE            
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
             AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO            
                                                               
     
         
     UPDATE FOSETTLEMENT            
      
      SET    INS_CHRG = ROUND((TRADEQTY * ABS(CASE             
      
                             WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (CASE WHEN AUCTIONPART = 'EA' THEN 0 ELSE PRICE END)          
      
                             ELSE CASE             
      
                                  WHEN @STT_ON = 'PRICE' THEN PRICE + CASE WHEN AUCTIONPART= 'EA'             
      
       THEN             
      
        CASE WHEN LEFT(OPTION_TYPE,1) ='P'             
      
        THEN -STRIKE_PRICE ELSE STRIKE_PRICE END ELSE 0 END            
      
                                    WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE            
      
                                    WHEN @STT_ON = 'SSPRICE' THEN PRICE + STRIKE_PRICE            
      
                                  END            
      
                           END) * (CASE             
      
                                     WHEN LEFT(INST_TYPE,3) = 'FUT' THEN  BOOKTYPE / INSTRUMENT * @TRDSELLTRANS            
      
                                     ELSE CASE             
      
                                            WHEN AUCTIONPART = '' THEN  BOOKTYPE / INSTRUMENT * @OPTTRDSELLTRANS            
      
                                            ELSE  BOOKTYPE / INSTRUMENT * @OPTDELSELLTRANS            
      
                                          END            
      
                                   END) / 100),4)            
      
      WHERE  SAUDA_DATE >= @SAUDA_DATE            
      
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
      
             AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO            
      
             AND SELL_BUY = 2            
      
             AND AUCTIONPART <> 'CA'            
      
             AND TRADEQTY > 0      
   
          
        EXEC STT_ROUNDING_FURTHER @SAUDA_DATE , @PARTYFROM , @PARTYTO     
                                         
      EXEC STT_INSERTDATA_DETAIL @SAUDA_DATE , '' , 'zzzzzzzz'     
    
        
                    
      SELECT   CONTRACTNO,            
               PARTY_CODE,            
   ACTCHRG = SUM(ACTINS_CHRG),            
               TOBECHRG = ROUND(SUM(INS_CHRG),0)            
      INTO     #SETTROUND            
      FROM     (SELECT   CONTRACTNO,            
                         PARTY_CODE,            
      SYMBOL,            
                         INST_TYPE,            
               EXPIRYDATE,            
                         STRIKE_PRICE,            
                         OPTION_TYPE,            
                         INS_CHRG = (SUM(INS_CHRG)),            
                         ACTINS_CHRG = SUM(INS_CHRG)            
                FROM     FOSETTLEMENT            
                WHERE    SAUDA_DATE >= @SAUDA_DATE            
                         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
                         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO            
                         AND TRADEQTY > 0            
                         AND AUCTIONPART <> 'CA'            
                GROUP BY CONTRACTNO,PARTY_CODE,SYMBOL,INST_TYPE,            
                         EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE) A            
      GROUP BY CONTRACTNO,PARTY_CODE            
                           
                           
      SELECT  S.CONTRACTNO,            
               S.PARTY_CODE,            
               SRNO = MIN(SRNO)            
      INTO     #SETTSTTPARTY            
      FROM     FOSETTLEMENT S,            
               #SETTROUND A            
   WHERE    SAUDA_DATE >= @SAUDA_DATE            
               AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
               AND S.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO            
               AND TRADEQTY > 0            
               AND AUCTIONPART <> 'CA'            
               AND A.PARTY_CODE = S.PARTY_CODE            
               AND INS_CHRG >= (CASE             
                                  WHEN TOBECHRG - ACTCHRG < 0 THEN ABS(TOBECHRG - ACTCHRG)            
                                  ELSE 0            
                                END)            
               AND INS_CHRG > 0            
               AND S.CONTRACTNO = A.CONTRACTNO            
      GROUP BY S.CONTRACTNO,S.PARTY_CODE           
          
   UPDATE FOSETTLEMENT                                    
      SET    INS_CHRG = INS_CHRG+ (TOBECHRG - ACTCHRG)                                    
      FROM   #SETTSTTPARTY A,                                    
             #SETTROUND S                                    
      WHERE  SAUDA_DATE >= @SAUDA_DATE                
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'                                    
             AND A.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO          
             AND TRADEQTY > 0                          
             AND FOSETTLEMENT.PARTY_CODE = A.PARTY_CODE                          
             AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE              
           AND FOSETTLEMENT.CONTRACTNO = S.CONTRACTNO          
             AND FOSETTLEMENT.CONTRACTNO = A.CONTRACTNO                          
             AND AUCTIONPART <> 'CA'                          
             AND FOSETTLEMENT.SRNO = A.SRNO                             
             AND FOSETTLEMENT.INS_CHRG > 0            
           
                                    
      TRUNCATE TABLE #SETTROUND                    
      TRUNCATE TABLE #SETTSTTPARTY           
      DROP TABLE #SETTROUND            
      DROP TABLE #SETTSTTPARTY            
                  
           
                  
      EXEC STT_INSERTDATA_SUMMARY @SAUDA_DATE , '' , 'zzzzzzzz'            
                    
      UPDATE FOSETTLEMENT            
      SET    INS_CHRG = 0            
      FROM   CLIENT2 C            
      WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE            
             AND INSURANCE_CHRG = 0            
             AND SAUDA_DATE >= @SAUDA_DATE            
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
                                                         
      UPDATE FOSETTLEMENT            
      SET    INS_CHRG = 0            
      FROM   FOCLIENTTAXES C            
      WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE            
             AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO            
             AND C.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO            
             AND FUT_INSURANCE_CHRG = 0            
             AND SAUDA_DATE >= @SAUDA_DATE            
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'            
                                                         
   END            
          
/*----------------------------------------- END OF THE PROC -------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_DETAIL
-- --------------------------------------------------




CREATE PROC [dbo].[STT_INSERTDATA_DETAIL] 
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10),
	@PARTYTO VARCHAR(11)
) AS   


UPDATE FOSETTLEMENT  
SET    INS_CHRG = 0  
WHERE  SAUDA_DATE >= @SAUDA_DATE  
     AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
     AND PARTY_CODE BETWEEN @PartyFrom AND @PartyTo  
	 AND EXISTS (SELECT SYMBOL FROM STT_EXCEPTION
				WHERE STT_EXCEPTION.SYMBOL = FOSETTLEMENT.SYMBOL
				AND @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO)
	 
DECLARE @MEMBERTYPE VARCHAR (2), @RECTYPE1 INT ,@RECTYPE2 INT

SET @RECTYPE1 = 30
SET @RECTYPE2 = 40

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
	BEGIN
		SET @RECTYPE1 = 40
		SET @RECTYPE2 = 50
	END


DELETE FROM STT_CLIENTDETAIL
WHERE       SAUDA_DATE = @SAUDA_DATE
            AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
            AND RECTYPE = @RECTYPE1

DELETE FROM STT_CLIENTDETAIL
WHERE       SAUDA_DATE = @SAUDA_DATE
            AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
            AND RECTYPE = @RECTYPE2
                          
INSERT INTO STT_CLIENTDETAIL
        (
		RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,
		STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT
	)
           
SELECT   
	@RECTYPE1,@SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
    PRICE = SUM(TRADEQTY*PRICE)/SUM(TRADEQTY),
	0,0,0,
	SUM(TRADEQTY),
	SUM(TRADEQTY * PRICE*BOOKTYPE/INSTRUMENT),
	ROUND(ABS(SUM(INS_CHRG)),2),
	ROUND(ABS(SUM(INS_CHRG)),2)
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
         AND AUCTIONPART = ''
         AND TRADEQTY > 0
         AND SELL_BUY = 2
GROUP BY CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,
         SYMBOL,EXPIRYDATE,STRIKE_PRICE
         

INSERT INTO STT_CLIENTDETAIL
        (
		RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,
		STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT
	)
           
SELECT   
	@RECTYPE2,@SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
	PRICE = SUM(TRADEQTY*PRICE)/SUM(TRADEQTY),
	0,0,0,
	SUM(TRADEQTY),
	SUM(TRADEQTY * PRICE * BOOKTYPE/ INSTRUMENT ),
	ROUND(ABS(SUM(INS_CHRG)),2),
	ROUND(ABS(SUM(INS_CHRG)),2)
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
         AND LEFT(INST_TYPE,3) = 'OPT'
         AND AUCTIONPART = 'EA'
         AND TRADEQTY > 0
         AND SELL_BUY = 2
GROUP BY CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,
         SYMBOL,EXPIRYDATE,STRIKE_PRICE
         
/*--------------------------------END OF THE PROC -------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_SUMMARY
-- --------------------------------------------------



CREATE PROC STT_INSERTDATA_SUMMARY 
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10)='',
	@PARTYTO VARCHAR(11)='ZZZZZZZZ'
) AS   

DELETE FROM STT_CLIENTDETAIL WHERE SAUDA_DATE = @SAUDA_DATE
AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
AND RECTYPE = 20

INSERT INTO STT_CLIENTDETAIL   
	(RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,TRDPRICE,
	PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT)

SELECT 20,@SAUDA_DATE,'',PARTY_CODE,'',
	'','','',0,0,0,0,0,0,0,0,SUM(INS_CHRG) 
FROM FOSETTLEMENT
WHERE 
	SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
	AND TRADEQTY > 0
	AND SELL_BUY = 2 
GROUP BY PARTY_CODE

/*--------------------------------END OF THE PROC -------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MATCHING_PARTYSCRIPWISE
-- --------------------------------------------------


CREATE PROC  
 STT_MATCHING_PARTYSCRIPWISE  
 (  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @CLITYPE VARCHAR(2),  
 @FROMCODE VARCHAR(10),  
 @TOCODE VARCHAR(10),  
 @PARTYCODETYPE VARCHAR(5),  
 @SHOW VARCHAR(1)  ,
 @TYPE VARCHAR(2)
 )  
  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ' 

DECLARE @MEMBERTYPE VARCHAR (2)

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER

CREATE TABLE #RECTYPE ( RECTYPE INT )
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (50)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END

IF @SHOW = 'A'
BEGIN  
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(C.INST_TYPE,E.INST_TYPE) 				AS INST_TYPE,
		ISNULL(C.SYMBOL,E.SYMBOL) 					AS SYMBOL,
		LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11) AS EXPIRYDATE,
		ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE) 				AS STRIKE_PRICE,
		ISNULL(C.OPTION_TYPE,E.OPTION_TYPE) 				AS OPTION_TYPE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ROUND(ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0),2)  AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE),
	ISNULL(C.INST_TYPE,E.INST_TYPE),ISNULL(C.SYMBOL,E.SYMBOL),
	LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11),
	ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE),ISNULL(C.OPTION_TYPE,E.OPTION_TYPE)
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT * FROM (
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(C.INST_TYPE,E.INST_TYPE) 				AS INST_TYPE,
		ISNULL(C.SYMBOL,E.SYMBOL) 					AS SYMBOL,
		LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11) AS EXPIRYDATE,
		ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE) 				AS STRIKE_PRICE,
		ISNULL(C.OPTION_TYPE,E.OPTION_TYPE) 				AS OPTION_TYPE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ROUND(ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0),2)  AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE),
	ISNULL(C.INST_TYPE,E.INST_TYPE),ISNULL(C.SYMBOL,E.SYMBOL),
	LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11),
	ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE),ISNULL(C.OPTION_TYPE,E.OPTION_TYPE)
	) STT_DIFF
	WHERE TOT_DIFF <> 0
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MATCHING_PARTYWISE
-- --------------------------------------------------

CREATE PROC    
 STT_MATCHING_PARTYWISE    
 (    
	 @FROMDATE VARCHAR(11),    
	 @TODATE VARCHAR(11),    
	 @CLITYPE VARCHAR(2),    
	 @FROMCODE VARCHAR(10),    
	 @TOCODE VARCHAR(10),    
	 @PARTYCODETYPE VARCHAR(5),    
	 @SHOW VARCHAR(1)    ,
	 @TYPE VARCHAR(2)
 )    
    
AS    

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ' 
    
DECLARE @MEMBERTYPE VARCHAR (2), @EXRECTYPE INT

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 50
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 30
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END


IF @SHOW = 'A'
BEGIN  
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     
		(
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE)
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT * FROM
	(
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     
		(
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE)
	) STT_DIFF
	WHERE TOT_DIFF <> 0
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MISEXCEPTION_PARTYSCRIPWISE_NSEFO
-- --------------------------------------------------

CREATE PROC STT_MISEXCEPTION_PARTYSCRIPWISE_NSEFO
 (  
	 @FROMDATE VARCHAR(11),  
	 @TODATE VARCHAR(11),  
	 @CLITYPE VARCHAR(2),  
	 @FROMCODE VARCHAR(10),  
	 @TOCODE VARCHAR(10),  
	 @EXCEPTIONTYPE VARCHAR(2)  ,
	 @TYPE VARCHAR(2)
 )  
  
AS  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE @MEMBERTYPE VARCHAR (2)

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER

CREATE TABLE #RECTYPE ( RECTYPE INT )
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (50)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ'  

IF @EXCEPTIONTYPE = 'BO'
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		C.PARTY_CODE                                                    AS PARTY_CODE,
		C.INST_TYPE,
		C.SYMBOL,
		LEFT(CONVERT(VARCHAR,C.EXPIRYDATE,109),11)    			AS EXPIRYDATE,
		C.STRIKE_PRICE,
		C.OPTION_TYPE,	
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE    E.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),C.PARTY_CODE,
	C.INST_TYPE,C.SYMBOL,LEFT(CONVERT(VARCHAR,C.EXPIRYDATE,109),11),C.STRIKE_PRICE,C.OPTION_TYPE
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		E.PARTY_CODE                                                    AS PARTY_CODE,
		E.INST_TYPE,
		E.SYMBOL,
		LEFT(CONVERT(VARCHAR,E.EXPIRYDATE,109),11)    			AS EXPIRYDATE,
		E.STRIKE_PRICE,
		E.OPTION_TYPE,		
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE    C.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),E.PARTY_CODE,
	E.INST_TYPE,E.SYMBOL,LEFT(CONVERT(VARCHAR,E.EXPIRYDATE,109),11),E.STRIKE_PRICE,E.OPTION_TYPE
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MISEXCEPTION_PARTYWISE
-- --------------------------------------------------

CREATE PROC STT_MISEXCEPTION_PARTYWISE
 (  
	@FROMDATE VARCHAR(11),  
	@TODATE VARCHAR(11),  
	@CLITYPE VARCHAR(2),  
	@FROMCODE VARCHAR(10),  
	@TOCODE VARCHAR(10),  
	@EXCEPTIONTYPE VARCHAR(2) ,
	@TYPE VARCHAR(2) 
 )  
  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
DECLARE @MEMBERTYPE VARCHAR (2), @EXRECTYPE INT

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 50
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 30
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ'  

IF @EXCEPTIONTYPE = 'BO'
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		C.PARTY_CODE                                                    AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM    (
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE  E.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),C.PARTY_CODE
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		E.PARTY_CODE                                                    AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE  C.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),E.PARTY_CODE
	ORDER BY 1,2

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_ROUNDING_FURTHER
-- --------------------------------------------------




CREATE PROC STT_ROUNDING_FURTHER 
(@SAUDA_DATE VARCHAR(11), @FROMPARTY VARCHAR(10), @TOPARTY VARCHAR(10))  
AS  
  
DECLARE @STTCUR CURSOR,  
@DIFF NUMERIC(18,4),  
@PARTY_CODE VARCHAR(10),  
@CONTRACTNO VARCHAR(7)  
  
DECLARE @SETTCUR CURSOR,  
@ORDER_NO VARCHAR(16),  
@TRADE_NO VARCHAR(20),  
@SYMBOL VARCHAR(12),  
@INS_CHRG NUMERIC(18,4)  ,
@SRNO INT
  
SELECT PARTY_CODE, CONTRACTNO, TOTAL = SUM(INS_CHRG), ACTUAL = ROUND(SUM(INS_CHRG),0)   
INTO #SETT FROM FOSETTLEMENT 
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
GROUP BY PARTY_CODE, CONTRACTNO  
HAVING SUM(INS_CHRG) <> ROUND(SUM(INS_CHRG),0)  
  
SET @STTCUR = CURSOR FOR  
SELECT PARTY_CODE, CONTRACTNO, DIFF = TOTAL - ACTUAL FROM #SETT  
ORDER BY PARTY_CODE, CONTRACTNO  
OPEN @STTCUR  
FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
WHILE @@FETCH_STATUS = 0 --1  
BEGIN  
 SET @SETTCUR = CURSOR FOR  
 SELECT SRNO,SYMBOL, ORDER_NO, TRADE_NO, INS_CHRG FROM FOSETTLEMENT    
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
 AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
 AND INS_CHRG > 0   
 ORDER BY INS_CHRG DESC  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SRNO,@SYMBOL, @ORDER_NO, @TRADE_NO, @INS_CHRG  
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0 --2  
 BEGIN  
  IF @DIFF < 0   
  BEGIN  
   UPDATE FOSETTLEMENT SET INS_CHRG = INS_CHRG + ABS(@DIFF)  
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
   AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
   AND TRADE_NO = @TRADE_NO  
   AND SRNO = @SRNO
   SELECT @DIFF = 0   
  END  
 ELSE  
   BEGIN  
   IF @DIFF >= @INS_CHRG   
   BEGIN  
    UPDATE FOSETTLEMENT SET INS_CHRG = 0  
    WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
    AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
    AND TRADE_NO = @TRADE_NO  
	AND SRNO = @SRNO

    SELECT @DIFF = @DIFF - @INS_CHRG   
   END   
    ELSE  
   BEGIN  
    UPDATE FOSETTLEMENT SET INS_CHRG = @INS_CHRG - @DIFF  
    WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
    AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
    AND TRADE_NO = @TRADE_NO  
    AND SRNO = @SRNO
     
    SELECT @DIFF = 0  
   END      
   END   
   FETCH NEXT FROM @SETTCUR INTO @SRNO,@SYMBOL, @ORDER_NO, @TRADE_NO, @INS_CHRG   
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
END  
CLOSE @STTCUR  
DEALLOCATE @STTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Upbroksett
-- --------------------------------------------------

CREATE Procedure Upbroksett   
@sauda_date varchar(11),  
@party_code varchar(10),  
@option_type varchar(2),  
@inst_type varchar(6),  
@symbol varchar(12),  
@expirydate varchar(11),  
@strike_price money  
as  
       Update fosettlement set   
         
	Table_no = FoSettBrokViewFinal.Table_No,Line_no = FoSettBrokViewFinal.Line_No,  
	Val_perc = FoSettBrokViewFinal.Val_perc,Normal = FoSettBrokViewFinal.Normal,  
	day_puc =  FoSettBrokViewFinal.day_puc,day_sales = FoSettBrokViewFinal.day_sales,  
	Sett_purch = FoSettBrokViewFinal.Sett_purch,Sett_sales = FoSettBrokViewFinal.Sett_sales,  
	BrokApplied = FoSettBrokViewFinal.BrokApplied ,

	NetRate = (Case when FoSettBrokViewFinal.sell_buy = 1   
			Then FoSettBrokViewFinal.Price + FoSettBrokViewFinal.BrokApplied   
			Else FoSettBrokViewFinal.Price - FoSettBrokViewFinal.BrokApplied   
			End),    
	
	Amount = FoSettBrokViewFinal.Tradeqty * (Case when FoSettBrokViewFinal.sell_buy = 1   
		Then ( FoSettBrokViewFinal.Price + FoSettBrokViewFinal.BrokApplied )  
		Else ( FoSettBrokViewFinal.Price - FoSettBrokViewFinal.BrokApplied )  
		End)* FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.Instrument,   
	Ins_chrg = FoSettBrokViewFinal.Ins_chrg * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument,
	turn_tax = FoSettBrokViewFinal.turn_tax * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument,
	other_chrg = FoSettBrokViewFinal.other_chrg * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument,  
	sebi_tax= FoSettBrokViewFinal.sebi_tax * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument,
	Broker_chrg = 0,  
	Service_tax = ((floor ( ((FoSettBrokViewFinal.Brokapplied * FoSettBrokViewFinal.TradeQty*FoSettBrokViewFinal.Service_Tax * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument) /100 *   
	power(10,FoSettBrokViewFinal.round_to) + FoSettBrokViewFinal.roFig + FoSettBrokViewFinal.errnum  ) /    
	(FoSettBrokViewFinal.RoFig + FoSettBrokViewFinal.Nozero)) * (FoSettBrokViewFinal.RoFig + FoSettBrokViewFinal.Nozero) )   
	/ power(10,FoSettBrokViewFinal.round_to)),  
	Trade_amount = FoSettBrokViewFinal.Tradeqty * FoSettBrokViewFinal.Price * FoSettBrokViewFinal.BookType / FoSettBrokViewFinal.instrument  
	
       FROM FoSettBrokViewFinal  
       Where  
            FoSettlement.Party_Code = FoSettBrokViewFinal.Party_code
            and	
            FoSettlement.inst_type = FoSettBrokViewFinal.inst_type
            and
            FoSettlement.symbol = FoSettBrokViewFinal.symbol
            and
            convert(Varchar,FoSettlement.expirydate,103) = convert(Varchar,FoSettBrokViewFinal.expirydate,103)
            and
            FoSettlement.strike_price = FoSettBrokViewFinal.strike_price
            and
            FoSettlement.Option_type = FoSettBrokViewFinal.Option_type
            and
            convert(Varchar,FoSettlement.Sauda_Date,103) = convert(Varchar,FoSettBrokViewFinal.Sauda_Date,103)
            and
            FoSettBrokViewFinal.Party_code = @party_code  
            and  
            FoSettBrokViewFinal.Option_type = @option_type   
            and  
            FoSettBrokViewFinal.inst_type = @inst_type  
            and  
            FoSettBrokViewFinal.symbol = @symbol  
            and   
            left(convert(varchar,FoSettBrokViewFinal.expirydate,109),11) = @expirydate  
            and  
            FoSettBrokViewFinal.strike_price = @strike_price  
            and  
            fosettlement.Status <>  'E'     
            and 
            FoSettlement.Sauda_Date Like @sauda_date + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_CHECKPASSWORD
-- --------------------------------------------------



CREATE PROC [dbo].[USP_CHECKPASSWORD]
(
	@PWD VARCHAR(512) 
)
/*
SELECT * FROM TBLGLOBALPARAMS
SELECT * FROM TBLPRADNYAUSERS
update TBLGLOBALPARAMS set FLDPWDMINLENGTH = 2
USP_CHECKPASSWORD ''
*/
AS

DECLARE 
@FLAG AS VARCHAR(1),
@SPCL AS VARCHAR(1),
@MAXL AS VARCHAR(2),
@MINL AS VARCHAR(2),
@ANUM AS VARCHAR(1),
@MSG AS VARCHAR(100),
@NFLAG AS VARCHAR(1)
SET @FLAG = 'N'
SET @NFLAG = 'N'
SET @MSG = 'OK'

CREATE TABLE #TEMP
(
	MSG VARCHAR(100)
) 

SELECT @SPCL = FLDSPCLCHAR, @MINL = FLDPWDMINLENGTH ,@MAXL = FLDPWDMAXLENGTH, @ANUM = FLDPWDALPHANUMONLY FROM TBLGLOBALPARAMS

IF LEN(@PWD) = 0 
 BEGIN
	SET @MSG = ' ** Password Can Not be Blank.'
	INSERT INTO #TEMP VALUES(@MSG)
	SELECT * FROM #TEMP
	RETURN
 END

IF LEN(@PWD) < @MINL
 BEGIN
	SET @MSG = ' ** Password Should be Minimum '+ @MINL + ' in Length.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
 IF LEN(@PWD) > @MAXL
 BEGIN
	SET @MSG = ' ** Password Should be Maximum '+ @MAXL + ' in Length.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
IF @ANUM = '1'
BEGIN 
	IF (PATINDEX('%['+CHAR(48)+'-'+CHAR(57)+']%',@PWD) > 0 )
	 BEGIN 
		SET @NFLAG = 'Y'
	 END
	 IF (PATINDEX('%['+CHAR(65)+'-'+CHAR(90)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 IF (PATINDEX('%['+CHAR(97)+'-'+CHAR(122)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
END
IF (@FLAG = 'N' or @NFLAG = 'N') AND @ANUM = '1'
 BEGIN 
	SET @MSG = ' ** Password Should be Alpha-Numeric.'
	INSERT INTO #TEMP VALUES(@MSG)
 END
 
SET @FLAG = 'N' 
IF @SPCL = 'Y'
BEGIN
	IF (PATINDEX('%['+CHAR(0)+'-'+CHAR(47)+']%',@PWD) > 0 )
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(58)+'-'+CHAR(64)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(58)+'-'+CHAR(64)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(91)+'-'+CHAR(96)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
	 
	IF (PATINDEX('%['+CHAR(123)+'-'+CHAR(126)+']%',@PWD) > 0 AND @FLAG = 'N')
	 BEGIN 
		SET @FLAG = 'Y'
	 END
END	 
 
IF @FLAG = 'N' AND @SPCL = 'Y'
 BEGIN 
	SET @MSG = ' ** Password Should have Atleast One Special Character.'
	INSERT INTO #TEMP VALUES(@MSG)
 END 	


  
IF ((SELECT COUNT(*) FROM #TEMP) = 0)
 BEGIN
	INSERT INTO #TEMP VALUES(@MSG)
 END 
SELECT * FROM #TEMP
DROP TABLE #TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GSTReversal_Action_Wrapper
-- --------------------------------------------------

-- USP_GSTReversal_Action_Wrapper '41~42~43~44~45','A','Lucky'
--exec USP_GSTReversal_Action_Wrapper @Str='12~',@ACTION='A',@ACTIONBY='SANTOSHH',@Remarks='12$OK~'



CREATE PROC [dbo].[USP_GSTReversal_Action_Wrapper]
@STR VARCHAR(MAX),
@ACTION CHAR,
@ACTIONBY VARCHAR(20),
@Remarks VARCHAR(300)

AS
/*
DECLARE @STR VARCHAR(20)
DECLARE @ACTION CHAR
DECLARE @ACTIONBY VARCHAR(20)

SET @STR = '12~13'
SET @ACTION = 'R'
SET @ACTIONBY = 'Badrish' 
*/
BEGIN

		 SELECT *  
		 INTO #Remarks
		 FROM .dbo.fn_Split(@Remarks,'~')
         
		 SELECT SUBSTRING(Value,0,charindex('$',value)) as SrNo,  
				SUBSTRING(Value,charindex('$',value)+1,300) as Remarks  
		 INTO #FinalRemarks
		 FROM #Remarks



		IF EXISTS(  SELECT 'ACTION TAKEN ALREADY IN THESE RECORDS : ' + PartyCode  + ' -  ' + INV_DATE  + ' -  ' +  CONVERT(VARCHAR(20),ReversalAmount )
		 FROM MSAJAG..GSTReversal_Preprocess
		 WHERE SRNo IN (SELECT Value  FROM .dbo.fn_Split(@Str,'~'))
				AND [STATUS] <> 'P')
				BEGIN 
						SELECT 'ACTION TAKEN ALREADY IN THESE RECORDS : ' + PartyCode  + ' -  ' + INV_DATE  + ' -  ' +  CONVERT(VARCHAR(20),ReversalAmount )
						FROM MSAJAG..GSTReversal_Preprocess
						WHERE SRNo IN (SELECT Value  FROM .dbo.fn_Split(@Str,'~'))
								AND [STATUS] <> 'P'
						
						RETURN 
				END

IF (@ACTION = 'R')
BEGIN

		 UPDATE MSAJAG..GSTReversal_Preprocess
		 SET [Status] = @ACTION, ActionBy = @ACTIONBY, ActionOn = GETDATE()
		 WHERE Srno IN (SELECT Value  FROM .dbo.fn_Split(@Str,'~'))
		 
		 

		 UPDATE A
		 SET A.Remarks = B.Remarks
		 FROM MSAJAG..GSTReversal_Preprocess A
				INNER JOIN #FinalRemarks B
				ON A.SrNo = B.SrNo


		 SELECT 'Entry Rejected Successfully..!'

END
ELSE IF (@ACTION = 'A')

BEGIN

TRUNCATE TABLE ACcoUNTNCE..GST_REVERSAL_OutputData

	DECLARE @MIN INT
	DECLARE @MAX INT
	DECLARE @Value INT
	
	DECLARE @INV_DATE  VARCHAR(15)
	DECLARE @PARTY_CODE  VARCHAR(11)
	DECLARE @INV_NO  VARCHAR(20)
	DECLARE @RECORDFOR  VARCHAR(20)
	DECLARE @INVOICE_TYPE VARCHAR(20)
	DECLARE @REV_AMOUNT MONEY
	DECLARE @VDT VARCHAR(12)
	DECLARE @GL_CODE VARCHAR(20)
	DECLARE @NARRATION VARCHAR(500)
	DECLARE @UNAME VARCHAR(20)
	DECLARE @ReversalType VARCHAR(20)
	DECLARE @BranchCode  VARCHAR(20)
	DECLARE @RemarksData VARCHAR(300)


	SET @MIN  = 1
	SELECT @MAX = position FROM .dbo.fn_Split(@Str,'~')


	WHILE (@Min<=@MAX)
	BEGIN
			 SET @Value = ''

			 SELECT @Value = Value 
			 FROM .dbo.fn_Split(@Str,'~')
			 WHERE position = @Min 		
		
		 
			 SELECT @INV_DATE = INV_DATE, @PARTY_CODE = PartyCode, @INV_NO = InvoiceNo, @RECORDFOR =RECORDFOR , @INVOICE_TYPE = INVOICETYPE, @REV_AMOUNT = ReversalAmount,
					@VDT = VDT, @GL_CODE = GLCode , @NARRATION = NARRATION , @UNAME = CreatedBy, @ReversalType = ReversalType , @BranchCode = Branch
			 FROM MSAJAG..GSTReversal_Preprocess
			 WHERE Srno = @Value

			 SELECT @RemarksData = Remarks
			 FROM #FinalRemarks
			 WHERE Srno = @Value 

			 
			 EXEC ACCOUNTNCE.DBO.GST_REVESAL_POSTING 
					@INV_DATE = @INV_DATE,
					@PARTY_CODE = @PARTY_CODE , 
					@INV_NO = @INV_NO , 
					@RECORDFOR = @RECORDFOR , 
					@INVOICE_TYPE = @INVOICE_TYPE , 
					@REV_AMOUNT = @REV_AMOUNT, 
					@VDT = @VDT , 
					@GL_CODE = @GL_CODE , 
					@NARRATION = @NARRATION , 
					@UNAME = @UNAME ,
					@ReversalType = @ReversalType ,
					@BranchCode  =@BranchCode  ,
					@SrNO = @Value,
				    @ACTIONBY = @ACTIONBY,
					@Remarks = @RemarksData


			 --UPDATE GSTReversal_Preprocess
			 --SET [Status] = @ACTION, ActionBy = @ACTIONBY, ActionOn = GETDATE()
			 --WHERE Srno = @Value

		
			SET @Min = @Min  + 1 
	END

	SELECT Result as '**** Output Summary ****' FROM ACCOUNTNCE..GST_REVERSAL_OutputData

--	SELECT 'Entry Accepted Successfully..!'
END
END
/*
SELECT *  FROM GSTReversal_Preprocess 
SELECT * FROM ACCOUNT.DBO.GST_REVERSAL_ENTRY_DETAILS 
SELECT * FROM ACCOUNT.DBO.JV_CN_DN_DETAILS 


delete ACCOUNT.DBO.GST_REVERSAL_ENTRY_DETAILS where narration like 'narr%'
delete  ACCOUNT.DBO.JV_CN_DN_DETAILS 
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RTB_NCE_MASTER_SYNC
-- --------------------------------------------------

CREATE PROC [dbo].[USP_RTB_NCE_MASTER_SYNC]    
(@sauda_date AS DATETIME)    

/*
BUILD BY : SIVA KUMAR
DEPLOYED BY: GANESH JAGDALE
CREATED ON : 25/04/2024
APPROVED BY : RAHUL SHAH
MODIFIED Date : 25/04/2024
PURPOSE : NCE Commodity RTB Process
APPROVED BY : RAHUL SHAH
SRE TiCKET : https://angelbrokingpl.atlassian.net/browse/SRE-25097
*/

-- USP_RTB_NCE_MASTER_SYNC '2023-06-30'

AS BEGIN    
   
DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE +' 23:59' -- AND AUCTIONPART = ''
     
   
INSERT INTO FOSETTLEMENT    
 SELECT CONTRACTNO = CONTRACTNO_SEG,BILLNO = LOT_SIZE, TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL = LEFT(SCRIP_CD,12),  
 SEC_NAME = SECURITY_NAME,  EXPIRYDATE = EXPIRYDATE,STRIKE_PRICE = CONVERT(MONEY,STRIKE_PRICE), 
 OPTION_TYPE = (CASE WHEN OPTION_TYPE ='XX' THEN '' ELSE OPTION_TYPE END) ,USER_ID = USERID,PRO_CLI = 1,O_C_FLAG = 10,C_U_FLAG = 'COVER',TRADEQTY = QTY,  
AUCTIONPART  ,MARKETTYPE = '1',SERIES = 0,ORDER_NO,PRICE = CONVERT(MONEY,MARKET_RATE),SAUDA_DATE = REPLACE(TRADE_TIME,'.0000000','') ,  
TABLE_NO ,LINE_NO = CONVERT(INT,LINE_NO),VAL_PERC,NORMAL = CONVERT(MONEY,NORMAL),DAY_PUC = CONVERT(MONEY,DAY_PUC),DAY_SALES = CONVERT(MONEY,DAY_SALES),  
SETT_PURCH = CONVERT(MONEY,SETT_PURCH),SETT_SALES = CONVERT(MONEY,SETT_SALES),SELL_BUY = CONVERT(INT,BUYSELL),  
SETTFLAG = CONVERT(INT,(CASE WHEN TRADE_TYPE = 'T' THEN BUYSELL+1 ELSE BUYSELL+3 END)),BROKAPPLIED = CONVERT(MONEY,NET_RATE_PER_UNIT),  
NETRATE = CONVERT(MONEY,(CASE WHEN BUYSELL = 1 THEN MARKET_RATE+NET_RATE_PER_UNIT ELSE MARKET_RATE-NET_RATE_PER_UNIT END)),  
AMOUNT = CONVERT(MONEY,QTY)*CONVERT(MONEY,MARKET_RATE),INS_CHRG = CONVERT(MONEY,STT),TURN_TAX = CONVERT(MONEY,TURN_TAX),OTHER_CHRG = OTHER_CHRG,  
SEBI_TAX = CONVERT(MONEY,SEBIFEE),BROKER_CHRG = CONVERT(MONEY,STAMPDUTY),SERVICE_TAX = CONVERT(MONEY,SERVICE_TAX),  
TRADE_AMOUNT = CONVERT(MONEY,QTY)*CONVERT(MONEY,MARKET_RATE),BILLFLAG = CONVERT(INT,(CASE WHEN TRADE_TYPE = 'T' THEN BUYSELL+1 ELSE BUYSELL+3 END)),  
SETT_NO = 0,NBROKAPP = CONVERT(MONEY,NET_RATE_PER_UNIT),NSERTAX = CONVERT(MONEY,SERVICE_TAX),  
N_NETRATE = CONVERT(MONEY,(CASE WHEN BUYSELL = 1 THEN MARKET_RATE+NET_RATE_PER_UNIT ELSE MARKET_RATE-NET_RATE_PER_UNIT END)),  
SETT_TYPE = 'F',CONVERT(MONEY,CL_RATE) CL_RATE,PARTICIPANTCODE = MEMID,STATUS = '11',  
CPID = CONVERT(VARCHAR(30),CONVERT(DATETIME, REPLACE(ORDER_TIME,'.0000000','')), 100) ,INSTRUMENT = isnull(DENOMINATOR,'0'),
BOOKTYPE = isnull(NUMERATOR,'0'),BRANCH_ID = 1,  
TMARK = 0,SCHEME = 3,DUMMY1 = 0,DUMMY2 = CONVERT(INT,MARKET_RATE),RESERVED1 = 0,RESERVED2 = 0   
 FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH(NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE
 

   SELECT * INTO #FOSETT 
FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH (NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE
 
--  DELETE FOTRADE_CTCLID WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE+ ' 23:59'

--INSERT INTO FOTRADE_CTCLID
--SELECT DISTINCT REPLACE(ORDER_TIME,'.0000000','') ,ORDER_NO,INST_TYPE,
--LEFT(SCRIP_CD,12),EXPIRYDATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CTCLID,GETDATE()
--FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH (NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE


  
DELETE TBL_STAMP_DATA WHERE  SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_STAMP_DATA  
SELECT  SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE = CONVERT(DATETIME,EXPIRYDATE)+' 23:59:59',STRIKE_PRICE,OPTION_TYPE,BUYQTY,SELLQTY,  
BUYAVGRATE,SELLAVGRATE,BUYSTAMP,SELLSTAMP,TOTALSTAMP,L_STATE,LASTRUNDATE = GETDATE()   
 FROM INHOUSE_NCE..TBL_STAMP_DATA_RTB WHERE SAUDA_DATE = @SAUDA_DATE     
   
  
DELETE STT_CLIENTDETAIL WHERE  SAUDA_DATE = @SAUDA_DATE    
  
INSERT INTO  STT_CLIENTDETAIL  
SELECT RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,  
STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT   
 FROM INHOUSE_NCE..STT_CLIENTDETAIL_RTB WHERE SAUDA_DATE = @SAUDA_DATE  
    
     
DELETE FROM CHARGES_DETAIL WHERE CD_SAUDA_DATE = @SAUDA_DATE    
   
INSERT INTO CHARGES_DETAIL    
SELECT  CD_PARTY_CODE = PARTY_CODE,CD_SAUDA_DATE = SAUDA_DATE,CD_CONTRACT_NO = CONTRACT_NO,CD_TRADE_NO = TRADE_NO,CD_ORDER_NO = ORDER_NO,  
CD_INST_TYPE = INST_TYPE,CD_SYMBOL = SYMBOL,CD_EXPIRY_DATE = EXPIRY_DATE +' 23:59',  
CD_OPTION_TYPE = (CASE WHEN OPTION_TYPE = 'XX' THEN '' ELSE OPTION_TYPE END),CD_STRIKE_PRICE = STRIKE_PRICE,CD_AUCTIONPART=AUCTIONPART ,  
CD_MARKETLOT = MARKETLOT,CD_SCHEME_ID = SCHEME_ID,CD_COMPUTATIONLEVEL = COMPUTATIONLEVEL,CD_COMPUTATIONON = COMPUTATIONON,  
CD_COMPUTATIONTYPE = COMPUTATIONTYPE,CD_BUYRATE = BUYRATE,CD_SELLRATE = SELLRATE,CD_TOT_BUYQTY = TOT_BUYQTY,CD_TOT_SELLQTY = TOT_SELLQTY,  
CD_TOT_BUYTURNOVER = TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED = TOT_BUYTURNOVER_ROUNDED,  
CD_TOT_SELLTURNOVER_ROUNDED = TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED = TOT_TURNOVER_ROUNDED,CD_TOT_LOT = TOT_LOT,  
CD_TOT_RES_TURNOVER = TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED = TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT = 0,CD_TOT_BUYBROK = TOT_BUYBROK,  
CD_TOT_SELLBROK = TOT_SELLBROK,CD_TOT_BROK = TOT_BROK,CD_TOT_BUYSERTAX = TOT_BUYSERTAX,CD_TOT_SELLSERTAX = TOT_SELLSERTAX,CD_TOT_SERTAX = TOT_SERTAX,  
CD_TOT_STT = TOT_STT,CD_TOT_TURN_TAX = TOT_TURN_TAX,CD_TOT_OTHER_CHRG = 0,CD_TOT_SEBI_TAX = 0,CD_TOT_STAMPDUTY = 0,CD_EXCH_BUYRATE = EXCH_BUYRATE,  
CD_EXCH_SELLRATE = EXCH_SELLRATE,CD_TIMESTAMP = GETDATE()   
 FROM INHOUSE_NCE..PRORDERWISEDETAILS_FO_RTB WHERE SAUDA_DATE = @SAUDA_DATE AND SYMBOL NOT LIKE '%BROK%'    
    
   
INSERT INTO CHARGES_DETAIL    
SELECT  CD_PARTY_CODE = PARTY_CODE,CD_SAUDA_DATE = SAUDA_DATE,CD_CONTRACT_NO = CONTRACT_NO,CD_TRADE_NO = TRADE_NO,CD_ORDER_NO = ORDER_NO,  
CD_INST_TYPE = INST_TYPE,CD_SYMBOL = 'BROKERAGE',CD_EXPIRY_DATE = EXPIRY_DATE,CD_OPTION_TYPE = OPTION_TYPE,CD_STRIKE_PRICE = STRIKE_PRICE,  
CD_AUCTIONPART = '',CD_MARKETLOT = MARKETLOT,CD_SCHEME_ID = SCHEME_ID,CD_COMPUTATIONLEVEL = COMPUTATIONLEVEL,CD_COMPUTATIONON = COMPUTATIONON,  
CD_COMPUTATIONTYPE = COMPUTATIONTYPE,CD_BUYRATE = BUYRATE,CD_SELLRATE = SELLRATE,CD_TOT_BUYQTY = TOT_BUYQTY,CD_TOT_SELLQTY = TOT_SELLQTY,  
CD_TOT_BUYTURNOVER = TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED = TOT_BUYTURNOVER_ROUNDED,  
CD_TOT_SELLTURNOVER_ROUNDED = TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED = TOT_TURNOVER_ROUNDED,CD_TOT_LOT = TOT_LOT,  
CD_TOT_RES_TURNOVER = TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED = TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT = 0,CD_TOT_BUYBROK = TOT_BUYBROK,  
CD_TOT_SELLBROK = TOT_SELLBROK,CD_TOT_BROK = TOT_BROK,CD_TOT_BUYSERTAX = TOT_BUYSERTAX,CD_TOT_SELLSERTAX = TOT_SELLSERTAX,CD_TOT_SERTAX = TOT_SERTAX,  
CD_TOT_STT = TOT_STT,CD_TOT_TURN_TAX = TOT_TURN_TAX,CD_TOT_OTHER_CHRG = 0,CD_TOT_SEBI_TAX = 0,CD_TOT_STAMPDUTY = 0,CD_EXCH_BUYRATE = EXCH_BUYRATE,  
CD_EXCH_SELLRATE = EXCH_SELLRATE,CD_TIMESTAMP = GETDATE()    
 FROM INHOUSE_NCE..PRORDERWISEDETAILS_FO_RTB P WHERE SAUDA_DATE = @SAUDA_DATE  AND SYMBOL LIKE '%BROK%'    
    
--  DECLARE @CONTNO VARCHAR(8)
--SELECT @CONTNO = MAX(CONTRACTNO_SEG) FROM #FOSETT (NOLOCK)  

/* Changes Start  01/03/2024 For Valan */ 
SELECT DISTINCT PARTY_CODE INTO #FOPARTY  FROM INHOUSE_NCE.DBO.FOBILLVALANDATA_RTB WHERE SAUDA_DATE>= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
CREATE INDEX #P ON #FOPARTY(PARTY_CODE)
SELECT DISTINCT CL_CODE,SHORT_NAME,EMAIL,L_STATE INTO #FOCLIENT  FROM CLIENT1 WHERE EXISTS (SELECT PARTY_CODE FROM #FOPARTY WHERE CL_CODE=PARTY_CODE )

CREATE INDEX #P ON #FOClient(CL_CODE)

 SELECT  PARTY_CODE,	PARTY_NAME=SHORT_NAME,	CLIENT_TYPE,	BILLNO,	CONTRACTNO,	INST_TYPE,	SYMBOL,
 EXPIRYDATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),EXPIRYDATE)+' 23:59') ,	OPTION_TYPE,	STRIKE_PRICE,	AUCTIONPART,	
 MATURITYDATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),MATURITYDATE)+' 23:59'),	
 SAUDA_DATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_DATE)+' 23:59'),	ISIN,	PQTY,	SQTY,	PRATE,	SRATE,	PAMT,	SAMT,
 PBROKAMT,	SBROKAMT,	PBILLAMT,	SBILLAMT,	CL_RATE,	CL_CHRG,	EXCL_CHRG,	SERVICE_TAX,	EXSER_TAX,	
 INEXSERFLAG,	SEBI_TAX,	TURN_TAX	,BROKER_NOTE,	INS_CHRG,	OTHER_CHRG,	TRADETYPE,	PARTICIPANTCODE	,TERMINAL_ID,	FAMILY,	FAMILYNAME,	TRADER,	BRANCH_CODE,	SUB_BROKER,
 STATUSNAME,	EXCHANGE,	SEGMENT,	MEMBERTYPE,	COMPANYNAME=L_STATE	,REGION	,UPDATEDATE	,EMAIL= C.EMAIL,SBU,	RELMGR,	GRP,	SECTOR,	
 CMCLOSING,	TRACK,		NUMERATOR	,DENOMINATOR, BILLNO AS RegularLot, AREA
 INTO #FOBILLVALAN
 FROM INHOUSE_NCE.DBO.FOBILLVALANDATA_RTB  B
 LEFT OUTER JOIN #FOCLIENT C ON PARTY_CODE=CL_CODE
 WHERE SAUDA_DATE>= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'

DELETE FROM FOBILLVALAN WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
 
 INSERT INTO FOBILLVALAN
 SELECT * FROM #FOBILLVALAN

 DELETE FROM FOACCBILL WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'

 INSERT INTO FOACCBILL
 SELECT  PARTY_CODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,START_DATE=START_DATE+ ' 23:59:00' ,END_DATE=END_DATE+ ' 23:59:00' ,
  PAYIN_DATE=PAYIN_DATE+ ' 23:59:00' ,PAYOUT_DATE=PAYOUT_DATE,AMOUNT,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION
 FROM INHOUSE_NCE.DBO.FOACCBILLDATA_RTB WHERE BILLDATE>= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'

 /* Changes End  01/03/2024 */
DECLARE @CONTNO VARCHAR(10)
SELECT @CONTNO= MAX(CONVERT(BIGINT,CONTRACTNO_SEG)) FROM #FOSETT (NOLOCK)
  
IF ISNULL(@CONTNO,0) <> 0 
 BEGIN 

UPDATE CONTGEN SET CONTRACTNO = @CONTNO WHERE @SAUDA_DATE BETWEEN START_DATE AND END_DATE 

END
          
	INSERT INTO INHOUSE_NCE..TBL_RTB_NCEDATA_UPD
		SELECT @SAUDA_DATE,GETDATE()

  
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RTB_NCE_MASTER_SYNC_11JUL2024_SRE_27774
-- --------------------------------------------------


CREATE PROC [dbo].[USP_RTB_NCE_MASTER_SYNC_11JUL2024_SRE_27774]    
(@sauda_date AS DATETIME)    

/*
BUILD BY : SIVA KUMAR
DEPLOYED BY: GANESH JAGDALE
CREATED ON : 25/04/2024
APPROVED BY : RAHUL SHAH
MODIFIED Date : 25/04/2024
PURPOSE : NCE Commodity RTB Process
APPROVED BY : RAHUL SHAH
SRE TiCKET : https://angelbrokingpl.atlassian.net/browse/SRE-25097
*/

-- USP_RTB_NCE_MASTER_SYNC '2023-06-30'

AS BEGIN    
   
DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE +' 23:59' -- AND AUCTIONPART = ''
     
   
INSERT INTO FOSETTLEMENT    
 SELECT CONTRACTNO = CONTRACTNO_SEG,BILLNO = LOT_SIZE, TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL = LEFT(SCRIP_CD,12),  
 SEC_NAME = SECURITY_NAME,  EXPIRYDATE = EXPIRYDATE,STRIKE_PRICE = CONVERT(MONEY,STRIKE_PRICE), 
 OPTION_TYPE = (CASE WHEN OPTION_TYPE ='XX' THEN '' ELSE OPTION_TYPE END) ,USER_ID = USERID,PRO_CLI = 1,O_C_FLAG = 10,C_U_FLAG = 'COVER',TRADEQTY = QTY,  
AUCTIONPART  ,MARKETTYPE = '1',SERIES = 0,ORDER_NO,PRICE = CONVERT(MONEY,MARKET_RATE),SAUDA_DATE = REPLACE(TRADE_TIME,'.0000000','') ,  
TABLE_NO ,LINE_NO = CONVERT(INT,LINE_NO),VAL_PERC,NORMAL = CONVERT(MONEY,NORMAL),DAY_PUC = CONVERT(MONEY,DAY_PUC),DAY_SALES = CONVERT(MONEY,DAY_SALES),  
SETT_PURCH = CONVERT(MONEY,SETT_PURCH),SETT_SALES = CONVERT(MONEY,SETT_SALES),SELL_BUY = CONVERT(INT,BUYSELL),  
SETTFLAG = CONVERT(INT,(CASE WHEN TRADE_TYPE = 'T' THEN BUYSELL+1 ELSE BUYSELL+3 END)),BROKAPPLIED = CONVERT(MONEY,NET_RATE_PER_UNIT),  
NETRATE = CONVERT(MONEY,(CASE WHEN BUYSELL = 1 THEN MARKET_RATE+NET_RATE_PER_UNIT ELSE MARKET_RATE-NET_RATE_PER_UNIT END)),  
AMOUNT = CONVERT(MONEY,QTY)*CONVERT(MONEY,MARKET_RATE),INS_CHRG = CONVERT(MONEY,STT),TURN_TAX = CONVERT(MONEY,TURN_TAX),OTHER_CHRG = OTHER_CHRG,  
SEBI_TAX = CONVERT(MONEY,SEBIFEE),BROKER_CHRG = CONVERT(MONEY,STAMPDUTY),SERVICE_TAX = CONVERT(MONEY,SERVICE_TAX),  
TRADE_AMOUNT = CONVERT(MONEY,QTY)*CONVERT(MONEY,MARKET_RATE),BILLFLAG = CONVERT(INT,(CASE WHEN TRADE_TYPE = 'T' THEN BUYSELL+1 ELSE BUYSELL+3 END)),  
SETT_NO = 0,NBROKAPP = CONVERT(MONEY,NET_RATE_PER_UNIT),NSERTAX = CONVERT(MONEY,SERVICE_TAX),  
N_NETRATE = CONVERT(MONEY,(CASE WHEN BUYSELL = 1 THEN MARKET_RATE+NET_RATE_PER_UNIT ELSE MARKET_RATE-NET_RATE_PER_UNIT END)),  
SETT_TYPE = 'F',CONVERT(MONEY,CL_RATE) CL_RATE,PARTICIPANTCODE = MEMID,STATUS = '11',  
CPID = CONVERT(VARCHAR(30),CONVERT(DATETIME, REPLACE(ORDER_TIME,'.0000000','')), 100) ,INSTRUMENT = isnull(DENOMINATOR,'0'),
BOOKTYPE = isnull(NUMERATOR,'0'),BRANCH_ID = 1,  
TMARK = 0,SCHEME = 3,DUMMY1 = 0,DUMMY2 = CONVERT(INT,MARKET_RATE),RESERVED1 = 0,RESERVED2 = 0   
 FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH(NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE
 

   SELECT * INTO #FOSETT 
FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH (NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE
 
--  DELETE FOTRADE_CTCLID WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE+ ' 23:59'

--INSERT INTO FOTRADE_CTCLID
--SELECT DISTINCT REPLACE(ORDER_TIME,'.0000000','') ,ORDER_NO,INST_TYPE,
--LEFT(SCRIP_CD,12),EXPIRYDATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CTCLID,GETDATE()
--FROM INHOUSE_NCE..PCNORDERDETAILS_FO_RTB WITH (NOLOCK) WHERE TRADE_DATE = @SAUDA_DATE


  
DELETE TBL_STAMP_DATA WHERE  SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_STAMP_DATA  
SELECT  SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE = CONVERT(DATETIME,EXPIRYDATE)+' 23:59:59',STRIKE_PRICE,OPTION_TYPE,BUYQTY,SELLQTY,  
BUYAVGRATE,SELLAVGRATE,BUYSTAMP,SELLSTAMP,TOTALSTAMP,L_STATE,LASTRUNDATE = GETDATE()   
 FROM INHOUSE_NCE..TBL_STAMP_DATA_RTB WHERE SAUDA_DATE = @SAUDA_DATE     
   
  
DELETE STT_CLIENTDETAIL WHERE  SAUDA_DATE = @SAUDA_DATE    
  
INSERT INTO  STT_CLIENTDETAIL  
SELECT RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,  
STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT   
 FROM INHOUSE_NCE..STT_CLIENTDETAIL_RTB WHERE SAUDA_DATE = @SAUDA_DATE  
    
     
DELETE FROM CHARGES_DETAIL WHERE CD_SAUDA_DATE = @SAUDA_DATE    
   
INSERT INTO CHARGES_DETAIL    
SELECT  CD_PARTY_CODE = PARTY_CODE,CD_SAUDA_DATE = SAUDA_DATE,CD_CONTRACT_NO = CONTRACT_NO,CD_TRADE_NO = TRADE_NO,CD_ORDER_NO = ORDER_NO,  
CD_INST_TYPE = INST_TYPE,CD_SYMBOL = SYMBOL,CD_EXPIRY_DATE = EXPIRY_DATE +' 23:59',  
CD_OPTION_TYPE = (CASE WHEN OPTION_TYPE = 'XX' THEN '' ELSE OPTION_TYPE END),CD_STRIKE_PRICE = STRIKE_PRICE,CD_AUCTIONPART=AUCTIONPART ,  
CD_MARKETLOT = MARKETLOT,CD_SCHEME_ID = SCHEME_ID,CD_COMPUTATIONLEVEL = COMPUTATIONLEVEL,CD_COMPUTATIONON = COMPUTATIONON,  
CD_COMPUTATIONTYPE = COMPUTATIONTYPE,CD_BUYRATE = BUYRATE,CD_SELLRATE = SELLRATE,CD_TOT_BUYQTY = TOT_BUYQTY,CD_TOT_SELLQTY = TOT_SELLQTY,  
CD_TOT_BUYTURNOVER = TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED = TOT_BUYTURNOVER_ROUNDED,  
CD_TOT_SELLTURNOVER_ROUNDED = TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED = TOT_TURNOVER_ROUNDED,CD_TOT_LOT = TOT_LOT,  
CD_TOT_RES_TURNOVER = TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED = TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT = 0,CD_TOT_BUYBROK = TOT_BUYBROK,  
CD_TOT_SELLBROK = TOT_SELLBROK,CD_TOT_BROK = TOT_BROK,CD_TOT_BUYSERTAX = TOT_BUYSERTAX,CD_TOT_SELLSERTAX = TOT_SELLSERTAX,CD_TOT_SERTAX = TOT_SERTAX,  
CD_TOT_STT = TOT_STT,CD_TOT_TURN_TAX = TOT_TURN_TAX,CD_TOT_OTHER_CHRG = 0,CD_TOT_SEBI_TAX = 0,CD_TOT_STAMPDUTY = 0,CD_EXCH_BUYRATE = EXCH_BUYRATE,  
CD_EXCH_SELLRATE = EXCH_SELLRATE,CD_TIMESTAMP = GETDATE()   
 FROM INHOUSE_NCE..PRORDERWISEDETAILS_FO_RTB WHERE SAUDA_DATE = @SAUDA_DATE AND SYMBOL NOT LIKE '%BROK%'    
    
   
INSERT INTO CHARGES_DETAIL    
SELECT  CD_PARTY_CODE = PARTY_CODE,CD_SAUDA_DATE = SAUDA_DATE,CD_CONTRACT_NO = CONTRACT_NO,CD_TRADE_NO = TRADE_NO,CD_ORDER_NO = ORDER_NO,  
CD_INST_TYPE = INST_TYPE,CD_SYMBOL = 'BROKERAGE',CD_EXPIRY_DATE = EXPIRY_DATE,CD_OPTION_TYPE = OPTION_TYPE,CD_STRIKE_PRICE = STRIKE_PRICE,  
CD_AUCTIONPART = '',CD_MARKETLOT = MARKETLOT,CD_SCHEME_ID = SCHEME_ID,CD_COMPUTATIONLEVEL = COMPUTATIONLEVEL,CD_COMPUTATIONON = COMPUTATIONON,  
CD_COMPUTATIONTYPE = COMPUTATIONTYPE,CD_BUYRATE = BUYRATE,CD_SELLRATE = SELLRATE,CD_TOT_BUYQTY = TOT_BUYQTY,CD_TOT_SELLQTY = TOT_SELLQTY,  
CD_TOT_BUYTURNOVER = TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER = TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED = TOT_BUYTURNOVER_ROUNDED,  
CD_TOT_SELLTURNOVER_ROUNDED = TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER = TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED = TOT_TURNOVER_ROUNDED,CD_TOT_LOT = TOT_LOT,  
CD_TOT_RES_TURNOVER = TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED = TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT = 0,CD_TOT_BUYBROK = TOT_BUYBROK,  
CD_TOT_SELLBROK = TOT_SELLBROK,CD_TOT_BROK = TOT_BROK,CD_TOT_BUYSERTAX = TOT_BUYSERTAX,CD_TOT_SELLSERTAX = TOT_SELLSERTAX,CD_TOT_SERTAX = TOT_SERTAX,  
CD_TOT_STT = TOT_STT,CD_TOT_TURN_TAX = TOT_TURN_TAX,CD_TOT_OTHER_CHRG = 0,CD_TOT_SEBI_TAX = 0,CD_TOT_STAMPDUTY = 0,CD_EXCH_BUYRATE = EXCH_BUYRATE,  
CD_EXCH_SELLRATE = EXCH_SELLRATE,CD_TIMESTAMP = GETDATE()    
 FROM INHOUSE_NCE..PRORDERWISEDETAILS_FO_RTB P WHERE SAUDA_DATE = @SAUDA_DATE  AND SYMBOL LIKE '%BROK%'    
    
--  DECLARE @CONTNO VARCHAR(8)
--SELECT @CONTNO = MAX(CONTRACTNO_SEG) FROM #FOSETT (NOLOCK)  

/* Changes Start  01/03/2024 For Valan */ 
SELECT DISTINCT PARTY_CODE INTO #FOPARTY  FROM INHOUSE_NCE.DBO.FOBILLVALANDATA_RTB WHERE SAUDA_DATE>= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
CREATE INDEX #P ON #FOPARTY(PARTY_CODE)
SELECT DISTINCT CL_CODE,SHORT_NAME,EMAIL,L_STATE INTO #FOCLIENT  FROM CLIENT1 WHERE EXISTS (SELECT PARTY_CODE FROM #FOPARTY WHERE CL_CODE=PARTY_CODE )

CREATE INDEX #P ON #FOClient(CL_CODE)

 SELECT  PARTY_CODE,	PARTY_NAME=SHORT_NAME,	CLIENT_TYPE,	BILLNO,	CONTRACTNO,	INST_TYPE,	SYMBOL,
 EXPIRYDATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),EXPIRYDATE)+' 23:59') ,	OPTION_TYPE,	STRIKE_PRICE,	AUCTIONPART,	
 MATURITYDATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),MATURITYDATE)+' 23:59'),	
 SAUDA_DATE=CONVERT(DATETIME,CONVERT(VARCHAR(11),SAUDA_DATE)+' 23:59'),	ISIN,	PQTY,	SQTY,	PRATE,	SRATE,	PAMT,	SAMT,
 PBROKAMT,	SBROKAMT,	PBILLAMT,	SBILLAMT,	CL_RATE,	CL_CHRG,	EXCL_CHRG,	SERVICE_TAX,	EXSER_TAX,	
 INEXSERFLAG,	SEBI_TAX,	TURN_TAX	,BROKER_NOTE,	INS_CHRG,	OTHER_CHRG,	TRADETYPE,	PARTICIPANTCODE	,TERMINAL_ID,	FAMILY,	FAMILYNAME,	TRADER,	BRANCH_CODE,	SUB_BROKER,
 STATUSNAME,	EXCHANGE,	SEGMENT,	MEMBERTYPE,	COMPANYNAME=L_STATE	,REGION	,UPDATEDATE	,EMAIL= C.EMAIL,SBU,	RELMGR,	GRP,	SECTOR,	
 CMCLOSING,	TRACK,		NUMERATOR	,DENOMINATOR, '' AS RegularLot, AREA
 INTO #FOBILLVALAN
 FROM INHOUSE_NCE.DBO.FOBILLVALANDATA_RTB  B
 LEFT OUTER JOIN #FOCLIENT C ON PARTY_CODE=CL_CODE
 WHERE SAUDA_DATE>= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'

DELETE FROM FOBILLVALAN WHERE SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
 
 INSERT INTO FOBILLVALAN
 SELECT * FROM #FOBILLVALAN

 DELETE FROM FOACCBILL WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'

 INSERT INTO FOACCBILL
 SELECT  PARTY_CODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,START_DATE=START_DATE+ ' 23:59:00' ,END_DATE=END_DATE+ ' 23:59:00' ,
  PAYIN_DATE=PAYIN_DATE+ ' 23:59:00' ,PAYOUT_DATE=PAYOUT_DATE,AMOUNT,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION
 FROM INHOUSE_NCE.DBO.FOACCBILLDATA_RTB WHERE BILLDATE>= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'

 /* Changes End  01/03/2024 */
DECLARE @CONTNO VARCHAR(10)
SELECT @CONTNO= MAX(CONVERT(BIGINT,CONTRACTNO_SEG)) FROM #FOSETT (NOLOCK)
  
IF ISNULL(@CONTNO,0) <> 0 
 BEGIN 

UPDATE CONTGEN SET CONTRACTNO = @CONTNO WHERE @SAUDA_DATE BETWEEN START_DATE AND END_DATE 

END
          
	INSERT INTO INHOUSE_NCE..TBL_RTB_NCEDATA_UPD
		SELECT @SAUDA_DATE,GETDATE()

  
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKBLOCKEDREPORTS
-- --------------------------------------------------

CREATE PROCEDURE V2_CHECKBLOCKEDREPORTS
                @RPTPATH VARCHAR(100)
                
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SET NOCOUNT ON
        
  IF (SELECT COUNT(1)
      FROM   TBLREPORTS_BLOCKED WITH (NOLOCK)
      WHERE  BLOCK_FLAG = 1
             AND LTRIM(RTRIM(FLDPATH)) = left(LTRIM(RTRIM(@RPTPATH)),len(FLDPATH))) > 0 
  BEGIN 
    SELECT '<font color = red><b>This Option has been disabled temporarily!! Please contact System Administrator!!</b></font>'
  END 
  ELSE 
  BEGIN 
    SELECT '' 
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKPROCESSFORTODAY
-- --------------------------------------------------

CREATE  PROC [dbo].[V2_CHECKPROCESSFORTODAY]  
(  
           @PROCESSFLAG VARCHAR(15),  
    @PROCESSDATE VARCHAR(11)  
)  
AS  

DECLARE @VBBFLAG INT

SELECT @VBBFLAG = 0
IF (SELECT ISNULL(COUNT(1),0) FROM (SELECT TOP 1 SP_PARTY_CODE FROM SCHEME_MAPPING) A) > 0 
	SELECT @VBBFLAG = 1

 SELECT FLAG = (CASE   
                   WHEN @PROCESSFLAG = 'VBB'  
                        AND IMPORT_TRADE > 0 THEN 1  
                   WHEN (@PROCESSFLAG = 'BILLGEN' OR @PROCESSFLAG = 'VALANGEN')
                        AND PositionFile > 0 AND VBB >= @VBBFLAG THEN 1  
                   WHEN @PROCESSFLAG = 'CONTRACT'  
                        AND IMPORT_TRADE > 0  AND VBB >= @VBBFLAG THEN 1  
                   WHEN @PROCESSFLAG = 'POSTING'  
                        AND BILLING > 0 THEN 1  
                   WHEN @PROCESSFLAG = 'CLOSE'  
                        AND POSTING > 0 THEN 1  
                   ELSE 0  
                 END),  
         PROCESSNAME = (CASE   
                          WHEN @PROCESSFLAG = 'VBB' THEN 'IMPORT_TRADE'  
                          WHEN @PROCESSFLAG = 'STT' THEN 'IMPORT_TRADE'  
                          WHEN (@PROCESSFLAG = 'BILLGEN' OR @PROCESSFLAG = 'VALANGEN') THEN 
							   (CASE WHEN VBB < @VBBFLAG 
									 THEN 'VBB PROCESS'
									 ELSE 'POSITION FILE'  
							    END)			
                          WHEN @PROCESSFLAG = 'CONTRACT' THEN
								(CASE WHEN VBB < @VBBFLAG 
									 THEN 'VBB PROCESS'
									 ELSE 'BILLGEN'  
							    END)  
                          WHEN @PROCESSFLAG = 'POSTING' THEN 'CONTRACT'  
                          WHEN @PROCESSFLAG = 'CLOSE' THEN 'POSTING'  
                          ELSE 'SOME PROCESS'  
                        END)  
  FROM     
 V2_BUSINESS_PROCESS  
  WHERE    
 LEFT(BUSINESS_DATE,11) = @PROCESSDATE  
 AND OPEN_CLOSE = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONFIRMATION
-- --------------------------------------------------


--EXEC V2_CONFIRMATION '','','ALWIND0001','ALWIND0001','FEB  2 2006','BROKER','BROKER'
  
CREATE  PROCEDURE [dbo].[V2_CONFIRMATION]
	(
	@fBranch varchar(10),  
	@fSubBroker varchar(10),  
	@fpartycode varchar(16),  
	@tpartycode varchar(16),  
	@fdatefrom  varchar(11),  
	@statusid varchar(15),  
	@statusname varchar(25)
	)
  
	AS  

	IF LEN(@fBranch) > 0 OR @fBranch <> ''
		SET @fBranch = @fBranch
	ELSE
		SET @fBranch = '%'
	
	
	IF LEN(@fSubBroker) > 0 OR @fSubBroker <> ''
		SET @fSubBroker = @fSubBroker
	ELSE
		SET @fSubBroker = '%'


	DECLARE @MYRECCOUNT INT 
	Set @MYRECCOUNT = 0 


	SELECT  
		C2.PARTY_CODE,   
		C1.Long_Name,
                C1.L_ADDRESS1, 
                C1.L_ADDRESS2, 
                C1.L_ADDRESS3, 
                C1.L_CITY, 
                C1.L_STATE, 
                C1.L_ZIP, 
                C1.BRANCH_CD , 
                C1.SUB_BROKER, 
                C1.TRADER, 
                C1.PAN_GIR_NO, 
                C1.RES_PHONE1, 
                C1.RES_PHONE2,
	        C2.SERVICE_CHRG,   
	        BROKERNOTE,   
	        TURNOVER_TAX,   
	        SEBI_TURN_TAX,   
	        C2.OTHER_CHRG,   
	        INSURANCE_CHRG
  
	INTO    
		#CLIENTMASTER   
	FROM    
		CLIENT1 C1   
	WITH   
	        (   
	                NOLOCK   
	        )   
	        ,   
	        CLIENT2 C2   
	WITH   
	        (   
	                NOLOCK   
	        )   

	WHERE   
		C2.CL_CODE = C1.CL_CODE   
	        AND C2.PARTY_CODE BETWEEN @fpartycode AND @tpartycode   
	        AND @STATUSNAME = (   
	        CASE   
	                WHEN @STATUSID = 'BRANCH'   
	                THEN C1.BRANCH_CD   
	                WHEN @STATUSID = 'SUBBROKER'   
	                THEN C1.SUB_BROKER   
	                WHEN @STATUSID = 'TRADER'   
	                THEN C1.TRADER   
	                WHEN @STATUSID = 'FAMILY'   
	                THEN C1.FAMILY   
	                WHEN @STATUSID = 'AREA'   
	                THEN C1.AREA   
	                WHEN @STATUSID = 'REGION'   
	                THEN C1.REGION   
	                WHEN @STATUSID = 'CLIENT'   
	                THEN C2.PARTY_CODE   
	                ELSE 'BROKER' END)   
		AND BRANCH_CD like @fBranch   
		AND SUB_BROKER like @fSubBroker  


---===================================================================---


	SELECT 
		ORDER_NO = (CASE WHEN Auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 2 
				THEN 'Exercise'  
 				WHEN auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 1 
				THEN 'Assignment'
 				ELSE order_no END),  
 		Trade_no = Pradnya.dbo.ReplaceTradeNo(Trade_no), 
		TradeTime = Convert(Varchar,Sauda_date,108),
		TradeQty,
		Price = isnull(price,0),
 		Pqty = (Case When Sell_Buy=1 Then TradeQty ELse 0 ENd),  
 		Sqty = (Case When Sell_Buy=2 Then TradeQty ELse 0 ENd),

 		Brokapplied = convert(money, isnull(brokapplied +   
                	(CASE WHEN C.service_chrg = 1 
				THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
				ELSE 0 END),0)),  
 		Totbrokapplied =  convert(money,isnull((brokapplied * TradeQty * BOOKTYPE/INSTRUMENT) +  
	  			(CASE WHEN C.service_chrg = 1 
					THEN isnull(f.service_tax,0) 
					ELSE 0 END),0)),  
		NETRATE = (CASE WHEN sell_buy =1 
				THEN isnull(netrate + 
					(CASE WHEN C.service_chrg = 1 
						THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
						ELSE 0 END),0)   
				ELSE isnull(netrate -
					(CASE WHEN C.service_chrg = 1 
						THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
						ELSE 0 END),0)
				END),  
 		INST_TYPE = f.inst_type, 
		SYMBOL = f.symbol,  
 		AMT = (CASE WHEN sell_buy = 1 
				THEN -((tradeqty * netrate * BOOKTYPE/INSTRUMENT) +
					(CASE WHEN C.service_chrg = 1 
						THEN isnull((f.service_tax),0) 
						ELSE (CASE WHEN C.service_chrg = 0 
						THEN 0 
						ELSE (CASE WHEN C.service_chrg = 2 
						THEN 0 ELSE 0 END) END ) END ))  
 				ELSE (tradeqty * netrate * BOOKTYPE/INSTRUMENT) -  
               				(CASE WHEN C.service_chrg = 1 
						THEN isnull((f.service_tax),0) 
						ELSE (CASE WHEN C.service_chrg = 0 
						THEN 0 
						ELSE (CASE WHEN C.service_chrg = 2 
						THEN 0 ELSE 0 END ) END ) END) 
				END),
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,f.expirydate,106),11),
		EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR,f.expirydate,101),11),
 		f.party_code,
		sell_buy = (Case When Sell_Buy=1 Then 'B' Else 'S' End),
		CONTRACTNO,
		SAUDA_DATE = convert(varchar,sauda_date,103),
 		STRIKE_PRICE = isnull(f.strike_price,0), 
		f.option_type,  
        	YY = year(sauda_date),
		MM = month(sauda_date),
		DD = day(sauda_date),  
		service_tax = 	(CASE WHEN C.service_chrg = 0 
					THEN (f.service_tax) 
					ELSE 0   
					END),  
		broker_chrg = 	(CASE WHEN BrokerNote = 1   
					THEN (Broker_chrg)  
					ELSE 0   
					END),  
		turn_tax =	(CASE WHEN Turnover_tax = 1
					THEN (turn_tax)    
					ELSE 0   
					END),  
		Sebi_tax =	(CASE WHEN Sebi_Turn_tax = 1   
					THEN (sebi_tax)    
					ELSE 0   
					END),  
		Insurance_Chrg =(CASE WHEN Insurance_Chrg = 1  
					THEN (Ins_chrg)  
					ELSE 0  
					END),   
		OTHER_CHRG = 	(CASE WHEN C.OTHER_CHRG = 1  
					THEN (f.OTHER_CHRG)  
					ELSE 0  
					END),   
		STAX = FoGlobals.Service_Tax,
		CESSTAX = FoGlobals.Cess_Tax,
		PARTYNAME = C.Long_Name,
                C.L_ADDRESS1, 
                C.L_ADDRESS2, 
                C.L_ADDRESS3, 
                C.L_CITY, 
                C.L_STATE, 
                C.L_ZIP, 
                C.BRANCH_CD , 
                C.SUB_BROKER, 
                C.TRADER, 
                C.PAN_GIR_NO, 
                C.RES_PHONE1, 
                C.RES_PHONE2,
		Participantcode,
		User_Id  

	INTO 	#CONFIRMATION_TEMP
	FROM 
		FOSETTLEMENT F (NOLOCK), 
		#CLIENTMASTER C (NOLOCK),
		FOSCRIP2 FOS2 (NOLOCK), 
		FoGlobals (NOLOCK)  

 	WHERE 
		f.Symbol = fos2.Symbol 
		AND f.Inst_type = fos2.Inst_Type   
		AND f.Expirydate = fos2.Expirydate 
		AND f.Strike_price = fos2.Strike_price   
		AND f.Option_type = fos2.Option_type   
		AND f.party_code >= @fpartycode 
		AND f.party_code <= @tpartycode   
		AND sauda_date LIKE @fdatefrom +'%'
		AND tradeqty <> 0 
		AND f.party_code = C.party_code 
		AND f.auctionpart <> 'CA'  
		AND f.sauda_date between year_start_dt and year_end_dt    



SELECT @MYRECCOUNT = COUNT(1) 
FROM Pradnya.Dbo.DataIn_History_Fosettlement_NCDX 
WHERE Sauda_date = @fdatefrom
  

IF @MYRECCOUNT > 0  
BEGIN

 	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
 
	INSERT   
	INTO #CONFIRMATION_TEMP
	SELECT 
		ORDER_NO = (CASE WHEN Auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 2 
				THEN 'Exercise'  
 				WHEN auctionpart = 'EA' and f.inst_type like 'OPT%' and sell_buy = 1 
				THEN 'Assignment'
 				ELSE order_no END),  
 		Trade_no = Pradnya.dbo.ReplaceTradeNo(Trade_no), 
		TradeTime = Convert(Varchar,Sauda_date,108),
		TradeQty,
		Price = isnull(price,0),
 		Pqty = (Case When Sell_Buy=1 Then TradeQty ELse 0 ENd),  
 		Sqty = (Case When Sell_Buy=2 Then TradeQty ELse 0 ENd),

 		Brokapplied = convert(money, isnull(brokapplied +   
                	(CASE WHEN C.service_chrg = 1 
				THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
				ELSE 0 END),0)),  
 		Totbrokapplied =  convert(money,isnull((brokapplied * TradeQty * BOOKTYPE/INSTRUMENT) +  
	  			(CASE WHEN C.service_chrg = 1 
					THEN isnull(f.service_tax,0) 
					ELSE 0 END),0)),  
		NETRATE = (CASE WHEN sell_buy =1 
				THEN isnull(netrate + 
					(CASE WHEN C.service_chrg = 1 
						THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
						ELSE 0 END),0)   
				ELSE isnull(netrate -
					(CASE WHEN C.service_chrg = 1 
						THEN isnull(((F.service_tax * INSTRUMENT/BOOKTYPE)/TradeQty),0) 
						ELSE 0 END),0)
				END),  
 		INST_TYPE = f.inst_type, 
		SYMBOL = f.symbol,  
 		AMT = (CASE WHEN sell_buy = 1 
				THEN -((tradeqty * netrate * BOOKTYPE/INSTRUMENT) +
					(CASE WHEN C.service_chrg = 1 
						THEN isnull((f.service_tax),0) 
						ELSE (CASE WHEN C.service_chrg = 0 
						THEN 0 
						ELSE (CASE WHEN C.service_chrg = 2 
						THEN 0 ELSE 0 END) END ) END ))  
 				ELSE (tradeqty * netrate * BOOKTYPE/INSTRUMENT) -  
               				(CASE WHEN C.service_chrg = 1 
						THEN isnull((f.service_tax),0) 
						ELSE (CASE WHEN C.service_chrg = 0 
						THEN 0 
						ELSE (CASE WHEN C.service_chrg = 2 
						THEN 0 ELSE 0 END ) END ) END) 
				END),
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,f.expirydate,106),11),
		EXPIRYDATE_ANX = LEFT(CONVERT(VARCHAR,f.expirydate,101),11),
 		f.party_code,
		sell_buy = (Case When Sell_Buy=1 Then 'B' Else 'S' End),
		CONTRACTNO,
		SAUDA_DATE = convert(varchar,sauda_date,103),
 		STRIKE_PRICE = isnull(f.strike_price,0), 
		f.option_type,  
        	YY = year(sauda_date),
		MM = month(sauda_date),
		DD = day(sauda_date),  
		service_tax = 	(CASE WHEN C.service_chrg = 0 
					THEN (f.service_tax) 
					ELSE 0   
					END),  
		broker_chrg = 	(CASE WHEN BrokerNote = 1   
					THEN (Broker_chrg)  
					ELSE 0   
					END),  
		turn_tax =	(CASE WHEN Turnover_tax = 1
					THEN (turn_tax)    
					ELSE 0   
					END),  
		Sebi_tax =	(CASE WHEN Sebi_Turn_tax = 1   
					THEN (sebi_tax)    
					ELSE 0   
					END),  
		Insurance_Chrg =(CASE WHEN Insurance_Chrg = 1  
					THEN (Ins_chrg)  
					ELSE 0  
					END),   
		OTHER_CHRG = 	(CASE WHEN C.OTHER_CHRG = 1  
					THEN (f.OTHER_CHRG)  
					ELSE 0  
					END),   
		STAX = FoGlobals.Service_Tax,
		CESSTAX = FoGlobals.Cess_Tax,
		PARTYNAME = C.Long_Name,
                C.L_ADDRESS1, 
                C.L_ADDRESS2, 
                C.L_ADDRESS3, 
                C.L_CITY, 
                C.L_STATE, 
                C.L_ZIP, 
                C.BRANCH_CD , 
                C.SUB_BROKER, 
                C.TRADER, 
                C.PAN_GIR_NO, 
                C.RES_PHONE1, 
                C.RES_PHONE2,
		Participantcode,
		User_Id  

	FROM 
		PRADNYA.DBO.HISTORY_FOSETTLEMENT_NCDX F (NOLOCK), 
		#CLIENTMASTER C (NOLOCK),
		FOSCRIP2 FOS2 (NOLOCK), 
		FoGlobals (NOLOCK)  

 	WHERE 
		f.Symbol = fos2.Symbol 
		AND f.Inst_type = fos2.Inst_Type   
		AND f.Expirydate = fos2.Expirydate 
		AND f.Strike_price = fos2.Strike_price   
		AND f.Option_type = fos2.Option_type   
		AND f.party_code >= @fpartycode 
		AND f.party_code <= @tpartycode   
		AND sauda_date LIKE @fdatefrom +'%'
		AND tradeqty <> 0 
		AND f.party_code = C.party_code 
		AND f.auctionpart <> 'CA'  
		AND f.sauda_date between year_start_dt and year_end_dt    


END
---===================================================================---

	SELECT 
		Order_No = Order_No,  
 		Trade_no = Trade_no, 
		TradeTime = TradeTime,
		Tradeqty = Sum(Tradeqty),
		Price = SUM(PRICE*TRADEQTY)/SUM(TRADEQTY),
 		Pqty = SUM(Pqty),  
 		Sqty = SUM(Sqty),  
 		Brokapplied = SUM(Brokapplied),  
 		Totbrokapplied =  SUM(Totbrokapplied),  
		NETRATE = SUM(NETRATE * TRADEQTY)/SUM(TRADEQTY),  
 		INST_TYPE = INST_TYPE, 
		SYMBOL = SYMBOL,  
 		Amt = SUM(Amt),  
		EXPIRYDATE = EXPIRYDATE,
		EXPIRYDATE_ANX = EXPIRYDATE_ANX,
 		PARTY_CODE = PARTY_CODE,
		SELL_BUY = SELL_BUY,
		CONTRACTNO = CONTRACTNO,
		SAUDA_DATE = SAUDA_DATE,
 		STRIKE_PRICE = STRIKE_PRICE, 
		OPTION_TYPE = OPTION_TYPE,  
        	YY,
		MM,
		DD,  
		service_tax = 	SUM(service_tax),  
		broker_chrg = 	SUM(broker_chrg),  
		turn_tax =	SUM(turn_tax),  
		Sebi_tax =	SUM(Sebi_tax),  
		Insurance_Chrg =SUM(Insurance_Chrg),   
		OTHER_CHRG = 	SUM(OTHER_CHRG),   
		STAX = STAX,
		CESSTAX = CESSTAX,    
		PARTYNAME,
                L_ADDRESS1, 
                L_ADDRESS2, 
                L_ADDRESS3, 
                L_CITY, 
                L_STATE, 
                L_ZIP, 
                BRANCH_CD , 
                SUB_BROKER, 
                TRADER, 
                PAN_GIR_NO, 
                RES_PHONE1, 
                RES_PHONE2,
		Participantcode,
		User_Id        

	INTO 	#CONFIRMATION
	FROM 
		#CONFIRMATION_TEMP (NOLOCK)

	GROUP BY
		Order_No,
 		Trade_no,
		TradeTime,
 		INST_TYPE,
		SYMBOL,
		EXPIRYDATE,
		EXPIRYDATE_ANX,
 		PARTY_CODE,
		SELL_BUY,
		CONTRACTNO,
		SAUDA_DATE,
 		STRIKE_PRICE,
		OPTION_TYPE,
        	YY,
		MM,
		DD,
		STAX,
		CESSTAX,
		PARTYNAME,
                L_ADDRESS1, 
                L_ADDRESS2, 
                L_ADDRESS3, 
                L_CITY, 
                L_STATE, 
                L_ZIP, 
                BRANCH_CD , 
                SUB_BROKER, 
                TRADER, 
                PAN_GIR_NO, 
                RES_PHONE1, 
                RES_PHONE2,
		Participantcode,
		User_Id

---===================================================================---


	UPDATE   
 		#CONFIRMATION  
		SET  
		NetRate = (Case When Sell_Buy = 'B'   
				Then NetRate + CD_Tot_BuyBrok/TradeQty + 
				Case When Service_Chrg = 1 
				     Then CD_Tot_BuySerTax/TradeQty
				     Else 0 
				End
				Else NetRate - CD_Tot_SellBrok/TradeQty -
				Case When Service_Chrg = 1 
				     Then CD_Tot_SellSerTax/TradeQty
				     Else 0 
				End
				End),
 		Totbrokapplied = (Case When Sell_Buy = 'B' 
				Then CD_Tot_BuyBrok 
				Else CD_Tot_SellBrok 
				End + 	
				Case When Service_Chrg = 1 
					Then Case When Sell_Buy = 'B' 
					Then CD_Tot_BuySerTax 
					Else CD_Tot_SellSerTax 
					End  
        			Else 0 End),  
 		Service_Tax = Service_Tax+  (Case When Service_Chrg = 0 
				Then Case When Sell_Buy = 'B' 
				Then CD_Tot_BuySerTax 
				Else CD_Tot_SellSerTax 
				End  
				Else 0 End),
		Amt 	= (Case When Sell_Buy = 'B'     
		 		Then NetRate*TradeQty + CD_Tot_BuyBrok +   
		   			Case When Service_Chrg = 1   
		      			Then CD_Tot_BuySerTax  
		      			Else 0   
					End
		 		Else NetRate*TradeQty - CD_Tot_SellBrok -  
		  			Case When Service_Chrg = 1   
		      			Then CD_Tot_SellSerTax  
		      			Else 0   
					End
				End)

	FROM  
		CHARGES_DETAIL D (NOLOCK),
		#CLIENTMASTER C (NOLOCK)  
	
	WHERE  
		Convert(Varchar,CD_Sauda_Date,103) = Convert(Varchar,Sauda_Date,103)  
		And CD_Party_Code = C.Party_Code
		And CD_Party_Code = #CONFIRMATION.Party_Code   
		And CD_Inst_Type = Inst_Type
		And CD_Symbol = Symbol  
		And Convert(Varchar,CD_Expiry_Date,106) = ExpiryDate  
		And CD_Option_Type = Option_Type  
		And CD_Strike_Price = Strike_Price  
		And CD_Trade_No = Trade_No  
		And CD_Order_No = (Case When Order_No = 'Exercise' or Order_No = 'Assignment' 
					Then CD_Order_No 
					Else Order_no End)

---===================================================================---

	INSERT INTO #CONFIRMATION
	SELECT 
		Order_No = CD_order_no,  
 		Trade_no = CD_Trade_no, 
		TradeTime = '',
		Tradeqty = 0,
		Price = 0,
 		Pqty = 0,
 		Sqty = 0,
 		Brokapplied = 0,
 		Totbrokapplied =  CD_Tot_BuyBrok + (Case When Service_Chrg = 1 
					Then CD_Tot_BuySerTax
					Else 0 End),  
		NETRATE = 0,  
 		INST_TYPE = CD_inst_type,
		SYMBOL = (Case When CD_Symbol = '' 
				Then 'CONT BROK' 
				Else CD_symbol 
				End),  
 		Amt = 0,
  		EXPIRYDATE = (Case When CD_Symbol = '' 
				Then '' 
				Else LEFT(CONVERT(VARCHAR,cd_expiry_date,106),11) 
				End),
		EXPIRYDATE_ANX = (Case When CD_Symbol = '' 
				Then '' 
				Else LEFT(CONVERT(VARCHAR,cd_expiry_date,101),11) 
				End),
 		Party_Code = CD_party_code,
		sell_buy = 'B',
		contractno = CD_contract_no,
		SAUDA_DATE = convert(varchar,CD_sauda_date,103),
 		STRIKE_PRICE = isnull(f.cd_strike_price,0), 
		option_type = CD_option_type,  
        	YY = year(CD_sauda_date),
		MM = month(CD_sauda_date),
		DD = day(CD_sauda_date),  
		service_tax = 	(Case When Service_Chrg = 0 
					Then CD_Tot_BuySerTax   
   					Else 0 
					End),  
		broker_chrg = 0,  
		turn_tax = 0,  
		Sebi_tax = 0,  
		Insurance_Chrg = 0,   
		OTHER_CHRG = 0,   
		STAX = 0,
		CESSTAX = 0,
		PARTYNAME = C.Long_Name,
                C.L_ADDRESS1, 
                C.L_ADDRESS2, 
                C.L_ADDRESS3, 
                C.L_CITY, 
                C.L_STATE, 
                C.L_ZIP, 
                C.BRANCH_CD , 
                C.SUB_BROKER, 
                C.TRADER, 
                C.PAN_GIR_NO, 
                C.RES_PHONE1, 
                C.RES_PHONE2,
		Participantcode = '',
		User_Id = ''

	FROM    
		CHARGES_DETAIL F,   
	        #CLIENTMASTER C   

	WHERE   
		CD_Sauda_Date Like @fdatefrom + '%'  
	 	And CD_party_code >= '0'   
	        AND CD_party_code <= 'zz'   
	        AND CD_contract_no BETWEEN (   
	        CASE   
	                WHEN CD_inst_type like 'opt%'   
	                AND CD_AuctionPart ='EA'   
	                THEN 0   
	                ELSE '0' END)   
	        AND '9999'   
	        AND CD_party_code=C.party_code  
	 	And CD_Trade_No = ''  
	 	And CD_Tot_BuyBrok > 0


---===================================================================---


	INSERT INTO #CONFIRMATION
	SELECT 
		Order_No = CD_order_no,  
 		Trade_no = CD_Trade_no, 
		TradeTime = '',
		Tradeqty = 0,
		Price = 0,
 		Pqty = 0,
 		Sqty = 0,
 		Brokapplied = 0,
 		Totbrokapplied =  CD_Tot_SellBrok   
      				+ (Case When Service_Chrg = 1 
				Then CD_Tot_SellSerTax   
   				Else 0 End),  
		NETRATE = 0,  
 		INST_TYPE = CD_inst_type,
		SYMBOL = (Case When CD_Symbol = '' 
				Then 'CONT BROK' 
				Else CD_symbol 
				End),  
 		Amt = 0,
  		EXPIRYDATE = (Case When CD_Symbol = '' 
				Then '' 
				Else LEFT(CONVERT(VARCHAR,cd_expiry_date,106),11) 
				End),
		EXPIRYDATE_ANX = (Case When CD_Symbol = '' 
				Then '' 
				Else LEFT(CONVERT(VARCHAR,cd_expiry_date,101),11) 
				End),
 		Party_Code = CD_party_code,
		sell_buy = 'S',
		contractno = CD_contract_no,
		SAUDA_DATE = convert(varchar,CD_sauda_date,103),
 		STRIKE_PRICE = isnull(f.cd_strike_price,0), 
		option_type = CD_option_type,  
        	YY = year(CD_sauda_date),
		MM = month(CD_sauda_date),
		DD = day(CD_sauda_date),  
		service_tax = (Case When Service_Chrg = 0 
				Then CD_Tot_SellSerTax   
   				Else 0 End),  
		broker_chrg = 0,  
		turn_tax = 0,  
		Sebi_tax = 0,  
		Insurance_Chrg = 0,   
		OTHER_CHRG = 0,   
		STAX = 0,
		CESSTAX = 0,
		PARTYNAME = C.Long_Name,
                C.L_ADDRESS1, 
                C.L_ADDRESS2, 
                C.L_ADDRESS3, 
                C.L_CITY, 
                C.L_STATE, 
                C.L_ZIP, 
                C.BRANCH_CD , 
                C.SUB_BROKER, 
                C.TRADER, 
                C.PAN_GIR_NO, 
                C.RES_PHONE1, 
                C.RES_PHONE2,
		Participantcode = '',
		User_Id = ''  

	FROM    
		CHARGES_DETAIL F,
        	#CLIENTMASTER C
	WHERE   
		CD_Sauda_Date Like @fdatefrom + '%'  
 		And CD_party_code >= '0'   
	        AND CD_party_code <= 'zz'   
	        AND CD_contract_no BETWEEN (   
	        CASE   
	                WHEN CD_inst_type like 'opt%'   
	                AND CD_AuctionPart ='EA'   
	                THEN 0   
	                ELSE '0' END)   
	        AND '9999'   
	        AND CD_party_code=C.party_code  
		And CD_Trade_No = ''  
		And CD_Tot_SellBrok > 0   


---===================================================================---


        SET NOCOUNT ON 
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	
	SELECT 
		* 
	FROM 
		#CONFIRMATION	
	ORDER BY 
		YY,
		MM,
		DD,
		party_code,
		inst_type, 
		symbol, 
		option_type, 
		strike_price, 
		sell_buy,
		Order_no,
		Trade_No

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ContractPrint_NCX
-- --------------------------------------------------


CREATE  PROCEDURE [dbo].[V2_ContractPrint_NCX]

(  
	 @STATUSID VARCHAR(15),  
	 @STATUSNAME VARCHAR(25),   
	 @SAUDA_DATE VARCHAR(11),   
	 @FROMPARTY_CODE VARCHAR(10),   
	 @TOPARTY_CODE VARCHAR(10),   
	 @FROMBRANCH VARCHAR(10),   
	 @TOBRANCH VARCHAR(10),   
	 @FROMSUB_BROKER VARCHAR(10),   
	 @TOSUB_BROKER VARCHAR(10),   
	 @FROMCONTRACTNO VARCHAR(12),   
	 @TOCONTRACTNO VARCHAR(12),   
	 @CONTFLAG VARCHAR(10),
	 @CLIENTTYPE VARCHAR(30)

)   

AS  

if @TOPARTY_CODE='' Begin Set @TOPARTY_CODE='zzzzzzz' End
if @FROMBRANCH='ALL' Begin Set @FROMBRANCH='' End
if @TOBRANCH='' or  @TOBRANCH='ALL' Begin Set @TOBRANCH='zzzzzzz' End
if @FROMSUB_BROKER='ALL' Begin Set @FROMSUB_BROKER='' End
if @TOSUB_BROKER='' or @TOSUB_BROKER='ALL' Begin Set @TOSUB_BROKER='zzzzzzz' End
if @FROMCONTRACTNO = '' Begin Set @FROMCONTRACTNO = 0   End  
if @TOCONTRACTNO = '' Begin Set @TOCONTRACTNO = 99999999   End  
if @CONTFLAG ='' Begin Set @CONTFLAG ='CONTRACT' End

/*------------------  CANNED CONTRACT PLUG IN ------------------------*/

IF EXISTS (SELECT TOP 1 PARTY_CODE FROM CONTRACT_DATA (nolock) WHERE SAUDA_DATE >= @SAUDA_DATE)
BEGIN
	EXEC V2_CONTSECTION_DETAIL @STATUSID,@STATUSNAME,@SAUDA_DATE,@FROMPARTY_CODE,@TOPARTY_CODE,@FROMBRANCH,@TOBRANCH,@FROMSUB_BROKER,@TOSUB_BROKER,@FROMCONTRACTNO,@TOCONTRACTNO,@CONTFLAG,@CLIENTTYPE
	RETURN
END 



/*---------------------------------------------------------------------*/

Create Table #FoSettlement
(
	Sauda_Date	DateTime,
	Party_code	varchar(10),
	ContractNo	varchar(14),
	Order_No	varchar(15),
	Trade_no	varchar(10),
	TradeTime	varchar(7),
	Inst_Type	varchar(6),
	Symbol		varchar(12),
	ExpiryDate	DateTime,
	Strike_Price	money,
	Option_Type	varchar(2),
	Sell_Buy	int,
	TradeQty	int,
	Price		money,
	BrokApplied	money,
	TotBrokApplied	money,
	NetRate		money,
	Amt		money,
	NetAmt		money,
	Service_Tax	money,
	broker_chrg	money,
	turn_tax	money,
	Sebi_tax	money,
	Insurance_Chrg	money,
	Other_Chrg	money,
	sTax		money,
	sDateY		int,
	sDateM		int,
	sDateD		int,
	PriceUnit	varchar(20),
	Qty_Unit	varchar(10),
	PrintF		int,
	Cl_Type	Varchar(3),
	Numerator int,
	Denominator int,
	ORDFLG int
)


CREATE INDEX [idxSDt] ON [dbo].[#foSettlement] (Sauda_Date,Party_Code,ContractNo,Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type)

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

Declare @intHistFlag int  
  
Select @intHistFlag = Count(1)   
 from pradnya..DataIn_History_FoSettlement_nce (nolock)
Where   
 Sauda_Date like @SAUDA_DATE + '%'  
  
Set @intHistFlag = Convert(int,isnull(@intHistFlag,0))  
  

INSERT INTO #FoSettlement  
Select
	Sauda_Date,Party_code,ContractNo,Order_No,Trade_no,TradeTime,
	Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,
	TradeQty=Sum(TradeQty),Price,BrokApplied=Min(BrokApplied),
	TotBrokApplied=Sum(TotBrokApplied),NetRate,
	Amt=Sum(Amt),
	NetAmt=Sum(NetAmt),
	Service_Tax=Sum(Service_Tax),
	Broker_Chrg=Sum(Broker_Chrg),
	Turn_Tax=Sum(Turn_Tax),
	Sebi_Tax=Sum(Sebi_Tax),
	Insurance_Chrg=Sum(Insurance_Chrg),
	Other_Chrg=Sum(Other_Chrg),
	sTax,sDateY,sDateM,sDateD,PriceUnit,
	Qty_Unit,PrintF,Cl_Type,
	Numerator,Denominator,ORDFLG=0
From 
(
	Select 
		Sauda_Date = Convert(varchar,sauda_date,106),  
		F.Party_code,ContractNo,Order_No = 
			(case 	when auctionpart = 'EA' AND f.inst_type like 'OPT%' AND sell_buy = 2 then 'Exercise'  
				when auctionpart = 'EA' AND f.inst_type like 'OPT%' AND sell_buy = 1 then 'Assignment'  
				else order_no end),  
		Trade_no = Pradnya.Dbo.ReplaceTradeNo(Trade_no), 
		TradeTime =  right(Sauda_date,7),
		Sell_Buy,TradeQty,Price,  BrokApplied ,  
		TotBrokApplied = brokapplied * TradeQty *  Booktype / Instrument,
		NetRate,f.Inst_Type,f.Symbol,  
		F.ExpiryDate,  
		F.Strike_Price, f.Option_Type,  
		Amt = Tradeqty * Price * Booktype / Instrument,
		NetAmt=(case when sell_buy = 1 then (tradeqty * netrate * booktype / instrument) +  
				(case when c2.service_chrg = 1 then isnull((f.service_tax),0) else  
				(case when c2.service_chrg = 0 then 0 else  
				(case when c2.service_chrg = 2 then 0 else 0 end) end ) end )  
			Else (tradeqty * netrate * booktype / instrument) -  
				(case when c2.service_chrg = 1 then isnull((f.service_tax),0) else  
				(case when c2.service_chrg = 0 then 0 else  
				(case when c2.service_chrg = 2 then 0 else 0 end ) end ) end) end ),  
		Service_Tax =  
			(cASE WHEN c2.service_chrg=0 THEN (f.service_tax) ELSE  
			(CASE WHEN c2.service_chrg=1  THEN 0 ELSE  
			(cASE WHEN c2.service_chrg=2 THEN  0 END) END) END) ,  
		broker_chrg= (Case When BrokerNote = 1   
				Then (Broker_chrg)  
				Else 0   
				End) ,  
		turn_tax=(Case When Turnover_tax = 1   
				Then (turn_tax)    
				Else 0   
				End),  
		Sebi_tax=(Case When Sebi_Turn_tax = 1   
				Then (sebi_tax)    
				Else 0   
				End),  
		Insurance_Chrg = (Case When Insurance_Chrg = 1  
				Then (Ins_chrg)  
				ELse 0  
				End ),   
		Other_Chrg= (Case When C2.Other_Chrg = 1  
				Then (F.Other_Chrg)  
				ELse 0  
				End ),   
		sTax = FoGlobals.Service_Tax,   
		sDateY = year(sauda_date),
		sDateM = month(sauda_date),
		sDateD = day(sauda_date),  
		PriceUnit = isnull(fos2.priceunit,''), 
		Qty_Unit = isnull(fos2.qty_unit,'') ,
		PrintF,Cl_Type,Numerator,Denominator	
	From 
		FoSettlement F (NOLOCK), 
		Client1 c1 (NOLOCK), 
		Client2 c2 (NOLOCK), 
		FoScrip2 fos2 , 
		FoGlobals (NOLOCK),
  		CLIENT_PRINT_SETTINGS  CP (NOLOCK) 
	Where 
		F.Symbol = fos2.Symbol 
		AND f.Inst_type = fos2.Inst_Type   
		AND f.Expirydate = fos2.Expirydate 
		AND f.Strike_price = fos2.Strike_price   
		AND f.Option_type = fos2.Option_type   
		AND f.Party_Code=c2.Party_Code 
		AND c1.Cl_Code = c2.Cl_Code   
		AND TradeQty <> 0 
		AND f.Auctionpart <> 'CA'
		AND f.sauda_date between year_start_dt AND year_end_dt    
		AND f.Party_Code Between @FROMPARTY_CODE AND  @TOPARTY_CODE   
		AND Sauda_Date Like @SAUDA_DATE + '%'  
	        AND BRANCH_CD >= @FROMBRANCH   
	        AND BRANCH_CD <= @TOBRANCH   
	        AND SUB_BROKER >= @FROMSUB_BROKER  
	        AND SUB_BROKER <= @TOSUB_BROKER   
	        AND @STATUSNAME = (
	        CASE
	                WHEN @STATUSID = 'BRANCH'   
	                THEN C1.BRANCH_CD   
	                WHEN @STATUSID = 'SUBBROKER'   
	                THEN C1.SUB_BROKER   
	                WHEN @STATUSID = 'TRADER'   
	                THEN C1.TRADER   
	                WHEN @STATUSID = 'FAMILY'   
	                THEN C1.FAMILY   
	                WHEN @STATUSID = 'AREA'   
	                THEN C1.AREA   
	                WHEN @STATUSID = 'REGION'   
	                THEN C1.REGION   
	                WHEN @STATUSID = 'CLIENT'   
	                THEN C2.PARTY_CODE   
	                ELSE 'BROKER' 
		END)
           AND PRINTF =  CP.PRINT_FLAG
	   AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'
 
	        AND contractno BETWEEN ( 
	        CASE 
	                WHEN F.inst_type like 'opt%' 
	                AND AuctionPart ='EA' 
	                THEN 0 
	                ELSE @FROMCONTRACTNO END) 
	        AND @TOCONTRACTNO 
) FoSett
Group By
	Sauda_Date,Party_code,ContractNo,Order_No,Trade_no,TradeTime,
	Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,Price,
	NetRate,sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,PrintF,Cl_Type,
	Numerator,Denominator

If @intHistFlag > 0   
Begin  
INSERT INTO #FoSettlement  
Select
	Sauda_Date,Party_code,ContractNo,Order_No,Trade_no,TradeTime,
	Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,
	TradeQty=Sum(TradeQty),Price,BrokApplied=Sum(BrokApplied),
	TotBrokApplied=Sum(TotBrokApplied),NetRate,
	Amt=Sum(Amt),
	NetAmt=Sum(NetAmt),
	Service_Tax=Sum(Service_Tax),
	Broker_Chrg=Sum(Broker_Chrg),
	Turn_Tax=Sum(Turn_Tax),
	Sebi_Tax=Sum(Sebi_Tax),
	Insurance_Chrg=Sum(Insurance_Chrg),
	Other_Chrg=Sum(Other_Chrg),
	sTax,sDateY,sDateM,sDateD,PriceUnit,
	Qty_Unit,PrintF,Cl_Type,
	Numerator,Denominator,ORDFLG=0
From 
(
	Select 
		Sauda_Date = Convert(varchar,sauda_date,106),  
		F.Party_code,ContractNo,Order_No = 
			(case 	when auctionpart = 'EA' AND f.inst_type like 'OPT%' AND sell_buy = 2 then 'Exercise'  
				when auctionpart = 'EA' AND f.inst_type like 'OPT%' AND sell_buy = 1 then 'Assignment'  
				else order_no end),  
		Trade_no = Pradnya.Dbo.ReplaceTradeNo(Trade_no), 
		TradeTime =  right(Sauda_date,7),
		Sell_Buy,TradeQty,Price,  BrokApplied ,  
		TotBrokApplied = brokapplied * TradeQty *  Booktype / Instrument,
		NetRate,f.Inst_Type,f.Symbol,  
		F.ExpiryDate,  
		F.Strike_Price, f.Option_Type,  
		Amt = Tradeqty * Price * Booktype / Instrument,
		NetAmt=(case when sell_buy = 1 then (tradeqty * netrate * booktype / instrument) +   
				(case when c2.service_chrg = 1 then isnull((f.service_tax),0) else  
				(case when c2.service_chrg = 0 then 0 else  
				(case when c2.service_chrg = 2 then 0 else 0 end) end ) end )  
			Else (tradeqty * netrate * booktype / instrument) -  
				(case when c2.service_chrg = 1 then isnull((f.service_tax),0) else  
				(case when c2.service_chrg = 0 then 0 else  
				(case when c2.service_chrg = 2 then 0 else 0 end ) end ) end) end ),  
		Service_Tax =  
			(cASE WHEN c2.service_chrg=0 THEN (f.service_tax) ELSE  
			(CASE WHEN c2.service_chrg=1  THEN 0 ELSE  
			(cASE WHEN c2.service_chrg=2 THEN  0 END) END) END) ,  
		broker_chrg= (Case When BrokerNote = 1   
				Then (Broker_chrg)  
				Else 0   
				End) ,  
		turn_tax=(Case When Turnover_tax = 1   
				Then (turn_tax)    
				Else 0   
				End),  
		Sebi_tax=(Case When Sebi_Turn_tax = 1   
				Then (sebi_tax)    
				Else 0   
				End),  
		Insurance_Chrg = (Case When Insurance_Chrg = 1  
				Then (Ins_chrg)  
				ELse 0  
				End ),   
		Other_Chrg= (Case When C2.Other_Chrg = 1  
				Then (F.Other_Chrg)  
				ELse 0  
				End ),   
		sTax = FoGlobals.Service_Tax,   
		sDateY = year(sauda_date),
		sDateM = month(sauda_date),
		sDateD = day(sauda_date),  
		PriceUnit = isnull(fos2.priceunit,''), 
		Qty_Unit = isnull(fos2.qty_unit,'') ,
		PrintF,Cl_Type,Numerator,Denominator	
	From 
		PRADNYA.DBO.HISTORY_FoSettlement_nce F (NOLOCK), 
		Client1 c1 (NOLOCK), 
		Client2 c2 (NOLOCK), 
		FoScrip2 fos2 (NOLOCK) , 
		FoGlobals (NOLOCK)  ,
		CLIENT_PRINT_SETTINGS  CP (NOLOCK) 
	Where 
		F.Symbol = fos2.Symbol 
		AND f.Inst_type = fos2.Inst_Type   
		AND f.Expirydate = fos2.Expirydate 
		AND f.Strike_price = fos2.Strike_price   
		AND f.Option_type = fos2.Option_type   
		AND f.Party_Code=c2.Party_Code 
		AND c1.Cl_Code = c2.Cl_Code   
		AND TradeQty <> 0 
		AND f.Auctionpart <> 'CA'
		AND f.sauda_date between year_start_dt AND year_end_dt    
		AND f.Party_Code Between @FROMPARTY_CODE AND  @TOPARTY_CODE   
		AND Sauda_Date Like @SAUDA_DATE + '%'  
	        AND BRANCH_CD >= @FROMBRANCH   
	        AND BRANCH_CD <= @TOBRANCH   
	        AND SUB_BROKER >= @FROMSUB_BROKER  
	        AND SUB_BROKER <= @TOSUB_BROKER   
	        AND @STATUSNAME = (
	        CASE
	                WHEN @STATUSID = 'BRANCH'   
	                THEN C1.BRANCH_CD   
	                WHEN @STATUSID = 'SUBBROKER'   
	                THEN C1.SUB_BROKER   
	                WHEN @STATUSID = 'TRADER'   
	                THEN C1.TRADER   
	                WHEN @STATUSID = 'FAMILY'   
	                THEN C1.FAMILY   
	                WHEN @STATUSID = 'AREA'   
	                THEN C1.AREA   
	  WHEN @STATUSID = 'REGION'   
	                THEN C1.REGION   
	                WHEN @STATUSID = 'CLIENT'   
	                THEN C2.PARTY_CODE   
	                ELSE 'BROKER' 
		END)
           AND PRINTF =  CP.PRINT_FLAG
	   AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'
	        AND contractno BETWEEN ( 
	        CASE 
	  WHEN F.inst_type like 'opt%' 
	                AND AuctionPart ='EA' 
	                THEN 0 
	                ELSE @FROMCONTRACTNO END) 
	        AND @TOCONTRACTNO 
) FoSett
Group By
	Sauda_Date,Party_code,ContractNo,Order_No,Trade_no,TradeTime,
	Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,Price,
	NetRate,sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,PrintF,Cl_Type,
	Numerator,Denominator
End


Update 
	#FoSettlement
Set
	BrokApplied = Case When Sell_buy = 1 Then  CD_Tot_BuyBrok Else CD_Tot_SellBrok End,
	TotBrokApplied = Case When Sell_buy = 1 Then  CD_Tot_BuyBrok Else CD_Tot_SellBrok End,
	Service_Tax = Service_Tax + (Case When Service_Chrg = 0 Then
			   Case When Sell_Buy =1 then CD_Tot_BuySerTax Else CD_Tot_SellSerTax End
				Else 0 End),
	NetRate = 0,
	Amt = Case When Sell_Buy = 1 Then 
			( TradeQty * Price * Numerator / Denominator )  + CD_Tot_BuyBrok
			+ Case When Service_Chrg = 1 Then isnull((CD_Tot_BuySerTax),0) Else 0 End  
		Else 
			( TradeQty * Price * Numerator / Denominator )  - CD_Tot_SellBrok
			- Case When Service_Chrg = 1 Then isnull((CD_Tot_SellSerTax),0) Else 0 End  
		End
From
	Charges_Detail, Client1, Client2
Where
	Cd_Party_Code = Client2.Party_Code
	And Client1.Cl_Code = Client2.Cl_Code
	And Convert(Varchar,CD_Sauda_Date,103) = Convert(varchar,Sauda_Date,103)
	And Cd_Party_Code = Client2.Party_Code
	And Cd_Inst_Type = Inst_Type
	And Cd_Symbol = Symbol
	And Convert(Varchar,Cd_Expiry_Date,103) = Convert(Varchar,ExpiryDate,103)
	And Cd_Strike_Price = Strike_Price
	And Cd_Option_Type = Option_Type
	And Cd_Trade_No = Trade_No
	And Cd_Order_No = Order_No

Insert Into #FoSettlement
Select 
	Sauda_Date=Convert(Varchar,Cd_Sauda_Date,106),Party_code=Cd_Party_Code,ContractNo=0,
	Order_No=CD_Order_No,Trade_no=CD_Trade_No,TradeTime='',
	Inst_Type=CD_Inst_Type,
	Symbol=(Case When CD_Symbol = '' Then 'CONT BROK' Else CD_symbol End),   
	ExpiryDate=Case When CD_Symbol = '' Then '' Else CD_expiry_date End,
	Strike_Price=Isnull(Cd_Strike_Price,0),
	Option_Type=Cd_Option_Type,
	Sell_Buy=1,TradeQty=0,Price=0,
	BrokApplied= CD_Tot_BuyBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_BuySerTax   
			Else 0 End),  
	TotBrokApplied= CD_Tot_BuyBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_BuySerTax   
			Else 0 End),  
	NetRate=0,
	Amt = 0,
	NetAmt=CD_Tot_BuyBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_BuySerTax   
			Else 0 End),
	Service_Tax=(Case When Service_Chrg = 0 Then   
			   CD_Tot_BuySerTax   
		   Else 0 End),
	Broker_Chrg=0,Turn_Tax=0,Sebi_Tax=0,
	Insurance_Chrg=0,Other_Chrg=0,
	sTax=FoGlobals.Service_Tax,
	sDateY=Year(Cd_Sauda_Date),
	sDateM=Month(Cd_Sauda_Date),
	sDateD=Day(Cd_Sauda_Date),
	PriceUnit='',Qty_Unit='',PrintF=0,Cl_Type,
	Numerator=0,Denominator=0,
	ORDFLG = (Case When CD_Symbol = '' Then 1  Else 0 End )
From 
	Charges_Detail, Client1, Client2, FoGlobals
Where
	Cd_Party_Code = Client2.Party_Code
	And Client1.Cl_Code = Client2.Cl_Code
	And CD_Sauda_Date Between Year_Start_Dt and Year_End_Dt
	And CD_Trade_No = ''  
	And CD_Tot_BuyBrok > 0  
	And 1 = Case When @CLIENTTYPE ='INSTCONTRACT' Then  
			Case When  Cl_Type ='INS' Then 1 Else 0 End
		Else Case When Cl_Type ='INS' Then 0 else 1 End End
	AND Client2.Party_Code Between @FROMPARTY_CODE AND  @TOPARTY_CODE   
	AND Cd_Sauda_Date Like @SAUDA_DATE + '%'  
        AND BRANCH_CD >= @FROMBRANCH   
        AND BRANCH_CD <= @TOBRANCH   
        AND SUB_BROKER >= @FROMSUB_BROKER  
        AND SUB_BROKER <= @TOSUB_BROKER   
        AND @STATUSNAME = (
        CASE
                WHEN @STATUSID = 'BRANCH'   
                THEN BRANCH_CD   
                WHEN @STATUSID = 'SUBBROKER'   
                THEN SUB_BROKER   
                WHEN @STATUSID = 'TRADER'   
                THEN TRADER   
                WHEN @STATUSID = 'FAMILY'   
                THEN FAMILY   
                WHEN @STATUSID = 'AREA'   
                THEN AREA   
                WHEN @STATUSID = 'REGION'   
                THEN REGION   
                WHEN @STATUSID = 'CLIENT'   
                THEN Client2.PARTY_CODE   
                ELSE 'BROKER' 
	END)
        AND CD_Contract_No BETWEEN ( 
        CASE 
                WHEN Cd_Inst_type like 'opt%' 
                AND CD_AuctionPart ='EA' 
                THEN 0 
                ELSE @FROMCONTRACTNO END) 
        AND @TOCONTRACTNO 



Insert Into #FoSettlement
Select 
	Sauda_Date=Convert(Varchar,Cd_Sauda_Date,106),Party_code=Cd_Party_Code,
	ContractNo=0,Order_No=CD_Order_No,Trade_no=CD_Trade_No,TradeTime='',
	Inst_Type=CD_Inst_Type,
	Symbol=(Case When CD_Symbol = '' Then 'CONT BROK' Else CD_symbol End),   
	ExpiryDate=Case When CD_Symbol = '' Then '' Else CD_expiry_date End,
	Strike_Price=Isnull(Cd_Strike_Price,0),
	Option_Type=Cd_Option_Type,
	Sell_Buy=2,TradeQty=0,Price=0,
	BrokApplied= CD_Tot_SellBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_SellSerTax   
			Else 0 End),  
	TotBrokApplied= CD_Tot_SellBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_SellSerTax   
			Else 0 End),  
	NetRate=0,
	Amt=0,
	NetAmt=CD_Tot_SellBrok +
			(Case When Service_Chrg = 1 Then   
				CD_Tot_SellSerTax   
			Else 0 End),
	Service_Tax=(Case When Service_Chrg = 0 Then   
			   CD_Tot_SellSerTax   
		   Else 0 End),
	Broker_Chrg=0,Turn_Tax=0,Sebi_Tax=0,
	Insurance_Chrg=0,Other_Chrg=0,
	sTax=FoGlobals.Service_Tax,
	sDateY=Year(Cd_Sauda_Date),
	sDateM=Month(Cd_Sauda_Date),
	sDateD=Day(Cd_Sauda_Date),
	PriceUnit='',Qty_Unit='',PrintF=0,Cl_Type,
	Numerator=0,Denominator=0,
	ORDFLG = (Case When CD_Symbol = '' Then 1  Else 0 End )
From 
	Charges_Detail, Client1, Client2, FoGlobals
Where
	Cd_Party_Code = Client2.Party_Code
	And Client1.Cl_Code = Client2.Cl_Code
	And CD_Sauda_Date Between Year_Start_Dt and Year_End_Dt
	And CD_Trade_No = ''  
	And CD_Tot_SellBrok > 0  
	And 1 = Case When @CLIENTTYPE ='INSTCONTRACT' Then  
			Case When  Cl_Type ='INS' Then 1 Else 0 End
		Else Case When Cl_Type ='INS' Then 0 else 1 End End
	AND Client2.Party_Code Between @FROMPARTY_CODE AND  @TOPARTY_CODE   
	AND Cd_Sauda_Date Like @SAUDA_DATE + '%'  
        AND BRANCH_CD >= @FROMBRANCH   
        AND BRANCH_CD <= @TOBRANCH   
        AND SUB_BROKER >= @FROMSUB_BROKER  
        AND SUB_BROKER <= @TOSUB_BROKER   
        AND @STATUSNAME = (
        CASE
                WHEN @STATUSID = 'BRANCH'   
                THEN BRANCH_CD   
                WHEN @STATUSID = 'SUBBROKER'   
                THEN SUB_BROKER   
                WHEN @STATUSID = 'TRADER'   
                THEN TRADER   
                WHEN @STATUSID = 'FAMILY'   
                THEN FAMILY   
                WHEN @STATUSID = 'AREA'   
                THEN AREA   
                WHEN @STATUSID = 'REGION'   
                THEN REGION   
                WHEN @STATUSID = 'CLIENT'   
                THEN Client2.PARTY_CODE   
                ELSE 'BROKER' 
	END)
        AND CD_Contract_No BETWEEN ( 
        CASE 
                WHEN Cd_Inst_type like 'opt%' 
                AND CD_AuctionPart ='EA' 
                THEN 0 
                ELSE @FROMCONTRACTNO END) 
        AND @TOCONTRACTNO 


/*-- UPDATE FOR PARENTCODE ---*/
UPDATE #FoSettlement SET PARTY_CODE = PARENTCODE
FROM CLIENT2_VIEW WHERE #FoSettlement.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
/*-- UPDATE FOR PARENTCODE ---*/


/*Fetching final output*/
Select
	SDT=Convert(Varchar,Sauda_Date,103),
	Sauda_Date= Convert(Varchar,Sauda_Date,103),
	SDateTime = Left(Convert(Varchar,Sauda_Date,109),11) +' '+ TradeTime,
	FoSett.Party_code,ContractNo,
	ORDER_NO = Order_No,
	TRADE_NO = Trade_No,
	TRADETIME = TradeTime,
	SCRIPNAME =
	        CASE 
                WHEN Inst_Type Like 'FUT%' 
                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' + 
			RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
		END,
	PSCRIPNAME = Case When Sell_Buy = 1 Then
		        CASE 
	                WHEN Inst_Type Like 'FUT%' 
	                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
	                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + 
				' ' + RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
			END
		Else '' End,   
	SSCRIPNAME = Case When Sell_Buy = 2 Then
		        CASE 
	                WHEN Inst_Type Like 'FUT%' 
	                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
	                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + 
				' ' + RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
			END
		Else '' End,   
	BUYSELL = Case When Sell_Buy = 1 then 'B' else 'S' end,
	Sell_Buy,
	QTY = TradeQty,
	PQTY = Case When Sell_Buy =1 Then TradeQty Else 0 End,
	SQTY = Case When Sell_Buy =2 Then TradeQty Else 0 End,
	RATE = PRICE,
	PRATE = Case When Sell_Buy =1 Then PRICE Else 0 End,
	SRATE = Case When Sell_Buy =2 Then PRICE Else 0 End,
	BROK = BrokApplied,
	PBROK = Case When Sell_Buy =1 Then BrokApplied Else 0 End,
	SBROK = Case When Sell_Buy =2 Then BrokApplied Else 0 End,
	BROKERAGE = TotBrokApplied,
	PBROKERAGE = Case When Sell_Buy =1 Then TotBrokApplied Else 0 End,
	SBROKERAGE = Case When Sell_Buy =2 Then TotBrokApplied Else 0 End,
	NETRATE = NetRate,
	PNETRATE = Case When Sell_Buy =1 Then NetRate Else 0 End,
	SNETRATE = Case When Sell_Buy =2 Then NetRate Else 0 End,
	MARKETAMT = AMT,
	PMARKETAMT = Case When Sell_Buy =1 Then Amt Else 0 End,
	SMARKETAMT = Case When Sell_Buy =2 Then Amt Else 0 End,
	AMT = NetAmt,
	PAMT = Case When Sell_Buy =1 Then NetAmt Else 0 End,
	SAMT = Case When Sell_Buy =2 Then NetAmt Else 0 End,
	Service_Tax,Broker_Chrg,Turn_Tax,Sebi_Tax,
	PINS_CHRG = CASE WHEN SELL_BUY =1 THEN INS_CHRG ELSE 0 END,      
	SINS_CHRG = CASE WHEN SELL_BUY =2 THEN INS_CHRG ELSE 0 END,      
	INS_CHRG,
	FoSett.Other_Chrg,
	sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,
	PartyName=Long_Name, L_Address1,L_Address2,L_Address3,
	L_city,l_state,L_Zip, Pan_Gir_No,Res_Phone1,Off_Phone1,Off_Phone2,
	Branch_Cd, Sub_Broker ,Trader,client2.Service_Chrg,
	Sebi_No=SebiNo,
	PARTICIPANTCODE = ISNULL(BANKID,''),ORDFLG
From
(
	Select 
		--Sauda_Date,Party_code,ContractNo,Order_No='00000000000',Trade_no='0000000',TradeTime='',
		Sauda_Date,Party_code,ContractNo,Order_No=Min(Order_No),Trade_no=Min(Trade_no),TradeTime=Min(TradeTime),
		Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,
		TradeQty=Sum(TradeQty),
		Price=Sum(TradeQty*Price)/Sum(TradeQty),
		BrokApplied=Sum(BrokApplied),
		TotBrokApplied=Sum(TotBrokApplied),
		NetRate=Sum(NetRate*TradeQty)/Sum(TradeQty),
		Amt=Sum(Amt),
		NetAmt = Sum(NetAmt),
		Service_Tax=Sum(Service_Tax),
		Broker_Chrg=Sum(Broker_Chrg),
		Turn_Tax=Sum(Turn_Tax),
		Sebi_Tax=Sum(Sebi_Tax),
		Ins_chrg=Sum(Insurance_Chrg),
		Other_Chrg = Sum(Other_Chrg),
		sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,
		PrintF,Cl_Type,ORDFLG
	From
		#FoSettlement
	Where
		PrintF = '3' OR Cl_Type ='INS'
	Group by
		Sauda_Date,Party_code,ContractNo,Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,
		Sell_Buy,sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,PrintF,Cl_Type,ORDFLG
	
	Union All
	Select 
		Sauda_Date,Party_code,ContractNo,Order_No,Trade_no,TradeTime,
		Inst_Type,Symbol,ExpiryDate,Strike_Price,Option_Type,Sell_Buy,
		TradeQty,Price,BrokApplied,TotBrokApplied,NetRate,Amt,NetAmt,
		Service_Tax,Broker_Chrg,Turn_Tax,Sebi_Tax,Ins_chrg=Insurance_Chrg,
		Other_Chrg,sTax,sDateY,sDateM,sDateD,PriceUnit,Qty_Unit,PrintF,
		Cl_Type,ORDFLG
	From
		#FoSettlement
	Where
		PrintF <> '3' And Cl_Type <> 'INS'
)FoSett, Client1, Client2, FoOwner
Where
	Client1.Cl_Code = Client2.Cl_Code
	And FoSett.Party_Code = Client2.Party_Code

Order By sDateY,sDateM,sDateD,Branch_Cd, Sub_Broker,FoSett.Party_Code,
OrdFlg, ScripName,Order_No desc,Trade_No desc


Drop Table #FoSettlement

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL
-- --------------------------------------------------


CREATE    PROCEDURE [dbo].[V2_CONTSECTION_DETAIL]

(  
	 @STATUSID VARCHAR(15),  
	 @STATUSNAME VARCHAR(25),   
	 @SAUDA_DATE VARCHAR(11),   
	 @FROMPARTY_CODE VARCHAR(10),   
	 @TOPARTY_CODE VARCHAR(10),   
	 @FROMBRANCH VARCHAR(10),   
	 @TOBRANCH VARCHAR(10),   
	 @FROMSUB_BROKER VARCHAR(10),   
	 @TOSUB_BROKER VARCHAR(10),   
	 @FROMCONTRACTNO VARCHAR(12),   
	 @TOCONTRACTNO VARCHAR(12),   
	 @CONTFLAG VARCHAR(10),
	 @CLIENTTYPE VARCHAR(30)
)   

AS  


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED



Select
	SDT=Convert(Varchar,Sauda_Date,103),
	Sauda_Date= Convert(Varchar,Sauda_Date,103),
	SDateTime = Left(Convert(Varchar,Sauda_Date,109),11) +' '+ TradeTime,
	PARTY_CODE = C2.PARENTCODE,
	ContractNo,
	ORDER_NO = Order_No,
	TRADE_NO = Trade_No,
	TRADETIME = TradeTime,
	SCRIPNAME =
	        CASE 
                WHEN Inst_Type Like 'FUT%' 
                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' + 
			RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
		END,
	PSCRIPNAME = Case When Sell_Buy = 1 Then
		        CASE 
	                WHEN Inst_Type Like 'FUT%' 
	                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
	                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + 
				' ' + RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
			END
		Else '' End,   
	SSCRIPNAME = Case When Sell_Buy = 2 Then
		        CASE 
	                WHEN Inst_Type Like 'FUT%' 
	                THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)     
	                ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + 
				' ' + RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)    
			END
		Else '' End,   
	BUYSELL = Case When Sell_Buy = 1 then 'B' else 'S' end,
	Sell_Buy,
	QTY,
	PQTY,
	SQTY,
	RATE = PRICE,
	PRATE,
	SRATE,
	BROK = PBROK+ SBROK,
	PBROK ,
	SBROK ,
	BROKERAGE,
	PBROKERAGE = Case When Sell_Buy =1 Then BROKERAGE Else 0 End,
	SBROKERAGE = Case When Sell_Buy =2 Then BROKERAGE Else 0 End,
	NETRATE = PNETRATE + SNETRATE,
	PNETRATE,
	SNETRATE,
	MARKETAMT = AMOUNT,
	PMARKETAMT = Case When Sell_Buy =1 Then AMOUNT Else 0 End,
	SMARKETAMT = Case When Sell_Buy =2 Then AMOUNT Else 0 End,
	AMT = NetAmount,
	PAMT = Case When Sell_Buy =1 Then NetAmount Else 0 End,
	SAMT = Case When Sell_Buy =2 Then NetAmount Else 0 End,
	CONTRACT_DATA.Service_Tax,
	Broker_Chrg,
	Turn_Tax,
	Sebi_Tax,
	PINS_CHRG = CASE WHEN SELL_BUY =1 THEN INS_CHRG ELSE 0 END,      
	SINS_CHRG = CASE WHEN SELL_BUY =2 THEN INS_CHRG ELSE 0 END,      
	INS_CHRG,
	CONTRACT_DATA.Other_Chrg,
	sTax = FoGlobals.Service_Tax,
	sDateY = year(sauda_date),
	sDateM = month(sauda_date),
	sDateD = day(sauda_date), 
	PriceUnit,
	Qty_Unit,
	PartyName,
	L_Address1,
	L_Address2,
	L_Address3,
	L_city,
	l_state,
	L_Zip, 
	Pan_Gir_No,
	Res_Phone1='',
	Off_Phone1,
	Off_Phone2,
	Branch_Cd, 
	Sub_Broker = SubBroker ,
	Trader,
	CONTRACT_MASTER.Service_Chrg,
	Sebi_No,
	PARTICIPANTCODE,
	CANNED_DATA =1
FROM
	CONTRACT_MASTER (NOLOCK), CONTRACT_DATA (NOLOCK), FoGlobals (nolock), CLIENT_PRINT_SETTINGS  CP (NOLOCK), CLIENT2_VIEW C2 (NOLOCK) 
WHERE   
	CONTRACT_MASTER.Party_Code = CONTRACT_DATA.Party_Code
	AND C2.PARTY_CODE = CONTRACT_MASTER.Party_Code
	AND left(CONTRACT_MASTER.Trade_Date,11) = left(CONTRACT_DATA.Sauda_Date,11)
	And Sauda_Date Between Year_Start_Dt and Year_End_Dt
	AND 1 <> CASE WHEN @CONTFLAG = 'CONTRACT' THEN CONTRACT_MASTER.PRINTF ELSE 2 END
	AND SAUDA_DATE >= @SAUDA_DATE 
	AND SAUDA_DATE <= @SAUDA_DATE
	AND CONTRACT_MASTER.Party_Code >= @FROMPARTY_CODE 
	AND CONTRACT_MASTER.Party_Code <= @TOPARTY_CODE 
	AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO
	AND BRANCH_CD >= @FROMBRANCH   
	AND BRANCH_CD <= @TOBRANCH   
	AND SUBBROKER >= @FROMSUB_BROKER  
	AND SUBBROKER <= @TOSUB_BROKER   
	AND @STATUSNAME = (
		CASE
		WHEN @STATUSID = 'BRANCH'   
		THEN BRANCH_CD   
		WHEN @STATUSID = 'SUBBROKER'   
		THEN SUBBROKER   
		WHEN @STATUSID = 'TRADER'   
		THEN TRADER   
		WHEN @STATUSID = 'FAMILY'   
		THEN FAMILY   
		WHEN @STATUSID = 'AREA'   
		THEN AREA   
		WHEN @STATUSID = 'REGION'   
		THEN REGION   
		WHEN @STATUSID = 'CLIENT'   
		THEN CONTRACT_MASTER.PARTY_CODE   
		ELSE 'BROKER' 
	END)
           AND CONTRACT_MASTER.PRINTF =  CP.PRINT_FLAG
	   AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'
 
ORDER BY 
	CONTRACTNO DESC, 
	BRANCH_CD,   
	SubBroker,   
	TRADER,   
	C2.PARENTCODE,
	INST_TYPE,   
	SYMBOL,   
	EXPIRYDATE,    
	OPTION_TYPE,   
	STRIKE_PRICE,   
	ORDFLG,  
	ORDER_NO,   
	TRADE_NO  


SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOBillDETAIL
-- --------------------------------------------------
CREATE PROC [dbo].[V2_FOBillDETAIL]        
 (            
 @StatusID VarChar(20),            
 @StatusName VarChar(50),            
 @FromDate VarChar(11),            
 @ToDate VarChar(11),            
 @FromPartyCode VarChar(20),            
 @ToPartyCode VarChar(20),            
 @FROMBRANCH VARCHAR(10),            
 @TOBRANCH VARCHAR(10),            
 @FROMSUB_BROKER VARCHAR(10),            
 @TOSUB_BROKER VARCHAR(10),            
 @ReportMode VARCHAR(20),   -- SUMMARY / DETAIL             
 @intPrintCF int = 0,            
 @ReportOpt Varchar(20) ='',   -- Plain / PRE_PRINT        
 @DIGIFLAG INT = 0        
 )            
      
--EXEC MCDX_Bill '','ALL','zzzzzzzzzz','','zzzzzzzzz','Apr 24 2007','Apr 24 2007','broker','broker'         
--EXEC V2_FOBillDetail 'broker','broker','Apr 24 2007','','000','ZZZ','','','','','SUMMARY',0,'PRE_PRINT',1   

   
    
--DIGITAL    
--EXEC V2_FOBillDetail 'broker','broker','Apr 24 2007','','00','ZZ',  '','','','','SUMMARY','1','',2     
--EXEC V2_FOBillDetail 'broker','broker','Feb 2 2006','Feb 2 2011','00','ZZZ','','zzzzzzzzz','','zzzzzzzzz','SUMMARY','','',2    
--EXEC V2_FOBillDetail 'broker','broker','Feb 2 2006','Feb 2 2011','00','ZZZ','','zzzzzzzzz','','zzzzzzzzz','DETAIL','','',2
--EXEC V2_FOBillDetail 'broker','broker','Feb 2 2006','Feb 2 2011','00','ZZZ','','zzzzzzzzz','','zzzzzzzzz','SUMMARY','','',2    
--EXEC NCDX_Digital_Bill '00','ZZZ','Nov 25 2005','Nov 25 2011','broker','broker','%','%','%'     
      
AS            
        
If @ToPartyCode ='' begin set @ToPartyCode ='zzzzzzzz' end            
If @TOBRANCH ='' begin set @TOBRANCH ='zzzzzzzz' end            
If @TOSUB_BROKER ='' begin set @TOSUB_BROKER ='zzzzzzzzz' end            
If @ToDate = '' begin Set @ToDate = @FromDate End        
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
Select         
 Distinct Party_Code         
 into #PartyList        
From        
 FoBillValan (nolock)        
Where        
 sauda_date >= @FromDate  and  sauda_date <=  @ToDate + ' 23:59'        
 AND party_code >= @FromPartyCode             
 AND party_code <= @ToPartyCode      
    
        
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[#PartyList] ([Party_Code])        
         
Select            
 partyname =C1.Long_Name,            
 C2.party_code,             
 client_type = c1.cl_type,             
 c1.l_address1,             
 c1.l_address2,            
 c1.l_address3,            
 c1.L_city,            
 c1.L_State,            
 c1.L_Nation,            
 c1.L_Zip,            
 C1.OFF_PHONE1,             
 C1.OFF_PHONE2,             
 branch_code = c1.branch_cd,            
 SUB_BROKER = c1.SUB_BROKER,            
 C1.TRADER,            
 C1.PAN_GIR_NO,            
 C2.service_chrg            
Into         
 #ClientMaster            
From            
 CLIENT1 C1 (nolock),        
 CLIENT2 C2 (nolock),        
 CLIENT_PRINT_SETTINGS CP (NOLOCK)        
Where        
 c1.cl_code = c2.cl_code            
 AND party_code >= @FromPartyCode            
 AND party_code <= @ToPartyCode            
 AND C2.PARTY_CODE In (Select Party_Code From #PartyList (nolock))        
 AND C2.PRINTF = CP.PRINT_FLAG         
/* AND CP.VALID_REPORT LIKE (CASE         
     WHEN @DIGIFLAG = 0 THEN '%'         
     WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'         
     WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'         
     ELSE CP.VALID_REPORT         
     END)*/        
 AND @STATUSNAME = (CASE        
       WHEN @STATUSID = 'BRANCH'        
       THEN C1.BRANCH_CD        
       WHEN @STATUSID = 'SUBBROKER'        
       THEN C1.SUB_BROKER        
       WHEN @STATUSID = 'TRADER'        
       THEN C1.TRADER        
       WHEN @STATUSID = 'FAMILY'        
       THEN C1.FAMILY        
       WHEN @STATUSID = 'AREA'        
       THEN C1.AREA        
       WHEN @STATUSID = 'REGION'        
       THEN C1.REGION        
       WHEN @STATUSID = 'CLIENT'        
       THEN C2.PARTY_CODE        
       ELSE 'BROKER'         
      END)        
 AND BRANCH_CD >= @FROMBRANCH             
 AND BRANCH_CD <= @TOBRANCH             
 AND SUB_BROKER  >= @FROMSUB_BROKER            
 AND SUB_BROKER  <= @TOSUB_BROKER       
    
            
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[#ClientMaster] ([Party_Code])        
        
If @ReportMode <> 'DETAIL'            
Begin            
 SELECT            
  f.party_code,             
  BillNo = 0,            
  f.inst_type,             
  --f.symbol,      
  Symbol = f.SYMBOL + (Case         
     When TradeType = 'BF'         
     then ' (B-F)'         
     else '' end),              
  Convert(VarChar, f.expirydate, 103) AS expirydate,            
  f.strike_price,             
  Case When f.option_type = '' Then '' Else f.option_type End AS option_type,            
  convert(varchar,convert(datetime,@FromDate),103) as SaudaDate,            
   convert(varchar,convert(datetime,@FromDate),112) AS saudaDateOrd,            
         ScripName  = (            
         CASE             
                 WHEN Inst_Type Like 'FUT%'             
                 THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)                 
                 ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' +             
   RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)                
   END),            
  Cl_Rate AS CLRATE,             
  PRATE = (Case When TradeType = 'BF'         
    Then Case When Sum(f.pqty) > Sum(f.sqty)         
     Then Case When Sum(pqty) > 0         
      Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty)         
      Else 0 End         
     Else 0 End         
    Else Case When Sum(pqty) > 0         
     Then Sum(pamt*f.Denominator/f.Numerator)/Sum(pqty)         
     Else 0 End         
   End),        
  SRATE = (Case When TradeType = 'BF'         
    Then Case When Sum(f.pqty) < Sum(f.sqty)         
     Then Case When Sum(sqty) > 0         
      Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty)         
      Else 0 End         
     Else 0 End         
    Else Case When Sum(sqty) > 0         
     Then Sum(samt*f.Denominator/f.Numerator)/Sum(sqty)         
     Else 0 End         
   End),        
  Case When TradeType = 'BF' Then Case             
   When Sum(f.pqty) > Sum(f.sqty) Then Sum(f.pqty) - Sum(f.sqty) Else 0 End Else Sum(f.pqty) End AS pqty,            
  Case When TradeType = 'BF' Then Case             
   When Sum(f.pqty) < Sum(f.sqty) Then Sum(f.sqty) - Sum(f.pqty) Else 0 End Else Sum(f.sqty) End AS sqty,            
 Case When Sum(f.pbillamt) > Sum(f.sbillamt) Then Sum(f.pbillamt) - Sum(f.sbillamt) Else 0 End AS pbillamt,            
  Case When Sum(f.sbillamt) > Sum(f.pbillamt) Then Sum(f.sbillamt) - Sum(f.pbillamt) Else 0 End AS sbillamt,            
          
  Sum((f.pbillamt)) - Sum((f.sbillamt) ) AS diff,            
  Sum(((f.cl_chrg - f.excl_chrg) + (f.service_tax - f.exser_tax) +            
    (f.sebi_tax) + (f.turn_tax) + (f.broker_note) + (f.ins_chrg) +             
   (f.other_chrg)) ) AS chrg_total,            
  Sum((f.pbillamt) + ((f.service_tax- f.exser_tax) + (f.turn_tax) + (f.sebi_tax) +             
    (f.broker_note) +  (f.ins_chrg) + (f.other_chrg) +             
    (f.cl_chrg-f.excl_chrg)) ) - Sum((f.sbillamt)  ) AS finalfigure,            
  CLEARING_CHRG = SUM(F.cl_chrg),            
  SERVICE_TAX = Sum(((f.service_tax - f.exser_tax)) ),             
  SEBI_TAX = Sum(((f.sebi_tax)) ),             
  TURN_TAX = Sum(((f.turn_tax)) ),             
  BROKER_NOTE = Sum(((f.broker_note)) ),             
  INS_CHRG = Sum(((f.ins_chrg)) ),             
  OTHER_CHRG = Sum(((f.other_chrg)) ),             
  TRADETYPE = Case When f.tradetype = 'BT' And  AuctionPart = 'EA' And Inst_Type Like 'FUT%'             
    Then  'FF' Else Replace(f.tradetype,'BT','') End,            
  MTOM =  Sum(Case When AuctionPart = '' then             
    (SBillAmt+SBrokAmt-PBillAmt+PBrokAmt) Else 0 End)            
 INTO #FOBILL_SUMMARY            
 FROM            
  fobillvalan F (nolock) ,            
  #ClientMaster c2            
 WHERE            
  c2.party_code = f.party_code            
  AND f.sauda_date >= @Fromdate             
  AND f.sauda_date <= @ToDate +' 23:59:59'             
  AND f.tradetype like (Case When Inst_Type Like 'OPT%'             
     Then 'BT'             
     Else '%'      
     End )            
 GROUP BY             
  f.party_code,             
  f.symbol,             
  f.inst_type,             
  f.expirydate,             
  f.strike_price,             
  f.option_type,            
  f.tradetype,             
  cl_rate,            
  AuctionPart     
 HAVING Case When TradeType = 'BF' then sum(sqty-pqty) else 1 end <> 0     
    
            
            
 IF @intPrintCF = 1          
 BEGIN            
  INSERT INTO #FOBILL_SUMMARY            
  SELECT            
   f.party_code,             
   BillNo = 0,            
   f.inst_type,             
   f.symbol,            
   Convert(VarChar, f.expirydate, 103) AS expirydate,            
   f.strike_price,             
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,            
   convert(varchar,convert(datetime,@FromDate),103) as SaudaDate,            
   convert(varchar,convert(datetime,@FromDate),112) AS saudaDateOrd,            
      ScripName  = (            
          CASE             
                  WHEN Inst_Type Like 'FUT%'             
                  THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)                 
                  ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' +             
    RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)                
    END),            
   Cl_Rate AS CLRATE,             
           
   prate = (Case When Sum(f.pqty - f.sqty) < 0 Then cl_rate ELse 0 End),            
   srate = (Case When Sum(f.pqty - f.sqty) > 0  Then cl_rate ELse 0 End),            
   Case When Sum(f.pqty - f.sqty) < 0  Then abs(Sum(f.pqty - f.sqty)) Else 0 End AS pqty,            
   Case When Sum(f.pqty - f.sqty) > 0  Then abs(Sum(f.pqty - f.sqty)) Else 0 End AS sqty,            
   pbillamt = 0,         
   sbillamt = 0,         
            
   diff=0,            
   chrg_total=0,            
   finalfigure =0,            
   CLEARING_CHRG = 0,            
   SERVICE_TAX = 0 ,            
   SEBI_TAX = 0,            
   TURN_TAX = 0,             
   BROKER_NOTE = 0,            
   INS_CHRG = 0 ,            
   OTHER_CHRG =0,            
   TRADETYPE = 'CF',            
   MTOM =  0            
              
  FROM            
   fobillvalan F (nolock) ,            
   #ClientMaster c2            
  WHERE            
    c2.party_code = f.party_code            
  AND f.sauda_date >= @Fromdate             
   AND f.sauda_date <= @ToDate +' 23:59:59'             
   AND f.tradetype like (Case When Inst_Type Like 'OPT%'             
      Then 'BT'             
      Else '%'             
      End )            
  GROUP BY             
   f.party_code,        f.symbol,             
   f.inst_type,             
   f.expirydate,             
   f.strike_price,             
   f.option_type,            
   cl_rate            
  HAVING Sum(f.pqty - f.sqty) <> 0 Or Sum(prate + srate) > 0          
 END            
            
            
End            
Else            
Begin            
            
Declare @PartyCount varchar (10)            
 Select            
  Top 1 @PartyCount = Party_Code             
 From            
  Tbl_MTomPremiumBill_Report             
 Where            
  BillDate >= @Fromdate             
  AND BillDate <= @ToDate +' 23:59:59'             
            
 Create Table #FOBILL_DETAIL            
 (            
  Party_Code Varchar(10),            
  BillNo BigInt,            
  Inst_Type Varchar(7),            
  Symbol Varchar(12),            
  ExpiryDate varchar(11),            
  Strike_Price Money,            
  Option_Type Varchar(2),            
  saudadate varchar(11),            
  saudaDateOrd varchar(11),            
  ScripName Varchar(50),            
  Cl_Rate Money,            
  prate Money,            
  srate Money,            
  pqty int,            
  sqty int,            
  pbillamt money,            
  sbillamt money,            
  diff money,            
  chrg_total money,            
  finalfigure money,            
  CLEARING_CHRG MONEY,            
  Service_Tax money,            
  sebi_tax money,            
  turn_tax money,            
  stampduty money,            
  insurance_chrg money,            
  other_chrg money,            
  TRADETYPE varchar(10),            
  MTOM money            
 )            
            
 If @PartyCount <> ''            
  BEGIN            
   INSERT INTO #FOBILL_DETAIL            
   Select            
   f.party_code,             
   BillNo = 0,            
   f.inst_type,             
   f.symbol,            
   Convert(VarChar, f.expirydate, 103) AS expirydate,            
   f.strike_price,             
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,            
   convert(varchar,convert(datetime,@FromDate),103) AS saudadate,            
    convert(varchar,convert(datetime,@FromDate),112) AS saudaDateOrd,            
          ScripName  = (            
          CASE             
                  WHEN Inst_Type Like 'FUT%'             
                  THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)                 
                  ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' +             
    RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)                
    END),            
   Cl_Rate AS CLRATE,             
   Case When Sum(pqty)-Sum(Sqty) > 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) /             
    Sum(pqty+Sqty) Else 0 End AS prate,                
   Case When Sum(pqty)-Sum(Sqty) < 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) /             
    Sum(pqty+Sqty) Else 0 End AS srate,                
   (Case When Sum(pqty)-Sum(Sqty) > 0 Then Sum(pqty)-Sum(Sqty) Else 0 End) AS pqty,                  
   (Case When Sum(pqty)-Sum(Sqty) < 0 Then Abs(Sum(pqty)-Sum(Sqty)) Else 0 End) AS sqty,                  
        
   Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) < 0             
        Then Abs(Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)))            
        Else 0             
   End              
   AS pbillamt ,            
   Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) > 0             
        Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))            
        Else 0             
   End              
   AS sbillamt,              
        
   Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS diff,                
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) AS chrg_total,                  
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -             
   Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS finalfigure,                    
   CLEARING_CHRG = 0,            
   Service_Tax = Sum(Service_Tax),                  
   sebi_tax = Sum(f.sebi_tax),             
   turn_tax = Sum(f.turn_tax),           
   stampduty = Sum(f.stampduty),         
   insurance_chrg = Sum(f.insurance_chrg),         
   other_chrg = Sum(f.other_chrg),           
               
   TRADETYPE = Case When f.BfDayFlag = 'B-T' And  AuctionPart = 'EA' And Inst_Type Like 'FUT%'             
     Then  'FF' Else Replace(Replace(f.BfDayFlag,'-',''),'BT','') End,            
   MTOM = Sum(Case When AuctionPart =''             
     Then Abs((SQty-PQty)*(NetRate-f.Cl_Rate))             
     Else 0 End)            
  FROM            
   Tbl_MtomPremiumBill_Report F (nolock) ,            
   #ClientMaster c2            
  WHERE            
   c2.party_code = f.party_code            
   AND F.BillDate >= @Fromdate             
 AND F.BillDate <= @ToDate +' 23:59:59'             
             
  GROUP BY             
   f.party_code,             
   f.symbol,             
   f.inst_type,             
   f.expirydate,             
   f.strike_price,             
   f.option_type,            
   f.BfDayFlag,             
   cl_rate,            
   AuctionPart,            
   Case When f.bfdayflag <> 'B-F' then PQty else '' end,            
   Case When f.bfdayflag <> 'B-F' then sQty else '' end,            
   Case When f.bfdayflag <> 'B-F' then Netwithbrok else 0 end                
                   
   Having Case When  bfdayflag = 'B-F' Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))  Else 1 End <> 0            
               
   OR            
   Case When  bfdayflag = 'B-F' Then Sum(SQty-PQty)  Else 1 End <> 0            
                   
  END            
 ELSE            
  BEGIN            
   INSERT INTO #FOBILL_DETAIL            
   Select f.party_code,             
   BillNo = 0,            
   f.inst_type,             
   f.symbol,            
   Convert(VarChar, f.expirydate, 103) AS expirydate,            
   f.strike_price,             
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,            
    convert(varchar,convert(datetime,@FromDate),103) AS saudadate,            
    convert(varchar,convert(datetime,@FromDate),112) AS saudaDateOrd,            
          ScripName  = (            
          CASE             
                  WHEN Inst_Type Like 'FUT%'             
                  THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)                 
                  ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' +             
    RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)                
    END),            
   Cl_Rate AS CLRATE,             
   Case When Sum(pqty)-Sum(Sqty) > 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) /             
    Sum(pqty+Sqty) Else 0 End AS prate,                
   Case When Sum(pqty)-Sum(Sqty) < 0 Then sum(Netwithbrok*pqty+Netwithbrok*Sqty) /             
    Sum(pqty+Sqty) Else 0 End AS srate,                
   (Case When Sum(pqty)-Sum(Sqty) > 0 Then Sum(pqty)-Sum(Sqty) Else 0 End) AS pqty,                  
   (Case When Sum(pqty)-Sum(Sqty) < 0 Then Abs(Sum(pqty)-Sum(Sqty)) Else 0 End) AS sqty,                  
        
   Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) < 0             
        Then Abs(Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)))            
        Else 0             
   End              
   AS pbillamt ,            
   Case When Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) > 0             
        Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))            
        Else 0             
   End              
   AS sbillamt,              
        
   Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS diff,                
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) AS chrg_total,                  
   Sum((Service_Tax+f.sebi_tax+f.turn_tax+f.stampduty+f.insurance_chrg+f.Other_Chrg)) -             
   Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok)) AS finalfigure,                    
   CLEARING_CHRG = 0,            
   Service_Tax = Sum(Service_Tax),           
   sebi_tax = Sum(f.sebi_tax),         
   turn_tax = Sum(f.turn_tax),           
   stampduty = Sum(f.stampduty),         
   insurance_chrg = Sum(f.insurance_chrg),              
   other_chrg = Sum(f.other_chrg),         
               
   TRADETYPE = Case When f.BfDayFlag = 'B-T' And  AuctionPart = 'EA' And Inst_Type Like 'FUT%'             
     Then  'FF' Else Replace(Replace(f.BfDayFlag,'-',''),'BT','') End,            
   MTOM = Sum(Case When AuctionPart =''             
     Then Abs((SQty-PQty)*(NetRate-f.Cl_Rate))             
     Else 0 End)            
  FROM            
   Tbl_MtomPremiumBill F (nolock) ,            
   #ClientMaster c2            
  WHERE            
   c2.party_code = f.party_code            
   AND F.BillDate >= @Fromdate             
   AND F.BillDate <= @ToDate +' 23:59:59'             
             
  GROUP BY             
   f.party_code,             
   f.symbol,             
   f.inst_type,             
   f.expirydate,             
   f.strike_price,             
   f.option_type,            
   f.BfDayFlag,             
   cl_rate,            
   AuctionPart,            
   Case When f.bfdayflag <> 'B-F' then PQty else '' end,            
   Case When f.bfdayflag <> 'B-F' then sQty else '' end,            
   Case When f.bfdayflag <> 'B-F' then Netwithbrok else 0 end                
                   
   Having Case When  bfdayflag = 'B-F' Then Sum((SQty-PQty)*(NetRate-f.Cl_Rate)-(Brok))  Else 1 End <> 0            
               
   OR            
   Case When  bfdayflag = 'B-F' Then Sum(SQty-PQty)  Else 1 End <> 0            
                   
  END            
              
            
 IF @intPrintCF = 1            
 BEGIN            
  INSERT INTO #FOBILL_DETAIL            
  SELECT            
   f.party_code,             
   BillNo = 0,            
   f.inst_type,             
   f.symbol,            
   Convert(VarChar, f.expirydate, 103) AS expirydate,            
   f.strike_price,             
   Case When f.option_type = '' Then '' Else f.option_type End AS option_type,            
   convert(varchar,convert(datetime,@FromDate),103) as SaudaDate,            
    convert(varchar,convert(datetime,@FromDate),112) AS saudaDateOrd,            
          ScripName  = (            
          CASE             
          WHEN Inst_Type Like 'FUT%'             
                  THEN RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11)                 
                  ELSE RTrim(inst_type) + ' ' + RTrim(symbol) + ' ' + Left(ExpiryDate,11) + ' ' +             
    RTrim(Convert(Varchar,strike_Price)) + ' ' + RTrim(Option_Type)                
    END),            
   Cl_Rate AS CLRATE,             
          
   prate = (Case When Sum(f.pqty - f.sqty) < 0 Then cl_rate ELse 0 End),            
   srate = (Case When Sum(f.pqty - f.sqty) > 0  Then cl_rate ELse 0 End),            
   Case When Sum(f.pqty - f.sqty) < 0  Then abs(Sum(f.pqty - f.sqty)) Else 0 End AS pqty,            
   Case When Sum(f.pqty - f.sqty) > 0  Then abs(Sum(f.pqty - f.sqty)) Else 0 End AS sqty,            
   pbillamt = 0,           
   sbillamt = 0,         
   diff=0,            
   chrg_total=0,            
   finalfigure =0,            
   CLEARING_CHRG = 0,            
   SERVICE_TAX = 0 ,            
   SEBI_TAX = 0,            
   TURN_TAX = 0,             
   BROKER_NOTE = 0,            
   INS_CHRG = 0 ,            
   OTHER_CHRG =0,            
   TRADETYPE = 'CF',            
   MTOM =  0             
  FROM            
   fobillvalan F (nolock) ,            
   #ClientMaster c2            
  WHERE            
    c2.party_code = f.party_code            
   AND F.sauda_date >= @Fromdate             
   AND F.sauda_date <= @ToDate +' 23:59:59'             
   AND f.tradetype like (Case When Inst_Type Like 'OPT%'             
      Then 'BT'             
      Else '%'             
      End )            
  GROUP BY             
   f.party_code,             
   f.symbol,             
   f.inst_type,             
   f.expirydate,             
   f.strike_price,             
   f.option_type,            
   cl_rate            
  HAVING Sum(f.pqty - f.sqty) <> 0 Or sum(prate + srate) > 0          
 END            
End            
      
      
      
            
            
Create Table #FOBILL            
(            
 Party_Code Varchar(10),            
 BillNo NVarchar(10),            
 Inst_Type Varchar(7),            
 Symbol Varchar(20),            
 ExpiryDate Varchar(10),            
 Strike_Price int,            
 Option_Type Varchar(2),            
 SaudaDate Varchar(10),            
 saudaDateOrd Varchar(10),            
 ScripName Varchar(40),            
 ClRate Money,            
 PRate Money,            
 SRate Money,            
 PQty Int,            
 SQty Int,            
 PBillamt Money,            
 SBillamt Money,            
 Diff Money,            
 chrg_total Money,            
 finalfigure Money,            
 CLEARING_CHRG MONEY,            
 Service_Tax Money,            
 sebi_tax Money,            
 turn_tax Money,            
 Broker_Note Money,            
 ins_chrg Money,            
 other_chrg Money,            
 tradetype varchar(3),            
 MtoM Money            
)            
             
If @ReportMode <> 'DETAIL'            
Begin            
 Insert Into #FOBILL Select * From #FOBILL_SUMMARY            
 Drop Table #FOBILL_SUMMARY            
End            
Else            
Begin            
 Insert Into #FOBILL Select * From #FOBILL_DETAIL            
 Drop Table #FOBILL_DETAIL            
End            
      
          
      
UPDATE #FOBILL            
SET BILLNO = FA.BILL_NO            
FROM FOACCBILL FA            
WHERE FA.PARTY_CODE = #FOBILL.PARTY_CODE            
AND  billdate >= @Fromdate             
AND billdate <= @ToDate +' 23:59:59'            
            
            
if @ReportOpt = 'PRE_PRINT' and @intPrintCF = 1            
Begin            
SELECT           
  partyname,party_code,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,            
  PAN_GIR_NO,service_chrg,BillNo,            
  inst_type,symbol,expirydate,strike_price,option_type,            
  saudadate,            
  saudadateOrd,            
  ScripName,            
  CLRATE= case when sum(pqty+sqty) >0 then sum(clrate * (pqty+sqty)) / sum(pqty+sqty) else 0 end,            
  BF_Qty = Sum(BF_Qty),            
  BF_Rate = Case When Sum(BF_Qty) > 0 then  Sum(BF_Rate*BF_Qty)/ Sum(BF_Qty) else 0 end,            
  BF_Amt=Sum(BF_Amt),            
  BT_PQty=Sum(BT_PQty),            
  BT_SQty=Sum(BT_SQty),            
  BT_PRate= Case When Sum(BT_PQty) > 0 then Sum(BT_PRate*BT_PQty)/Sum(BT_PQty) else 0 end ,            
  BT_SRate=case when Sum(BT_SQty) >0 then Sum(BT_SRate*BT_SQty)/Sum(BT_SQty) else 0 end ,            
  BT_PAmt=Sum(BT_PAmt),            
  BT_SAmt=Sum(Bt_SAmt),            
  BT_DIFF=Sum(BT_Diff),            
  CF_Rate=case when Sum(CF_Qty) > 0 then Sum(CF_Rate*CF_Qty)/Sum(CF_Qty) else 0 end ,            
  CF_Qty=Sum(CF_Qty),            
  CF_Amount=Sum(CF_Amount),            
  prate= case when Sum(PQty) > 0 then Sum(PRate*PQty)/Sum(PQty) else 0 end ,            
  srate= case when Sum(SQty) > 0 then Sum(SRate*SQty)/Sum(SQty) else 0 end,            
  pqty=Sum(PQty),            
  sqty=Sum(SQty),            
  pbillamt=Sum(PBillAmt),            
  sbillamt=Sum(SBillAmt),            
  chrg_total=Sum(Chrg_Total),            
  finalfigure=sum(finalfigure),            
  CLEARING_CHRG = SUM(CLEARING_CHRG),            
  SERVICE_TAX=sum(SERVICE_TAX),            
  SEBI_TAX=sum(SEBI_TAX),            
  TURN_TAX=sum(TURN_TAX),            
  BROKER_NOTE=sum(BROKER_NOTE),            
  INS_CHRG=sum(INS_CHRG),            
  OTHER_CHRG=sum(OTHER_CHRG),         
  TRADETYPE,            
  TRADETYPE_P = Case When sum(Pqty) > 0 then TRADETYPE Else '' End,            
  TRADETYPE_S = Case When sum(Sqty) > 0 then TRADETYPE Else '' End,            
  MtoM=sum(MtoM)            
FROM            
(            
 SELECT             
  partyname,#ClientMaster.party_code,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,            
  PAN_GIR_NO,service_chrg,BillNo,       
  inst_type,symbol,expirydate,strike_price,option_type,            
  saudadate,saudadateOrd,            
  ScripName,CLRATE,            
            
  BF_Qty = Case When PQty >0 Then PQty Else SQty End,            
  BF_Rate = Case When PQty > 0 Then PRate Else SRate End ,            
  BF_Amt = 0,            
              
  BT_PQty = 0,            
  BT_SQty = 0,            
  BT_PRate = 0,            
  BT_SRate = 0,            
  BT_PAmt = 0,            
  BT_SAmt = 0,            
  BT_DIFF = 0,            
            
  CF_Qty = 0,            
  CF_Rate = 0,            
  CF_Amount = 0,            
            
  prate,srate,            
  pqty,sqty,pbillamt,sbillamt,            
            
  chrg_total,            
  finalfigure,            
  CLEARING_CHRG,            
  SERVICE_TAX,SEBI_TAX,TURN_TAX,            
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,            
  TRADETYPE,            
  MtoM=0           
            
 FROM #FOBILL ,#ClientMaster             
 Where            
  #ClientMaster.Party_code = #FOBILL.Party_Code            
  And tradetype = 'BF'        
  And (Pqty > 0  Or Sqty > 0)            
             
 Union All            
             
 SELECT             
  partyname,#ClientMaster.party_code,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,            
  PAN_GIR_NO,service_chrg,BillNo,            
  inst_type,symbol,expirydate,strike_price,option_type,            
  saudadate,saudadateOrd,            
  ScripName,CLRATE,            
            
  BF_Qty = 0,            
  BF_Rate = 0,            
  BF_Amt = 0,            
              
  BT_PQty = PQty,            
  BT_SQty = SQty,            
  BT_PRate = PRate,            
  BT_SRate = SRate,            
  BT_PAmt = PBillAmt,            
  BT_SAmt = SBillAmt,            
  BT_DIFF = (PBillAmt-SBillAmt),            
            
  CF_Qty = 0,            
  CF_Rate = 0 ,            
  CF_Amount = 0,            
            
  prate,srate,            
  pqty,sqty,pbillamt,sbillamt,            
            
  chrg_total,            
  finalfigure,            
  CLEARING_CHRG,            
  SERVICE_TAX,SEBI_TAX,TURN_TAX,         
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,            
  TRADETYPE,            
  MtoM          
            
 FROM #FOBILL ,#ClientMaster             
 Where            
  #ClientMaster.Party_code = #FOBILL.Party_Code            
  And ( tradetype = '' Or tradetype = 'BT' )            
  AND (PQTY > 0  OR SQTY > 0 OR SYMBOL = 'BROKERAGE')    
             
 Union All            
            
 SELECT             
  partyname,#ClientMaster.party_code,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,            
  PAN_GIR_NO,service_chrg,BillNo,            
  inst_type,symbol,expirydate,strike_price,option_type,            
  saudadate,saudadateOrd,            
  ScripName,CLRATE,            
            
  BF_Qty = 0,            
  BF_Rate = 0,            
  BF_Amt = 0,            
              
  BT_PQty = 0,            
  BT_SQty = 0,            
  BT_PRate = 0,            
  BT_SRate = 0,            
  BT_PAmt = 0,            
  BT_SAmt = 0,            
  BT_DIFF = 0,            
            
  CF_Qty = Case When PQty >0 Then PQty Else SQty End,            
  CF_Rate = Case When PQty > 0 Then PRate Else SRate End ,            
  CF_Amount = (Case When PQty >0 Then PQty Else SQty End ) * CLRATE,            
            
  prate,srate,            
  pqty,sqty,pbillamt,sbillamt,            
            
  chrg_total,            
  finalfigure,            
  CLEARING_CHRG,            
  SERVICE_TAX,SEBI_TAX,TURN_TAX,            
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,            
  TRADETYPE,            
  MtoM=0           
            
 FROM #FOBILL ,#ClientMaster             
 Where            
  #ClientMaster.Party_code = #FOBILL.Party_Code            
  And  tradetype = 'CF'            
  And (Pqty > 0  Or Sqty > 0)            
            
 ) FoBill            
 Group By             
  partyname,party_code,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,            
  PAN_GIR_NO,service_chrg,BillNo,            
  inst_type,symbol,expirydate,strike_price,option_type,ScripName,        
  saudadate,            
  saudadateOrd,            
  TRADETYPE            
        
 Having Sum(PBillAmt+SBillAmt) > 0        
            
 Order By             
  party_code,             
  saudadateOrd,            
  partyname,            
  SUB_BROKER,            
  symbol,             
  inst_type,             
  expirydate,             
  strike_price,             
  option_type            
             
 End            
Else            
Begin            
            
 SELECT             
  partyname,#ClientMaster.party_code,client_type,            
  l_address1,l_address2,l_address3,L_city,L_State,L_Nation,L_Zip,            
  OFF_PHONE1,OFF_PHONE2,            
  branch_code,SUB_BROKER,TRADER,       
  PAN_GIR_NO,service_chrg,BillNo,            
  inst_type,symbol,expirydate,strike_price,option_type,             
  saudadate,saudadateOrd,            
  ScripName,CLRATE,prate,srate,            
  pqty,sqty,pbillamt,sbillamt,diff,chrg_total,            
  finalfigure,CLEARING_CHRG,            
  SERVICE_TAX,SEBI_TAX,TURN_TAX,            
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,            
  TRADETYPE,            
  TRADETYPE_P = Case When Pqty > 0 then TRADETYPE Else '' End,            
  TRADETYPE_S = Case When Sqty > 0 then TRADETYPE Else '' End,            
  MtoM,            
  intOrder = Case When TRADETYPE = 'BF' Then 1 Else Case When TRADETYPE='CF' then 3 else 2 end end             
             
 FROM #FOBILL ,#ClientMaster             
 Where            
  #ClientMaster.Party_code = #FOBILL.Party_Code            
  AND (PQTY > 0  OR SQTY > 0 OR SYMBOL = 'BROKERAGE')    
               
 ORDER BY             
  #ClientMaster.party_code,             
  saudadateOrd,            
  partyname,             
  SUB_BROKER,            
  symbol,             
  inst_type,             
  expirydate,             
  strike_price,             
  option_type,             
  intOrder        
 End            
        
Drop Table #FOBILL            
Drop Table #ClientMaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_GETMARGINREQ
-- --------------------------------------------------
CREATE PROC V2_GETMARGINREQ(
           @MARGINDATE VARCHAR(11),
           @FCODE      VARCHAR(10),
           @TCODE      VARCHAR(10),
           @STATUSID   VARCHAR(15),
           @STATUSNAME VARCHAR(15),
           @STRBRANCH  VARCHAR(10))

AS

  SET NOCOUNT ON
  
  DECLARE  @TDATE    DATETIME, 
           @EXCHANGE VARCHAR(3) 

  SELECT   TOP 1 @TDATE = MARGINDATE
  FROM     TBL_CLIENTMARGIN WITH (NOLOCK)
  WHERE    MARGINDATE <= @MARGINDATE + ' 23:59:59'
  ORDER BY 1 DESC
           
  SET @MARGINDATE = LEFT(@TDATE,11)

  SELECT   TOP 1 @EXCHANGE = EXCHANGE
  FROM     FOGLOBALS WITH (NOLOCK)
                    
  IF @STATUSID <> 'AREA'
      OR @STATUSID <> 'REGION'
    BEGIN
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '0IM',
             DRAMT = INITIALMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = @EXCHANGE + ' - INITIAL MARGIN AS ON ' + @MARGINDATE,
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK)
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND INITIALMARGIN > 0
             AND @STATUSNAME = (CASE 
                                  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                                  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                                  WHEN @STATUSID = 'TRADER' THEN TRADER
                                  WHEN @STATUSID = 'FAMILY' THEN FAMILY
                                  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
                                  ELSE 'BROKER'
                                END)
      UNION ALL
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '1EX',
             DRAMT = MTMMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = @EXCHANGE + ' - EXPOSURE MARGIN AS ON ' + @MARGINDATE,
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK)
      WHERE  MARGINDATE = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND MTMMARGIN > 0
             AND @STATUSNAME = (CASE 
                                  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                                  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                                  WHEN @STATUSID = 'TRADER' THEN TRADER
                                  WHEN @STATUSID = 'FAMILY' THEN FAMILY
                                  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
                                  ELSE 'BROKER'
                                END)
      ORDER BY 9,
               3
    END
  ELSE
    BEGIN
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '0IM',
             DRAMT = INITIALMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = '',
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK),
             (SELECT STATUSID = 'AREA',
                     STATUSNAME = AREACODE,
                     BRANCH_CODE
              FROM   AREA WITH (NOLOCK)
              UNION ALL
              SELECT STATUSID = 'REGION',
                     STATUSNAME = REGIONCODE,
                     BRANCH_CODE
              FROM   REGION WITH (NOLOCK)) E
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD = BRANCH_CODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND INITIALMARGIN > 0
             AND STATUSNAME = @STATUSNAME
             AND STATUSID = @STATUSID
      UNION ALL
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '1EX',
             DRAMT = MTMMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = '',
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK),
             (SELECT STATUSID = 'AREA',
                     STATUSNAME = AREACODE,
                     BRANCH_CODE
              FROM   AREA WITH (NOLOCK)
              UNION ALL
              SELECT STATUSID = 'REGION',
                     STATUSNAME = REGIONCODE,
                     BRANCH_CODE
              FROM   REGION WITH (NOLOCK)) E
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD = BRANCH_CODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND MTMMARGIN > 0
             AND STATUSNAME = @STATUSNAME
             AND STATUSID = @STATUSID
      ORDER BY 9,
               3
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_ObjectListing
-- --------------------------------------------------
CREATE Proc V2_ObjectListing  
  
as  
  
select b.name TableName, a.rowcnt RowCnt, cast(sum(c.used)*8192/1024  as varchar) + ' KB' SpaceUsed  
from sysindexes a, sysobjects b, sysindexes c  
where a.id = b.id  
and a.indid = 0  
and a.id = c.id  
and c.indid in (0,1,255)  
and b.xtype = 'U'  
group by b.name, a.rowcnt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROC_STATMP_UPLOAD
-- --------------------------------------------------



 

CREATE PROC [dbo].[V2_PROC_STATMP_UPLOAD] 
(
	@TDATE VARCHAR(10), @FILEFOR VARCHAR(20), @FILETYPE VARCHAR(50), 
	@PROGID VARCHAR(50), @UNAME VARCHAR(50)='',@FILENAME VARCHAR(100) = ''
)
AS
 
DECLARE @SETT_DATE DATETIME,
		@MEMBERCODE	VARCHAR(10),
		@MEMBER_TYPE VARCHAR(2),
		@FILEDATE	DATETIME,
		@RECCNT		INT

SELECT   
	@FILEDATE = .DBO.PIECE(FILE_DATA,',',2) 
FROM STAMPDUTY_FILEDATA
WHERE .DBO.PIECE(FILE_DATA,',',1) = '10'

IF @FILEDATE <> CONVERT(DATETIME,@TDATE,103)
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'SELECTED DATE IS NOT MATCHING WITH THE FILE DATE.'
	RETURN
END

SELECT 
	REC_FOR,RECTYPE,SAUDA_DATE,TM_CODE,PARTY_CODE,STATE_NAME,INST_TYPE,SYMBOL,EXPIRY_DATE,STRIKE_PRICE,OPTION_TYPE,
	CA_LEVEL,BUYQTY,SELLQTY,SETT_PRICE,DELBUYQTY,DELBUYVAL,TRDBUYQTY,TRDBUYVAL,DELSTAMP,TRDSTAMP,TOTALSTAMP
INTO #TBL_STAMP_EXCHG
FROM TBL_STAMP_EXCHG
WHERE 1 = 2

INSERT INTO #TBL_STAMP_EXCHG
SELECT 
	REC_FOR='NORMAL',
	RECTYPE = .DBO.PIECE(FILE_DATA,',',1), 
	SAUDA_DATE = .DBO.PIECE(FILE_DATA,',',2),
	TM_CODE = .DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = '',
	STATE_NAME = '',
	INST_TYPE = '',
	SYMBOL = '',
	EXPIRY_DATE = '1900-01-01',
	STRIKE_PRICE = 0,
	OPTION_TYPE = '',
	CA_LAVEL = '',
	BUYQTY = 0,
	SELLQTY = 0,
	SETT_PRICE = 0,
	DELBUYQTY = 0,
	DELBUYVAL = 0,
	TRDBUYQTY = 0,
	TRDBUYVAL = 0,
	DELSTAMP = 0,
	TRDSTAMP = 0,
	TOTALSTAMP = Replace(.DBO.PIECE(FILE_DATA,',',4) , Char(17),'')
FROM STAMPDUTY_FILEDATA
WHERE  .DBO.PIECE(FILE_DATA,',',1) = '10'
 
INSERT INTO #TBL_STAMP_EXCHG
SELECT 
	REC_FOR='NORMAL',
	RECTYPE = .DBO.PIECE(FILE_DATA,',',1), 
	SAUDA_DATE = .DBO.PIECE(FILE_DATA,',',2), 
	TM_CODE = .DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = .DBO.PIECE(FILE_DATA,',',4),
	STATE_NAME = .DBO.PIECE(FILE_DATA,',',6),
	INST_TYPE = '',
	SYMBOL = '',
	EXPIRY_DATE = '1900-01-01',
	STRIKE_PRICE = 0,
	OPTION_TYPE = '',
	CA_LAVEL = '',
	BUYQTY = 0,
	SELLQTY = 0,
	SETT_PRICE = 0,
	DELBUYQTY = 0,
	DELBUYVAL = 0,
	TRDBUYQTY = 0,
	TRDBUYVAL = 0,
	DELSTAMP = 0,
	TRDSTAMP = 0,
	TOTALSTAMP = Replace(.DBO.PIECE(FILE_DATA,',',5) , Char(17),'')
FROM STAMPDUTY_FILEDATA
WHERE .DBO.PIECE(FILE_DATA,',',1) = '20'

INSERT INTO #TBL_STAMP_EXCHG
SELECT 
	REC_FOR='NORMAL',
	RECTYPE = .DBO.PIECE(FILE_DATA,',',1), 
	SAUDA_DATE = .DBO.PIECE(FILE_DATA,',',2),
	TM_CODE = .DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = .DBO.PIECE(FILE_DATA,',',4),
	STATE_NAME = '',
	INST_TYPE = .DBO.PIECE(FILE_DATA,',',5),
	SYMBOL = .DBO.PIECE(FILE_DATA,',',6),
	EXPIRY_DATE = .DBO.PIECE(FILE_DATA,',',7),
	STRIKE_PRICE = .DBO.PIECE(FILE_DATA,',',8),
	OPTION_TYPE = .DBO.PIECE(FILE_DATA,',',9),
	CA_LAVEL = .DBO.PIECE(FILE_DATA,',',10),
	BUYQTY = .DBO.PIECE(FILE_DATA,',',11),
	SELLQTY = 0,
	SETT_PRICE = 0,
	DELBUYQTY = .DBO.PIECE(FILE_DATA,',',11),
	DELBUYVAL = .DBO.PIECE(FILE_DATA,',',12),
	TRDBUYQTY = 0,
	TRDBUYVAL = 0,
	DELSTAMP = Replace(.DBO.PIECE(FILE_DATA,',',17) , Char(17),''),
	TRDSTAMP = 0,
	TOTALSTAMP = Replace(.DBO.PIECE(FILE_DATA,',',17) , Char(17),'')
FROM STAMPDUTY_FILEDATA
WHERE .DBO.PIECE(FILE_DATA,',',1) = '30'

UPDATE #TBL_STAMP_EXCHG SET STATE_NAME = T.STATE_NAME
FROM (
		SELECT DISTINCT RECTYPE, PARTY_CODE, STATE_NAME FROM #TBL_STAMP_EXCHG 
		WHERE RECTYPE = 20
	 ) T
WHERE #TBL_STAMP_EXCHG.PARTY_CODE = T.PARTY_CODE
AND #TBL_STAMP_EXCHG.RECTYPE = 30 AND T.RECTYPE = 20 

DELETE FROM TBL_STAMP_EXCHG 
WHERE SAUDA_DATE = @FILEDATE
AND REC_FOR='NORMAL'

INSERT INTO TBL_STAMP_EXCHG 
SELECT *, UPLOAD_BY = @UNAME, UPLOAD_ON = GETDATE() 
FROM #TBL_STAMP_EXCHG

SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #TBL_STAMP_EXCHG

DROP TABLE #TBL_STAMP_EXCHG
/*
DELETE FROM FILEDATA
WHERE PROGID = @PROGID
*/
IF @RECCNT > 0 
BEGIN
	SELECT STRMSGCODE = 1, STRMSG = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORD(S) ' + CONVERT(VARCHAR,@RECCNT)
END
ELSE
BEGIN
	SELECT STRMSGCODE = -1, STRMSG = 'PLEASE CHECK AND IMPORT CORRECT FILE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESS_STATUS_LOG_UPD
-- --------------------------------------------------



CREATE PROC [dbo].[V2_PROCESS_STATUS_LOG_UPD] 

(
	@@SAUDA_DATE VARCHAR(11),
	@PROCESSID VARCHAR(10), 
	@FILENAME VARCHAR(255),
	@UNAME VARCHAR(20),
	@MACHINEIP VARCHAR(20) =''

)
AS

DECLARE @PROCESSNAME VARCHAR(50)
SET @PROCESSNAME = @PROCESSID

SELECT @PROCESSNAME = 
CASE 
	WHEN @PROCESSID = 'BILLGEN' THEN 'BILL GENERATION'
	WHEN @PROCESSID = 'CHKEXALC'THEN 'OPT EX ALLOC'
	WHEN @PROCESSID = 'CHKPOST' THEN 'BILL POSTING'
	WHEN @PROCESSID = 'CHKSTTIMP'THEN 'EXCH STT IMPORT'
	WHEN @PROCESSID = 'CONTRACT' THEN 'CONTRACT POP'
	WHEN @PROCESSID = 'IMPTRD' THEN 'IMPORT TRADE'
	WHEN @PROCESSID = 'MRGFILE' THEN 'MARGIN RET FILE GEN'
	WHEN @PROCESSID = 'MRGIMP' THEN 'EXCH MARGIN IMPORT'
	WHEN @PROCESSID = 'MRGPOP' THEN 'MARGIN REP POP'
	WHEN @PROCESSID = 'POSIMP' THEN 'EXCH POS IMPORT'
	WHEN @PROCESSID = 'STT' THEN 'STT COMPUTATION'
	WHEN @PROCESSID = 'VBB' THEN 'VBB COMPUTATION'
	WHEN @PROCESSID = 'FCN01' THEN 'FCN01 IMPORT'
	WHEN @PROCESSID = 'CLOSE' THEN 'CLOSE TR DATE'
END

IF @PROCESSID = 'CHKSTTIMP'
BEGIN
	SELECT  @@SAUDA_DATE = LEFT(CONVERT(DATETIME,@@SAUDA_DATE),11)
END

IF (SELECT COUNT(1)  
  FROM   (SELECT TOP 1 BUSINESS_DATE  
          FROM   V2_BUSINESS_PROCESS  
          WHERE  LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE) A) = 0  
BEGIN    
	INSERT INTO V2_BUSINESS_PROCESS 
		(
			BUSINESS_DATE,IMPORT_TRADE,VBB,STT,BILLING,CONTRACT,
			POSTING,POSITIONFILE,MARGINFILE,MARGINRETURNFILE,
			CLIENTMARGINPOP,EXCHANGESTT,EXERCISEALLOCATION,OPEN_CLOSE,
			PROCESSDATE,PROCESSBY,LASTUPDATEDATE,LASTUPDATEBY,MACHINEIP
		)
	SELECT 	
		BUSINESS_DATE = @@SAUDA_DATE,
		IMPORT_TRADE		= 0,VBB 		= 0,STT 		= 0,
		BILLING 		= 0,CONTRACT 		= 0,POSTING 		= 0,
		POSITIONFILE 		= 0,MARGINFILE 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,EXCHANGESTT 	= 0,EXERCISEALLOCATION 	= 0,
		OPEN_CLOSE 		= 0,
		PROCESSDATE 		= GETDATE(),
		PROCESSBY 		= @UNAME,
		LASTUPDATEDATE 		= GETDATE(),
		LASTUPDATEBY		= '',
		MACHINEIP 		= @MACHINEIP

END


IF @PROCESSID = 'IMPTRD'  /*IMPORT TRADE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 
		IMPORT_TRADE 		= IMPORT_TRADE + 1,
		VBB 			= 0,STT 		= 0,
		BILLING 		= 0,CONTRACT		= 0,POSTING 		= 0,
		POSITIONFILE 		= 0,MARGINFILE 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,EXCHANGESTT 	= 0,EXERCISEALLOCATION 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'BILLGEN' OR @PROCESSID = 'VALANGEN' /*BILL GENERATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		BILLING 		= BILLING + 1,
		CONTRACT		= 0,POSTING 		= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'CHKEXALC' /*OPTION EXERCISE ALLOCAITON*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		VBB 			= 0,STT 		= 0,BILLING 		= 0,
		CONTRACT		= 0,POSTING 		= 0,CLIENTMARGINPOP 	= 0,
		EXERCISEALLOCATION 	= EXERCISEALLOCATION + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'CHKSTTIMP' /*EXCHG STT IMPORT*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		EXCHANGESTT 		= EXCHANGESTT + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	


IF @PROCESSID = 'CONTRACT' /*CONTRACT PRINT DATA POPUP*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		CONTRACT 		= CONTRACT + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'MRGFILE' /*MARGIN RETURN FILE GENEATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		MARGINRETURNFILE 		= MARGINRETURNFILE + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

	

IF @PROCESSID = 'MRGIMP' /*IMPORT EXCHG MARGIN FILE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		MARGINFILE 		= MARGINFILE + 1,
		MARGINRETURNFILE =0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'MRGPOP' /*MARGIN REPORT DATA POP*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		CLIENTMARGINPOP 		= CLIENTMARGINPOP + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	


IF @PROCESSID = 'POSIMP' /*IMPORT EXCHG POSITION FILE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		POSITIONFILE 		= POSITIONFILE + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'STT' /*STT COMPUTATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		STT 			= STT + 1,
		BILLING 		= 0,CONTRACT		= 0,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END



IF @PROCESSID = 'VBB' /*VBB COMPUTATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		VBB 			= VBB + 1,
		BILLING 		= 0,CONTRACT		= 0,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END




IF @PROCESSID = 'CLOSE' /*CLOSE TRADING DAY*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		OPEN_CLOSE 	=  1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	


IF @PROCESSID = 'CHKPOST' /*CHECKING BLL POSTING STATUS*/
BEGIN


      DECLARE @POSTFLAG INT

      SELECT * INTO #ACCBILL FROM FOACCBILL  (NOLOCK)
      WHERE BILLDATE LIKE @@SAUDA_DATE + '%' 
	  AND AMOUNT <> 0
  
      SELECT * INTO #BILLMATCH FROM ACCOUNTNCE.DBO.BILLMATCH  (NOLOCK)
      WHERE DATE LIKE @@SAUDA_DATE + '%' 
	  AND AMOUNT <> 0
  
      SELECT @POSTFLAG = ISNULL(COUNT(1),0)  
      FROM   (SELECT   POSTFLAG = ISNULL(B.PARTY_CODE,'0')  
              FROM     #ACCBILL A  
                       LEFT OUTER JOIN #BILLMATCH B  
                         ON ( A.PARTY_CODE = B.PARTY_CODE  
                             AND A.AMOUNT = B.AMOUNT  
                             AND SELL_BUY = (CASE   
                                               WHEN DRCR = 'D' THEN 1  
                                               ELSE 2  
                                             END))  
              WHERE    
					NOT EXISTS (SELECT ACCODE  
                                       FROM   VALANACCOUNT  
                                       WHERE  ACCODE = A.PARTY_CODE)  
              GROUP BY ISNULL(B.PARTY_CODE,'0')  
              UNION   
              SELECT POSTFLAG = '0'  
              FROM   #BILLMATCH B  
              WHERE  NOT EXISTS (SELECT PARTY_CODE  
                                     FROM   #ACCBILL A  
                                     WHERE  A.PARTY_CODE = B.PARTY_CODE  
				)) P  
         WHERE  POSTFLAG = '0'  
                          

	DROP TABLE #BILLMATCH
	DROP TABLE #ACCBILL

	IF (SELECT COUNT(1)  
        	  FROM   ACCOUNTNCE.DBO.BILLPOSTED  (NOLOCK)
	          WHERE  LEFT(VDT,11) = @@SAUDA_DATE) > 0
	BEGIN
		UPDATE 
			V2_BUSINESS_PROCESS 
		SET 	
			Posting 	=  CASE WHEN  BILLING = 0 THEN 0 
						ELSE (CASE   
							                          WHEN @POSTFLAG = 0 THEN 1  
							                          ELSE 0  
							                        END) 
						END
		WHERE 
			LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE			
	END
END


IF @PROCESSID <> 'INSTCONS' AND @PROCESSID <> 'CHKPOST'
BEGIN
	
	INSERT INTO V2_PROCESS_STATUS_LOG 
	( 
		EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
		FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
	)
	SELECT
		EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
		SEGMENT='FUTURES',
		BUSINESSDATE=@@SAUDA_DATE,
		PROCESSID = @PROCESSID,
		PROCESSNAME= @PROCESSNAME,
		FILENAME=@FILENAME,
		START_END_FLAG=1,
		PROCESSDATE=GETDATE(),
		PROCESSBY=@UNAME,
		MACHINEIP= @MACHINEIP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESSFORTODAY
-- --------------------------------------------------


CREATE PROC [dbo].[V2_PROCESSFORTODAY]
(  
           @PROCESSFLAG VARCHAR(15),  
           @UNAME       VARCHAR(50),  
           @PROCESSDATE VARCHAR(11)
)  
AS  

	


	/*-------------------------------------------------------------------------*/

	IF @PROCESSFLAG = 'VBB'  
	BEGIN  
		EXEC PR_Charges_Detail @PROCESSDATE,@PROCESSDATE,'0','zzzzzz',@UNAME
	END

	/*-------------------------------------------------------------------------*/

	IF @PROCESSFLAG = 'BILLGEN'  
	BEGIN  
		EXEC FOBILLGENERATE @PROCESSDATE,@UNAME
	END

	IF @PROCESSFLAG = 'VALANGEN'  
	BEGIN  
		EXEC FOVALANGENERATE @PROCESSDATE,@UNAME
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'CONTRACT'  
	BEGIN  
		EXEC POP_CONTRACTDATA @PROCESSDATE,@UNAME
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'CLOSE'  
	BEGIN 
		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,@PROCESSFLAG,'',@UNAME,''
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'STATUS'  
	BEGIN  

		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,'CHKPOST','',@UNAME,''


		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,'INSTCONS','',@UNAME,''


		/*-----------------------------------------------------------------*/
		CREATE TABLE #PROCESS_LOG
		(
			PROCESS_ID VARCHAR(100),
			PROCESS_STAT VARCHAR(200) 
		)


		/*--------------------- Import Trade ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND Import_Trade > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Import Trade','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Import Trade','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='IMPTRD')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Import Trade','Done')
			END
		END




		/*--------------------- VBB Computation ------------------------*/ 
		IF (SELECT COUNT(1) FROM SCHEME_MAPPING (NOLOCK)) > 0
		BEGIN
			IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
				WHERE Left(Business_Date,11) = @PROCESSDATE AND VBB > 0)= 0 
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('VBB Computation','Pending')
			END
			ELSE
			BEGIN
				INSERT INTO #PROCESS_LOG 
				SELECT 'VBB Computation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
				WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
				FROM V2_PROCESS_STATUS_LOG (NOLOCK)
				WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
					WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VBB')
			END

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('VBB Computation','Done')
			END
		END


		/*--------------------- Position File Import ------------------------*/ 
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND PositionFile > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Position File Import','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Position File Import','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='POSIMP')


			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Position File Import','Done')
			END
		END


		/*--------------------- BILL GENERATION ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND Billing > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Bill Generation','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Bill Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='BILLGEN')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Bill Generation','Done')
			END
		END


		/*--------------------- VALAN GENERATION ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND Billing > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Valan Generation','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Valan Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VALANGEN')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Valan Generation','Done')
			END
		END

		/*--------------------- BILL POSTING ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND POSTING > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Bill Posting','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT  'Bill Posting','Done - ' + PROC_STAT FROM
			(SELECT TOP 1 (CASE WHEN CONVERT(VARCHAR,POSTDATE,108) <> '00:00:00' 
			THEN CONVERT(VARCHAR,POSTDATE) ELSE LEFT(POSTDATE,11) END ) + 
			(CASE WHEN ISNULL(USERNAME,'')<>'' THEN ' ('+ USERNAME + ')' ELSE '' END) AS PROC_STAT
			FROM  ACCOUNTNCE.DBO.BILLPOSTED (NOLOCK) WHERE VDT BETWEEN @PROCESSDATE AND @PROCESSDATE + ' 23:59') STAT

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Bill Posting','Done')
			END
		END


		/*--------------------- Contract Print canned data Popup ------------------------*/
		IF (SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK) ) <> 'NCM'
		BEGIN
			IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
				WHERE Left(Business_Date,11) = @PROCESSDATE AND CONTRACT > 0) = 0 
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Contract Print Data Popup','Pending')
			END
			ELSE
			BEGIN
				INSERT INTO #PROCESS_LOG 
				SELECT 'Contract Print Data Popup','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
				WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
				FROM V2_PROCESS_STATUS_LOG (NOLOCK)
				WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
					WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='CONTRACT')
			END

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Contract Print Data Popup','Done')
			END
		END

		/*--------------------- Margin File Import ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND MarginFile > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Margin File Import','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Margin File Import','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGIMP')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Margin File Import','Done')
			END
		END

	
		/*--------------------- Margin Return File Generation ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND MarginReturnFile > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Margin Return File Generation','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Margin Return File Generation','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGFILE')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Margin Return File Generation','Done')
			END
		END
	

		/*--------------------- Margin Report Data Popup ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE Left(Business_Date,11) = @PROCESSDATE AND ClientMarginPop > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('Margin Report Data Popup','Pending')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'Margin Report Data Popup','Done - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGPOP')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('Margin Report Data Popup','Done')
			END
		END



		SELECT * FROM #PROCESS_LOG
	
		DROP TABLE #PROCESS_LOG
		
		
		
	END

/*--------------------------------------------- EOF --------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.v2_sp_sortby
-- --------------------------------------------------
CREATE procedure v2_sp_sortby as

select sortname,sortval from v2_sortby

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_ADMINPASSWORD
-- --------------------------------------------------
CREATE PROC V2_UPDATE_ADMINPASSWORD
(    
 @PASSWORD VARCHAR(512),    
 @ADMINID VARCHAR(25),    
 @DAYCOUNT INT     
)    
    
AS    
    
    
SET NOCOUNT ON    
    
DECLARE @@FLDOLDPASSWORD TINYINT    
DECLARE @@FLDAUTO INT    
DECLARE @@PASSAUTO BIGINT    
DECLARE @@OLDPASSSTRING VARCHAR(2000)    
DECLARE @@OLDPASSCOUNT INT    
DECLARE @@NEWPASSSTRING VARCHAR(2000)    
    
    
/*    
CREATE TABLE TBLUSERPASSHIST    
(    
 FLDAUTO BIGINT IDENTITY(1,1),    
 FLDUSERID INT,    
 FLDOLDPASSLISTING VARCHAR(2000)    
)    
select * from TBLADMINPASSHIST
*/    
    
    
SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS    
    
IF ISNULL(@@FLDOLDPASSWORD,0) = 0    
BEGIN    
 SET @@FLDOLDPASSWORD = 1    
END    
    
    
    
SELECT @@FLDAUTO = ISNULL(FLDAUTO_ADMIN,0) FROM TBLADMIN    
WHERE FLDNAME = @ADMINID    
    
IF ISNULL(@@FLDAUTO,0) = 0    
BEGIN    
 SELECT MSG = 'ADMIN USER NOT FOUND'    
 RETURN    
END    
    
    
    
SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLADMINPASSHIST    
WHERE FLDADMINID = @@FLDAUTO    
    
IF ISNULL(@@OLDPASSSTRING,'') = ''    
BEGIN    
 SET @@OLDPASSSTRING = ''    
END    
    
IF ISNULL(@@PASSAUTO,0) = 0    
BEGIN    
 SET @@PASSAUTO = 0    
END    
    
    
SELECT     
 @@OLDPASSCOUNT = COUNT(1)    
FROM     
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
WHERE     
 SPLITTED_VALUE = @PASSWORD    
 AND SNO > (    
      SELECT     
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)    
      FROM     
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
     )    
    
    
IF ISNULL(@@OLDPASSCOUNT,0) > 0    
BEGIN    
 SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'    
 RETURN    
END    
    
    
    
UPDATE TBLADMIN     
SET     
 FLDPASSWORD = @PASSWORD,    
 PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT),  
 FLDATTEMPTCNT = 0   
WHERE     
 FLDAUTO_ADMIN = @@FLDAUTO    
    
SET @@NEWPASSSTRING = ''    
    
DECLARE @@STRING VARCHAR(100)    
    
DECLARE vendor_cursor CURSOR FOR     
    
SELECT SPLITTED_VALUE    
FROM     
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
WHERE  SNO > (    
      SELECT     
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)    
      FROM     
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
     )    
OPEN vendor_cursor    
    
FETCH NEXT FROM vendor_cursor     
INTO @@STRING    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''    
FETCH NEXT FROM vendor_cursor     
INTO @@STRING    
END     
    
CLOSE vendor_cursor    
DEALLOCATE vendor_cursor    
    
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD     
    
IF ISNULL(@@PASSAUTO,0) = 0    
BEGIN    
 INSERT INTO TBLADMINPASSHIST     
 (FLDADMINID, FLDOLDPASSLISTING)     
 VALUES    
 (@@FLDAUTO, @@NEWPASSSTRING)    
END    
ELSE    
BEGIN    
 UPDATE TBLADMINPASSHIST    
 SET FLDOLDPASSLISTING = @@NEWPASSSTRING    
 WHERE FLDAUTO = @@PASSAUTO    
 AND FLDADMINID = @@FLDAUTO     
END    
    
SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'    
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_PASSWORD
-- --------------------------------------------------


CREATE  PROC V2_UPDATE_PASSWORD
(
	@PASSWORD VARCHAR(15),
	@USERID VARCHAR(25),
	@DAYCOUNT INT	
)

AS


SET NOCOUNT ON

DECLARE @@FLDOLDPASSWORD TINYINT
DECLARE @@FLDAUTO INT
DECLARE @@PASSAUTO BIGINT
DECLARE @@OLDPASSSTRING VARCHAR(2000)
DECLARE @@OLDPASSCOUNT INT
DECLARE @@NEWPASSSTRING VARCHAR(2000)


/*
CREATE TABLE TBLUSERPASSHIST
(
	FLDAUTO BIGINT IDENTITY(1,1),
	FLDUSERID INT,
	FLDOLDPASSLISTING VARCHAR(2000)
)
*/


SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS

IF ISNULL(@@FLDOLDPASSWORD,0) = 0
BEGIN
	SET @@FLDOLDPASSWORD = 1
END



SELECT @@FLDAUTO = ISNULL(FLDAUTO,0) FROM TBLPRADNYAUSERS
WHERE FLDUSERNAME = @USERID

IF ISNULL(@@FLDAUTO,0) = 0
BEGIN
	SELECT MSG = 'USER NOT FOUND'
	RETURN
END



SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLUSERPASSHIST
WHERE FLDUSERID = @@FLDAUTO

IF ISNULL(@@OLDPASSSTRING,'') = ''
BEGIN
	SET @@OLDPASSSTRING = ''
END

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	SET @@PASSAUTO = 0
END


SELECT 
	@@OLDPASSCOUNT = COUNT(1)
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE 
	SPLITTED_VALUE = @PASSWORD
	AND SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)


IF ISNULL(@@OLDPASSCOUNT,0) > 0
BEGIN
	SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'
	RETURN
END



UPDATE TBLPRADNYAUSERS 
SET 
	FLDPASSWORD = @PASSWORD,
	PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT)
WHERE 
	FLDAUTO = @@FLDAUTO

								
UPDATE TBLUSERCONTROLMASTER 
SET 
	FLDATTEMPTCNT = 0,
	FLDFIRSTLOGIN = 'N'
WHERE 
	TBLUSERCONTROLMASTER.FLDUSERID = @@FLDAUTO 



SET @@NEWPASSSTRING = ''


DECLARE @@STRING VARCHAR(100)

DECLARE vendor_cursor CURSOR FOR 

SELECT SPLITTED_VALUE
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE  SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)
OPEN vendor_cursor

FETCH NEXT FROM vendor_cursor 
INTO @@STRING

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''
FETCH NEXT FROM vendor_cursor 
INTO @@STRING
END 

CLOSE vendor_cursor
DEALLOCATE vendor_cursor

	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD 

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	INSERT INTO TBLUSERPASSHIST 
	(FLDUSERID, FLDOLDPASSLISTING) 
	VALUES
	(@@FLDAUTO, @@NEWPASSSTRING)
END
ELSE
BEGIN
	UPDATE TBLUSERPASSHIST
	SET FLDOLDPASSLISTING = @@NEWPASSSTRING
	WHERE FLDAUTO = @@PASSAUTO
	AND FLDUSERID = @@FLDAUTO 
END

SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPLOADDPC7_BULK
-- --------------------------------------------------


CREATE PROC [DBO].[V2_UPLOADDPC7_BULK](                
         @FNAME VARCHAR(200),                
         @UNAME VARCHAR(50))                 
                
AS                
/*                
EXEC V2_UPLOADDPC7_BULK 'E:\BACKOFFICE\08DPC7U.636653',''                
*/                
--SET NOCOUNT ON                 
                
DECLARE                  
 @ROWDATA  VARCHAR(2000),                
 @FILEDATA CURSOR,                
 @@SQL VARCHAR(1000),    
 @@REFNO INT,
 @@SNO  INT,
 @@SQLCUR CURSOR,
 @@CLTDPID VARCHAR(16)
    
SELECT  @@REFNO = REFNO FROM DELSEGMENT               
                
 CREATE TABLE #TMP                
 (                
  FLDDETAILS VARCHAR(1000)                
 )                
                
 CREATE TABLE #TMP_1                
 (                
  SNO        INT IDENTITY(1,1) NOT NULL,                 
  FLDDETAILS VARCHAR(1000),                 
  CLTDPID    VARCHAR(16),              
CONSTRAINT [IDX_SNO_1] PRIMARY KEY CLUSTERED               
(              
 SNO ASC              
)                   
 )                
                
CREATE NONCLUSTERED INDEX [IDX_CLTDPID] ON [DBO].[#TMP_1]               
(              
 [CLTDPID]              
)              
              
 CREATE TABLE #TMP_2               
 (                
  SNO        INT,                 
  CLTDPID    VARCHAR(16),              
CONSTRAINT [IDX_SNO_3] PRIMARY KEY CLUSTERED               
(              
 SNO ASC              
)                      
 )                
              
 CREATE TABLE #DPC7                
 (                
  SNO        INT IDENTITY(1,1) NOT NULL,                 
  RECTYPE    VARCHAR(2),                 
  ISIN       VARCHAR(12),              
  CURRQUANTITY VARCHAR(50),                
  FREEQUANTITY VARCHAR(50),                 
  EARMARKQUANTITY VARCHAR(50),              
  PLEDGEQUANTITY VARCHAR(50),              
  REMLOCQUANTITY VARCHAR(50),              
  SCRIP_NAME1   VARCHAR(50),                 
  SCRIP_NAME2   VARCHAR(100),                 
  SCRIP_NAME3   VARCHAR(150),                 
  FILLER1       VARCHAR(10),              
  FILLER2       VARCHAR(10),              
  FILLER3       VARCHAR(10),              
  FILLER4       VARCHAR(10),              
  FILLER5       VARCHAR(10),              
  FILLER6       VARCHAR(10),     
  SETTNO     VARCHAR(13),              
  CLTDPID    VARCHAR(16)               
 )                
                
 SELECT @@SQL = 'BULK INSERT #TMP FROM '''+ @FNAME + ''' WITH (FIRSTROW = 1) '                
 EXEC(@@SQL)                
      
 ALTER TABLE #TMP               
 ADD SNO INT IDENTITY(1,1) NOT NULL      
                
  DELETE FROM #TMP                 
  WHERE  FLDDETAILS NOT LIKE '01%'                
         AND FLDDETAILS NOT LIKE '04%'                
                
   SELECT @@SQL = 'INSERT INTO #TMP_1 (FLDDETAILS, CLTDPID)'      
   SELECT @@SQL = @@SQL + 'SELECT         '      
   SELECT @@SQL = @@SQL + 'FLDDETAILS,    '      
   SELECT @@SQL = @@SQL + 'CLTDPID = (CASE WHEN FLDDETAILS LIKE ''01%'' THEN SUBSTRING(FLDDETAILS,4,8) + SUBSTRING(FLDDETAILS,13,8) ELSE '''' END)'              
  SELECT @@SQL = @@SQL + ' FROM   #TMP ORDER BY SNO'      
 EXEC(@@SQL)         
              
 INSERT INTO #TMP_2               
 SELECT SNO, CLTDPID                
 FROM   #TMP_1                
 WHERE  CLTDPID <> ''              

SET @@SQLCUR = CURSOR FOR
	SELECT SNO, CLTDPID FROM #TMP_2
	ORDER BY SNO DESC
OPEN @@SQLCUR
FETCH NEXT FROM @@SQLCUR INTO @@SNO, @@CLTDPID 
WHILE @@FETCH_STATUS = 0 
BEGIN
	--SELECT @@SNO
	
	UPDATE #TMP_1 SET #TMP_1.FLDDETAILS = #TMP_1.FLDDETAILS + '~' + @@CLTDPID, CLTDPID = @@CLTDPID
	WHERE #TMP_1.SNO > @@SNO
	AND #TMP_1.CLTDPID = ''
	
	FETCH NEXT FROM @@SQLCUR INTO @@SNO, @@CLTDPID 	
END 
CLOSE @@SQLCUR
DEALLOCATE @@SQLCUR

/*              
  UPDATE #TMP_1          
  SET    #TMP_1.FLDDETAILS = #TMP_1.FLDDETAILS + '~' + T.CLTDPID                
  FROM  #TMP_2 T                 
  WHERE  T.SNO = (SELECT TOP 1 SNO                
                  FROM   #TMP_1 S                
                  WHERE  S.SNO < #TMP_1.SNO                
                         AND S.CLTDPID <> ''                
                  ORDER BY 1 DESC)                
         AND #TMP_1.CLTDPID = ''              
*/
              
 SET @FILEDATA = CURSOR FOR  SELECT REPLACE(FLDDETAILS,'''','') FROM #TMP_1 WHERE  FLDDETAILS LIKE '04%' ORDER BY SNO                 
 OPEN @FILEDATA                      
                 
 FETCH NEXT FROM @FILEDATA INTO @ROWDATA              
 WHILE @@FETCH_STATUS = 0                       
 BEGIN                      
                
  SELECT @@SQL =  'INSERT INTO #DPC7 (RECTYPE,ISIN,CURRQUANTITY,FREEQUANTITY,EARMARKQUANTITY,PLEDGEQUANTITY,
  REMLOCQUANTITY,SCRIP_NAME1,SCRIP_NAME2,SCRIP_NAME3,FILLER1,FILLER2,FILLER3,FILLER4,FILLER5,FILLER6,SETTNO,CLTDPID) VALUES (' + ''''+ REPLACE(''+ @ROWDATA +'','~',''',''') + ''')'                
  EXEC (@@SQL)                
 FETCH NEXT FROM @FILEDATA INTO @ROWDATA              
 END                      
 CLOSE @FILEDATA            
 DEALLOCATE @FILEDATA                
      
UPDATE #DPC7 SET             
SETTNO = (CASE WHEN LEFT(SETTNO,6) = '111000'             
      THEN '20' + LEFT(RIGHT(SETTNO,7),2) + RIGHT(SETTNO,3) + 'D'     
      WHEN LEFT(SETTNO,6) = '111004'             
      THEN '20' + LEFT(RIGHT(SETTNO,7),2) + RIGHT(SETTNO,3) + 'AD'             
      WHEN LEFT(SETTNO,6) = '121100'             
      THEN RIGHT(SETTNO,7) + 'G'     
      WHEN LEFT(SETTNO,6) = '121104'             
      THEN RIGHT(SETTNO,7) + 'W'     
      WHEN LEFT(SETTNO,6) = '121101'             
      THEN RIGHT(SETTNO,7) + 'A'      
      WHEN LEFT(SETTNO,6) = '999999' AND @@REFNO = 110    
      THEN RIGHT(SETTNO,7) + 'G'    
      WHEN LEFT(SETTNO,6) = '999999' AND @@REFNO = 120    
      THEN RIGHT(SETTNO,7) + 'D'    
   ELSE RIGHT(SETTNO,7) + 'G'    
      END)    
WHERE SETTNO <> ''     

TRUNCATE TABLE DELCDSLBALANCE    
    
  INSERT INTO DELCDSLBALANCE    
  SELECT PARTY_CODE=(CASE WHEN SETTNO = '' THEN 'PARTY' ELSE SETTNO END),DPID=LEFT(CLTDPID,8),              
  CLTDPID,SCRIP_CD='',SERIES='',ISIN,FREEBAL=CONVERT(INT,CONVERT(NUMERIC(18, 4),FREEQUANTITY)),CURRBAL=CONVERT(INT,CONVERT(NUMERIC(18, 4),CURRQUANTITY)),              
  FREEZEBAL=0,LOCKINBAL=0,PLEDGEBAL=CONVERT(INT,CONVERT(NUMERIC(18, 4),PLEDGEQUANTITY)),DPVBAL=0,DPCBAL=0,RPCBAL=0,ELIMBAL=0,EARMARKBAL=CONVERT(INT,CONVERT(NUMERIC(18, 4),EARMARKQUANTITY)),              
  REMLOCKBAL=CONVERT(INT,CONVERT(NUMERIC(18, 4),REMLOCQUANTITY)),TOTALBALANCE=CONVERT(INT,CONVERT(NUMERIC(18, 4),FREEQUANTITY)),TRDATE=GETDATE()               
  FROM #DPC7                 
                
  DROP TABLE #TMP                
  DROP TABLE #TMP_1                 
  DROP TABLE #TMP_2              
  DROP TABLE #DPC7

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_User_Report_Mapping
-- --------------------------------------------------

CREATE Proc V2_User_Report_Mapping  
@fldstat varchar(15)          
  
AS  
  
Select   
      u.fldusername,  
      fldname = u.fldfirstname +  ' ' + u.fldmiddlename + ' ' + u.fldlastname,  
      u.fldstname,  
      a.fldstatus,   
      c.fldcategoryname,   
      r.fldreportname,   
      r.fldpath,   
      g.fldgrpname,   
      m.fldmenuname,  
      Branch_Cd = isnull(branch_cd,''),   
      Trader = isnull(trader,a.fldstatus + ' Login'),   
      Client_Name = isnull(long_name,a.fldstatus + ' Login')   
From   
      TblAdmin a (nolock),  
      TblCategory c (nolock),  
      tblreports r (nolock),   
      tblreportgrp g (nolock),   
      tblmenuhead m (nolock),   
      tblcatmenu cm (nolock),     
      TblPradnyaUsers u  (nolock)  
      left outer join   
      (  
            Select   
                  Party_Code,   
                  Branch_Cd,  
                  Trader,  
                  Long_Name  
            From  
                  Client1 C1 (nolock),  
                  Client2 C2 (nolock)  
            Where  
                  C1.Cl_COde = C2.Cl_Code  
      ) cl  
      on  
      (cl.party_code = u.fldstname)  
Where   
      u.fldadminauto = a.fldauto_admin  
      And u.fldcategory = c.fldcategorycode   
      And r.fldreportgrp =g.fldreportgrp    
      and r.fldmenugrp = m.fldmenucode    
      and r.fldreportcode = cm.fldreportcode    
--      and u.fldcategory = 8  
      and cm.fldcategorycode like '%,' + u.fldcategory + ',%' 
      and a.fldstatus=@fldstat
Order By   
      u.fldusername,   
      g.fldgrpname,   
      m.fldmenuname,  
      r.fldreportname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_User_Report_Mapping_withoutrep
-- --------------------------------------------------

create Proc V2_User_Report_Mapping_withoutrep    
@fldstat varchar(15)            
    
AS    
    
Select distinct      
      u.fldusername,    
      fldname = u.fldfirstname +  ' ' + u.fldmiddlename + ' ' + u.fldlastname,    
      u.fldstname,    
      a.fldstatus,     
      c.fldcategoryname     
    /*  r.fldreportname,     
      r.fldpath,     
      g.fldgrpname,     
      m.fldmenuname,    
      Branch_Cd = isnull(branch_cd,''),     
      Trader = isnull(trader,a.fldstatus + ' Login'),     
      Client_Name = isnull(long_name,a.fldstatus + ' Login')     */
From     
      TblAdmin a (nolock),    
      TblCategory c (nolock),    
      tblreports r (nolock),     
      tblreportgrp g (nolock),     
      tblmenuhead m (nolock),     
      tblcatmenu cm (nolock),       
      TblPradnyaUsers u  (nolock)    
      left outer join     
      (    
            Select     
                  Party_Code,     
                  Branch_Cd,    
                  Trader,    
                  Long_Name    
            From    
                  Client1 C1 (nolock),    
                  Client2 C2 (nolock)    
            Where    
                  C1.Cl_COde = C2.Cl_Code    
      ) cl    
      on    
      (cl.party_code = u.fldstname)    
Where     
      u.fldadminauto = a.fldauto_admin    
      And u.fldcategory = c.fldcategorycode     
      And r.fldreportgrp =g.fldreportgrp      
      and r.fldmenugrp = m.fldmenucode      
      and r.fldreportcode = cm.fldreportcode      
      and cm.fldcategorycode like '%,' + u.fldcategory + ',%'   
      and a.fldstatus=@fldstat  
Order By     
      u.fldusername
   --   g.fldgrpname,     
 --     m.fldmenuname,    
--      r.fldreportname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_ADDITIONAL_PROCESS
-- --------------------------------------------------
-- Query For ALL FUTURES AND CURRENCY Segments --

CREATE PROC VALAN_ADDITIONAL_PROCESS
(
	@BILLDATE	VARCHAR(11)
)
AS

DECLARE @SBCCODE VARCHAR(10)
DECLARE @SBCCODEPAY VARCHAR(10) 
DECLARE @KKCCODE VARCHAR(10)
DECLARE @KKCCODEPAY VARCHAR(10) 

SET @SBCCODE = ''
SET @SBCCODEPAY = ''
SET @KKCCODE = ''
SET @KKCCODEPAY = ''

SELECT @KKCCODE = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'KRISHI KALYAN CESS'

SELECT @KKCCODEPAY = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'KRISHI KALYAN CESS PAYABLE'

SELECT @SBCCODE = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'SWACHH BHARAT CESS'

SELECT @SBCCODEPAY = ACCODE FROM VALANACCOUNT 
WHERE ACNAME = 'SWACHH BHARAT CESS PAYABLE'

IF ISNULL(@SBCCODE,'')='' AND ISNULL(@KKCCODE,'')=''
BEGIN
	RETURN
END

SELECT A.* INTO #SBC
FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
WHERE BILLDATE = @BILLDATE
AND PARTY_CODE = ACCODE
AND V.ACNAME = 'SERVICE TAX'
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
AND ISNULL(SBCCHARGE,0) > 0

IF (SELECT ISNULL(COUNT(1),0) FROM #SBC) > 0 
BEGIN
	UPDATE #SBC SET PARTY_CODE = @SBCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2)
	FROM FOGLOBALS
	WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	AND ISNULL(SBCCHARGE,0) > 0

	SELECT A.* INTO #SERTAX
	FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
	WHERE BILLDATE = @BILLDATE
	AND PARTY_CODE = ACCODE
	AND V.ACNAME = 'SERVICE TAX'
	AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	AND ISNULL(SBCCHARGE,0) > 0

	UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #SBC.AMOUNT
	FROM #SBC 
	WHERE #SERTAX.BILLDATE = #SBC.BILLDATE
	AND #SERTAX.BRANCHCD = #SBC.BRANCHCD

	
	INSERT INTO FOACCBILL
	SELECT * FROM #SBC


		SELECT A.* INTO #KKC
		FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
		WHERE BILLDATE = @BILLDATE
		AND PARTY_CODE = ACCODE
		AND V.ACNAME = 'SERVICE TAX'
		AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
		AND ISNULL(KRISHICHARGE,0) > 0

		IF (SELECT ISNULL(COUNT(1),0) FROM #KKC) > 0 
		BEGIN
			UPDATE #KKC SET PARTY_CODE = @KKCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)
			FROM FOGLOBALS
			WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
			AND ISNULL(KRISHICHARGE,0) > 0

			UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #KKC.AMOUNT
			FROM #KKC 
			WHERE #SERTAX.BILLDATE = #KKC.BILLDATE
			AND #SERTAX.BRANCHCD = #KKC.BRANCHCD


			INSERT INTO FOACCBILL
			SELECT * FROM #KKC

		END
		DROP TABLE #KKC
		
	
	DELETE FROM FOACCBILL
	WHERE BILLDATE = @BILLDATE
	AND EXISTS (SELECT PARTY_CODE FROM #SERTAX WHERE FOACCBILL.PARTY_CODE = #SERTAX.PARTY_CODE)	

	INSERT INTO FOACCBILL
	SELECT * FROM #SERTAX

	DROP TABLE #SERTAX
END
DROP TABLE #SBC

SELECT A.* INTO #PAYSBC
FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
WHERE BILLDATE = @BILLDATE
AND PARTY_CODE = ACCODE
AND V.ACNAME = 'SERVICE TAX PAYABLE'
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
AND ISNULL(SBCCHARGE,0) > 0

IF (SELECT ISNULL(COUNT(1),0) FROM #PAYSBC) > 0 
BEGIN
	UPDATE #PAYSBC SET PARTY_CODE = @SBCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2)
	FROM FOGLOBALS
	WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	AND ISNULL(SBCCHARGE,0) > 0

	SELECT A.* INTO #PAYSERTAX
	FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
	WHERE BILLDATE = @BILLDATE
	AND PARTY_CODE = ACCODE
	AND V.ACNAME = 'SERVICE TAX PAYABLE'
	AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
	AND ISNULL(SBCCHARGE,0) > 0

	UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYSBC.AMOUNT
	FROM #PAYSBC 
	WHERE #PAYSERTAX.BILLDATE = #PAYSBC.BILLDATE
	AND #PAYSERTAX.BRANCHCD = #PAYSBC.BRANCHCD

	INSERT INTO FOACCBILL
	SELECT * FROM #PAYSBC

		SELECT A.* INTO #PAYKKC
		FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS
		WHERE BILLDATE = @BILLDATE
		AND PARTY_CODE = ACCODE
		AND V.ACNAME = 'SERVICE TAX PAYABLE'
		AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
		AND ISNULL(KRISHICHARGE,0) > 0

		IF (SELECT ISNULL(COUNT(1),0) FROM #PAYKKC) > 0 
		BEGIN
			UPDATE #PAYKKC SET PARTY_CODE = @KKCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)
			FROM FOGLOBALS
			WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT 
			AND ISNULL(KRISHICHARGE,0) > 0

			UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYKKC.AMOUNT
			FROM #PAYKKC 
			WHERE #PAYSERTAX.BILLDATE = #PAYKKC.BILLDATE
			AND #PAYSERTAX.BRANCHCD = #PAYKKC.BRANCHCD

			DELETE FROM FOACCBILL
			WHERE BILLDATE = @BILLDATE
			AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAXKKC WHERE FOACCBILL.PARTY_CODE = #PAYSERTAXKKC.PARTY_CODE)

			INSERT INTO FOACCBILL
			SELECT * FROM #PAYKKC

		END
		DROP TABLE #PAYKKC

	DELETE FROM FOACCBILL
	WHERE BILLDATE = @BILLDATE
	AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAX WHERE FOACCBILL.PARTY_CODE = #PAYSERTAX.PARTY_CODE)

	INSERT INTO FOACCBILL
	SELECT * FROM #PAYSERTAX

	DROP TABLE #PAYSERTAX
END
DROP TABLE #PAYSBC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_GST_BILLPOST
-- --------------------------------------------------
CREATE PROC [dbo].[VALAN_GST_BILLPOST]
(
	@BILLDATE	VARCHAR(11)
)
AS


DECLARE @NARRATION VARCHAR(100),
		@START_DATE	DATETIME,
		@END_DATE	DATETIME,
		@PAYIN_DATE	DATETIME,
		@PAYOUT_DATE DATETIME

SELECT @NARRATION = ISNULL(MAX(NARRATION),'BILL POSTED'),
	   @START_DATE = MAX(START_DATE),
	   @END_DATE = MAX(END_DATE),
	   @PAYIN_DATE = MAX(PAYIN_DATE),
	   @PAYOUT_DATE = MAX(PAYOUT_DATE)
 FROM FOACCBILL WHERE Billdate LIKE @BILLDATE + '%'

SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
INTO #GSTDATA
FROM TBL_CLIENT_GST_DATA G, TBL_GST_LOCATION L, FOBILLVALAN N 
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59'
AND N.Party_Code = G.PARTY_CODE
AND GST_LOCATION = LOC_CODE
AND @BILLDATE BETWEEN G.EFF_FROM_DATE AND G.EFF_TO_DATE
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
GROUP BY N.PARTY_CODE,N.Branch_Code,L_STATE,STATE 

INSERT INTO #GSTDATA
SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=FOOWNER.STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
FROM FOBILLVALAN N, FOOWNER,
TBL_STATE_GST_DATA T, CLIENT1 G
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59' 
AND FOOWNER.State = STATE_NAME
AND @BILLDATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE 
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
AND N.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #GSTDATA WHERE N.PARTY_CODE = #GSTDATA.Party_Code)
AND G.CL_CODE = N.Party_Code
GROUP BY N.PARTY_CODE,N.Branch_Code,FOOWNER.STATE, L_STATE 

UPDATE #GSTDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM STATE_MASTER  WHERE STATE <> 'OTHER')

UPDATE #GSTDATA SET 
STATE_CODE=D.STATE_CODE,
GST_PER=D.GST_PER,
CGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.CGST_PER ELSE 0 END),
IGST_PER=(CASE WHEN SOURCESTATE <> TARGETSTATE THEN D.IGST_PER ELSE 0 END),
SGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 0 THEN D.SGST_PER ELSE 0 END),
UGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 1 THEN D.UGST_PER ELSE 0 END),
AGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.AGST_PER ELSE 0 END)
FROM TBL_STATE_GST_DATA D
WHERE D.STATE_NAME = SOURCESTATE
AND @BILLDATE BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

UPDATE #GSTDATA SET 
CGST_PER = SERVICE_TAX * CGST_PER / GST_PER,
SGST_PER = SERVICE_TAX * SGST_PER / GST_PER,
IGST_PER = SERVICE_TAX * IGST_PER / GST_PER,
UGST_PER = SERVICE_TAX * UGST_PER / GST_PER,
AGST_PER = SERVICE_TAX * AGST_PER / GST_PER

UPDATE #GSTDATA SET SGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + UGST_PER + AGST_PER)
WHERE SGST_PER > 0 
UPDATE #GSTDATA SET UGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + SGST_PER + AGST_PER)
WHERE UGST_PER > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) <= 0 
BEGIN
	RETURN
END
 
IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) > 0 
BEGIN
	DELETE FROM FOACCBILL 
	WHERE Billdate LIKE @BILLDATE + '%'
	AND Party_Code IN (SELECT ACCODE FROM Valanaccount
	WHERE ACNAME = 'SERVICE TAX')

	DELETE FROM FOACCBILL 
	WHERE  Billdate LIKE @BILLDATE + '%'
	AND PARTY_CODE IN (SELECT ACCODE FROM VALANACCOUNT WHERE ACNAME = 'ROUNDING OFF')

	UPDATE FOACCBILL SET AMOUNT = ROUND(AMOUNT,2)
	WHERE  Billdate LIKE @BILLDATE + '%'
END

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),0,0,0,0,Branchcd,NARRATION=@NARRATION
FROM FOACCBILL G, VALANACCOUNT 
WHERE Billdate LIKE @BILLDATE + '%'
AND ACNAME = 'ROUNDING OFF' 
AND Branchcd <> 'ZZZ'
GROUP BY ACCODE,BRANCHCD 
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0 
ORDER BY BRANCHCD 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),0,0,0,0,'ZZZ',NARRATION=@NARRATION 
FROM FOACCBILL G, VALANACCOUNT, ACCOUNTNCE.DBO.ACMAST 
WHERE Billdate LIKE @BILLDATE + '%'
AND VALANACCOUNT.ACNAME = 'ROUNDING OFF' 
AND G.Party_Code = CLTCODE 
AND (BRANCHCD = 'ZZZ' OR ACCAT = 4)
GROUP BY ACCODE
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_CI_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[VBB_CI_NEW] 
AS 
SELECT DISTINCT PARTY_CODE,TABLE_NAME  INTO #CLT FROM  FOCLIENTBROKSCHEME C WITH(NOLOCK) ,BROKTABLE B  WHERE C.FUT_BROKTABLE  =B.TABLE_NO
AND ( TABLE_NAME LIKE '%VBB%' OR TABLE_NAME LIKE '%Plus%' OR TABLE_NAME LIKE '%Value Add Plan%') 
  AND DATE_FROM >CONVERT(VARCHAR(11),GETDATE()-5,120)  AND DATE_TO > GETDATE() 

  CREATE INDEX #CL ON #CLT (PARTY_CODE)
  
INSERT INTO Scheme_Mapping
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'FUT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND DEL_SCHEME_ID <> ''
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND TRD_SCHEME_ID <> ''
 ) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE  AND SP_Date_To>getdate()) 
UNION ALL
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'OPT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND DEL_SCHEME_ID <> ''
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND TRD_SCHEME_ID <> ''
) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE  AND SP_Date_To>getdate()) 


UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'
FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code AND CR_Date_To >= GETDATE()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_CI_NEW_CLIENT
-- --------------------------------------------------

CREATE PROC [dbo].[VBB_CI_NEW_CLIENT] (@PARTY_CODE VARCHAR(10),@BROK_SCHEME VARCHAR(50)) 
AS 

--SELECT DISTINCT PARTY_CODE =@PARTY_CODE ,TABLE_NAME =@BROK_SCHEME INTO #CLT 

--CREATE INDEX #CL ON #CLT (PARTY_CODE)

SELECT DISTINCT PARTY_CODE =Cl_Code ,TABLE_NAME =@BROK_SCHEME INTO #CLT 
From Client5 With(Nolock) where Cl_code =@PARTY_CODE
CREATE INDEX #CL ON #CLT (PARTY_CODE)

IF(Select Count(1) from #CLT) >=1
Begin 

UPDATE Scheme_Mapping SET SP_Date_To= CONVERT(VARCHAR(11),GETDATE()-1,120)  + ' 23:59:59.000' WHERE SP_Party_Code =@PARTY_CODE AND  SP_Date_To >GETDATE()

INSERT INTO Scheme_Mapping
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'FUT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE 
AND DEL_SCHEME_ID <> ''
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND TRD_SCHEME_ID <> ''
 ) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE()) 
UNION ALL
SELECT DISTINCT * FROM (
SELECT  PARTY_CODE,'O' A , 'OPT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType,	MIN_BROK	,MAX_BROK,'0.0000' S,'-1.0000' T,
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM 
(
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER,	DEL_TO_TURNOVER	 AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND DEL_SCHEME_ID <> '' 
UNION ALL
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER,	TO_TURNOVER	,MIN_BROK,	MAX_BROK 
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='NCE' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE
AND TRD_SCHEME_ID <> ''
 ) A ,
Scheme_Master S ,#CLT V
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER
---AND PARTY_CODE  IN (SELECT * FROM #CL)
) A
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE()) 


UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'
FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code  AND CR_Date_To >= GETDATE()


--UPDATE R SET TODATE = CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000'
--FROM  TBL_ADDITIONAL_BROEKRAGE R, #CLT C WHERE R.Party_Code =C.Party_Code  AND TODATE >= GETDATE()



END
ELSE 
BEGIN 
		Select 'Client Not Registered' As Status

   Return

End




--IF @@ROWCOUNT =0 
--  BEGIN 

--   Select 'Aleready Marked' As Status

--   Return
--  End

--UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'
--FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code  AND CR_Date_To >= GETDATE()

--UPDATE R SET TODATE = CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000'
--FROM  TBL_ADDITIONAL_BROEKRAGE R, #CLT C WHERE R.Party_Code =C.Party_Code  AND TODATE >= GETDATE()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_DailyMapping
-- --------------------------------------------------
CREATE PROC [dbo].[VBB_DailyMapping] AS        
        
BEGIN TRAN        
        
/*--------------------------------- OPTION ALL TRD SINGLE SIDE --------------------------*/              
SELECT * INTO #SCHEME_MAP FROM CLIENT5 WHERE ACTIVEFROM  >= CONVERT(VARCHAR(11),GETDATE()-5,120) 
AND CONVERT(VARCHAR(11),ACTIVEFROM,120) <=CONVERT(VARCHAR(11),GETDATE(),120)

CREATE INDEX #SCHEME_MAP ON #SCHEME_MAP (CL_CODE)

SELECT *  INTO #FOCLIENTBROKSCHEME FROM  FOCLIENTBROKSCHEME 
WHERE  CONVERT(VARCHAR(11),DATE_FROM,120)  >=CONVERT(VARCHAR(11),GETDATE()-5,120) 
AND CONVERT(VARCHAR(11),DATE_FROM,120) <= CONVERT(VARCHAR(11),GETDATE() ,120)
AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

SELECT DISTINCT TABLE_NO INTO #BROKTABLE  FROM BROKTABLE WHERE ( TABLE_NAME LIKE '%VBB%' OR TABLE_NAME LIKE '%PLUS%' OR TABLE_NAME LIKE '%Value Add Plan%') 

DELETE FROM  #FOCLIENTBROKSCHEME WHERE PARTY_CODE IN 
(SELECT DISTINCT SP_PARTY_CODE FROM SCHEME_MAPPING WHERE SP_SCHEME_ID IN ('52','53','54','55','56','57','58','59')) 
AND DATE_TO > GETDATE()

DELETE  FROM  #FOCLIENTBROKSCHEME WHERE --PARTY_CODE IN ( SELECT DISTINCT CL_CODE FROM CLIENT_DETAILS_TMP)
DATE_TO >GETDATE()
AND PARTY_CODE  IN
(SELECT PARTY_CODE FROM #FOCLIENTBROKSCHEME WHERE FUT_BROKTABLE   
IN (SELECT TABLE_NO FROM #BROKTABLE) AND DATE_TO > GETDATE())  


CREATE INDEX #FOCLIENTBROKSCHEME ON #FOCLIENTBROKSCHEME (PARTY_CODE)
              
SELECT *  INTO #SCHEME_MAPPING FROM  SCHEME_MAPPING 
WHERE  
  SP_PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP ) 


CREATE INDEX #SCHEME_MAPPING ON #SCHEME_MAPPING (SP_PARTY_CODE,SP_TRD_TYPE,SP_SCRIP)



INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ALL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'ALL' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ALL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'ALL' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   
/****************FOR SLIVER **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'SILVER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'SILVER' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'SILVER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'SILVER' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ZINC',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'ZINC' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ZINC',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'ZINC' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'CRUDEOIL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'CRUDEOIL' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'CRUDEOIL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'CRUDEOIL' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'COPPER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,     
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'COPPER' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'COPPER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'COPPER' )              
-----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

COMMIT

exec VBB_CI_NEW

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_DailyMapping_bkp_28102025
-- --------------------------------------------------
CREATE PROC [dbo].[VBB_DailyMapping_bkp_28102025] AS        
        
BEGIN TRAN        
        
/*--------------------------------- OPTION ALL TRD SINGLE SIDE --------------------------*/              
SELECT * INTO #SCHEME_MAP FROM CLIENT5 WHERE ACTIVEFROM  >= CONVERT(VARCHAR(11),GETDATE()-5,120) 
AND CONVERT(VARCHAR(11),ACTIVEFROM,120) <=CONVERT(VARCHAR(11),GETDATE(),120)

CREATE INDEX #SCHEME_MAP ON #SCHEME_MAP (CL_CODE)

SELECT *  INTO #FOCLIENTBROKSCHEME FROM  FOCLIENTBROKSCHEME 
WHERE  CONVERT(VARCHAR(11),DATE_FROM,120)  >=CONVERT(VARCHAR(11),GETDATE()-5,120) 
AND CONVERT(VARCHAR(11),DATE_FROM,120) <= CONVERT(VARCHAR(11),GETDATE() ,120)
AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

SELECT DISTINCT TABLE_NO INTO #BROKTABLE  FROM BROKTABLE WHERE ( TABLE_NAME LIKE '%VBB%' OR TABLE_NAME LIKE '%PLUS%' OR TABLE_NAME LIKE '%Value Add Plan%') 

DELETE FROM  #FOCLIENTBROKSCHEME WHERE PARTY_CODE IN 
(SELECT DISTINCT SP_PARTY_CODE FROM SCHEME_MAPPING WHERE SP_SCHEME_ID IN ('52','53','54','55','56','57','58','59')) 
AND DATE_TO > GETDATE()

DELETE  FROM  #FOCLIENTBROKSCHEME WHERE --PARTY_CODE IN ( SELECT DISTINCT CL_CODE FROM CLIENT_DETAILS_TMP)
DATE_TO >GETDATE()
AND PARTY_CODE  IN
(SELECT PARTY_CODE FROM #FOCLIENTBROKSCHEME WHERE FUT_BROKTABLE   
IN (SELECT TABLE_NO FROM #BROKTABLE) AND DATE_TO > GETDATE())  


CREATE INDEX #FOCLIENTBROKSCHEME ON #FOCLIENTBROKSCHEME (PARTY_CODE)
              
SELECT *  INTO #SCHEME_MAPPING FROM  SCHEME_MAPPING 
WHERE  
  SP_PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP ) 


CREATE INDEX #SCHEME_MAPPING ON #SCHEME_MAPPING (SP_PARTY_CODE,SP_TRD_TYPE,SP_SCRIP)



INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ALL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 250,              
 SP_MAX_BROKAMT  = 250,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'ALL' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ALL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 250,              
 SP_MAX_BROKAMT  = 250,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'ALL' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   
/****************FOR SLIVER **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'SILVER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'SILVER' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'SILVER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'SILVER' )              
---AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ZINC',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'ZINC' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'ZINC',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 100,              
 SP_MAX_BROKAMT  = 100,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'ZINC' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )   

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'CRUDEOIL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'CRUDEOIL' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'CRUDEOIL',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'CRUDEOIL' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

/****************FOR ZINC **************/
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'COPPER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'TRD',              
 SP_SCHEME_TYPE  = 0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,     
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC ='P' AND TRD_DEL ='S' AND DAY_PUC <> 0)     
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'TRD' AND SP_SCRIP = 'COPPER' )              
----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  
              
/*--------------------------------- OPTION ALL DEL SINGLE SIDE --------------------------*/              
              
INSERT INTO SCHEME_MAPPING              
SELECT               
 SP_PARTY_CODE  = PARTY_CODE,              
 SP_COMPUTATION_LEVEL = 'T',              
 SP_INST_TYPE  = 'OPT',              
 SP_SCRIP  = 'COPPER',              
 SP_SCHEME_ID  = 10,              
 SP_TRD_TYPE  = 'DEL',              
 SP_SCHEME_TYPE  =0,              
 SP_MULTIPLIER  = 1,              
 SP_BUY_BROK_TYPE =  'P',              
 SP_SELL_BROK_TYPE =  'P',              
 SP_BUY_BROK  =.50,              
 SP_SELL_BROK  = .50,              
 SP_RES_MULTIPLIER = 0,              
 SP_RES_BUY_BROK  = 0,              
 SP_RES_SELL_BROK = 0,              
 SP_VALUE_FROM  = 0,              
 SP_VALUE_TO  = -1,              
 SP_TURNOVERON  = 'PRICE',              
 SP_BROK_COMPUTEON = 'V',              
 SP_BROK_COMPUTETYPE = 'V',              
 SP_MIN_BROKAMT  = 50,              
 SP_MAX_BROKAMT  = 50,              
 SP_MIN_SCRIPAMT  = 0,              
 SP_MAX_SCRIPAMT  = -1,              
 SP_DATE_FROM  = LEFT(GETDATE(),11),              
 SP_DATE_TO  = 'DEC 31 2049 23:59',              
 SP_CREATEDBY  = 'ADMIN',              
 SP_CREATEDON  = GETDATE(),              
 SP_MODIFIEDBY  = '',              
 SP_MODIFIEDON  = GETDATE()              
FROM              
 #FOCLIENTBROKSCHEME            
WHERE DATE_TO > GETDATE() --- AND FUT_BROKTABLE NOT IN (SELECT TABLE_NO FROM BROKTABLE WHERE VAL_PERC = 'P' AND TRD_DEL ='S' AND DAY_PUC <> 0)            
--AND DATE_FROM > GETDATE()-15   
AND PARTY_CODE NOT IN (SELECT SP_PARTY_CODE FROM #SCHEME_MAPPING WHERE SP_TRD_TYPE = 'DEL' AND SP_SCRIP = 'COPPER' )              
-----AND PARTY_CODE IN (SELECT CL_CODE FROM  #SCHEME_MAP )  

COMMIT

exec VBB_CI_NEW

GO

-- --------------------------------------------------
-- TABLE dbo.AccBill
-- --------------------------------------------------
CREATE TABLE [dbo].[AccBill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Start_Date] DATETIME NOT NULL,
    [End_Date] DATETIME NOT NULL,
    [PayIn_Date] DATETIME NOT NULL,
    [PayOut_Date] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [BranchCd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTHORISEDSIGNETORIES
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTHORISEDSIGNETORIES]
(
    [Authorisedsignetory1] VARCHAR(100) NULL,
    [Authorisedsignetory2] VARCHAR(100) NULL,
    [Authorisedsignetory3] VARCHAR(100) NULL,
    [Authorisedsignetory4] VARCHAR(100) NULL,
    [Authorisedsignetory5] VARCHAR(100) NULL,
    [Authorisedsignetory6] VARCHAR(100) NULL,
    [Authorisedsignetory7] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AuthorisedSignetory
-- --------------------------------------------------
CREATE TABLE [dbo].[AuthorisedSignetory]
(
    [Name] VARCHAR(100) NOT NULL,
    [Authorised] INT NOT NULL,
    [Dummy1] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_CONTGEN_31032022
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_CONTGEN_31032022]
(
    [ContractNo] VARCHAR(10) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_CONTGEN_31032024
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_CONTGEN_31032024]
(
    [ContractNo] VARCHAR(10) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANK
-- --------------------------------------------------
CREATE TABLE [dbo].[BANK]
(
    [BankId] VARCHAR(16) NOT NULL,
    [BankName] VARCHAR(60) NULL,
    [address1] VARCHAR(60) NULL,
    [address2] VARCHAR(60) NULL,
    [city] VARCHAR(40) NULL,
    [pincode] VARCHAR(20) NULL,
    [phone1] VARCHAR(20) NULL,
    [phone2] VARCHAR(20) NULL,
    [phone3] VARCHAR(20) NULL,
    [phone4] VARCHAR(20) NULL,
    [fax1] VARCHAR(40) NULL,
    [fax2] VARCHAR(20) NULL,
    [email] VARCHAR(50) NULL,
    [BankType] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bankguarantee
-- --------------------------------------------------
CREATE TABLE [dbo].[bankguarantee]
(
    [exch_indicator] VARCHAR(3) NOT NULL,
    [seg_indicator] VARCHAR(20) NOT NULL,
    [cl_type] VARCHAR(1) NOT NULL,
    [party_code] VARCHAR(6) NOT NULL,
    [sysid] DECIMAL(18, 0) NOT NULL,
    [bankId] DECIMAL(18, 0) NOT NULL,
    [bk_guarantee_no] VARCHAR(30) NOT NULL,
    [bk_guarantee_amt] DECIMAL(18, 0) NOT NULL,
    [guarantee_bal_amt] DECIMAL(18, 2) NOT NULL,
    [issue_dt] SMALLDATETIME NOT NULL,
    [maturity_dt] SMALLDATETIME NOT NULL,
    [lastclaim_dt] SMALLDATETIME NOT NULL,
    [status] VARCHAR(1) NOT NULL,
    [create_dt] SMALLDATETIME NOT NULL,
    [created_by] VARCHAR(30) NOT NULL,
    [guarantee_rec_dt] SMALLDATETIME NULL,
    [remarks] VARCHAR(250) NULL,
    [update_dt] SMALLDATETIME NULL,
    [old_id] DECIMAL(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bbgfosettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[bbgfosettlement]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL,
    [PARENTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bill_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[Bill_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bill_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[Bill_Digital_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillNo
-- --------------------------------------------------
CREATE TABLE [dbo].[BillNo]
(
    [bill_no] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch
-- --------------------------------------------------
CREATE TABLE [dbo].[branch]
(
    [BRANCH_CODE] CHAR(10) NULL,
    [BRANCH] CHAR(40) NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(100) NULL,
    [Prefix] VARCHAR(3) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchBrokTable
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchBrokTable]
(
    [Table_No] INT NULL,
    [Table_Name] VARCHAR(30) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Table_Type] CHAR(1) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Remarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branches
-- --------------------------------------------------
CREATE TABLE [dbo].[branches]
(
    [Branch_cd] CHAR(10) NOT NULL,
    [Short_Name] CHAR(20) NOT NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [deftrader] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchPayMode
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchPayMode]
(
    [AcName] VARCHAR(100) NULL,
    [Branch] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(18, 4) NULL,
    [Day_Sales] NUMERIC(18, 4) NULL,
    [Sett_Purch] NUMERIC(18, 4) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(18, 4) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Charges_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[Charges_Detail]
(
    [CD_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(20) NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD]
(
    [FILE_DATA] VARCHAR(8000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_BULK]
(
    [FILEDATA] VARCHAR(2000) NOT NULL,
    [SPID] BIGINT NOT NULL DEFAULT @@spid
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_LOG]
(
    [FILE_PARAM] VARCHAR(1000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_brok_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_brok_details_tmp]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(7) NOT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Trd_Brok] INT NULL,
    [Del_Brok] INT NULL,
    [Ser_Tax] TINYINT NULL,
    [Ser_Tax_Method] TINYINT NULL,
    [Credit_Limit] INT NOT NULL,
    [InActive_From] DATETIME NULL,
    [Print_Options] TINYINT NULL,
    [No_Of_Copies] INT NULL,
    [Participant_Code] VARCHAR(15) NULL,
    [Custodian_Code] VARCHAR(50) NULL,
    [Inst_Contract] CHAR(1) NULL,
    [Round_Style] INT NULL,
    [STP_Provider] VARCHAR(5) NULL,
    [STP_Rp_Style] TINYINT NULL,
    [Market_Type] INT NULL,
    [Multiplier] INT NULL,
    [Charged] INT NULL,
    [Maintenance] INT NULL,
    [Reqd_By_Exch] INT NULL,
    [Reqd_By_Broker] INT NULL,
    [Client_Rating] VARCHAR(10) NULL,
    [Debit_Balance] CHAR(1) NULL,
    [Inter_Sett] CHAR(1) NULL,
    [TRD_STT] MONEY NULL,
    [Trd_Tran_Chrgs] FLOAT NULL,
    [Trd_Sebi_Fees] NUMERIC(18, 6) NULL,
    [Trd_Stamp_Duty] MONEY NULL,
    [Trd_Other_Chrgs] MONEY NULL,
    [Trd_Eff_Dt] DATETIME NULL,
    [Del_Stt] MONEY NULL,
    [Del_Tran_Chrgs] FLOAT NULL,
    [Del_SEBI_Fees] NUMERIC(18, 6) NULL,
    [Del_Stamp_Duty] MONEY NULL,
    [Del_Other_Chrgs] MONEY NULL,
    [Del_Eff_Dt] DATETIME NULL,
    [Rounding_Method] VARCHAR(10) NULL,
    [Round_To_Digit] TINYINT NULL,
    [Round_To_Paise] INT NULL,
    [Fut_Brok] INT NULL,
    [Fut_Opt_Brok] INT NULL,
    [Fut_Fut_Fin_Brok] INT NULL,
    [Fut_Opt_Exc] INT NULL,
    [Fut_Brok_Applicable] INT NULL,
    [Fut_Stt] SMALLINT NULL,
    [Fut_Tran_Chrgs] SMALLINT NULL,
    [Fut_Sebi_Fees] SMALLINT NULL,
    [Fut_Stamp_Duty] SMALLINT NULL,
    [Fut_Other_Chrgs] SMALLINT NULL,
    [Status] CHAR(1) NULL,
    [Modifiedon] DATETIME NULL,
    [Modifiedby] VARCHAR(25) NULL,
    [Imp_Status] TINYINT NULL,
    [Pay_B3B_Payment] CHAR(1) NULL,
    [Pay_Bank_name] VARCHAR(50) NULL,
    [Pay_Branch_name] VARCHAR(50) NULL,
    [Pay_AC_No] VARCHAR(20) NULL,
    [Pay_payment_Mode] CHAR(1) NULL,
    [Brok_Eff_Date] DATETIME NULL,
    [Inst_Trd_Brok] INT NULL,
    [Inst_Del_Brok] INT NULL,
    [SYSTEMDATE] DATETIME NULL,
    [Active_Date] DATETIME NULL,
    [CheckActiveClient] VARCHAR(1) NULL,
    [Deactive_Remarks] VARCHAR(100) NULL,
    [Deactive_value] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details_tmp]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(50) NULL,
    [p_city] VARCHAR(40) NULL,
    [p_address2] VARCHAR(50) NULL,
    [p_state] VARCHAR(50) NULL,
    [p_address3] VARCHAR(50) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] NUMERIC(18, 0) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [INCOME_SLAB] INT NULL,
    [NETWORTH_SLAB] INT NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL,
    [RES_PHONE1_STD] VARCHAR(5) NULL,
    [RES_PHONE2_STD] VARCHAR(5) NULL,
    [OFF_PHONE1_STD] VARCHAR(5) NULL,
    [OFF_PHONE2_STD] VARCHAR(5) NULL,
    [P_PHONE_STD] VARCHAR(5) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Party_Modification_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Party_Modification_Tmp]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Old_Party_Code] VARCHAR(10) NOT NULL,
    [New_Party_Code] VARCHAR(10) NOT NULL,
    [Branch_Cd] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(10) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [area] VARCHAR(10) NOT NULL,
    [region] VARCHAR(20) NOT NULL,
    [Status] INT NOT NULL,
    [AddedBy] VARCHAR(50) NOT NULL,
    [AddedOn] DATETIME NOT NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1
-- --------------------------------------------------
CREATE TABLE [dbo].[client1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(100) NULL,
    [L_Address2] VARCHAR(100) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(100) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(20) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(100) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [trader] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [Region] VARCHAR(20) NULL,
    [Area] VARCHAR(20) NULL,
    [ClRating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] DECIMAL(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] DECIMAL(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] SMALLINT NULL,
    [AlbmCF_tableno] INT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [ParentCode] VARCHAR(10) NULL,
    [ProductCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client2_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Client2_Log]
(
    [Cl_Code] CHAR(10) NULL,
    [Exchange] CHAR(3) NULL,
    [Tran_Cat] CHAR(3) NULL,
    [Scrip_Cat] DECIMAL(9, 0) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Margin] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [Sebi_Turn_Tax] TINYINT NULL,
    [Insurance_Chrg] TINYINT NULL,
    [Service_Chrg] TINYINT NULL,
    [Std_Rate] INT NULL,
    [P_To_P] INT NULL,
    [Exposure_Lim] DECIMAL(18, 0) NULL,
    [Demat_Tableno] INT NULL,
    [Bankid] VARCHAR(16) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Printf] TINYINT NULL,
    [Albmdelchrg] TINYINT NULL,
    [Albmdelivery] INT NULL,
    [Albmcf_Tableno] INT NULL,
    [Mf_Tableno] INT NULL,
    [Sb_Tableno] INT NULL,
    [Brok1_Tableno] INT NULL,
    [Brok2_Tableno] INT NULL,
    [Brok3_Tableno] INT NULL,
    [Brokernote] TINYINT NULL,
    [Other_Chrg] TINYINT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontamt] TINYINT NULL,
    [Addledgerbal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [Inscont] CHAR(1) NULL,
    [Sertaxmethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [Activefrom] DATETIME NULL,
    [Inactivefrom] DATETIME NULL,
    [Debitbalflag] INT NULL,
    [Intersettflag] INT NULL,
    [Logfld_Script_Name] VARCHAR(500) NULL,
    [Logfld_Session_Id] VARCHAR(30) NULL,
    [Logfld_Local_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Host] VARCHAR(50) NULL,
    [Logfld_Statusname] VARCHAR(50) NULL,
    [Logfld_Username] VARCHAR(100) NULL,
    [Logfld_When_109] VARCHAR(30) NULL,
    [Logfld_Action] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client3
-- --------------------------------------------------
CREATE TABLE [dbo].[client3]
(
    [cl_code] VARCHAR(10) NULL,
    [party_code] CHAR(10) NOT NULL,
    [exchange] CHAR(3) NOT NULL,
    [markettype] VARCHAR(15) NOT NULL,
    [margin] MONEY NOT NULL,
    [nooftimes] DECIMAL(2, 0) NOT NULL,
    [margin_recd] DECIMAL(18, 4) NULL,
    [MtoM] DECIMAL(18, 4) NULL,
    [pmarginrate] DECIMAL(5, 2) NULL,
    [MtoMdate] DATETIME NULL,
    [InitialMargin] DECIMAL(18, 4) NULL,
    [MainenancetMargin] DECIMAL(18, 4) NULL,
    [MarginExchange] DECIMAL(18, 4) NULL,
    [MarginBroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4
-- --------------------------------------------------
CREATE TABLE [dbo].[client4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(20) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client5
-- --------------------------------------------------
CREATE TABLE [dbo].[client5]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [BirthDate] DATETIME NULL,
    [Sex] CHAR(1) NULL,
    [ActiveFrom] DATETIME NULL,
    [InteractMode] TINYINT NULL,
    [RepatriatAC] TINYINT NULL,
    [RepatriatBank] INT NULL,
    [RepatriatACNO] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [KYCForm] TINYINT NULL,
    [BankCert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [VotersID] TINYINT NULL,
    [VotersIDdtl] VARCHAR(30) NULL,
    [ITReturn] TINYINT NULL,
    [ITReturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [InactiveFrom] DATETIME NULL,
    [P_Address1] VARCHAR(100) NULL,
    [P_Address2] VARCHAR(100) NULL,
    [P_Address3] VARCHAR(100) NULL,
    [P_City] VARCHAR(40) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [AddEmailId] VARCHAR(230) NULL,
    [PassportDateOfIssue] DATETIME NULL,
    [PassportPlaceOfIssue] VARCHAR(30) NULL,
    [VoterIdDateOfIssue] DATETIME NULL,
    [VoterIdPlaceOfIssue] VARCHAR(30) NULL,
    [ITReturnDateOfFiling] DATETIME NULL,
    [LicenceNoDateOfIssue] DATETIME NULL,
    [LicenceNoPlaceOfIssue] VARCHAR(30) NULL,
    [RationCardDateOfIssue] DATETIME NULL,
    [RationCardPlaceOfIssue] VARCHAR(30) NULL,
    [Client_AGRE_DT] DATETIME NULL,
    [REGR_NO] VARCHAR(50) NULL,
    [REGR_PLACE] VARCHAR(50) NULL,
    [REGR_DATE] DATETIME NULL,
    [REGR_AUTH] VARCHAR(50) NULL,
    [INTROD_CLIENT_ID] VARCHAR(50) NULL,
    [INTROD_RELATION] VARCHAR(50) NULL,
    [ANY_OTHER_ACC] VARCHAR(50) NULL,
    [SETT_MODE] VARCHAR(50) NULL,
    [DEALING_WITH_OTHRER_TM] VARCHAR(50) NULL,
    [systumdate] DATETIME NULL,
    [PASSPORTEXPDATE] DATETIME NULL,
    [DRIVEEXPDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client6
-- --------------------------------------------------
CREATE TABLE [dbo].[Client6]
(
    [Cl_Code] CHAR(6) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] DECIMAL(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] DECIMAL(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientbrok_scheme
-- --------------------------------------------------
CREATE TABLE [dbo].[clientbrok_scheme]
(
    [SCHEME_ID] DECIMAL(18, 0) IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [Table_No] VARCHAR(5) NOT NULL,
    [Scheme_Type] VARCHAR(5) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Trade_Type] VARCHAR(3) NOT NULL,
    [BrokScheme] VARCHAR(1) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientsettings
-- --------------------------------------------------
CREATE TABLE [dbo].[clientsettings]
(
    [Exchange] CHAR(3) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Cl_Code] VARCHAR(10) NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(4) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(4) NULL,
    [Dummy9] VARCHAR(4) NULL,
    [Dummy10] VARCHAR(4) NULL,
    [RoundStyle] SMALLINT NULL,
    [RoundStyle1] SMALLINT NULL,
    [DebitBalance] TINYINT NULL,
    [InterSett] TINYINT NULL,
    [Latest] CHAR(4) NULL,
    [Area] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Cl_Type] CHAR(3) NULL,
    [Cl_status] CHAR(3) NULL,
    [Clrating] VARCHAR(10) NULL,
    [Family] VARCHAR(50) NULL,
    [Sub_Broker] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientstatus
-- --------------------------------------------------
CREATE TABLE [dbo].[clientstatus]
(
    [Cl_Status] CHAR(3) NOT NULL,
    [Description] CHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttaxes]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [Cl_type] CHAR(5) NULL,
    [Trans_cat] CHAR(5) NULL,
    [Insurance_Chrg] MONEY NULL,
    [Turnover_tax] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [Sebiturn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Demat_Insure] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Tax1] MONEY NULL,
    [Tax2] MONEY NULL,
    [Tax3] MONEY NULL,
    [Tax4] MONEY NULL,
    [Tax5] MONEY NULL,
    [Tax6] MONEY NULL,
    [Tax7] MONEY NULL,
    [Tax8] MONEY NULL,
    [Tax9] MONEY NULL,
    [Tax10] MONEY NULL,
    [Latest] CHAR(10) NULL,
    [State] CHAR(15) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttaxes_new
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttaxes_new]
(
    [Exchange] CHAR(10) NULL,
    [ScIdentity] CHAR(3) NULL,
    [Party_code] CHAR(10) NULL,
    [Cl_type] CHAR(5) NULL,
    [Trans_cat] CHAR(5) NULL,
    [Insurance_Chrg] MONEY NULL,
    [Turnover_tax] MONEY NULL,
    [Other_chrg] MONEY NULL,
    [Sebiturn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Demat_Insure] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Tax1] MONEY NULL,
    [Tax2] MONEY NULL,
    [Tax3] MONEY NULL,
    [Tax4] MONEY NULL,
    [Tax5] MONEY NULL,
    [Tax6] MONEY NULL,
    [Tax7] MONEY NULL,
    [Tax8] MONEY NULL,
    [Tax9] MONEY NULL,
    [Tax10] MONEY NULL,
    [Latest] CHAR(10) NULL,
    [State] CHAR(15) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [Round_To] INT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttype
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttype]
(
    [Cl_Type] CHAR(3) NOT NULL,
    [Description] CHAR(25) NULL,
    [prefix] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.closing
-- --------------------------------------------------
CREATE TABLE [dbo].[closing]
(
    [MARKET] VARCHAR(12) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] CHAR(2) NULL,
    [Cl_Rate] MONEY NULL,
    [SysDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Closingtemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Closingtemp]
(
    [Market] VARCHAR(12) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] CHAR(2) NULL,
    [Cl_Rate] MONEY NULL,
    [Sysdate] SMALLDATETIME NULL,
    [Pre_Cl_Rate] MONEY NULL,
    [Open_Rate] MONEY NULL,
    [Hi_Rate] MONEY NULL,
    [Low_Rate] MONEY NULL,
    [TotTrdQty] MONEY NULL,
    [TotTurnOver] MONEY NULL,
    [YearHiRate] MONEY NULL,
    [YearLowRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_CONFMEM0_DIGITAL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_CONFMEM0_DIGITAL_DATA]
(
    [C_SR_NO] INT IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(MAX) NULL,
    [C_Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_EXCH_IMPFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_EXCH_IMPFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL,
    [FILE_NAME] VARCHAR(100) NULL,
    [FILE_SAMPLE] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TBL_PROCESS_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TBL_PROCESS_DETAIL]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] VARCHAR(50) NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(200) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TRADEFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TRADEFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL,
    [FILE_SAMPLE] VARCHAR(8000) NULL,
    [FILE_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.comm_bill_process
-- --------------------------------------------------
CREATE TABLE [dbo].[comm_bill_process]
(
    [party_code] VARCHAR(12) NULL,
    [sno] VARCHAR(5) NULL,
    [Data_text] VARCHAR(MAX) NULL,
    [SRNO] INT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(11) NULL,
    [SCRIP_CD] VARCHAR(100) NULL,
    [OD_TIME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMMCONTRACT
-- --------------------------------------------------
CREATE TABLE [dbo].[COMMCONTRACT]
(
    [CONTRACT_TOKEN_NO] NUMERIC(18, 0) NOT NULL,
    [ASSET_TOKEN_NO] NUMERIC(18, 0) NOT NULL,
    [CONTRACT_INSTRUMENT_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(10) NULL,
    [SERIES] VARCHAR(2) NULL,
    [FILLER1] VARCHAR(4) NULL,
    [EXPIRY_DATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRECISION] VARCHAR(1) NULL,
    [CORPORATE_ACTION_LEVEL] NUMERIC(18, 0) NULL,
    [FILLER2] VARCHAR(6) NULL,
    [ADMISSION_TYPE] NUMERIC(18, 0) NULL,
    [ISSUE_RATE] NUMERIC(18, 4) NULL,
    [TRD_STATUS_NRM] INT NULL,
    [ELG_NRM_MKT] INT NULL,
    [FILLER3] VARCHAR(6) NULL,
    [TRD_STATUS_ODD] INT NULL,
    [ELG_ODD_MKT] INT NULL,
    [FILLER4] VARCHAR(6) NULL,
    [TRD_STATUS_SPT] INT NULL,
    [ELG_SPT_MKT] INT NULL,
    [FILLER5] VARCHAR(6) NULL,
    [TRD_STATUS_AUC] INT NULL,
    [ELG_AUC_MKT] INT NULL,
    [FILLER6] VARCHAR(6) NULL,
    [ISSUE_START_DATE] DATETIME NULL,
    [ISSUE_SETTLE_DATE] DATETIME NULL,
    [CONTRACT_MATURITY_DATE] DATETIME NULL,
    [MARGIN_PERCENTAGE] NUMERIC(18, 4) NULL,
    [MINIMUM_LOT_SIZE] NUMERIC(18, 4) NULL,
    [BOARD_LOT_QUANTITY] NUMERIC(18, 4) NULL,
    [TICK_SIZE] NUMERIC(18, 4) NULL,
    [ISSUED_CAPITAL] NUMERIC(18, 4) NULL,
    [VOLUME_FREEZE_QUANTITY] NUMERIC(18, 4) NULL,
    [WARNING_QUANTITY] NUMERIC(18, 4) NULL,
    [ADMISSION_DATE] NUMERIC(18, 0) NULL,
    [EXPULSION_DATE] NUMERIC(18, 0) NULL,
    [RE_ADMISSION_DATE] NUMERIC(18, 0) NULL,
    [RECORD_DATE] NUMERIC(18, 0) NULL,
    [NO_DELIVERY_START_DATE] NUMERIC(18, 0) NULL,
    [NO_DELIVERY_END_DATE] NUMERIC(18, 0) NULL,
    [OPT_RANGE_LOW_PRICE] NUMERIC(18, 4) NULL,
    [OPT_RANGE_HIGH_PRICE] NUMERIC(18, 4) NULL,
    [EX_DATE] NUMERIC(18, 0) NULL,
    [BOOK_CLOSURE_START_DATE] NUMERIC(18, 0) NULL,
    [BOOK_CLOSURE_END_DATE] NUMERIC(18, 0) NULL,
    [UPDATE_DATE_AND_TIME] NUMERIC(18, 0) NULL,
    [EXERCISE_START_DATE] NUMERIC(18, 0) NULL,
    [EXERCISE_END_DATE] NUMERIC(18, 0) NULL,
    [TICKER_SELECTION] NUMERIC(18, 0) NULL,
    [QUANTITY_MULTIPLIER] NUMERIC(18, 0) NULL,
    [QUALITY_SPECS] VARCHAR(12) NULL,
    [STOCK_NAME] VARCHAR(26) NULL,
    [CP_AGM] NUMERIC(18, 0) NULL,
    [CP_DIV] NUMERIC(18, 0) NULL,
    [CP_BONUS] NUMERIC(18, 0) NULL,
    [SPECIAL_TERM] NUMERIC(18, 0) NULL,
    [COMM_SPEC] VARCHAR(26) NULL,
    [EXERCISE_STYLE] VARCHAR(1) NULL,
    [EXERCISE_ALLOWED] VARCHAR(1) NULL,
    [EXERCISE_REJECTION_ALLOWED] VARCHAR(1) NULL,
    [POSITION_LIQUI_ALLOWED] VARCHAR(1) NULL,
    [CHECK_SUM] VARCHAR(1) NULL,
    [CA_ADJUSTED] VARCHAR(1) NULL,
    [UDLN_ASSET_SYMBOL] VARCHAR(12) NULL,
    [ASSET_INSTRUMENT] VARCHAR(6) NULL,
    [BASE_PRICE] NUMERIC(18, 4) NULL,
    [DELETE_FLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMMCONTRACT_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[COMMCONTRACT_TMP]
(
    [CONTRACT_DATE] DATETIME NULL,
    [CONTRACT_INSTRUMENT_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(10) NULL,
    [EXPIRY_DATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CORPORATE_ACTION_LEVEL] NUMERIC(18, 2) NULL,
    [CONTRACT_ACTIVE_MARKET_TYPE] VARCHAR(1) NULL,
    [CONTRACT_ISSUE_START_DATE] DATETIME NULL,
    [CONTRACT_ISSUE_MATURITY_DATE] DATETIME NULL,
    [CONTRACT_EXERCISE_START_DATE] DATETIME NULL,
    [CONTRACT_EXERCISE_END_DATE] DATETIME NULL,
    [CONTRACT_EXERCISE_STYLE] VARCHAR(1) NULL,
    [CONTRACT_UL_INSTRUMENT_TYPE] VARCHAR(6) NULL,
    [CONTRACT_UL_SYMBOL] VARCHAR(10) NULL,
    [CONTRACT_UL_SERIES] VARCHAR(2) NULL,
    [CONTRACT_UL_EXPIRY_DATE] DATETIME NULL,
    [CONTRACT_UL_STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_UL_OPTION_TYPE] VARCHAR(2) NULL,
    [CONTRACT_UL_CA_LEVEL] NUMERIC(18, 2) NULL,
    [CONTRACT_OPEN_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_HIGH_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_LOW_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_CLOSE_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_UL_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_SETTLEMENT_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_BASE_PRICE] NUMERIC(18, 4) NULL,
    [CONTRACT_TRADING_UNIT] NUMERIC(18, 4) NULL,
    [CONTRACT_TRADING_QUANTITY] NUMERIC(18, 4) NULL,
    [CONTRACT_DELIVERY_UNIT] NUMERIC(18, 4) NULL,
    [CONTRACT_DELIVERY_QUANTITY] NUMERIC(18, 4) NULL,
    [CONTRACT_PRICE_QUOTATION_UNIT] NUMERIC(18, 4) NULL,
    [INTENTION_PERIOD_START_DATE] DATETIME NULL,
    [INTENTION_PERIOD_END_DATE] DATETIME NULL,
    [TENDER_PERIOD_START_DATE] DATETIME NULL,
    [TENDER_PERIOD_END_DATE] DATETIME NULL,
    [DELIVERY_PERIOD_START_DATE] DATETIME NULL,
    [DELIVERY_PERIOD_END_DATE] DATETIME NULL,
    [DELIVERY_MECHANISM] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Company
-- --------------------------------------------------
CREATE TABLE [dbo].[Company]
(
    [Co_Code] NVARCHAR(6) NOT NULL,
    [Short_Name] NVARCHAR(20) NOT NULL,
    [Long_Name] NVARCHAR(50) NULL,
    [Address1] NVARCHAR(40) NULL,
    [Address2] NVARCHAR(40) NULL,
    [Address3] NVARCHAR(40) NULL,
    [Address4] NVARCHAR(40) NULL,
    [City] NVARCHAR(20) NULL,
    [State] NVARCHAR(15) NULL,
    [Nation] NVARCHAR(15) NULL,
    [Zip] NVARCHAR(15) NULL,
    [Phone1] NVARCHAR(15) NULL,
    [Phone2] NVARCHAR(15) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMPANY_LOGO
-- --------------------------------------------------
CREATE TABLE [dbo].[COMPANY_LOGO]
(
    [CL_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CL_TYPE] CHAR(5) NULL,
    [CL_LOGO] IMAGE NULL,
    [CL_LOGO64] VARCHAR(100) NULL,
    [CL_UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContGen
-- --------------------------------------------------
CREATE TABLE [dbo].[ContGen]
(
    [ContractNo] VARCHAR(10) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContLogin
-- --------------------------------------------------
CREATE TABLE [dbo].[ContLogin]
(
    [LoginId] VARCHAR(30) NULL,
    [FromParty] VARCHAR(10) NULL,
    [ToParty] VARCHAR(10) NULL,
    [Option_type] VARCHAR(2) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_price] INT NULL,
    [Qty] INT NULL,
    [Sell_Buy] INT NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [ContractNo] VARCHAR(10) NULL,
    [SplitDate] SMALLDATETIME NULL,
    [Printed] INT NULL,
    [TradeNo] VARCHAR(14) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA]
(
    [CONTRACTNO] VARCHAR(14) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [TRADETIME] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [QTY] INT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRICE] MONEY NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [SELL_BUY] INT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [ORDFLG] INT NULL,
    [PRICEUNIT] VARCHAR(20) NULL,
    [QTY_UNIT] VARCHAR(10) NULL,
    [CONT_CL_RATE] NUMERIC(18, 4) NULL,
    [CONT_USER_ID] VARCHAR(20) NULL,
    [CONT_REMARK_ID] VARCHAR(1) NULL,
    [CONT_REMARK_DESC] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA_DET
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA_DET]
(
    [CONTRACTNO] VARCHAR(14) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [TRADETIME] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [QTY] INT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRICE] MONEY NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [SELL_BUY] INT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [ORDFLG] INT NULL,
    [PRICEUNIT] VARCHAR(20) NULL,
    [QTY_UNIT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Digital_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(500) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_MASTER]
(
    [TRADE_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(20) NULL,
    [REGION] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL,
    [OFF_PHONE2] VARCHAR(15) NULL,
    [PRINTF] INT NULL,
    [MAPIDID] VARCHAR(12) NULL,
    [UCC_CODE] VARCHAR(16) NULL,
    [SERVICE_CHRG] MONEY NULL,
    [BROKERNOTE] NUMERIC(18, 4) NULL,
    [TURNOVER_TAX] NUMERIC(18, 4) NULL,
    [SEBI_TURN_TAX] NUMERIC(18, 4) NULL,
    [OTHER_CHRG] NUMERIC(18, 4) NULL,
    [INSURANCE_CHRG] NUMERIC(18, 4) NULL,
    [SEBI_NO] VARCHAR(25) NULL,
    [PARTICIPANTCODE] VARCHAR(20) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [CL_STATUS] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Plain_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Plain_DATA]
(
    [Sr_No] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [Description] VARCHAR(2000) NULL,
    [Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Contract_Rounding
-- --------------------------------------------------
CREATE TABLE [dbo].[Contract_Rounding]
(
    [CR_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CR_Party_Code] VARCHAR(10) NOT NULL,
    [CR_Min_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Max_ContractAmt] NUMERIC(18, 4) NOT NULL,
    [CR_Date_From] DATETIME NOT NULL,
    [CR_Date_To] DATETIME NOT NULL,
    [CR_CreatedBy] VARCHAR(20) NOT NULL,
    [CR_CreatedOn] DATETIME NOT NULL,
    [CR_ModifiedBy] VARCHAR(20) NOT NULL,
    [CR_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContractPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[ContractPrint_Setting]
(
    [Rpt_Code] VARCHAR(20) NULL,
    [Rpt_Desc] VARCHAR(50) NULL,
    [Rpt_Pos] NUMERIC(10, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Custodian
-- --------------------------------------------------
CREATE TABLE [dbo].[Custodian]
(
    [Custodiancode] VARCHAR(15) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(50) NULL,
    [State] VARCHAR(50) NULL,
    [Nation] VARCHAR(50) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(10) NULL,
    [Off_Phone1] CHAR(10) NULL,
    [Off_Phone2] CHAR(10) NULL,
    [Email] CHAR(10) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Sebiregno] VARCHAR(15) NULL,
    [CUST_ACCNO] VARCHAR(20) NULL,
    [CUST_BANKNAME] VARCHAR(50) NULL,
    [CUST_BRANCHNAME] VARCHAR(50) NULL,
    [BROK_ACCNO] VARCHAR(20) NULL,
    [BROK_BANKNAME] VARCHAR(50) NULL,
    [BROK_BRANCHNAME] VARCHAR(50) NULL,
    [CLEARING_CODE] VARCHAR(5) NULL,
    [SETTLE_BY] VARCHAR(10) NULL,
    [STD_ISD1] VARCHAR(10) NULL,
    [STD_ISD2] VARCHAR(10) NULL,
    [PANNO] VARCHAR(10) NULL,
    [MOBILENO] VARCHAR(17) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DATA_ARCHIVE_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[DATA_ARCHIVE_LOG]
(
    [TABLE_NAME] VARCHAR(50) NULL,
    [ACTIVITY] VARCHAR(20) NULL,
    [CUTOFF_DATE] DATETIME NULL,
    [RECORDCOUNT] INT NULL,
    [SYSTEM_DATE] DATETIME NULL,
    [USER_NAME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEALINGADDRESS
-- --------------------------------------------------
CREATE TABLE [dbo].[DEALINGADDRESS]
(
    [BRANCHNAME] VARCHAR(100) NULL,
    [ADDR1] VARCHAR(100) NULL,
    [ADDR2] VARCHAR(100) NULL,
    [ADDR3] VARCHAR(100) NULL,
    [PHONE1] VARCHAR(100) NULL,
    [PHONE2] VARCHAR(100) NULL,
    [FAX] VARCHAR(100) NULL,
    [Email] VARCHAR(100) NULL,
    [COMPLEmail1] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELCDSLBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[DELCDSLBALANCE]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [DPID] VARCHAR(8) NOT NULL,
    [CLTDPID] VARCHAR(16) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [FREEBAL] NUMERIC(18, 4) NOT NULL,
    [CURRBAL] NUMERIC(18, 4) NULL,
    [FREEZEBAL] NUMERIC(18, 4) NOT NULL,
    [LOCKINBAL] NUMERIC(18, 4) NOT NULL,
    [PLEDGEBAL] NUMERIC(18, 4) NOT NULL,
    [DPVBAL] NUMERIC(18, 4) NOT NULL,
    [DPCBAL] NUMERIC(18, 4) NOT NULL,
    [RPCBAL] CHAR(10) NOT NULL,
    [ELIMBAL] NUMERIC(18, 4) NOT NULL,
    [EARMARKBAL] NUMERIC(18, 4) NOT NULL,
    [REMLOCKBAL] NUMERIC(18, 4) NOT NULL,
    [TOTALBALANCE] NUMERIC(18, 4) NOT NULL,
    [TRDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERY_CHRG_PARTY_EXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERY_CHRG_PARTY_EXCEPTION]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [CREATEDBY] VARCHAR(20) NULL,
    [CREATEDON] DATETIME NULL,
    [MODIFIEDBY] VARCHAR(20) NULL,
    [MODIFIEDON] DATETIME NULL,
    [CHARGE_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_CloseOut_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_CloseOut_Temp]
(
    [IntSrNo] INT IDENTITY(1,1) NOT NULL,
    [ReportDate] DATETIME NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Sett_No] VARCHAR(8) NULL,
    [D_Sett_Type] VARCHAR(50) NULL,
    [D_Sett_No] VARCHAR(8) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 2) NOT NULL,
    [Option_Type] VARCHAR(2) NULL,
    [WareHouse] VARCHAR(20) NULL,
    [IsIn] VARCHAR(12) NULL,
    [CloseOut_Type] CHAR(1) NULL,
    [DrCr] CHAR(1) NULL,
    [Qty_Clt] NUMERIC(18, 4) NOT NULL,
    [PayIn_Qty] NUMERIC(18, 4) NOT NULL,
    [PayOut_Qty] NUMERIC(18, 4) NOT NULL,
    [CloseOut_Flag] CHAR(1) NULL,
    [Price] NUMERIC(18, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_ClosePos
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_ClosePos]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_code] VARCHAR(15) NULL,
    [Trade_Date] DATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expiry_Date] DATETIME NULL,
    [Option_Type] CHAR(5) NULL,
    [Strike_Price] MONEY NULL,
    [Open_Pos] MONEY NULL,
    [Del_Pos] INT NULL,
    [Sell_Buy] TINYINT NULL,
    [Net_Pos] MONEY NULL,
    [SettlementPrice] NUMERIC(15, 7) NULL,
    [Table_No] VARCHAR(4) NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [BrokApplied] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [PartyFlag] INT NULL,
    [WAREHOUSE] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_DelCode
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_DelCode]
(
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [NSDLNo] NUMERIC(18, 0) NULL,
    [CDSLNo] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Demat_Trans
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Demat_Trans]
(
    [SNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 2) NOT NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [TrDate] DATETIME NOT NULL,
    [CltAccNo] VARCHAR(16) NULL,
    [DpId] VARCHAR(16) NULL,
    [DpName] VARCHAR(50) NULL,
    [IsIn] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [PartiPantCode] VARCHAR(10) NULL,
    [DpType] VARCHAR(10) NULL,
    [TransNo] VARCHAR(15) NOT NULL,
    [DrCr] VARCHAR(1) NOT NULL,
    [BDpType] VARCHAR(4) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltAccNo] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL,
    [WareHouse] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERY_DEMAT_TRANS_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERY_DEMAT_TRANS_TMP]
(
    [SNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 2) NOT NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [TrDate] DATETIME NOT NULL,
    [CltAccNo] VARCHAR(16) NULL,
    [DpId] VARCHAR(16) NULL,
    [DpName] VARCHAR(50) NULL,
    [IsIn] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [PartiPantCode] VARCHAR(10) NULL,
    [DpType] VARCHAR(10) NULL,
    [TransNo] VARCHAR(15) NOT NULL,
    [DrCr] VARCHAR(1) NOT NULL,
    [BDpType] VARCHAR(4) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltAccNo] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] INT NULL,
    [Filler5] INT NULL,
    [WareHouse] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_DematTransOut
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_DematTransOut]
(
    [Sno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Refno] INT NULL,
    [Tcode] NUMERIC(18, 0) NULL,
    [Trtype] NUMERIC(18, 0) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expiry_Date] DATETIME NULL,
    [Strike_Price] NUMERIC(18, 2) NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Qty] NUMERIC(18, 4) NULL,
    [Trdate] DATETIME NULL,
    [Cltaccno] VARCHAR(16) NULL,
    [Dpid] VARCHAR(16) NULL,
    [Dpname] VARCHAR(50) NULL,
    [Isin] VARCHAR(12) NULL,
    [Branch_Cd] VARCHAR(10) NULL,
    [Partipantcode] VARCHAR(10) NULL,
    [Dptype] VARCHAR(10) NULL,
    [Transno] VARCHAR(15) NULL,
    [Drcr] VARCHAR(1) NULL,
    [Bdptype] VARCHAR(4) NULL,
    [Bdpid] VARCHAR(16) NULL,
    [Bcltaccno] VARCHAR(16) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [WareHouse] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_FoSett
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_FoSett]
(
    [ContractNo] VARCHAR(14) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(16) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] INT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] NUMERIC(18, 4) NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NULL,
    [Order_no] VARCHAR(15) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NULL,
    [Line_No] NUMERIC(3, 0) NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] INT NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Look_Ahead_Period
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Look_Ahead_Period]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Symbol] VARCHAR(12) NULL,
    [Add_Margin] NUMERIC(18, 4) NULL,
    [Look_Ahead_Period] INT NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Modified_By] VARCHAR(25) NULL,
    [Modified_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Margin
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Margin]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Inst_Type] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [ExpiryDate] DATETIME NULL,
    [Int_Margin] NUMERIC(9, 4) NULL,
    [Exp_Margin] NUMERIC(9, 4) NULL,
    [Add_Margin] NUMERIC(9, 4) NULL,
    [Tot_Margin] NUMERIC(9, 4) NULL,
    [Add_Margin_Long] NUMERIC(9, 4) NULL,
    [Add_Margin_Short] NUMERIC(9, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Margin_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Margin_Temp]
(
    [Inst_Type] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [ExpiryDate] DATETIME NULL,
    [Int_Margin] NUMERIC(9, 4) NULL,
    [Exp_Margin] NUMERIC(9, 4) NULL,
    [Add_Margin] NUMERIC(9, 4) NULL,
    [Tot_Margin] NUMERIC(9, 4) NULL,
    [Add_Margin_Long] NUMERIC(9, 4) NULL,
    [Add_Margin_Short] NUMERIC(9, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Market_Type
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Market_Type]
(
    [Exchange] VARCHAR(3) NULL,
    [ExchangeId] VARCHAR(2) NULL,
    [DPType] VARCHAR(4) NULL,
    [MarketType] VARCHAR(2) NULL,
    [MaketTypeName] VARCHAR(30) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [clearingid] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Master]
(
    [RefNo] INT NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(10) NOT NULL,
    [Company] VARCHAR(50) NOT NULL,
    [FileRead] INT NULL,
    [AuctionPer] NUMERIC(18, 2) NULL,
    [NSECmBpId] VARCHAR(8) NULL,
    [BSECMBpId] VARCHAR(8) NULL,
    [NSDLToCDSL] VARCHAR(8) NULL,
    [AuctionParty] VARCHAR(10) NULL,
    [AuctionChrg] MONEY NULL,
    [NoOfSlip] INT NULL,
    [AllocationType] INT NULL,
    [InSettEx] INT NULL,
    [InBenEx] INT NULL,
    [BrokerId] VARCHAR(8) NULL,
    [BrokerFileId] VARCHAR(2) NULL,
    [DelCloseBrokFlag] INT NULL,
    [SettPocketFlag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_MultiIsIn
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_MultiIsIn]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL,
    [Perc] MONEY NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [EffDate] DATETIME NOT NULL,
    [WareHouse] VARCHAR(20) NULL,
    [CreatedBy] VARCHAR(20) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(20) NULL,
    [ModifiedOn] DATETIME NULL,
    [Remark] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Obl_CloseOut
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Obl_CloseOut]
(
    [Del_Rec_No] INT NOT NULL,
    [Report_Date] DATETIME NOT NULL,
    [CM_Primary_Code] VARCHAR(5) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [WareHouse] VARCHAR(20) NULL,
    [PayIn_Qty] NUMERIC(18, 4) NOT NULL,
    [PayOut_Qty] NUMERIC(18, 4) NOT NULL,
    [PayIn_Value] NUMERIC(18, 4) NOT NULL,
    [PayOut_Value] NUMERIC(18, 4) NOT NULL,
    [D_Sett_Type] VARCHAR(2) NOT NULL,
    [D_Sett_No] VARCHAR(7) NOT NULL,
    [D_IsIn] VARCHAR(12) NOT NULL,
    [Close_Type] CHAR(1) NOT NULL,
    [Markup] NUMERIC(18, 4) NOT NULL,
    [Price] NUMERIC(18, 4) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Obl_Clt
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Obl_Clt]
(
    [Report_Date] DATETIME NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [CM_Primary_Code] VARCHAR(5) NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 4) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [CRA_Level] NUMERIC(18, 4) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [MemberCode] VARCHAR(15) NULL,
    [Member_Ac_Type] VARCHAR(12) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Sell_Buy] VARCHAR(1) NOT NULL,
    [Tot_Req_Qty] NUMERIC(18, 4) NOT NULL,
    [Qty_Req_Demat] NUMERIC(18, 4) NOT NULL,
    [Qty_Req_Non_Demat] NUMERIC(18, 4) NOT NULL,
    [Accept_Flag] CHAR(1) NOT NULL,
    [Total_Allocated_Qty] NUMERIC(18, 4) NOT NULL,
    [Total_Rej_Qty] NUMERIC(18, 4) NOT NULL,
    [Del_Rec_No] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Obl_Net
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Obl_Net]
(
    [Del_Rec_No] INT NOT NULL,
    [Report_Date] DATETIME NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Sett_no] VARCHAR(7) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 4) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [PayIn_Qty] NUMERIC(18, 4) NOT NULL,
    [PayOut_Qty] NUMERIC(18, 4) NOT NULL,
    [PayIn_Value] NUMERIC(18, 4) NOT NULL,
    [PayOut_Value] NUMERIC(18, 4) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Obl_Premium_Net
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Obl_Premium_Net]
(
    [Del_Rec_No] INT NOT NULL,
    [Report_Date] DATETIME NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Sett_no] VARCHAR(7) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [ExpiryDate] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 4) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [PayIn_Qty] NUMERIC(18, 4) NOT NULL,
    [PayOut_Qty] NUMERIC(18, 4) NOT NULL,
    [PayIn_Value] NUMERIC(18, 4) NOT NULL,
    [PayOut_Value] NUMERIC(18, 4) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL,
    [Sec_IsIn] VARCHAR(12) NOT NULL,
    [Pre_Disc_Perc] NUMERIC(18, 4) NOT NULL,
    [Pre_Disc_Flag] VARCHAR(1) NOT NULL,
    [Pre_disc_Price] NUMERIC(18, 4) NOT NULL,
    [Pre_Disc_Sett_Type] VARCHAR(2) NOT NULL,
    [Pre_Disc_Sett_No] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Obl_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Obl_Temp]
(
    [Del_Rec_No] INT NOT NULL,
    [Report_Date] DATETIME NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Sett_no] VARCHAR(7) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 4) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [PayIn_Qty] NUMERIC(18, 4) NOT NULL,
    [PayOut_Qty] NUMERIC(18, 4) NOT NULL,
    [PayIn_Value] NUMERIC(18, 4) NOT NULL,
    [PayOut_Value] NUMERIC(18, 4) NOT NULL,
    [IsIn] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Party_Margin
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Party_Margin]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [MDate_From] DATETIME NULL,
    [MDate_To] DATETIME NULL,
    [Party_Code] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Margin] MONEY NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_PartyFlag
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_PartyFlag]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Debitflag] INT NULL,
    [Interflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_PayOut
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_PayOut]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(16) NULL,
    [AcType] VARCHAR(4) NULL,
    [Debitqty] INT NULL,
    [Payqty] INT NOT NULL,
    [Shrtqty] INT NULL,
    [Poolqty] INT NULL,
    [Dptype] VARCHAR(4) NULL,
    [Ledbal] MONEY NOT NULL,
    [Effbal] MONEY NOT NULL,
    [Cl_Rate] MONEY NOT NULL,
    [Payoutdate] DATETIME NULL,
    [Actpayout] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales]
(
    [Delivery_Id] FLOAT NULL,
    [MemberCode] NVARCHAR(5) NULL,
    [Sett_Type] NVARCHAR(1) NULL,
    [Sett_No] NVARCHAR(7) NULL,
    [Symbol] NVARCHAR(10) NULL,
    [WareHouse] NVARCHAR(20) NULL,
    [IsIn] NVARCHAR(12) NULL,
    [Qty] FLOAT NULL,
    [Cut_Off_Date] SMALLDATETIME NULL,
    [Sell_Buy] NCHAR(1) NULL,
    [BuyClientName] NVARCHAR(60) NULL,
    [BuyClientAddr] NVARCHAR(100) NULL,
    [BuyClientFormNo] NVARCHAR(10) NULL,
    [BuyClientQty] FLOAT NULL,
    [BuyClientValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax]
(
    [Delivery_Id] NUMERIC(18, 0) NULL,
    [MemberCode] VARCHAR(5) NULL,
    [Sett_Type] VARCHAR(1) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Symbol] VARCHAR(10) NULL,
    [WareHouse] VARCHAR(20) NULL,
    [IsIn] VARCHAR(12) NULL,
    [Qty] NUMERIC(18, 4) NULL,
    [Cut_Off_Date] DATETIME NULL,
    [Sell_Buy] CHAR(1) NULL,
    [BuyClientName] VARCHAR(60) NULL,
    [BuyClientAddr] VARCHAR(100) NULL,
    [BuyClientFormNo] VARCHAR(10) NULL,
    [BuyClientQty] NUMERIC(18, 4) NULL,
    [BuyClientValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_BatchNo
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_BatchNo]
(
    [Sett_Type] VARCHAR(2) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sell_Buy] VARCHAR(1) NULL,
    [Batch_No] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_Cl_Address
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_Cl_Address]
(
    [Add_SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Address] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_Cl_WareHouse
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_Cl_WareHouse]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [WareHouse] VARCHAR(20) NULL,
    [Add_SrNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_Clt
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_Clt]
(
    [Pri_key] INT IDENTITY(1,1) NOT NULL,
    [Delivery_Id] NUMERIC(18, 0) NULL,
    [Cut_Off_Date] DATETIME NULL,
    [MemberCode] VARCHAR(5) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [WareHouse] VARCHAR(20) NULL,
    [ISIN] VARCHAR(16) NULL,
    [Sell_Buy] VARCHAR(1) NULL,
    [Exemp_Form_No] VARCHAR(10) NULL,
    [PayOutQty] NUMERIC(18, 4) NULL,
    [Delivery_Val] NUMERIC(18, 4) NULL,
    [Sales_Tax_Amt] NUMERIC(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_Final
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_Final]
(
    [Delivery_Id] NUMERIC(18, 0) NULL,
    [Sett_Type] VARCHAR(1) NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sell_Buy] CHAR(1) NULL,
    [Symbol] VARCHAR(10) NULL,
    [WareHouse] VARCHAR(20) NULL,
    [IsIn] VARCHAR(12) NULL,
    [Qty] NUMERIC(18, 4) NULL,
    [SalesTaxAmt] NUMERIC(18, 4) NULL,
    [Party_Code] VARCHAR(12) NULL,
    [PartyName] VARCHAR(60) NULL,
    [Sales_Sett_Type] CHAR(1) NULL,
    [Sales_Sett_No] VARCHAR(7) NULL,
    [Sales_Sett_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sales_Tax_Perc
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sales_Tax_Perc]
(
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sell_Buy] CHAR(1) NULL,
    [STax_Per] MONEY NULL,
    [CreatedBy] VARCHAR(20) NULL,
    [CreateOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(20) NULL,
    [ModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERY_SALESTAX_OBL_CLT
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERY_SALESTAX_OBL_CLT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [D_SETT_TYPE] VARCHAR(2) NULL,
    [D_SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [ISIN] VARCHAR(16) NULL,
    [WAREHOUSE] VARCHAR(20) NULL,
    [SELL_BUY] INT NULL,
    [DEL_QTY] NUMERIC(18, 4) NULL,
    [DEL_VALUE] NUMERIC(18, 4) NULL,
    [STAX_PERC] NUMERIC(18, 4) NULL,
    [STAX_AMT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Sett_Mst
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Sett_Mst]
(
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Sec_PayIn] DATETIME NOT NULL,
    [Sec_PayOut] DATETIME NOT NULL,
    [Fund_PayIn] DATETIME NOT NULL,
    [Fund_PayOut] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_SlipFormat
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_SlipFormat]
(
    [FormatProvider] VARCHAR(10) NOT NULL,
    [FromDp] VARCHAR(4) NOT NULL,
    [ToDp] VARCHAR(4) NOT NULL,
    [Detail] VARCHAR(10) NOT NULL,
    [PoolOrBen] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_Transaction
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_Transaction]
(
    [SNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 2) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [TransNo] VARCHAR(16) NOT NULL,
    [FromNo] VARCHAR(16) NOT NULL,
    [ToNo] VARCHAR(16) NOT NULL,
    [IsIn] VARCHAR(16) NOT NULL,
    [FolioNo] VARCHAR(16) NOT NULL,
    [HolderName] VARCHAR(100) NOT NULL,
    [Reason] VARCHAR(100) NOT NULL,
    [DrCr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [OrgQty] NUMERIC(18, 4) NOT NULL,
    [DpType] VARCHAR(10) NOT NULL,
    [DpId] VARCHAR(16) NOT NULL,
    [CltDpId] VARCHAR(16) NOT NULL,
    [BranchCd] VARCHAR(10) NOT NULL,
    [PartipantCode] VARCHAR(10) NOT NULL,
    [CounterParty] VARCHAR(10) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NOT NULL,
    [BatchNo] VARCHAR(10) NOT NULL,
    [ISett_No] VARCHAR(7) NOT NULL,
    [ISett_Type] VARCHAR(2) NOT NULL,
    [ShareType] VARCHAR(8) NOT NULL,
    [TransDate] DATETIME NOT NULL,
    [BDpType] VARCHAR(4) NOT NULL,
    [BDpId] VARCHAR(8) NOT NULL,
    [BCltDpId] VARCHAR(16) NOT NULL,
    [Active] INT NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] VARCHAR(1) NOT NULL,
    [Filler3] VARCHAR(1) NOT NULL,
    [Filler4] VARCHAR(1) NOT NULL,
    [Filler5] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_TransactionTemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_TransactionTemp]
(
    [SNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Strike_Price] NUMERIC(18, 2) NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [Qty] NUMERIC(18, 4) NOT NULL,
    [TransNo] VARCHAR(16) NOT NULL,
    [FromNo] VARCHAR(16) NOT NULL,
    [ToNo] VARCHAR(16) NOT NULL,
    [IsIn] VARCHAR(16) NOT NULL,
    [FolioNo] VARCHAR(16) NOT NULL,
    [HolderName] VARCHAR(100) NOT NULL,
    [Reason] VARCHAR(100) NOT NULL,
    [DrCr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [OrgQty] NUMERIC(18, 4) NOT NULL,
    [DpType] VARCHAR(10) NOT NULL,
    [DpId] VARCHAR(16) NOT NULL,
    [CltDpId] VARCHAR(16) NOT NULL,
    [BranchCd] VARCHAR(10) NOT NULL,
    [PartipantCode] VARCHAR(10) NOT NULL,
    [CounterParty] VARCHAR(10) NOT NULL,
    [WareHouse] VARCHAR(20) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NOT NULL,
    [BatchNo] VARCHAR(10) NOT NULL,
    [ISett_No] VARCHAR(7) NOT NULL,
    [ISett_Type] VARCHAR(2) NOT NULL,
    [ShareType] VARCHAR(8) NOT NULL,
    [TransDate] DATETIME NOT NULL,
    [BDpType] VARCHAR(4) NOT NULL,
    [BDpId] VARCHAR(8) NOT NULL,
    [BCltDpId] VARCHAR(16) NOT NULL,
    [Active] INT NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] VARCHAR(1) NOT NULL,
    [Filler3] VARCHAR(1) NOT NULL,
    [Filler4] VARCHAR(1) NOT NULL,
    [Filler5] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delivery_TransPrintPool
-- --------------------------------------------------
CREATE TABLE [dbo].[Delivery_TransPrintPool]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [FromParty] VARCHAR(10) NULL,
    [ToParty] VARCHAR(10) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [CertNo] VARCHAR(12) NULL,
    [TrType] INT NULL,
    [BDpType] VARCHAR(4) NULL,
    [BDpId] VARCHAR(8) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [DpId] VARCHAR(8) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [Batchno] VARCHAR(10) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [TransDate] DATETIME NULL,
    [HolderName] VARCHAR(100) NULL,
    [OptionFlag] INT NULL,
    [Qty] NUMERIC(18, 4) NULL,
    [NewQty] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERY_VARIATION_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERY_VARIATION_DETAILS]
(
    [SYMBOL] VARCHAR(12) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL,
    [Variation] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELIVERYDP
-- --------------------------------------------------
CREATE TABLE [dbo].[DELIVERYDP]
(
    [SNo] INT IDENTITY(1,1) NOT NULL,
    [DpType] VARCHAR(4) NULL,
    [DpId] VARCHAR(16) NULL,
    [DpCltNo] VARCHAR(16) NULL,
    [Description] VARCHAR(50) NULL,
    [AccountType] VARCHAR(4) NULL,
    [Licenceno] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dellog
-- --------------------------------------------------
CREATE TABLE [dbo].[dellog]
(
    [Party_Code] VARCHAR(10) NULL,
    [OCltDpId] VARCHAR(16) NULL,
    [ODpId] VARCHAR(8) NULL,
    [OPOA] CHAR(1) NULL,
    [NCltDpID] VARCHAR(16) NULL,
    [NDpId] VARCHAR(8) NULL,
    [NPOA] CHAR(1) NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedDate] DATETIME NULL,
    [RecordFrom] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelPartyFlag
-- --------------------------------------------------
CREATE TABLE [dbo].[DelPartyFlag]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Debitflag] INT NULL,
    [Interflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELPOASHORTAGE
-- --------------------------------------------------
CREATE TABLE [dbo].[DELPOASHORTAGE]
(
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIPNAME] VARCHAR(12) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ISIN] VARCHAR(20) NOT NULL,
    [EXCHG] VARCHAR(3) NOT NULL,
    [SCRIPCODE] VARCHAR(12) NOT NULL,
    [TORECQTY] NUMERIC(18, 4) NOT NULL,
    [BALANCE] NUMERIC(18, 4) NOT NULL,
    [DPTYPE] VARCHAR(4) NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [POAFLAG] INT NULL,
    [START_DATE] DATETIME NULL,
    [STATUS] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELPOATEMP_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[DELPOATEMP_NEW]
(
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIPNAME] VARCHAR(12) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [QTY] NUMERIC(18, 4) NOT NULL,
    [ISIN] VARCHAR(20) NULL,
    [EXCHG] VARCHAR(3) NOT NULL,
    [START_DATE] DATETIME NULL,
    [STATUS] VARCHAR(8) NOT NULL,
    [DPID] VARCHAR(8) NULL,
    [CLTDPID] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelSlipMst
-- --------------------------------------------------
CREATE TABLE [dbo].[DelSlipMst]
(
    [Dptype] CHAR(4) NULL,
    [Sliptype] VARCHAR(2) NULL,
    [Slipno] NUMERIC(18, 0) NULL,
    [Slflag] INT NULL,
    [Checksum] VARCHAR(5) NULL,
    [Dpid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [SLIPSERIES] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[Digital_File_Name]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [D_Type] VARCHAR(8) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(10) NULL,
    [D_Order] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Doc_Ctgry
-- --------------------------------------------------
CREATE TABLE [dbo].[Doc_Ctgry]
(
    [Doc_Cd] VARCHAR(8) NOT NULL,
    [Ctgry_Code] VARCHAR(8) NULL,
    [Group_Code] VARCHAR(8) NOT NULL,
    [Mandatory_Flg] VARCHAR(1) NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_Id] VARCHAR(20) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Effective_Datefrom] DATETIME NOT NULL,
    [Effective_Dateto] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(20) NULL,
    [Modify_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(20) NULL,
    [Delete_Dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Document
-- --------------------------------------------------
CREATE TABLE [dbo].[Document]
(
    [Doc_Cd] VARCHAR(8) NOT NULL,
    [Long_Nm] VARCHAR(50) NOT NULL,
    [Stat] VARCHAR(1) NOT NULL,
    [Entry_Id] VARCHAR(20) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(20) NULL,
    [Modify_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(20) NULL,
    [Delete_Dt] DATETIME NULL,
    [DOC_DESC] VARCHAR(122) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMail_Blank_Check
-- --------------------------------------------------
CREATE TABLE [dbo].[EMail_Blank_Check]
(
    [Email_Blank_Flag] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMail_Login_User
-- --------------------------------------------------
CREATE TABLE [dbo].[EMail_Login_User]
(
    [EMail_Login_Id] VARCHAR(10) NOT NULL,
    [EMail_Login_Name] VARCHAR(50) NOT NULL,
    [EMail_Login_Password] VARCHAR(10) NOT NULL,
    [EMail_Login_Status] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMail_PartyReport
-- --------------------------------------------------
CREATE TABLE [dbo].[EMail_PartyReport]
(
    [EMail_Party_Code] CHAR(10) NOT NULL,
    [EMail_Report_Names] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMail_Report_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[EMail_Report_Log]
(
    [EMail_Login_Id] VARCHAR(10) NOT NULL,
    [EMail_Activity_Type] CHAR(1) NOT NULL,
    [EMail_Activity_Date] INT NOT NULL,
    [EMail_Activity_Time] INT NOT NULL,
    [EMail_From_Party] VARCHAR(10) NOT NULL,
    [EMail_Mail_Add] VARCHAR(50) NOT NULL,
    [EMail_Report_Name] VARCHAR(5000) NULL,
    [EMail_Report_Date] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMail_Report_Settings
-- --------------------------------------------------
CREATE TABLE [dbo].[EMail_Report_Settings]
(
    [email_report_name] VARCHAR(50) NOT NULL,
    [email_report_path] VARCHAR(256) NOT NULL,
    [email_report_subject] VARCHAR(256) NOT NULL,
    [email_report_cc] VARCHAR(256) NOT NULL,
    [email_report_body] VARCHAR(256) NOT NULL,
    [email_report_priority] INT NOT NULL,
    [email_report_parameter] VARCHAR(256) NOT NULL,
    [email_search_parameter] VARCHAR(256) NOT NULL,
    [email_out_file_prefix] VARCHAR(10) NOT NULL,
    [email_output_folder] VARCHAR(256) NOT NULL,
    [email_output_sub_folder] VARCHAR(100) NOT NULL,
    [email_dateformat] INT NOT NULL,
    [email_table_name] VARCHAR(200) NULL,
    [email_network_path] VARCHAR(256) NOT NULL,
    [email_report_from] VARCHAR(256) NOT NULL,
    [Email_Out_File_Suffix] VARCHAR(20) NULL,
    [Email_Out_File_SubFolderFlag] INT NULL,
    [Email_Out_File_SrNo_Part1] INT NULL,
    [Email_Out_File_SrNo_Part2] INT NULL,
    [Email_Out_File_SrNo_Type] VARCHAR(8) NULL,
    [Email_Out_File_Name] VARCHAR(50) NULL,
    [Email_Report_Desc] VARCHAR(30) NULL,
    [Email_Zip_File] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ErrorLog
-- --------------------------------------------------
CREATE TABLE [dbo].[ErrorLog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exalloc_netposition
-- --------------------------------------------------
CREATE TABLE [dbo].[exalloc_netposition]
(
    [party_code] VARCHAR(20) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(15) NULL,
    [expirydate] SMALLDATETIME NULL,
    [strike_price] MONEY NULL,
    [option_type] VARCHAR(2) NULL,
    [pqty] INT NULL,
    [sqty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Exchanges
-- --------------------------------------------------
CREATE TABLE [dbo].[Exchanges]
(
    [Exchange] CHAR(3) NOT NULL,
    [Short_name] CHAR(20) NULL,
    [Long_name] CHAR(50) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Saj_code] CHAR(10) NULL,
    [Alloc_method] CHAR(3) NULL,
    [marketsegment] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE_DATA]
(
    [TEXTDATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILEDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILEDATA]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROGID] VARCHAR(16) NULL,
    [FILE_DATA] VARCHAR(MAX) NULL,
    [UploadDateTime] DATETIME NULL,
    [UploadBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_POS_DETAILS_DAS]
(
    [FOPDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOPDD_INST_TYPE] VARCHAR(6) NULL,
    [FOPDD_SYMBOL] VARCHAR(12) NULL,
    [FOPDD_STRIKE_PRICE] MONEY NULL,
    [FOPDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOPDD_INTFLAG] VARCHAR(15) NULL,
    [FOPDD_EXPIRYDATE] DATETIME NULL,
    [FOPDD_SEC_NAME] VARCHAR(35) NULL,
    [FOPDD_OPENING_PQTY] INT NULL,
    [FOPDD_OPENING_SQTY] INT NULL,
    [FOPDD_TODAY_PQTY] INT NULL,
    [FOPDD_TODAY_SQTY] INT NULL,
    [FOPDD_EXERCISEDQTY] INT NULL,
    [FOPDD_ASSIGNEDQTY] INT NULL,
    [FOPDD_INS_PQTY] INT NULL,
    [FOPDD_INS_SQTY] INT NULL,
    [FOPDD_CLOSING_PQTY] INT NULL,
    [FOPDD_CLOSING_SQTY] INT NULL,
    [FOPDD_EXPQTY] INT NULL,
    [FOPDD_AUTOCORPQTY] INT NULL,
    [FOPDD_LONGVALUE] MONEY NULL,
    [FOPDD_SHORTVALUE] MONEY NULL,
    [FOPDD_CLOSINGPRICE] MONEY NULL,
    [FOPDD_STLMNTPRICE] MONEY NULL,
    [FOPDD_FLAG] VARCHAR(2) NULL,
    [FOPDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOPDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOPDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_TRADE_DETAILS_DAS]
(
    [FOTDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOTDD_INST_TYPE] VARCHAR(6) NULL,
    [FOTDD_SYMBOL] VARCHAR(12) NULL,
    [FOTDD_STRIKE_PRICE] MONEY NULL,
    [FOTDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOTDD_EXPIRY_DATE] DATETIME NULL,
    [FOTDD_SEC_NAME] VARCHAR(25) NOT NULL,
    [FOTDD_TRADEQTY] INT NULL,
    [FOTDD_VALUE] MONEY NULL,
    [FOTDD_PRICE] MONEY NULL,
    [FOTDD_PQTY] INT NULL,
    [FOTDD_SQTY] INT NULL,
    [FOTDD_PAMT] MONEY NULL,
    [FOTDD_SAMT] MONEY NULL,
    [FOTDD_NETRATE] NUMERIC(15, 7) NULL,
    [FOTDD_CFPPRICE] MONEY NULL,
    [FOTDD_CFSPRICE] MONEY NULL,
    [FOTDD_SETTPRICE] MONEY NULL,
    [FOTDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOTDD_PNETRATE] MONEY NULL,
    [FOTDD_SNETRATE] MONEY NULL,
    [FOTDD_CHARGES] MONEY NULL,
    [FOTDD_BROKERAGE] MONEY NULL,
    [FOTDD_SERVICE_TAX] MONEY NULL,
    [FOTDD_BROKER_NOTE] MONEY NULL,
    [FOTDD_TURN_TAX] MONEY NULL,
    [FOTDD_SEBI_TAX] MONEY NULL,
    [FOTDD_CONTRACTNO] VARCHAR(14) NOT NULL,
    [FOTDD_PCOMM] MONEY NULL,
    [FOTDD_SCOMM] MONEY NULL,
    [FOTDD_INS_CHRG] MONEY NULL,
    [FOTDD_FLAG] VARCHAR(5) NULL,
    [FOTDD_O_C_FLAG] VARCHAR(5) NULL,
    [FOTDD_AUCTIONPART] VARCHAR(2) NULL,
    [FOTDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOTDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foaccbill
-- --------------------------------------------------
CREATE TABLE [dbo].[foaccbill]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Bill_No] INT NULL,
    [Sell_Buy] VARCHAR(2) NOT NULL,
    [Sett_No] VARCHAR(12) NOT NULL,
    [Sett_Type] VARCHAR(2) NOT NULL,
    [BillDate] SMALLDATETIME NOT NULL,
    [Start_Date] SMALLDATETIME NOT NULL,
    [End_Date] SMALLDATETIME NOT NULL,
    [PayIn_Date] SMALLDATETIME NOT NULL,
    [PayOut_Date] SMALLDATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [expiryflag] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [Reserved3] INT NULL,
    [Branchcd] VARCHAR(10) NULL,
    [Narration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOADDMARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[FOADDMARGIN]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [MARGIN_AMT] NUMERIC(18, 4) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MODIFIED_BY] VARCHAR(20) NULL,
    [MODIFIED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOAddMargin_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[FOAddMargin_Imp]
(
    [MDate] VARCHAR(11) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [AddMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLNO
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLNO]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [BILLDATE] SMALLDATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBillValan
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBillValan]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(10) NULL,
    [BillNo] INT NULL,
    [ContractNo] VARCHAR(10) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [expirydate] SMALLDATETIME NULL,
    [Option_type] VARCHAR(2) NULL,
    [Strike_Price] MONEY NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MaturityDate] SMALLDATETIME NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [IsIn] VARCHAR(12) NULL,
    [PQty] INT NULL,
    [SQty] INT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [PAmt] MONEY NULL,
    [SAmt] MONEY NULL,
    [PBrokAmt] MONEY NULL,
    [SBrokAmt] MONEY NULL,
    [PBillAmt] MONEY NULL,
    [SBillAmt] MONEY NULL,
    [Cl_Rate] MONEY NULL,
    [Cl_Chrg] MONEY NULL,
    [ExCl_Chrg] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [ExSer_Tax] MONEY NULL,
    [InExSerFlag] SMALLINT NULL,
    [sebi_tax] MONEY NULL,
    [turn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [TradeType] VARCHAR(3) NULL,
    [ParticiPantCode] VARCHAR(15) NULL,
    [Terminal_Id] VARCHAR(15) NULL,
    [Family] VARCHAR(10) NULL,
    [FamilyName] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [StatusName] VARCHAR(15) NULL,
    [Exchange] VARCHAR(5) NULL,
    [Segment] VARCHAR(10) NULL,
    [MemberType] VARCHAR(2) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Region] VARCHAR(20) NULL,
    [UpdateDate] VARCHAR(11) NULL,
    [email] VARCHAR(100) NULL,
    [SBU] VARCHAR(10) NULL,
    [RELMGR] VARCHAR(10) NULL,
    [GRP] VARCHAR(10) NULL,
    [Sector] VARCHAR(20) NULL,
    [CMClosing] MONEY NULL,
    [Track] VARCHAR(1) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoBillValan_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[FoBillValan_Temp]
(
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(10) NULL,
    [BillNo] VARCHAR(10) NULL,
    [ContractNo] VARCHAR(10) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [expirydate] SMALLDATETIME NULL,
    [Option_type] VARCHAR(2) NULL,
    [Strike_Price] MONEY NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MaturityDate] SMALLDATETIME NULL,
    [Sauda_date] SMALLDATETIME NULL,
    [IsIn] VARCHAR(12) NULL,
    [PQty] INT NULL,
    [SQty] INT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [PAmt] MONEY NULL,
    [SAmt] MONEY NULL,
    [PBrokAmt] MONEY NULL,
    [SBrokAmt] MONEY NULL,
    [PBillAmt] MONEY NULL,
    [SBillAmt] MONEY NULL,
    [Cl_Rate] MONEY NULL,
    [Cl_Chrg] MONEY NULL,
    [ExCl_Chrg] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [ExSer_Tax] MONEY NULL,
    [InExSerFlag] SMALLINT NULL,
    [sebi_tax] MONEY NULL,
    [turn_tax] MONEY NULL,
    [Broker_note] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [TradeType] VARCHAR(3) NULL,
    [ParticiPantCode] VARCHAR(15) NULL,
    [Terminal_Id] VARCHAR(15) NULL,
    [Family] VARCHAR(10) NULL,
    [FamilyName] VARCHAR(50) NULL,
    [Trader] VARCHAR(20) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [StatusName] VARCHAR(15) NULL,
    [Exchange] VARCHAR(5) NULL,
    [Segment] VARCHAR(10) NULL,
    [MemberType] VARCHAR(2) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Region] VARCHAR(10) NULL,
    [UpdateDate] VARCHAR(11) NULL,
    [email] VARCHAR(100) NULL,
    [SBU] VARCHAR(10) NULL,
    [RELMGR] VARCHAR(10) NULL,
    [GRP] VARCHAR(10) NULL,
    [Sector] VARCHAR(20) NULL,
    [CMClosing] MONEY NULL,
    [Track] VARCHAR(1) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoCarryFwdBrok
-- --------------------------------------------------
CREATE TABLE [dbo].[FoCarryFwdBrok]
(
    [Party_Code] VARCHAR(10) NULL,
    [Brokerage] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Sauda_Date] DATETIME NULL,
    [ExSer] MONEY NULL,
    [Charge] MONEY NULL,
    [InSerTax] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoClientBrokScheme
-- --------------------------------------------------
CREATE TABLE [dbo].[FoClientBrokScheme]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_BrokTable] INT NULL,
    [Opt_BrokTable] INT NULL,
    [Fut_Exp_BrokTable] INT NULL,
    [Opt_Exc_BrokTable] INT NULL,
    [Comm_Del_BrokTable] INT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Opt_Brok_ComputeOn] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoClientTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[FoClientTaxes]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Fut_Other_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Fut_Broker_Note] DECIMAL(18, 5) NULL,
    [Opt_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Opt_Other_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Opt_Broker_Note] DECIMAL(18, 5) NULL,
    [Round_To] DECIMAL(18, 0) NULL,
    [RoFig] INT NULL,
    [ErrNum] NUMERIC(18, 10) NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foclosing
-- --------------------------------------------------
CREATE TABLE [dbo].[foclosing]
(
    [Cl_Rate] MONEY NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Trade_Date] SMALLDATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Strike_price] MONEY NULL,
    [Cor_Act_level] INT NULL,
    [MarketType] VARCHAR(5) NULL,
    [Option_type] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foclosing_billreport
-- --------------------------------------------------
CREATE TABLE [dbo].[foclosing_billreport]
(
    [Cl_Rate] MONEY NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Trade_Date] SMALLDATETIME NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Strike_price] MONEY NULL,
    [Cor_Act_level] INT NULL,
    [MarketType] VARCHAR(5) NULL,
    [Option_type] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLOSING_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLOSING_IMP]
(
    [INST_TYPE] VARCHAR(10) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] VARCHAR(20) NULL,
    [STRIKE_PRICE] VARCHAR(20) NULL,
    [OPTION_TYPE] VARCHAR(20) NULL,
    [OPEN_PRICE] NUMERIC(18, 4) NULL,
    [HIGH_PRICE] NUMERIC(18, 4) NULL,
    [LOW_PRICE] NUMERIC(18, 4) NULL,
    [CL_RATE] NUMERIC(18, 4) NULL,
    [SETTL_PRICE] NUMERIC(18, 4) NULL,
    [QTYTRADED] NUMERIC(18, 4) NULL,
    [VALUE] NUMERIC(18, 4) NULL,
    [OPENINTREST] NUMERIC(18, 4) NULL,
    [CHANGEIN_OPENINTREST] NUMERIC(18, 4) NULL,
    [TIMESTAMP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLOSING_ULPRICE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLOSING_ULPRICE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [TRADE_DATE] DATETIME NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [UL_PRICE] MONEY NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoClosingDetail
-- --------------------------------------------------
CREATE TABLE [dbo].[FoClosingDetail]
(
    [Trade_Date] DATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Previous_Close] NUMERIC(18, 4) NULL,
    [Open_Price] NUMERIC(18, 4) NULL,
    [High_Price] NUMERIC(18, 4) NULL,
    [Low_Price] NUMERIC(18, 4) NULL,
    [Cl_Rate] NUMERIC(18, 4) NULL,
    [QtyTraded] NUMERIC(18, 4) NULL,
    [Value] NUMERIC(18, 4) NULL,
    [OpenIntrest] NUMERIC(18, 4) NULL,
    [ChangeIn_OpenIntrest] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foerrorlog
-- --------------------------------------------------
CREATE TABLE [dbo].[foerrorlog]
(
    [ErrDate] SMALLDATETIME NULL,
    [CName] VARCHAR(200) NULL,
    [MName] VARCHAR(200) NULL,
    [SName] VARCHAR(200) NULL,
    [ErrStr] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOERRTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOERRTRADE]
(
    [Trade_No] VARCHAR(20) NOT NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] VARCHAR(10) NULL,
    [BookTypeName] VARCHAR(10) NULL,
    [MarKetType] VARCHAR(10) NULL,
    [User_Id] VARCHAR(12) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [Opp_Broker_Id] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL,
    [reserved1] VARCHAR(10) NULL,
    [reserved2] VARCHAR(20) NULL,
    [reserved3] VARCHAR(10) NULL,
    [reserved4] VARCHAR(10) NULL,
    [reserved5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foexallocsettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[foexallocsettlement]
(
    [ContractNo] VARCHAR(14) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [CpId] INT NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] INT NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOexallocTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOexallocTRADE]
(
    [foeatrd_Trade_No] VARCHAR(20) NULL,
    [foeatrd_Status] VARCHAR(2) NULL,
    [foeatrd_Inst_Type] VARCHAR(6) NULL,
    [foeatrd_Symbol] VARCHAR(12) NULL,
    [foeatrd_Expirydate] SMALLDATETIME NULL,
    [foeatrd_Strike_price] MONEY NULL,
    [foeatrd_Option_type] VARCHAR(2) NULL,
    [foeatrd_Sec_Name] VARCHAR(50) NULL,
    [foeatrd_MarKetType] VARCHAR(2) NULL,
    [foeatrd_User_Id] VARCHAR(15) NULL,
    [foeatrd_Sell_Buy] INT NULL,
    [foeatrd_TradeQty] INT NULL,
    [foeatrd_Price] MONEY NULL,
    [foeatrd_Pro_cli] INT NULL,
    [foeatrd_Party_Code] VARCHAR(10) NULL,
    [foeatrd_O_C_Flag] VARCHAR(5) NULL,
    [foeatrd_C_U_Flag] VARCHAR(7) NULL,
    [foeatrd_ActivityTime] DATETIME NULL,
    [foeatrd_Order_No] VARCHAR(20) NULL,
    [foeatrd_settflag] INT NULL,
    [foeatrd_cl_rate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foexalloctradehist
-- --------------------------------------------------
CREATE TABLE [dbo].[foexalloctradehist]
(
    [foeatrd_Trade_No] VARCHAR(20) NULL,
    [foeatrd_Status] VARCHAR(2) NULL,
    [foeatrd_Inst_Type] VARCHAR(6) NULL,
    [foeatrd_Symbol] VARCHAR(12) NULL,
    [foeatrd_Expirydate] SMALLDATETIME NULL,
    [foeatrd_Strike_price] MONEY NULL,
    [foeatrd_Option_type] VARCHAR(2) NULL,
    [foeatrd_Sec_Name] VARCHAR(50) NULL,
    [foeatrd_MarKetType] VARCHAR(2) NULL,
    [foeatrd_User_Id] VARCHAR(15) NULL,
    [foeatrd_Sell_Buy] INT NULL,
    [foeatrd_TradeQty] INT NULL,
    [foeatrd_Price] MONEY NULL,
    [foeatrd_Pro_cli] INT NULL,
    [foeatrd_Party_Code] VARCHAR(10) NULL,
    [foeatrd_O_C_Flag] VARCHAR(5) NULL,
    [foeatrd_C_U_Flag] VARCHAR(7) NULL,
    [foeatrd_ActivityTime] DATETIME NULL,
    [foeatrd_Order_No] VARCHAR(20) NULL,
    [foeatrd_settflag] INT NULL,
    [foeatrd_cl_rate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foexalloctradehistnew
-- --------------------------------------------------
CREATE TABLE [dbo].[foexalloctradehistnew]
(
    [foeatrd_Trade_No] VARCHAR(20) NULL,
    [foeatrd_Status] VARCHAR(2) NULL,
    [foeatrd_Inst_Type] VARCHAR(6) NULL,
    [foeatrd_Symbol] VARCHAR(12) NULL,
    [foeatrd_Expirydate] SMALLDATETIME NULL,
    [foeatrd_Strike_price] MONEY NULL,
    [foeatrd_Option_type] VARCHAR(2) NULL,
    [foeatrd_Sec_Name] VARCHAR(50) NULL,
    [foeatrd_MarKetType] VARCHAR(2) NULL,
    [foeatrd_User_Id] VARCHAR(15) NULL,
    [foeatrd_Sell_Buy] INT NULL,
    [foeatrd_TradeQty] INT NULL,
    [foeatrd_Price] MONEY NULL,
    [foeatrd_Pro_cli] INT NULL,
    [foeatrd_Party_Code] VARCHAR(10) NULL,
    [foeatrd_O_C_Flag] VARCHAR(5) NULL,
    [foeatrd_C_U_Flag] VARCHAR(7) NULL,
    [foeatrd_ActivityTime] DATETIME NULL,
    [foeatrd_Order_No] VARCHAR(20) NULL,
    [foeatrd_settflag] INT NULL,
    [foeatrd_cl_rate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoExerciseallocation
-- --------------------------------------------------
CREATE TABLE [dbo].[FoExerciseallocation]
(
    [FoEa_Table_No] VARCHAR(16) NULL,
    [FoEa_Position_Date] DATETIME NULL,
    [FoEa_Desc] VARCHAR(50) NULL,
    [FoEa_Segment_Ind] VARCHAR(5) NULL,
    [FoEa_Sett_Type] VARCHAR(2) NULL,
    [FoEa_Cm_Code] VARCHAR(13) NULL,
    [FoEa_Mem_Type] VARCHAR(1) NULL,
    [FoEa_Tm_Code] VARCHAR(13) NULL,
    [FoEa_Acc_Type] VARCHAR(2) NULL,
    [FoEa_Party_Code] VARCHAR(15) NULL,
    [FoEa_Inst_Type] VARCHAR(6) NULL,
    [FoEa_Symbol] VARCHAR(12) NULL,
    [FoEa_Expirydate] DATETIME NULL,
    [FoEa_Strike_Price] MONEY NULL,
    [FoEa_Option_Type] VARCHAR(2) NULL,
    [FoEa_Cor_Act_Level] INT NULL,
    [FoEa_Preexall_Longqty] INT NULL,
    [FoEa_Preexall_Shortqty] INT NULL,
    [FoEa_Exercise_Qty] INT NULL,
    [FoEa_Alloc_Qty] INT NULL,
    [FoEa_Postexall_Longqty] INT NULL,
    [FoEa_Postexall_Shortqty] INT NULL,
    [FoEa_Brought_FoRward_Long_Quantity] INT NULL,
    [FoEa_Brought_FoRward_Long_Value] MONEY NULL,
    [FoEa_Brought_FoRward_Short_Quantity] INT NULL,
    [FoEa_Brought_FoRward_Short_Value] MONEY NULL,
    [FoEa_Day_Buy_Open_Quantity] INT NULL,
    [FoEa_Day_Buy_Open_Value] MONEY NULL,
    [FoEa_Day_Sell_Open_Quantity] INT NULL,
    [FoEa_Day_Sell_Open_Value] MONEY NULL,
    [FoEa_Preexall_Longvalue] MONEY NULL,
    [FoEa_Preexall_Shortvalue] MONEY NULL,
    [FoEa_Postexall_Longvalue] MONEY NULL,
    [FoEa_Postexall_Shortvalue] MONEY NULL,
    [FoEa_Settlementprice] MONEY NULL,
    [FoEa_Netpremium] MONEY NULL,
    [FoEa_Daily_Mtm_Settlement_Value] MONEY NULL,
    [FoEa_Futures_Final_Settlement_Value] MONEY NULL,
    [FoEa_Exercised_Assigned_Value] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOExerciseAllocation_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[FOExerciseAllocation_Temp]
(
    [FoEa_Position_Date] DATETIME NULL,
    [FoEa_Segment_Ind] VARCHAR(5) NULL,
    [FoEa_Sett_Type] VARCHAR(2) NULL,
    [FoEa_Cm_Code] VARCHAR(13) NULL,
    [FoEa_Mem_Type] VARCHAR(1) NULL,
    [FoEa_Tm_Code] VARCHAR(13) NULL,
    [FoEa_Acc_Type] VARCHAR(2) NULL,
    [FoEa_Party_Code] VARCHAR(15) NULL,
    [FoEa_Inst_Type] VARCHAR(6) NULL,
    [FoEa_Symbol] VARCHAR(12) NULL,
    [FoEa_Expirydate] DATETIME NULL,
    [FoEa_Strike_Price] MONEY NULL,
    [FoEa_Option_Type] VARCHAR(2) NULL,
    [FoEa_Cor_Act_Level] INT NULL,
    [FoEa_Brought_FoRward_Long_Quantity] INT NULL,
    [FoEa_Brought_FoRward_Long_Value] MONEY NULL,
    [FoEa_Brought_FoRward_Short_Quantity] INT NULL,
    [FoEa_Brought_FoRward_Short_Value] MONEY NULL,
    [FoEa_Day_Buy_Open_Quantity] INT NULL,
    [FoEa_Day_Buy_Open_Value] MONEY NULL,
    [FoEa_Day_Sell_Open_Quantity] INT NULL,
    [FoEa_Day_Sell_Open_Value] MONEY NULL,
    [FoEa_Preexall_Longqty] INT NULL,
    [FoEa_Preexall_Longvalue] MONEY NULL,
    [FoEa_Preexall_Shortqty] INT NULL,
    [FoEa_Preexall_Shortvalue] MONEY NULL,
    [FoEa_Exercise_Qty] INT NULL,
    [FoEa_Alloc_Qty] INT NULL,
    [FoEa_Postexall_Longqty] INT NULL,
    [FoEa_Postexall_Longvalue] MONEY NULL,
    [FoEa_Postexall_Shortqty] INT NULL,
    [FoEa_Postexall_Shortvalue] MONEY NULL,
    [FoEa_Settlementprice] MONEY NULL,
    [FoEa_Netpremium] MONEY NULL,
    [FoEa_Daily_Mtm_Settlement_Value] MONEY NULL,
    [FoEa_Futures_Final_Settlement_Value] MONEY NULL,
    [FoEa_Exercised_Assigned_Value] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXERCISEALLOCATION_TEMP_UDIFF
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXERCISEALLOCATION_TEMP_UDIFF]
(
    [SGMT] VARCHAR(20) NULL,
    [SRC] VARCHAR(20) NULL,
    [RPTGDT] VARCHAR(20) NULL,
    [BIZDT] VARCHAR(20) NULL,
    [TRADREGNORGN] VARCHAR(100) NULL,
    [CLRMMBID] VARCHAR(100) NULL,
    [BRKRORCTDNPTCPTID] VARCHAR(100) NULL,
    [CLNTTP] VARCHAR(100) NULL,
    [CLNTID] VARCHAR(100) NULL,
    [FININSTRMTP] VARCHAR(100) NULL,
    [ISIN] VARCHAR(100) NULL,
    [TCKRSYMB] VARCHAR(100) NULL,
    [XPRYDT] VARCHAR(100) NULL,
    [FININSTRMACTLXPRYDT] VARCHAR(100) NULL,
    [STRKPRIC] VARCHAR(100) NULL,
    [OPTNTP] VARCHAR(100) NULL,
    [NEWBRDLOTQTY] VARCHAR(100) NULL,
    [OPNGLNGQTY] VARCHAR(100) NULL,
    [OPNGLNGVAL] VARCHAR(100) NULL,
    [OPNGSHRTQTY] VARCHAR(100) NULL,
    [OPNGSHRTVAL] VARCHAR(100) NULL,
    [OPNBUYTRADGQTY] VARCHAR(100) NULL,
    [OPNBUYTRADGVAL] VARCHAR(100) NULL,
    [OPNSELLTRADGQTY] VARCHAR(100) NULL,
    [OPNSELLTRADGVAL] VARCHAR(100) NULL,
    [PREEXRCASSGNDLNGQTY] VARCHAR(100) NULL,
    [PREEXRCASSGNDLNGVAL] VARCHAR(100) NULL,
    [PREEXRCASSGNDSHRTQTY] VARCHAR(100) NULL,
    [PREEXRCASSGNDSHRTVAL] VARCHAR(100) NULL,
    [EXRCDQTY] VARCHAR(100) NULL,
    [ASSGNDQTY] VARCHAR(100) NULL,
    [PSTEXRCASSGNDLNGQTY] VARCHAR(100) NULL,
    [PSTEXRCASSGNDLNGVAL] VARCHAR(100) NULL,
    [PSTEXRCASSGNDSHRTQTY] VARCHAR(100) NULL,
    [PSTEXRCASSGNDSHRTVAL] VARCHAR(100) NULL,
    [STTLMPRIC] VARCHAR(100) NULL,
    [REFRATE] VARCHAR(100) NULL,
    [PRMAMT] VARCHAR(100) NULL,
    [DALYMRKTOMKTSETTLMVAL] VARCHAR(100) NULL,
    [FUTRSFNLSTTLMVAL] VARCHAR(100) NULL,
    [EXRCASSGNDVAL] VARCHAR(100) NULL,
    [RMKS] VARCHAR(150) NULL,
    [RSVD1] VARCHAR(60) NULL,
    [RSVD2] VARCHAR(60) NULL,
    [RSVD3] VARCHAR(60) NULL,
    [RSVD4] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foexpirybackup
-- --------------------------------------------------
CREATE TABLE [dbo].[foexpirybackup]
(
    [SrNo] INT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(15) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] INT NULL,
    [Instrument] INT NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL,
    [lst_updt_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoExpirysettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[FoExpirysettlement]
(
    [Contractno] VARCHAR(14) NOT NULL,
    [Billno] VARCHAR(10) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_Name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Pro_Cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [Auctionpart] VARCHAR(2) NULL,
    [Markettype] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_No] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_Perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_Puc] MONEY NULL,
    [Day_Sales] MONEY NULL,
    [Sett_Purch] MONEY NULL,
    [Sett_Sales] MONEY NULL,
    [Sell_Buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [Netrate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [Trade_Amount] MONEY NULL,
    [Billflag] INT NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Nbrokapp] MONEY NULL,
    [Nsertax] MONEY NULL,
    [N_Netrate] DECIMAL(15, 7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [Participantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [Cpid] INT NULL,
    [Instrument] INT NULL,
    [Booktype] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Tmark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoFinalClosing
-- --------------------------------------------------
CREATE TABLE [dbo].[FoFinalClosing]
(
    [ClosingDate] SMALLDATETIME NOT NULL,
    [UnderlyingAsset] VARCHAR(12) NOT NULL,
    [Cl_Rate] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoFttrade
-- --------------------------------------------------
CREATE TABLE [dbo].[FoFttrade]
(
    [Trade_No] VARCHAR(20) NOT NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(50) NULL,
    [BookType] VARCHAR(10) NULL,
    [BookTypeName] VARCHAR(10) NULL,
    [MarKetType] VARCHAR(10) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [Opp_Broker_Id] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL,
    [reserved1] VARCHAR(10) NULL,
    [reserved2] VARCHAR(20) NULL,
    [reserved3] VARCHAR(10) NULL,
    [reserved4] VARCHAR(10) NULL,
    [reserved5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoFtTrade_1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FoFtTrade_1_IMP]
(
    [Trade_No] VARCHAR(10) NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] VARCHAR(25) NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] VARCHAR(2) NULL,
    [BookTypeName] VARCHAR(3) NULL,
    [MarKetType] VARCHAR(2) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] NUMERIC(18, 8) NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(20) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(16) NULL,
    [Opp_Broker_Id] VARCHAR(10) NULL,
    [OrderTime] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRADE_2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRADE_2_IMP]
(
    [TRADE_NO] VARCHAR(20) NULL,
    [STATUS] VARCHAR(3) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [BOOKTYPENAME] VARCHAR(3) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [PRICE] NUMERIC(18, 8) NULL,
    [PRO_CLI] VARCHAR(2) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(10) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(16) NULL,
    [OPP_BROKER_ID] VARCHAR(10) NULL,
    [ORDERTIME] VARCHAR(20) NULL,
    [CTCLID] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoFtTrade_3_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FoFtTrade_3_IMP]
(
    [Trade_No] VARCHAR(20) NULL,
    [TradeDate] DATETIME NULL,
    [ActivityType] VARCHAR(2) NULL,
    [Markettype] VARCHAR(2) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [B_BrokerCode] VARCHAR(10) NULL,
    [S_BrokerCode] VARCHAR(10) NULL,
    [Price] NUMERIC(18, 8) NULL,
    [ActivityTime] DATETIME NULL,
    [TradeVolume] MONEY NULL,
    [Token_No] VARCHAR(50) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [B_CmCode] VARCHAR(10) NULL,
    [S_CmCode] VARCHAR(10) NULL,
    [Sell_Branch] VARCHAR(15) NULL,
    [B_ParticipantCode] VARCHAR(50) NULL,
    [B_Confirmation] CHAR(2) NULL,
    [S_ParticipantCode] VARCHAR(50) NULL,
    [S_Confirmation] CHAR(2) NULL,
    [B_O_C_Flag] VARCHAR(5) NULL,
    [S_O_C_Flag] VARCHAR(5) NULL,
    [B_Old_ParticipantCode] VARCHAR(50) NULL,
    [B_Old_CmCode] VARCHAR(10) NULL,
    [S_Old_ParticipantCode] VARCHAR(50) NULL,
    [S_Old_CmCode] VARCHAR(10) NULL,
    [B_Trader] VARCHAR(12) NULL,
    [S_Trader] VARCHAR(12) NULL,
    [B_Order_No] VARCHAR(16) NULL,
    [S_Order_No] VARCHAR(16) NULL,
    [B_Party_Code] VARCHAR(20) NULL,
    [S_Party_Code] VARCHAR(20) NULL,
    [B_Remark] VARCHAR(100) NULL,
    [S_Remark] VARCHAR(100) NULL,
    [B_TradeQty] VARCHAR(10) NULL,
    [S_TradeQty] VARCHAR(10) NULL,
    [B_Pro_cli] VARCHAR(10) NULL,
    [S_Pro_cli] VARCHAR(10) NULL,
    [ControlFlag] VARCHAR(2) NULL,
    [OrderTime] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRADE_4_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRADE_4_IMP]
(
    [TRADE_NO] VARCHAR(20) NULL,
    [STATUS] VARCHAR(3) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [BOOKTYPENAME] VARCHAR(3) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] NUMERIC(36, 0) NULL,
    [PRICE] NUMERIC(36, 12) NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(16) NULL,
    [OPP_BROKER_ID] VARCHAR(10) NULL,
    [ORDERTIME] VARCHAR(20) NULL,
    [CTCLID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRAE_1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRAE_1_IMP]
(
    [TRADE_NO] VARCHAR(20) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [ACTIVITY_TYPE] NUMERIC(2, 0) NULL,
    [MARKET_TYPE] VARCHAR(1) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(10) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(9, 2) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CA_LEVEL] NUMERIC(2, 0) NULL,
    [BUY_TM_CODE] VARCHAR(5) NULL,
    [SELL_TM_CODE] VARCHAR(5) NULL,
    [PRICE] NUMERIC(9, 2) NULL,
    [TRADE_TIME] DATETIME NULL,
    [TRADE_VOLUME] NUMERIC(12, 0) NULL,
    [TRADE_TOKEN_NO] NUMERIC(5, 0) NULL,
    [BUY_BRANCH] NUMERIC(2, 0) NULL,
    [BUY_CM_CODE] VARCHAR(6) NULL,
    [SELL_CM_CODE] VARCHAR(6) NULL,
    [SELL_BRANCH] NUMERIC(2, 0) NULL,
    [BUY_CP_CODE] VARCHAR(12) NULL,
    [BUY_CONF_FLAG] VARCHAR(1) NULL,
    [SELL_CP_CODE] VARCHAR(12) NULL,
    [SELL_CONF_FLAG] VARCHAR(1) NULL,
    [BUY_CU_FLAG] VARCHAR(1) NULL,
    [SELL_CU_FLAG] VARCHAR(1) NULL,
    [BUY_OLD_CP_CODE] VARCHAR(12) NULL,
    [BUY_OLD_CM_CODE] VARCHAR(6) NULL,
    [SELL_OLD_CP_CODE] VARCHAR(12) NULL,
    [SELL_OLD_CM_CODE] VARCHAR(6) NULL,
    [BUY_DEALER_CODE] NUMERIC(5, 0) NULL,
    [SELL_DEALER_CODE] NUMERIC(5, 0) NULL,
    [BUY_ORDER_NO] VARCHAR(20) NULL,
    [SELL_ORDER_NO] VARCHAR(20) NULL,
    [BUY_CLIENT] VARCHAR(10) NULL,
    [SELL_CLIENT] VARCHAR(10) NULL,
    [BUY_REMARKS] VARCHAR(24) NULL,
    [SELL_REMARKS] VARCHAR(24) NULL,
    [BUY_OC_FLAG] VARCHAR(1) NULL,
    [SELL_OC_FLAG] VARCHAR(1) NULL,
    [BUY_PRO_CLI] VARCHAR(1) NULL,
    [SELL_PRO_CLI] VARCHAR(1) NULL,
    [CONTROL_FLAG] VARCHAR(1) NULL,
    [LAST_MOD_TIME] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRAE_2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRAE_2_IMP]
(
    [TRADE_NO] VARCHAR(15) NULL,
    [STATUS] VARCHAR(2) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [INST_TYPE] VARCHAR(7) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(30) NULL,
    [MARKETTYPE] INT NULL,
    [BOOKTYPE] INT NULL,
    [USER_ID] VARCHAR(10) NULL,
    [BRANCH_ID] VARCHAR(10) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [PRICE] MONEY NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(16) NULL,
    [O_C_FLAG] VARCHAR(3) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(16) NULL,
    [OPP_BROKER_ID] VARCHAR(10) NULL,
    [NNF_ID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOGLOBALS
-- --------------------------------------------------
CREATE TABLE [dbo].[FOGLOBALS]
(
    [year] VARCHAR(4) NOT NULL,
    [exchange] VARCHAR(3) NOT NULL,
    [service_tax] MONEY NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] SMALLINT NULL,
    [sebi_turn_ac] SMALLINT NULL,
    [broker_note_ac] SMALLINT NULL,
    [other_chrg_ac] SMALLINT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NOT NULL,
    [year_end_dt] DATETIME NOT NULL,
    [CESS_Tax] NUMERIC(10, 9) NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [TRDSELLTRANS] NUMERIC(18, 6) NULL,
    [RMS_FEES] NUMERIC(18, 6) NULL,
    [SBCCHARGE] NUMERIC(18, 4) NULL,
    [KRISHICHARGE] NUMERIC(18, 4) NULL,
    [OPTTRDSELLTRANS] NUMERIC(18, 9) NULL,
    [OPTDELSELLTRANS] NUMERIC(18, 9) NULL,
    [STT_ON] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fomargin
-- --------------------------------------------------
CREATE TABLE [dbo].[fomargin]
(
    [party_code] VARCHAR(10) NOT NULL,
    [Margin_date] SMALLDATETIME NULL,
    [expirydate] SMALLDATETIME NULL,
    [Inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [totalqty] INT NULL,
    [cl_rate] MONEY NULL,
    [spreadqty] INT NULL,
    [spreadmth] VARCHAR(12) NULL,
    [nonspreadqty] INT NULL,
    [spreadmargin] MONEY NULL,
    [nonspreadmargin] MONEY NULL,
    [Ex_SpreadMargin] MONEY NULL,
    [Ex_nonspreadmargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Exp_Det_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Exp_Det_Log]
(
    [Sauda_Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [NetPosition] INT NULL,
    [Margin_Perc] NUMERIC(9, 4) NULL,
    [MarginAmt] MONEY NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL,
    [Modified_By] VARCHAR(20) NULL,
    [Modified_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Exp_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Exp_Details]
(
    [Sauda_Date] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [NetPosition] INT NULL,
    [Margin_Perc] NUMERIC(9, 4) NULL,
    [MarginAmt] MONEY NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Exp_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Exp_Imp]
(
    [SrNo] INT NULL,
    [Margin_Symbol] VARCHAR(12) NULL,
    [Margin_Perc] NVARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Exp_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Exp_Log]
(
    [Margin_Year] INT NULL,
    [Margin_Month] INT NULL,
    [Margin_Symbol] VARCHAR(12) NULL,
    [Margin_Perc] NUMERIC(9, 4) NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL,
    [Modified_By] VARCHAR(20) NULL,
    [Modified_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Exp_Perc
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Exp_Perc]
(
    [Margin_Year] INT NULL,
    [Margin_Month] INT NULL,
    [Margin_Symbol] VARCHAR(12) NULL,
    [Margin_Perc] NUMERIC(9, 4) NULL,
    [Created_By] VARCHAR(20) NULL,
    [Created_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_PENALTY
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_PENALTY]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SHORTAGE] MONEY NULL,
    [PENALTY_PERC] NUMERIC(12, 6) NULL,
    [PENALTY_AMT] MONEY NULL,
    [DAYS_3_COUNT] INT NULL,
    [MONTH_5_COUNT] INT NULL,
    [LEDGER_POST_FLAG] INT NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL,
    [SERVICE_TAX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_SHORTAGE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_SHORTAGE]
(
    [MDATE] VARCHAR(11) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [SPREADMARGIN] MONEY NULL,
    [NONSPREADMARGIN] MONEY NULL,
    [TOTALMARGIN] MONEY NULL,
    [MTOM] MONEY NULL,
    [MTOMLOSS] MONEY NULL,
    [DEL_MARGIN] MONEY NULL,
    [EFFECTIVECOLL] MONEY NULL,
    [CL_TYPE] VARCHAR(2) NULL,
    [PEAKMARGIN] MONEY NULL,
    [EFFECTIVECOLL_PEAK] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_SHORTAGE_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_SHORTAGE_LOG]
(
    [MDATE] DATETIME NULL,
    [VALIDATEWITH] VARCHAR(30) NULL,
    [ACTOPT] VARCHAR(30) NULL,
    [COLLOPT] VARCHAR(30) NULL,
    [BATCHNO] VARCHAR(10) NULL,
    [REFNO] INT NULL,
    [VALIDATIONDATE] VARCHAR(11) NULL,
    [CREATEDBY] VARCHAR(20) NULL,
    [CREATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMargin_Span
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMargin_Span]
(
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Spanmargin] MONEY NULL,
    [Premium] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Pmarginrate] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Newspanmargin] MONEY NULL,
    [Finaltotalmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginAdd
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginAdd]
(
    [Mdate] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Segment] VARCHAR(3) NULL,
    [Cl_Type] VARCHAR(3) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [ExpiryDate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [NetPosition] INT NULL,
    [MarginablePosition] INT NULL,
    [SettlementPrice] MONEY NULL,
    [MarginPercent] MONEY NULL,
    [AddMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginAdd_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginAdd_Imp]
(
    [Party_Code] VARCHAR(10) NULL,
    [Segment] VARCHAR(3) NULL,
    [Cl_Type] VARCHAR(3) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [ExpiryDate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Cor_Act_Level] NVARCHAR(5) NULL,
    [NetPosition] NVARCHAR(10) NULL,
    [MarginablePosition] NVARCHAR(10) NULL,
    [SettlementPrice] MONEY NULL,
    [MarginPercent] MONEY NULL,
    [AddMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginnew
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginnew]
(
    [Party_Code] VARCHAR(12) NOT NULL,
    [Spreadmargin] MONEY NULL,
    [Nonspreadmargin] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Pmargin] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Pmarginamount] MONEY NULL,
    [Pspanmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL,
    [Mtom] MONEY NULL,
    [AddMargin] MONEY NULL,
    [DEL_MARGIN] NUMERIC(18, 4) NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [PEAKMARGIN] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_DATA]
(
    [MDATE] DATETIME NULL,
    [TMCODE] VARCHAR(12) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [INITIALMARGIN] MONEY NULL,
    [OTHERMARGIN] MONEY NULL,
    [MTOMMARGIN] MONEY NULL,
    [INITIALMARGIN_REP] MONEY NULL,
    [OTHERMARGIN_REP] MONEY NULL,
    [MTOMMARGIN_REP] MONEY NULL,
    [INITIALMARGIN_SHORT] MONEY NULL,
    [OTHERMARGIN_SHORT] MONEY NULL,
    [MTOMMARGIN_SHORT] MONEY NULL,
    [UPLOADED_BY] VARCHAR(20) NULL,
    [UPLOADED_ON] DATETIME NULL,
    [PEAKMARGIN] NUMERIC(18, 4) NULL,
    [PEAKMARGIN_REP] NUMERIC(18, 4) NULL,
    [PEAKMARGIN_SHORT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_EFFCOLL
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_EFFCOLL]
(
    [PARTY_CODE] VARCHAR(12) NULL,
    [EFFECTIVECOLL] MONEY NULL,
    [EFFECTIVECOLL_OTHER] MONEY NULL,
    [EFFECTIVECOLL_MTOM] MONEY NULL,
    [EffectiveColl_PEAK] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginNew_EffColl_BKUP_08Apr2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginNew_EffColl_BKUP_08Apr2024]
(
    [Party_Code] VARCHAR(12) NULL,
    [EffectiveColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_EXCH
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_EXCH]
(
    [Party_Code] VARCHAR(12) NULL,
    [Spreadmargin] MONEY NULL,
    [Nonspreadmargin] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Pmargin] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Pmarginamount] MONEY NULL,
    [Pspanmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL,
    [Mtom] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginNew_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginNew_Imp]
(
    [Mdate] DATETIME NULL,
    [Party_Code] VARCHAR(12) NULL,
    [Spreadmargin] MONEY NULL,
    [Nonspreadmargin] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Mtom] MONEY NULL,
    [cl_type] VARCHAR(2) NULL,
    [DEL_MARGIN] NUMERIC(18, 4) NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [PEAKMARGIN] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMarginNew_IMP_bak_19042024
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMarginNew_IMP_bak_19042024]
(
    [Mdate] DATETIME NULL,
    [Party_Code] VARCHAR(12) NULL,
    [Spreadmargin] MONEY NULL,
    [Nonspreadmargin] MONEY NULL,
    [Totalmargin] MONEY NULL,
    [Mtom] MONEY NULL,
    [DEL_MARGIN] NUMERIC(18, 4) NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [PEAKMARGIN] NUMERIC(18, 4) NULL,
    [cl_type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_INTRADAY
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_INTRADAY]
(
    [FILECOUNTER] INT NOT NULL,
    [MDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(12) NOT NULL,
    [SPANMARGIN] NUMERIC(18, 4) NULL,
    [FILLER] NUMERIC(18, 4) NULL,
    [EXTREAMELOSSMARGIN] NUMERIC(18, 4) NULL,
    [DEL_MARGIN] NUMERIC(18, 4) NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [TOTALMARGIN] MONEY NULL,
    [CL_TYPE] VARCHAR(2) NULL,
    [UPLOADBY] VARCHAR(50) NULL,
    [UPLOAD_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_INTRADAY_BKUP_29APR2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_INTRADAY_BKUP_29APR2024]
(
    [FILECOUNTER] INT NOT NULL,
    [MDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [SPAN_MARGIN] MONEY NULL,
    [NET_BUY_PREMIUM] MONEY NULL,
    [EXTREME_LOSS_MARGIN] MONEY NULL,
    [MTOM_LOSS] MONEY NULL,
    [OTHER_MARGIN] MONEY NULL,
    [TOTAL_MARGIN] MONEY NULL,
    [CL_TYPE] VARCHAR(1) NULL,
    [UPLOADED_BY] VARCHAR(20) NULL,
    [UPLOADED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_INTRADAY_IMP_BKUP_29APR2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_INTRADAY_IMP_BKUP_29APR2024]
(
    [MDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [SPAN_MARGIN] MONEY NULL,
    [NET_BUY_PREMIUM] MONEY NULL,
    [EXTREME_LOSS_MARGIN] MONEY NULL,
    [MTOM_LOSS] MONEY NULL,
    [OTHER_MARGIN] MONEY NULL,
    [TOTAL_MARGIN] MONEY NULL,
    [CL_TYPE] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_PROV_INTRADAY
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_PROV_INTRADAY]
(
    [FILECOUNTER] INT NOT NULL,
    [MDATE] DATETIME NULL,
    [FILETIME] VARCHAR(20) NULL,
    [CMCODE] VARCHAR(12) NULL,
    [TMCODE] VARCHAR(12) NULL,
    [PARTY_CODE] VARCHAR(12) NULL,
    [INITIALMARGIN] MONEY NULL,
    [EXTREAMELOSSMARGIN] MONEY NULL,
    [NETBUYPREMIUM] MONEY NULL,
    [TOTALMARGIN] MONEY NULL,
    [UPLOADBY] VARCHAR(50) NULL,
    [UPLOAD_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMarginPercent
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMarginPercent]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Margin_Percent] NUMERIC(5, 2) NULL,
    [Interest_Percent] NUMERIC(5, 2) NULL,
    [Effective_DateFrom] DATETIME NULL,
    [Entry_Id] VARCHAR(25) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(25) NULL,
    [Modify_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(25) NULL,
    [Delete_Dt] DATETIME NULL,
    [Stat] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMg13PenaltyMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMg13PenaltyMaster]
(
    [EffectiveDate] SMALLDATETIME NULL,
    [Slab] INT NULL,
    [FromPenaltyPercentage] DECIMAL(18, 2) NULL,
    [ToPenaltyPercentage] DECIMAL(18, 2) NULL,
    [MinimumAmt] INT NULL,
    [Minimumpercentage] DECIMAL(18, 2) NULL,
    [chargeflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMg13Reference
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMg13Reference]
(
    [RefNo] INT NULL,
    [SubMenuRefno] INT NULL,
    [Subject] VARCHAR(50) NULL,
    [Heading] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoMG13Shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[FoMG13Shortage]
(
    [FileDate] SMALLDATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Batch_no] VARCHAR(10) NULL,
    [RefNo] INT NULL,
    [MarginRequirement] MONEY NULL,
    [MarginAvailable] MONEY NULL,
    [MarginReported] MONEY NULL,
    [ExchShort] MONEY NULL,
    [BrkShort] MONEY NULL,
    [BrkSlab] INT NULL,
    [ExchSlab] INT NULL,
    [BrkShortagePercentage] DECIMAL(18, 2) NULL,
    [BrkPenalty] MONEY NULL,
    [ExchShortagePercentage] DECIMAL(18, 2) NULL,
    [ExchPenalty] MONEY NULL,
    [Reserved1] VARCHAR(10) NULL,
    [Reserved2] VARCHAR(10) NULL,
    [Reserved3] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoNseNspMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[FoNseNspMargin]
(
    [Date] SMALLDATETIME NULL,
    [Inst_type] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [ExpiryDate] SMALLDATETIME NULL,
    [Valid_date] SMALLDATETIME NULL,
    [NonSpreadMargin] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foowner
-- --------------------------------------------------
CREATE TABLE [dbo].[foowner]
(
    [Company] VARCHAR(80) NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(15) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [ContNo] VARCHAR(8) NULL,
    [Style] INT NULL,
    [NSECODE] VARCHAR(20) NULL,
    [NSECMCODE] VARCHAR(20) NULL,
    [SEBINO] VARCHAR(20) NULL,
    [state] VARCHAR(50) NULL,
    [Email] VARCHAR(100) NULL,
    [FileDirPath] VARCHAR(20) NULL,
    [VB_RDO_CONNECTION] INT NULL,
    [Panno] VARCHAR(15) NULL,
    [FAX] VARCHAR(15) NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(30) NULL,
    [COMPLIANCE_MOBILE] VARCHAR(15) NULL,
    [BROKERSEBIREGNO] VARCHAR(30) NULL,
    [cin] VARCHAR(30) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL,
    [PARENTCODE_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foowner_BKUP_18MAR24
-- --------------------------------------------------
CREATE TABLE [dbo].[foowner_BKUP_18MAR24]
(
    [Company] VARCHAR(50) NOT NULL,
    [Addr1] VARCHAR(50) NULL,
    [Addr2] VARCHAR(50) NULL,
    [Phone] VARCHAR(25) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [ContNo] VARCHAR(8) NULL,
    [Style] INT NULL,
    [ContPrint_Party_Style] INT NULL,
    [Email] VARCHAR(50) NULL,
    [state] VARCHAR(50) NULL,
    [SebiNo] VARCHAR(20) NULL,
    [SMTP_SRV_NAME] VARCHAR(50) NULL,
    [PARENTCODE_FLAG] INT NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [COMPLIANCE_MOBILE] VARCHAR(15) NULL,
    [PANNO] VARCHAR(12) NULL,
    [BROKERSEBIREGNO] VARCHAR(15) NULL,
    [FAX] VARCHAR(25) NULL,
    [CIN] VARCHAR(30) NULL,
    [COMMONSEBINO] VARCHAR(150) NULL,
    [COMMONMEMBERCODE] VARCHAR(100) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [EXCHANGECODE] VARCHAR(15) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoRiskManagement_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[FoRiskManagement_tbl]
(
    [party_code] VARCHAR(15) NULL,
    [short_name] VARCHAR(100) NULL,
    [long_name] VARCHAR(100) NULL,
    [branch_cd] VARCHAR(20) NULL,
    [family] VARCHAR(20) NULL,
    [sub_broker] VARCHAR(20) NULL,
    [trader] VARCHAR(20) NULL,
    [customerexec] VARCHAR(30) NULL,
    [margindate] DATETIME NULL,
    [dailymtmamt] MONEY NULL,
    [finaldaymtmamt] MONEY NULL,
    [premiumamt] MONEY NULL,
    [exallocamt] MONEY NULL,
    [brokerage] MONEY NULL,
    [servicetax] MONEY NULL,
    [turntax] MONEY NULL,
    [sebitax] MONEY NULL,
    [insurancecharge] MONEY NULL,
    [stampduty] MONEY NULL,
    [othercharges] MONEY NULL,
    [expirybrokerage] MONEY NULL,
    [expiryservicetax] MONEY NULL,
    [cfbrokerage] MONEY NULL,
    [cfservicetax] MONEY NULL,
    [cfcharges] MONEY NULL,
    [clearingcharges] MONEY NULL,
    [billamount] MONEY NULL,
    [ledgeramount] MONEY NULL,
    [cash_coll] MONEY NULL,
    [noncash_coll] MONEY NULL,
    [effectivecoll] MONEY NULL,
    [haircutcash_coll] MONEY NULL,
    [haircutnoncash_coll] MONEY NULL,
    [totalfd] MONEY NULL,
    [totalbg] MONEY NULL,
    [totalsecurities] MONEY NULL,
    [initialmargin_MG13] MONEY NULL,
    [MTOMmargin_MG13] MONEY NULL,
    [spanmargin] MONEY NULL,
    [long_futuresexposure] MONEY NULL,
    [short_futuresexposure] MONEY NULL,
    [futuresexposure] MONEY NULL,
    [long_optionsexposure] MONEY NULL,
    [short_optionsexposure] MONEY NULL,
    [optionsexposure] MONEY NULL,
    [hedgeexposure] MONEY NULL,
    [optionsMTOM] MONEY NULL,
    [futuresturnover] MONEY NULL,
    [optionsturnover] MONEY NULL,
    [exallocturnover] MONEY NULL,
    [bsecm_exposure] MONEY NULL,
    [nsecm_exposure] MONEY NULL,
    [dummy1] MONEY NULL,
    [dummy2] VARCHAR(20) NULL,
    [lst_update_dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoRms_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[FoRms_TBL]
(
    [Party_Code] VARCHAR(15) NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Family] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [Trader] VARCHAR(20) NULL,
    [Customerexec] VARCHAR(100) NULL,
    [Margindate] DATETIME NOT NULL,
    [Dailymtmamt] MONEY NOT NULL,
    [Finaldaymtmamt] MONEY NOT NULL,
    [Premiumamt] MONEY NOT NULL,
    [Exallocamt] MONEY NOT NULL,
    [Brokerage] MONEY NOT NULL,
    [Servicetax] MONEY NOT NULL,
    [Turntax] MONEY NOT NULL,
    [Sebitax] MONEY NOT NULL,
    [Insurancecharge] MONEY NOT NULL,
    [Stampduty] MONEY NOT NULL,
    [Othercharges] MONEY NOT NULL,
    [Expirybrokerage] MONEY NOT NULL,
    [Expiryservicetax] MONEY NOT NULL,
    [Cfbrokerage] MONEY NOT NULL,
    [Cfservicetax] MONEY NOT NULL,
    [Cfcharges] MONEY NOT NULL,
    [Clearingcharges] MONEY NOT NULL,
    [Billamount] MONEY NOT NULL,
    [Ledgeramount] MONEY NOT NULL,
    [Cash_Coll] MONEY NOT NULL,
    [Noncash_Coll] MONEY NOT NULL,
    [Effectivecoll] MONEY NOT NULL,
    [Haircutcash_Coll] MONEY NOT NULL,
    [Haircutnoncash_Coll] MONEY NOT NULL,
    [Totalfd] MONEY NOT NULL,
    [Totalbg] MONEY NOT NULL,
    [Totalsecurities] MONEY NOT NULL,
    [Initialmargin_Mg13] MONEY NOT NULL,
    [Mtommargin_Mg13] MONEY NOT NULL,
    [Spanmargin] MONEY NOT NULL,
    [Long_Futuresexposure] MONEY NOT NULL,
    [Short_Futuresexposure] MONEY NOT NULL,
    [Futuresexposure] MONEY NOT NULL,
    [Long_Optionsexposure] MONEY NOT NULL,
    [Short_Optionsexposure] MONEY NOT NULL,
    [Optionsexposure] MONEY NOT NULL,
    [Hedgeexposure] MONEY NOT NULL,
    [Optionsmtom] MONEY NOT NULL,
    [Futuresturnover] MONEY NOT NULL,
    [Optionsturnover] MONEY NOT NULL,
    [Exallocturnover] MONEY NOT NULL,
    [Bsecm_Exposure] MONEY NOT NULL,
    [Nsecm_Exposure] MONEY NOT NULL,
    [Dummy1] MONEY NOT NULL,
    [Dummy2] VARCHAR(20) NULL,
    [Lst_Update_Dt] DATETIME NOT NULL,
    [mmargindate] VARCHAR(11) NULL,
    [finalimargin] MONEY NOT NULL,
    [finaltotal] MONEY NOT NULL,
    [TotMarginForReporting] MONEY NOT NULL,
    [MarginPer] MONEY NOT NULL,
    [finalspamargin] MONEY NOT NULL,
    [SrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoRms_TBL_Combine
-- --------------------------------------------------
CREATE TABLE [dbo].[FoRms_TBL_Combine]
(
    [Exchange] VARCHAR(3) NULL,
    [Party_Code] VARCHAR(15) NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Family] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [Trader] VARCHAR(20) NULL,
    [Customerexec] VARCHAR(100) NULL,
    [Margindate] DATETIME NOT NULL,
    [Dailymtmamt] MONEY NOT NULL,
    [Finaldaymtmamt] MONEY NOT NULL,
    [Premiumamt] MONEY NOT NULL,
    [Exallocamt] MONEY NOT NULL,
    [Brokerage] MONEY NOT NULL,
    [Servicetax] MONEY NOT NULL,
    [Turntax] MONEY NOT NULL,
    [Sebitax] MONEY NOT NULL,
    [Insurancecharge] MONEY NOT NULL,
    [Stampduty] MONEY NOT NULL,
    [Othercharges] MONEY NOT NULL,
    [Expirybrokerage] MONEY NOT NULL,
    [Expiryservicetax] MONEY NOT NULL,
    [Cfbrokerage] MONEY NOT NULL,
    [Cfservicetax] MONEY NOT NULL,
    [Cfcharges] MONEY NOT NULL,
    [Clearingcharges] MONEY NOT NULL,
    [Billamount] MONEY NOT NULL,
    [Ledgeramount] MONEY NOT NULL,
    [Cash_Coll] MONEY NOT NULL,
    [Noncash_Coll] MONEY NOT NULL,
    [Effectivecoll] MONEY NOT NULL,
    [Haircutcash_Coll] MONEY NOT NULL,
    [Haircutnoncash_Coll] MONEY NOT NULL,
    [Totalfd] MONEY NOT NULL,
    [Totalbg] MONEY NOT NULL,
    [Totalsecurities] MONEY NOT NULL,
    [Initialmargin_Mg13] MONEY NOT NULL,
    [Mtommargin_Mg13] MONEY NOT NULL,
    [Spanmargin] MONEY NOT NULL,
    [Long_Futuresexposure] MONEY NOT NULL,
    [Short_Futuresexposure] MONEY NOT NULL,
    [Futuresexposure] MONEY NOT NULL,
    [Long_Optionsexposure] MONEY NOT NULL,
    [Short_Optionsexposure] MONEY NOT NULL,
    [Optionsexposure] MONEY NOT NULL,
    [Hedgeexposure] MONEY NOT NULL,
    [Optionsmtom] MONEY NOT NULL,
    [Futuresturnover] MONEY NOT NULL,
    [Optionsturnover] MONEY NOT NULL,
    [Exallocturnover] MONEY NOT NULL,
    [Bsecm_Exposure] MONEY NOT NULL,
    [Nsecm_Exposure] MONEY NOT NULL,
    [Dummy1] MONEY NOT NULL,
    [Dummy2] VARCHAR(20) NULL,
    [Lst_Update_Dt] DATETIME NOT NULL,
    [mmargindate] VARCHAR(11) NULL,
    [finalimargin] MONEY NOT NULL,
    [finaltotal] MONEY NOT NULL,
    [TotMarginForReporting] MONEY NOT NULL,
    [MarginPer] MONEY NOT NULL,
    [finalspamargin] MONEY NOT NULL,
    [SrNo] INT NULL,
    [Payment] MONEY NULL,
    [Prv_long_futuresexposure] MONEY NULL,
    [Prv_short_futuresexposure] MONEY NULL,
    [Prv_long_optionsexposure] MONEY NULL,
    [Prv_short_optionsexposure] MONEY NULL,
    [exposuremtom] MONEY NULL,
    [OptBuyPrem] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP]
(
    [ContDate] DATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [PriceUnit] VARCHAR(20) NULL,
    [Qty_Unit] VARCHAR(10) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL,
    [RegularLot] MONEY NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [ExStartdate] SMALLDATETIME NULL,
    [ExEndDate] SMALLDATETIME NULL,
    [ExStyle] VARCHAR(1) NULL,
    [MarketType] VARCHAR(1) NULL,
    [OpenPrice] MONEY NOT NULL,
    [HighPrice] MONEY NOT NULL,
    [LowPrice] MONEY NOT NULL,
    [ClosePrice] MONEY NOT NULL,
    [SettlementPrice] MONEY NOT NULL,
    [C_U_Price] MONEY NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP_A_GROUP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP_A_GROUP]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(100) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [ADDED_BY] VARCHAR(30) NULL,
    [ADDED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP_BLK_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP_BLK_IMP]
(
    [COLUMN1] VARCHAR(12) NULL,
    [COLUMN2] VARCHAR(12) NULL,
    [COLUMN3] VARCHAR(12) NULL,
    [COLUMN4] VARCHAR(12) NULL,
    [COLUMN5] VARCHAR(12) NULL,
    [COLUMN6] VARCHAR(12) NULL,
    [COLUMN7] VARCHAR(12) NULL,
    [COLUMN8] VARCHAR(12) NULL,
    [COLUMN9] VARCHAR(12) NULL,
    [COLUMN10] VARCHAR(12) NULL,
    [COLUMN11] VARCHAR(12) NULL,
    [COLUMN12] VARCHAR(12) NULL,
    [COLUMN13] VARCHAR(12) NULL,
    [COLUMN14] VARCHAR(12) NULL,
    [COLUMN15] VARCHAR(12) NULL,
    [COLUMN16] VARCHAR(12) NULL,
    [COLUMN17] VARCHAR(12) NULL,
    [COLUMN18] VARCHAR(12) NULL,
    [COLUMN19] VARCHAR(12) NULL,
    [COLUMN20] VARCHAR(12) NULL,
    [COLUMN21] VARCHAR(12) NULL,
    [COLUMN22] VARCHAR(12) NULL,
    [COLUMN23] VARCHAR(12) NULL,
    [COLUMN24] VARCHAR(12) NULL,
    [COLUMN25] VARCHAR(12) NULL,
    [COLUMN26] VARCHAR(12) NULL,
    [COLUMN27] VARCHAR(12) NULL,
    [COLUMN28] VARCHAR(12) NULL,
    [COLUMN29] VARCHAR(12) NULL,
    [COLUMN30] VARCHAR(12) NULL,
    [COLUMN31] VARCHAR(12) NULL,
    [COLUMN32] VARCHAR(12) NULL,
    [COLUMN33] VARCHAR(12) NULL,
    [COLUMN34] VARCHAR(20) NULL,
    [COLUMN35] VARCHAR(20) NULL,
    [COLUMN36] VARCHAR(20) NULL,
    [COLUMN37] VARCHAR(20) NULL,
    [COLUMN38] VARCHAR(12) NULL,
    [COLUMN39] VARCHAR(12) NULL,
    [COLUMN40] VARCHAR(12) NULL,
    [COLUMN41] VARCHAR(12) NULL,
    [COLUMN42] VARCHAR(12) NULL,
    [COLUMN43] VARCHAR(12) NULL,
    [COLUMN44] VARCHAR(12) NULL,
    [COLUMN45] VARCHAR(12) NULL,
    [COLUMN46] VARCHAR(12) NULL,
    [COLUMN47] VARCHAR(12) NULL,
    [COLUMN48] VARCHAR(12) NULL,
    [COLUMN49] VARCHAR(12) NULL,
    [COLUMN50] VARCHAR(12) NULL,
    [COLUMN51] VARCHAR(12) NULL,
    [COLUMN52] VARCHAR(12) NULL,
    [COLUMN53] VARCHAR(12) NULL,
    [COLUMN54] VARCHAR(50) NULL,
    [COLUMN55] VARCHAR(12) NULL,
    [COLUMN56] VARCHAR(12) NULL,
    [COLUMN57] VARCHAR(12) NULL,
    [COLUMN58] VARCHAR(12) NULL,
    [COLUMN59] VARCHAR(12) NULL,
    [COLUMN60] VARCHAR(12) NULL,
    [COLUMN61] VARCHAR(12) NULL,
    [COLUMN62] VARCHAR(12) NULL,
    [COLUMN63] VARCHAR(12) NULL,
    [COLUMN64] VARCHAR(12) NULL,
    [COLUMN65] VARCHAR(12) NULL,
    [COLUMN66] VARCHAR(12) NULL,
    [COLUMN67] VARCHAR(12) NULL,
    [COLUMN68] VARCHAR(12) NULL,
    [COLUMN69] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoScrip_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[FoScrip_Imp]
(
    [CONTRACT_TOKEN_NO] NUMERIC(18, 0) NOT NULL,
    [ASSET_TOKEN_NO] NUMERIC(18, 0) NOT NULL,
    [CONTRACT_INSTRUMENT_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(10) NULL,
    [SERIES] VARCHAR(2) NULL,
    [FILLER1] VARCHAR(4) NULL,
    [EXPIRY_DATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [PRECISION] VARCHAR(1) NULL,
    [CORPORATE_ACTION_LEVEL] NUMERIC(18, 0) NULL,
    [FILLER2] VARCHAR(6) NULL,
    [ADMISSION_TYPE] NUMERIC(18, 0) NULL,
    [ISSUE_RATE] NUMERIC(18, 4) NULL,
    [TRD_STATUS_NRM] INT NULL,
    [ELG_NRM_MKT] INT NULL,
    [FILLER3] VARCHAR(6) NULL,
    [TRD_STATUS_ODD] INT NULL,
    [ELG_ODD_MKT] INT NULL,
    [FILLER4] VARCHAR(6) NULL,
    [TRD_STATUS_SPT] INT NULL,
    [ELG_SPT_MKT] INT NULL,
    [FILLER5] VARCHAR(6) NULL,
    [TRD_STATUS_AUC] INT NULL,
    [ELG_AUC_MKT] INT NULL,
    [FILLER6] VARCHAR(6) NULL,
    [ISSUE_START_DATE] DATETIME NULL,
    [ISSUE_SETTLE_DATE] DATETIME NULL,
    [CONTRACT_MATURITY_DATE] DATETIME NULL,
    [MARGIN_PERCENTAGE] NUMERIC(18, 4) NULL,
    [MINIMUM_LOT_SIZE] NUMERIC(18, 4) NULL,
    [BOARD_LOT_QUANTITY] NUMERIC(18, 4) NULL,
    [TICK_SIZE] NUMERIC(18, 4) NULL,
    [ISSUED_CAPITAL] NUMERIC(18, 4) NULL,
    [VOLUME_FREEZE_QUANTITY] NUMERIC(18, 4) NULL,
    [WARNING_QUANTITY] NUMERIC(18, 4) NULL,
    [ADMISSION_DATE] NUMERIC(18, 0) NULL,
    [EXPULSION_DATE] NUMERIC(18, 0) NULL,
    [RE_ADMISSION_DATE] NUMERIC(18, 0) NULL,
    [RECORD_DATE] NUMERIC(18, 0) NULL,
    [NO_DELIVERY_START_DATE] NUMERIC(18, 0) NULL,
    [NO_DELIVERY_END_DATE] NUMERIC(18, 0) NULL,
    [OPT_RANGE_LOW_PRICE] NUMERIC(18, 4) NULL,
    [OPT_RANGE_HIGH_PRICE] NUMERIC(18, 4) NULL,
    [EX_DATE] NUMERIC(18, 0) NULL,
    [BOOK_CLOSURE_START_DATE] NUMERIC(18, 0) NULL,
    [BOOK_CLOSURE_END_DATE] NUMERIC(18, 0) NULL,
    [UPDATE_DATE_AND_TIME] NUMERIC(18, 0) NULL,
    [EXERCISE_START_DATE] NUMERIC(18, 0) NULL,
    [EXERCISE_END_DATE] NUMERIC(18, 0) NULL,
    [TICKER_SELECTION] NUMERIC(18, 0) NULL,
    [QUANTITY_MULTIPLIER] NUMERIC(18, 0) NULL,
    [QUALITY_SPECS] VARCHAR(12) NULL,
    [STOCK_NAME] VARCHAR(26) NULL,
    [CP_AGM] NUMERIC(18, 0) NULL,
    [CP_DIV] NUMERIC(18, 0) NULL,
    [CP_BONUS] NUMERIC(18, 0) NULL,
    [SPECIAL_TERM] NUMERIC(18, 0) NULL,
    [COMM_SPEC] VARCHAR(26) NULL,
    [EXERCISE_STYLE] VARCHAR(1) NULL,
    [EXERCISE_ALLOWED] VARCHAR(1) NULL,
    [EXERCISE_REJECTION_ALLOWED] VARCHAR(1) NULL,
    [POSITION_LIQUI_ALLOWED] VARCHAR(1) NULL,
    [CHECK_SUM] VARCHAR(1) NULL,
    [CA_ADJUSTED] VARCHAR(1) NULL,
    [UDLN_ASSET_SYMBOL] VARCHAR(12) NULL,
    [ASSET_INSTRUMENT] VARCHAR(6) NULL,
    [BASE_PRICE] NUMERIC(18, 4) NULL,
    [DELETE_FLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP1
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP1]
(
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoScrip1_BKUP_18Mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FoScrip1_BKUP_18Mar2024]
(
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP1_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP1_IMP]
(
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP2
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP2]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [C_Regular_Lot] INT NULL,
    [C_Issue_Mat_Dt] SMALLDATETIME NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL,
    [PriceUnit] VARCHAR(20) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Qty_Unit] VARCHAR(10) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL,
    [P_Key] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoScrip2_BKUP_18Mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[FoScrip2_BKUP_18Mar2024]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [C_Regular_Lot] INT NULL,
    [C_Issue_Mat_Dt] SMALLDATETIME NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL,
    [PriceUnit] VARCHAR(20) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Qty_Unit] VARCHAR(10) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL,
    [P_Key] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP2_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP2_IMP]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [C_Regular_Lot] INT NULL,
    [C_Issue_Mat_Dt] SMALLDATETIME NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL,
    [PriceUnit] VARCHAR(20) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Qty_Unit] VARCHAR(10) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP3
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP3]
(
    [P_Key] INT IDENTITY(1,1) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [Option_Type] VARCHAR(2) NULL,
    [TickSize] INT NULL,
    [Del_Numerator] INT NULL,
    [Del_Denominator] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoScripBrokerage
-- --------------------------------------------------
CREATE TABLE [dbo].[FoScripBrokerage]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Brok_Scheme] TINYINT NULL,
    [Trd_Del] CHAR(1) NULL,
    [Table_No] INT NOT NULL,
    [FinalTable_No] INT NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [EnteredBy] VARCHAR(20) NULL,
    [EnteredDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[fosett_mst]
(
    [Exchange] CHAR(5) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] VARCHAR(12) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Start_date] SMALLDATETIME NULL,
    [expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Funds_Payin] SMALLDATETIME NULL,
    [Funds_Payout] SMALLDATETIME NULL,
    [Sec_Payin] SMALLDATETIME NULL,
    [Sec_Payout] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [maturitydate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoSettcorpact
-- --------------------------------------------------
CREATE TABLE [dbo].[FoSettcorpact]
(
    [Contractno] VARCHAR(14) NOT NULL,
    [Billno] VARCHAR(10) NULL,
    [Trade_No] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_Name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Pro_Cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [Auctionpart] VARCHAR(2) NULL,
    [Markettype] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_No] VARCHAR(15) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_Perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_Puc] MONEY NULL,
    [Day_Sales] MONEY NULL,
    [Sett_Purch] MONEY NULL,
    [Sett_Sales] MONEY NULL,
    [Sell_Buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [Netrate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Service_Tax] MONEY NULL,
    [Trade_Amount] MONEY NULL,
    [Billflag] INT NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Nbrokapp] MONEY NULL,
    [Nsertax] MONEY NULL,
    [N_Netrate] DECIMAL(15, 7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [Participantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [Cpid] INT NULL,
    [Instrument] INT NULL,
    [Booktype] VARCHAR(5) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Tmark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] INT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSETTLEMENT_BAK_1408
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSETTLEMENT_BAK_1408]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] INT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSETTLEMENT_BAK_15082024
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSETTLEMENT_BAK_15082024]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] INT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement_BKUP_18Mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement_BKUP_18Mar2024]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] INT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoSettlement_Inst
-- --------------------------------------------------
CREATE TABLE [dbo].[FoSettlement_Inst]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Order_no] VARCHAR(20) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Sell_Buy] INT NULL,
    [Tradeqty] INT NULL,
    [Price] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement_test
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement_test]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] INT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] MONEY NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlementexpiry
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlementexpiry]
(
    [SrNo] INT NULL,
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(50) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] MONEY NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] INT NULL,
    [Instrument] INT NULL,
    [BookType] MONEY NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoSpanMarginNew
-- --------------------------------------------------
CREATE TABLE [dbo].[FoSpanMarginNew]
(
    [Party_Code] VARCHAR(12) NOT NULL,
    [SpanMargin] MONEY NULL,
    [premium] MONEY NULL,
    [TotalMargin] MONEY NULL,
    [Pmarginrate] DECIMAL(18, 0) NULL,
    [Mdate] DATETIME NULL,
    [Newspanmargin] MONEY NULL,
    [Finaltotalmargin] MONEY NULL,
    [Cl_Type] VARCHAR(2) NULL,
    [MtoM] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSPANRECORD
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSPANRECORD]
(
    [party_code] VARCHAR(10) NOT NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [expirydate] SMALLDATETIME NULL,
    [pqty] INT NULL,
    [sqty] INT NULL,
    [strike_price] MONEY NULL,
    [option_type] VARCHAR(2) NULL,
    [sauda_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fostat_trd
-- --------------------------------------------------
CREATE TABLE [dbo].[fostat_trd]
(
    [actioncode] VARCHAR(3) NULL,
    [sysdate] SMALLDATETIME NULL,
    [filedate] SMALLDATETIME NULL,
    [com_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTaxes]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] NVARCHAR(3) NULL,
    [Insurance_Chrg] DECIMAL(5, 4) NULL,
    [Turnover_tax] DECIMAL(5, 4) NULL,
    [Other_chrg] DECIMAL(5, 4) NULL,
    [Sebiturn_tax] DECIMAL(5, 4) NULL,
    [Broker_note] DECIMAL(6, 4) NULL,
    [From_date] SMALLDATETIME NULL,
    [Demat_Insure] DECIMAL(3, 2) NULL,
    [To_date] SMALLDATETIME NULL,
    [Inst_Type] NVARCHAR(6) NULL,
    [Symbol] NVARCHAR(12) NULL,
    [Sales_Tax] MONEY NULL,
    [State] NVARCHAR(6) NULL,
    [Unit] MONEY NULL,
    [Basis] NVARCHAR(5) NULL,
    [Created_By] NVARCHAR(25) NULL,
    [Created_On] SMALLDATETIME NULL,
    [Modified_By] NVARCHAR(25) NULL,
    [Modified_On] SMALLDATETIME NULL,
    [DELIVERY_CHRG] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fotmclchrg
-- --------------------------------------------------
CREATE TABLE [dbo].[fotmclchrg]
(
    [Party_code] VARCHAR(10) NULL,
    [orderno] VARCHAR(15) NULL,
    [Sauda_date] DATETIME NULL,
    [Clearingcharges] MONEY NULL,
    [dummy1] TINYINT NULL,
    [dummy2] VARCHAR(15) NULL,
    [trade_no] VARCHAR(20) NULL,
    [sell_buy] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foTMinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[foTMinfo]
(
    [TM_Code] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Short_Name] VARCHAR(20) NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Add1] VARCHAR(50) NULL,
    [Add2] VARCHAR(50) NULL,
    [PhoneNo] VARCHAR(15) NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [ClFeePerval] MONEY NULL,
    [Rounding] INT NULL,
    [MtoM] DECIMAL(18, 0) NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADE]
(
    [Trade_No] VARCHAR(20) NOT NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(50) NULL,
    [BookType] NUMERIC(18, 0) NULL,
    [BookTypeName] NUMERIC(18, 0) NULL,
    [MarKetType] VARCHAR(10) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [Opp_Broker_Id] VARCHAR(20) NULL,
    [settflag] INT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL,
    [reserved1] MONEY NULL,
    [reserved2] VARCHAR(20) NULL,
    [reserved3] VARCHAR(10) NULL,
    [reserved4] VARCHAR(10) NULL,
    [reserved5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADE_CTCLID
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADE_CTCLID]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(20) NULL,
    [IMPORTED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADE_CTCLID_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADE_CTCLID_TMP]
(
    [SAUDA_DATE] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTradeMissing
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTradeMissing]
(
    [Trade_No] VARCHAR(20) NOT NULL,
    [Status] VARCHAR(3) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [BookType] MONEY NULL,
    [BookTypeName] MONEY NULL,
    [MarKetType] MONEY NULL,
    [User_Id] VARCHAR(15) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Sell_Buy] INT NULL,
    [TradeQty] INT NULL,
    [Price] MONEY NULL,
    [Pro_cli] INT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(50) NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [ActivityTime] DATETIME NULL,
    [Last_Mod_time] DATETIME NULL,
    [Order_No] VARCHAR(20) NULL,
    [Opp_Broker_Id] VARCHAR(5) NULL,
    [settflag] INT NULL,
    [membercode] VARCHAR(10) NULL,
    [tmpartycode] VARCHAR(10) NULL,
    [reserved1] VARCHAR(10) NULL,
    [reserved2] VARCHAR(20) NULL,
    [reserved3] VARCHAR(10) NULL,
    [reserved4] VARCHAR(10) NULL,
    [reserved5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_BrokTable
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_BrokTable]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(18, 4) NULL,
    [Day_Sales] NUMERIC(18, 4) NULL,
    [Sett_Purch] NUMERIC(18, 4) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(18, 4) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_Client1
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_Client1]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Short_Name] VARCHAR(21) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(100) NULL,
    [L_Address2] VARCHAR(100) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NULL,
    [Cl_Status] VARCHAR(3) NULL,
    [Gl_Code] VARCHAR(20) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(100) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [trader] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(20) NULL,
    [ClRating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_Client2
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_Client2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] DECIMAL(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] DECIMAL(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(16) NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] SMALLINT NULL,
    [AlbmCF_tableno] INT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_ClientBrokScheme
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_ClientBrokScheme]
(
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_BrokTable] INT NULL,
    [Opt_BrokTable] INT NULL,
    [Fut_Exp_BrokTable] INT NULL,
    [Opt_Exc_BrokTable] INT NULL,
    [Comm_Del_BrokTable] INT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Opt_Brok_ComputeOn] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_ClientTaxes
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_ClientTaxes]
(
    [Party_Code] VARCHAR(10) NULL,
    [Date_From] DATETIME NULL,
    [Date_To] DATETIME NULL,
    [Fut_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Fut_Other_Chrg] DECIMAL(18, 5) NULL,
    [Fut_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Fut_Broker_Note] DECIMAL(18, 5) NULL,
    [Opt_Insurance_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Turnover_Tax] DECIMAL(18, 5) NULL,
    [Opt_Other_Chrg] DECIMAL(18, 5) NULL,
    [Opt_Sebiturn_Tax] DECIMAL(18, 5) NULL,
    [Opt_Broker_Note] DECIMAL(18, 5) NULL,
    [Round_To] DECIMAL(18, 0) NULL,
    [RoFig] INT NULL,
    [ErrNum] NUMERIC(18, 9) NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_ContractNo
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_ContractNo]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Order_No] VARCHAR(15) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [InsCont] CHAR(1) NULL,
    [Sell_Buy] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_FoScrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_FoScrip1]
(
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoTrd_FoScrip2
-- --------------------------------------------------
CREATE TABLE [dbo].[FoTrd_FoScrip2]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [C_Regular_Lot] INT NULL,
    [C_Issue_Mat_Dt] SMALLDATETIME NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMP_FilePath
-- --------------------------------------------------
CREATE TABLE [dbo].[IMP_FilePath]
(
    [File_Type] VARCHAR(20) NULL,
    [File_Path] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Inst_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Inst_Log]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_Party_Code] VARCHAR(10) NULL,
    [Sauda_Date] DATETIME NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Order_No] VARCHAR(20) NULL,
    [Trade_No] VARCHAR(20) NULL,
    [Sell_Buy] VARCHAR(1) NULL,
    [Contract_No] VARCHAR(20) NULL,
    [New_Contract_No] VARCHAR(20) NULL,
    [Brokerage] NUMERIC(18, 4) NULL,
    [New_Brokerage] NUMERIC(18, 4) NULL,
    [Market_Rate] NUMERIC(18, 4) NULL,
    [New_Market_Rate] NUMERIC(18, 4) NULL,
    [Net_Rate] NUMERIC(18, 4) NULL,
    [New_net_rate] NUMERIC(18, 4) NULL,
    [Qty] BIGINT NULL,
    [New_Qty] BIGINT NULL,
    [RoundTo] INT NULL,
    [Participant_Code] VARCHAR(20) NULL,
    [New_Participant_Code] VARCHAR(20) NULL,
    [UserName] VARCHAR(25) NULL,
    [Module] VARCHAR(50) NULL,
    [Called_From] VARCHAR(100) NULL,
    [TimeStamp] DATETIME NULL,
    [ExtraField3] VARCHAR(10) NULL,
    [ExtraField4] VARCHAR(1) NULL,
    [ExtraField5] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.instclient_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[instclient_tbl]
(
    [PartyCode] CHAR(10) NULL,
    [marketrate] CHAR(1) NULL,
    [brokerage] CHAR(1) NULL,
    [netrate] CHAR(1) NULL,
    [noc] INT NULL,
    [res1] VARCHAR(10) NULL,
    [res2] VARCHAR(10) NULL,
    [res3] VARCHAR(10) NULL,
    [res4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Kyc_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Kyc_Master]
(
    [Doc_Cd] VARCHAR(8) NOT NULL,
    [Ctgry_Code] VARCHAR(8) NOT NULL,
    [Group_Code] VARCHAR(8) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Received_Dt] DATETIME NULL,
    [Entry_Id] VARCHAR(20) NOT NULL,
    [Entry_Dt] DATETIME NOT NULL,
    [Modify_Id] VARCHAR(20) NULL,
    [Modify_Dt] DATETIME NULL,
    [Auth_Id] VARCHAR(20) NULL,
    [Auth_Dt] DATETIME NULL,
    [Delete_Id] VARCHAR(20) NULL,
    [Delete_Dt] DATETIME NULL,
    [Remarks] VARCHAR(100) NULL,
    [Status] CHAR(1) NULL,
    [Doc_Completed] CHAR(1) NULL,
    [Exchange] VARCHAR(3) NULL,
    [segment] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_DETAILS_DAS]
(
    [LEDDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [LEDDD_SAUDA_DATE] DATETIME NULL,
    [LEDDD_OPENING_BAL] MONEY NULL,
    [LEDDD_CHQ_REC] MONEY NULL,
    [LEDDD_CHQ_PAY] MONEY NULL,
    [LEDDD_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_BAL] MONEY NULL,
    [LEDDD_CASH_MARGIN] MONEY NULL,
    [LEDDD_OPENING_INIT_MARGIN] MONEY NULL,
    [LEDDD_MRG_REC] MONEY NULL,
    [LEDDD_MRG_REPAY] MONEY NULL,
    [LEDDD_MRG_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_INIT_MARGIN] MONEY NULL,
    [LEDDD_NONCASH_COLL_HC] MONEY NULL,
    [LEDDD_INIT_EXPO_MARGIN] MONEY NULL,
    [LEDDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [LEDDD_CREATED_DT] DATETIME NOT NULL,
    [LEDDD_FT_D] MONEY NULL,
    [LEDDD_FT_C] MONEY NULL,
    [LEDDD_MRG_FT] MONEY NULL,
    [LEDDD_RUNNINGBAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[LOG_PWDMAILS]
(
    [FLDID] INT NOT NULL,
    [FLDSTNAME] VARCHAR(10) NOT NULL,
    [FLDUSERNAME] VARCHAR(20) NOT NULL,
    [PAN_GIR_NO] VARCHAR(20) NOT NULL,
    [DOB] VARCHAR(10) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [IP_ADDR] VARCHAR(20) NOT NULL,
    [MAC_ID] VARCHAR(25) NOT NULL,
    [ERROR_DESC] VARCHAR(100) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL,
    [EMAIL_SENT_STAT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Login_Exp
-- --------------------------------------------------
CREATE TABLE [dbo].[Login_Exp]
(
    [Exp_Period_Type] CHAR(2) NULL,
    [Exp_Period] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marketsegment
-- --------------------------------------------------
CREATE TABLE [dbo].[marketsegment]
(
    [MarketDesc] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mg13batchno_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[mg13batchno_tbl]
(
    [filedate] SMALLDATETIME NULL,
    [batchno] INT NULL,
    [rejected] VARCHAR(5) NULL,
    [reserved1] INT NULL,
    [reserverd2] INT NULL,
    [reserved3] INT NULL,
    [Validate_Fld] VARCHAR(50) NULL,
    [Last_Update_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICLTID
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICLTID]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [CLTDPNO] VARCHAR(16) NOT NULL,
    [DPID] VARCHAR(16) NOT NULL,
    [INTRODUCER] VARCHAR(100) NULL,
    [DPTYPE] VARCHAR(4) NULL,
    [DEF] INT NULL,
    [DDPIFLAG] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MultiCltLog
-- --------------------------------------------------
CREATE TABLE [dbo].[MultiCltLog]
(
    [Party_Code] VARCHAR(10) NULL,
    [OCltDpId] VARCHAR(16) NULL,
    [ODpId] VARCHAR(8) NULL,
    [OPOA] INT NULL,
    [NCltDpID] VARCHAR(16) NULL,
    [NDpId] VARCHAR(8) NULL,
    [NPOA] INT NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedDate] DATETIME NULL,
    [RecordFrom] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multicompany
-- --------------------------------------------------
CREATE TABLE [dbo].[multicompany]
(
    [CompanyName] VARCHAR(35) NULL,
    [Exchange] CHAR(3) NULL,
    [ShareDB] VARCHAR(12) NULL,
    [AccountDB] VARCHAR(12) NULL,
    [DefaultClient] INT NULL,
    [segment] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIISIN
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIISIN]
(
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] CHAR(2) NULL,
    [Isin] VARCHAR(20) NULL,
    [Valid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MultiISIN_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[MultiISIN_Imp]
(
    [Dummy1] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [SecName] VARCHAR(50) NULL,
    [SecDetail] VARCHAR(120) NULL,
    [Dummy2] VARCHAR(10) NULL,
    [Addr1] VARCHAR(100) NULL,
    [Addr2] VARCHAR(100) NULL,
    [Addr3] VARCHAR(100) NULL,
    [Addr4] VARCHAR(100) NULL,
    [City] VARCHAR(50) NULL,
    [State] VARCHAR(100) NULL,
    [Country] VARCHAR(20) NULL,
    [Zip] VARCHAR(10) NULL,
    [Phone1] VARCHAR(20) NULL,
    [Phone2] VARCHAR(20) NULL,
    [Phone3] VARCHAR(20) NULL,
    [Email] VARCHAR(100) NULL,
    [ContactPerson] VARCHAR(100) NULL,
    [Designation] VARCHAR(50) NULL,
    [WAddr1] VARCHAR(100) NULL,
    [WAddr2] VARCHAR(100) NULL,
    [WAddr3] VARCHAR(100) NULL,
    [WCity] VARCHAR(50) NULL,
    [WState] VARCHAR(100) NULL,
    [WCountry] VARCHAR(20) NULL,
    [WZip] VARCHAR(10) NULL,
    [WPhone1] VARCHAR(20) NULL,
    [WPhone2] VARCHAR(20) NULL,
    [WPhone3] VARCHAR(20) NULL,
    [Dummy3] VARCHAR(100) NULL,
    [Dummy4] VARCHAR(10) NULL,
    [RegName] VARCHAR(120) NULL,
    [Dummy5] VARCHAR(10) NULL,
    [Dummy6] VARCHAR(10) NULL,
    [RAddr1] VARCHAR(100) NULL,
    [RAddr2] VARCHAR(100) NULL,
    [RAddr3] VARCHAR(100) NULL,
    [RCity] VARCHAR(50) NULL,
    [RState] VARCHAR(100) NULL,
    [RCountry] VARCHAR(20) NULL,
    [RZip] VARCHAR(10) NULL,
    [RPhone1] VARCHAR(20) NULL,
    [RPhone2] VARCHAR(20) NULL,
    [RPhone3] VARCHAR(20) NULL,
    [REmail] VARCHAR(100) NULL,
    [RegDetail] VARCHAR(120) NULL,
    [Dummy7] VARCHAR(20) NULL,
    [Dummy8] VARCHAR(20) NULL,
    [TAddr1] VARCHAR(100) NULL,
    [TAddr2] VARCHAR(100) NULL,
    [TAddr3] VARCHAR(100) NULL,
    [TCity] VARCHAR(50) NULL,
    [TState] VARCHAR(100) NULL,
    [TCountry] VARCHAR(20) NULL,
    [TZip] VARCHAR(10) NULL,
    [TPhone1] VARCHAR(20) NULL,
    [TPhone2] VARCHAR(20) NULL,
    [TPhone3] VARCHAR(20) NULL,
    [TEmail] VARCHAR(100) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [CommType1] VARCHAR(50) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [CommType2] VARCHAR(50) NULL,
    [Status1] VARCHAR(10) NULL,
    [Status2] VARCHAR(20) NULL,
    [Dummy11] VARCHAR(10) NULL,
    [Dummy12] VARCHAR(10) NULL,
    [Date1] DATETIME NULL,
    [Dummy13] VARCHAR(10) NULL,
    [Dummy14] VARCHAR(10) NULL,
    [Dummy15] VARCHAR(10) NULL,
    [Dummy16] VARCHAR(10) NULL,
    [Dummy17] VARCHAR(10) NULL,
    [Date2] DATETIME NULL,
    [Dummy18] VARCHAR(10) NULL,
    [Date3] DATETIME NULL,
    [Date4] DATETIME NULL,
    [Dummy19] VARCHAR(10) NULL,
    [Dummy20] VARCHAR(10) NULL,
    [Dummy21] VARCHAR(10) NULL,
    [Dummy22] VARCHAR(50) NULL,
    [Dummy23] VARCHAR(50) NULL,
    [Dummy24] VARCHAR(50) NULL,
    [Dummy25] VARCHAR(50) NULL,
    [Dummy26] VARCHAR(120) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nce_aws_digital_bill
-- --------------------------------------------------
CREATE TABLE [dbo].[nce_aws_digital_bill]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [OrgSymbol] VARCHAR(12) NULL,
    [Symbol] VARCHAR(18) NULL,
    [expirydate] VARCHAR(11) NULL,
    [option_type] VARCHAR(2) NULL,
    [strike_price] MONEY NULL,
    [cl_rate] MONEY NULL,
    [pqty] INT NULL,
    [sqty] INT NULL,
    [prate] MONEY NULL,
    [srate] MONEY NULL,
    [billno] VARCHAR(10) NULL,
    [SAUDA_DATE] VARCHAR(11) NULL,
    [pamt] MONEY NULL,
    [samt] MONEY NULL,
    [service_tax] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [turn_tax] MONEY NULL,
    [broker_note] MONEY NULL,
    [Insurance_Chrg] MONEY NULL,
    [other_chrg] MONEY NULL,
    [TradeType] INT NOT NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [TotBrok] MONEY NULL,
    [Party_NameToPrint] VARCHAR(32) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NOT NULL,
    [L_Address3] VARCHAR(40) NOT NULL,
    [L_city] VARCHAR(40) NOT NULL,
    [L_Zip] VARCHAR(10) NOT NULL,
    [pan_gir_no] VARCHAR(50) NOT NULL,
    [Res_Phone1] VARCHAR(15) NOT NULL,
    [Off_Phone1] VARCHAR(15) NOT NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [pcode] CHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEW_SCHEME_add
-- --------------------------------------------------
CREATE TABLE [dbo].[NEW_SCHEME_add]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [A] VARCHAR(1) NOT NULL,
    [B] VARCHAR(3) NOT NULL,
    [V] VARCHAR(3) NOT NULL,
    [E] NUMERIC(18, 0) NULL,
    [SM_Trd_Type] VARCHAR(3) NOT NULL,
    [SR] INT NOT NULL,
    [SM_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Buy_Brok_Type] CHAR(1) NOT NULL,
    [SM_Sell_Brok_Type] CHAR(10) NOT NULL,
    [SM_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Multiplier] VARCHAR(6) NOT NULL,
    [SM_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Value_From] NUMERIC(18, 4) NOT NULL,
    [SM_Value_To] NUMERIC(18, 4) NOT NULL,
    [SM_TurnOverOn] VARCHAR(7) NOT NULL,
    [SM_ComputationOn] CHAR(1) NOT NULL,
    [SM_ComputationType] CHAR(1) NOT NULL,
    [MIN_BROK] NUMERIC(18, 9) NULL,
    [MAX_BROK] NUMERIC(18, 9) NULL,
    [S] VARCHAR(6) NOT NULL,
    [T] VARCHAR(7) NOT NULL,
    [ERE] VARCHAR(11) NULL,
    [U] VARCHAR(23) NOT NULL,
    [VX] VARCHAR(20) NULL,
    [RE] DATETIME NOT NULL,
    [Z] VARCHAR(1) NOT NULL,
    [R] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PartyMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[PartyMapping]
(
    [OldParty_Code] VARCHAR(10) NULL,
    [NewParty_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PRE_OFFERS
-- --------------------------------------------------
CREATE TABLE [dbo].[PRE_OFFERS]
(
    [party_code] VARCHAR(50) NOT NULL,
    [start_date] DATE NOT NULL,
    [end_date] DATE NOT NULL,
    [offer_amount_limit] NUMERIC(18, 4) NOT NULL,
    [brokerage_order_count_limit] INT NOT NULL,
    [product] VARCHAR(50) NOT NULL,
    [type_of_voucher] VARCHAR(50) NOT NULL,
    [offer_compaign_id] VARCHAR(50) NOT NULL,
    [mtf_days_applicable] INT NOT NULL,
    [mtf_max_amount] INT NOT NULL,
    [priority] INT NULL,
    [OFFER_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rating
-- --------------------------------------------------
CREATE TABLE [dbo].[rating]
(
    [Rating] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Remissor_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Remissor_Master]
(
    [Row_Id] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [RemCode] VARCHAR(10) NOT NULL,
    [SharingType] VARCHAR(1) NOT NULL,
    [TransType] VARCHAR(3) NOT NULL,
    [Val_Per] VARCHAR(1) NOT NULL,
    [Sharing] NUMERIC(18, 4) NOT NULL,
    [Charges] NUMERIC(18, 4) NOT NULL,
    [LowerLimit] NUMERIC(18, 2) NOT NULL,
    [UpperLimit] NUMERIC(18, 2) NOT NULL,
    [FromDate] DATETIME NOT NULL,
    [ToDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Remissor_Trans_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Remissor_Trans_Temp]
(
    [Sauda_Date] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [RemCode] VARCHAR(10) NOT NULL,
    [Branch_Cd] VARCHAR(10) NOT NULL,
    [ClientTrdBrokerage] NUMERIC(18, 2) NOT NULL,
    [ClientDelBrokerage] NUMERIC(18, 2) NOT NULL,
    [TrdTurnOver] NUMERIC(18, 4) NOT NULL,
    [DelTurnOver] NUMERIC(18, 2) NOT NULL,
    [RemShareBrokerage] NUMERIC(18, 2) NOT NULL,
    [SharingType] VARCHAR(1) NOT NULL,
    [Sharing] NUMERIC(18, 4) NOT NULL,
    [TransType] VARCHAR(3) NOT NULL,
    [Charges] NUMERIC(18, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RMFFEES_Exception
-- --------------------------------------------------
CREATE TABLE [dbo].[RMFFEES_Exception]
(
    [Inst_Type] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [EffDate_From] DATETIME NULL,
    [EffDate_To] DATETIME NULL,
    [Min_TurnOver] MONEY NULL,
    [TAX_PERC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.roundparam
-- --------------------------------------------------
CREATE TABLE [dbo].[roundparam]
(
    [RoundStyle] SMALLINT NULL,
    [Description] CHAR(25) NULL,
    [Round_to] SMALLINT NULL,
    [RoFig] SMALLINT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] SMALLINT NULL,
    [RoundMarketrate] TINYINT NULL,
    [RoundBrokerage] TINYINT NULL,
    [RoundNetrate] TINYINT NULL,
    [OtherRound] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Mapping]
(
    [SP_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SP_Party_Code] VARCHAR(10) NOT NULL,
    [SP_Computation_Level] CHAR(1) NOT NULL,
    [SP_Inst_Type] VARCHAR(3) NOT NULL,
    [SP_Scrip] VARCHAR(12) NOT NULL,
    [SP_Scheme_Id] INT NOT NULL,
    [SP_Trd_Type] VARCHAR(3) NOT NULL,
    [SP_Scheme_Type] CHAR(1) NOT NULL,
    [SP_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Buy_Brok_Type] CHAR(1) NULL,
    [SP_Sell_Brok_Type] CHAR(1) NULL,
    [SP_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Sell_Brok] NUMERIC(18, 4) NULL,
    [SP_Value_From] NUMERIC(18, 4) NOT NULL,
    [SP_Value_To] NUMERIC(18, 4) NOT NULL,
    [SP_TurnOverOn] VARCHAR(7) NOT NULL,
    [SP_Brok_ComputeOn] CHAR(1) NOT NULL,
    [SP_Brok_ComputeType] CHAR(1) NOT NULL,
    [SP_Min_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Min_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Date_From] DATETIME NOT NULL,
    [SP_Date_To] DATETIME NOT NULL,
    [SP_CreatedBy] VARCHAR(20) NOT NULL,
    [SP_CreatedOn] DATETIME NOT NULL,
    [SP_ModifiedBy] VARCHAR(20) NOT NULL,
    [SP_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCHEME_MAPPING_BKP_AFTER_16OCT2024
-- --------------------------------------------------
CREATE TABLE [dbo].[SCHEME_MAPPING_BKP_AFTER_16OCT2024]
(
    [SP_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SP_Party_Code] VARCHAR(10) NOT NULL,
    [SP_Computation_Level] CHAR(1) NOT NULL,
    [SP_Inst_Type] VARCHAR(3) NOT NULL,
    [SP_Scrip] VARCHAR(12) NOT NULL,
    [SP_Scheme_Id] INT NOT NULL,
    [SP_Trd_Type] VARCHAR(3) NOT NULL,
    [SP_Scheme_Type] CHAR(1) NOT NULL,
    [SP_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Buy_Brok_Type] CHAR(1) NULL,
    [SP_Sell_Brok_Type] CHAR(1) NULL,
    [SP_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SP_Res_Sell_Brok] NUMERIC(18, 4) NULL,
    [SP_Value_From] NUMERIC(18, 4) NOT NULL,
    [SP_Value_To] NUMERIC(18, 4) NOT NULL,
    [SP_TurnOverOn] VARCHAR(7) NOT NULL,
    [SP_Brok_ComputeOn] CHAR(1) NOT NULL,
    [SP_Brok_ComputeType] CHAR(1) NOT NULL,
    [SP_Min_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_BrokAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Min_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Max_ScripAmt] NUMERIC(18, 4) NOT NULL,
    [SP_Date_From] DATETIME NOT NULL,
    [SP_Date_To] DATETIME NOT NULL,
    [SP_CreatedBy] VARCHAR(20) NOT NULL,
    [SP_CreatedOn] DATETIME NOT NULL,
    [SP_ModifiedBy] VARCHAR(20) NOT NULL,
    [SP_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scheme_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Scheme_Master]
(
    [SM_SrNo] INT IDENTITY(1,1) NOT NULL,
    [SM_Scheme_Id] INT NOT NULL,
    [SM_Scheme_Desc] VARCHAR(50) NULL,
    [SM_Trd_Type] VARCHAR(3) NOT NULL,
    [SM_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Buy_Brok_Type] CHAR(1) NOT NULL,
    [SM_Sell_Brok_Type] CHAR(10) NOT NULL,
    [SM_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Multiplier] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Buy_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Res_Sell_Brok] NUMERIC(18, 4) NOT NULL,
    [SM_Value_From] NUMERIC(18, 4) NOT NULL,
    [SM_Value_To] NUMERIC(18, 4) NOT NULL,
    [SM_TurnOverOn] VARCHAR(7) NOT NULL,
    [SM_ComputationOn] CHAR(1) NOT NULL,
    [SM_ComputationType] CHAR(1) NOT NULL,
    [SM_CreatedBy] VARCHAR(20) NOT NULL,
    [SM_CreatedOn] DATETIME NOT NULL,
    [SM_ModifiedBy] VARCHAR(20) NOT NULL,
    [SM_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Schemes
-- --------------------------------------------------
CREATE TABLE [dbo].[Schemes]
(
    [schemeID] TINYINT NOT NULL,
    [Desc] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scrip_imp
-- --------------------------------------------------
CREATE TABLE [dbo].[Scrip_imp]
(
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [SCRIP_NAME] VARCHAR(50) NULL,
    [FILLER1] VARCHAR(12) NULL,
    [ISIN] VARCHAR(12) NULL,
    [Sno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[Scrip1]
(
    [Co_Code] VARCHAR(6) NOT NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Short_Name] VARCHAR(50) NULL,
    [Long_Name] VARCHAR(50) NULL,
    [Market_Lot] INT NULL,
    [Face_Val] FLOAT NULL,
    [Book_Cl_Dt] DATETIME NULL,
    [Ex_Div_Dt] DATETIME NULL,
    [Ex_Bon_Dt] DATETIME NULL,
    [Ex_Rit_Dt] DATETIME NULL,
    [Eqt_Type] VARCHAR(3) NULL,
    [Sub_Type] VARCHAR(3) NULL,
    [Agent_Cd] VARCHAR(6) NULL,
    [Demat_Flag] SMALLINT NULL,
    [Demat_Date] DATETIME NOT NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Securities
-- --------------------------------------------------
CREATE TABLE [dbo].[Securities]
(
    [exch_indicator] VARCHAR(3) NULL,
    [seg_indicator] VARCHAR(20) NULL,
    [party_code] VARCHAR(6) NULL,
    [security_type] VARCHAR(3) NULL,
    [rec_dt] SMALLDATETIME NULL,
    [create_dt] SMALLDATETIME NULL,
    [created_by] VARCHAR(30) NULL,
    [gross_value] DECIMAL(18, 0) NULL,
    [net_value] DECIMAL(18, 0) NULL,
    [lst_val_dt] SMALLDATETIME NULL,
    [lst_update_dt] SMALLDATETIME NULL,
    [lst_update_by] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [series] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [foliono] VARCHAR(10) NULL,
    [certno] VARCHAR(15) NULL,
    [fromno] VARCHAR(15) NULL,
    [tono] VARCHAR(15) NULL,
    [qty] INT NULL,
    [bankcode] VARCHAR(15) NULL,
    [cltaccno] VARCHAR(15) NULL,
    [isin] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SpanMargin_Imp
-- --------------------------------------------------
CREATE TABLE [dbo].[SpanMargin_Imp]
(
    [node] VARCHAR(20) NULL,
    [Intradate] VARCHAR(20) NULL,
    [isSetl] VARCHAR(20) NULL,
    [qual] VARCHAR(20) NULL,
    [Intratime] VARCHAR(20) NULL,
    [run] VARCHAR(20) NULL,
    [firm] VARCHAR(20) NULL,
    [acct] VARCHAR(20) NULL,
    [seg] VARCHAR(20) NULL,
    [Intratype] VARCHAR(20) NULL,
    [isCust] VARCHAR(20) NULL,
    [ec] VARCHAR(20) NULL,
    [cc] VARCHAR(20) NULL,
    [Intracurrency] VARCHAR(20) NULL,
    [lfv] VARCHAR(20) NULL,
    [sfv] VARCHAR(20) NULL,
    [lov] VARCHAR(20) NULL,
    [sov] VARCHAR(20) NULL,
    [isM] VARCHAR(20) NULL,
    [pbc] VARCHAR(20) NULL,
    [spanReq] VARCHAR(20) NULL,
    [anov] VARCHAR(20) NULL,
    [sr] VARCHAR(20) NULL,
    [ia] VARCHAR(20) NULL,
    [dr] VARCHAR(20) NULL,
    [ie] VARCHAR(20) NULL,
    [iex] VARCHAR(20) NULL,
    [som] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SpanMargin_intraday
-- --------------------------------------------------
CREATE TABLE [dbo].[SpanMargin_intraday]
(
    [node] VARCHAR(7) NOT NULL,
    [Intradate] SMALLDATETIME NOT NULL,
    [isSetl] INT NOT NULL,
    [qual] VARCHAR(7) NOT NULL,
    [Intratime] VARCHAR(7) NULL,
    [run] VARCHAR(7) NULL,
    [firm] VARCHAR(7) NOT NULL,
    [acct] VARCHAR(7) NOT NULL,
    [seg] VARCHAR(4) NULL,
    [Intratype] VARCHAR(7) NULL,
    [isCust] VARCHAR(7) NULL,
    [ec] VARCHAR(10) NULL,
    [cc] VARCHAR(10) NULL,
    [Intracurrency] VARCHAR(7) NULL,
    [lfv] FLOAT NULL,
    [sfv] FLOAT NULL,
    [lov] FLOAT NULL,
    [sov] FLOAT NULL,
    [isM] FLOAT NULL,
    [pbc] VARCHAR(7) NULL,
    [spanReq] FLOAT NULL,
    [anov] FLOAT NULL,
    [sr] FLOAT NULL,
    [ia] FLOAT NULL,
    [dr] FLOAT NULL,
    [ie] FLOAT NULL,
    [iex] FLOAT NULL,
    [som] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(10) NULL,
    [IndexColumn] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SQLTableReIndex_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[SQLTableReIndex_Log]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(20) NULL,
    [IndexColumn] VARCHAR(100) NULL,
    [Status] VARCHAR(20) NULL,
    [UserId] INT NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STAMPDUTY_FILEDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[STAMPDUTY_FILEDATA]
(
    [FILE_DATA] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stat_trd
-- --------------------------------------------------
CREATE TABLE [dbo].[stat_trd]
(
    [actioncode] VARCHAR(3) NULL,
    [sysdate] SMALLDATETIME NULL,
    [filedate] SMALLDATETIME NULL,
    [com_date] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STATE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[STATE_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATE] VARCHAR(50) NULL,
    [TRDSTAMPDUTY] DECIMAL(18, 4) NULL,
    [DELSTAMPDUTY] DECIMAL(18, 4) NULL,
    [PROSTAMPDUTY] DECIMAL(18, 4) NULL,
    [MIN_MULTIPLIER] DECIMAL(18, 4) NULL,
    [FOR_TURNOVER] DECIMAL(18, 4) NULL,
    [MAXIMUM_LIMIT] DECIMAL(18, 4) NULL,
    [STATE_CODE] VARCHAR(2) NULL,
    [YEAR_START_DATE] DATETIME NULL,
    [YEAR_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STATE_MASTER_bak_20230621
-- --------------------------------------------------
CREATE TABLE [dbo].[STATE_MASTER_bak_20230621]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATE] VARCHAR(50) NULL,
    [TRDSTAMPDUTY] DECIMAL(18, 4) NULL,
    [DELSTAMPDUTY] DECIMAL(18, 4) NULL,
    [PROSTAMPDUTY] DECIMAL(18, 4) NULL,
    [MIN_MULTIPLIER] DECIMAL(18, 4) NULL,
    [FOR_TURNOVER] DECIMAL(18, 4) NULL,
    [MAXIMUM_LIMIT] DECIMAL(18, 4) NULL,
    [STATE_CODE] VARCHAR(2) NULL,
    [YEAR_START_DATE] DATETIME NULL,
    [YEAR_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_CLIENTDETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_CLIENTDETAIL]
(
    [RECTYPE] INT NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [CONTRACTNO] VARCHAR(7) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NOT NULL,
    [OPTION_TYPE] VARCHAR(6) NOT NULL,
    [SYMBOL] VARCHAR(12) NOT NULL,
    [EXPIRYDATE] DATETIME NOT NULL,
    [STRIKE_PRICE] MONEY NULL,
    [TRDPRICE] MONEY NULL,
    [PQTYTRD] INT NULL,
    [PAMTTRD] MONEY NULL,
    [PSTTTRD] MONEY NULL,
    [SQTYTRD] INT NULL,
    [SAMTTRD] MONEY NULL,
    [SSTTTRD] MONEY NULL,
    [TOTALSTT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_EXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_EXCEPTION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EFFDATE_FROM] DATETIME NULL,
    [EFFDATE_TO] DATETIME NULL,
    [ADDEDBY] VARCHAR(20) NULL,
    [ADDEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_EXCHG
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_EXCHG]
(
    [RECTYPE] INT NOT NULL,
    [STT_DATE] DATETIME NOT NULL,
    [TM_CODE] VARCHAR(15) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(6) NULL,
    [CA_LEVEL] INT NULL,
    [SQTY] INT NULL,
    [SAMT] NUMERIC(18, 4) NULL,
    [TSAMT_FUT] NUMERIC(18, 4) NULL,
    [TSAMT_OPT] NUMERIC(18, 4) NULL,
    [STT_FUT] NUMERIC(18, 4) NULL,
    [STT_OPT] NUMERIC(18, 4) NULL,
    [TOTALSTT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUBBROKERS
-- --------------------------------------------------
CREATE TABLE [dbo].[SUBBROKERS]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [Branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysconstraints
-- --------------------------------------------------
CREATE TABLE [dbo].[sysconstraints]
(
    [constid] INT NULL,
    [id] INT NULL,
    [colid] SMALLINT NULL,
    [spare1] TINYINT NULL,
    [status] INT NULL,
    [actions] INT NULL,
    [error] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.T#
-- --------------------------------------------------
CREATE TABLE [dbo].[T#]
(
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NULL,
    [Startdate] SMALLDATETIME NULL,
    [Maturitydate] SMALLDATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [Cor_Act_Level] INT NULL,
    [C_Regular_Lot] INT NULL,
    [C_Issue_Mat_Dt] SMALLDATETIME NULL,
    [C_U_Inst_type] VARCHAR(6) NULL,
    [C_U_Symbol] VARCHAR(12) NULL,
    [C_U_Series] VARCHAR(2) NULL,
    [C_U_Expirydate] SMALLDATETIME NULL,
    [C_U_StrikePrice] MONEY NULL,
    [C_U_Option_type] VARCHAR(2) NULL,
    [C_U_CAL] INT NULL,
    [PriceUnit] VARCHAR(20) NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL,
    [Qty_Unit] VARCHAR(10) NULL,
    [Delivery_Lot] NUMERIC(18, 4) NULL,
    [Delivery_Unit] VARCHAR(10) NULL,
    [P_Key] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.taxes
-- --------------------------------------------------
CREATE TABLE [dbo].[taxes]
(
    [Exchange] VARCHAR(3) NULL,
    [Trans_cat] VARCHAR(3) NULL,
    [Insurance_Chrg] DECIMAL(5, 4) NULL,
    [Turnover_tax] DECIMAL(4, 3) NULL,
    [Other_chrg] DECIMAL(3, 2) NULL,
    [Sebiturn_tax] DECIMAL(3, 2) NULL,
    [Broker_note] DECIMAL(3, 2) NULL,
    [From_date] DATETIME NULL,
    [Demat_Insure] DECIMAL(3, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TAXES_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TAXES_SETTING]
(
    [TAXES_TYPE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [TAXES_PERC] NUMERIC(18, 6) NULL,
    [TAXES_UNIT] NUMERIC(18, 0) NULL,
    [TRADE_TIME_FROM] INT NULL,
    [TRADE_TIME_TO] INT NULL,
    [COMPUTE_FLAG] INT NULL,
    [STATE_CODE] VARCHAR(50) NULL,
    [MAXIMUM_LIMIT] MONEY NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [FOR_TURNOVER] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(200) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GROUP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GROUP_LOG]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [EMAIL_SEND_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GRP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GRP]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_FILE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_FILE]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FLD_FILENAME] VARCHAR(200) NULL,
    [FLD_FILEDATE] DATETIME NULL,
    [PROCESS_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_LISNER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_LISNER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_PATH] VARCHAR(200) NULL,
    [PROCESS_FILE_NAME] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_TYPE] VARCHAR(1) NULL,
    [PROCESS_SET] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_LISNER_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_LISNER_LOG]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [BUSINESS_DATE] DATETIME NULL,
    [PROCESS_FOR] VARCHAR(50) NULL,
    [PROCESS_FILE_NAME] VARCHAR(50) NULL,
    [PROCESS_FLAG] INT NULL,
    [PROCESS_SETUP_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(200) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER_DELIVERY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER_DELIVERY]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(200) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Charge_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Charge_Detail]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Charge_Code] VARCHAR(10) NOT NULL,
    [Line_No] INT NOT NULL,
    [Charge_Type] VARCHAR(4) NOT NULL,
    [Charge_By] VARCHAR(50) NOT NULL,
    [Charge_On] VARCHAR(8) NOT NULL,
    [Val_Per] VARCHAR(1) NOT NULL,
    [Rate] NUMERIC(18, 4) NOT NULL,
    [Unit] NUMERIC(18, 0) NULL,
    [FromDate] DATETIME NOT NULL,
    [ToDate] DATETIME NOT NULL,
    [Charge_Rule] VARCHAR(10) NOT NULL,
    [AddedBy] VARCHAR(50) NOT NULL,
    [AddedOn] DATETIME NOT NULL,
    [ModifiedBy] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL,
    [MIN_CHARGE] NUMERIC(18, 4) NULL,
    [MAX_CHARGE] NUMERIC(18, 4) NULL,
    [FIX_CHARGE] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_Charge_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_Charge_Master]
(
    [Sno] INT IDENTITY(1,1) NOT NULL,
    [Charge_Code] VARCHAR(10) NOT NULL,
    [Charge_Name] VARCHAR(50) NOT NULL,
    [Line_No] INT NOT NULL,
    [Charge_Type] VARCHAR(4) NOT NULL,
    [Charge_By] VARCHAR(50) NOT NULL,
    [Charge_On] VARCHAR(8) NOT NULL,
    [Val_Per] VARCHAR(1) NOT NULL,
    [Rate] NUMERIC(18, 4) NOT NULL,
    [Unit] NUMERIC(18, 0) NULL,
    [AddedBy] VARCHAR(50) NULL,
    [AddedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL,
    [MIN_CHARGE] NUMERIC(18, 4) NULL,
    [MAX_CHARGE] NUMERIC(18, 4) NULL,
    [FIX_CHARGE] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CHARGES_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CHARGES_DATA]
(
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(50) NOT NULL,
    [CHARGE_CODE] VARCHAR(10) NOT NULL,
    [CHARGE_AMOUNT] NUMERIC(18, 4) NOT NULL,
    [RULE_CODE] VARCHAR(10) NULL,
    [CALCULATED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLASS_IMPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLASS_IMPORT]
(
    [FLDFILENO] VARCHAR(2) NOT NULL,
    [FLDFILETYPE] VARCHAR(50) NULL,
    [FLDFILENAME] VARCHAR(10) NULL,
    [FLDPROCNAME] VARCHAR(50) NOT NULL,
    [FLDFILEFOR] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENT_GST_DATA]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(250) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [L_NATION] VARCHAR(15) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL,
    [EFF_FROM_DATE] DATETIME NOT NULL,
    [EFF_TO_DATE] DATETIME NOT NULL,
    [CREATED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_clientmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_clientmargin]
(
    [party_code] VARCHAR(15) NOT NULL,
    [margindate] DATETIME NOT NULL,
    [billamount] MONEY NOT NULL,
    [ledgeramount] MONEY NOT NULL,
    [cash_coll] MONEY NOT NULL,
    [noncash_coll] MONEY NOT NULL,
    [initialmargin] MONEY NOT NULL,
    [lst_update_dt] DATETIME NOT NULL,
    [short_name] VARCHAR(25) NULL,
    [long_name] VARCHAR(100) NULL,
    [branch_cd] VARCHAR(20) NULL,
    [family] VARCHAR(20) NULL,
    [sub_broker] VARCHAR(20) NULL,
    [trader] VARCHAR(20) NULL,
    [MTMMargin] MONEY NULL,
    [AddMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_COLLATERAL_MARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_COLLATERAL_MARGIN]
(
    [EFFDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [ISIN] VARCHAR(20) NULL,
    [CL_RATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [QTY] NUMERIC(18, 4) NULL,
    [HAIRCUT] MONEY NULL,
    [FINALAMOUNT] MONEY NULL,
    [PERCENTAGECASH] NUMERIC(18, 2) NULL,
    [PERECNTAGENONCASH] NUMERIC(18, 2) NULL,
    [COLL_TYPE] VARCHAR(6) NULL,
    [CASH_NCASH] VARCHAR(2) NULL,
    [FD_BG_NO] VARCHAR(20) NULL,
    [BANK_CODE] VARCHAR(15) NULL,
    [FD_TYPE] VARCHAR(1) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CTCL_PARTY_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CTCL_PARTY_MAPPING]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [USERID] VARCHAR(15) NULL,
    [CTCLID] VARCHAR(20) NULL,
    [FROMPARTY] VARCHAR(10) NULL,
    [TOPARTY] VARCHAR(10) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [ADDEDBY] VARCHAR(50) NULL,
    [ADDEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DAILY_MTM_DIFF
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DAILY_MTM_DIFF]
(
    [SAUDA_DATE] DATETIME NULL,
    [BO_PARTY_CODE] VARCHAR(10) NULL,
    [BO_INT_TYPE] VARCHAR(7) NULL,
    [BO_SYMBOL] VARCHAR(12) NULL,
    [BO_EXPIRYDATE] DATETIME NULL,
    [BO_OPTION_TYPE] VARCHAR(2) NULL,
    [BO_STRIKE_PRICE] MONEY NULL,
    [BO_MTM] MONEY NULL,
    [BO_PRM] MONEY NULL,
    [BO_EXC] MONEY NULL,
    [EX_PARTY_CODE] VARCHAR(10) NULL,
    [EX_INT_TYPE] VARCHAR(7) NULL,
    [EX_SYMBOL] VARCHAR(12) NULL,
    [EX_EXPIRYDATE] DATETIME NULL,
    [EX_OPTION_TYPE] VARCHAR(2) NULL,
    [EX_STRIKE_PRICE] MONEY NULL,
    [EX_MTM] MONEY NULL,
    [EX_PRM] MONEY NULL,
    [EX_EXC] MONEY NULL,
    [ERR_DESC] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ECNBOUNCED
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ECNBOUNCED]
(
    [EXCHANGE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FOMARGINNEW_UDIFF_EOD
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FOMARGINNEW_UDIFF_EOD]
(
    [Sgmt] VARCHAR(2) NULL,
    [Src] VARCHAR(5) NULL,
    [MARGINDATE] DATETIME NULL,
    [BizDt] DATETIME NULL,
    [TradRegnOrgn] VARCHAR(1) NULL,
    [Lvl] VARCHAR(1) NULL,
    [ClrMmbId] VARCHAR(20) NULL,
    [BrkrOrCtdnPtcptId] VARCHAR(20) NULL,
    [ClntTp] VARCHAR(1) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [TckrSymb] VARCHAR(30) NULL,
    [SttlmTp] VARCHAR(20) NULL,
    [SctiesSttlmTxId] VARCHAR(20) NULL,
    [SctySrs] VARCHAR(20) NULL,
    [FinInstrmId] VARCHAR(20) NULL,
    [FinInstrmTp] VARCHAR(20) NULL,
    [XpryDt] VARCHAR(20) NULL,
    [StrkPric] VARCHAR(20) NULL,
    [OptnTp] VARCHAR(20) NULL,
    [ValAtRskMrgn] VARCHAR(20) NULL,
    [SPANMrgn] NUMERIC(18, 4) NULL,
    [LossMrgn] NUMERIC(18, 4) NULL,
    [PrmAmt] VARCHAR(20) NULL,
    [CnsltdCrstllsdOblgtnMrg] NUMERIC(18, 4) NULL,
    [DlvrySttlmtMrgn] VARCHAR(20) NULL,
    [SpclMrgn] VARCHAR(20) NULL,
    [SpclCshMrgn] VARCHAR(20) NULL,
    [TndrMrgn] VARCHAR(20) NULL,
    [AddtlMrgn] VARCHAR(20) NULL,
    [MrkToMktNetd] VARCHAR(20) NULL,
    [MinMrgn] NUMERIC(18, 4) NULL,
    [SPANMrgnMin] NUMERIC(18, 4) NULL,
    [XtrmLossMrgnMin] NUMERIC(18, 4) NULL,
    [AggtPeakLbltyRptd] NUMERIC(18, 4) NULL,
    [EndOfDayRqrmntRptd] NUMERIC(18, 4) NULL,
    [TtlMrgnAsPerActlParams] NUMERIC(18, 4) NULL,
    [TtlBuyTradgVol] VARCHAR(20) NULL,
    [TtlBuyTrfVal] VARCHAR(20) NULL,
    [TtlSellTradgVol] VARCHAR(20) NULL,
    [TtlSellTrfVal] VARCHAR(20) NULL,
    [NetOpnQty] VARCHAR(20) NULL,
    [NetOpnVal] VARCHAR(20) NULL,
    [CncntrtnMrgn] VARCHAR(20) NULL,
    [DvlmntMrgn] VARCHAR(20) NULL,
    [CrossMrgnBnftForSPAN] VARCHAR(20) NULL,
    [CrossMrgnBnftForELM] VARCHAR(20) NULL,
    [Rmks] VARCHAR(20) NULL,
    [Rsvd1] VARCHAR(20) NULL,
    [Rsvd2] VARCHAR(20) NULL,
    [Rsvd3] VARCHAR(20) NULL,
    [Rsvd4] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GST_LOCATION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GST_LOCATION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [LOC_CODE] VARCHAR(20) NOT NULL,
    [LOCATION] VARCHAR(80) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [ADDRESS1] VARCHAR(100) NULL,
    [ADDRESS2] VARCHAR(100) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [NATION] VARCHAR(50) NULL,
    [ZIP] VARCHAR(30) NULL,
    [PHONE1] VARCHAR(30) NULL,
    [PHONE2] VARCHAR(30) NULL,
    [FAX] VARCHAR(30) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [GST_NO] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_MTomPremiumBill
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_MTomPremiumBill]
(
    [Billdate] SMALLDATETIME NULL,
    [Pqty] INT NULL,
    [Sqty] INT NULL,
    [Netrate] MONEY NULL,
    [Cl_Rate] MONEY NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Sdate] SMALLDATETIME NULL,
    [Sell_Buy] INT NULL,
    [Service_Tax] MONEY NULL,
    [Brok] MONEY NULL,
    [Nonexpiryservice_Tax] MONEY NULL,
    [Nonexpirybrok] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Stampduty] MONEY NULL,
    [Inex_Service_Tax] MONEY NULL,
    [Inex_Sebi_Tax] MONEY NULL,
    [Inex_Turn_Tax] MONEY NULL,
    [Inex_Stampduty] MONEY NULL,
    [Expirybrok] MONEY NULL,
    [Expiryservice_Tax] MONEY NULL,
    [Insurance_Chrg] MONEY NULL,
    [Inex_Insurance_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Inex_Other_Chrg] MONEY NULL,
    [Auctionpart] VARCHAR(2) NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Strike_Price] MONEY NULL,
    [Netwithbrok] MONEY NULL,
    [Bfdayflag] VARCHAR(3) NULL,
    [Reserved1] INT NULL,
    [Actbuyqty] INT NULL,
    [Actsellqty] INT NULL,
    [ClosingRate] MONEY NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mtompremiumbill_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mtompremiumbill_Report]
(
    [billdate] SMALLDATETIME NULL,
    [pqty] INT NULL,
    [sqty] INT NULL,
    [netrate] MONEY NULL,
    [cl_rate] MONEY NULL,
    [party_code] VARCHAR(10) NULL,
    [inst_type] VARCHAR(6) NULL,
    [symbol] VARCHAR(12) NULL,
    [expirydate] SMALLDATETIME NULL,
    [sdate] SMALLDATETIME NULL,
    [sell_buy] INT NULL,
    [service_tax] MONEY NULL,
    [brok] MONEY NULL,
    [nonexpiryservice_tax] MONEY NULL,
    [nonexpirybrok] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [turn_tax] MONEY NULL,
    [stampduty] MONEY NULL,
    [inex_service_tax] MONEY NULL,
    [inex_sebi_tax] MONEY NULL,
    [inex_turn_tax] MONEY NULL,
    [inex_stampduty] MONEY NULL,
    [expirybrok] MONEY NULL,
    [expiryservice_tax] MONEY NULL,
    [insurance_chrg] MONEY NULL,
    [inex_insurance_chrg] MONEY NULL,
    [other_chrg] MONEY NULL,
    [inex_other_chrg] MONEY NULL,
    [auctionpart] VARCHAR(2) NULL,
    [option_type] VARCHAR(2) NULL,
    [strike_price] MONEY NULL,
    [netwithbrok] MONEY NULL,
    [bfdayflag] VARCHAR(3) NULL,
    [reserved1] INT NULL,
    [actbuyqty] INT NULL,
    [actsellqty] INT NULL,
    [ClosingRate] MONEY NULL,
    [Numerator] MONEY NULL,
    [Denominator] MONEY NULL,
    [RegularLot] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Rule_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Rule_Master]
(
    [SNo] INT IDENTITY(1,1) NOT NULL,
    [Rule_Code] VARCHAR(10) NOT NULL,
    [Rule_Name] VARCHAR(50) NOT NULL,
    [Rule_Definition] VARCHAR(500) NOT NULL,
    [Rule_Type] VARCHAR(20) NULL,
    [Rule_Applicable] VARCHAR(10) NOT NULL,
    [AddedBy] VARCHAR(50) NOT NULL,
    [AddedOn] DATETIME NOT NULL,
    [ModifiedBy] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_DATA]
(
    [SAUDA_DATE] DATETIME NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [BUYQTY] INT NULL,
    [SELLQTY] INT NULL,
    [BUYAVGRATE] NUMERIC(38, 2) NULL,
    [SELLAVGRATE] NUMERIC(38, 2) NULL,
    [BUYSTAMP] NUMERIC(38, 2) NULL,
    [SELLSTAMP] NUMERIC(38, 2) NULL,
    [TOTALSTAMP] NUMERIC(38, 2) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [LASTRUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_EXCHG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_EXCHG]
(
    [REC_FOR] VARCHAR(10) NULL,
    [RECTYPE] VARCHAR(2) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TM_CODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [STATE_NAME] VARCHAR(50) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(30) NULL,
    [EXPIRY_DATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CA_LEVEL] VARCHAR(10) NULL,
    [BUYQTY] INT NULL,
    [SELLQTY] INT NULL,
    [SETT_PRICE] NUMERIC(18, 4) NULL,
    [DELBUYQTY] INT NULL,
    [DELBUYVAL] NUMERIC(18, 4) NULL,
    [TRDBUYQTY] INT NULL,
    [TRDBUYVAL] NUMERIC(18, 4) NULL,
    [DELSTAMP] NUMERIC(18, 4) NULL,
    [TRDSTAMP] NUMERIC(18, 4) NULL,
    [TOTALSTAMP] NUMERIC(18, 4) NULL,
    [UPLOAD_BY] VARCHAR(50) NULL,
    [UPLOAD_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STAMP_TAX
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STAMP_TAX]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [BUYTAX] NUMERIC(18, 6) NULL,
    [SELLTAX] NUMERIC(18, 6) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_SLAB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_SLAB]
(
    [INST_TYPE] VARCHAR(3) NULL,
    [TRADE_TYPE] VARCHAR(3) NULL,
    [CHARGE_ON] INT NULL,
    [FROM_TOT] NUMERIC(18, 4) NULL,
    [TO_TOT] NUMERIC(18, 4) NULL,
    [CHARGE_PER] NUMERIC(18, 6) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbladmin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbladmin]
(
    [fldauto_admin] INT IDENTITY(1,1) NOT NULL,
    [fldname] VARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(50) NULL,
    [fldcompany] VARCHAR(50) NULL,
    [fldstname] VARCHAR(50) NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN_LOG]
(
    [Fldauto_Admin] INT NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(30) NOT NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblAdminconfig
-- --------------------------------------------------
CREATE TABLE [dbo].[TblAdminconfig]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMINPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMINPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDADMINID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [fldcategoryname] VARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATEGORY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATEGORY_LOG]
(
    [Fldcategorycode] INT NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcatmenu
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcatmenu]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldreportcode] INT NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATMENU_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode_OLD] VARCHAR(2000) NULL,
    [Fldcategorycode_NEW] VARCHAR(2000) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINE_IP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSADMINLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSADMINLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDADMINNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSUSERLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDUSERNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblGlobalParams
-- --------------------------------------------------
CREATE TABLE [dbo].[tblGlobalParams]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL,
    [FldPwdAlphaNumOnly] INT NULL,
    [FLDOLDPASSWORD] TINYINT NULL,
    [FLDUPDTDATE] DATETIME NULL,
    [FLDCLIENTMAKERCHEKER] INT NULL,
    [FLDAUTOCODEGENERATE] INT NULL,
    [FLDFLAG] VARCHAR(3) NULL,
    [FLDREPORTFLAG] VARCHAR(3) NULL,
    [FLDCHECKCLIENTPROCESS] VARCHAR(1) NULL,
    [FLDBRANCHADD] TINYINT NULL,
    [BRANCHFLAG] CHAR(1) NULL,
    [FLDPANVALIDATION] CHAR(1) NULL,
    [FLDPARTYCODEBY] VARCHAR(10) NULL,
    [ALLOW_MULTI_LOGIN] INT NULL,
    [MAX_REJECTION_ALLOW] SMALLINT NULL,
    [MAC_ID_VALIDATION] INT NULL,
    [MKCKFLAG] SMALLINT NULL,
    [FldAddRpt] SMALLINT NULL,
    [FldCaptcha] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblmenuhead
-- --------------------------------------------------
CREATE TABLE [dbo].[tblmenuhead]
(
    [fldmenucode] VARCHAR(20) NULL,
    [fldmenuname] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPradnyausers
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPradnyausers]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] VARCHAR(25) NULL,
    [fldpassword] VARCHAR(512) NULL,
    [fldfirstname] VARCHAR(25) NULL,
    [fldmiddlename] VARCHAR(25) NULL,
    [fldlastname] VARCHAR(25) NULL,
    [fldsex] VARCHAR(8) NULL,
    [fldaddress1] VARCHAR(100) NULL,
    [fldaddress2] VARCHAR(100) NULL,
    [fldphone1] VARCHAR(10) NULL,
    [fldphone2] VARCHAR(10) NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] VARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS_LOG]
(
    [Fldauto] INT NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(512) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(100) NULL,
    [Fldaddress2] VARCHAR(100) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MachineIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreportgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreportgrp]
(
    [fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [fldgrpname] VARCHAR(35) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [flddesc] VARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTGRP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTGRP_LOG]
(
    [Fldreportgrp] INT NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblreports
-- --------------------------------------------------
CREATE TABLE [dbo].[tblreports]
(
    [fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [fldreportname] VARCHAR(50) NULL,
    [fldpath] VARCHAR(500) NULL,
    [fldtarget] VARCHAR(25) NULL,
    [flddesc] VARCHAR(80) NULL,
    [fldreportgrp] VARCHAR(10) NULL,
    [fldmenugrp] VARCHAR(3) NULL,
    [fldstatus] VARCHAR(20) NULL,
    [fldorder] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblReports_Blocked
-- --------------------------------------------------
CREATE TABLE [dbo].[TblReports_Blocked]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldreportname] VARCHAR(35) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NOT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERBLOCK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERBLOCK]
(
    [FLDAUTO] INT NOT NULL,
    [FLDNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlGlobals
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlGlobals]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NOT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLD_MAC_ID] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblUserControlMaster_Jrnl
-- --------------------------------------------------
CREATE TABLE [dbo].[tblUserControlMaster_Jrnl]
(
    [FLDAUTO] BIGINT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL,
    [FLD_MAC_ID] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS_LOG]
(
    [FLDAUTO] INT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMPDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMPDATA]
(
    [FILE_DATA] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermLimit
-- --------------------------------------------------
CREATE TABLE [dbo].[TermLimit]
(
    [USERID] VARCHAR(50) NULL,
    [TRADELIMIT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermLimit_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[TermLimit_Log]
(
    [USERID] VARCHAR(50) NULL,
    [TRADELIMIT] MONEY NULL,
    [MODIFIEDBY] VARCHAR(50) NULL,
    [MODIFIEDON] DATETIME NULL,
    [MODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.termparty
-- --------------------------------------------------
CREATE TABLE [dbo].[termparty]
(
    [UserId] CHAR(10) NOT NULL,
    [Party_code] CHAR(10) NOT NULL,
    [ProCli] INT NULL,
    [Exceptparty] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermParty_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[TermParty_Log]
(
    [Userid] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(15) NULL,
    [Procli] INT NULL,
    [Exceptparty] VARCHAR(15) NULL,
    [Modified_By] VARCHAR(15) NULL,
    [Modified_On] DATETIME NULL,
    [Mode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trscheme
-- --------------------------------------------------
CREATE TABLE [dbo].[trscheme]
(
    [Scheme_desc] VARCHAR(10) NULL,
    [scheme] VARCHAR(1) NULL,
    [tmark] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TurnTax_Exception
-- --------------------------------------------------
CREATE TABLE [dbo].[TurnTax_Exception]
(
    [Inst_Type] VARCHAR(7) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_Name] VARCHAR(25) NULL,
    [EffDate_From] DATETIME NULL,
    [EffDate_To] DATETIME NULL,
    [Min_TurnOver] MONEY NULL,
    [TAX_PERC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ucc_Client
-- --------------------------------------------------
CREATE TABLE [dbo].[Ucc_Client]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Client_Name] VARCHAR(100) NOT NULL,
    [Contract_Person] VARCHAR(60) NULL,
    [Clearingno1] VARCHAR(4) NULL,
    [Clearingno2] VARCHAR(4) NULL,
    [Clearingno3] VARCHAR(4) NULL,
    [Clearingno4] VARCHAR(4) NULL,
    [Mapidid] VARCHAR(12) NULL,
    [Fmcode] VARCHAR(10) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Family_Code1] VARCHAR(10) NULL,
    [Family_Code2] VARCHAR(10) NULL,
    [Family_Code3] VARCHAR(10) NULL,
    [Family_Code4] VARCHAR(10) NULL,
    [Remark] VARCHAR(100) NULL,
    [Ucc_Code] VARCHAR(16) NULL,
    [Stpprovider] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(10) NULL,
    [Dummy2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERDISABLED_LIST
-- --------------------------------------------------
CREATE TABLE [dbo].[USERDISABLED_LIST]
(
    [USERID] BIGINT NULL,
    [USERSTATUS] SMALLINT NULL,
    [MODEFLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(500) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BillPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BillPrint_Setting]
(
    [Rpt_SrNo] INT NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(300) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BUSINESS_PROCESS]
(
    [BUSINESS_DATE] SMALLDATETIME NULL,
    [IMPORT_TRADE] INT NULL,
    [VBB] INT NULL,
    [STT] INT NULL,
    [BILLING] INT NULL,
    [CONTRACT] INT NULL,
    [POSTING] INT NULL,
    [POSITIONFILE] INT NULL,
    [MARGINFILE] INT NULL,
    [MARGINRETURNFILE] INT NULL,
    [CLIENTMARGINPOP] INT NULL,
    [EXCHANGESTT] INT NULL,
    [EXERCISEALLOCATION] INT NULL,
    [OPEN_CLOSE] INT NULL,
    [PROCESSDATE] DATETIME NULL,
    [PROCESSBY] VARCHAR(20) NULL,
    [LASTUPDATEDATE] DATETIME NULL,
    [LASTUPDATEBY] VARCHAR(20) NULL,
    [MACHINEIP] VARCHAR(20) NULL,
    [FCN01IMPORT] INT NULL,
    [CONTRACTMASTERIMP] INT NULL,
    [INSTCONSOLIDATION] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_clientbrok_scheme
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_clientbrok_scheme]
(
    [SCHEME_ID] DECIMAL(18, 0) IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [Table_No] VARCHAR(5) NOT NULL,
    [Scheme_Type] VARCHAR(5) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NOT NULL,
    [Trade_Type] VARCHAR(3) NOT NULL,
    [BrokScheme] VARCHAR(1) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [Round_To] INT NULL,
    [Rofig] INT NULL,
    [Errnum] NUMERIC(19, 8) NULL,
    [Nozero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Contract_Digital_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Contract_Digital_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(500) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_ContractPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_ContractPrint_Setting]
(
    [Rpt_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(300) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Digital_File_Name]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [D_Type] VARCHAR(8) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(10) NULL,
    [D_Order] INT NULL,
    [D_Seprater] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_grandsub
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_grandsub]
(
    [sno] INT IDENTITY(1,1) NOT NULL,
    [F_Value] NVARCHAR(5) NOT NULL,
    [F_Name] CHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_inputdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_inputdetails]
(
    [sno] INT NOT NULL,
    [Ctrltype] CHAR(10) NOT NULL,
    [Def] NVARCHAR(250) NOT NULL,
    [Maxlength] INT NULL,
    [ReadOnly] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LOGIN_ERR_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [LOGIN_ID] VARCHAR(20) NULL,
    [LOGIN_PWD] VARCHAR(20) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ERR_TYPE] VARCHAR(20) NULL,
    [LOGIN_TYPE] VARCHAR(10) NULL,
    [LOGIN_DT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Login_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Login_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(64) NULL,
    [Category] VARCHAR(64) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusId] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [Action] VARCHAR(6) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LovMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LovMaster]
(
    [SNo] INT IDENTITY(1,1) NOT NULL,
    [ControlType] NVARCHAR(50) NOT NULL,
    [ConttrolValue] NVARCHAR(500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PROCESS_STATUS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PROCESS_STATUS_LOG]
(
    [SNO] NUMERIC(9, 0) IDENTITY(1,1) NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [BusinessDate] SMALLDATETIME NULL,
    [ProcessId] VARCHAR(10) NULL,
    [ProcessName] VARCHAR(50) NULL,
    [FileName] VARCHAR(255) NULL,
    [Start_End_Flag] INT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(64) NULL,
    [MachineIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_QueriesSelection
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_QueriesSelection]
(
    [Qno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [QTitle] NVARCHAR(350) NOT NULL,
    [Qpage] NVARCHAR(250) NULL,
    [Subtotal] CHAR(10) NULL,
    [Grandtotal] CHAR(10) NULL,
    [SubTotalField] CHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_QueryParam
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_QueryParam]
(
    [Rid] NUMERIC(10, 0) NOT NULL,
    [DisplayName] NVARCHAR(50) NOT NULL,
    [ParamName] NVARCHAR(50) NOT NULL,
    [ControlName] NVARCHAR(50) NOT NULL,
    [ControlType] NVARCHAR(50) NOT NULL,
    [Maxlength] CHAR(10) NULL,
    [FieldType] NVARCHAR(50) NULL,
    [Readonly] NVARCHAR(10) NULL,
    [ExtraParam] NVARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_queryreport
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_queryreport]
(
    [Qno] INT NOT NULL,
    [Query] NVARCHAR(500) NOT NULL,
    [QueryFilter] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Report_Access_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Report_Access_Log]
(
    [Sno] BIGINT IDENTITY(1,1) NOT NULL,
    [RepPath] VARCHAR(4000) NULL,
    [UserId] INT NULL,
    [UserName] VARCHAR(50) NULL,
    [StatusName] VARCHAR(32) NULL,
    [StatusID] VARCHAR(32) NULL,
    [IPAdd] VARCHAR(20) NULL,
    [AddDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v2_sortby
-- --------------------------------------------------
CREATE TABLE [dbo].[v2_sortby]
(
    [sortval] INT NOT NULL,
    [sortname] CHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ValanAccount
-- --------------------------------------------------
CREATE TABLE [dbo].[ValanAccount]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.Sett_Service_Tax_Trigger
-- --------------------------------------------------
CREATE TRIGGER [Sett_Service_Tax_Trigger] ON dbo.fosettlement 
FOR INSERT, UPDATE
AS

UPDATE FOSETTLEMENT SET SERVICE_TAX = 0, NSERTAX = 0
FROM INSERTED I, CLIENT1 C1, CLIENT2 C2
WHERE C1.CL_CODE = C2.CL_CODE
AND C2.PARTY_CODE = I.PARTY_CODE
AND I.SAUDA_DATE = FOSETTLEMENT.SAUDA_DATE
AND FOSETTLEMENT.PARTY_CODE = I.PARTY_CODE
AND I.INST_TYPE = FOSETTLEMENT.INST_TYPE
AND I.SYMBOL = FOSETTLEMENT.SYMBOL
AND I.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE
AND I.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE
AND I.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE
AND I.ORDER_NO = FOSETTLEMENT.ORDER_NO
AND I.TRADE_NO = FOSETTLEMENT.TRADE_NO
AND L_STATE =  'JAMMU AND KASHMIR'
AND SERVICE_CHRG = 0

GO

-- --------------------------------------------------
-- VIEW dbo.AREA
-- --------------------------------------------------
CREATE VIEW [dbo].[AREA]    
AS    
SELECT * FROM MCDX.dbo.Area

GO

-- --------------------------------------------------
-- VIEW dbo.AUDIT_MARGIN_VIEW
-- --------------------------------------------------

CREATE VIEW AUDIT_MARGIN_VIEW
AS
SELECT PARTY_CODE, MDATE, MARGIN = SPREADMARGIN + MTOM FROM FOMARGINNEW

GO

-- --------------------------------------------------
-- VIEW dbo.bbgfosettbfview
-- --------------------------------------------------




/* JAn 16  2002  */
/*  Made the sauda_date as Date Time   */

CREATE  view bbgfosettbfview as
select S.Party_Code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,Pqty=(Case When sell_buy = 1 then sum(tradeqty) else 0 end),
Sqty=(Case When sell_buy = 2 then sum(tradeqty) else 0 end),s.strike_price,s.option_type ,Sauda_date = Convert(DateTime , Left(Convert(varchar,sauda_date,109),11)) ,settflag 
from fosettlement s ,client2 C Where s.party_code = C.Party_code and c.Brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30') 
/* Do I really need following line  */
/* and settflag in(4,5,6,7,8,9)
*/
group by S.party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,expirydate,s.strike_price,s.option_type,
sell_buy,expirydate  ,Convert(DateTime , Left(Convert(varchar,sauda_date,109),11))  ,settflag

GO

-- --------------------------------------------------
-- VIEW dbo.BBGSpansalepur
-- --------------------------------------------------







/****** Object:  View dbo.BBGSpansalepur    Script Date: 09/10/2001 6:26:39 PM ******/

/****** Object:  View dbo.BBGSpansalepur    Script Date: 09/07/2001 10:35:19 PM ******/


/****** Object:  View dbo.BBGSpansalepur    Script Date: 9/7/2001 4:08:57 PM ******/


/****** Object:  View dbo.BBGSpansalepur    Script Date: 8/7/01 4:28:25 PM ******/

/****** Object:  View dbo.BBGSpansalepur    Script Date: 7/25/01 10:05:13 PM ******/

CREATE  VIEW BBGSpansalepur AS
select  t1.party_code,t1.inst_type,t1.symbol,t1.sec_name,t1.expirydate  ,t1.strike_price ,t1.option_type,
        t1.sell_buy, t1.tradeqty ,             
      pqty = isnull((select sum(tradeqty) from fosettlement where 
                fosettlement.party_code = t1.party_code and
                fosettlement.inst_type=t1.inst_type and 
                fosettlement.symbol=t1.symbol and 
                fosettlement.expirydate=t1.expirydate  and
                fosettlement.strike_price=t1.strike_price and  
                fosettlement.sec_name = t1.sec_name  and  
                fosettlement.option_type=t1.option_type 
               
                and fosettlement.sell_buy = 1),0),

      Sqty =isnull( (select sum(tradeqty) from fosettlement where 
                fosettlement.party_code = t1.party_code and
                fosettlement.inst_type=t1.inst_type and
	fosettlement.symbol=t1.symbol and
	fosettlement.expirydate=t1.expirydate and
                fosettlement.strike_price=t1.strike_price and 
                fosettlement.sec_name = t1.sec_name  and  
                fosettlement.option_type=t1.option_type
           
                and fosettlement.sell_buy = 2),0)
from fosettlement t1

GO

-- --------------------------------------------------
-- VIEW dbo.BranchBroktablevalues
-- --------------------------------------------------
CREATE View BranchBroktablevalues  
As   
Select Distinct Day_Puc As Brok, T.Branch_Code From Broktable B, BranchBrokTable T
Where T.Table_No = B.Table_No   

Union All  

Select Distinct Day_Sales As Brok, T.Branch_Code From Broktable B, BranchBrokTable T
Where T.Table_No = B.Table_No   

Union All  
Select Distinct Sett_Purch As Brok, T.Branch_Code From Broktable B, BranchBrokTable T
Where T.Table_No = B.Table_No 
  
Union All  
Select Distinct Sett_Sales As Brok, T.Branch_Code From Broktable B, BranchBrokTable T
Where T.Table_No = B.Table_No 
  
Union All  
Select Distinct Normal As Brok, T.Branch_Code From Broktable B, BranchBrokTable T
Where T.Table_No = B.Table_No

GO

-- --------------------------------------------------
-- VIEW dbo.broktablevalues
-- --------------------------------------------------







CREATE  view broktablevalues
as 
select distinct day_puc as brok from broktable

union all
select distinct day_sales as brok from broktable

union all
select distinct sett_purch as brok from broktable

union all
select distinct sett_sales as brok from broktable

union all
select distinct normal as brok from broktable

GO

-- --------------------------------------------------
-- VIEW dbo.CHARGES_DETAIL_VIEW
-- --------------------------------------------------


CREATE  VIEW [dbo].[CHARGES_DETAIL_VIEW]  

AS  
  
SELECT 
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOTALBROKERAGE = SUM(CD_TOTALBROKERAGE),  
	CD_BUY_QTY = SUM(CD_TOT_BUYQTY),  
	CD_SELL_QTY= SUM(CD_TOT_SELLQTY),  
	CD_TOTALSERTAX = SUM(CD_TOT_SERTAX),  
	CD_BUYRATE,  
	CD_SELLRATE,
	TRD_TRADEQTY = SUM(TRD_TRADEQTY),
	CD_STATUS
FROM
	(
	SELECT  
		CD_CONTRACT_NO,
		CD_SAUDA_DATE,  
		CD_INST_TYPE,  
		CD_SYMBOL,  
		CD_EXPIRY_DATE,  
		CD_STRIKE_PRICE,  
		CD_OPTION_TYPE,  
		CD_ORDER_NO,  
		CD_TRADE_NO = TRADE_NO,  
		CD_PARTY_CODE,  
		CD_AUCTIONPART,  
		CD_TOTALBROKERAGE=CONVERT(NUMERIC(26,12),CD_TOT_BROK)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_TOT_BUYQTY,  
		CD_TOT_SELLQTY,  
		CD_TOT_SERTAX = CONVERT(NUMERIC(26,12),CD_TOT_SERTAX)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_BUYRATE ,  
		CD_SELLRATE,  
		TRD_TRADEQTY, 
		CD_STATUS =''
	FROM   
		CHARGES_DETAIL (NOLOCK),  
		(SELECT   
			SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,112),   
			INST_TYPE,  
			SYMBOL,  
			EXPIRYDATE,  
			STRIKE_PRICE,  
			OPTION_TYPE,  
			ORDER_NO,  
			PARTY_CODE,  
			AUCTION_PART=AUCTIONPART,  
			TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),  
			TRD_TRADEQTY=SUM(TRADEQTY)   
		FROM  
			FOSETTLEMENT (NOLOCK)  
		WHERE  
			TRADEQTY > 0  
		GROUP BY  
			CONVERT(VARCHAR,SAUDA_DATE,112),
			INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			AUCTIONPART,ORDER_NO,PARTY_CODE,PRADNYA.DBO.REPLACETRADENO(TRADE_NO)  
	 ) STLMNT  
	WHERE  
		SAUDA_DATE  =  CONVERT(VARCHAR,CD_SAUDA_DATE,112) AND  
		INST_TYPE = CD_INST_TYPE AND 
		SYMBOL = CD_SYMBOL AND
		EXPIRYDATE = CD_EXPIRY_DATE AND
		STRIKE_PRICE = CD_STRIKE_PRICE AND  
		OPTION_TYPE = CD_OPTION_TYPE AND
		ORDER_NO = CD_ORDER_NO AND   
		PARTY_CODE = CD_PARTY_CODE AND   
		AUCTION_PART = CD_AUCTIONPART AND  
		CD_TRADE_NO =''
		and CD_TOT_BUYQTY+CD_TOT_SELLQTY > 0
	) SS	
GROUP BY
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_BUYRATE,  
	CD_SELLRATE, 
	CD_STATUS 

UNION ALL

SELECT 
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOTALBROKERAGE = SUM(CD_TOTALBROKERAGE),  
	CD_BUY_QTY = SUM(CD_TOT_BUYQTY),  
	CD_SELL_QTY= SUM(CD_TOT_SELLQTY),  
	CD_TOTALSERTAX = SUM(CD_TOT_SERTAX),  
	CD_BUYRATE,  
	CD_SELLRATE,
	TRD_TRADEQTY = SUM(TRD_TRADEQTY),
	CD_STATUS
FROM
	(
	SELECT  
		CD_CONTRACT_NO,
		CD_SAUDA_DATE,  
		CD_INST_TYPE=INST_TYPE,  
		CD_SYMBOL=SYMBOL,  
		CD_EXPIRY_DATE=EXPIRYDATE,  
		CD_STRIKE_PRICE=STRIKE_PRICE,  
		CD_OPTION_TYPE=OPTION_TYPE,  
		CD_ORDER_NO=ORDER_NO,  
		CD_TRADE_NO = TRADE_NO,  
		CD_PARTY_CODE,  
		CD_AUCTIONPART=AUCTION_PART,  
		CD_TOTALBROKERAGE=CONVERT(NUMERIC(26,12),CD_TOT_BROK)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_TOT_BUYQTY=TRD_TRADEQTY,  
		CD_TOT_SELLQTY=TRD_TRADEQTY,  
		CD_TOT_SERTAX = CONVERT(NUMERIC(26,12),CD_TOT_SERTAX)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_BUYRATE ,  
		CD_SELLRATE,  
		TRD_TRADEQTY, 
		CD_STATUS =''
	FROM   
		CHARGES_DETAIL (NOLOCK),  
		(SELECT   
			CONTRACTNO,
			SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,112),   
			INST_TYPE,  
			SYMBOL,  
			EXPIRYDATE,  
			STRIKE_PRICE,  
			OPTION_TYPE,  
			ORDER_NO,  
			PARTY_CODE,  
			AUCTION_PART=AUCTIONPART,  
			TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),  
			TRD_TRADEQTY=SUM(TRADEQTY) 
		FROM  
			FOSETTLEMENT (NOLOCK)  
		WHERE  
			TRADEQTY > 0  
		GROUP BY  
			CONTRACTNO,CONVERT(VARCHAR,SAUDA_DATE,112),
			INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			AUCTIONPART,ORDER_NO,PARTY_CODE,PRADNYA.DBO.REPLACETRADENO(TRADE_NO)  
	 ) STLMNT  
	WHERE  
		SAUDA_DATE  =  CONVERT(VARCHAR,CD_SAUDA_DATE,112) AND  
		PARTY_CODE = CD_PARTY_CODE AND   
		CONTRACTNO = CD_CONTRACT_NO AND   
		CD_INST_TYPE  = '' AND
		CD_SYMBOL = '' AND
		CD_OPTION_TYPE = '' AND
		CD_ORDER_NO = '' AND
		CD_AUCTIONPART ='' AND
		CD_TRADE_NO =''
	) SS	
GROUP BY
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_BUYRATE,  
	CD_SELLRATE, 
	CD_STATUS 

UNION ALL  
  
SELECT  
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOT_BROK,  
	CD_TOT_BUYQTY,  
	CD_TOT_SELLQTY,  
	CD_TOT_SERTAX,  
	CD_BUYRATE ,  
	CD_SELLRATE,  
	TRD_TRADEQTY = 0,
	CD_STATUS=''
FROM CHARGES_DETAIL (NOLOCK)  
WHERE  
	CD_TRADE_NO <> ''

GO

-- --------------------------------------------------
-- VIEW dbo.Client_BROK_Details
-- --------------------------------------------------
creatE view Client_BROK_Details
    AS
    SELECT * FROM MSAJAG.DBO.Client_BROK_Details

GO

-- --------------------------------------------------
-- VIEW dbo.Client_Details
-- --------------------------------------------------

creatE view Client_Details
    AS
    SELECT * FROM MSAJAG.DBO.Client_Details

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_PRINT_SETTINGS
-- --------------------------------------------------

CREATE VIEW CLIENT_PRINT_SETTINGS AS
SELECT * FROM MSAJAG.DBO.CLIENT_PRINT_SETTINGS (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT2_VIEW
-- --------------------------------------------------
CREATE VIEW CLIENT2_VIEW AS  SELECT * FROM CLIENT2 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT2_VW
-- --------------------------------------------------

CREATE VIEW CLIENT2_VW

AS

SELECT * FROM nce.DBO.CLIENT2(NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_BROKTABLE_VIEW
-- --------------------------------------------------


CREATE VIEW [dbo].[CLS_BROKTABLE_VIEW] AS
SELECT 
	TABLE_NO,TABLE_NAME = CONVERT(VARCHAR,TABLE_NO) + ' - ' + TABLE_NAME,
	SRNO = LINE_NO,VALUE  = CONVERT(VARCHAR,LOWER_LIM) + '-' + CONVERT(VARCHAR,UPPER_LIM),
	DAY_BUY = CONVERT(VARCHAR,DAY_PUC) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	DAY_SELL = CONVERT(VARCHAR,DAY_SALES) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	SETT_BUY = CONVERT(VARCHAR,SETT_PURCH) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	SETT_SELL = CONVERT(VARCHAR,SETT_SALES) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END,
	DELIVERY = CONVERT(VARCHAR,NORMAL) + ' ' + CASE WHEN VAL_PERC ='P' THEN '%' ELSE 'VALUE' END
FROM BROKTABLE (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_FOBILLVALAN_CHRG
-- --------------------------------------------------




CREATE VIEW [dbo].[CLS_FOBILLVALAN_CHRG]
AS
SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,
SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,F.SERVICE_TAX,EXSER_TAX,
INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,
SUB_BROKER,STATUSNAME,F.EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,TRACK,AREA,
TOT_SERVICETAX=(F.SERVICE_TAX-F.EXSER_TAX)- ((
CASE 
	WHEN ISNULL(SBCCHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100) 
	ELSE 0 
END) + (
CASE 
	WHEN ISNULL(KRISHICHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100) 
	ELSE 0 
END)
),
SBC_CHRG = (CASE WHEN ISNULL(SBCCHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100) ELSE 0 END),
KRISHI_CHRG = (CASE WHEN ISNULL(KRISHICHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100) ELSE 0 END)
FROM FOBILLVALAN F LEFT OUTER JOIN FOGLOBALS G ON F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.DELCLTVIEW
-- --------------------------------------------------

CREATE VIEW DELCLTVIEW AS
SELECT SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,  
BUYQTY=SUM(CASE WHEN INOUT = 'O' THEN QTY ELSE 0 END),  
SELLQTY=SUM(CASE WHEN INOUT = 'I' THEN QTY ELSE 0 END)  
FROM DELIVERYCLT  
GROUP BY SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.DELCODE
-- --------------------------------------------------

CREATE VIEW DELCODE AS
SELECT * FROM DELIVERY_DELCODE

GO

-- --------------------------------------------------
-- VIEW dbo.DELIVERY_OBL_CLOSEOUT_VIEW
-- --------------------------------------------------
  
CREATE VIEW [dbo].[DELIVERY_OBL_CLOSEOUT_VIEW]      
AS      
      
SELECT       
 DEL_REC_NO,REPORT_DATE=MIN(ISNULL(REPDT,REPORT_DATE)),CM_PRIMARY_CODE,SYMBOL,WAREHOUSE,      
 PAYIN_QTY= SUM(CASE WHEN REPDT IS NULL THEN 0 ELSE PAYIN_QTY END),      
 PAYOUT_QTY= SUM(CASE WHEN REPDT IS NULL THEN 0 ELSE PAYOUT_QTY END),      
 PAYIN_VALUE = SUM(PAYIN_VALUE) ,      
 PAYOUT_VALUE = SUM(PAYOUT_VALUE),      
 D_SETT_TYPE,D_SETT_NO,D_ISIN,CLOSE_TYPE,      
 MARKUP=MAX(MARKUP),PRICE=MAX(PRICE),SETT_TYPE,SETT_NO,ISIN      
FROM       
DELIVERY_OBL_CLOSEOUT D (NOLOCK)      
LEFT OUTER JOIN      
(      
 SELECT REPDT = MIN(REPORT_DATE),      
 SETTTYPE = SETT_TYPE,      
 SETTNO = SETT_NO      
 FROM DELIVERY_OBL_CLOSEOUT (NOLOCK)       
 GROUP BY SETT_TYPE,SETT_NO      
) T      
ON (SETTTYPE = SETT_TYPE AND SETTNO = SETT_NO      
AND REPDT = REPORT_DATE)      
GROUP BY      
 DEL_REC_NO,CM_PRIMARY_CODE,SYMBOL,WAREHOUSE,       
 D_SETT_TYPE,D_SETT_NO,D_ISIN,CLOSE_TYPE,SETT_TYPE,SETT_NO,ISIN

GO

-- --------------------------------------------------
-- VIEW dbo.Delivery_Rpt_NCDXDelGetView
-- --------------------------------------------------
CREATE  View Delivery_Rpt_NCDXDelGetView As
select Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
PayOut_Qty=Sum(PayOut_Qty),WareHouse from DELIVERY_OBL_NET
Where PayOut_Qty > 0 
Group By Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,WareHouse

GO

-- --------------------------------------------------
-- VIEW dbo.Delivery_Rpt_NCDXDelGiveView
-- --------------------------------------------------
CREATE  View Delivery_Rpt_NCDXDelGiveView As
select Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
PayIn_Qty=Sum(PayIn_Qty),WareHouse from DELIVERY_OBL_NET
Where PayIn_Qty > 0 
Group By Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,WareHouse

GO

-- --------------------------------------------------
-- VIEW dbo.Delivery_Rpt_NCDXDelNet
-- --------------------------------------------------



CREATE  View Delivery_Rpt_NCDXDelNet As
select Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
WareHouse,PayIn_Qty=Sum(PayIn_Qty),PayOut_Qty=Sum(PayOut_Qty) from DELIVERY_OBL_NET
Group By Sett_Type,Sett_no,Inst_Type,Symbol,Expiry_Date,Strike_Price,Option_Type,
WareHouse

GO

-- --------------------------------------------------
-- VIEW dbo.DELIVERY_SLIPMST
-- --------------------------------------------------

CREATE VIEW DELIVERY_SLIPMST AS
SELECT * FROM DELSLIPMST

GO

-- --------------------------------------------------
-- VIEW dbo.DELIVERYCLT
-- --------------------------------------------------

CREATE VIEW DELIVERYCLT AS
SELECT SETT_NO,SETT_TYPE,SCRIP_CD=SYMBOL,SERIES='EQ',PARTY_CODE,
QTY=Total_Allocated_Qty,
INOUT = CASE WHEN SELL_BUY = 'S' THEN 'I' ELSE 'O' END,
BRANCH_CD='HO',PARTIPANTCODE=MEMBERCODE,WAREHOUSE
FROM DELIVERY_OBL_CLT (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.DELNET
-- --------------------------------------------------

CREATE VIEW DELNET AS
SELECT SETT_NO,SETT_TYPE,SCRIP_CD=SYMBOL,SERIES='EQ',
QTY=SUM(Total_Allocated_Qty),
INOUT = CASE WHEN SELL_BUY = 'S' THEN 'I' ELSE 'O' END
FROM DELIVERY_OBL_CLT (NOLOCK) 
GROUP BY SETT_NO,SETT_TYPE,SYMBOL,SELL_BUY

GO

-- --------------------------------------------------
-- VIEW dbo.DELSEGMENT
-- --------------------------------------------------

CREATE VIEW DELSEGMENT AS
SELECT * FROM DELIVERY_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.DELTRANS
-- --------------------------------------------------

CREATE VIEW DELTRANS
AS

SELECT SNO,SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD=SYMBOL,SERIES='EQ',EXPIRYDATE=EXPIRY_DATE,WAREHOUSE,QTY,FROMNO,TONO,CERTNO=ISIN,FOLIONO,
HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,
SHARETYPE,TRANSDATE,FILLER1,FILLER2=ACTIVE,FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5
FROM DELIVERY_TRANSACTION (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.DELTRANSTEMP
-- --------------------------------------------------

CREATE VIEW DELTRANSTEMP AS
SELECT SNO,SETT_NO,SETT_TYPE,REFNO,TCODE,TRTYPE,PARTY_CODE,SCRIP_CD=SYMBOL,SERIES='EQ',EXPIRYDATE=EXPIRY_DATE,WAREHOUSE,
QTY,FROMNO,TONO,CERTNO=ISIN,FOLIONO,HOLDERNAME,REASON,DRCR,DELIVERED,ORGQTY,DPTYPE,DPID,CLTDPID,BRANCHCD,PARTIPANTCODE,
SLIPNO,BATCHNO,ISETT_NO,ISETT_TYPE,SHARETYPE,TRANSDATE,FILLER1,FILLER2,FILLER3,BDPTYPE,BDPID,BCLTDPID,FILLER4,FILLER5
FROM DELIVERY_TRANSACTIONTEMP

GO

-- --------------------------------------------------
-- VIEW dbo.DEMATTRANS
-- --------------------------------------------------

CREATE VIEW DEMATTRANS
AS
SELECT SNO,
SETT_NO,
SETT_TYPE,
REFNO,
TCODE,
TRTYPE,
PARTY_CODE,
SCRIP_CD=SYMBOL,
SERIES='EQ',
QTY,
TRDATE,
CLTACCNO,
DPID,
DPNAME,
ISIN,
BRANCH_CD,
PARTIPANTCODE,
DPTYPE,
TRANSNO,
DRCR,
BDPTYPE,
BDPID,
BCLTACCNO,
FILLER1,
FILLER2,
FILLER3,
FILLER4,
FILLER5 FROM DELIVERY_DEMAT_TRANS (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.ea_foexallocsalepur
-- --------------------------------------------------







/****** Object:  View dbo.ea_foexallocsalepur    Script Date: 09/10/2001 6:26:40 PM ******/

/****** Object:  View dbo.ea_foexallocsalepur    Script Date: 09/07/2001 10:35:19 PM ******/


/****** Object:  View dbo.ea_foexallocsalepur    Script Date: 9/7/2001 4:09:00 PM ******/



CREATE  view ea_foexallocsalepur
as

select  party_code=t1.foeatrd_party_code,inst_type=t1.foeatrd_inst_type,
	symbol=t1.foeatrd_symbol,sec_name=t1.foeatrd_sec_name,expirydate=t1.foeatrd_expirydate,
	strike_price=t1.foeatrd_strike_price ,option_type=t1.foeatrd_option_type,
        sell_buy=t1.foeatrd_sell_buy, tradeqty=t1.foeatrd_tradeqty ,
      	pqty = isnull((select sum(foeatrd_tradeqty) from foexalloctrade where 
                foexalloctrade.foeatrd_party_code = t1.foeatrd_party_code and
                foexalloctrade.foeatrd_inst_type=t1.foeatrd_inst_type and 
                foexalloctrade.foeatrd_symbol=t1.foeatrd_symbol and 
                foexalloctrade.foeatrd_expirydate=t1.foeatrd_expirydate  and
                foexalloctrade.foeatrd_strike_price=t1.foeatrd_strike_price and  
                foexalloctrade.foeatrd_option_type=t1.foeatrd_option_type 
                and foexalloctrade.foeatrd_sell_buy = 1),0),

        Sqty =isnull( (select sum(foeatrd_tradeqty) from foexalloctrade where 
                foexalloctrade.foeatrd_party_code = t1.foeatrd_party_code and
                foexalloctrade.foeatrd_inst_type=t1.foeatrd_inst_type and
	foexalloctrade.foeatrd_symbol=t1.foeatrd_symbol and
	foexalloctrade.foeatrd_expirydate=t1.foeatrd_expirydate and
                foexalloctrade.foeatrd_strike_price=t1.foeatrd_strike_price and 
                foexalloctrade.foeatrd_option_type=t1.foeatrd_option_type 
                and foexalloctrade.foeatrd_sell_buy = 2),0)
from foexalloctrade t1

GO

-- --------------------------------------------------
-- VIEW dbo.ExerciseAssignmentView
-- --------------------------------------------------







/****** Object:  View dbo.ExerciseAssignmentView    Script Date: 09/10/2001 6:26:40 PM ******/

/****** Object:  View dbo.ExerciseAssignmentView    Script Date: 09/07/2001 10:35:19 PM ******/


/****** Object:  View dbo.ExerciseAssignmentView    Script Date: 9/7/2001 4:09:00 PM ******/


CREATE  VIEW ExerciseAssignmentView 
AS
SELECT DISTINCT b.sauda_date,b.party_code,b.inst_type,b.symbol,b.option_type,b.strike_price,b.markettype,b.expirydate ,
EAPayable = (SELECT DISTINCT isnull(SUM(a.tradeqty*a.price),0) 
FROM fosettlement a WHERE a.sauda_date = b.sauda_date AND 
a.party_code = b.party_code AND a.strike_price = b.strike_price 
AND a.option_type = b.option_type AND a.expirydate=b.expirydate and
a.inst_type = b.inst_type AND a.sell_buy = 2
and a.auctionpart = 'EA'),

EAReceivable = (SELECT isnull(SUM(c.tradeqty*c.price),0)
FROM fosettlement c WHERE c.sauda_date = b.sauda_date AND 
c.party_code = b.party_code AND c.strike_price = b.strike_price AND 
c.option_type = b.option_type AND c.expirydate=b.expirydate and c.inst_type = b.inst_type AND c.sell_buy =1 and c.auctionpart = 'EA'), 


NetEA = ((SELECT isnull(SUM(d.tradeqty*d.price),0) FROM fosettlement d
 WHERE d.sauda_date = b.sauda_date AND d.party_code = b.party_code AND 
d.strike_price = b.strike_price AND d.option_type = b.option_type AND d.expirydate=b.expirydate and
d.inst_type = b.inst_type AND d.sell_buy = 2 and d.auctionpart = 'EA') - 
(SELECT isnull(SUM(e.tradeqty*e.price),0) FROM fosettlement e 
WHERE e.sauda_date = b.sauda_date AND e.party_code = b.party_code AND
 e.strike_price = b.strike_price AND e.option_type = b.option_type AND e.expirydate=b.expirydate and
e.inst_type = b.inst_type AND e.sell_buy = 1 and e.auctionpart = 'EA')), 
b.sec_name,pqty = ( case when b.sell_buy = 1 then sum(b.tradeqty) else 0 end ),
sqty = ( case when b.sell_buy = 2 then sum(b.tradeqty) else 0 end )
FROM fosettlement b 
WHERE LEFT(rtrim(ltrim(inst_type)),3) = 'OPT' 
and b.auctionpart = 'EA'
GROUP BY b.party_code,b.inst_type,b.symbol,b.option_type,b.strike_price,b.markettype,b.expirydate,b.sec_name, b.sauda_date ,b.sell_buy

GO

-- --------------------------------------------------
-- VIEW dbo.Expirynetposview_Final
-- --------------------------------------------------

CREATE View Expirynetposview_Final  
As  
  
Select S.Party_Code,s.Inst_Type,s.Symbol,s.Strike_Price,s.Option_Type,sec_Name=Left(S.Inst_Type,3)+S.Symbol+Left(Convert(Varchar,s.Expirydate,109),11),s.Expirydate,  
S.Sauda_Date,  
Pqty = ( Case When Sell_Buy = 1 Then Sum(S.Tradeqty) Else 0 End ),  
Sqty = ( Case When Sell_Buy = 2 Then Sum(S.Tradeqty) Else 0 End ),netrate,price,  
Participantcode = (Case When (Participantcode = '' Or Participantcode Is Null)   
   Then (Select Ltrim(Rtrim(Isnull(Membercode,''))) From FoOwner)  
   Else Ltrim(Rtrim(Participantcode))  
   End)  
From FoSettlement S  
where  
--(auctionpart <> 'EA' and inst_type like 'FUT%'  
--or auctionpart <> 'CA' and inst_type like 'OPT%')  
S.Reserved1 = '0'   
Group By S.Party_Code,s.Inst_Type,s.Symbol,s.Strike_Price,s.Option_Type,s.Expirydate,  
S.Sauda_Date,s.Sell_Buy,s.Netrate,s.Price,participantcode

GO

-- --------------------------------------------------
-- VIEW dbo.FOBAsalepur
-- --------------------------------------------------

CREATE  VIEW FOBAsalepur AS  
/*select t1.trade_no, t1.party_code,t1.series_code,t1.sell_buy,t1.tradeqty,  
pqty = (select sum(tradeqty) from bfotrade where   
                   bfotrade.party_code = t1.party_code  
               and bfotrade.series_code = t1.series_code  
               and bfotrade.sell_buy = 1),  
Sqty = (select sum(tradeqty) from bfotrade where   
                   bfotrade.party_code = t1.party_code  
               and bfotrade.series_code = t1.series_code  
               and bfotrade.sell_buy = 2)  
from bfotrade t1*/  
  
/*  Remove Tradeqty to make it unique for a Party and Scrip  */  
  
select  t1.party_code,t1.inst_type,t1.symbol,t1.expirydate  ,t1.strike_price ,t1.option_type,  
      pqty = isnull(Sum(Case When Sell_Buy = 1 Then tradeqty Else 0 End),0),  
      sqty = isnull(Sum(Case When Sell_Buy = 2 Then tradeqty Else 0 End),0)  
from fotrade t1  
GROUP BY t1.party_code,t1.inst_type,t1.symbol,t1.expirydate ,t1.strike_price  ,t1.option_type

GO

-- --------------------------------------------------
-- VIEW dbo.FOBILLVALAN_CHRG
-- --------------------------------------------------


CREATE VIEW [dbo].[FOBILLVALAN_CHRG]
AS
SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,F.SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,F.EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,TRACK,NUMERATOR,DENOMINATOR,REGULARLOT,AREA,
TOT_SERVICETAX=(F.SERVICE_TAX-F.EXSER_TAX)- ((
CASE 
	WHEN ISNULL(SBCCHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100) 
	ELSE 0 
END) + (
CASE 
	WHEN ISNULL(KRISHICHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100) 
	ELSE 0 
END)
),
SBC_CHRG = (CASE WHEN ISNULL(SBCCHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100) ELSE 0 END),
KRISHI_CHRG = (CASE WHEN ISNULL(KRISHICHARGE,0) > 0 THEN (((F.SERVICE_TAX-F.EXSER_TAX) * 100 / G.SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100) ELSE 0 END)
FROM FOBILLVALAN F LEFT OUTER JOIN FOGLOBALS G ON F.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.FOBILLVALAN_PARENT
-- --------------------------------------------------


CREATE VIEW [DBO].[FOBILLVALAN_PARENT] 
AS

SELECT 
	PARTY_CODE=PARENTCODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,
	EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,
	SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,EXCL_CHRG,SERVICE_TAX,EXSER_TAX,
	INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,F.OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,
	FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,F.EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,
	REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,TRACK,AREA,NUMERATOR,DENOMINATOR
FROM 
	FOBILLVALAN F (NOLOCK), CLIENT2_VIEW (NOLOCK)
WHERE 
	F.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKEXALLOCVIEW
-- --------------------------------------------------








/****** Object:  View dbo.FOBROKEXALLOCVIEW    Script Date: 09/10/2001 6:26:40 PM ******/

/****** Object:  View dbo.FOBROKEXALLOCVIEW    Script Date: 09/07/2001 10:35:19 PM ******/


/****** Object:  View dbo.FOBROKEXALLOCVIEW    Script Date: 9/7/2001 4:09:01 PM ******/


/****** Object:  View dbo.FOBROKEXALLOCVIEW    Script Date: 8/7/01 4:28:27 PM ******/

/****** Object:  View dbo.FOBROKEXALLOCVIEW    Script Date: 7/25/01 10:05:15 PM ******/




CREATE  VIEW FOBROKEXALLOCVIEW AS
select 

f.foeatrd_Trade_no as trade_no,f.foeatrd_party_code as party_code,f.foeatrd_inst_type as inst_type,f.foeatrd_symbol as symbol,
f.foeatrd_sec_name as sec_name,f.foeatrd_expirydate as expirydate,f.foeatrd_strike_price as strike_price,
f.foeatrd_option_type as option_type,f.foeatrd_tradeqty as tradeqty,f.foeatrd_MarketType as markettype,
       f.foeatrd_user_id as user_id,f.foeatrd_order_no as order_no,f.foeatrd_price as price,f.foeatrd_Pro_cli as pro_cli,
f.foeatrd_O_C_flag as o_c_flag,f.foeatrd_C_U_flag as c_u_flag,f.foeatrd_activitytime as activitytime,f.foeatrd_sell_buy as sell_buy,
       f.foeatrd_settflag as settflag,dummy2,Brok3_TableNo,Brok_Scheme,Tran_Cat,Off_phone1,f.foeatrd_cl_rate as cl_rate,
MPrice = /*(CASE WHEN C2.Dummy1 = 0 
	       THEN f.foeatrd_PRICE 
	       Else
		   (Case When C2.Dummy1 = 1 
			 Then (Case When f.foeatrd_Strike_Price = 0 Then f.foeatrd_Price Else f.foeatrd_Strike_Price End ) 			
	                 Else f.foeatrd_Strike_price + f.foeatrd_PRICE  
		    END)
	  END),*/
f.foeatrd_cl_rate,
MultiPlier = ( Case When ( Brok_Scheme = 4 or Brok_Scheme = 5 or Brok_Scheme = 6) 
		Then ceiling(Convert(numeric(19,2),f.foeatrd_TradeQty) / Convert(numeric(19,2),C_Regular_Lot))
		Else  1
	      End)		
from foexalloctrade F, Client2 C2,FoScrip2 S2,Client1 C1
where c2.Party_Code = f.foeatrd_Party_Code 
and C1.Cl_Code = C2.Cl_Code
and f.foeatrd_inst_type = S2.inst_type 
AND f.foeatrd_SYMBOL = S2.SYMBOL      
AND f.foeatrd_expirydate = S2.expirydate
and f.foeatrd_option_type = S2.option_type 
And f.foeatrd_Strike_Price = S2.Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW
-- --------------------------------------------------

CREATE  VIEW FOBROKVIEW 
AS
Select F.Trade_No,  
Status,F.Inst_Type,F.Symbol,F.Expirydate,  F.Strike_price,F.Option_type,F.Sec_Name,BookType,BookTypeName,MarKetType,
User_Id,
Branch_Id=(case when (select membertype from foowner) = 'CM' then tmpartycode else branch_id end),
Sell_Buy,TradeQty,Price,
Pro_cli,
F.Party_Code,ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,
Order_No,Opp_Broker_Id,settflag,C2.Std_Rate,C2.Brok2_TableNo,C2.Brok_Scheme,Tran_Cat,Off_phone1,c2.Dummy6,C2.Dummy7,cl_type,
MPrice = (CASE WHEN ((C2.Dummy1 = 0) Or (C2.Dummy1 = 20))
        THEN PRICE 
        Else
     (Case When (C2.Dummy1 = 1 Or C2.Dummy1 = 21 ) 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END),
MultiPlier = ( Case When ( C2.Brok_Scheme = 4 or C2.Brok_Scheme = 5 or C2.Brok_Scheme = 6 or C2.Brok_Scheme = 24 or C2.Brok_Scheme = 25 or C2.Brok_Scheme = 26)  
  Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/(Case When TradeQty = 0 Then 1 else TradeQty End)
  Else  1
       End), 
TaxPrice = (CASE WHEN ((C2.Dummy1 = 0) Or (C2.Dummy1 = 20))
        THEN PRICE 
        Else
     (Case When (C2.Dummy1 = 1 Or C2.Dummy1 = 21 ) 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END) ,Reserved2
from fotrade F, FoTrd_Client2  C2,FoTrd_FoScrip2 S2,FoTrd_Client1 C1, FOOwner
where c2.Party_Code = F.Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.inst_type = S2.inst_type 
AND F.SYMBOL = S2.SYMBOL      
AND F.expirydate = S2.expirydate
and F.option_type = S2.option_type 
And F.Strike_Price = S2.Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW_EXALLOC
-- --------------------------------------------------






/****** Object:  View dbo.FOBROKVIEW_EXALLOC    Script Date: 09/10/2001 6:26:40 PM ******/
/****** Object:  View dbo.FOBROKVIEW_EXALLOC    Script Date: 09/07/2001 10:35:19 PM ******/
/****** Object:  View dbo.FOBROKVIEW_EXALLOC    Script Date: 9/7/2001 4:09:01 PM ******/
CREATE  VIEW FOBROKVIEW_EXALLOC
 AS
select trade_no=f.foeatrd_Trade_No,status=f.foeatrd_Status,inst_type=F.foeatrd_Inst_Type,symbol=F.foeatrd_Symbol,
expirydate=F.foeatrd_Expirydate,strike_price=F.foeatrd_Strike_price,option_type=F.foeatrd_Option_type,
sec_name=F.foeatrd_Sec_Name,BookType='1',BookTypeName='RL',markettype=foeatrd_MarKetType,
user_id=foeatrd_User_Id,Branch_Id='1',sell_buy=foeatrd_Sell_Buy,tradeqty=foeatrd_TradeQty,price=foeatrd_Price,
pro_cli=foeatrd_Pro_cli,party_code=F.foeatrd_Party_Code,ParticipantCode='',
o_c_flag=foeatrd_O_C_Flag,c_u_flag=foeatrd_C_U_Flag,activitytime=foeatrd_ActivityTime,Last_Mod_time=foeatrd_activitytime,
order_no=foeatrd_Order_No,Opp_Broker_Id='',settflag=foeatrd_settflag,dummy2,Brok_Scheme,Tran_Cat,Off_phone1,
MPrice = /*(CASE WHEN C2.Dummy1 = 0 
	       THEN foeatrd_PRICE 
	       Else
		   (Case When C2.Dummy1 = 1 
			 Then (Case When F.foeatrd_Strike_Price = 0 Then F.foeatrd_Price Else F.foeatrd_Strike_Price End ) 			
	                 Else F.foeatrd_Strike_price + foeatrd_PRICE  
		    END)
	  END),*/
f.foeatrd_cl_rate,
MultiPlier = ( Case When ( Brok_Scheme = 4 or Brok_Scheme = 5 or Brok_Scheme = 6) 
		Then ceiling(Convert(numeric(19,2),foeatrd_TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/(Case When foeatrd_TradeQty = 0 Then 1 else foeatrd_TradeQty End)
		Else  1
	      End),
cl_rate=foeatrd_cl_rate		
from foexalloctrade F, Client2 C2,FoScrip2 S2,Client1 C1
where c2.Party_Code = F.foeatrd_Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.foeatrd_inst_type = S2.inst_type 
AND F.foeatrd_SYMBOL = S2.SYMBOL      
AND F.foeatrd_expirydate = S2.expirydate
and F.foeatrd_option_type = S2.option_type 
And F.foeatrd_Strike_Price = S2.Strike_Price
and f.foeatrd_tradeqty <> 0

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW_expiry
-- --------------------------------------------------






/*
drop VIEW FOBROKVIEW_expiry
*/
/****** Object:  View dbo.FOBROKVIEW    Script Date: 03/21/2002 2:11:53 PM ******/
/****** Object:  View dbo.FOBROKVIEW    Script Date: 01/23/2002 2:36:42 PM ******/
CREATE  VIEW FOBROKVIEW_expiry
AS
Select F.Trade_No,  
Status,F.Inst_Type,F.Symbol,F.Expirydate,  F.Strike_price,F.Option_type,F.Sec_Name,BookType,BookTypeName,MarKetType,
User_Id,
Branch_Id=(case when (select membertype from foowner) = 'CM' then tmpartycode else branch_id end),
Sell_Buy,TradeQty,Price,
/*Pro_cli = ( Case When Cl_type = 'PRO' then 1 Else 2 end ),*/
Pro_cli,
F.Party_Code,ParticipantCode,O_C_Flag,C_U_Flag,ActivityTime,Last_Mod_time,
Order_No,Opp_Broker_Id,settflag,C2.Std_Rate,C2.Brok1_TableNo,C2.Brok_Scheme,Tran_Cat,Off_phone1,c2.Dummy6,C2.Dummy7,cl_type,
MPrice = /*(CASE WHEN ((C2.Dummy1 = 0) Or (C2.Dummy1 = 20))
        THEN PRICE 
        Else
     (Case When (C2.Dummy1 = 1 Or C2.Dummy1 = 21 ) 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END),*/
/* COMMENTED BY UPPILI KRISHNAN */
/*
 isnull(( select fofinalclosing.cl_rate from fofinalclosing
                         where 
                            f.expirydate = fofinalclosing.closingdate
                                        and fofinalclosing.UnderlyingAsset=f.symbol   
                         
                     
           ),isnull(( select foclosing_billreport.cl_rate from foclosing_billreport
                         where left(convert(varchar,foclosing_billreport.trade_date,109),11)  like left(convert(varchar,f.expirydate,109),11)
                         and foclosing_billreport.Inst_Type = f.inst_type and foclosing_billreport.symbol=f.symbol 
                          and foclosing_billreport.strike_price=f.strike_price and foclosing_billreport.option_type =f.option_type 
                         and convert(varchar,foclosing_billreport.expirydate,103) = convert(varchar,f.expirydate,103)
                     
           ),0)), */
f.price,
MultiPlier = ( Case When ( C2.Brok_Scheme = 4 or C2.Brok_Scheme = 5 or C2.Brok_Scheme = 6 or C2.Brok_Scheme = 24 or C2.Brok_Scheme = 25 or C2.Brok_Scheme = 26)  
  Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/(Case When TradeQty = 0 Then 1 else TradeQty End)
  Else  1
       End), 
TaxPrice = (CASE WHEN TaxesFlag = 0 
        THEN PRICE 
        Else
     (Case When TaxesFlag = 1 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END) 
from fotrade F, Client2 C2,FoScrip2 S2,Client1 C1, FOOwner
where c2.Party_Code = F.Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.inst_type = S2.inst_type 
AND F.SYMBOL = S2.SYMBOL      
AND F.expirydate = S2.expirydate
and F.option_type = S2.option_type 
And F.Strike_Price = S2.Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.FoBrokviewFinal
-- --------------------------------------------------




CREATE VIEW [dbo].[FoBrokviewFinal]   
AS  
SELECT   
TRADE_NO,STATUS,FOBROKVIEW.INST_TYPE,FOBROKVIEW.SYMBOL,  
FOBROKVIEW.EXPIRYDATE,FOBROKVIEW.STRIKE_PRICE,FOBROKVIEW.OPTION_TYPE,  
FOBROKVIEW.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,  
BRANCH_ID,FOBROKVIEW.SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
FOBROKVIEW.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,  
ACTIVITYTIME,LAST_MOD_TIME,TRAN_CAT,OFF_PHONE1,  
ORDER_NO,OPP_BROKER_ID,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,  
BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,  
BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,  
BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,FOCLIENTTAXES.ROUND_TO,FOCLIENTTAXES.ROFIG,  
FOCLIENTTAXES.ERRNUM,FOCLIENTTAXES.NOZERO,  
FOTAXES.INSURANCE_CHRG,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,  
SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE, C_REGULAR_LOT,  
BROKAPPLIED = (((  CASE    
 WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 1)  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 2)  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW.SELL_BUY = 1)  
 THEN    
  ((FLOOR ( (((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * (FOBROKVIEW.MPRICE)) /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO) +  
  FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) *  
  (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW.SELL_BUY = 2)  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW.MPRICE)) /100 )* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC* (FOBROKVIEW.MPRICE)) /100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * (FOBROKVIEW.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )  
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 ELSE  0   
 END  ) )) ,  
INS_CHRG  = ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW.INST_TYPE,3) ='FUT' THEN FUT_INSURANCE_CHRG ELSE OPT_INSURANCE_CHRG END  
  * (FOBROKVIEW.MPRICE) * FOBROKVIEW.TRADEQTY * BOOKTYPE / BOOKTYPENAME)  
  /100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /POWER(10,FOCLIENTTAXES.ROUND_TO)),  
  
TURN_TAX  =  ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW.INST_TYPE,3) ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END   
   * ((( FOBROKVIEW.MPRICE) * FOBROKVIEW.TRADEQTY) * BOOKTYPE)/BOOKTYPENAME)   
  /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+ FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /(FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /POWER(10,FOCLIENTTAXES.ROUND_TO)),  
  
OTHER_CHRG = ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW.INST_TYPE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  
   * (FOBROKVIEW.TAXPRICE) * FOBROKVIEW.TRADEQTY * BOOKTYPE / BOOKTYPENAME)   
  /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO)),  
  
SEBI_TAX =     ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW.INST_TYPE,3) ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  
   *(FOBROKVIEW.TAXPRICE) * FOBROKVIEW.TRADEQTY * BOOKTYPE / BOOKTYPENAME)  
  /100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG +  
  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO)),  
BROKER_CHRG =  0,  
  
CPID=Opp_Broker_Id,INSTRUMENT=0,TMARK=0,SCHEME=BROK_SCHEME,DUMMY1=0,RESERVED1,RESERVED2=FOBROKVIEW.RESERVED2,CL_TYPE,  
DUMMY2 =   
 (CASE    
 WHEN (FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 1)  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 2)  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )   
 THEN   
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )  
 THEN   
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /   
  POWER(10,FOCLIENTTAXES.ROUND_TO))  
 ELSE  0   
 END )   
FROM  
(  
 SELECT F.TRADE_NO,    
 STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,  
 BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,  
 BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),  
 SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
 F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,  
 ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK2_TABLENO,TRAN_CAT,  
 OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,CL_TYPE,  
 MPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))  
         THEN PRICE   
         ELSE  
      (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )   
     THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                    ELSE F.STRIKE_PRICE + PRICE    
       END)  
    END),  
 MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR  
   C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)    
   THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/  
  (CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)  
   ELSE  1  
        END),   
 TAXPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))  
         THEN PRICE   
         ELSE  
      (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )   
     THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                    ELSE F.STRIKE_PRICE + PRICE    
       END)  
    END) ,RESERVED2,C_REGULAR_LOT,RESERVED3,RESERVED1  
 FROM FOTRADE F, FOTRD_CLIENT2  C2,FOTRD_FOSCRIP2 S2,FOTRD_CLIENT1 C1, FOOWNER  
 WHERE C2.PARTY_CODE = F.PARTY_CODE   
 AND C1.CL_CODE = C2.CL_CODE  
 AND F.INST_TYPE = S2.INST_TYPE   
 AND F.SYMBOL = S2.SYMBOL        
 AND F.EXPIRYDATE = S2.EXPIRYDATE  
 AND F.OPTION_TYPE = S2.OPTION_TYPE   
 AND F.STRIKE_PRICE = S2.STRIKE_PRICE  
)FOBROKVIEW,  
FOTRD_BROKTABLE BROKTABLE,  
FOTAXES ,  
FOGLOBALS ,  
FOTRD_CLIENTTAXES FOCLIENTTAXES,  
FOTRD_CLIENTBROKSCHEME FOCLIENTBROKSCHEME  
  
WHERE   
 FOBROKVIEW.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND   
 FOBROKVIEW.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND  
 FOBROKVIEW.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND    FOBROKVIEW.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND  
 BROKTABLE.TABLE_NO =( CASE  WHEN LEFT(FOBROKVIEW.INST_TYPE,3) = 'FUT' THEN FUT_BROKTABLE ELSE OPT_BROKTABLE END) AND      
 BROKTABLE.TRD_DEL = FOBROKVIEW.RESERVED3 
 AND MPRICE >= BROKTABLE.LOWER_LIM 
 AND MPRICE < BROKTABLE.UPPER_LIM 
 AND FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE FOBROKVIEW.TRAN_CAT END ) 
 --And LEFT(FOBROKVIEW.INST_TYPE,3) = FOTAXES.INST_TYPE    
 and FOTAXES.EXCHANGE = 'NCE' 
 AND FOBROKVIEW.ACTIVITYTIME BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE 
 AND FOBROKVIEW.ACTIVITYTIME BETWEEN FOGLOBALS.YEAR_START_DT AND FOGLOBALS.YEAR_END_DT

GO

-- --------------------------------------------------
-- VIEW dbo.fobrokviewFinal_expiry
-- --------------------------------------------------

	
	CREATE VIEW [dbo].[fobrokviewFinal_expiry]
AS
SELECT TRADE_NO,STATUS,FOBROKVIEW_EXPIRY.INST_TYPE,FOBROKVIEW_EXPIRY.SYMBOL,FOBROKVIEW_EXPIRY.EXPIRYDATE,FOBROKVIEW_EXPIRY.STRIKE_PRICE,FOBROKVIEW_EXPIRY.OPTION_TYPE,
FOBROKVIEW_EXPIRY.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,FOBROKVIEW_EXPIRY.SELL_BUY,TRADEQTY,PRICE,PRO_CLI,
FOBROKVIEW_EXPIRY.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,TRAN_CAT,OFF_PHONE1,
ORDER_NO,OPP_BROKER_ID,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,
BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,
BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,FOCLIENTTAXES.ROUND_TO,FOCLIENTTAXES.ROFIG,FOCLIENTTAXES.ERRNUM,FOCLIENTTAXES.NOZERO,
FOTAXES.INSURANCE_CHRG,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,
SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE, C_REGULAR_LOT,
BROKAPPLIED = (((  CASE  
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)
                               THEN  
                                          ((FLOOR ( (((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW_EXPIRY.MPRICE))  /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO) + 
FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))
                        WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL* (FOBROKVIEW_EXPIRY.MPRICE))  /100 )* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' ) 
                            THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' ) 
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                   WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                  WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )
  THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * (FOBROKVIEW_EXPIRY.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
             WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES* (FOBROKVIEW_EXPIRY.MPRICE)) /100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' ) 
                            THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' ) 
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                   
WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                  WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXPIRY.MPRICE))/ 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
             WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXPIRY.MPRICE))/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
  POWER(10,FOCLIENTTAXES.ROUND_TO))
   ELSE  0 
                        END 
                         ) ) ),
INS_CHRG  = ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW_EXPIRY.INST_TYPE,3) ='FUT' THEN FUT_INSURANCE_CHRG ELSE OPT_INSURANCE_CHRG END
		* (FOBROKVIEW_EXPIRY.MPRICE) * FOBROKVIEW_EXPIRY.TRADEQTY *
		BOOKTYPE  / BOOKTYPENAME)/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + 
		FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + 
		FOCLIENTTAXES.NOZERO ) ) /POWER(10,FOCLIENTTAXES.ROUND_TO)),

TURN_TAX  =  ((FLOOR(( (((CASE WHEN LEFT(FOBROKVIEW_EXPIRY.INST_TYPE,3) ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END  
	 * (FOBROKVIEW_EXPIRY.MPRICE) * FOBROKVIEW_EXPIRY.TRADEQTY * 
	BOOKTYPE  / BOOKTYPENAME) )/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+ FOCLIENTTAXES.ROFIG +
	FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /
	POWER(10,FOCLIENTTAXES.ROUND_TO)),

OTHER_CHRG = ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW_EXPIRY.INST_TYPE,3) ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END
		 * (FOBROKVIEW_EXPIRY.TAXPRICE) * FOBROKVIEW_EXPIRY.TRADEQTY * BOOKTYPE  / BOOKTYPENAME )/100 ) *
		POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG +
		FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO)),

SEBI_TAX =     ((FLOOR(( ((CASE WHEN LEFT(FOBROKVIEW_EXPIRY.INST_TYPE,3) ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END
	 *(FOBROKVIEW_EXPIRY.TAXPRICE) * FOBROKVIEW_EXPIRY.TRADEQTY * BOOKTYPE  / BOOKTYPENAME)/100) * 
	POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
	FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * 
	(FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO)),

BROKER_CHRG = 0,
CPID=0,INSTRUMENT=0,TMARK=0,SCHEME=BROK_SCHEME,DUMMY1=0,RESERVED1=0,RESERVED2=0,CL_TYPE,
DUMMY2 = 
(CASE  
                     WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
          WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' ) 
                              THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' ) 
                              THEN 
  ((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )
                              THEN 
  ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
   POWER(10,FOCLIENTTAXES.ROUND_TO))
                     ELSE  0 
 END ) 
FROM
(
	SELECT F.TRADE_NO, STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,
	F.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,USER_ID,
	BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),
	SELL_BUY,TRADEQTY,PRICE,
	PRO_CLI,
	F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,
	ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK1_TABLENO,TRAN_CAT,OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,CL_TYPE,
	MPRICE = F.PRICE,
	MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 
			OR C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)  
		  THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/
			(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)
		  ELSE  1
	       END), 
	TAXPRICE = (CASE WHEN TAXESFLAG = 0 
	        THEN PRICE 
	        ELSE
	     (CASE WHEN TAXESFLAG = 1 
	    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
	                   ELSE F.STRIKE_PRICE + PRICE  
	      END)
	   END) ,C_REGULAR_LOT
	FROM FOTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1, FOOWNER
	WHERE C2.PARTY_CODE = F.PARTY_CODE 
	AND C1.CL_CODE = C2.CL_CODE
	AND F.INST_TYPE = S2.INST_TYPE 
	AND F.SYMBOL = S2.SYMBOL      
	AND F.EXPIRYDATE = S2.EXPIRYDATE
	AND F.OPTION_TYPE = S2.OPTION_TYPE 
	AND F.STRIKE_PRICE = S2.STRIKE_PRICE
)
FOBROKVIEW_EXPIRY,BROKTABLE,
(
	SELECT  T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE  ,T1.STRIKE_PRICE ,T1.OPTION_TYPE,  
	      PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),  
	      SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
	FROM FOTRADE T1  
	GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE ,T1.STRIKE_PRICE  ,T1.OPTION_TYPE
) S,
FOTAXES ,
FOGLOBALS ,
FOCLIENTTAXES,
FOCLIENTBROKSCHEME

WHERE 
	FOBROKVIEW_EXPIRY.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND 
	FOBROKVIEW_EXPIRY.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
	FOBROKVIEW_EXPIRY.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND 
	FOBROKVIEW_EXPIRY.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND

	FOBROKVIEW_EXPIRY.PARTY_CODE = S.PARTY_CODE AND
	FOBROKVIEW_EXPIRY.INST_TYPE=S.INST_TYPE AND  
	FOBROKVIEW_EXPIRY.SYMBOL=S.SYMBOL AND
	FOBROKVIEW_EXPIRY.EXPIRYDATE=S.EXPIRYDATE  AND
	FOBROKVIEW_EXPIRY.STRIKE_PRICE = S.STRIKE_PRICE AND                 
	FOBROKVIEW_EXPIRY.OPTION_TYPE = S.OPTION_TYPE    AND  
	BROKTABLE.TABLE_NO = ( CASE WHEN (FOBROKVIEW_EXPIRY.TRAN_CAT = 'TRD')  THEN 
	                   		FUT_EXP_BROKTABLE          
					END ) AND
	BROKTABLE.LINE_NO = (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE 
				BROKTABLE.TABLE_NO = FUT_EXP_BROKTABLE   
				AND S.PARTY_CODE =  FOBROKVIEW_EXPIRY.PARTY_CODE    
					AND TRD_DEL = 'T'        
	                    	AND FOBROKVIEW_EXPIRY.MPRICE <= BROKTABLE.UPPER_LIM ) 
 AND FOTAXES.EXCHANGE = 'NCE' 
 --AND FOBROKVIEW_EXPIRY.TRAN_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE FOTAXES.TRANS_CAT END )
 AND YEAR_END_DT >= ACTIVITYTIME
 AND YEAR_START_DT <= ACTIVITYTIME
 AND ACTIVITYTIME >= FOTAXES.FROM_DATE
 AND ACTIVITYTIME <= FOTAXES.TO_DATE

GO

-- --------------------------------------------------
-- VIEW dbo.FOConfirmView
-- --------------------------------------------------


CREATE VIEW FOConfirmView As   
SELECT  FoBrokViewFinal.Trade_no,FoBrokViewFinal.party_code,FoBrokViewFinal.inst_type,FoBrokViewFinal.symbol,FoBrokViewFinal.sec_name,FoBrokViewFinal.expirydate,  
	FoBrokViewFinal.strike_price,FoBrokViewFinal.option_type,  
	FoBrokViewFinal.tradeqty,FoBrokViewFinal.MarketType,  
	FoBrokViewFinal.user_id,FoBrokViewFinal.order_no,FoBrokViewFinal.Price,FoBrokViewFinal.Pro_cli,FoBrokViewFinal.O_C_flag,FoBrokViewFinal.C_U_flag,FoBrokViewFinal.activitytime,  
	FoBrokViewFinal.Table_No,FoBrokViewFinal.Line_No,FoBrokViewFinal.Val_perc,FoBrokViewFinal.Normal,FoBrokViewFinal.day_puc,FoBrokViewFinal.day_sales,  
	FoBrokViewFinal.Sett_purch,FoBrokViewFinal.Sett_sales,FoBrokViewFinal.Sell_buy,FoBrokViewFinal.settflag,  
	FoBrokViewFinal.Insurance_chrg,FoBrokViewFinal.turnover_tax,FoBrokViewFinal.sebiturn_tax,broker_note,SerTax,year,FoBrokViewFinal.exchange,off_phone1,  
	BrokApplied ,NetRate = (Case when FoBrokViewFinal.sell_buy = 1   
	      Then FoBrokViewFinal.Price + BrokApplied   
		Else FoBrokViewFinal.Price - BrokApplied   
		End),
	Amount = (FoBrokViewFinal.Tradeqty * (Case when FoBrokViewFinal.sell_buy = 1   
		Then ( FoBrokViewFinal.Price + BrokApplied )  
		Else ( FoBrokViewFinal.Price - BrokApplied )  
		End)  * BookType ) / BookTypeName  ,
	Ins_chrg,turn_tax,FoBrokViewFinal.other_chrg,sebi_tax,Broker_chrg,  
	Service_tax = Case When c2.Service_Chrg = 1 And c2.SerTaxMethod = 1 then 0 else  
	((floor ( ((Brokapplied*TradeQty*BookType/BookTypeName)*FoBrokViewFinal.Service_Tax/100 * power(10,FoBrokViewFinal.round_to) +   
	FoBrokViewFinal.roFig + FoBrokViewFinal.errnum  ) /  (FoBrokViewFinal.RoFig + FoBrokViewFinal.Nozero)) * (FoBrokViewFinal.RoFig +  
	FoBrokViewFinal.Nozero) )  / power(10,FoBrokViewFinal.round_to)) end,	
	Trade_amount = (FoBrokViewFinal.Tradeqty * FoBrokViewFinal.Price * BookType ) / BookTypeName ,
	auctionpart = '',ParticipantCode,Status,CpId,BookTypeName as Instrument,BookType,
	BookTypeName,Branch_Id,TMark,Scheme,FoBrokViewFinal.Dummy1,  
	FoBrokViewFinal.Dummy2,Reserved1,Reserved2,cl_type ,C_Regular_Lot
FROM FoBrokViewFinal  ,Client2 c2 
Where c2.Party_Code = FoBrokViewFinal.Party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.FOConfirmView_expiry
-- --------------------------------------------------


CREATE  VIEW FOConfirmView_expiry As   
  SELECT distinct fobrokviewfinal_expiry.Trade_no,fobrokviewfinal_expiry.party_code,  
  fobrokviewfinal_expiry.inst_type,fobrokviewfinal_expiry.symbol,fobrokviewfinal_expiry.sec_name,  
  fobrokviewfinal_expiry.expirydate,fobrokviewfinal_expiry.strike_price,fobrokviewfinal_expiry.option_type,  
  fobrokviewfinal_expiry.tradeqty,fobrokviewfinal_expiry.MarketType,fobrokviewfinal_expiry.user_id,  
  fobrokviewfinal_expiry.order_no,fobrokviewfinal_expiry.Price,fobrokviewfinal_expiry.Pro_cli,  
  fobrokviewfinal_expiry.O_C_flag,fobrokviewfinal_expiry.C_U_flag,fobrokviewfinal_expiry.activitytime,  
  fobrokviewfinal_expiry.Table_No,fobrokviewfinal_expiry.Line_No,fobrokviewfinal_expiry.Val_perc,  
  fobrokviewfinal_expiry.Normal,fobrokviewfinal_expiry.day_puc,fobrokviewfinal_expiry.day_sales,  
  fobrokviewfinal_expiry.Sett_purch,fobrokviewfinal_expiry.Sett_sales,fobrokviewfinal_expiry.Sell_buy,  
  fobrokviewfinal_expiry.settflag,fobrokviewfinal_expiry.Insurance_chrg,fobrokviewfinal_expiry.turnover_tax,
  fobrokviewfinal_expiry.sebiturn_tax,broker_note,SerTax,year,  
  fobrokviewfinal_expiry.exchange,off_phone1,BrokApplied ,    
  NetRate = (Case when fobrokviewfinal_expiry.sell_buy = 1   
          Then fobrokviewfinal_expiry.Price + BrokApplied   
      Else fobrokviewfinal_expiry.Price - BrokApplied   
      End),
  Amount = ( fobrokviewfinal_expiry.Tradeqty * (Case when fobrokviewfinal_expiry.sell_buy = 1   
      Then ( fobrokviewfinal_expiry.Price + BrokApplied )  
       Else ( fobrokviewfinal_expiry.Price - BrokApplied )  
      End) *  BookType ) / BookTypeName ,
  Ins_chrg,turn_tax,fobrokviewfinal_expiry.other_chrg,sebi_tax,Broker_chrg,    
  Service_tax = Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1 then 0 else
	((floor ( (Brokapplied*TradeQty*BookType/BookTypeName*fobrokviewfinal_expiry.Service_Tax/100 * 
	power(10,fobrokviewfinal_expiry.round_to) +  
  fobrokviewfinal_expiry.roFig + fobrokviewfinal_expiry.errnum  ) /  (fobrokviewfinal_expiry.RoFig +   
  fobrokviewfinal_expiry.Nozero)) * (fobrokviewfinal_expiry.RoFig + 
  fobrokviewfinal_expiry.Nozero) )  / power(10,fobrokviewfinal_expiry.round_to)) end,    
  Trade_amount = fobrokviewfinal_expiry.Tradeqty * fobrokviewfinal_expiry.Price *BookType/BookTypeName , 
  ParticipantCode,Status,CpId,Instrument=BookTypeName,BookType,Branch_Id,TMark,Scheme,fobrokviewfinal_expiry.Dummy1,
  fobrokviewfinal_expiry.Dummy2,Reserved1,Reserved2,  cl_type,auctionpart = case when left(inst_type,3)= 'FUT' then 'EA' else 'CA' end,
  C_Regular_Lot  
  FROM fobrokviewfinal_expiry  , Client2 where Client2.Party_Code = fobrokviewfinal_expiry.Party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.FoCursorcontsale
-- --------------------------------------------------
CREATE View FoCursorcontsale  
As  
Select T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,sauda_Date = Left(Convert(Varchar,sauda_Date,109),11),      
Pqty = Sum(Pqty),sqty=Sum(Sqty)  
From 
(
        Select T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,t1.Sell_Buy,
        tradeqty,sauda_Date = Left(Convert(Varchar,sauda_Date,109),11), /*  T1.Price,  */    
        Pqty = (Case When Sell_Buy = 1 Then Sum(Tradeqty) Else 0 End ),
        Sqty = (Case When Sell_Buy = 2 Then Sum(Tradeqty) Else 0 End )
        From FoSettlement T1, Client2  Where  Tradeqty > 0  
        And T1.Party_Code = Client2.Party_Code
        Group By T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,t1.Sell_Buy,
        t1.Tradeqty,left(Convert(Varchar,sauda_Date,109),11)  
) T1   
Group By T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,left(Convert(Varchar,sauda_Date,109),11)

GO

-- --------------------------------------------------
-- VIEW dbo.FoCursorcontunequalsalepur
-- --------------------------------------------------
Create View FoCursorcontunequalsalepur As 
Select S1.Party_Code,s1.Inst_Type,s1.Symbol,s1.Sec_Name,s1.Expirydate,s1.Strike_Price,s1.Option_Type,sauda_Date,
Isnull(S1.Pqty,0) Pqty,isnull(S1.Sqty,0) Sqty 
From 
(
        Select T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,
        sauda_Date = Left(Convert(Varchar,sauda_Date,109),11), /*  T1.Price,  */      
        Pqty = Sum(Pqty),sqty=Sum(Sqty)  
        From 
        (
        Select T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,t1.Sell_Buy,
        tradeqty,sauda_Date = Left(Convert(Varchar,sauda_Date,109),11), /*  T1.Price,  */    
        Pqty =
        	(Case When Sell_Buy = 1 Then Sum(Tradeqty) Else 0 End ),
        
        Sqty = 
        	(Case When Sell_Buy = 2 Then Sum(Tradeqty) Else 0 End )
        From FoSettlement T1, Client2  Where  Tradeqty > 0  
        And T1.Party_Code = Client2.Party_Code
        Group By T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,t1.Sell_Buy,
        t1.Tradeqty,left(Convert(Varchar,sauda_Date,109),11)  
        ) T1   
        Group By T1.Party_Code,t1.Inst_Type,t1.Symbol,t1.Sec_Name,t1.Expirydate,t1.Strike_Price,t1.Option_Type,
        left(Convert(Varchar,sauda_Date,109),11)    
) S1 
Group By Sauda_Date,s1.Party_Code,s1.Inst_Type,s1.Symbol,s1.Sec_Name,s1.Expirydate,s1.Strike_Price,s1.Option_Type,sqty,pqty

GO

-- --------------------------------------------------
-- VIEW dbo.FOMARGIN_EOD
-- --------------------------------------------------





CREATE VIEW [dbo].[FOMARGIN_EOD]
AS


SELECT A.PARTY_CODE, A.MDATE AS MDATE,0 as  SPANMARGIN, TOTALMARGIN = TOTALMARGIN - MTOM , PSPANMARGIN = 0, NONSPREADMARGIN = 0, MTOM = 0 
FROM FOMARGINNEW A

GO

-- --------------------------------------------------
-- VIEW dbo.FOMARGIN_PEAK
-- --------------------------------------------------

 CREATE VIEW [FOMARGIN_PEAK]
AS



SELECT FILECOUNTER, MDATE, EXCHANGE = (SELECT exchange from pradnya..multicompany where ShareDb =  db_name() ),
	   SEGMENT =  (SELECT SEGMENT from pradnya..multicompany where ShareDb =  db_name() ), PARTY_CODE, PEAK_MARGIN = TOTAL_MARGIN
FROM FOMARGINNEW_INTRADAY

GO

-- --------------------------------------------------
-- VIEW dbo.FoMarginNew_Imp_View
-- --------------------------------------------------
CREATE view FoMarginNew_Imp_View  
as  
select * from FoMarginNew_Imp

GO

-- --------------------------------------------------
-- VIEW dbo.FOSettBrokview
-- --------------------------------------------------





CREATE   VIEW FOSettBrokview 
AS
Select F.Trade_No,  
Status,F.Inst_Type,F.Symbol,F.Expirydate,  F.Strike_price,F.Option_type,F.Sec_Name,BookType,MarKetType,
User_Id,Branch_Id,
Sell_Buy,TradeQty,Price,Pro_cli,F.Party_Code,ParticipantCode,O_C_Flag,C_U_Flag,Sauda_date,
Order_No,settflag,C2.Std_Rate,C2.Brok2_TableNo,C2.Brok_Scheme,Tran_Cat,Off_phone1,c2.Dummy6,C2.Dummy7,
MPrice = (CASE WHEN ((C2.Dummy1 = 0) Or (C2.Dummy1 = 20))
        THEN PRICE 
        Else
     (Case When (C2.Dummy1 = 1 Or C2.Dummy1 = 21 ) 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END),
MultiPlier = ( Case When ( C2.Brok_Scheme = 4 or C2.Brok_Scheme = 5 or C2.Brok_Scheme = 6 or C2.Brok_Scheme = 24 or C2.Brok_Scheme = 25 or C2.Brok_Scheme = 26)  
  Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/(Case When TradeQty = 0 Then 1 else TradeQty End)
  Else  1
       End), 
TaxPrice = (CASE WHEN TaxesFlag = 0 
        THEN PRICE 
        Else
     (Case When TaxesFlag = 1 
    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
                   Else F.Strike_price + PRICE  
      END)
   END) 
from fosettlement F, Client2 C2,FoScrip2 S2,Client1 C1, FOOwner
where c2.Party_Code = F.Party_Code 
and C1.Cl_Code = C2.Cl_Code
and F.inst_type = S2.inst_type 
AND F.SYMBOL = S2.SYMBOL      
AND F.expirydate = S2.expirydate
and F.option_type = S2.option_type 
And F.Strike_Price = S2.Strike_Price

GO

-- --------------------------------------------------
-- VIEW dbo.FoSettBrokViewFinal
-- --------------------------------------------------

--select * from FoSettBrokViewFinal

CREATE  View [dbo].[FoSettBrokViewFinal] As 
Select Trade_No,Status,FoSettBrokView.Inst_Type,FoSettBrokView.Symbol,FoSettBrokView.Expirydate,FoSettBrokView.Strike_price,FoSettBrokView.Option_type,
FoSettBrokView.Sec_Name,BookType,MarKetType,User_Id,Branch_Id,FoSettBrokView.Sell_Buy,TradeQty,Price,Pro_cli,
FoSettBrokView.Party_Code,ParticipantCode,O_C_Flag,C_U_Flag,Sauda_date,Tran_Cat,Off_Phone1,
Order_No,settflag,Brok_Scheme,MPrice,MultiPlier,FoGlobals.Service_tax,
BrokTable.Table_No,BrokTable.Line_No,BrokTable.Val_perc,broktable.Normal,broktable.day_puc,Broktable.day_sales,
Broktable.Sett_purch,Broktable.Sett_sales,Broktable.round_to,broktable.roFig,broktable.errnum,broktable.NoZero,
 FOTAXES.Insurance_chrg,FOTAXES.turnover_tax,FOTAXES.sebiturn_tax,FOTAXES.broker_note,
       SerTax=FOGLOBALS.service_tax,FOGLOBALS.year,FOGLOBALS.exchange, 
BrokApplied = (  case  
                         when ( FoSettBrokView.SettFlag = 1 and broktable.val_perc ='V' and FoSettBrokView.sell_buy = 1)
                              Then 
  ((floor((FoSettBrokView.MultiPlier* broktable.Normal* power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 1 and broktable.val_perc ='V' and FoSettBrokView.sell_buy = 2)
                              Then 
  ((floor((FoSettBrokView.MultiPlier*broktable.Normal  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 1 and broktable.val_perc ='P' and FoSettBrokView.sell_buy = 1)
                               Then  
                                          ((floor ( (((FoSettBrokView.MultiPlier*broktable.Normal /100 ) * (FoSettBrokView.MPrice))  * power(10,Broktable.round_to) + broktable.roFig + broktable.errnum ) /  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / power(10,broktable.round_to))
                        when ( FoSettBrokView.SettFlag = 1 and broktable.val_perc ='P' and FoSettBrokView.sell_buy = 2)
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*broktable.Normal /100 )* (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                      when (FoSettBrokView.SettFlag = 2  and broktable.val_perc ='V' ) 
                            Then 
  ((floor(( ((FoSettBrokView.MultiPlier*broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                      when (FoSettBrokView.SettFlag = 2  and broktable.val_perc ='P' ) 
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*broktable.day_puc/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                   when (FoSettBrokView.SettFlag = 3  and broktable.val_perc ='V' )
                             Then 
  ((floor(( FoSettBrokView.MultiPlier*Broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                  when (FoSettBrokView.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((Broktable.day_sales/ 100) * (FoSettBrokView.MPrice) ,broktable.round_to) */
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.day_sales/ 100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                when ( FoSettBrokView.SettFlag = 4  and broktable.val_perc ='V' )
                             Then 
  ((floor((FoSettBrokView.MultiPlier* Broktable.Sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 4  and broktable.val_perc ='P' )
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.Sett_purch/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
             when ( FoSettBrokView.SettFlag = 5  and broktable.val_perc ='V' )
                             Then 
  ((floor((FoSettBrokView.MultiPlier* Broktable.Sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 5  and broktable.val_perc ='P' )
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.Sett_sales/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))


  /* Added By BBG     16 Jan 2002  */

when (FoSettBrokView.SettFlag = 6  and broktable.val_perc ='V' ) 
                            Then 
  ((floor(( ((FoSettBrokView.MultiPlier*broktable.day_puc))  * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                      when (FoSettBrokView.SettFlag = 6  and broktable.val_perc ='P' ) 
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*broktable.day_puc/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                   when (FoSettBrokView.SettFlag = 7  and broktable.val_perc ='V' )
                             Then 
  ((floor(( FoSettBrokView.MultiPlier*Broktable.day_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                  when (FoSettBrokView.SettFlag = 7  and broktable.val_perc ='P' )
                             Then /*round((Broktable.day_sales/ 100) * (FoSettBrokView.MPrice) ,broktable.round_to) */
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.day_sales/ 100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                when ( FoSettBrokView.SettFlag = 8  and broktable.val_perc ='V' )
                             Then 
  ((floor((FoSettBrokView.MultiPlier* Broktable.Sett_purch * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 8  and broktable.val_perc ='P' )

                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.Sett_purch/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
             when ( FoSettBrokView.SettFlag = 9  and broktable.val_perc ='V' )
                             Then 
  ((floor((FoSettBrokView.MultiPlier* Broktable.Sett_sales * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
                         when ( FoSettBrokView.SettFlag = 9  and broktable.val_perc ='P' )
                             Then 
  ((floor(( ((FoSettBrokView.MultiPlier*Broktable.Sett_sales/100) * (FoSettBrokView.MPrice)) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /  
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) )  / 
  power(10,broktable.round_to))
   Else  0 
                        End 
                         ) ,
        Ins_chrg  = ((floor(( ((fotaxes.insurance_chrg * (FoSettBrokView.TaxPrice) * FoSettBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to)),
        turn_tax  =  ((floor(( ((fotaxes.turnover_tax * (FoSettBrokView.TaxPrice) * FoSettBrokView.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) /
  (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /
  power(10,broktable.round_to)),
        other_chrg = ((floor(( ((fotaxes.other_chrg * (FoSettBrokView.TaxPrice) * FoSettBrokView.Tradeqty)/100 ) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /  power(10,broktable.round_to)),
        sebi_tax =     ((floor(( ((fotaxes.sebiturn_tax *(FoSettBrokView.TaxPrice) * FoSettBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) / power(10,broktable.round_to)),
        Broker_chrg =  ((floor(( ((fotaxes.broker_note * (FoSettBrokView.TaxPrice) * FoSettBrokView.Tradeqty)/100) * power(10,Broktable.round_to)+broktable.roFig + broktable.errnum ) / (broktable.RoFig + broktable.Nozero )) * (broktable.rofig +broktable.NoZero ) ) /power(10,broktable.round_to))
/* Added By Animesh Cause of Added new fields in FoSettlement on Date 04/09/2001 12:25 PM. */
,cpid=0,Instrument=0,TMark=0,Scheme=FoSettBrokView.brok_scheme,Dummy1=0,Dummy2=0,Reserved1=0,Reserved2=0
from
(
	Select F.Trade_No,  
	Status,F.Inst_Type,F.Symbol,F.Expirydate,  F.Strike_price,F.Option_type,F.Sec_Name,BookType,MarKetType,
	User_Id,Branch_Id,
	Sell_Buy,TradeQty,Price,Pro_cli,F.Party_Code,ParticipantCode,O_C_Flag,C_U_Flag,Sauda_date,
	Order_No,settflag,C2.Std_Rate,C2.Brok2_TableNo,C2.Brok_Scheme,Tran_Cat,Off_phone1,c2.Dummy6,C2.Dummy7,
	MPrice = (CASE WHEN ((C2.Dummy1 = 0) Or (C2.Dummy1 = 20))
	        THEN PRICE 
	        Else
	     (Case When (C2.Dummy1 = 1 Or C2.Dummy1 = 21 ) 
	    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
	                   Else F.Strike_price + PRICE  
	      END)
	   END),
	MultiPlier = ( Case When ( C2.Brok_Scheme = 4 or C2.Brok_Scheme = 5 or C2.Brok_Scheme = 6 or C2.Brok_Scheme = 24 or C2.Brok_Scheme = 25 or C2.Brok_Scheme = 26)  
	  Then ceiling(Convert(numeric(19,2),TradeQty) / Convert(numeric(19,2),C_Regular_Lot))/(Case When TradeQty = 0 Then 1 else TradeQty End)
	  Else  1
	       End), 
	TaxPrice = (CASE WHEN TaxesFlag = 0 
	        THEN PRICE 
	        Else
	     (Case When TaxesFlag = 1 
	    Then (Case When F.Strike_Price = 0 Then F.Price Else F.Strike_Price End )    
	                   Else F.Strike_price + PRICE  
	      END)
	   END) ,Cl_Type
	from fosettlement F, Client2 C2,FoScrip2 S2,Client1 C1, FOOwner
	where c2.Party_Code = F.Party_Code 
	and C1.Cl_Code = C2.Cl_Code
	and F.inst_type = S2.inst_type 
	AND F.SYMBOL = S2.SYMBOL      
	AND F.expirydate = S2.expirydate
	and F.option_type = S2.option_type 
	And F.Strike_Price = S2.Strike_Price
) FoSettBrokView,BrokTable,foBAsalepur S,FoTaxes ,FoGlobals 
Where FoSettBrokView.party_code = s.party_code and
      FoSettBrokView.inst_type=S.inst_type and  
      FoSettBrokView.symbol=S.symbol and
      FoSettBrokView.expirydate=S.expirydate  AND
      FoSettBrokView.strike_price = s.strike_price and                 
      FoSettBrokView.option_type = s.option_type    and  
      year_start_dt >= Sauda_date and
      year_start_dt <= Sauda_date and
	 Sauda_date >= FOTAXES.From_date and
	 Sauda_date <= FOTAXES.to_date 

and
      Broktable.Table_no =(Case 
                                When 
                                    Left(FoSettBrokView.Inst_Type,3) = 'FUT' /*  And Settflag in(1,2,3,4,5) */
                                Then 
                                    FoSettBrokView.std_rate
                              /*   When 
                                    Left(FoSettBrokView.Inst_Type,3) = 'FUT'  And Settflag in(6,7,8,9)
                                Then 
                                    FoSettBrokView.Dummy6
                                When 
                                    Settflag in(6,7,8,9)
                                Then 
                                    FoSettBrokView.Dummy7  */
                                Else 
                                    FoSettBrokView.Brok2_TableNo
                                End)
           And   
           Broktable.Line_no =  ( case When 

                                           /* (FoSettBrokView.brok_scheme = 1  Or FoSettBrokView.brok_scheme = 5 ) */
                                           FoSettBrokView.brok_scheme in (1,5,21,25) 
                                       Then     
                                           (Select Min(Broktable.line_no) From Broktable where
                                            Broktable.Table_no =(Case 
                                                                     When 
                                                                         Left(FoSettBrokView.Inst_Type,3) = 'FUT' /*   And Settflag in(1,2,3,4,5)  */
                                                                     Then 
                                                                         FoSettBrokView.std_rate
                                                                    /* When 
                                                                         Left(FoSettBrokView.Inst_Type,3) = 'FUT'  And Settflag in(6,7,8,9)
                                                                     Then 
                                                                         FoSettBrokView.Dummy6 
                                                                     When 
                                                                         Settflag in(6,7,8,9)
                                                                     Then 
                                                                         FoSettBrokView.Dummy7  */

                                                                     Else 
                                                                         FoSettBrokView.Brok2_TableNo
                                                                 End)
           And Trd_Del = 
( Case 
                              When ((s.Pqty >= s.Sqty) And Settflag in (1,2,3,4,5)) 
                              then 
                                  ( Case 
                                        When ( FoSettBrokView.Sell_Buy = 1 ) 
                                        Then 
                                            'F'  
                                        Else 
                                            'S'
                                    End )
                           When 
                               Settflag in(6,7) 
                           Then
                                'S' 
                           When 
                                Settflag in(8,9) 
                           Then
                               'F'
                           When 
                               ((s.Pqty < s.Sqty) And Settflag in (1,2,3,4,5))
                           Then 
                              ( Case 
                                When
                                    ( FoSettBrokView.Sell_Buy = 2 ) 
                                Then 
                                    'F'  
                                Else
                                    'S'
                                End )
                           When 
                               Settflag in(6,7) 
                           Then
                                'S' 
                           When 
                                Settflag in(8,9) 
                           Then
                               'F'

 
                        End )     
 
                            and FoSettBrokView.Party_Code =  s.Party_code    
                           and FoSettBrokView.MPrice <= Broktable.upper_lim)  
        
                           When 
                               /* ( FoSettBrokView.brok_scheme = 3 or FoSettBrokView.brok_scheme = 6 ) */
                               FoSettBrokView.brok_scheme in (3,6,23,26) 
                           Then     
                               ( Select min(Broktable.line_no) From broktable where
                                        Broktable.table_no =  ( Case When 
                                                                         Left(FoSettBrokView.Inst_Type,3) = 'FUT' /*  And Settflag in(1,2,3,4,5)  */
                                                                     Then 
                                                                         FoSettBrokView.std_rate
                                                                    /*  When 
                                                                          Left(FoSettBrokView.Inst_Type,3) = 'FUT'  And Settflag in(6,7,8,9)
                                                                     Then 
                                                                         FoSettBrokView.Dummy6
                                                                     When 
                                                                         Settflag in(6,7,8,9)
                                                                     Then 
                                                                         FoSettBrokView.Dummy7 */

                                                                     Else 
                                                                         FoSettBrokView.Brok2_TableNo
   End)
              
           and Trd_Del = 
                        ( Case 
                              When ((s.Pqty >= s.Sqty) And Settflag in (1,2,3,4,5)) 
                              then 
                                  ( Case 
                                        When ( FoSettBrokView.Sell_Buy = 1 ) 
                                        Then 
                                            'F'  
                                        Else 
                                            'S'
                                    End )
                           When 
                               Settflag in(6,7) 
                           Then
                                'S' 
                           When 
                                Settflag in(8,9) 
                           Then
                               'F'
                           When 
                               ((s.Pqty < s.Sqty) And Settflag in (1,2,3,4,5))
                           Then 
                              ( Case 
                                When
                                    ( FoSettBrokView.Sell_Buy = 2 ) 
                                Then 
                                    'F'  
                                Else
                                    'S'
                                End)
                           When 
                               Settflag in(6,7) 
                           Then
                                'S' 
                           When 
                                Settflag in(8,9) 
                           Then
                               'F'
                                
 
                        End )     
            /*  End ) */
             and FoSettBrokView.Party_Code = s.Party_code    
             and FoSettBrokView.MPrice <= Broktable.upper_lim) 
      else 
          (select min(line_no) from broktable 
                  where FoSettBrokView.MPrice <= Broktable.upper_lim 
                  and broktable.table_no = (Case When 
                                                     Left(FoSettBrokView.Inst_Type,3) = 'FUT' /* And Settflag in(1,2,3,4,5)  */
                                                 Then
                                                     FoSettBrokView.std_rate
                                               /*  When 
                                                     Left(FoSettBrokView.Inst_Type,3) = 'FUT'  And Settflag in(6,7,8,9)
                                                 Then 
                                                     FoSettBrokView.Dummy6
                                                 When 
                                                     Settflag in(6,7,8,9)
                                                 Then 
                                                     FoSettBrokView.Dummy7  */
                                                 Else FoSettBrokView.Brok2_TableNo
                                             End)
)
       end )
  And FOTAXES.exchange = 'NCE' 
  and FoSettBrokView.Tran_cat = (Case When Cl_Type = 'PRO' Then 'PRO' Else FOTAXES.Trans_cat End )

GO

-- --------------------------------------------------
-- VIEW dbo.foTrdImpbfview
-- --------------------------------------------------




/* JAn 16  2002  */
/*  Made the sauda_date as Date Time   */

CREATE  view foTrdImpbfview as
select S.Party_Code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,Pqty=(Case When sell_buy = 1 then sum(tradeqty) else 0 end),
Sqty=(Case When sell_buy = 2 then sum(tradeqty) else 0 end),s.strike_price,s.option_type ,settflag 
from foTrade s ,client2 C Where s.party_code = C.Party_code and c.Tran_cat = 'TRD' 
group by S.party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,expirydate,s.strike_price,s.option_type,
sell_buy,expirydate,settflag

GO

-- --------------------------------------------------
-- VIEW dbo.foTrdsettbfview
-- --------------------------------------------------
CREATE  view foTrdsettbfview as
select S.Party_Code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,Pqty=(Case When sell_buy = 1 then sum(tradeqty) else 0 end),
Sqty=(Case When sell_buy = 2 then sum(tradeqty) else 0 end),s.strike_price,s.option_type ,settflag 
from foTrade s ,client2 C Where s.party_code = C.Party_code and c.Brok_scheme in ('20','21','22','23','24','25','26','27','28','29','30') 
group by S.party_code,s.Inst_Type,s.Symbol,S.EXPIRYDATE,expirydate,s.strike_price,s.option_type,
sell_buy,expirydate,settflag

GO

-- --------------------------------------------------
-- VIEW dbo.GET_MARGIN_REQ_LEDGER
-- --------------------------------------------------

CREATE VIEW [dbo].[GET_MARGIN_REQ_LEDGER]
AS

SELECT MDATE, PARTY_CODE = F.PARTY_CODE, INITIALMARGIN = SPREADMARGIN, MTOM = MTOM, DEL_MARGIN = DEL_MARGIN
FROM FOMARGINNEW F

GO

-- --------------------------------------------------
-- VIEW dbo.NCDX_PS03
-- --------------------------------------------------



CREATE VIEW [dbo].[NCDX_PS03] AS   
  
SELECT
	SAUDA_DATE = LEFT(SAUDA_DATE,11), 
	POSITIONDATE = REPLACE(UPPER(CONVERT(VARCHAR,SAUDA_DATE,106)),' ','-'),  
	SEGMENTINDICATOR = 'F',  
	SETTLEMENTTYPE = 'C'  ,
	CLEARINGMEMBERCODE = TM_CODE,  
	MEMBERTYPE = CASE WHEN CLIENT_TYPE ='INS' THEN 'C' ELSE 'M' END,  
	TRADINGMEMBERCODE = PARTICIPANTCODE,  
	ACCOUNTTYPE = CASE WHEN CLIENT_TYPE ='PRO' THEN 'P' ELSE 'C' END,  
	CLIENTACCOUNTCODE = PARTY_CODE,  
	INSTRUMENTTYPE = F.INST_TYPE,  
	SYMBOL = F.SYMBOL,  
	EXPIRYDATE = REPLACE(UPPER(CONVERT(VARCHAR,F.EXPIRYDATE,106)),' ','-'),  
	STRIKEPRICE = F.STRIKE_PRICE,  
	OPTIONTYPE = CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN 'FF' ELSE F.OPTION_TYPE END,  
	CALEVEL = 0,  

	BROUGHTFORWARDLONGQTY = CASE WHEN SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END) >0 THEN   
							SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END) ELSE 0 END,  
	BROUGHTFORWARDLONGVALUE = CONVERT(MONEY,(CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN   
							(CASE WHEN SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END) >0 THEN   
							SUM(CASE WHEN TRADETYPE='BF' THEN PAMT-SAMT ELSE 0 END) ELSE 0 END) ELSE 0 END)) ,  
	BROUGHTFORWARDSHORTQTY = CASE WHEN SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END) < 0 THEN   
							ABS(SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
	BROUGHTFORWARDSHORTVALUE =  CONVERT(MONEY,(CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT' THEN (CASE WHEN   
							SUM(CASE WHEN TRADETYPE='BF' THEN PQTY-SQTY ELSE 0 END) <0 THEN   
							ABS(SUM(CASE WHEN TRADETYPE='BF' THEN ABS(PAMT-SAMT) ELSE 0 END)) ELSE 0 END) ELSE 0 END)),  

	DAYBUYOPENQTY = SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' THEN PQTY ELSE 0 END),  
	DAYBUYOPENVALUE  =  CONVERT(MONEY,SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' THEN PQTY * PRATE ELSE 0 END)),  
	DAYSELLOPENQTY = SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' THEN SQTY ELSE 0 END),  
	DAYSELLOPENVALUE  =  CONVERT(MONEY,SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' THEN SQTY * SRATE ELSE 0 END)),  


	PREEXASGMNTLONGQTY = CASE WHEN SUM(CASE WHEN  AUCTIONPART <> '' THEN 0 ELSE PQTY-SQTY END) > 0  
						THEN SUM(CASE WHEN  AUCTIONPART <> ''  THEN 0 ELSE PQTY-SQTY END) ELSE 0 END,  
	PREEXASGMNTLONGVALUE =  CONVERT(MONEY,( CASE WHEN SUM(CASE WHEN  (AUCTIONPART ='EA' OR TRADETYPE ='BF')   
						THEN 0 ELSE (CASE WHEN TRADETYPE ='BT'   
						THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE SAMT-PAMT END) END) < 0 OR 
						(SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' AND PQTY-SQTY=0  THEN 1 ELSE 0 END)>0)   
						THEN SUM(CASE WHEN  AUCTIONPART <> ''  THEN 0 ELSE CASE WHEN TRADETYPE ='BT'   
						THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE SAMT-PAMT END END) ELSE 0 END)),  
	PREEXASGMNTSHORTQTY = CASE WHEN SUM(CASE WHEN AUCTIONPART <> ''  THEN 0 ELSE PQTY-SQTY END) < 0  
						THEN ABS(SUM(CASE WHEN AUCTIONPART <> ''  THEN 0 ELSE PQTY-SQTY END)) ELSE 0 END,  
	PREEXASGMNTSHORTVALUE =  CONVERT(MONEY,( CASE WHEN SUM(CASE WHEN (AUCTIONPART ='EA' OR TRADETYPE ='BF')   
						THEN 0 ELSE (CASE WHEN TRADETYPE ='BT'   
						THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE SAMT-PAMT END) END) > 0  
						AND (SUM(CASE WHEN TRADETYPE ='BT' AND AUCTIONPART ='' AND PQTY-SQTY=0  THEN 1 ELSE 0 END)=0)  
						THEN (SUM(CASE WHEN  AUCTIONPART <> ''  THEN 0 ELSE CASE WHEN TRADETYPE ='BT'   
						THEN (SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE SAMT-PAMT END END)) ELSE 0 END)),


	EXERCISEDQTY = SUM(CASE WHEN LEFT(F.INST_TYPE,3) ='OPT' AND AUCTIONPART ='EA' THEN PQTY ELSE 0 END),
	ASSIGNEDQTY  = SUM(CASE WHEN LEFT(F.INST_TYPE,3) ='OPT' AND AUCTIONPART ='EA' THEN SQTY ELSE 0 END),

	POSTEXASGMNTLONGQTY = CASE WHEN SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END) > 0   THEN
						SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END) ELSE 0  END,
	POSTEXASGMNTLONGVALUE =  CONVERT(MONEY,CASE WHEN SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END) > -1 THEN
						SUM(CASE WHEN TRADETYPE ='BT' THEN CASE WHEN  AUCTIONPART ='' THEN 
						(SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END ELSE SAMT-PAMT END) ELSE 0 END),
	POSTEXASGMNTSHORTQTY = CASE WHEN SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END)< 0 THEN
						ABS(SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END)) ELSE 0 END,
	POSTEXASGMNTSHORTVALUE =  CONVERT(MONEY,CASE WHEN SUM(CASE WHEN  AUCTIONPART ='' THEN PQTY-SQTY ELSE 0 END) < 0 THEN   
						SUM(CASE WHEN TRADETYPE ='BT' THEN CASE WHEN  AUCTIONPART ='' THEN 
						(SQTY*SRATE*NUMERATOR/DENOMINATOR)-(PQTY*PRATE*NUMERATOR/DENOMINATOR) ELSE 0 END ELSE SAMT-PAMT END)ELSE 0  END),

	SETTLEMENTPRICE = F.CL_RATE ,  

	NETPREMIUM =  CONVERT(MONEY,SUM(CASE WHEN TRADETYPE ='BT' AND LEFT(F.INST_TYPE,3) ='OPT' AND AUCTIONPART =''
						THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END)),  

	DAILYMTMSETTLEMENTVALUE =  CONVERT(MONEY,SUM(CASE WHEN LEFT(F.INST_TYPE,3) ='FUT' AND LEFT(MATURITYDATE,11) <> LEFT(SAUDA_DATE,11)
						THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END)),
	FUTURESFINALSETTLEMENTVALUE =  CONVERT(MONEY,SUM(CASE WHEN LEFT(F.INST_TYPE,3) ='FUT' AND LEFT(MATURITYDATE,11) = LEFT(SAUDA_DATE,11)
						THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END)),

	EXERCISEDASSIGNEDVALUE =  CONVERT(MONEY,SUM(CASE WHEN LEFT(F.INST_TYPE,3) ='OPT' AND AUCTIONPART ='EA' 
						THEN SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT ELSE 0 END))  
FROM   
	FOBILLVALAN F(NOLOCK) , FOOWNER (NOLOCK)  
WHERE  
	CLIENT_TYPE <> 'INS'
GROUP BY   
	 SAUDA_DATE,  
	 TM_CODE,  
	 CLIENT_TYPE,  
	 PARTICIPANTCODE,  
	 PARTY_CODE,  
	 F.INST_TYPE,  
	 F.SYMBOL,  
	 F.EXPIRYDATE,  
	 F.STRIKE_PRICE,  
	 F.OPTION_TYPE ,  
	 F.CL_RATE 
HAVING SUM( SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT )  <> 0 OR SUM(PQTY-SQTY) <> 0

GO

-- --------------------------------------------------
-- VIEW dbo.OPEN_BILL_DATES
-- --------------------------------------------------

CREATE VIEW [dbo].[OPEN_BILL_DATES]
AS
	SELECT DISTINCT BILLDATE, FUNDS_PAYIN = PAYIN_DATE FROM FOACCBILL

GO

-- --------------------------------------------------
-- VIEW dbo.Owner
-- --------------------------------------------------
CREATE view [dbo].[OWNER]    
as    
select * from foowner

GO

-- --------------------------------------------------
-- VIEW dbo.POBANK
-- --------------------------------------------------
CREATE view [dbo].[POBANK]  
as  
select   
* from MCDX.dbo.POBANK

GO

-- --------------------------------------------------
-- VIEW dbo.REGION
-- --------------------------------------------------

CREATE VIEW [dbo].[REGION]  
AS  
SELECT * FROM MSAJAG.dbo.Region

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_FoColl
-- --------------------------------------------------
CREATE   View Rpt_FoColl As
Select Distinct Party_Code,billdate,sum(Credit) As Credit, Sum(Debit) As Debit,yy,mm,dd From 
(
        Select Distinct Party_Code,convert(Datetime,left(Convert(Varchar,billdate,109),11),109) As Billdate,sum(Credit) As Credit, 
        Sum(Debit) As Debit,yy,mm,dd
         From 
        (
                Select  Party_Code ,billdate ,
        	Credit = (Case When Sell_Buy = 2 Then Amount Else 0 End),
        	Debit  = (Case When Sell_Buy = 1 Then Amount Else 0 End),yy=Year(Billdate),mm=Month(Billdate),dd=Day(Billdate)
        	From FoAccbill
        	Where Amount <> 0
        	And Party_Code In (Select Distinct Party_Code From Client2)
        	Union 
        	Select  Party_Code ,billdate=Trans_Date, 
        	Credit = 0,
        	Debit  = 0,yy=Year(Trans_Date),mm=Month(Trans_Date),dd=Day(Trans_Date)
        	From Msajag.Dbo.Collateral
        	Union
        	Select Party_Code,billdate = Getdate(),
        	Credit = 0,
        	Debit = 0,yy=Year(Getdate()),mm=Month(Getdate()),dd=Day(Getdate())
        	From Client2
        )
        FoColl_View
        Group By Party_Code,convert(Datetime,left(Convert(Varchar,billdate,109),11),109),yy,mm,dd
)
FoColl_Viewfinal
Group By Party_Code,billdate,yy,mm,dd

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MParty
-- --------------------------------------------------





/****** Object:  View dbo.Rpt_View_NewM2MParty    Script Date: May 08 2003 18:27:35 ******/
CREATE  View  Rpt_View_NewM2MParty AS 
Select foea_position_date,foea_party_code,
foea_NetPremium=Sum(foea_NetPremium),foea_Daily_MTM_Settlement_Value=Sum(foea_Daily_MTM_Settlement_Value),
foea_Futures_Final_Settlement_Value=Sum(foea_Futures_Final_Settlement_Value),foea_Exercised_Assigned_Value=Sum(foea_Exercised_Assigned_Value)
From foexerciseallocation
Group By foea_position_date,foea_party_code

GO

-- --------------------------------------------------
-- VIEW dbo.Rpt_View_NewM2MScrip
-- --------------------------------------------------





/****** Object:  View dbo.Rpt_View_NewM2MScrip    Script Date: May 08 2003 18:27:35 ******/
CREATE  View Rpt_View_NewM2MScrip AS 
Select foea_position_date,foea_inst_type,foea_symbol,foea_expirydate,foea_strike_price,foea_option_type,
foea_NetPremium=Sum(foea_NetPremium),foea_Daily_MTM_Settlement_Value=Sum(foea_Daily_MTM_Settlement_Value),
foea_Futures_Final_Settlement_Value=Sum(foea_Futures_Final_Settlement_Value),foea_Exercised_Assigned_Value=Sum(foea_Exercised_Assigned_Value)
From foexerciseallocation
Group By foea_position_date,foea_inst_type,foea_symbol,foea_expirydate,foea_strike_price,foea_option_type

GO

-- --------------------------------------------------
-- VIEW dbo.SBU_MASTER
-- --------------------------------------------------

CREATE VIEW [dbo].[SBU_MASTER]  
AS  
SELECT * FROM MSAJAG.DBO.SBU_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.SCRIP2
-- --------------------------------------------------

CREATE VIEW SCRIP2 AS

SELECT SCRIP_CD,SERIES FROM MSAJAG.DBO.SCRIP2 (NOLOCK)

UNION ALL 

SELECT SCRIP_CD,SERIES='BSE' FROM BSEDB.DBO.SCRIP2 (NOLOCK)

UNION ALL 

SELECT DISTINCT SYMBOL AS SCRIP_CD,SERIES='COM' FROM FOSCRIP2 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.SETT_MST
-- --------------------------------------------------
CREATE VIEW SETT_MST AS SELECT * FROM MSAJAG..SETT_MST

GO

-- --------------------------------------------------
-- VIEW dbo.SpanDetailView
-- --------------------------------------------------







/****** Object:  View dbo.SpanDetailView    Script Date: 09/10/2001 6:26:41 PM ******/

/****** Object:  View dbo.SpanDetailView    Script Date: 09/07/2001 10:35:21 PM ******/


/****** Object:  View dbo.SpanDetailView    Script Date: 9/7/2001 4:09:05 PM ******/


/****** Object:  View dbo.SpanDetailView    Script Date: 8/7/01 4:28:29 PM ******/

/****** Object:  View dbo.SpanDetailView    Script Date: 7/25/01 10:05:18 PM ******/




/****** Object:  View dbo.SpanDetailView    Script Date: 7/18/2001 6:21:07 PM ******/
CREATE  view SpanDetailView
as

select m.mdate as mdate, m.party_code as party_code, newspanmargin
from fospanmarginnew m, client3 cl3
where cl3.party_code = m.party_code
and cl3.markettype like 'FUT%'

GO

-- --------------------------------------------------
-- VIEW dbo.spanMarginDetailView
-- --------------------------------------------------





/****** Object:  View dbo.spanMarginDetailView    Script Date: 8/31/01 2:57:19 PM ******/
CREATE  view spanMarginDetailView
as

select m.mdate as mdate, m.party_code as party_code, m.spanmargin,m.premium,m.totalmargin,m.pmarginrate,m.newspanmargin,m.finaltotalmargin
from fospanmarginnew m, client3 cl3
where cl3.party_code = m.party_code
and cl3.markettype like 'FUT%'

GO

-- --------------------------------------------------
-- VIEW dbo.SPANNETPOSITION
-- --------------------------------------------------




CREATE  view SPANNETPOSITION as

select party_code,inst_type,symbol,expirydate,
pqty = ( case when sell_buy = 1 then sum(tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(tradeqty) else 0 end ), strike_price, option_type,sauda_date as sauda_date
from fosettlement where reserved1 <> 1
group by party_code,inst_type,symbol,expirydate,sell_buy, strike_price, option_type,sauda_date


union all

select party_code,inst_type,symbol,expirydate,
pqty = ( case when sell_buy = 1 then sum(tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(tradeqty) else 0 end ), strike_price, option_type,tradedate as sauda_date
from fotrade4432
group by party_code,inst_type,symbol,expirydate,sell_buy, strike_price, option_type,tradedate


union all

select party_code,inst_type,symbol,expirydate,
pqty = ( case when sell_buy = 1 then sum(tradeqty) else 0 end ),
sqty = ( case when sell_buy = 2 then sum(tradeqty) else 0 end ), strike_price, option_type,tradedate as sauda_date
from fomanualtrade
group by party_code,inst_type,symbol,expirydate,sell_buy, strike_price, option_type,tradedate

GO

-- --------------------------------------------------
-- VIEW dbo.SpanOptionExAllocView
-- --------------------------------------------------







/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 09/10/2001 6:26:41 PM ******/

/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 09/07/2001 10:35:21 PM ******/


/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 9/7/2001 4:09:05 PM ******/


/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 8/7/01 4:28:29 PM ******/

/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 7/25/01 10:05:18 PM ******/


/****** Object:  View dbo.SpanOptionExAllocView    Script Date: 7/4/01 10:54:09 AM ******/


CREATE  view SpanOptionExAllocView

as 

select s.party_code,s.inst_type,s.symbol,s.strike_price,s.option_type,s.expirydate,
pqty = ( case when s.sell_buy = 1 then sum(s.tradeqty) else 0 end ),
sqty = ( case when s.sell_buy = 2 then sum(s.tradeqty) else 0 end ),
Nsertax = ( case when s.billflag>3 then sum(s.nsertax) else 0 end ),
nbrokapp = ( case when s.billflag > 3 then sum(s.nbrokapp*s.tradeqty) else 0 end ),s.billflag,
cl_rate = isnull(( select fofinalclosing.cl_rate from fofinalclosing
                         where fofinalclosing.closingdate like s.expirydate
                         		and foscrip2.maturitydate like fofinalclosing.closingdate
                                        and fofinalclosing.UnderlyingAsset=s.symbol   
           ),0)
from fosettlement s, foscrip2
where left(s.inst_type,3) = 'OPT'
and left(foscrip2.inst_type,3) = 'OPT'
and foscrip2.symbol = s.symbol
and foscrip2.inst_type = s.inst_type
and foscrip2.strike_price = s.strike_price
and foscrip2.option_type = s.option_type
and foscrip2.expirydate = s.expirydate
group by s.party_code,s.inst_type,s.symbol,s.strike_price,s.option_type,s.expirydate,s.sell_buy,s.billflag,foscrip2.maturitydate

GO

-- --------------------------------------------------
-- VIEW dbo.TBL_GST_LOCATION_Dnt_USE
-- --------------------------------------------------

CREATE VIEW TBL_GST_LOCATION
AS
SELECT * FROM MSAJAG.DBO.TBL_GST_LOCATION

GO

-- --------------------------------------------------
-- VIEW dbo.TBL_STATE_GST_DATA
-- --------------------------------------------------
CREATE VIEW TBL_STATE_GST_DATA
AS
SELECT * FROM mcdx.DBO.TBL_STATE_GST_DATA

GO

-- --------------------------------------------------
-- VIEW dbo.TRADERS
-- --------------------------------------------------
CREATE VIEW TRADERS AS
SELECT 
	BRANCH_CD,TRADER_CODE = SHORT_NAME,LONG_NAME,ADDRESS1,ADDRESS2,CITY,STATE,NATION,ZIP,PHONE1,PHONE2,FAX,EMAIL,[REMOTE]
	SECURITY_NET,MONEY_NET,EXCISE_REG,CONTACT_PERSON,COM_PERC,TERMINAL_ID,DEFTRADER
FROM BRANCHES

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLASS_VW_ENTITYMASTER
-- --------------------------------------------------



CREATE VIEW [DBO].[V2_CLASS_VW_ENTITYMASTER]     
    
AS    
    
  SELECT ENT_CODE = 'BROKER',    
         ENT_NAME = 'BROKER',     
         ENT_TYPE = 'BROKER',     
         ORDER_BY = 1      
  FROM   OWNER  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = BRANCH_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'BRANCH' ,     
         ORDER_BY = 2      
  FROM   BRANCH   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SHORT_NAME,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'TRADER',     
         ORDER_BY = 4        
  FROM   BRANCHES   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = SUB_BROKER,    
         ENT_NAME = [NAME],     
         ENT_TYPE = 'SUBBROKER',     
         ORDER_BY = 3        
  FROM   SUBBROKERS  (NOLOCK)   
  UNION ALL     
  SELECT DISTINCT ENT_CODE = AREACODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'AREA',     
         ORDER_BY = 7        
  FROM   AREA   (NOLOCK)  
  UNION ALL     
  SELECT DISTINCT ENT_CODE = REGIONCODE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'REGION',     
         ORDER_BY = 8        
  FROM   REGION   (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = CL_CODE,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'CLIENT',     
         ORDER_BY = 5        
  FROM   CLIENT1  (NOLOCK)  
  UNION ALL     
  SELECT ENT_CODE = FAMILY,    
         ENT_NAME = LONG_NAME,     
         ENT_TYPE = 'FAMILY',     
         ORDER_BY = 6        
  FROM   CLIENT1  (NOLOCK)  
  WHERE  CL_CODE = FAMILY    
  UNION ALL     
    
  SELECT ENT_CODE = CL_TYPE,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLTYPE',     
         ORDER_BY = 9        
  FROM   CLIENTTYPE   (NOLOCK)   
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'GROUP',     
         ORDER_BY = 10        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'GROUP'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'RELMGR',     
         ORDER_BY = 11        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'RELMGR'    
  UNION ALL     
  SELECT ENT_CODE = SBU_CODE,    
         ENT_NAME = SBU_NAME,     
         ENT_TYPE = 'SBU',     
         ORDER_BY = 12        
  FROM  SBU_MASTER    (NOLOCK)  
  WHERE  SBU_TYPE = 'SBU'    
  UNION ALL     
  SELECT ENT_CODE = CL_STATUS,    
         ENT_NAME = DESCRIPTION,     
         ENT_TYPE = 'CLSTATUS',     
         ORDER_BY = 13        
  FROM  CLIENTSTATUS   (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.VW_BILLCHECK
-- --------------------------------------------------




CREATE VIEW [dbo].[VW_BILLCHECK]  

AS  

  

SELECT SAUDA_DATE, FLAG = 1, MSG = (CASE WHEN BO_AMT = EX_AMT THEN 'FINAL OBL MATCHED. ' ELSE 'FINAL OBL MISMATCH. ' END)  

    + (CASE WHEN DIFFCNT > 0 THEN 'PARTY SCRIP OBL MISMATCH -' + CONVERT(VARCHAR,ISNULL(DIFFCNT,0)) + ' RECORDS ' ELSE 'PARTY SCRIP OBL MATCHED ' END)   

    + 'BO AMOUNT = ' + CONVERT(VARCHAR,BO_AMT) + ' AND EXCHANGE AMT = ' + CONVERT(VARCHAR,EX_AMT)  

FROM (  

SELECT SAUDA_DATE, DIFFCNT=ISNULL(SUM(CASE WHEN DIFF <> 0 THEN 1 ELSE 0 END),0),  

BO_AMT=ISNULL(SUM(BO_AMT),0), EX_AMT=ISNULL(SUM(EX_AMT),0)  

FROM (SELECT SAUDA_DATE, DIFF=BO_MTM+BO_PRM+BO_EXC-EX_MTM-EX_PRM-EX_EXC, BO_AMT = BO_MTM+BO_PRM+BO_EXC, EX_AMT = EX_MTM+EX_PRM+EX_EXC  

FROM TBL_DAILY_MTM_DIFF) A GROUP BY SAUDA_DATE) A

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MAPPING_TABLE
-- --------------------------------------------------

   
CREATE VIEW Vw_MAPPING_TABLE AS  
  
SELECT * FROM ANAND1.MSAJAG.DBO.MAPPING_TABLE

GO

