-- DDL Export
-- Server: 10.254.33.28
-- Database: INHOUSE
-- Exported: 2026-02-05T11:26:35.433722

USE INHOUSE;
GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_AD_Backend_ChangeMst_User_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_AD_Backend_ChangeMst_User_Mapping] ADD CONSTRAINT [FK__tbl_AD_Ba__EmpId__6C040022] FOREIGN KEY ([EmpId]) REFERENCES [dbo].[tbl_EmpDetails] ([EmpId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_AD_Backend_ChangeMst_User_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_AD_Backend_ChangeMst_User_Mapping] ADD CONSTRAINT [FK__tbl_AD_Ba__Query__6CF8245B] FOREIGN KEY ([QueryId]) REFERENCES [dbo].[tbl_AD_QueryChange_Mst] ([QueryId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_Emp_DBServer_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_DBServer_Mapping] ADD CONSTRAINT [FK__tbl_Emp_D__DBSer__16644E42] FOREIGN KEY ([DBServerId]) REFERENCES [dbo].[tbl_Server_DBServerAccess] ([DBServerId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_Emp_DBServer_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_DBServer_Mapping] ADD CONSTRAINT [FK__tbl_Emp_D__EmpId__1758727B] FOREIGN KEY ([EmpId]) REFERENCES [dbo].[tbl_EmpDetails] ([EmpId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_Emp_Role_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Role_Mapping] ADD CONSTRAINT [FK__tbl_Emp_R__EmpId__00750D23] FOREIGN KEY ([EmpId]) REFERENCES [dbo].[tbl_EmpDetails] ([EmpId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_Emp_Role_Mapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Emp_Role_Mapping] ADD CONSTRAINT [FK__tbl_Emp_R__RoleI__0169315C] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[tbl_RoleMst] ([RoleId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_FileUploadUserMapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_FileUploadUserMapping] ADD CONSTRAINT [FK__tbl_FileU__EmpId__2F2FFC0C] FOREIGN KEY ([EmpId]) REFERENCES [dbo].[tbl_EmpDetails] ([EmpId])

GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.tbl_FileUploadUserMapping
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_FileUploadUserMapping] ADD CONSTRAINT [FK__tbl_FileU__Uploa__2E3BD7D3] FOREIGN KEY ([UploadTypeId]) REFERENCES [dbo].[tbl_FileUploadMst] ([UploadTypeId])

GO

-- --------------------------------------------------
-- FUNCTION dbo.DPC_TB
-- --------------------------------------------------
CREATE Function  [dbo].[DPC_TB](@aCdate varchar(11),@TBDATE varchar(11))           
RETURNS @TB table       
(      
cltcode varchar(10),      
DrCr char(1),      
vamt money      
)      
AS       
BEGIN  
/*
 if @aCdate=@TBDATE
 BEGIN
	select @aCdate=sdtcur from account.dbo.parameter where sdtnxt=@aCdate
 END      
*/ 

 if @aCdate=@TBDATE
 BEGIN
	insert into @TB      
	select cltcode,'D',sum(-vamt) 
	from account_ab.dbo.LEDGER with (nolock) where vdt < @aCdate and edt >=@aCdate and drcr='D'
	group by  cltcode
 END
 ELSE
 BEGIN
	 insert into @TB      
	 select cltcode,'D',sum(case when drcr='D' then vamt else -vamt end) from account_ab.dbo.LEDGER with (nolock)       
	 where isnumeric(left(cltcode,1))=0 and vdt>= @aCdate and  (Case when vtyp=15 and drcr='D' then edt else vdt end) < @TBDATE      
	 group by cltcode   
 END
    
 update @TB set Drcr='C' where vamt < 0      
      
REturn      
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.DPC_TB_NB
-- --------------------------------------------------
CREATE Function  [dbo].[DPC_TB_NB](@aCdate varchar(11),@TBDATE varchar(11))                 
RETURNS @TB table             
(            
cltcode varchar(10),            
DrCr char(1),            
vamt money            
)            
AS             
BEGIN        
/*      
 if @aCdate=@TBDATE      
 BEGIN      
 select @aCdate=sdtcur from account.dbo.parameter where sdtnxt=@aCdate      
 END            
*/       
      
 if @aCdate=@TBDATE      
 BEGIN      
 insert into @TB            
 select cltcode,'D',sum(-vamt)       
 from account_ab.dbo.LEDGER with (nolock) where vdt < @aCdate and edt >=@aCdate and drcr='D'      
 group by  cltcode      
 END      
 ELSE      
 BEGIN      
  insert into @TB            
  select cltcode,'D',sum(case when drcr='D' then vamt else -vamt end) from account_ab.dbo.LEDGER with (nolock)             
  where isnumeric(left(cltcode,1))=0     
  and vdt>= @aCdate and      
  /* (Case when vtyp=15 and drcr='D' then edt else vdt end)  < @TBDATE  */    
  edt < @TBDATE
  group by cltcode         
 END      
          
 update @TB set Drcr='C' where vamt < 0            
            
REturn            
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.RoundedTurnover
-- --------------------------------------------------

CREATE  Function [dbo].[RoundedTurnover](@Amt Numeric(18,4), @roundingAmt Numeric(18,4))  
Returns Numeric(18,4)  
As  
Begin  

	 if @Amt > 0 AND @roundingAmt > 1   
	  Select @Amt = (Case When @Amt - Convert(BigInt,@Amt/@roundingAmt)*@roundingAmt = 0   
						  Then @Amt   
			Else (Convert(BigInt,@Amt/@roundingAmt)+1)*@roundingAmt   
			  End)  
	 Else   
	  select @Amt = @Amt  
	 
	Return @Amt  
  
  end

GO

-- --------------------------------------------------
-- FUNCTION dbo.strip_non_alpha
-- --------------------------------------------------

create

	function [dbo].[strip_non_alpha] (@strInput varchar(8000)) returns varchar(8000)

as

begin
	declare 
		@strRetVal varchar(8000),
		@chrCurrChar char(1),
		@intCounter int,
		@intInputLen int

		set @intInputLen = len(ltrim(rtrim(isnull(@strInput, ''))))
		set @intCounter = 0

	set @strRetVal = ''

	while (@intCounter <= @intInputLen) begin
		set @intCounter = @intCounter + 1
		set @chrCurrChar = substring(@strInput, @intCounter, 1)

		set @strRetVal = @strRetVal + 
			case 
				when (ascii(@chrCurrChar) between 65 and 90) then @chrCurrChar
				when (ascii(@chrCurrChar) between 97 and 122) then @chrCurrChar
				when (ascii(@chrCurrChar) = 255) then @chrCurrChar
				else ''
			end
	end

	return @strRetVal

end

GO

-- --------------------------------------------------
-- FUNCTION dbo.strip_non_digit
-- --------------------------------------------------
create

	function [dbo].[strip_non_digit] (@Input varchar(20)) returns varchar(20)

as

begin
	declare 
		@RetVal varchar(20),
		@chrCurrChar char(1),
		@intCounter int,
		@intInputLen int

		set @intInputLen = len(isnull(@Input, ''))
		set @intCounter = 0

	set @RetVal = ''

	while (@intCounter <= @intInputLen) begin
		set @intCounter = @intCounter + 1
		set @chrCurrChar = substring(@Input, @intCounter, 1)

		set @RetVal = @RetVal + 
			case 
				when (ascii(@chrCurrChar) between 48 and 57) then @chrCurrChar
				else ''
			end
	end

	return @RetVal

end

GO

-- --------------------------------------------------
-- INDEX dbo.BO_client_deposit_recno
-- --------------------------------------------------
CREATE CLUSTERED INDEX [co_pcode] ON [dbo].[BO_client_deposit_recno] ([cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.DPC_TB_TEMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxsegclt] ON [dbo].[DPC_TB_TEMP] ([Segment], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.NCMS_PO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXcl] ON [dbo].[NCMS_PO] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.NCMS_PO_BSEIPO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[NCMS_PO_BSEIPO] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.PenalRev_Table
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxptydt] ON [dbo].[PenalRev_Table] ([Party_Code], [RevDate])

GO

-- --------------------------------------------------
-- INDEX dbo.SEBI_PO
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex_cltcode] ON [dbo].[SEBI_PO] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_dob_mismatch
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [party] ON [dbo].[tbl_dob_mismatch] ([PartyCode])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_EmpDetails
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_EmpD__7DA847CAAD50F0D6] ON [dbo].[tbl_EmpDetails] ([EmpCode])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_FileUploadUserMapping
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [unq_tbl_FileUploadUserMapping_UploadTypeId_EmpId] ON [dbo].[tbl_FileUploadUserMapping] ([UploadTypeId], [EmpId])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_RoleMst
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Role__8A2B61601DDF33D2] ON [dbo].[tbl_RoleMst] ([RoleName])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Server_DBServerAccess
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__tbl_Serv__539374CABB94AE7F] ON [dbo].[tbl_Server_DBServerAccess] ([IPAdd])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_AD_QueryChange_Mst
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_AD_QueryChange_Mst] ADD CONSTRAINT [PK__tbl_AD_Q__5967F7DBA56A7B2E] PRIMARY KEY ([QueryId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_BACKUP_PROCESS_STATUS
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_BACKUP_PROCESS_STATUS] ADD CONSTRAINT [PK__TBL_BACK__CA1EE06C27F8EE98] PRIMARY KEY ([SNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_EmpDetails
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_EmpDetails] ADD CONSTRAINT [PK__tbl_EmpD__AF2DBB997CD96557] PRIMARY KEY ([EmpId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_EmpDetails
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_EmpDetails] ADD CONSTRAINT [UQ__tbl_EmpD__7DA847CAAD50F0D6] UNIQUE ([EmpCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_FileUploadMst
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_FileUploadMst] ADD CONSTRAINT [PK__tbl_File__02940272D141AB6C] PRIMARY KEY ([UploadTypeId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_RoleMst
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_RoleMst] ADD CONSTRAINT [PK__tbl_Role__8AFACE1A5342470E] PRIMARY KEY ([RoleId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_RoleMst
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_RoleMst] ADD CONSTRAINT [UQ__tbl_Role__8A2B61601DDF33D2] UNIQUE ([RoleName])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Server_DBServerAccess
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Server_DBServerAccess] ADD CONSTRAINT [PK__tbl_Serv__9107BE7589B563E8] PRIMARY KEY ([DBServerId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Server_DBServerAccess
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Server_DBServerAccess] ADD CONSTRAINT [UQ__tbl_Serv__539374CABB94AE7F] UNIQUE ([IPAdd])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AGG_DupRec
-- --------------------------------------------------
CREATE procedure AGG_DupRec      
as      
set nocount on      
select * INTO #A1 from ACCOUNT_AB.dbo.ledger where vdt >=convert(Date,getdate()-10)       
AND CHECKEDBY='ONLINE' AND VTYP=2      
select * INTO #A2 from ACCOUNT_AB.dbo.ledger where vdt >=convert(Date,getdate()-10)       
AND CHECKEDBY<>'ONLINE' AND VTYP=2      
SELECT B.*,A.DDNO,A.L1_SNO INTO #B1 FROM ACCOUNT_AB.dbo.LEDGER1 A JOIN #A1 B ON A.VNO=B.VNO       
AND A.VTYP=B.VTYP AND A.LNO=B.LNO      
SELECT B.*,A.DDNO,A.L1_SNO INTO #B2 FROM ACCOUNT_AB.dbo.LEDGER1 A JOIN #A2 B ON A.VNO=B.VNO       
AND A.VTYP=B.VTYP AND A.LNO=B.LNO      
SELECT A.* INTO #C1 FROM #B1 A JOIN  #B2 B ON A.CLTCODE=B.CLTCODE AND A.VAMT=B.VAMT AND A.DDNO=B.DDNO 
DELETE from AGG_DupRecLog where CONVERT(varchar(11),GETDATE(),106)= CONVERT(varchar(11),GETDATE(),106)      
insert into AGG_DupRecLog      
select count(1) as DupCount,Getdate() as ProTime From ACCOUNT_AB.dbo.ledger where vtyp=2       
and vno in (Select vno from #c1)       
and checkedby='ONLINE' --AND CLTCODE NOT IN ('02020','03014')      
having count(1) > 0      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_checkUnpostedReceiptEntry
-- --------------------------------------------------
CREATE procedure Angel_checkUnpostedReceiptEntry  
as  
  
select * into #bse_cr from ledger where vdt >='Jan 21 2008 00:00' and vtyp=2 and drcr='C'  
select ddno,vno,lno into #chqno from ledger1 where vtyp=2 and vno >='200801210000'  
select a.*,b.ddno into #bse1 from #bse_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno  
  
select * into #aa from intranet.testdb.dbo.payin where posted_status='Y' and segment='ABLCM'   
and vdate >='Jan 21 2008 00:00'  
  
update #aa set ddno=REPLACE(DDNO,' ','')  
update #aa set ddno=REPLACE(DDNO,'A','4')  
update #aa set ddno=REPLACE(DDNO,'','/')  
update #aa set ddno=REPLACE(DDNO,'O','0')  
update #aa set ddno=REPLACE(DDNO,'`','')  
update #BSE1 set ddno=REPLACE(DDNO,'.','')  
update #BSE1 set ddno=REPLACE(DDNO,'E','')  
update #BSE1 set ddno=REPLACE(DDNO,'+','')  
  
update #BSE1 set ddno=REPLACE(DDNO,' ','')  
update #BSE1 set ddno=REPLACE(DDNO,'A','4')  
update #BSE1 set ddno=REPLACE(DDNO,'','/')  
update #BSE1 set ddno=REPLACE(DDNO,'O','0')  
update #BSE1 set ddno=REPLACE(DDNO,'`','')  
update #BSE1 set ddno=REPLACE(DDNO,'.','')  
update #BSE1 set ddno=REPLACE(DDNO,'E','')  
update #BSE1 set ddno=REPLACE(DDNO,'+','')  
  
select * from (select * from #aa where isnumeric(ddno)=1 and len(ddno)<= 7 )a   
left outer join (  
select * from #bse1 where isnumeric(ddno)=1 and len(ddno)<= 7  
) b   
on a.cltcode=b.cltcode and  convert(int,a.ddno)=convert(int,b.ddno)  
where isnull(b.ddno,0)=0   
  
  
  
update intranet.testdb.dbo.payin   
set posted_status='N'  
where srno in  
(  
select srno  
from (select * from #aa where isnumeric(ddno)=1 and len(ddno)<= 7 )a   
left outer join (select * from #bse1 where isnumeric(ddno)=1 and len(ddno)<= 7) b   
on a.cltcode=b.cltcode and  convert(int,a.ddno)=convert(int,b.ddno)  
where isnull(b.ddno,0)=0   
) and segment='ABLCM'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_Payment_reco
-- --------------------------------------------------
    
CREATE proc angel_Client_Payment_reco       
as      
    
/*
truncate table Client_Payment_reco_BSE    
    
insert into Client_Payment_reco_BSE    

select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                     
isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),                    
Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),                     
treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()                  
--into #recodet                  
From account_ab.dbo.ledger l  (nolock)  left outer join account_ab.dbo.LEDGER1 L1  (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno   where          
cltcode >='A0001' and cltcode <='ZZZZZ' and l.drcr='D'       
--and vdt <=@tdate-@daysbefore       
and clear_mode not in ( 'R', 'C') and l.vtyp  in (3)                    
and reldt ='1900-01-01 00:00:00.000'       
and vdt < getdate()  
*/

select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,                     
isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),                    
Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),                     
treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()                  
into #t                  
From account_ab.dbo.ledger l  (nolock)  left outer join account_ab.dbo.LEDGER1 L1  (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno   where          
cltcode >='A0001' and cltcode <='ZZZZZ' and l.drcr='D'       
--and vdt <=@tdate-@daysbefore       
and clear_mode not in ( 'R', 'C') and l.vtyp  in (3)                    
and reldt ='1900-01-01 00:00:00.000'       
and vdt < getdate()  


truncate table Client_Payment_reco_BSE    

insert into Client_Payment_reco_BSE     

Select l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(l.ddno,'') as ddno, 
isnull(cltcode ,'') cltcode ,                       
isnull( acname ,'') acname, l.drcr, Dramt,                    
Cramt,                       
treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()                    
from #t L, 
account_ab.dbo.LEDGER1 L1  (nolock)
where l.vno = l1.vno and l.ddno = l1.ddno and l1.vtyp <> 16

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_DelCalcBrokTax
-- --------------------------------------------------
CREATE Proc Angel_DelCalcBrokTax
(@PartyCode varchar(15), @qty int,@rate decimal)
as

declare @DelBrok decimal

--set @qty = 1000
--set @buyrate = 105
--set @sellrate = 98

select cl_code,y.table_no,y.val_perc,y.normal,y.trd_del,y.lower_lim,y.upper_lim,'DEL' as type 
into #brokInfo
from bsedb_ab.dbo.client2 x (nolock), 
bsedb_ab.dbo.broktable y (nolock)
where x.sub_tableno = y.table_no and x.cl_code =  @PartyCode

set @DelBrok = (select 
case 
when val_perc = 'P' then ((@rate*normal)/100)*@qty
when val_perc = 'V' then @qty*normal end
from #brokInfo where  @rate > lower_lim
and  @rate < upper_lim ) 

select 
DelBrok = convert(dec(10,4),@DelBrok),
TurnoverTax= convert(dec(10,4),((@qty*@rate)*Turnover_tax)/100),
Service_tax= convert(dec(10,4),(((((@qty*@rate))*Turnover_tax)/100+(@DelBrok))*10.3)/100),
STT=  convert(dec(10,2),round(((@qty*@rate)*insurance_chrg)/100,0)),
StampDuty= convert(dec(10,4),(((@qty*@rate))*Broker_note)/100),
SebiTax= convert(dec(10,4),(((@qty*@rate))*Sebiturn_tax)/100) into #fin
from bsedb_ab.dbo.taxes where Trans_Cat = 'DEL'

select *,Total=DelBrok+TurnoverTax+Service_tax+STT+StampDuty+SebiTax from #fin

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_FranchiseeFetch
-- --------------------------------------------------
CREATE PROCEDURE Angel_FranchiseeFetch(@fydate as varchar(25),@tdate as varchar(25))                                
as                                
                                
Set Nocount On                                
                                
Set transaction isolation level read uncommitted                                
select code         
into #file                                
from [CSOKYC-6].franchisee.dbo.Franchisee_glcode_Mast                                 
where segment='ABLCM' and code not in ('99790','61410')and flag<>'X' union select '520012'                                
                                
truncate table  dbo.tempbse                                
                                
insert into  dbo.tempbse                                
select l2.cltcode ,l.vtyp,l2.drcr,camt,costcode                                
from account_ab.dbo.ledger l(nolock)  , account_ab.dbo.ledger2 l2 (nolock)                                                                  
Where l.vdt >= @fydate and  l.vdt  <= @tdate  and l2.vtype <> 18                                               
and l2.cltcode IN( select code from #file)                                               
and l.vtyp = l2.vtype                                               
and l.booktype = l2.booktype and l.vno = l2.vno and l.lno = l2.lno                                 
                                
Set Nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing
-- --------------------------------------------------
CREATE procedure ANGEL_GLAgeing      
(      
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),      
@fromdate as varchar(11),@todate as varchar(11)      
)      
as      
      
set nocount on      
      
declare @fdate as datetime,@tdate as datetime      
set @fdate=convert(datetime,@fromdate+' 00:00')      
set @tdate=convert(datetime,@todate+' 23:59')      
      
      
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),      
Bal0to30=convert(money,0),      
Bal31to60=convert(money,0),      
Bal61to90=convert(money,0),      
Bal90to180=convert(money,0),      
Bal181to360=convert(money,0),      
Bal361above=convert(money,0)      
into #ageing      
from Account_AB.dbo.ledger where vdt >=@fdate and vdt <=@tdate      
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto      
group by cltcode      
      
      
      
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),      
value=sum(Case when drcr='D' then vamt else -vamt end)      
into #file1      
from Account_AB.dbo.ledger where vdt >=@fdate and vdt <=@tdate      
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto      
group by cltcode,convert(datetime,convert(varchar(11),vdt))      
      
--print @tdate-30      
update #ageing set Bal0to30=b.bal30days from      
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30      
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
      
update #ageing set Bal31to60=b.bal60days from      
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60      
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
      
update #ageing set Bal61to90=b.bal90days from      
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90      
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
      
update #ageing set Bal90to180=b.bal180days from      
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180      
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
      
update #ageing set Bal181to360=b.bal360days from      
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360      
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
      
update #ageing set Bal361above=b.bal361days from      
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360       
group by cltcode) b where #ageing.cltcode=b.cltcode      
      
    
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0    
update #ageing set bal31to60=0 where value < 0 and bal0to30 <=0 and bal31to60 > 0    
update #ageing set bal61to90=0 where value < 0 and (bal0to30+BAL31TO60) <=0 and bal61to90 > 0    
update #ageing set bal90to180=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90) <=0 and bal90to180 > 0    
update #ageing set bal181to360=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180) <=0 and bal181to360 > 0    
update #ageing set bal361above=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180+bal181to360) <=0 and bal361above > 0    
    
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0    
where value < 0 and bal0to30 < value    
    
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0    
where value < 0 and (bal0to30+bal31to60) < value     
    
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0    
where value < 0 and (bal0to30+bal31to60+bal61to90) < value     
    
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0    
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) < value     
    
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0    
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value     
    
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)    
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value     
    
------------------- Debit Balance    
    
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0    
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0    
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0    
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0    
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0    
update #ageing set bal361above=0 where value > 0 and bal361above < 0    
    
    
    
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0    
where value > 0 and bal0to30 >= value and bal0to30 > 0    
    
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0    
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0    
    
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0    
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0    
    
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0    
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0    
    
    
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0    
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value     
and bal181to360 > 0    
    
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)    
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value     
and bal361above > 0    
    
    
    
select x.*,SBcode=isnull(y.sbcode,'') from      
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x      
left outer join       
(select * from mis.remisior.dbo.remi_ledcode where coname='ABLCM') y       
on x.cltcode=y.ledgercode      
      
    
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing_New
-- --------------------------------------------------
create procedure ANGEL_GLAgeing_New          
(          
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),          
@fromdate as varchar(11),@todate as varchar(11)          
)          
as          
 --This is the rectified query by sachin dewoolkar  & alok Jain on 12/06/2009 (cr Caluclation logic has been change to reverse of dr.)    
--before any modification contact to Sachin dewoolkar or alok jain.  
set nocount on          
          
declare @fdate as datetime,@tdate as datetime          
set @fdate=convert(datetime,@fromdate+' 00:00')          
set @tdate=convert(datetime,@todate+' 23:59')          
          
          
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),          
Bal0to30=convert(money,0),          
Bal31to60=convert(money,0),          
Bal61to90=convert(money,0),          
Bal90to180=convert(money,0),          
Bal181to360=convert(money,0),          
Bal361above=convert(money,0)          
into #ageing          
from Account_AB.dbo.ledger where vdt >=@fdate and vdt <=@tdate          
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto          
group by cltcode          
          
          
          
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),          
value=sum(Case when drcr='D' then vamt else -vamt end)          
into #file1          
from Account_AB.dbo.ledger where vdt >=@fdate and vdt <=@tdate          
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto          
group by cltcode,convert(datetime,convert(varchar(11),vdt))          
          
--print @tdate-30          
update #ageing set Bal0to30=b.bal30days from          
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal31to60=b.bal60days from          
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal61to90=b.bal90days from          
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal90to180=b.bal180days from          
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal181to360=b.bal360days from          
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360          
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
          
update #ageing set Bal361above=b.bal361days from          
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360           
group by cltcode) b where #ageing.cltcode=b.cltcode          
          
        
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0        
update #ageing set bal31to60=0 where value < 0 and bal31to60 > 0        
update #ageing set bal61to90=0 where value < 0 and bal61to90 > 0        
update #ageing set bal90to180=0 where value < 0 and bal90to180 > 0        
update #ageing set bal181to360=0 where value < 0 and bal181to360 > 0        
update #ageing set bal361above=0 where value < 0 and bal361above > 0        
  
  
  
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and bal0to30 <= value and bal0to30 < 0        
  
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and bal0to30+bal31to60 <= value and bal31to60 < 0        
  
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0        
where value < 0 and (bal0to30+bal31to60+bal61to90) <= value and bal61to90 < 0        
  
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0       
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) <= value and bal90to180 < 0        
  
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0        
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) <= value         
and bal181to360 < 0        
  
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)        
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) <= value         
and bal361above < 0     
        
        
------------------- Debit Balance        
        
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0        
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0        
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0        
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0        
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0        
update #ageing set bal361above=0 where value > 0 and bal361above < 0        
        
        
        
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and bal0to30 >= value and bal0to30 > 0        
        
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0        
        
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0        
        
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0        
        
        
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value         
and bal181to360 > 0        
        
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)        
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value         
and bal361above > 0        
        
        
        
select x.*,SBcode=isnull(y.sbcode,'') from          
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x          
left outer join           
(select  top 1 * from mis.remisior.dbo.remi_ledcode where coname='ABLCM' ) y           
on x.cltcode=y.ledgercode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_rpt_Dabba_trader
-- --------------------------------------------------
CREATE Proc Angel_rpt_Dabba_trader    
as    
/*    
Exchangewise subrokerwise avegare order quantity <= 20 and order value <= 5000      
of last 30 trading days.    
*/    
    
declare @fdate as varchar(11)    
select @fdate=min(start_date) from    
(    
select top 30 * from intranet.risk.dbo.sett_mst where start_date<=getdate()    
and sett_type='N'    
order by start_date desc    
) a    
--print @fdate    
    
select Sub_broker=space(10),party_code,tradeqty=sum(tradeqty),Amount=sum(amount),sauda_date=convert(datetime,convert(varchar(11),sauda_date))    
into #bse    
from bsedb_ab.dbo.SETTLEMENT (nolock)    
where sauda_date>=@fdate    
and sauda_date<=getdate()    
group by party_code,sauda_date    
    
INSERT into #bse    
select Sub_broker=space(10),party_code,tradeqty=sum(tradeqty),Amount=sum(amount),sauda_date=convert(datetime,convert(varchar(11),sauda_date))    
from bsedb_ab.dbo.HISTORY (nolock)    
where sauda_date>=@fdate    
and sauda_date<=getdate()    
group by party_code,convert(datetime,convert(varchar(11),sauda_date))    
    
---------------------------------------------    
    
update #bse set sub_broker=b.sub_broker     
from client1 b (nolock)    
where #bse.party_code=b.cl_code    
    
select sub_broker,tradeqty=sum(tradeqty),Amount=sum(Amount),nor=count(distinct sauda_date)     
into #CND1    
from #bse    
group by sub_broker--,convert(varchar(11),sauda_date)    
having sum(tradeqty)/count(distinct sauda_date) <=20 and sum(Amount)/count(distinct sauda_date)  <=5000    
    
select b2c_sb into #ff from mis.remisior.dbo.b2c_sb    
    
    
insert into Angel_Dabba_trader    
select *,Update_date=getdate()  from #cnd1 where sub_broker not in (select b2c_sb  from #ff)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_Rpt_StampDuty_New_Report
-- --------------------------------------------------
CREATE  Proc Angel_Rpt_StampDuty_New_Report (@Start_Date Varchar(11), @End_Date Varchar(11), @State Varchar(50))      
As      
  
/*  
declare @Start_Date Varchar(11)  
declare @End_Date Varchar(11)  
declare @State Varchar(50)  
  
set @Start_Date = 'Jul 01 2007'  
set @End_Date = 'Jul 31 2007'  
set @State = '%'  
*/  
  
set @Start_Date = convert(datetime,@Start_Date,103)  
set @End_Date = convert(datetime,@End_Date,103)  
      
Select S2.sett_No,S2.Sett_Type,             
Ptqty = Sum(Case when sell_buy = 1 And BillFlag in (2,3) Then tradeqty Else 0 End),                
Stqty = sum(Case when sell_buy = 2 And BillFlag in (2,3) Then tradeqty Else 0 End) ,                
PtaMt = sum(Case when sell_buy = 1 And BillFlag in (2,3) Then tradeqty * Marketrate Else 0 End),                
Stamt = sum(Case when sell_buy = 2 And BillFlag in (2,3) Then tradeqty * Marketrate Else 0 End),                
Pdqty = Sum(Case when sell_buy = 1 And BillFlag in (1,4,5) Then tradeqty Else 0 End),                
Sdqty = sum(Case when sell_buy = 2 And BillFlag in (1,4,5) Then tradeqty Else 0 End) ,                
PdaMt = sum(Case when sell_buy = 1 And BillFlag in (1,4,5) Then tradeqty * Marketrate Else 0 End),                
Sdamt = sum(Case when sell_buy = 2 And BillFlag in (1,4,5) Then tradeqty * Marketrate Else 0 End),                
Totamt = Sum(tradeqty * marketrate), Cl_Type, L_State             
Into #StampDuty From settlement, Client2, Client1, sett_mst s2             
where settlement.sett_no = s2.sett_no And settlement.sett_type = s2.sett_type            
and s2.end_date >= @Start_Date and s2.end_date <= @End_Date + ' 23:59:59'            
And trade_no not like '%C%' and settlement.party_code = Client2.party_code                 
and Client1.Cl_code = Client2.Cl_code                 
and auctionpart not like 'F%' And auctionpart not like 'A%'                
And TradeQty > 0      
And L_State Like @State    
group by S2.Sett_Type, Cl_Type, L_State,S2.sett_No              
             
Insert Into #StampDuty            
select S2.sett_No,S2.Sett_Type,            
Ptqty = 0,                
Stqty = 0,                
PtaMt = 0,                
Stamt = 0,                
Pdqty = Sum(Case when sell_buy = 1 Then tradeqty Else 0 End),                
Sdqty = sum(Case when sell_buy = 2 Then tradeqty Else 0 End) ,                
PdaMt = sum(Case when sell_buy = 1 Then tradeqty * ISettlement.Dummy2 Else 0 End),                
Sdamt = sum(Case when sell_buy = 2 Then tradeqty * ISettlement.Dummy2 Else 0 End),                
Totamt = Sum(tradeqty * Isettlement.Dummy2),Cl_Type,L_State             
from isettlement ,Client2, Client1, sett_mst s2             
where isettlement.sett_no = s2.sett_no And isettlement.sett_type = s2.sett_type            
and s2.end_date >= @Start_Date and s2.end_date <= @End_Date + ' 23:59:59'            
And trade_no not like '%C%' and isettlement.party_code = Client2.party_code                 
and Client1.Cl_code = Client2.Cl_code                 
and auctionpart not like 'F%'  and auctionpart not like 'A%'                
And TradeQty > 0       
And L_State Like @State    
group by S2.Sett_Type, Cl_Type, L_State,S2.sett_No  
            
Insert Into #StampDuty            
Select S2.sett_No,S2.Sett_Type,            
Ptqty = Sum(Case when sell_buy = 1 And BillFlag in (2,3) Then tradeqty Else 0 End),                
Stqty = sum(Case when sell_buy = 2 And BillFlag in (2,3) Then tradeqty Else 0 End) ,                
PtaMt = sum(Case when sell_buy = 1 And BillFlag in (2,3) Then tradeqty * Marketrate Else 0 End),                
Stamt = sum(Case when sell_buy = 2 And BillFlag in (2,3) Then tradeqty * Marketrate Else 0 End),                
Pdqty = Sum(Case when sell_buy = 1 And BillFlag in (1,4,5) Then tradeqty Else 0 End),                
Sdqty = sum(Case when sell_buy = 2 And BillFlag in (1,4,5) Then tradeqty Else 0 End) ,                
PdaMt = sum(Case when sell_buy = 1 And BillFlag in (1,4,5) Then tradeqty * Marketrate Else 0 End),                
Sdamt = sum(Case when sell_buy = 2 And BillFlag in (1,4,5) Then tradeqty * Marketrate Else 0 End),                
Totamt = Sum(tradeqty * marketrate), Cl_Type, L_State             
From History, Client2, Client1, sett_mst s2             
where History.sett_no = s2.sett_no And History.sett_type = s2.sett_type            
and s2.end_date >= @Start_Date and s2.end_date <= @End_Date + ' 23:59:59'            
And trade_no not like '%C%' and History.party_code = Client2.party_code                 
and Client1.Cl_code = Client2.Cl_code                 
and auctionpart not like 'F%'  and auctionpart not like 'A%'                
And TradeQty > 0       
And L_State Like @State    
group by S2.Sett_Type, Cl_Type, L_State,S2.sett_No  
            
Insert Into #StampDuty            
select S2.sett_No,S2.Sett_Type,            
Ptqty = 0,                
Stqty = 0,                
PtaMt = 0,                
Stamt = 0,                
Pdqty = Sum(Case when sell_buy = 1 Then tradeqty Else 0 End),                
Sdqty = sum(Case when sell_buy = 2 Then tradeqty Else 0 End) ,                
PdaMt = sum(Case when sell_buy = 1 Then tradeqty * IHistory.Dummy2 Else 0 End),                
Sdamt = sum(Case when sell_buy = 2 Then tradeqty * IHistory.Dummy2 Else 0 End),                
Totamt = Sum(tradeqty * IHistory.Dummy2),Cl_Type,L_State             
from IHistory ,Client2, Client1, sett_mst s2             
where IHistory.sett_no = s2.sett_no And IHistory.sett_type = s2.sett_type            
and s2.end_date >= @Start_Date and s2.end_date <= @End_Date + ' 23:59:59'            
And trade_no not like '%C%' and IHistory.party_code = Client2.party_code                 
and Client1.Cl_code = Client2.Cl_code                 
and auctionpart not like 'F%'  and auctionpart not like 'A%'                
And TradeQty > 0       
And L_State Like @State    
group by S2.Sett_Type, Cl_Type, L_State,S2.sett_No   
  
  
truncate table  Angel_StampDuty_Report  
  
insert into Angel_StampDuty_Report                      
Select sett_No,sett_type,L_State,              
ProDelAmount = convert(numeric(18,4),     
  Sum(Case When Cl_Type = 'PRO'     
    Then (Case When Sett_Type in ('W', 'C')             
                 Then PDAmt+SDAmt+PTAmt+STAmt            
                 Else PDAmt+SDAmt             
          End)     
            Else 0    
      End)),            
ProTrdAmount = convert(numeric(18,4),     
  Sum(Case When Cl_Type = 'PRO'     
    Then (Case When Sett_Type in ('W', 'C')             
                 Then 0    
                 Else PTAmt+STAmt    
          End)     
            Else 0    
      End)),            
NrmDelAmount = convert(numeric(18,4),     
  Sum(Case When Cl_Type <> 'PRO'     
    Then (Case When Sett_Type in ('W', 'C')             
                 Then PDAmt+SDAmt+PTAmt+STAmt            
                 Else PDAmt+SDAmt             
          End)     
            Else 0    
      End)),            
NrmTrdAmount = convert(numeric(18,4),     
  Sum(Case When Cl_Type <> 'PRO'     
    Then (Case When Sett_Type in ('W', 'C')             
                 Then 0    
                 Else PTAmt+STAmt    
          End)     
            Else 0    
      End)),            
TotalAmt = convert(numeric(18,4), sum(totamt))         
From #StampDuty      
Group by L_State,sett_No,sett_type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_TrdCalcBrokTax
-- --------------------------------------------------

CREATE Proc Angel_TrdCalcBrokTax
(@PartyCode varchar(15), @qty int,@buyrate decimal,@sellrate decimal)
as

declare @FirstLeg decimal
declare @SecondLeg decimal

--set @qty = 1000
--set @buyrate = 105
--set @sellrate = 98

select cl_code,y.table_no,y.val_perc,y.day_puc,y.trd_del,y.lower_lim,y.upper_lim,'TRD' as type
into #brokInfo  from bsedb_ab.dbo.client2 x (nolock), bsedb_ab.dbo.broktable y (nolock)
where x.table_no = y.table_no and x.cl_code = @PartyCode
union
select cl_code,y.table_no,y.val_perc,y.normal,y.trd_del,y.lower_lim,y.upper_lim,'DEL' as Del 
from bsedb_ab.dbo.client2 x (nolock), 
bsedb_ab.dbo.broktable y (nolock)
where x.sub_tableno = y.table_no and x.cl_code = @PartyCode

set @FirstLeg = case when @buyrate > @sellrate then @buyrate else @sellrate end
--print @FirstLeg

set @SecondLeg = case when @buyrate < @sellrate then @buyrate else @sellrate end
--print @SecondLeg

declare @firstBrok money, @secondBrok money

set @firstBrok = (select 
case 
when val_perc = 'P' then ((@FirstLeg*day_puc)/100)*@qty
when val_perc = 'V' then @qty*day_puc end
 from #brokInfo where type = 'TRD' and Trd_del = 'F' and  @FirstLeg > lower_lim
and  @FirstLeg < upper_lim ) 

set @secondBrok = (select case 
when val_perc = 'P' then ((@SecondLeg*day_puc)/100)*@qty
when val_perc = 'V' then @qty*day_puc end
from #brokInfo where type = 'TRD' and Trd_del = 'S' and  @SecondLeg > lower_lim
and  @SecondLeg < upper_lim)

select 
BuyBrok =case when  @buyrate > @sellrate  then @firstBrok else @secondBrok  end,
SellBrok =case when @sellrate > @buyrate then @firstBrok else @secondBrok end,
 TurnoverTax=(((@qty*@sellrate)+(@qty*@buyrate))*Turnover_tax)/100,
Service_tax=(((((@qty*@sellrate)+(@qty*@buyrate))*Turnover_tax)/100+(@firstBrok+@secondBrok))*10.3)/100,
STT=((@qty*@sellrate)*insurance_chrg)/100,
StampDuty= (((@qty*@sellrate)+(@qty*@buyrate))*Broker_note)/100,
SebiTax=(((@qty*@sellrate)+(@qty*@buyrate))*Sebiturn_tax)/100
from bsedb_ab.dbo.taxes where Trans_Cat = 'TRD'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_updateBlankPswd_bsefo
-- --------------------------------------------------
CREATE procedure Angel_updateBlankPswd_bsefo  
as  
  
update bsefo.dbo.tblPradnyausers   
set fldpassword=b.encruppswd from   
(select distinct * from intranet.ctcl.dbo.blank_pswd_2007) b   
where bsefo.dbo.tblPradnyausers.fldstname=b.party_code  
  
update bsefo.dbo.tblUserControlMaster set FLDFIRSTLOGIN='Y',fldstatus=0,fldattemptcnt=0    
where FLDUSERID in  
(  
Select FLDAUTO from bsefo.dbo.tblPradnyausers where fldstname  
in  
(select distinct party_code from intranet.ctcl.dbo.blank_pswd_2007)   
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','N4511','','','1',500,88.15,2,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by AngelBSECM (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  AngelBSECM.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_ADTest
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_ADTest]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'
-- Exec BBGSettBrokDisplayVer1_ADTest '1','D','N4511','','','1',500,88.15,2,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim
				    and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_BKP06Aug2015
-- --------------------------------------------------
Create  procedure
	[dbo].[BBGSettBrokDisplayVer1_BKP06Aug2015]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'

/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor


CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable where
                                               		            S.Table_No = Broktable.Table_no
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable
							    	    where S.Table_No = Broktable.Table_no
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End

Select * from #ViewSettlement
/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_BKP12SEP2015
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'

/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable where
                                               		            S.Table_No = Broktable.Table_no
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable
							    	    where S.Table_No = Broktable.Table_no
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End

Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir

declare @Trans_Cat varchar(100)

select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note 
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_bkp28Mar2017
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_bkp28Mar2017]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','N4511','','','1',500,88.15,2,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_BKP29OCT2015
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_BKP29OCT2015]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'
if(@Party_Code='R88064')
BEGIN
print 'A'
	SET @Sauda_date = convert(varchar(11),getdate(),109)
END

/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable where
                                               		    S.Table_No = Broktable.Table_no
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable where
                                               		            S.Table_No = Broktable.Table_no
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable
							    	    where S.Table_No = Broktable.Table_no
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard
-- --------------------------------------------------

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_DealerDashboard]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate Money,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1_DealerDashboard '1','D','ALWR1937','532296','','2',100,1375,2,'JAN  1 2000','broker','broker','AJYC'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by AngelBSECM (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

--Commented By (Neelam K) As Suggested by Gaurav Garg Sir
--If(@B2C = 'Y')
--Begin
--	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
--					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
--	BEGIN
--		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
--		RETURN
--	END  
--End
--Else 
--Begin
--	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
--	and
--	NOT EXISTS (Select Sb_Tag from [INTRANET].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
--						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
--						and (C.party_code = @Party_code)
--						and C.Sub_Broker = H.Sb_Tag)
--	BEGIN
--		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
--		Return
--	END
--End

     If(@B2C <> 'Y')
		Begin
				IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
				and
				NOT EXISTS (Select Sb_Tag from [INTRANET].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails C with(nolock) 
									where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
									and (C.party_code = @Party_code)
									and C.Sub_Broker = H.Sb_Tag)
				BEGIN
					Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
					Return
		  END
     End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  AngelBSECM.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To
))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                        when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ))  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig +CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                      Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)
)
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                  Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
  and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)



/***********State Wise Stamp Duty Logic - Added by AngelBSECM on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by AngelBSECM on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_bkp12Mar2019
-- --------------------------------------------------
Create  procedure
	[dbo].[BBGSettBrokDisplayVer1_DealerDashboard_bkp12Mar2019]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate Money,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1_DealerDashboard '1','D','ALWR1937','532296','','2',100,1375,2,'JAN  1 2000','broker','broker','AJYC'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

If(@B2C = 'Y')
Begin
	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
	BEGIN
		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
		RETURN
	END  
End
Else 
Begin
	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
	and
	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
						and (C.party_code = @Party_code)
						and C.Sub_Broker = H.Sb_Tag)
	BEGIN
		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
		Return
	END
End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)



/***********State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_bkp13Dec2018
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_DealerDashboard_bkp13Dec2018]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','M114540','532296','','1',100,1000,4,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

If(@B2C = 'Y')
Begin
	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
	BEGIN
		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
		RETURN
	END  
End
Else 
Begin
	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
	and
	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
						and (C.party_code = @Party_code)
						and C.Sub_Broker = H.Sb_Tag)
	BEGIN
		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
		Return
	END
End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_Bkp21July2022
-- --------------------------------------------------
Create procedure
	[dbo].[BBGSettBrokDisplayVer1_DealerDashboard_Bkp21July2022]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate Money,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1_DealerDashboard '1','D','ALWR1937','532296','','2',100,1375,2,'JAN  1 2000','broker','broker','AJYC'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

--Commented By (Neelam K) As Suggested by Gaurav Garg Sir
--If(@B2C = 'Y')
--Begin
--	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
--					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
--	BEGIN
--		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
--		RETURN
--	END  
--End
--Else 
--Begin
--	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
--	and
--	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
--						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
--						and (C.party_code = @Party_code)
--						and C.Sub_Broker = H.Sb_Tag)
--	BEGIN
--		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
--		Return
--	END
--End

     If(@B2C <> 'Y')
		Begin
				IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
				and
				NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
									where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
									and (C.party_code = @Party_code)
									and C.Sub_Broker = H.Sb_Tag)
				BEGIN
					Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
					Return
		  END
     End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)



/***********State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_bkp23Nov2017
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_DealerDashboard_bkp23Nov2017]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

If(@B2C = 'Y')
Begin
	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
	BEGIN
		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
		RETURN
	END  
End
Else 
Begin
	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
	and
	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
						where  H.emp_no = @emp_no
						and (C.party_code = @Party_code)
						and C.Sub_Broker = H.Sb_Tag)
	BEGIN
		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
		Return
	END
End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_bkp28Mar2017
-- --------------------------------------------------
CREATE  procedure
	[dbo].[BBGSettBrokDisplayVer1_DealerDashboard_bkp28Mar2017]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate SmallMoney,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1 '1','D','A031','532296','','1',4,1070.40,4,'JAN  1 2000','broker','broker'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

If(@B2C = 'Y')
Begin
	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
	BEGIN
		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
		RETURN
	END  
End
Else 
Begin
	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
	and
	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
						where  H.emp_no = @emp_no
						and (C.party_code = @Party_code)
						and C.Sub_Broker = H.Sb_Tag)
	BEGIN
		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
		Return
	END
End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_Test
-- --------------------------------------------------

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_DealerDashboard_Test]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate Money,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1_DealerDashboard '1','D','ALWR1937','532296','','2',100,1375,2,'JAN  1 2000','broker','broker','AJYC'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

--Commented By (Neelam K) As Suggested by Gaurav Garg Sir
--If(@B2C = 'Y')
--Begin
--	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
--					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
--	BEGIN
--		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
--		RETURN
--	END  
--End
--Else 
--Begin
--	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
--	and
--	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
--						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
--						and (C.party_code = @Party_code)
--						and C.Sub_Broker = H.Sb_Tag)
--	BEGIN
--		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
--		Return
--	END
--End

     If(@B2C <> 'Y')
		Begin
				IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
				and
				NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails C with(nolock) 
									where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
									and (C.party_code = @Party_code)
									and C.Sub_Broker = H.Sb_Tag)
				BEGIN
					Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
					Return
		  END
     End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To
))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                        when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ))  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig +CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                      Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)
)
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                  Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
  and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)



/***********State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_DealerDashboard_UAT
-- --------------------------------------------------

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_DealerDashboard_UAT]
	(
		@Sett_no Varchar(7),
		@Sett_type Varchar(2),
		@Party_Code varchar(10),
		@Scrip_Cd Varchar(12),
		@series Varchar(3),
		@Sell_buy Char(1),
		@TradeQty Integer, 
		@Marketrate Money,
		@Settflag Char(1),
		@Sauda_date Varchar(11),
		@StatusName VarChar(50),
		@FromWhere VarChar(50),
		@emp_no varchar(20)
	)

as
-- Exec BBGSettBrokDisplayVer1_DealerDashboard '1','D','ALWR1937','532296','','2',100,1375,2,'JAN  1 2000','broker','broker','AJYC'

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)

--IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @Party_Code and RMDealer = @emp_no)
--BEGIN
--	Select MSG = 'ERROR', ERRORMsg = 'Client ' + @Party_Code +' is not mapped under you.'
--	RETURN
--END

Declare @B2C varchar(10)  

Select @B2C = B2C from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE

--Commented By (Neelam K) As Suggested by Gaurav Garg Sir
--If(@B2C = 'Y')
--Begin
--	IF NOT EXISTS (Select top 1 party_code from MIMANSA.angelcs.dbo.angelclient1 with(nolock) where party_code = @PARTY_CODE 
--					and (RMDealer = @emp_no or CommDealer1 = @emp_no or CommDealer2 = @emp_no))
--	BEGIN
--		Select MSG = 'ERROR', ERRORMsg = 'Client ' + @PARTY_CODE +' is not mapped under you.'
--		RETURN
--	END  
--End
--Else 
--Begin
--	IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
--	and
--	NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B C with(nolock) 
--						where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
--						and (C.party_code = @Party_code)
--						and C.Sub_Broker = H.Sb_Tag)
--	BEGIN
--		Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
--		Return
--	END
--End

     If(@B2C <> 'Y')
		Begin
				IF NOT EXISTS (Select party_code from MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails_B2B with(nolock) where RMDealer = @emp_no and party_code = @Party_code)
				and
				NOT EXISTS (Select Sb_Tag from [196.1.115.132].MIMANSA.dbo.b2b_angelharmony H with(nolock), MIMANSA.crm.dbo.tbl_CRMS_Dashboard_ClientDetails C with(nolock) 
									where (H.emp_no = @emp_no or Sb_Tag = @emp_no)
									and (C.party_code = @Party_code)
									and C.Sub_Broker = H.Sb_Tag)
				BEGIN
					Select ERROR = 'ERROR', MSG = 'The client ' + @Party_code + ' is not mapped under you.'
					Return
		  END
     End


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To
))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                        when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ))  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig +CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                      Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)
)
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)
)
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                  Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
  and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)



/***********State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_ForAPI
-- --------------------------------------------------

-- Exec [BBGSettBrokDisplayVer1_ForAPI] 'M116992','','1',75,10500,3,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI] 'ALWR1937','','1',100,100,3,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI] 'ALWR1937','','1',100,100,4,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI] 'ALWR1937','','1',100,100,5,'E60022'

-- http://172.17.41.190/BrokCalculatorAPI/Service1.svc/GetBrokCalEQ/AEMobile/8D139516-D89B-4371-BB47-D1D4D456F34A/M114540/''/1/500/88.15/2/E60022/172.17.41.190/BSE

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_ForAPI]
(
	@Party_Code varchar(10),
	@Scrip_Cd Varchar(12),
	@Sell_buy Char(1),
	@TradeQty Integer, 
	@Marketrate Money,
	@Settflag Char(1),
	@Emp_no varchar(20)
)

as
Declare @Sett_no Varchar(7) = '1',
			@Sett_type Varchar(2) = 'N',
			@series Varchar(3) = 'EQ',
			@Sauda_date Varchar(11)

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by AngelBSECM (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  AngelBSECM.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), 
							NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

--Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
--Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
--from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
--where #ViewSettlement.Party_Code= CT.Party_Code
--and CT.Todate>getdate()
--and Trans_Cat=@Trans_Cat


/***********State Wise Stamp Duty Logic - Added by AngelBSECM on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by AngelBSECM on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



Select #ViewSettlement.*,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals,
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE, Levies_Brokerage=@LeviesBrokerage, Brokerage_Type=isnull(@Brokerage_Type,'P') 
into #BrokCal
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat



Select RecordDate = Convert(varchar,getdate()), Exchange = 'BSE', Party_code,
TradeQty_amt = [Tradeqty], MarketRate_amt = convert(decimal(10,2),MarketRate), 
Brokerage_Brak = convert(decimal(10,4),NBrokApp), LeviesBrokerage_perc = convert(decimal(10,4),other_chrg),
--LeviesBrokerage_Amt = convert(decimal(10,2),(Brokapplied * [Tradeqty])),
LeviesBrokerage_Amt = convert(decimal(10,2),((case when Brokapplied <> 0 then Brokapplied else NBrokApp end ) * [Tradeqty])),
--NetRate = convert(decimal(10,4),NetRate), 
NetRate = convert(decimal(10,4),(case when N_NetRate <> 0 then N_NetRate else (MarketRate + NBrokApp) end )), 
TurnoverTax_Levies = convert(decimal(10,5),Levies_TurnoverTax),
TurnoverTax_Amt = convert(decimal(10,2),turn_tax),
STT_Levies = convert(decimal(10,2),LeviesSTT), 
STT_Amt = convert(decimal(10,2),Ins_chrg), 
StampDuty_Levies = convert(decimal(10,4),Levies_StampDuty), 
StampDuty_Amt = convert(decimal(10,2),Broker_chrg), 
SebiTax_Levies = convert(decimal(10,4),Levies_SebiTax),
SebiTax_Amt = convert(decimal(10,2),sebi_tax),
GST_Levies = convert(decimal(10,2),LeviesServ_Tax),
GST_Amt = convert(decimal(10,2),NSerTax),
TradeAmtWithBrok = convert(decimal(10,2),(N_NetRate * Tradeqty)),
--TotalLevies = convert(decimal(10,2),(Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
TotalLevies = convert(decimal(10,2),(other_chrg + Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
Brokerage_Type = isnull(@Brokerage_Type,'P') 
from #BrokCal

--Select N_NetRate from #BrokCal

--other_chrg+NSerTax+Ins_chrg+turn_tax+sebi_tax+Broker_chrg


/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_ForAPI_ADTest
-- --------------------------------------------------

-- Exec [BBGSettBrokDisplayVer1_ForAPI_ADTest] 'ALWR1937','','1',100,100,2,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI_ADTest] 'ALWR1937','','1',100,100,3,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI_ADTest] 'ALWR1937','','1',100,100,4,'E60022'
-- Exec [BBGSettBrokDisplayVer1_ForAPI_ADTest] 'ALWR1937','','1',100,100,5,'E60022'

-- http://172.17.41.190/BrokCalculatorAPI/Service1.svc/GetBrokCalEQ/AEMobile/8D139516-D89B-4371-BB47-D1D4D456F34A/M114540/''/1/500/88.15/2/E60022/172.17.41.190/BSE

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_ForAPI_ADTest]
(
	@Party_Code varchar(10),
	@Scrip_Cd Varchar(12),
	@Sell_buy Char(1),
	@TradeQty Integer, 
	@Marketrate SmallMoney,
	@Settflag Char(1),
	@Emp_no varchar(20)
)

as
Declare @Sett_no Varchar(7) = '1',
			@Sett_type Varchar(2) = 'N',
			@series Varchar(3) = 'EQ',
			@Sauda_date Varchar(11)

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), 
							NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

--Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
--Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
--from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
--where #ViewSettlement.Party_Code= CT.Party_Code
--and CT.Todate>getdate()
--and Trans_Cat=@Trans_Cat


/***********State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/




	--Declare @Party_code varchar(20) = @Party_Code
	Declare @Segment varchar(10) = 'BSE' 
	--Declare @SettFLAG int = @Settflag
	--Declare @TRADEQTY bigint = @TradeQty
	--Declare @MARKETRATE money = @Marketrate
	
	Declare @BROKER_CHRG money = 0
	Declare @ROUNDEDTURNOVER money = 0
	Declare @BROKER_NOTE money = 0
	Declare @MyBroker_chrg money
	Declare @Mystate varchar(50)
	Declare @StateTrdBroker_Chrg money
	Declare @StateDelBroker_Chrg money
	Declare @Min_Multiplier money
	Declare @For_TurnOver money
	Declare @Maximum_Limit money
	Declare @Del_Min_Multiplier money
	Declare @Del_For_TurnOver money
	Declare @StampExists money
	Declare @TRD_ROUNDEDTURNOVER money
	Declare @DEL_ROUNDEDTURNOVER money
	Declare @TOBECHRG_STAMPDUTY money
	Declare @TRD_TURNOVER money             
	Declare @DEL_TURNOVER money 
	
	Print @Segment

	Select  @MyBroker_chrg = Broker_Note from [MIMANSA].[ClientService].dbo.BseClientTaxes_New where party_code = @Party_code
	Select @Mystate = Isnull(L_State,'') from [MIMANSA].Angelcs.dbo.Angelclient1 with(nolock) Where party_code = @Party_code 

	PRINT @MyBroker_chrg
	PRINT 'Mystate' + ':' + @Mystate

	If @Mystate =''
	Begin
			Select @Mystate = [State] from [MIMANSA].[ClientService].dbo.Owner1   
	End

	Select @StateTrdBroker_Chrg = TRDSTAMPDUTY, @StateDelBroker_Chrg  = DelStampDuty,@Min_Multiplier = Min_Multiplier,
	@For_TurnOver = For_TurnOver ,@Maximum_Limit=Maximum_Limit, @Del_Min_Multiplier= Del_Min_Multiplier,@Del_For_TurnOver=Del_For_TurnOver
	From [MIMANSA].[ClientService].dbo.BSeSTATE_MASTER_DATA Where [State] = @Mystate

	--Select StateTrdBroker_Chrg = @StateTrdBroker_Chrg , StateDelBroker_Chrg = @StateDelBroker_Chrg ,
	--Min_Multiplier  = @Min_Multiplier, For_TurnOver = @For_TurnOver , Maximum_Limit = @Maximum_Limit, 
	--Del_Min_Multiplier = @Del_Min_Multiplier, Del_For_TurnOver = @Del_For_TurnOver

	If @MyBroker_Chrg <> 0 and ( @StateTrdBroker_Chrg is not Null Or @StateDelBroker_Chrg is not null)
	Begin

		Print 'Here1'

		Set @BROKER_CHRG = 0
	     
		SET @BROKER_CHRG = Case when @SettFLAG IN (2,3)  then (@TRADEQTY*@MARKETRATE*@StateTrdBroker_Chrg) /Cast(100 As Money)                      
								when @SettFLAG IN (4,5) then (@TRADEQTY*@MARKETRATE*@StateDelBroker_Chrg)/Cast(100 As Money)   
								end    
	   
		print @BROKER_CHRG

		If(@Del_For_TurnOver > 0)
		Begin     
			SET @ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((@TRADEQTY*@MARKETRATE), @For_TurnOver)         
			SET @TRD_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER((CASE WHEN @SettFLAG < 4 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END), @For_TurnOver)             
			SET @DEL_ROUNDEDTURNOVER = dbo.ROUNDEDTURNOVER(CASE WHEN @SettFLAG > 3 THEN (@TRADEQTY*@MARKETRATE) ELSE 0 END, @Del_For_TurnOver)                                        
		End

		PRINT @BROKER_NOTE

		SET @TOBECHRG_STAMPDUTY = (CASE WHEN @FOR_TURNOVER = @DEL_FOR_TURNOVER           
										THEN (CASE WHEN @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @MAXIMUM_LIMIT 
															AND @MAXIMUM_LIMIT > 0  
													THEN @MAXIMUM_LIMIT                        
													WHEN  @FOR_TURNOVER > 0 and @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER > @BROKER_NOTE                        
													THEN  @ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER                        
													WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0                          
													THEN @MAXIMUM_LIMIT                        
													ELSE @BROKER_NOTE                         
												END)                        
										ELSE            
										(CASE WHEN @FOR_TURNOVER > 0 and ( @TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @MAXIMUM_LIMIT 
														AND @MAXIMUM_LIMIT > 0                       
												THEN @MAXIMUM_LIMIT                      
												WHEN @FOR_TURNOVER > 0 and (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER) > @BROKER_NOTE           
												THEN (@TRD_ROUNDEDTURNOVER/@FOR_TURNOVER * @MIN_MULTIPLIER) +          
														(@DEL_ROUNDEDTURNOVER/@DEL_FOR_TURNOVER * @DEL_MIN_MULTIPLIER)          
												WHEN @BROKER_NOTE > @MAXIMUM_LIMIT AND @MAXIMUM_LIMIT > 0          
												THEN @MAXIMUM_LIMIT                      
												ELSE @BROKER_NOTE                       
										END)          
									END)          
	
		Select @StampExists = Isnull(Sum(@TOBECHRG_STAMPDUTY),0) 

		If @StampExists <> 0 
		Begin
			Set @BROKER_CHRG = 0
			Set @BROKER_CHRG = @TOBECHRG_STAMPDUTY 
		End

		If(@SettFLAG in (2,3))
		Begin
			Set @BROKER_NOTE = @StateTrdBroker_Chrg
			--Select StampDuty_Levies = @StateTrdBroker_Chrg, StampDuty_Amt = @BROKER_CHRG 
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else If(@SettFLAG in (4,5))
		Begin
			Set @BROKER_NOTE = @StateDelBroker_Chrg
			--Select StampDuty_Levies = @StateDelBroker_Chrg , StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End
		Else 
		Begin
			Set @BROKER_NOTE = 0
			--Select StampDuty_Levies = 0, StampDuty_Amt = @BROKER_CHRG
			Update #ViewSettlement set Broker_chrg = @BROKER_CHRG
		End

	End    


/***********End State Wise Stamp Duty Logic - Added by Anand on Dec 13 2018 - Logic from SP - GetClientTradesbill*********/



Select #ViewSettlement.*,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals,
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=@BROKER_NOTE, Levies_Brokerage=@LeviesBrokerage, Brokerage_Type=isnull(@Brokerage_Type,'P') 
into #BrokCal
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat



Select RecordDate = Convert(varchar,getdate()), Exchange = 'BSE', Party_code,
TradeQty_amt = [Tradeqty], MarketRate_amt = convert(decimal(10,2),MarketRate), 
Brokerage_Brak = convert(decimal(10,4),NBrokApp), LeviesBrokerage_perc = convert(decimal(10,4),other_chrg),
--LeviesBrokerage_Amt = convert(decimal(10,2),(Brokapplied * [Tradeqty])),
LeviesBrokerage_Amt = convert(decimal(10,2),((case when Brokapplied <> 0 then Brokapplied else NBrokApp end ) * [Tradeqty])),
--NetRate = convert(decimal(10,4),NetRate), 
NetRate = convert(decimal(10,4),(case when NetRate <> 0 then NetRate else (MarketRate + NBrokApp) end )), 
TurnoverTax_Levies = convert(decimal(10,5),Levies_TurnoverTax),
TurnoverTax_Amt = convert(decimal(10,2),turn_tax),
STT_Levies = convert(decimal(10,2),LeviesSTT), 
STT_Amt = convert(decimal(10,2),Ins_chrg), 
StampDuty_Levies = convert(decimal(10,4),Levies_StampDuty), 
StampDuty_Amt = convert(decimal(10,2),Broker_chrg), 
SebiTax_Levies = convert(decimal(10,4),Levies_SebiTax),
SebiTax_Amt = convert(decimal(10,2),sebi_tax),
GST_Levies = convert(decimal(10,2),LeviesServ_Tax),
GST_Amt = convert(decimal(10,2),NSerTax),
TradeAmtWithBrok = convert(decimal(10,2),(N_NetRate * Tradeqty)),
--TotalLevies = convert(decimal(10,2),(Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
TotalLevies = convert(decimal(10,2),(other_chrg + Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
Brokerage_Type = isnull(@Brokerage_Type,'P') 
from #BrokCal

--other_chrg+NSerTax+Ins_chrg+turn_tax+sebi_tax+Broker_chrg


/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGSettBrokDisplayVer1_ForAPI_bkp12Dec2018
-- --------------------------------------------------

-- Exec BBGSettBrokDisplayVer1_ForAPI 'M114540','','1',100,100,5,'E60022'
-- http://172.17.41.190/BrokCalculatorAPI/Service1.svc/GetBrokCalEQ/AEMobile/8D139516-D89B-4371-BB47-D1D4D456F34A/M114540/''/1/500/88.15/2/E60022/172.17.41.190/BSE

CREATE  procedure [dbo].[BBGSettBrokDisplayVer1_ForAPI_bkp12Dec2018]
(
	@Party_Code varchar(10),
	@Scrip_Cd Varchar(12),
	@Sell_buy Char(1),
	@TradeQty Integer, 
	@Marketrate SmallMoney,
	@Settflag Char(1),
	@Emp_no varchar(20)
)

as
Declare @Sett_no Varchar(7) = '1',
			@Sett_type Varchar(2) = 'N',
			@series Varchar(3) = 'EQ',
			@Sauda_date Varchar(11)

	SET @Sauda_date = convert(varchar(11),getdate(),109) --Added by Anand (Approved by BG sir)


/* Consists of 2 SPS  NewUpdBillTaxAfterBill and BBGInsSettBrokRecal */
Declare
@@Party_code As Varchar(12),
@@Scrip_cd As Varchar(12),
@@Series As Varchar(3),
@@PartipantCode Varchar(15),
@@Sell_buy As Int,
@@Pqty As Int,
@@Sqty As Int,
@@Prate As Money,
@@Srate As Money,
@@TPqty As Int,
@@TSqty As Int,
@@TPrate As Money,
@@TSrate As Money,
@@Tmark Varchar(3),
@@Sett_no  As varchar(10),
@@PMore AS Char (1),
@@PRateMore As Char(1),
@@SMore AS Char (1),
@@SRateMore As Char(1),
@@EQ As Char(1),
@@GetPos AS Cursor,
@@GetParty As Cursor,
@STT_From_Global float,
@Service_Tax_From_Globals float

Select @STT_From_Global=ISNULL((case when @Settflag=2 then TrdBuyTrans when @Settflag=3 then TrdSellTrans
									when @Settflag=4 then DelBuyTrans when @Settflag=5 then DelSellTrans else 0 end),0),
		@Service_Tax_From_Globals=ISNULL(service_tax,0)
from bsedb_ab.dbo.Globals  where year_end_dt>getdate()                            -- Suggested by Dharmesh on Aug 06 2015

PRINT @STT_From_Global
PRINT @Service_Tax_From_Globals

--select TrdBuyTrans, TrdSellTrans, DelBuyTrans, DelSellTrans from  Anand.bsedb_ab.dbo.Globals  where year_end_dt>getdate()

CREATE TABLE #ViewSettlement(
	[ContractNo] [varchar](14) NOT NULL,
	[BillNo] [varchar](10) NOT NULL,
	[Trade_no] [varchar](20) NULL,
	[Party_Code] [varchar](10) NOT NULL,
	[Scrip_Cd] [varchar](10) NOT NULL,
	[User_id] [varchar](10) NULL,
	[Tradeqty] [int] NOT NULL,
	[AuctionPart] [varchar](2) NOT NULL,
	[MarketType] [varchar](2) NOT NULL,
	[Series] [char](2) NOT NULL,
	[Order_no] [varchar](16) NULL,
	[MarketRate] [money] NOT NULL,
	[Sauda_date] [datetime] NULL,
	[Table_No] [varchar](4) NOT NULL,
	[Line_No] [numeric](3, 0) NOT NULL,
	[Val_perc] [char](1) NOT NULL,
	[Normal] [money] NOT NULL,
	[Day_puc] [money] NOT NULL,
	[day_sales] [money] NOT NULL,
	[Sett_purch] [money] NOT NULL,
	[Sett_sales] [money] NOT NULL,
	[Sell_buy] [int] NOT NULL,
	[Settflag] [int] NOT NULL,
	[Brokapplied] [money] NOT NULL,
	[NetRate] [numeric](15, 7) NOT NULL,
	[Amount] [money] NOT NULL,
	[Ins_chrg] [money] NOT NULL,
	[turn_tax] [money] NOT NULL,
	[other_chrg] [money] NOT NULL,
	[sebi_tax] [money] NOT NULL,
	[Broker_chrg] [money] NOT NULL,
	[Service_tax] [money] NOT NULL,
	[Trade_amount] [money] NOT NULL,
	[Billflag] [int] NOT NULL,
	[sett_no] [varchar](7) NOT NULL,
	[NBrokApp] [money] NOT NULL,
	[NSerTax] [money] NOT NULL,
	[N_NetRate] [numeric](15, 7) NOT NULL,
	[sett_type] [varchar](3) NOT NULL,
	[Partipantcode] [varchar](15) NULL,
	[Status] [varchar](2) NULL,
	[Pro_Cli] [int] NULL,
	[CpId] [varchar](20) NULL,
	[Instrument] [varchar](2) NULL,
	[BookType] [varchar](2) NULL,
	[Branch_Id] [varchar](10) NULL,
	[TMark] [varchar](1) NULL,
	[Scheme] [varchar](2) NULL,
	[Dummy1] [money] NULL,
	[Dummy2] [varchar](5) NULL  --,
	--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 

 Insert into #ViewSettlement Values(
'0',  --[ContractNo] [varchar](14) NOT NULL,
'0',  --[BillNo] [varchar](10) NOT NULL,
'0',  --[Trade_no] [varchar](20) NULL,
@Party_Code,-- [Party_Code] [varchar](10) NOT NULL,
@Scrip_Cd, --[Scrip_Cd] [varchar](10) NOT NULL,
'0',--[User_id] [varchar](10) NULL,
@TradeQty, --[Tradeqty] [int] NOT NULL,
'',--[AuctionPart] [varchar](2) NOT NULL,
'',--[MarketType] [varchar](2) NOT NULL,
'',--[Series] [char](2) NOT NULL,
'0',--[Order_no] [varchar](16) NULL,
@Marketrate,--[MarketRate] [money] NOT NULL,
Getdate(),--[Sauda_date] [datetime] NULL, cast(Left(Convert(Varchar,getdate(),109),11) As Datetime)
'',--[Table_No] [varchar](4) NOT NULL,
0,--[Line_No] [numeric](3, 0) NOT NULL,
'',--[Val_perc] [char](1) NOT NULL,
0,--[Normal] [money] NOT NULL,
0,--[Day_puc] [money] NOT NULL,
0,--[day_sales] [money] NOT NULL,
0,--[Sett_purch] [money] NOT NULL,
0,--[Sett_sales] [money] NOT NULL,
@Sell_buy,--[Sell_buy] [int] NOT NULL,
4 /* @Settflag */, --[Settflag] [int] NOT NULL,
0,--[Brokapplied] [money] NOT NULL,
0,--[NetRate] [numeric](15, 7) NOT NULL,
0,--[Amount] [money] NOT NULL,
0,--[Ins_chrg] [money] NOT NULL,
0,--[turn_tax] [money] NOT NULL,
0,--[other_chrg] [money] NOT NULL,
0,--[sebi_tax] [money] NOT NULL,
0,--[Broker_chrg] [money] NOT NULL,
0,--[Service_tax] [money] NOT NULL,
0,--[Trade_amount] [money] NOT NULL,
0,--[Billflag] [int] NOT NULL,
'2000001',--[sett_no] [varchar](7) NOT NULL,
0,--[NBrokApp] [money] NOT NULL,
0,--[NSerTax] [money] NOT NULL,
0,--[N_NetRate] [numeric](15, 7) NOT NULL,
'D',--[sett_type] [varchar](3) NOT NULL,
'612',--[Partipantcode] [varchar](15) NULL,
'A',--[Status] [varchar](2) NULL,
0,--[Pro_Cli] [int] NULL,
'',--[CpId] [varchar](20) NULL,
'',--[Instrument] [varchar](2) NULL,
'',--[BookType] [varchar](2) NULL,
'',--[Branch_Id] [varchar](10) NULL,
Case When @Settflag in(2,3) Then 'T' Else 'D' End ,--[TMark] [varchar](1) NULL,
'',--[Scheme] [varchar](2) NULL,
'',--[Dummy1] [money] NULL,
'' --,--[Dummy2] [varchar](5) NULL --,
--1,--[SRNO] [bigint] IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,
 ) 


--select * from #ViewSettlement
 

If @SettFlag in(2,3) 
Begin 

Set @@Getparty = Cursor For
Select distinct Party_code,Scrip_cd,Series,PartipantCode From #ViewSettlement
--Where
--Sett_no = @sett_no
--And
--Sett_type = @Sett_type
--And
--Party_Code = @Party_Code
--And
--Scrip_Cd Like @Scrip_Cd
--And
--Series Like @Series
--And
--Sauda_Date Like @Sauda_Date + '%'

Open @@Getparty
Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode
--Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode 



While @@fetch_status = 0
Begin
     Set @@Pqty = 0
     Set @@Prate = 0
     Set @@Sqty = 0
     Set @@Srate = 0
     Set @@Tpqty = 0
     Set @@Tprate = 0
     Set @@TSqty = 0
     Set @@TSrate = 0
/*  Select  @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode */

     Set @@GetPos = Cursor For
     Select Sell_buy,
     pqty = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty),0) else 0 end ),0),
     prate = Isnull((Case When Sell_buy = 1 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0),
     Sqty = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty),0) else 0 end ),0),
     srate = Isnull((Case When Sell_buy = 2 then isnull(sum(tradeqty*marketrate)/(case when sum(tradeqty) = 0 then 1 else sum(tradeqty)end ),0) else 0 end ),0)
     From #ViewSettlement t1
     /* Where
     T1.Party_code = @@party_code
     And
     T1.Sett_no = @Sett_no
     And
     T1.Scrip_cd = @@Scrip_cd
     And
     T1.Series =  @@Series
     And
     T1.Sett_type = @Sett_type
     And
     T1.PartipantCode = @@PartipantCode*/
     Group by T1.Sett_No,T1.Sett_Type, t1.party_code,t1.scrip_cd,t1.series,t1.sell_buy,PartipantCode

     Open @@GetPos
     Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate


     While @@Fetch_status = 0
     Begin
     --Select @@Sell_buy,@@Pqty,@@Sqty,@@Prate,@@Srate,@@PartipantCode,@@Tmark 
     If @@Sell_buy = 1
     Begin
          Set @@TPqty = @@Pqty
          Set @@TPrate = @@Prate
     End
     If @@Sell_buy = 2
     Begin
          Set @@TSqty = @@Sqty
          Set @@TSrate = @@Srate
     End
          Fetch Next from @@Getpos into @@Sell_buy,@@Pqty,@@Prate,@@Sqty,@@Srate
     End

/* Select @@Pqty
Select @@Prate
Select @@SQty
Select @@Srate
return
*/
Set @@Pmore = 'N'
Set @@SMore = 'N'
Set @@SrateMore = 'N'
Set @@PrateMore = 'N'
Set @@Eq= 'N'



If @@TPqty > @@TSqty
Begin
     Set @@Pmore = 'Y'
End
If @@TSqty > @@TPqty
Begin
     Set @@Smore = 'Y'
End

If @@TPqty = @@TSqty
Begin
     Set @@Pmore = 'Y'
     Set @@Smore = 'Y'
     Set @@Eq = 'Y'
     If @@TSRate > @@TPRate
     Begin
          Set @@SRatemore = 'Y'
     End
     If @@TPRate > @@TSRate
     Begin
        Set @@PRatemore = 'Y'
     End
End

/*
Select @@Pmore
Select @@Smore
Select @@PRatemore
Select @@Sratemore
Select @@Eq

Return
*/


/* Select @Tdate = Ltrim(Rtrim(@Tdate))
If Len(@Tdate) = 10
Begin
          Select @Tdate = STUFF(@Tdate, 4, 1,'  ')
End
*/
/*Select @Tparty = Ltrim(Rtrim(@Tparty))
Select @Tscrip_cd = Ltrim(Rtrim(@TScrip_cd))
Select @Tmark = Ltrim(Rtrim(@Tmark))
*/
/*Select @Tparty,@TdATE ,@Tscrip_cd,@Tmark*/


update #ViewSettlement set
--Select Trade_no,Tradeqty,PartipantCode,
--Select   
Tmark = Tmark,
    Table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    Sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    BrokApplied =(Case
		when #ViewSettlement.status = 'N' then 0
	       else
               (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */

		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End)
                       END  ),
       NetRate = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End)
                    END     ),
       Amount = (Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE * #ViewSettlement. TRADEQTY
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                             #ViewSettlement.Tradeqty  *  (  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))

                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                               #ViewSettlement.Tradeqty  * (   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                #ViewSettlement.Tradeqty * (   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                             #ViewSettlement.Tradeqty * (    #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                              #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                              #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))


                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                               #ViewSettlement.Tradeqty * (  #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                     #ViewSettlement.Tradeqty * ( #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) )
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                       #ViewSettlement.Tradeqty  * (  #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To)))
   Else  0
                        End )
                      END   ),
/*       Ins_chrg  =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),


        turn_tax  = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /
		power(10,CT.Round_To))END),

        other_chrg =(Case
		when #ViewSettlement.status = 'N' then 0
		ELSE  ((floor(( ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) / 	power(10,CT.Round_To))END),

        sebi_tax =(Case
		when #ViewSettlement.status = 'N' then 0
   		ELSE  ((floor(( ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /	power(10,CT.Round_To))END),

        Broker_chrg = (Case
		when #ViewSettlement.status = 'N' then 0
		ELSE ((floor(( ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) / (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) ) /power(10,CT.Round_To))END),
*/


        --Ins_chrg  = ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Ins_chrg  = ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),         --Suggested by Dharmesh on Aug 06 2015
        turn_tax  = ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        other_chrg = ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ),
        sebi_tax = ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),
        Broker_chrg = ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100),

        Service_tax =(Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    )/*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Globals.service_tax)  END )*/,
      Trade_amount = #ViewSettlement.Tradeqty * #ViewSettlement.MarketRate,
      NBrokApp = (Case
		when #ViewSettlement.status = 'N' then 0
	       else
(  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then  /* broktable.Normal */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                          ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
                         when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))
   Else  0
                        End )
                        end ),
        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else  (Case
		when #ViewSettlement.status = 'N' then 0
	       else
 (  case
                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                              Then
		( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )


                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                              Then /* broktable.Normal  */
		(( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
		power(10,CT.Round_To))) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                               Then
                                      ((    ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                             Then /* round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)         */
		((  ((floor(( ((broktable.Normal /100 )* #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                            Then /* ((broktable.day_puc)) */
		((  ((floor(( ((broktable.day_puc))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                      when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                             Then /* round((broktable.day_puc/100) * #ViewSettlement.marketrate,CT.Round_To)  */
		(( ((floor(( ((broktable.day_puc/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                   when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                             Then /* broktable.day_sales */
		(( ((floor(( broktable.day_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))   ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                  when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                             Then /*round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To) */
		( (  ((floor(( ((broktable.day_sales/ 100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                 when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                             Then /* broktable.sett_purch  */
		(( ((floor(( broktable.sett_purch * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))  ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To) */
		((  ((floor(( ((broktable.sett_purch/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
             when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
                             Then /* broktable.sett_sales */
		((  ((floor(( broktable.sett_sales * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )

 when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
                             Then /* round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)*/
		((  ((floor(( ((broktable.sett_sales/100) * #ViewSettlement.marketrate) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   Else  0
                        End
                         )
			End )
                     END    ),
N_NetRate =(Case
		when #ViewSettlement.status = 'N' then #ViewSettlement.MARKETRATE
	       else
(  case
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
                                                      Then /* round (( #ViewSettlement.marketrate + broktable.Normal),CT.Round_To) */
                                                                 #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))


                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
                                                       Then /* round((#ViewSettlement.marketrate - broktable.Normal ),CT.Round_To )    */
                                                                  #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                                           when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
                                                        Then /* (#ViewSettlement.marketrate + round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To)) */
                                                                   #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
                                                       Then /* (#ViewSettlement.marketrate - round((broktable.Normal /100 )* #ViewSettlement.marketrate,CT.Round_To))           */
                                                                   #ViewSettlement.marketrate -  ((floor((  ( ((broktable.Normal /100 )* #ViewSettlement.marketrate))  * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
                                                    Then /* round((broktable.day_puc + #ViewSettlement.marketrate ),CT.Round_To)*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.day_puc  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate + round((broktable.day_puc/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate + ((floor(( (((broktable.day_puc/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                          when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
                                                     Then /* round((#ViewSettlement.marketrate - broktable.day_sales),CT.Round_To)*/
                                                               #ViewSettlement.marketrate - ((floor(( (( broktable.day_sales)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
                                                    Then /* (#ViewSettlement.marketrate - round((broktable.day_sales/ 100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                #ViewSettlement.marketrate - ((floor((  (((broktable.day_sales/ 100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
                                                     Then /* round((broktable.sett_purch + #ViewSettlement.marketrate ),CT.Round_To )*/
                                                                 #ViewSettlement.marketrate + ((floor(( ((broktable.sett_purch  )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
                                                      Then /* (#ViewSettlement.marketrate + round(( broktable.sett_purch/100) * #ViewSettlement.marketrate ,CT.Round_To))*/
                                                                 #ViewSettlement.marketrate + ((floor(( ( (( broktable.sett_purch/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                        when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='V' )
                                                      Then /* round(( #ViewSettlement.marketrate - broktable.sett_sales ),CT.Round_To) */
                                                                   #ViewSettlement.marketrate - ((floor(( (( broktable.sett_sales )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  	(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                                         when ( #ViewSettlement.SettFlag =5  and broktable.val_perc ='P' )
                                                     Then /* (#ViewSettlement.marketrate - round((broktable.sett_sales/100) * #ViewSettlement.marketrate ,CT.Round_To)) */
                                                                 #ViewSettlement.marketrate -  ((floor((  (((broktable.sett_sales/100) * #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
   Else  0
                        End )
                        end )

   FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   And Broktable.Line_no = ( case when S.BrokScheme = 2 then
							    (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del =
							    ( Case When @@Eq = 'Y' then
								  ( Case When @@PRatemore = 'Y'
									 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    		             Then 'F'
							    		             Else 'S'
									        End )
									 Else
									      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		             Then 'F'
							    			     Else 'S'
									        End )
									 End )
								   Else
									( Case When @@PMore = 'Y'
									       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			           Then 'F'

							    			           Else 'S'
										      End )
									       Else
									           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    		                  Then
                                                                                              'F'
                                                                                          Else
                                                                                              'S'
									             End )
									  End )
								   End )
							    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
						else ( case when S.BrokScheme = 1 then
					       		   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		    S.Table_No = Broktable.Table_no
														and S.party_code = #ViewSettlement.Party_Code
				                	    and Trd_Del = ( Case When @@PMore = 'Y'
										 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									     	 Else
										      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			 	    Then 'F'
							    			 	    Else 'S'
										       End )
									    End )
                                                	    and #ViewSettlement.Party_Code =  Client2.Party_code
                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
							else ( case when S.BrokScheme = 3 then
					       		   	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
                                               		            S.Table_No = Broktable.Table_no
																and S.party_code = #ViewSettlement.Party_Code
				                	            and Trd_Del = ( Case When @@SMore ='Y'
									        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
							    			           	     Then 'F'
							    			 	             Else 'S'
										         End )
									     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
							    			 	        Then 'F'
							    			 	        Else 'S'
										           End )
									            End )
        	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	                                               		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
								else
							    	   (Select min(Broktable.line_no) from broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) 
							    	    where S.Table_No = Broktable.Table_no
										and S.party_code = #ViewSettlement.Party_Code
							     	    And Trd_Del = 'T'
   		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
				           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
								end )
							end )
						end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt

Fetch Next from @@Getparty into @@Party_code,@@Scrip_cd,@@Series,@@PartipantCode

End
End

If @SettFlag in(4,5) 
Begin 
Update #ViewSettlement set 
/* Tmark = 'D' ,*/ table_no = broktable.table_no, line_no = broktable.line_no,val_perc = broktable.val_perc,
    Normal = Broktable.Normal, day_puc= Broktable.Day_puc,day_sales = Broktable.day_sales,
    sett_purch =   Broktable.Sett_purch,sett_sales = broktable.Sett_sales,
    NBrokApp = (  case
    when (  broktable.val_perc ='V' )
                             Then
		((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /

		(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /

		power(10,CT.Round_To))

                        when (  broktable.val_perc ='P' )
                             Then      ((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
          BrokApplied
                        End
                         ),
       N_NetRate = (  case
                      when (  broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY = 1)
                             Then
                                  #ViewSettlement.marketrate + ((floor((  (( broktable.Normal)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
                      when (  broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 1 )
                             Then #ViewSettlement.marketrate + ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))

                      when (broktable.val_perc ='V' AND #ViewSettlement.SELL_BUY =2 )
                             Then #ViewSettlement.marketrate - ((floor(( (( broktable.Normal )) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / 	power(10,CT.Round_To))
                      when ( broktable.val_perc ='P' AND #ViewSettlement.SELL_BUY = 2 )
                             Then
                      #ViewSettlement.marketrate - ((floor(( (((broktable.Normal /100 )* #ViewSettlement.marketrate)) * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To))
   Else
             NetRate
                        End
                         ),/*modified by bhayashree on 27-12-2000*/

        NSertax = (Case When Client2.Service_Chrg = 1 And Client2.SerTaxMethod = 1
			     Then 0
			     Else (case when ( broktable.val_perc ='V' )
			Then ( ( ((floor(( broktable.Normal * power(10,CT.Round_To)+CT.RoFig + CT.ErrNum ) /
				(CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  /
				power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
                        when (broktable.val_perc ='P' )
                        Then ((((floor ( (((broktable.Normal /100 ) * #ViewSettlement.marketrate)  * power(10,CT.Round_To) + CT.RoFig + CT.ErrNum ) /  (CT.RoFig + CT.NoZero )) * (CT.RoFig +CT.NoZero ) )  / power(10,CT.Round_To)) ) * ( #ViewSettlement.Tradeqty * Globals.service_tax) )  / ( CASE WHEN CLIENT2.Service_chrg <>  3 THEN 100 ELSE (100 + Globals.service_tax)  END )
   			Else #ViewSettlement.Service_tax
                        End ) End
                         ) /*  /  ( CASE WHEN CLIENT2.Service_chrg =  0 THEN 100 ELSE (100 + Settlement.service_tax)  END )*/,
--Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.insurance_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),
Ins_chrg  =(Case when #ViewSettlement.status = 'N' then 0 else ((@STT_From_Global * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) End),   --Suggested by Dharmesh on Aug 05 2015
turn_tax  = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.turnover_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
other_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.other_chrg * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100 ) end),
sebi_tax = (Case when #ViewSettlement.status = 'N' then 0 else ((CT.sebiturn_tax * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end),
Broker_chrg =(Case when #ViewSettlement.status = 'N' then 0 else ((CT.broker_note * #ViewSettlement.marketrate * #ViewSettlement.Tradeqty)/100) end)

      FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      And Broktable.Line_no = (Select min(Broktable.line_no) from Bsedb_ab.dbo.broktable with(nolock), Bsedb_ab.dbo.ClientBrok_Scheme S with(nolock) where
		               S.Table_No = Broktable.Table_no
			       And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			       And #ViewSettlement.marketrate <= Broktable.upper_lim 
				   and S.party_code = #ViewSettlement.Party_Code)
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
End


declare @LeviesBrokerage money
Declare @Brokerage_Type varchar(2)
Declare @Min_Brok_limit money
Declare @Max_Brok_limit money
Declare @Brokerage money
Declare @Tbl_no bigint

if(@SettFlag in (2,3))
begin
	Select @LeviesBrokerage = (Case when #ViewSettlement.status = 'N' then 0
																else (  case
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 1)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='V' and sell_buy = 2)
																				  Then  broktable.Normal
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 1)
																				   Then broktable.Normal --/100
																		when ( #ViewSettlement.SettFlag = 1 and broktable.val_perc ='P' and sell_buy = 2)
																				 Then broktable.Normal   --/100 
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='V' )
																				Then broktable.day_puc
																		when (#ViewSettlement.SettFlag = 2  and broktable.val_perc ='P' )
																				 Then broktable.day_puc  --/100
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='V' )
																				 Then broktable.day_sales 
																		when (#ViewSettlement.SettFlag = 3  and broktable.val_perc ='P' )
																				 Then broktable.day_sales  --/ 100
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='V' )
																				 Then  broktable.sett_purch
																		when ( #ViewSettlement.SettFlag = 4  and broktable.val_perc ='P' )
																				 Then broktable.sett_purch  --/100
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='V' )
																				 Then broktable.sett_sales
																		when ( #ViewSettlement.SettFlag = 5  and broktable.val_perc ='P' )
																				 Then broktable.sett_sales  --/100
																		Else  0
																		End )
									end ),
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc,
			@Tbl_no=BrokTable.Table_No

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2 Client2 ,#ViewSettlement ,Bsedb_ab.dbo.globals globals, 
   Bsedb_ab.dbo.client1 client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
   WHERE #ViewSettlement.Party_Code = Client2.Party_code
   and client1.cl_code=client2.cl_code
   And Client2.Party_Code = CT.Party_Code
   And Client2.Tran_Cat = CT.Trans_Cat
   And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
   And #ViewSettlement.Sauda_Date Between FromDate And ToDate
   And S.Table_No = Broktable.Table_no
   And S.Scheme_Type = Client2.Tran_Cat
   And S.Scrip_Cd = 'ALL'
   And S.PARTY_CODE = #ViewSettlement.Party_Code
   And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
   --And Broktable.Line_no = ( case when S.BrokScheme = 2 then
			--				    (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del =
			--				    ( Case When @@Eq = 'Y' then
			--					  ( Case When @@PRatemore = 'Y'
			--						 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    		             Then 'F'
			--				    		             Else 'S'
			--						        End )
			--						 Else
			--						      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		             Then 'F'
			--				    			     Else 'S'
			--						        End )
			--						 End )
			--					   Else
			--						( Case When @@PMore = 'Y'
			--						       then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			           Then 'F'

			--				    			           Else 'S'
			--							      End )
			--						       Else
			--						           ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    		                  Then
   --                                                                                           'F'
   --                                                                                       Else
   --                                                                                           'S'
			--						             End )
			--						  End )
			--					   End )
			--				    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--			else ( case when S.BrokScheme = 1 then
			--		       		   (Select min(Broktable.line_no) from broktable where
   --                                            		    S.Table_No = Broktable.Table_no
			--	                	    and Trd_Del = ( Case When @@PMore = 'Y'
			--							 then ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						     	 Else
			--							      ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			 	    Then 'F'
			--				    			 	    Else 'S'
			--							       End )
			--						    End )
   --                                             	    and #ViewSettlement.Party_Code =  Client2.Party_code
   --                                            		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--				else ( case when S.BrokScheme = 3 then
			--		       		   	   (Select min(Broktable.line_no) from broktable where
   --                                            		            S.Table_No = Broktable.Table_no
			--	                	            and Trd_Del = ( Case When @@SMore ='Y'
			--						        	 then ( Case When ( #ViewSettlement.Sell_Buy = 2 )
			--				    			           	     Then 'F'
			--				    			 	             Else 'S'
			--							         End )
			--						     	    Else ( Case When ( #ViewSettlement.Sell_Buy = 1 )
			--				    			 	        Then 'F'
			--				    			 	        Else 'S'
			--							           End )
			--						            End )
   --     	                                        	    and #ViewSettlement.Party_Code =  Client2.Party_code
	  --                                             		    and #ViewSettlement.marketrate <= Broktable.upper_lim)
			--					else
			--				    	   (Select min(Broktable.line_no) from broktable
			--				    	    where S.Table_No = Broktable.Table_no
			--				     	    And Trd_Del = 'T'
   --		                   				    and #ViewSettlement.Party_Code =  Client2.Party_code
			--	           			    and #ViewSettlement.marketrate <= Broktable.upper_lim )
			--					end )
			--				end )
			--			end )
  and #ViewSettlement.status <> 'E'
  And CT.Trans_cat = Client2.Tran_cat
  and #ViewSettlement.party_code = @@party_code
  --and #ViewSettlement.scrip_cd = @@scrip_cd
  and #ViewSettlement.tradeqty > 0
  --And #ViewSettlement.Sett_type = @Sett_type
  --And #ViewSettlement.Sett_no = @Sett_no
  And #ViewSettlement.PartipantCode = @@PartipantCode

  And Sauda_date > Globals.year_start_dt
  And Sauda_date < Globals.year_end_dt
   and BrokTable.Trd_Del = 'f'
   and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
   --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
   --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
   ----and BrokTable.Val_perc='P'

   
END
if(@SettFlag in (4,5))
BEGIN
	Select @LeviesBrokerage = case  when (  broktable.val_perc ='V' )
										Then broktable.Normal
									when (  broktable.val_perc ='P' )
										Then broktable.Normal --/100
									Else BrokApplied
								end,
			@Min_Brok_limit=Lower_lim,
			@Max_Brok_limit=Upper_lim,
			@Brokerage_Type=BrokTable.Val_perc

	FROM Bsedb_ab.dbo.BrokTable BrokTable,Bsedb_ab.dbo.Client2,Bsedb_ab.dbo.globals, #ViewSettlement,Bsedb_ab.dbo.Client1, Bsedb_ab.dbo.ClientBrok_Scheme S, Bsedb_ab.dbo.ClientTaxes_New CT, Bsedb_ab.dbo.Owner
      WHERE #ViewSettlement.Party_Code = Client2.Party_code
      And Client2.Cl_code = Client1.Cl_code
      And Client2.Party_Code = CT.Party_Code
      And CT.trans_Cat = 'DEL'
      And S.Trade_Type = 'NRM' --(Case When #ViewSettlement.PartipantCode = MemberCode Then 'NRM' Else 'INS' End)
      And #ViewSettlement.Sauda_Date Between FromDate And ToDate
      And S.Table_No = Broktable.Table_no
      And S.Scheme_Type = 'DEL'
      And S.Scrip_Cd = 'ALL'
      And S.PARTY_CODE = #ViewSettlement.Party_Code
      And #ViewSettlement.Sauda_Date Between S.From_Date And S.To_Date
      --And Broktable.Line_no = (Select min(Broktable.line_no) from broktable where
		    --           S.Table_No = Broktable.Table_no
			   --    And Trd_Del = 'D' And #ViewSettlement.Party_Code =  Client2.Party_code
			   --    And #ViewSettlement.marketrate <= Broktable.upper_lim )
      And (Globals.exchange = 'BSE')

      --AND #ViewSettlement.SETT_NO = @@SETT_NO
      --AND #ViewSettlement.SETT_TYPE = @Sett_type
      --and #ViewSettlement.billflag in(4,5)
      and #ViewSettlement.status <> 'E'
      --and #ViewSettlement.party_code = @party_code
      --and #ViewSettlement.scrip_cd = @Scrip_cd
      And Sauda_date > Globals.year_start_dt
      And Sauda_date < Globals.year_end_dt
	  and BrokTable.Trd_Del = 'D'
	  and @Marketrate >= BrokTable.Lower_lim 
	  and @Marketrate <= BrokTable.Upper_lim
	  --and (Brokapplied*@TradeQty) >= BrokTable.Lower_lim 
	  --and (Brokapplied*@TradeQty) <= BrokTable.Upper_lim  
END

--Select @Brokerage=NBrokApp*@TradeQty from #ViewSettlement

--if(@Brokerage<@Min_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'AA'
--END
--else if(@Brokerage>@Max_Brok_limit)
--BEGIN
--	set @Brokerage_Type='V'
--	--Print 'BB'

--END
--else
--BEGIN
--	set @Brokerage_Type='P'
--END

Print '@Min_Brok_limit'
Print @Min_Brok_limit
Print '@Max_Brok_limit'
Print @Max_Brok_limit
Print '@Tbl_no'
print @Tbl_no


Update #ViewSettlement set Service_tax=Service_tax+(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100), 
							NSerTax=NSerTax +(turn_tax*@Service_Tax_From_Globals/100)+(sebi_tax*@Service_Tax_From_Globals/100)
							, N_NetRate= (case when @Settflag=3 then N_NetRate-(NBrokApp*2) else N_NetRate end)
							,Ins_chrg=Round(Ins_chrg,0)								-- Suggested by Dharmesh on Aug 06 2015 and approved by BG sir
							,other_chrg=isnull(@LeviesBrokerage,0.00)


declare @Trans_Cat varchar(100)
select @Trans_Cat= case when @Settflag in ('2','3') then 'TRD' else  'DEL' end
print @Trans_Cat

--Select *,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals, 
--Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note,Levies_Brokerage=@LeviesBrokerage ,Brokerage_Type=isnull(@Brokerage_Type ,'P')
--from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
--where #ViewSettlement.Party_Code= CT.Party_Code
--and CT.Todate>getdate()
--and Trans_Cat=@Trans_Cat


Select #ViewSettlement.*,LeviesSTT=@STT_From_Global,LeviesServ_Tax=@Service_Tax_From_Globals,
Levies_TurnoverTax=turnover_tax, Levies_SebiTax=sebiturn_tax, Levies_StampDuty=broker_note, Levies_Brokerage=@LeviesBrokerage, Brokerage_Type=isnull(@Brokerage_Type,'P') 
into #BrokCal
from #ViewSettlement , Bsedb_ab.dbo.ClientTaxes_New CT with(nolock) 
where #ViewSettlement.Party_Code= CT.Party_Code
and CT.Todate>getdate()
and Trans_Cat=@Trans_Cat

Select RecordDate = Convert(varchar,getdate()), Exchange = 'BSE', Party_code,
TradeQty_amt = [Tradeqty], MarketRate_amt = convert(decimal(10,2),MarketRate), 
Brokerage_Brak = convert(decimal(10,4),NBrokApp), LeviesBrokerage_perc = convert(decimal(10,4),other_chrg),
--LeviesBrokerage_Amt = convert(decimal(10,2),(Brokapplied * [Tradeqty])),
LeviesBrokerage_Amt = convert(decimal(10,2),((case when Brokapplied <> 0 then Brokapplied else NBrokApp end ) * [Tradeqty])),
--NetRate = convert(decimal(10,4),NetRate), 
NetRate = convert(decimal(10,4),(case when NetRate <> 0 then NetRate else (MarketRate + NBrokApp) end )), 
TurnoverTax_Levies = convert(decimal(10,5),Levies_TurnoverTax),
TurnoverTax_Amt = convert(decimal(10,2),turn_tax),
STT_Levies = convert(decimal(10,2),LeviesSTT), 
STT_Amt = convert(decimal(10,2),Ins_chrg), 
StampDuty_Levies = convert(decimal(10,4),Levies_StampDuty), 
StampDuty_Amt = convert(decimal(10,2),Broker_chrg), 
SebiTax_Levies = convert(decimal(10,4),Levies_SebiTax),
SebiTax_Amt = convert(decimal(10,2),sebi_tax),
GST_Levies = convert(decimal(10,2),LeviesServ_Tax),
GST_Amt = convert(decimal(10,2),NSerTax),
TradeAmtWithBrok = convert(decimal(10,2),(N_NetRate * Tradeqty)),
--TotalLevies = convert(decimal(10,2),(Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
TotalLevies = convert(decimal(10,2),(other_chrg + Ins_chrg + turn_tax + sebi_tax + Broker_chrg + NSerTax)),
Brokerage_Type = isnull(@Brokerage_Type,'P') 
from #BrokCal

--other_chrg+NSerTax+Ins_chrg+turn_tax+sebi_tax+Broker_chrg


/*

if @@error = 0
begin
	insert into inst_log values
	(
		ltrim(rtrim(@Party_Code)),	/*party_code*/
		ltrim(rtrim(@Party_Code)),	/*new_party_code*/
		convert(datetime, ltrim(rtrim(@Sauda_date))),	 /*sauda_date*/
		ltrim(rtrim(@Sett_no)),	 /*sett_no*/
		ltrim(rtrim(@Sett_type)),	 /*sett_type*/
		ltrim(rtrim(@Scrip_Cd)),	/*scrip_cd*/
		ltrim(rtrim(@series)),	/*series*/
		ltrim(rtrim('')),	 /*order_no*/
		ltrim(rtrim('')),	 /*trade_no*/
		ltrim(rtrim('')),	/*sell_buy*/
		ltrim(rtrim('')),	/*contract_no*/
		ltrim(rtrim('')),	/*new_contract_no*/
		0,		/*brokerage*/
		0,		/*new_brokerage*/
		0,		/*market_rate*/
		0,		/*new_market_rate*/
		0,		/*net_rate*/
		0,		/*new_net_rate*/
		0,		/*qty*/
		0,		/*new_qty*/
		ltrim(rtrim('')),	 /*participant_code*/
		ltrim(rtrim('')),	 /*new_participant_code*/
		ltrim(rtrim(@StatusName)),	 /*username*/
		ltrim((@FromWhere)),	 /*module*/
		'BBGSettBrokReCal',	/*called_from*/
		getdate(),	/*timestamp*/
		ltrim(rtrim('')),	/*extrafield3*/
		ltrim(rtrim('')),	/*extrafield4*/
		ltrim(rtrim(''))	 /*extrafield5*/
	)
end

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bond_POdet
-- --------------------------------------------------
CREATE Procedure [dbo].[Bond_POdet](@pcode as varchar(10) = null)            
as            
            
Set nocount on                            
  
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
      
  Truncate table Bond_PO            
      
  insert into Bond_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
  select Getdate(),CLTCODE,            
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate  and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            
  group by cltcode            
      
  exec Fetch_CliUnreco_bond            
      
  update Bond_PO set UNRecoCr=-b.UnRecoCr from             
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
  where Bond_PO.cltcode=b.cltcode            
      
  update Bond_PO set OTherDr=b.Vbal from            
  (select substring(Cltcode,3,10) as Cltcode,VBAl from Bond_PO where cltcode like '98%' and VBAL < 0) b            
  where Bond_PO.cltcode=b.cltcode            
      
      
  truncate table Bond_PO_BSEIPO          
  insert into Bond_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
  from Bond_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
           
END            
ELSE            
BEGIN            
            
 delete from Bond_PO where Cltcode=@pcode            
            
 insert into Bond_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            
 0,0            
 from account_ab.dbo.ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode  and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') 
          
 group by cltcode            
            
 exec Fetch_CliUnreco_bond @pcode            
             
 update Bond_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where Bond_PO.cltcode=b.cltcode and Bond_PO.Cltcode=@pcode            
            
 update Bond_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from Bond_PO where cltcode like '98%' and VBAL < 0) b            
 where Bond_PO.cltcode=b.cltcode and Bond_PO.Cltcode=@pcode            
          
 delete from Bond_PO_BSEIPO where Cltcode=@pcode            
 insert into Bond_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from Bond_PO           
 where substring(Cltcode,2,10)=@pcode          
             
END                               
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bond_POdet_02082017
-- --------------------------------------------------
CREATE Procedure Bond_POdet_02082017(@pcode as varchar(10) = null)              
as              
              
Set nocount on                              
    
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'               
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()              
              
IF @Pcode is null              
BEGIN              
        
  Truncate table Bond_PO              
        
  insert into Bond_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)              
  select Getdate(),CLTCODE,              
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),               
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),              
  0,0              
  from account_ab.dbo.ledger a with (nolock)               
  where VDT>=@sdtcur and VDT <= @ToDate              
  group by cltcode              
        
  exec Fetch_CliUnreco_bond              
        
  update Bond_PO set UNRecoCr=-b.UnRecoCr from               
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b              
  where Bond_PO.cltcode=b.cltcode              
        
  update Bond_PO set OTherDr=b.Vbal from              
  (select substring(Cltcode,3,10) as Cltcode,VBAl from Bond_PO where cltcode like '98%' and VBAL < 0) b              
  where Bond_PO.cltcode=b.cltcode              
        
        
  truncate table Bond_PO_BSEIPO            
  insert into Bond_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr             
  from Bond_PO             
 where cltcode like '6%' and ISNUMERIC(cltcode)=0            
             
END              
ELSE              
BEGIN              
              
 delete from Bond_PO where Cltcode=@pcode              
              
 insert into Bond_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)              
 select Getdate(),CLTCODE,              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),               
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),              
 0,0              
 from account_ab.dbo.ledger a with (nolock)               
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode              
 group by cltcode              
              
 exec Fetch_CliUnreco_bond @pcode              
               
 update Bond_PO set UNRecoCr=-b.UnRecoCr from               
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b              
 where Bond_PO.cltcode=b.cltcode and Bond_PO.Cltcode=@pcode              
              
 update Bond_PO set OTherDr=b.Vbal from              
 (select substring(Cltcode,3,10) as Cltcode,VBAl from Bond_PO where cltcode like '98%' and VBAL < 0) b              
 where Bond_PO.cltcode=b.cltcode and Bond_PO.Cltcode=@pcode              
            
 delete from Bond_PO_BSEIPO where Cltcode=@pcode              
 insert into Bond_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr             
 from Bond_PO             
 where substring(Cltcode,2,10)=@pcode            
               
END                                 
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DPC_GetTB
-- --------------------------------------------------
CREATE Procedure DPC_GetTB(@acdate as varchar(11),@tbdate as varchar(11),@segment as  varchar(10))  
as  
Truncate table DPC_TB_TEMP
insert into DPC_TB_TEMP select @segment,cltcode,drcr,vamt from dbo.DPC_TB(@acdate,@tbdate)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DPC_GetTB_NB
-- --------------------------------------------------
CREATE Procedure [dbo].[DPC_GetTB_NB](@acdate as varchar(11),@tbdate as varchar(11),@segment as  varchar(10))    
as    
Truncate table DPC_TB_NB_TEMP  
--insert into DPC_TB_NB_TEMP select @segment,cltcode,drcr,vamt from dbo.DPC_TB_NB(@acdate,@tbdate)    
insert into DPC_TB_NB_TEMP
Exec DPC_TB_NB_Opt @acdate,@tbdate,@segment

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DPC_TB_NB_Opt
-- --------------------------------------------------
Create Procedure  [dbo].[DPC_TB_NB_Opt](@aCdate varchar(11),@TBDATE varchar(11),@segment varchar(10))                 
 
AS             
BEGIN  

 Create Table #TB
 (            
cltcode varchar(10),            
DrCr char(1),            
vamt money            
)            
         
		 
		 Create Index #t on #TB (Cltcode) 
       Create Index #t1 on #TB (Vamt) 
            
 if @aCdate=@TBDATE      
 BEGIN      
 insert into #TB         
 select cltcode,'D',sum(-vamt)       
 from ACCOUNT_AB.dbo.LEDGER with (nolock) where vdt < @aCdate and edt >=@aCdate and drcr='D'      
 group by  cltcode      
 END      
 ELSE      
 BEGIN      
 insert into #TB          
 select cltcode,'D',sum(case when drcr='D' then vamt else -vamt end) from ACCOUNT_AB.dbo.LEDGER with (nolock)             
 where vdt>= @aCdate and      
 /* (Case when vtyp=15 and drcr='D' then edt else vdt end) < @TBDATE  */          
 edt < @TBDATE
 group by cltcode            
 END      
       
 update #TB set Drcr='C' where vamt < 0            
            
      
	  
 Select @segment,* from #TB With(nolock) where isnumeric(left(cltcode,1))=0  
	      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco
-- --------------------------------------------------

CREATE Procedure [dbo].[Fetch_CliUnreco] (@pcode as varchar(10) = null)       
as        
        
set nocount on        
        
/*        
declare @fromdt as datetime,@todate as datetime        
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()        
*/        
        
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/        
declare @fromdt as datetime,@todate as datetime          
select @fromdt=sdtcur from account_ab.dbo.parameter with (nolock)   where sdtnxt = (select sdtcur  from account_ab.dbo.parameter  with (nolock)   where sdtcur <= getdate() and ldtcur >=getdate())          
select @todate=ldtcur from account_ab.dbo.parameter  with (nolock)  where sdtcur <= getdate() and ldtcur >=getdate()          
------END----------------        
         
IF @pcode is null  
BEGIN  
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet        
 from account_ab.dbo.ledger b with (nolock)         
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1        
         
 select         
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo        
 into #led1        
 from account_ab.dbo.ledger1 with (nolock)        
 where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )         
         
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype         
         
         
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,         
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),         
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),         
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()         
 into #recodet         
 From account_ab.dbo.LEDGER l with (nolock)        
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno        
 and vdt <= getdate() AND        
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%') 
/* and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')             */
 /*                                    
 select top 0 * into BO_client_deposit_recno from [CSOKYC-6].general.dbo.BO_client_deposit_recno         
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)         
 */        
         
         
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on         
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')         
         
 truncate table BO_client_deposit_recno         
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodet (nolock)         
END  
ELSE  
BEGIN  
  
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet        
 from account_ab.dbo.LEDGER b with (nolock)         
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode  
  
 select         
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,  
 accno=space(10)        
 into #ledger1c        
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype       
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )         
  
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc        
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp  
 where  a.lno=1  /*and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')  */
  
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype  
  
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,         
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),         
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),         
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()         
 into #recodetc         
 From account_ab.dbo.LEDGER l with (nolock)        
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno        
 and vdt <= getdate()         
 and       
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%') 
 /*and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')       */
       
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on         
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')         
         
 delete from BO_client_deposit_recno where cltcode=@pcode        
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodetc (nolock)         
  
  
END        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_02042014
-- --------------------------------------------------
CREATE Procedure Fetch_CliUnreco_02042014  
as  
  
set nocount on  
  
declare @fromdt as datetime,@todate as datetime  
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()  
  
select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet  
from account_ab.dbo.ledger b with (nolock)   
where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1  
  
select   
bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo  
into #led1  
from account_ab.dbo.ledger1 with (nolock)  
where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )   
  
select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype   
  
  
select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,   
isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),   
Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),   
treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()   
into #recodet   
From account_ab.dbo.LEDGER l with (nolock)  
join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno  
and vdt <= getdate()   
and l.narration not like 'BEING AMT RECD TECH PROCESS%'  
    
/*                              
select top 0 * into BO_client_deposit_recno from [196.1.115.182].general.dbo.BO_client_deposit_recno   
create clustered index co_pcode on BO_client_deposit_recno(cltcode)   
*/  
  
  
delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on   
a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')   
  
truncate table BO_client_deposit_recno   
insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodet (nolock)   
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_06May2022
-- --------------------------------------------------
create Procedure [dbo].[Fetch_CliUnreco_06May2022] (@pcode as varchar(10) = null)       
as        
        
set nocount on        
        
/*        
declare @fromdt as datetime,@todate as datetime        
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()        
*/        
        
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/        
declare @fromdt as datetime,@todate as datetime          
select @fromdt=sdtcur from account_ab.dbo.parameter with (nolock)   where sdtnxt = (select sdtcur  from account_ab.dbo.parameter  with (nolock)   where sdtcur <= getdate() and ldtcur >=getdate())          
select @todate=ldtcur from account_ab.dbo.parameter  with (nolock)  where sdtcur <= getdate() and ldtcur >=getdate()          
------END----------------        
         
IF @pcode is null  
BEGIN  
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet        
 from account_ab.dbo.ledger b with (nolock)         
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1        
         
 select         
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo        
 into #led1        
 from account_ab.dbo.ledger1 with (nolock)        
 where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )         
         
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype         
         
         
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,         
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),         
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),         
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()         
 into #recodet         
 From account_ab.dbo.LEDGER l with (nolock)        
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno        
 and vdt <= getdate() AND        
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%') 
/* and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')             */
 /*                                    
 select top 0 * into BO_client_deposit_recno from [196.1.115.182].general.dbo.BO_client_deposit_recno         
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)         
 */        
         
         
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on         
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')         
         
 truncate table BO_client_deposit_recno         
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodet (nolock)         
END  
ELSE  
BEGIN  
  
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet        
 from account_ab.dbo.LEDGER b with (nolock)         
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode  
  
 select         
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,  
 accno=space(10)        
 into #ledger1c        
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype       
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )         
  
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc        
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp  
 where  a.lno=1  /*and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')  */
  
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype  
  
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,         
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),         
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),         
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()         
 into #recodetc         
 From account_ab.dbo.LEDGER l with (nolock)        
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno        
 and vdt <= getdate()         
 and       
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%') 
 /*and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')       */
       
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on         
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')         
         
 delete from BO_client_deposit_recno where cltcode=@pcode        
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodetc (nolock)         
  
  
END        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_bond
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Fetch_CliUnreco_bond] (@pcode as varchar(10) = null)             
as              
              
set nocount on              
              
/*              
declare @fromdt as datetime,@todate as datetime              
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()              
*/              
              
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/              
declare @fromdt as datetime,@todate as datetime                
select @fromdt=sdtcur from account_ab.dbo.parameter where sdtnxt = (select sdtcur  from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate())                
select @todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()                
------END----------------              
               
IF @pcode is null        
BEGIN        
              
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet              
 from account_ab.dbo.ledger b with (nolock)               
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1              
               
 select               
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo              
 into #led1              
 from account_ab.dbo.ledger1 with (nolock)              
 where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )               
               
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype               
               
               
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,               
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),               
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),               
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()               
 into #recodet               
 From account_ab.dbo.LEDGER l with (nolock)              
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno              
 and vdt <= getdate() AND              
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')  
 and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')   
              
 /*                                          
 select top 0 * into BO_client_deposit_recno_Bond from [CSOKYC-6].general.dbo.BO_client_deposit_recno               
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)               
 */              
               
               
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on               
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')               
               
 truncate table BO_client_deposit_recno_Bond               
 insert into BO_client_deposit_recno_Bond select co_code='BSECM',getdate(),* from #recodet (nolock)               
END        
ELSE        
BEGIN        
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet              
 from account_ab.dbo.LEDGER b with (nolock)               
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode        
        
 select               
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,        
 accno=space(10)              
 into #ledger1c              
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype             
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )               
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc              
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp        
 where  a.lno=1  and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')   
       
        
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype        
        
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,               
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),               
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),               
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()               
 into #recodetc               
 From account_ab.dbo.LEDGER l with (nolock)              
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno              
 and vdt <= getdate()               
 and             
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')    
 and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')   
          
             
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on               
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')               
               
 delete from BO_client_deposit_recno_Bond where cltcode=@pcode              
 insert into BO_client_deposit_recno_Bond select co_code='BSECM',getdate(),* from #recodetc (nolock)               
        
        
END              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_bond_02082017
-- --------------------------------------------------
Create Procedure [dbo].[Fetch_CliUnreco_bond_02082017] (@pcode as varchar(10) = null)           
as            
            
set nocount on            
            
/*            
declare @fromdt as datetime,@todate as datetime            
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()            
*/            
            
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/            
declare @fromdt as datetime,@todate as datetime              
select @fromdt=sdtcur from account_ab.dbo.parameter where sdtnxt = (select sdtcur  from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate())              
select @todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()              
------END----------------            
             
IF @pcode is null      
BEGIN      
            
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet            
 from account_ab.dbo.ledger b with (nolock)             
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1            
             
 select             
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo            
 into #led1            
 from account_ab.dbo.ledger1 with (nolock)            
 where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )             
             
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype             
             
             
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,             
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),             
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),             
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()             
 into #recodet             
 From account_ab.dbo.LEDGER l with (nolock)            
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno            
 and vdt <= getdate() AND            
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')              
 /*                                        
 select top 0 * into BO_client_deposit_recno_Bond from [196.1.115.182].general.dbo.BO_client_deposit_recno             
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)             
 */            
             
             
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on             
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')             
             
 truncate table BO_client_deposit_recno_Bond             
 insert into BO_client_deposit_recno_Bond select co_code='BSECM',getdate(),* from #recodet (nolock)             
END      
ELSE      
BEGIN      
      
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet            
 from account_ab.dbo.LEDGER b with (nolock)             
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode      
      
 select             
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,      
 accno=space(10)            
 into #ledger1c            
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype           
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )             
      
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc            
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp      
 where  a.lno=1       
      
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype      
      
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,             
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),             
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),             
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()             
 into #recodetc             
 From account_ab.dbo.LEDGER l with (nolock)            
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno            
 and vdt <= getdate()             
 and           
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')          
           
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on             
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')             
             
 delete from BO_client_deposit_recno_Bond where cltcode=@pcode            
 insert into BO_client_deposit_recno_Bond select co_code='BSECM',getdate(),* from #recodetc (nolock)             
      
      
END            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_ForPO
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Fetch_CliUnreco_ForPO] (@pcode as varchar(10) = null)         
as          
          
set nocount on          
          
/*          
declare @fromdt as datetime,@todate as datetime          
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()          
*/          
          
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/          
declare @fromdt as datetime,@todate as datetime            
select @fromdt=sdtcur from account_ab.dbo.parameter with (nolock)   where sdtnxt = (select sdtcur  from account_ab.dbo.parameter  with (nolock)   where sdtcur <= getdate() and ldtcur >=getdate())            
select @todate=ldtcur from account_ab.dbo.parameter  with (nolock)  where sdtcur <= getdate() and ldtcur >=getdate()            
------END----------------          
           
IF @pcode is null    
BEGIN    
    select distinct party_code into #PO_client_unreco from  [INTRANET].cms.dbo.NCMS_PO_Request_ForPayout with(nolock)   
  
  create index #PO_cli on #PO_client_unreco(Party_code)  
          
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet          
 from account_ab.dbo.ledger b with (nolock)   ,#PO_client_unreco p              
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3)    and b.CLTCODE=p.party_code     
      
   create index #vdet_v on #vdet(vtyp,vno,booktype)  
  
 select           
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,t.vtyp,t.vno,t.lno,drcr,t.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo        
 into #led1          
 from account_ab.dbo.ledger1 t with (nolock)  , #vdet l where l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype       
 and drcr='C' and clear_mode not in ( 'R', 'C') and t.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )             
           
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype           
           
           
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,           
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),           
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),           
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()           
 into #recodet           
 From account_ab.dbo.LEDGER l with (nolock)          
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno          
 and vdt <= getdate() AND          
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%')   
/* and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')             */  
 /*                                      
 select top 0 * into BO_client_deposit_recno from [CSOKYC-6].general.dbo.BO_client_deposit_recno           
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)           
 */          
           
           
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on           
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')           
           
 truncate table BO_client_deposit_recno           
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodet (nolock)           
END    
ELSE    
BEGIN    
    
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet          
 from account_ab.dbo.LEDGER b with (nolock)           
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode    
    
 select           
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,    
 accno=space(10)          
 into #ledger1c          
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype         
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )           
    
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc          
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp    
 where  a.lno=1  /*and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')  */  
    
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype    
    
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,           
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),           
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),           
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()           
 into #recodetc           
 From account_ab.dbo.LEDGER l with (nolock)          
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno          
 and vdt <= getdate()           
 and         
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%' AND l.narration not like 'AMOUNT RECEIVED%')   
 /*and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')       */  
         
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on           
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')           
           
 delete from BO_client_deposit_recno where cltcode=@pcode          
 insert into BO_client_deposit_recno select co_code='BSECM',getdate(),* from #recodetc (nolock)           
    
    
END          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Fetch_CliUnreco_GSec
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Fetch_CliUnreco_GSec] (@pcode as varchar(10) = null)             
as              
              
set nocount on              
              
/*              
declare @fromdt as datetime,@todate as datetime              
select @fromdt=sdtcur,@todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()              
*/              
              
/*------NEW LINE ADD FOR FINANCIAL YEAR CALENDER-----*/              
declare @fromdt as datetime,@todate as datetime                
select @fromdt=sdtcur from account_ab.dbo.parameter where sdtnxt = (select sdtcur  from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate())                
select @todate=ldtcur from account_ab.dbo.parameter where sdtcur <= getdate() and ldtcur >=getdate()                
------END----------------              
               
IF @pcode is null        
BEGIN        
              
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #vdet              
 from account_ab.dbo.ledger b with (nolock)               
 where vdt >=@fromdt and vdt <=@todate and (vtyp=2 or vtyp=3) and lno=1              
               
 select               
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,vtyp,vno,lno,drcr,BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo              
 into #led1              
 from account_ab.dbo.ledger1 with (nolock)              
 where drcr='C' and clear_mode not in ( 'R', 'C') and vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )               
               
 select t.*,l.accno into #ledger1 from #vdet l join #led1 t on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype               
               
               
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,               
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),               
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),               
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()               
 into #recodet               
 From account_ab.dbo.LEDGER l with (nolock)              
 join #ledger1 L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno              
 and vdt <= getdate() AND              
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')  
 and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')   
              
 /*                                          
 select top 0 * into BO_client_deposit_recno_Bond from [CSOKYC-6].general.dbo.BO_client_deposit_recno               
 create clustered index co_pcode on BO_client_deposit_recno(cltcode)               
 */              
               
 delete #recodet from #recodet a inner join BSEDB_AB.DBO.CLient1 b WITH (NOLOCK) on               
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')               
               
 truncate table BO_client_deposit_recno_GSec               
 insert into BO_client_deposit_recno_GSec select co_code='BSECM',getdate(),* from #recodet (nolock)               
END        
ELSE        
BEGIN        
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=b.cltcode into #cdet              
 from account_ab.dbo.LEDGER b with (nolock)               
 where  vdt >=GETDATE()-31 and vdt <=@todate and (vtyp=2 or vtyp=3) and CLTCODE=@pcode        
        
 select               
 bnkname,brnname,dd,ddno,dddt,reldt,relamt,refno,receiptno,a.vtyp,a.vno,a.lno,drcr,a.BookType,MicrNo,SlipNo,slipdate,ChequeInName,Chqprinted,clear_mode,L1_SNo,        
 accno=space(10)              
 into #ledger1c              
 from account_ab.dbo.ledger1 a with (nolock) join #cdet b on a.vno=b.vno and a.vtyp=b.vtyp and a.booktype=b.booktype             
 where drcr='C' and clear_mode not in ( 'R', 'C') and a.vtyp in (2, 3) and (reldt ='1900-01-01 00:00:00.000' or reldt > getdate()+1 )               
        
 select b.vtyp, b.booktype, b.vno, b.lno,accno=a.cltcode into #vdetc              
 from account_ab.dbo.LEDGER a with (nolock) join #cdet b on a.VNO=b.vno and a.booktype=b.booktype and a.vtyp=b.vtyp        
 where  a.lno=1  and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')   
       
        
 update #ledger1c set accno=b.accno from #vdetc b where #ledger1c.vno=b.vno and #ledger1c.vtyp=b.vtyp and #ledger1c.booktype=b.booktype        
        
 select l1.accno,l.vtyp, l.booktype, l.vno, vdt, tdate=convert(varchar,l.vdt,103), isnull(ddno,'') ddno, isnull(cltcode ,'') cltcode ,               
 isnull( acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then vamt  else 0 end ),               
 Cramt= (case when upper(l.drcr) = 'C' then vamt else 0 end ),               
 treldt=isnull(convert(varchar, reldt , 103),''), l1.refno,last_Date=getdate()               
 into #recodetc               
 From account_ab.dbo.LEDGER l with (nolock)              
 join #ledger1c L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno              
 and vdt <= getdate()               
 and             
 (l.narration not like 'BEING AMT RECD TECH PROCESS%'  AND l.narration not like 'BEING AMT RECEIVED BY ONLINE TRF%')    
 and (l.VTYP<>35 and isnull(l.enteredby,'')<>'mtf process')   
          
             
 delete #recodetc from #recodetc a inner join MSAJAG.DBO.CLient1 b WITH (NOLOCK) on               
 a.cltcode=b.CL_cODE where a.ddno='0' and (B.cl_type = 'NBF' OR B.cl_type = 'TMF')               
               
 delete from BO_client_deposit_recno_GSec where cltcode=@pcode              
 insert into BO_client_deposit_recno_GSec select co_code='BSECM',getdate(),* from #recodetc (nolock)               
        
        
END              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GSec_POdet
-- --------------------------------------------------
CREATE Procedure [dbo].[GSec_POdet](@pcode as varchar(10) = null)            
as            
     
Set nocount on                            
  
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
      
  Truncate table GSec_PO            
      
  insert into GSec_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
  select Getdate(),CLTCODE,            
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate  and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            
  group by cltcode            
      
  exec Fetch_CliUnreco_GSec            
      
  update GSec_PO set UNRecoCr=-b.UnRecoCr from             
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
  where GSec_PO.cltcode=b.cltcode            
      
  update GSec_PO set OTherDr=b.Vbal from            
  (select substring(Cltcode,3,10) as Cltcode,VBAl from GSec_PO where cltcode like '98%' and VBAL < 0) b            
  where GSec_PO.cltcode=b.cltcode            
      
      
  truncate table GSec_PO_BSEIPO          
  insert into GSec_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
  from GSec_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
  
END            
ELSE            
BEGIN            
            
 delete from GSec_PO where Cltcode=@pcode            
            
 insert into GSec_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            
 0,0            
 from account_ab.dbo.ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode  and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') 
          
 group by cltcode            
            
 exec Fetch_CliUnreco_GSec @pcode            
             
 update GSec_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where GSec_PO.cltcode=b.cltcode and GSec_PO.Cltcode=@pcode            
            
 update GSec_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from GSec_PO where cltcode like '98%' and VBAL < 0) b            
 where GSec_PO.cltcode=b.cltcode and GSec_PO.Cltcode=@pcode            
          
 delete from GSec_PO_BSEIPO where Cltcode=@pcode            
 insert into GSec_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from GSec_PO           
 where substring(Cltcode,2,10)=@pcode          
             
END                               
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.midware_ledger_inhouse
-- --------------------------------------------------
CREATE procedure MIDWARE_ledger_inhouse      
as              
              
set nocount on              
----- Account Master              
truncate table INHOUSE.dbo.ledger      


/* Fetch Party Ledger */
insert into INHOUSE.dbo.ledger            
select * from account_ab.dbo.ledger with (nolock) 
where vdt >= convert(datetime,convert(varchar(11),getdate()-15)+' 00:00:00')
and cltcode >='A0001' and cltcode <='ZZ9999'   

declare @finDt as datetime,@sDt as datetime
set @finDt = 'Oct 31 '+case when datepart(mm,getdate()) > 3 then convert(varchar(4),datepart(yy,getdate()))
else convert(varchar(4),datepart(yy,getdate())-1) end

if getdate() > @finDt
Begin
	select @sdt=sdtcur from parameter with (nolock)  where sdtcur <= getdate() and ldtcur >= getdate()
end
else
Begin
	select @sdt=sdtcur from parameter with (nolock) where ldtprv = (select  ldtprv from parameter with (nolock)  where sdtcur <= getdate() and ldtcur >= getdate())
end


/* Fetch General Ledger */
insert into INHOUSE.dbo.ledger            
select * from account_ab.dbo.ledger with (nolock) 
where vdt >= @sdt and cltcode >='0' and cltcode <='99999999'   

              
truncate table INHOUSE.dbo.ledger1      
insert into INHOUSE.dbo.ledger1            
select * from account_ab.dbo.ledger1 with (nolock)    
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Midware_master_inhouse
-- --------------------------------------------------
CREATE procedure Midware_master_inhouse      
as      
      
set nocount on      
----- Account Master      
truncate table INHOUSE.dbo.acmast      
insert into INHOUSE.dbo.acmast       
select * from ACCOUNT_AB.DBO.acmast with (nolock) --  00:18 secs      
      
truncate table INHOUSE.dbo.vmast      
insert into INHOUSE.dbo.vmast      
select * from ACCOUNT_AB.DBO.vmast with (nolock) --  00:01 secs      
      
truncate table INHOUSE.dbo.parameter       
insert into INHOUSE.dbo.parameter       
select * from ACCOUNT_AB.DBO.parameter with (nolock) --  00:01 secs      
    
truncate table INHOUSE.dbo.costmast    
insert into INHOUSE.dbo.costmast       
select * from ACCOUNT_AB.DBO.costmast with (nolock) --  00:01 secs      
      
--- Settlement      
truncate table INHOUSE.DBO.sett_mst      
insert into INHOUSE.DBO.sett_mst      
select * from BSEDB_AB.DBO.sett_mst with (nolock)      
      
      
--- Scrip Master      
truncate table INHOUSE.DBO.scrip1      
insert into INHOUSE.DBO.scrip1      
select * from BSEDB_AB.DBO.scrip1 with (nolock)      
      
truncate table INHOUSE.DBO.scrip2      
insert into INHOUSE.DBO.scrip2      
select * from BSEDB_AB.DBO.scrip2 with (nolock)      
      
      
--- Client Master       
/*
truncate table INHOUSE.DBO.client1      
insert into INHOUSE.DBO.client1      
select * from BSEDB_AB.DBO.client1 with (nolock)      
      
truncate table INHOUSE.DBO.client2      
insert into INHOUSE.DBO.client2      
select * from BSEDB_AB.dbo.client2 with (nolock)      
      
truncate table INHOUSE.DBO.client3      
insert into INHOUSE.DBO.client3      
select * from BSEDB_AB.dbo.client3 with (nolock)      
      
truncate table INHOUSE.DBO.client4      
insert into INHOUSE.DBO.client4      
select * from BSEDB_AB.dbo.client4 with (nolock)      
      
truncate table INHOUSE.DBO.client5      
insert into INHOUSE.DBO.client5      
select * from BSEDB_AB.dbo.client5 with (nolock)      
      
truncate table INHOUSE.DBO.client6      
insert into INHOUSE.DBO.client6      
select * from BSEDB_AB.dbo.client6 with (nolock)      
*/      
      
--- Sub-broker      
truncate table INHOUSE.DBO.subbrokers       
insert into INHOUSE.DBO.subbrokers       
select * from BSEDB_AB.dbo.subbrokers with (nolock)      
      
--- Branch      
truncate table INHOUSE.DBO.branches      
insert into INHOUSE.DBO.branches      
select * from BSEDB_AB.dbo.branches with (nolock)      
      
--- Region      
truncate table INHOUSE.DBO.region      
insert into INHOUSE.DBO.region      
select * from BSEDB_AB.dbo.region with (nolock)      
      
--- Brokerage      
truncate table INHOUSE.DBO.Broktable      
insert into INHOUSE.DBO.Broktable      
select * from BSEDB_AB.dbo.Broktable with (nolock)      
    
----Global    
truncate table INHOUSE.DBO.globals    
insert into INHOUSE.DBO.globals       
select * from BSEDB_AB.dbo.globals with (nolock)       
    
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.midware_TrxDetails_Inhouse
-- --------------------------------------------------
CREATE procedure midware_TrxDetails_Inhouse    
as    
set nocount on              
    
declare @sdate as varchar(11)    
select top 1 @sdate=convert(varchar(13),sauda_DAte) from bsedb_Ab.dbo.settlement with (nolock)  
--print @sdate    
    
truncate table inhouse.dbo.settlement   
insert into inhouse.dbo.settlement   
select * from bsedb_Ab.dbo.settlement with (nolock) where sauda_date >= @sdate+' 00:00:00' and  sauda_date <= @sdate+' 23:59:59'     
    
truncate table inhouse.dbo.isettlement   
insert into inhouse.dbo.isettlement   
select * from bsedb_Ab.dbo.isettlement with (nolock) where sauda_date >= @sdate+' 00:00:00' and  sauda_date <= @sdate+' 23:59:59'     

truncate table inhouse.dbo.CMBILLVALAN  
insert into inhouse.dbo.CMBILLVALAN    
select * from bsedb_Ab.dbo.CMBILLVALAN with (nolock) where sauda_date >= @sdate+' 00:00:00' and  sauda_date <= @sdate+' 23:59:59'     
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_clear_data
-- --------------------------------------------------
create proc

	[dbo].[mimansa_usp_ucc_bsecm_clear_data]

as

	truncate table mimansa_angel_tbl_ucc_bsecm_trade 

	truncate table mimansa_angel_ucc_bsecm_client_data

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_client_data_check
-- --------------------------------------------------
create  proc

	[dbo].[mimansa_usp_ucc_bsecm_client_data_check]

as

	declare @strPAN_Invalid_Reasons varchar(2000)

	select distinct
		client_code = ltrim(rtrim(client_code)),
		client_long_name = ltrim(rtrim(client_long_name)),
		pan_no = ltrim(rtrim(pan_no)),
		pan_orig,
		pan_err = 
			case 
				when ltrim(rtrim(isnull(pan_orig, 'NA'))) = 'NA'
				then 'NO PAN'
				when len(ltrim(rtrim(isnull(pan_orig, '')))) = 0
				then 'NO PAN'
				when not (
					isnumeric(left(ltrim(rtrim(isnull(pan_orig, ''))), 5)) = 0 and
					isnumeric(substring(ltrim(rtrim(isnull(pan_orig, ''))), 6, 4)) = 1 and
					isnumeric(right(ltrim(rtrim(isnull(pan_orig, ''))), 1)) = 0 and
					len(ltrim(rtrim(isnull(pan_orig, '')))) = 10
				)
				then 'INVALID PAN'
			end,

		pan_length = len(ltrim(rtrim(isnull(pan_orig, '')))),
		phone = ltrim(rtrim(phone)),
		client_address = ltrim(rtrim(client_address))

	from
		mimansa_angel_ucc_bsecm_client_data with(nolock)

	where
		ltrim(rtrim(isnull(pan_no, 'NA'))) = 'NA'

	order by
		pan_err, 
		client_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_client_data_fetch
-- --------------------------------------------------



CREATE             proc

	[dbo].[mimansa_usp_ucc_bsecm_client_data_fetch] 
as

/*
	exec sp_ucc_bsecm_client_data_fetch 'N'
	exec sp_ucc_bsecm_client_data_fetch 'Y'
	exec mimansa_usp_ucc_bsecm_client_data_fetch 
*/

set nocount on

--update
--	angel_ucc_bsecm_client_data
--set
--	client_first_name = ltrim(rtrim(isnull(m.firstname_pan, ''))),
--	client_middle_name = ltrim(rtrim(isnull(m.middlename_pan, ''))),
--	client_last_name = ltrim(rtrim(isnull(m.lastname_pan, '')))
---- 	client_long_name = ltrim(rtrim(ltrim(rtrim(isnull(m.firstname_pan, ''))) + ' ' + ltrim(rtrim(isnull(m.middlename_pan, ''))) + ' ' + ltrim(rtrim(isnull(m.lastname_pan, '')))))
--from
----	____temp_ucc_bsecm_name_mismatch
--	____temp_ucc_bsecm_name_mismatch_invalid_clients m
---- 	____temp_ucc_bsecm_name_mismatch_invalid_clients_ii m
--where
--	ltrim(rtrim(angel_ucc_bsecm_client_data.client_code)) = ltrim(rtrim(m.clientcode))

--	and len(ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.client_code, '')))) > 0
--	and len(ltrim(rtrim(isnull(m.clientcode, '')))) > 0

--	and len(ltrim(rtrim(isnull(m.pan, '')))) > 0
--	and len(ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.pan_no, '')))) > 0
--	and ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.pan_no, '' ))) <> 'NA' 

--	and (len(isnull(m.firstname_pan, '')) + len(isnull(m.firstname_pan, ''))  + len(isnull(m.firstname_pan, ''))) > 0

--update
--	angel_ucc_bsecm_client_data
--set
--	client_long_name = ltrim(rtrim(isnull(m.clientname_pan, '')))
--from
--	____temp_ucc_bsecm_name_mismatch_invalid_clients_ii m
--where
--	ltrim(rtrim(angel_ucc_bsecm_client_data.client_code)) = ltrim(rtrim(m.clientcode))

--	and len(ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.client_code, '')))) > 0
--	and len(ltrim(rtrim(isnull(m.clientcode, '')))) > 0

--	and len(ltrim(rtrim(isnull(m.pan, '')))) > 0
--	and len(ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.pan_no, '')))) > 0
--	and ltrim(rtrim(isnull(angel_ucc_bsecm_client_data.pan_no, '' ))) <> 'NA'

--	and (len(isnull(m.firstname_pan, '')) + len(isnull(m.firstname_pan, ''))  + len(isnull(m.firstname_pan, ''))) = 0
--	and len(isnull(m.clientname_pan, '')) > 0

delete
	mimansa_angel_ucc_bsecm_client_data
from
	--[196.1.115.239].inhouse.dbo.AllSebiBannedEntities bp with (nolock)
	[INTRANET].mimansa.dbo.UCC_AllSebiBannedEntities bp with (nolock)
where
	ltrim(rtrim(replace(isnull(mimansa_angel_ucc_bsecm_client_data.pan_no, ''), ',', ''))) = ltrim(rtrim(isnull(bp.panno, '')))
	and len(bp.panno)=10
set nocount off

select distinct
	new_modify,
	sub_bat_user,
	equity_client,
	derivative_client,
	reserved_001,
	reserved_002,
	reserved_003,
	client_code,
	client_status,
	client_category,

	client_long_name = 
		case 
			when len(ltrim(rtrim(dbo.strip_non_alpha( client_long_name )))) = 0 
			then ''
			else ltrim(rtrim(dbo.strip_non_alpha( client_long_name )))
		end,

	client_last_name = 
		case 
			when len(dbo.strip_non_alpha( client_last_name )) = 0 
			then ''
			else dbo.strip_non_alpha( client_last_name )
		end,
	client_first_name = 
		case 
			when len(dbo.strip_non_alpha( client_first_name )) = 0 
			then ''
			else dbo.strip_non_alpha( client_first_name )
		end,
	client_middle_name = 
		case 
			when len(dbo.strip_non_alpha( client_middle_name )) = 0 
			then ''
			else dbo.strip_non_alpha( client_middle_name )
		end,
	client_address,
	city = 
		case 
			when len(city)  = 0 
			then ''
			else city
		end,
	state = 
		case 
			when len( state ) = 0 
			then ''
			else  state 
		end,
	country = 
		case 
			when len(country)=0 
			then ''
			else country
		end,
	pin_code,
	std_code,
	phone,
	email,
	--mapin,
	MobilePager,
	pan_no,
	registration_no,
	registering_authority,
	place_of_registration,
	date_of_registration,
	passport_no,
	place_of_issue_of_passport,
	date_of_issue_of_passport,
	driving_license_no,
	place_of_issue_of_driving_license,
	date_of_issue_of_driving_license,
	voter_id,
	place_of_issue_of_voter_id,
	date_of_issue_of_voter_id,
	ration_card_number,
	place_of_issue_of_ration_card,
	date_of_issue_of_ration_card,
	bank_name,
	bank_address,
	bank_account_type,
	bank_account_no,
	depository_name,
	depository_participant,
	client_dp_id,
	remarks,
	introducers_name = '',
	sub_broker = '',
	date_of_birth,
	client_agreement_date,
	--client_with_other_member,
	Type_Of_Service,
	is_active,
	CP_CODE , 
	EQ_CMID ,
	FNO_CP_CODE ,
	FNO_CMID ,
	CIN ,
	WHETHER_CORPORATE_WITH_CIN  
from
	mimansa_angel_ucc_bsecm_client_data with(nolock) 
where
	len(ltrim(rtrim(isnull(pan_no, '')))) > 0 and
	isnull(pan_no, '' ) <> 'NA' 
order by 
	new_modify,
	client_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_client_data_pop
-- --------------------------------------------------



CREATE proc

	[dbo].[mimansa_usp_ucc_bsecm_client_data_pop]

as


	set nocount on


	/*******************FETCH DATA**************************/

	

	--truncate table angel_ucc_bsecm_client1
	--truncate table angel_ucc_bsecm_client2
--	truncate table angel_ucc_bsecm_client4
	--truncate table angel_ucc_bsecm_client5

	--truncate table angel_ucc_bsecm_client_bank

	truncate table mimansa_angel_ucc_bsecm_client_data

	set nocount on
	--insert into 
	--	angel_ucc_bsecm_client1
	select
		party_code=ltrim(rtrim(c2.party_code)),
		Cl_Code=ltrim(rtrim(c1.Cl_Code)),Short_Name=ltrim(rtrim(c1.Short_Name)),Long_Name=ltrim(rtrim(c1.Long_Name)),L_Address1=ltrim(rtrim(c1.L_Address1)),L_Address2=ltrim(rtrim(c1.L_Address2)),
		L_city=ltrim(rtrim(c1.L_city)),L_State=ltrim(rtrim(c1.L_State)),L_Nation=ltrim(rtrim(c1.L_Nation)),L_Zip=ltrim(rtrim(c1.L_Zip)),Fax=ltrim(rtrim(c1.Fax)),Res_Phone1=dbo.strip_non_digit(ltrim(rtrim(c1.Res_Phone1))),
		Res_Phone2=dbo.strip_non_digit(ltrim(rtrim(c1.Res_Phone2))),Off_Phone1=dbo.strip_non_digit(ltrim(rtrim(c1.Off_Phone1))),Off_Phone2=dbo.strip_non_digit(ltrim(rtrim(c1.Off_Phone2))),Email=ltrim(rtrim(c1.Email)),Branch_cd=ltrim(rtrim(c1.Branch_cd)),
		Credit_Limit=ltrim(rtrim(c1.Credit_Limit)),Cl_type=ltrim(rtrim(c1.Cl_type)),Cl_Status=ltrim(rtrim(c1.Cl_Status)),Gl_Code=ltrim(rtrim(c1.Gl_Code)),Fd_Code=ltrim(rtrim(c1.Fd_Code)),
		Family=ltrim(rtrim(c1.Family)),Penalty=ltrim(rtrim(c1.Penalty)),Sub_Broker=ltrim(rtrim(c1.Sub_Broker)),Confirm_fax=ltrim(rtrim(c1.Confirm_fax)),PhoneOld=ltrim(rtrim(c1.PhoneOld)),
		L_Address3=ltrim(rtrim(c1.L_Address3)),Mobile_Pager=dbo.strip_non_digit(ltrim(rtrim(c1.Mobile_Pager))),pan_gir_no=ltrim(rtrim(c1.pan_gir_no)),trader=ltrim(rtrim(c1.trader)),Ward_No=ltrim(rtrim(c1.Ward_No)),
		Region=ltrim(rtrim(c1.Region)),Area=ltrim(rtrim(c1.Area)),Clrating=ltrim(rtrim(c1.Clrating)) 
	into #temp_client1 	
	from 
		AngelBSECM.bsedb_ab.dbo.client1 c1 with(nolock), 
		AngelBSECM.bsedb_ab.dbo.client2 c2 with(nolock),
		mimansa_angel_tbl_ucc_bsecm_trade t with (nolock)
	where 
		c1.cl_code= c2.cl_code and 
		c2.party_code = t.party_code 

	
	set nocount on
	--insert into 
	--	angel_ucc_bsecm_client2
	select 
		Cl_Code=c2.Cl_Code,Party_code=c2.Party_code--,Exchange=ltrim(rtrim(c2.Exchange))
		--,Tran_Cat=ltrim(rtrim(c2.Tran_Cat)),Scrip_cat=ltrim(rtrim(c2.Scrip_cat)),
		--Party_code=ltrim(rtrim(c2.Party_code)),Table_no=ltrim(rtrim(c2.Table_no)),Sub_TableNo=ltrim(rtrim(c2.Sub_TableNo)),Margin=ltrim(rtrim(c2.Margin)),
		--Turnover_tax=ltrim(rtrim(c2.Turnover_tax)),Sebi_Turn_tax=ltrim(rtrim(c2.Sebi_Turn_tax)),Insurance_Chrg=ltrim(rtrim(c2.Insurance_Chrg)),
		--Service_chrg=ltrim(rtrim(c2.Service_chrg)),Std_rate=ltrim(rtrim(c2.Std_rate)),P_To_P=ltrim(rtrim(c2.P_To_P)),exposure_lim=ltrim(rtrim(c2.exposure_lim)),
		--demat_tableno=ltrim(rtrim(c2.demat_tableno)),BankId=ltrim(rtrim(c2.BankId)),CltDpNo=ltrim(rtrim(c2.CltDpNo)),Printf=ltrim(rtrim(c2.Printf)),
		--ALBMDelchrg=ltrim(rtrim(c2.ALBMDelchrg)),ALBMDelivery=ltrim(rtrim(c2.ALBMDelivery)),AlbmCF_tableno=ltrim(rtrim(c2.AlbmCF_tableno)),
		--MF_tableno=ltrim(rtrim(c2.MF_tableno)),SB_tableno=ltrim(rtrim(c2.SB_tableno)),brok1_tableno=ltrim(rtrim(c2.brok1_tableno)),
		--brok2_tableno=ltrim(rtrim(c2.brok2_tableno)),brok3_tableno=ltrim(rtrim(c2.brok3_tableno)),BrokerNote=ltrim(rtrim(c2.BrokerNote)),
		--Other_chrg=ltrim(rtrim(c2.Other_chrg)),brok_scheme=ltrim(rtrim(c2.brok_scheme)),contcharge=ltrim(rtrim(c2.contcharge)),
		--mincontamt=ltrim(rtrim(c2.mincontamt)),AddLedgerBal=ltrim(rtrim(c2.AddLedgerBal)),Dummy1=ltrim(rtrim(c2.Dummy1)),Dummy2=ltrim(rtrim(c2.Dummy2)),
		--InsCont=ltrim(rtrim(c2.InsCont)),SerTaxMethod=ltrim(rtrim(c2.SerTaxMethod)),dummy6=ltrim(rtrim(c2.dummy6)),dummy7=ltrim(rtrim(c2.dummy7)),
		--dummy8=ltrim(rtrim(c2.dummy8)),dummy9=ltrim(rtrim(c2.dummy9)),dummy10=ltrim(rtrim(c2.dummy10)),PARENTCODE=ltrim(rtrim(c2.PARENTCODE)),PRODUCTCODE=ltrim(rtrim(c2.PRODUCTCODE))
	into #temp_client2 		
	from 
		AngelBSECM.bsedb_ab.dbo.client2 c2 with(nolock),
		mimansa_angel_tbl_ucc_bsecm_trade t with (nolock)
	where 
		c2.party_code = t.party_code
		

	
	set nocount on
	--insert into 
	--	angel_ucc_bsecm_client5
	select 
		party_code=t.party_code,
		--c5.*
		cl_code=c5.cl_code,regr_no=c5.regr_no,regr_auth=c5.regr_auth,
		regr_place=c5.regr_place,regr_date=c5.regr_date,passportdtl=c5.passportdtl,
		passportplaceofissue=c5.passportplaceofissue,passportdateofissue=c5.passportdateofissue,
		drivelicendtl=c5.drivelicendtl,licencenoplaceofissue=c5.licencenoplaceofissue,
		licencenodateofissue=c5.licencenodateofissue,votersiddtl=c5.votersiddtl,
		voteridplaceofissue=c5.voteridplaceofissue,voteriddateofissue=c5.voteriddateofissue,
		rationcarddtl=c5.rationcarddtl,rationcardplaceofissue=c5.rationcardplaceofissue,
		rationcarddateofissue=c5.rationcarddateofissue,introducer=c5.introducer,
		birthdate=c5.birthdate,client_agre_dt=c5.client_agre_dt,
		inactivefrom=c5.inactivefrom 
	into #temp_client5	
	from 
		AngelBSECM.bsedb_ab.dbo.client5 c5 with(nolock),
		#temp_client2 t with (nolock)
	where 
		c5.cl_code = t.cl_code
		


	set nocount on
	select distinct
		party_code = ltrim(rtrim(c4.party_code)),
		bank_id = ltrim(rtrim(c4.bankid)),
		bank_name = ltrim(rtrim(isnull(b.bank_name, ''))),
		bank_address = ltrim(rtrim(isnull(b.address1, ''))) + space(1) + ltrim(rtrim(isnull(b.address2, ''))) + space(1) + ltrim(rtrim(isnull(b.city, ''))) + space(1) + ltrim(rtrim(isnull(b.state, ''))) + space(1) + ltrim(rtrim(isnull(b.nation, ''))),
		account_type = ltrim(rtrim(c4.depository)),
		account_no = ltrim(rtrim(c4.cltdpid))
	into
		#pobank
	from
		mimansa_angel_tbl_ucc_bsecm_trade t with (nolock),
		AngelBSECM.bsedb_ab.dbo.client4 c4 with(nolock),
		AngelBSECM.bsedb_ab.dbo.pobank b with(nolock)
	where
		t.party_code = c4.party_code and
		c4.bankid = b.bankid and
		c4.depository in ('SAVING', 'CURRENT', 'OTHER')


	set nocount on
	select distinct
		party_code = ltrim(rtrim(c4.party_code)),
		bank_id = ltrim(rtrim(c4.bankid)),
		bank_name = ltrim(rtrim(isnull(b.bankname, ''))),
		bank_address = ltrim(rtrim(isnull(b.address1, ''))) + space(1) + ltrim(rtrim(isnull(b.address2, ''))) + space(1) + ltrim(rtrim(isnull(b.city, ''))),
		account_type = ltrim(rtrim(c4.depository)),
		account_no = ltrim(rtrim(c4.cltdpid))
	into
		#bank
	from
		mimansa_angel_tbl_ucc_bsecm_trade t with (nolock),
		AngelBSECM.bsedb_ab.dbo.client4 c4 with(nolock),
		AngelBSECM.bsedb_ab.dbo.bank b with(nolock)
	where
		t.party_code = c4.party_code and
		c4.bankid = b.bankid and
		c4.depository in ('CDSL', 'NSDL') and
		c4.defdp = '1'

	set nocount on
	--insert into
		--angel_ucc_bsecm_client_bank
		--#temp_Bank
	select distinct
		party_code = ltrim(rtrim(case when po.party_code is null then b.party_code else po.party_code end)),
		bank_name = ltrim(rtrim(isnull(po.bank_name, ''))),
		bank_address = ltrim(rtrim(isnull(po.bank_address, ''))),
		bank_account_type = ltrim(rtrim(isnull(po.account_type, ''))),
		bank_account_no = ltrim(rtrim(isnull(po.account_no, ''))),
	
		dp_name = ltrim(rtrim(isnull(b.account_type, ''))),
		depository_participant = ltrim(rtrim(isnull(b.bank_name, ''))),
		demat_id_of_client = ltrim(rtrim(isnull(b.account_no, '')))
	into #temp_Bank	
	from
		#pobank po full outer join #bank b on ltrim(rtrim(po.party_code)) = ltrim(rtrim(b.party_code))
	order by
		ltrim(rtrim(case when po.party_code is null then b.party_code else po.party_code end))



	/*******************END - FETCH DATA**************************/

	insert into
		mimansa_angel_ucc_bsecm_client_data
	select 
		new_modify = 'N',
		sub_bat_user = cast ('' as varchar(11)),
	
		equity_client = 'Y',
		derivative_client = 'N',
		reserved_001 = cast ('' as varchar(1)),
		reserved_002 = cast ('' as varchar(1)),
		reserved_003 = cast ('' as varchar(1)),
		client_code = 
			left(
				isnull(
					replace(
						replace(
							replace(
								ltrim(rtrim(isnull(c2.party_code, 'NA'))), '%', ''
							), '|', ''
						), ',', ''
					), 'NA'
				), 10
			),

		client_status = 'CL',
		client_category = 
			case 
				when ltrim(rtrim(c1_b.cl_status)) = 'HUF' then 'HUF' 
				when ltrim(rtrim(c1_b.cl_status)) = 'PF'  then 'PF'  
				when ltrim(rtrim(c1_b.cl_status)) = 'TS'  then 'NT' 
				when ltrim(rtrim(c1_b.cl_status)) = 'BCP'  then 'CO' 
				when ltrim(rtrim(c1_b.cl_status)) = 'IND' then 'I' 
				when ltrim(rtrim(c1_b.cl_status)) = 'OCB' then 'OCB' 
				when ltrim(rtrim(c1_b.cl_status)) = 'NRE' then 'NRI' 
				when ltrim(rtrim(c1_b.cl_status)) = 'NRO' then 'NRI' 
				when ltrim(rtrim(c1_b.cl_status)) = 'NRI' then 'NRI' 
				when ltrim(rtrim(c1_b.cl_status)) = 'OTH' then 'O' 
				when ltrim(rtrim(c1_b.cl_status)) = 'FVC' then 'FVCF' 
				when ltrim(rtrim(c1_b.cl_status)) = 'QFI' then 'QFI' 
				else ' '
			end,
			client_long_name = left(ltrim(rtrim(isnull(c1_b.long_name, ''))), 100),
			client_first_name = 
				left(
					left (
						replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)),
						case 
							when charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) <= 0 then len(replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1))) 
							else charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) 
						end
					), 50
				),
			client_middle_name = 
				left(
					substring (
						replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)),
						case 
							when charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) <= 0 then 1 
							else charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) + 1 
						end,
						case when
							charindex (
								space(1), 
								replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 
								case 
									when charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) <= 0 then 1 
									else charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) + 1 
								end
							) <= 0 then len(replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1))) else
							charindex (
								space(1), 
								replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 
								case 
									when charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) <= 0 then 1 
									else charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) + 1 
								end
							)
						end - 
						case 
							when charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) <= 0 then 0 
							else charindex (space(1), replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)), 1) 
						end
					), 50
				),
			client_last_name = 
				left(
					right (
						replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1)),
						case 
							when charindex (space(1), reverse (replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1))), 1) <= 0 then len(replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1))) 
							else charindex (space(1), reverse (replace(ltrim(rtrim(isnull(c1_b.long_name, ''))), space(2), space(1))), 1) - 1 
						end
					), 50
				),
			client_address = 
				case 
					when len(ltrim(rtrim(left(ltrim(rtrim(isnull(c1_b.l_address1, '')))  + space(1) + ltrim(rtrim(isnull(c1_b.l_address2, ''))) + space(1) + ltrim(rtrim(isnull(c1_b.l_address3, ''))), 250)))) = 0
					then 'NA'
					else left(ltrim(rtrim(isnull(c1_b.l_address1, 'NA')))  + space(1) + ltrim(rtrim(isnull(c1_b.l_address2, 'NA'))) + space(1) + ltrim(rtrim(isnull(c1_b.l_address3, 'NA'))), 250)
					end,
			city = case 
					when len(ltrim(rtrim(isnull(c1_b.l_city, '')))) = 0
					then 'NA'
					else left(ltrim(rtrim(isnull(c1_b.l_city, 'NA'))), 25)
					end,
			state = 
				case 
					when len(ltrim(rtrim(isnull(c1_b.l_state, '')))) = 0 then 'XXXXXX'
					else left(ltrim(rtrim(isnull(c1_b.l_state, 'NA'))), 25)
				end,
			country = 
				case 
					when len(left(ltrim(rtrim(isnull(c1_b.l_nation, ''))), 25)) = 0
					then 'NA'
					else left(ltrim(rtrim(isnull(c1_b.l_nation, 'NA'))), 25)
					end,
			pin_code = 
				replace(
					case 
						when len(ltrim(rtrim(isnull(c1_b.l_zip, '')))) <> 6 then '999999'
						when len(ltrim(rtrim(isnull(c1_b.l_zip, '')))) = 0 then '999999'
						else left(ltrim(rtrim(isnull(c1_b.l_zip, '999999'))), 6)
					end, ' ', ''
				),
			std_code = left('0000000000', 10), /*left('999', 10),*/
			phone = 
				left(
					
						case 
							when len(isnull(c1_b.res_phone1, '')) > 0 then isnull(c1_b.res_phone1, '')
							when len(isnull(c1_b.res_phone2, '')) > 0 then isnull(c1_b.res_phone2, '')
							when len(isnull(c1_b.off_phone1, '')) > 0 then isnull(c1_b.off_phone1, '')
							when len(isnull(c1_b.off_phone2, '')) > 0 then isnull(c1_b.off_phone2, '')
						else 
							'' 
						end
												
						, 15
				),
		email = left(isnull(email, ''), 50),
		MobilePager=isnull(c1_b.Mobile_Pager,''),
		pan_no = 
			case 
				when
					len(ltrim(rtrim(isnull(pan_gir_no, '')))) = 0
				then
					'NA'
				when 
					not (
						isnumeric(left(	ltrim(rtrim(isnull(pan_gir_no, ''))), 5)) = 0 and 
						isnumeric(substring(	ltrim(rtrim(isnull(pan_gir_no, ''))), 6, 4)) = 1 and
						isnumeric(right(ltrim(rtrim(isnull(pan_gir_no, ''))), 1)) = 0 and
						len(ltrim(rtrim(isnull(pan_gir_no, '')))) = 10
					)
				then
					'NA'
				else
					ltrim(rtrim(isnull(pan_gir_no, 'NA')))
				end,
	
		registration_no = left(ltrim(rtrim(isnull(c5.regr_no, ''))), 50),
		registering_authority = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.regr_no, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.regr_auth, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.regr_auth, ''))) end
				end, 50
			),
		place_of_registration = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.regr_no, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.regr_place, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.regr_place, ''))) end
				end, 50
			),

		date_of_registration = 
				case 
					when ltrim(rtrim(c1_b.cl_status)) not in ('IND', 'SP', 'NRI') then convert(varchar, isnull(c5.regr_date, ''), 103)
				else
					case 
						when ltrim(rtrim(isnull(c5.regr_no, ''))) = '' then cast ('' as varchar(1))
						else convert(varchar, isnull(c5.regr_date, ''), 103)
					end
				end,
		passport_no = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.passportdtl, ''))) = '' then cast ('' as varchar(1))
					else ltrim(rtrim(isnull(c5.passportdtl, ''))) 
				end, 50
			),
		place_of_issue_of_passport = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.passportdtl, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.passportplaceofissue, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.passportplaceofissue, ''))) end
				end, 50
			),
		date_of_issue_of_passport = 
			case 
				when ltrim(rtrim(isnull(c5.passportdtl, ''))) = '' then cast ('' as varchar(1))
				else convert(varchar, isnull(c5.passportdateofissue, ''), 103)
			end,
	
		driving_license_no = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.drivelicendtl, ''))) = '' then cast ('' as varchar(1))
					else ltrim(rtrim(isnull(c5.drivelicendtl, ''))) 
				end, 50
			),
		place_of_issue_of_driving_license = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.drivelicendtl, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.licencenoplaceofissue, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.licencenoplaceofissue, ''))) end
				end, 50
			),
		date_of_issue_of_driving_license = 
			case 
				when ltrim(rtrim(isnull(c5.drivelicendtl, ''))) = '' then cast ('' as varchar(1))
				else convert(varchar, isnull(c5.licencenodateofissue, ''), 103)
			end,
	
		voter_id = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.votersiddtl, ''))) = '' then cast ('' as varchar(1))
					else ltrim(rtrim(isnull(c5.votersiddtl, ''))) 
				end, 50
			),
		place_of_issue_of_voter_id = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.votersiddtl, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.voteridplaceofissue, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.voteridplaceofissue, ''))) end
				end, 50
			),
		date_of_issue_of_voter_id = 
			case 
				when ltrim(rtrim(isnull(c5.votersiddtl, ''))) = '' then cast ('' as varchar(1))
				else convert(varchar, isnull(c5.voteriddateofissue, ''), 103)
			end,
	
		ration_card_number = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.rationcarddtl, ''))) = '' then cast ('' as varchar(1))
					else ltrim(rtrim(isnull(c5.rationcarddtl, ''))) 
				end, 50
			),
		place_of_issue_of_ration_card = 
			left(
				case 
					when ltrim(rtrim(isnull(c5.rationcarddtl, ''))) = '' then cast ('' as varchar(1))
					else case when len(ltrim(rtrim(isnull(c5.rationcardplaceofissue, '')))) = 0 then 'NA' else ltrim(rtrim(isnull(c5.rationcardplaceofissue, ''))) end
				end, 50
			),
		date_of_issue_of_ration_card = 
			case 
				when ltrim(rtrim(isnull(c5.rationcarddtl, ''))) = '' then cast ('' as varchar(1))
				else convert(varchar, isnull(c5.rationcarddateofissue, ''), 103)
			end,
		bank_name = 
			left(
				case 
					when (isnull(c1_b.bank_account_type, '')) in ('SAVING', 'CURRENT', 'OTHER') 
					then ltrim(rtrim(isnull(c1_b.bank_name, ''))) else '' end, 50
			),
		bank_address = 
			left(
				case 
					when (isnull(c1_b.bank_account_type, '')) in ('SAVING', 'CURRENT', 'OTHER') 
					then ltrim(rtrim(isnull(c1_b.bank_address, ''))) else '' end, 200
			),
		bank_account_type = 
			left(
				case 
					when (isnull(c1_b.bank_account_type, '')) in ('SAVING', 'CURRENT', 'OTHER') 
					then ltrim(rtrim(isnull(c1_b.bank_account_type, ''))) else '' end, 20
			),
		bank_account_no = 
			left(
				case 
					when (isnull(c1_b.bank_account_type, '')) in ('SAVING', 'CURRENT', 'OTHER') 
					then ltrim(rtrim(isnull(c1_b.bank_account_no, ''))) else '' end, 20
			),
	
		depository_name = 
			left(
				case 
					when (isnull(c1_b.dp_name, '')) in ('CDSL', 'NSDL') 
					then ltrim(rtrim(isnull(c1_b.dp_name, ''))) else '' end, 50
			),
		depository_participant = 
			left(
				case 
					when (isnull(c1_b.dp_name, '')) in ('CDSL', 'NSDL') 
					then ltrim(rtrim(isnull(c1_b.depository_participant, ''))) else '' end, 50
			),
		client_dp_id = 
			left(
				case 
					when (isnull(c1_b.dp_name, '')) in ('CDSL', 'NSDL') 
					then ltrim(rtrim(isnull(c1_b.demat_id_of_client, ''))) else '' end, 50
			),
	
		remarks = cast ('' as varchar(1)),
	
		introducers_name = 
			left(ltrim(rtrim(isnull(c5.introducer, ''))), 50),
	
		sub_broker = 
			left(ltrim(rtrim(isnull(c1_b.sub_broker, ''))), 50),
	
		date_of_birth = 
				case 
					when ltrim(rtrim(c1_b.cl_status)) in ('IND', 'SP', 'NRI') then convert(varchar, isnull(c5.birthdate, ''), 103)
				else
					case 
						when replace(convert(varchar, isnull(c5.birthdate, ''), 103), '/', '') = '01011900' then ''
						else convert(varchar, isnull(c5.birthdate, ''), 103)
					end
				end,
	
		client_agreement_date = 
			case 
				when replace(convert(varchar, isnull(c5.client_agre_dt, ''), 103), '/', '') = '01011900' then ''
				else convert(varchar, isnull(c5.client_agre_dt, ''), 103)
			end,
	    Type_Of_Service='4',
		is_active = 
			case when c5.inactivefrom > getdate() then 'Y' else 'N' end,

		record_time = getdate(),
		pan_orig = pan_gir_no,
		client_code_orig = c2.party_code,
		dummy_001 = '',
		dummy_002 = '',
		dummy_003 = '',
		dummy_004 = '',
		dummy_005 = '',
		dummy_006 = '',
		dummy_007 = '',
		dummy_008 = '',
		dummy_009 = '',
		dummy_010 = '',
		CP_CODE ='', 
		EQ_CMID ='',
		FNO_CP_CODE ='',
		FNO_CMID ='',
		CIN ='',
		WHETHER_CORPORATE_WITH_CIN =''

	from
		(
			select 
				c1.*,
				b.bank_name, b.bank_address, b.bank_account_type, b.bank_account_no, b.dp_name, b.depository_participant, b.demat_id_of_client
			from
				#temp_client1 c1 with (nolock) 
					left outer join
				#temp_Bank b with (nolock)
					on ltrim(rtrim(c1.party_code)) = ltrim(rtrim(b.party_code))
		) c1_b,
		#temp_client2 c2 with (nolock),
		#temp_client5 c5 with (nolock)

	where
		ltrim(rtrim(c1_b.party_code)) = ltrim(rtrim(c2.party_code)) and
		ltrim(rtrim(c2.party_code)) = ltrim(rtrim(c5.party_code)) and
		ltrim(rtrim(left(c2.party_code,2))) <> '98'


--	update mimansa_angel_ucc_bsecm_client_data set bank_account_type = 'SAVINGS' where bank_account_type = 'SAVING'
	update mimansa_angel_ucc_bsecm_client_data set bank_account_type = 'SAVING' where bank_account_type like 'SAVING%'
	update mimansa_angel_ucc_bsecm_client_data set bank_account_type = 'OTHERS' where bank_account_type = 'OTHER'

	update
		mimansa_angel_ucc_bsecm_client_data
	set
		client_long_name = ltrim(rtrim(isnull(addemailid, '')))
	from
		anand1.msajag.dbo.client_details 
	where
		ltrim(rtrim(client_code)) = ltrim(rtrim(party_code))
		and len(ltrim(rtrim(isnull(client_code, '')))) > 0
		and len(ltrim(rtrim(isnull(party_code, '')))) > 0
		and len(ltrim(rtrim(isnull(addemailid, '')))) > 0


--anand1.msajag.dbo.CLIENT_MASTER_UCC_DATA Table flag values
--Email			:	1
--SMS			:	2
--SMS & Email	:	3

--BSE required format
--SMS			:	1
--Email			:	2
--SMS & Email	:	3
--None			:	4


    update
		mimansa_angel_ucc_bsecm_client_data
	set
		Type_Of_Service = 
		case when ltrim(rtrim(TYPEOFFACILITY))=1 then '2'  
		 when ltrim(rtrim(TYPEOFFACILITY))=2 then '1' 
		 when ltrim(rtrim(TYPEOFFACILITY))=3 then '3' 
	     else  '4' end
	    
	from
		anand1.msajag.dbo.CLIENT_MASTER_UCC_DATA with(nolock)
	where
		ltrim(rtrim(client_code)) = ltrim(rtrim(party_code))
		and len(ltrim(rtrim(isnull(client_code, '')))) > 0
		and len(ltrim(rtrim(isnull(party_code, '')))) > 0

	--Added by prasanna on Jun 19 2012 for adding CIN column in Ucc Nsecm file as suggested in circular. 	
	update
		mimansa_angel_ucc_bsecm_client_data
	set
		mimansa_angel_ucc_bsecm_client_data.cin=isnull(c1.cin,'')
	from
		anand1.msajag.dbo.CLIENT_MASTER_NOMINEE_DATA c1 with(nolock)--,AngelBSECM.bsedb_ab.dbo.client1 c2 with(nolock)
	where
		client_code = party_code
		and len(isnull(client_code, '')) > 0
		and len(isnull(party_code, '')) > 0	
		--and c2.cl_code=c1.party_code
		--and c2.cl_code=mimansa_angel_ucc_bsecm_client_data.client_code
		--and c2.cl_status='BCP'		
		and mimansa_angel_ucc_bsecm_client_data.client_category='CO'

	set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_load_new_client_data
-- --------------------------------------------------
CREATE proc

	[dbo].[mimansa_usp_ucc_bsecm_load_new_client_data] (
		@from_date varchar(11), 
		@to_date varchar(11) 
	)

as

/*
exec mimansa_usp_ucc_bsecm_load_modified_client_data 'Mar 05 2013','Mar 06 2013'
*/

set implicit_transactions off 
set nocount on 
set transaction isolation level read uncommitted 

insert into 
	mimansa_angel_tbl_ucc_bsecm_trade
select distinct
	party_code
from
	(
		select 
			c2.party_code,
			active = case when activefrom >= convert(datetime, left(convert(varchar, getdate(), 109), 11) + ' 00:00:00') then 'Y' else 'N' end,
			added_date = activefrom
		from 
			bsedb_ab.dbo.client2 c2 with(nolock),
			bsedb_ab.dbo.client5 c5 with(nolock)
		where
			ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c5.cl_code)) and
			activefrom >= convert(datetime, @from_date + ' 00:00:00') and
			activefrom < convert(datetime, @to_date + ' 23:59:59')
	) new_clients

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mimansa_usp_ucc_bsecm_load_new_client_data_backup01Oct2017
-- --------------------------------------------------

CREATE proc

	[dbo].[mimansa_usp_ucc_bsecm_load_new_client_data_backup01Oct2017] (
		@from_date varchar(11), 
		@to_date varchar(11) 
	)

as

/*
exec mimansa_usp_ucc_bsecm_load_modified_client_data 'Mar 05 2013','Mar 06 2013'
*/

set implicit_transactions off 
set nocount on 
set transaction isolation level read uncommitted 

insert into 
	mimansa_angel_tbl_ucc_bsecm_trade
select distinct
	party_code
from
	(
		select 
			c2.party_code,
			active = case when activefrom >= convert(datetime, left(convert(varchar, getdate(), 109), 11) + ' 00:00:00') then 'Y' else 'N' end,
			added_date = activefrom
		from 
			anand.bsedb_ab.dbo.client2 c2 with(nolock),
			anand.bsedb_ab.dbo.client5 c5 with(nolock)
		where
			ltrim(rtrim(c2.cl_code)) = ltrim(rtrim(c5.cl_code)) and
			activefrom >= convert(datetime, @from_date + ' 00:00:00') and
			activefrom < convert(datetime, @to_date + ' 23:59:59')
	) new_clients

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MimansaPoBankDetails
-- --------------------------------------------------
CREATE Procedure [dbo].[MimansaPoBankDetails]
As
Select               
c.Party_code,              
'BSE-CAPITAL' as Exchange,              
BankName = isnull(p.Bank_Name,''),              
Branch = isnull(p.Branch_Name,''),              
AcNum = isnull(c.CltDpId,''),              
AcType = isnull(c.Depository,'')              
From               
Bsedb_ab.Dbo.Client4 c (nolock)              
join              
Bsedb_ab.Dbo.PoBank p (nolock)              
on              
(cast(p.BankId as varchar) = c.BankID)              
Where              
c.Depository not in ('CDSL','NSDL')              
UNION               
Select               
c.cltcode,              
'BSE-CAPITAL' as Exchange,              
BankName = isnull(p.Bank_Name,''),              
Branch = isnull(p.Branch_Name,''),              
AcNum = isnull(c.AccNo,''),              
AcType = isnull(c.AccType,'')               
From               
Account_Ab.dbo.MultiBankId c (nolock)              
join              
Bsedb_ab.Dbo.PoBank p (nolock)              
on                         
(cast(p.BankId as varchar) = c.BankID)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NBFC_RevInt
-- --------------------------------------------------
CREATE Procedure [dbo].[NBFC_RevInt] (@monthflag  as char(1))
as

set nocount on

/* 
@monthflag = "P" for previous Month and "C" for current month.
*/


declare @FPM as varchar(25),@LPM as varchar(25),@FPPM as varchar(25),@Mmnth as int, @Myear as int

if @monthflag='P'
BEGIN
	SELECT	
	@FPM=convert(varchar(11),DATEADD(MONTH, DATEDIFF(MONTH, '19000201', GETDATE()), '19000101'))+' 00:00:00', 
	@LPM=convert(varchar(11),DATEADD(MONTH, DATEDIFF(MONTH, '19000101', GETDATE()), '18991231'))+' 23:59:59'
END
ELSE
BEGIN
	SELECT	
	@FPM=convert(varchar(11),convert(datetime,convert(varchar(2),datepart(m,getdate()))+'/01/'+convert(varchar(4),datepart(yy,getdate()))))+' 00:00:00',
	@LPM=convert(varchar(11),getdate())+' 23:59:59'
END


select @Mmnth=datepart(m,convert(datetime,@fpm))
select @Myear=datepart(yy,convert(datetime,@fpm))
if @Mmnth=1 
begin
	set @Mmnth=12
	set @Myear=@Myear-1
end
else
begin
	set @Mmnth=@Mmnth-1
end

select @FPPM=convert(datetime,convert(varchar(2),@Mmnth)+'/01/'+convert(varchar(4),@Myear))


select * into #file1 from 
(select * from account_Ab.dbo.LEDGER with (nolock) where vdt>=@FPPM and vdt <=@LPM and vtyp=2) a join 
/* (select cl_code from bsedb_Ab.dbo.client1 with (nolock) where cl_type in ('NBF','TMF','SMF') ) b */
 (select cl_code from bsedb_Ab.dbo.client1 with (nolock) where cl_type in ('NBF','TMF') ) b 
on a.cltcode=b.cl_code 

select b.*,a.relamt,reldt,ddno into #file2
from account_Ab.dbo.ledger1 a with (nolock) join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp and a.lno=b.lno 

truncate table NBFC_RevData
insert into NBFC_RevData(segment,cltcode,vdt,vamt,reldt,int_days,InstNo,Vno)
select segment='BSECM',cltcode,vdt,vamt,reldt,datediff(d,vdt,reldt) as int_days,ddno,vno
from #file2 
where converT(varchar(10),vdt,103) <> converT(varchar(10),reldt,103) and reldt >= @FPM and vdt <=@LPM

/*

select a.segment,a.cltcode,a.vamt,a.vdt,a.reldt,a.int_days,b.IntRate,IntAmt=convert(money,(((vamt*IntRate)/100)/365)*int_days) from
(
select segment='BSECM',cltcode,vdt,vamt,reldt,datediff(d,vdt,reldt) as int_days
from #file2 
where converT(varchar(10),vdt,103) <> converT(varchar(10),reldt,103) and reldt >= @FPM and vdt <=@LPM
) a join
(select client_code,intrateequity as IntRate,backofficecode from ABVSNBFCARC.LiveAngel_fundingsystem_new.dbo.Angel_client_intRate) b
on a.cltcode=b.backofficecode
*/

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_Bill2Bill
-- --------------------------------------------------
CREATE Procedure NCMS_Bill2Bill(@pcode as varchar(10) = null)          
as          
         
set xact_abort on          
set nocount on          
          
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
--select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          
          
IF @Pcode is null          
BEGIN          
    

  Truncate table NCMS_PO_B2B          
 
  insert into NCMS_PO_B2B(ProcessDateTime,Cltcode,B2Bamt,SettNo,SettType,NARRATION,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end),
  0,'',NARRATION,           
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59') and vtyp=15    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark where payoutType='B')         
  group by cltcode,NARRATION          
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO_B2B where Cltcode=@pcode          
    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN           
	  insert into NCMS_PO_B2B(ProcessDateTime,Cltcode,B2Bamt,SettNo,SettType,NARRATION,UCV,UnRecoCr,OtherDr)          
	  select Getdate(),CLTCODE,          
	  B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end),
	  0,'',NARRATION,           
	  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
	  0,0          
	  from account_ab.dbo.ledger a with (nolock)           
	  where edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59') and vtyp=15    
	  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark where payoutType='B')         
	  group by cltcode,NARRATION    
 end    
           
END          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_LDmargin_Upload_Utility
-- --------------------------------------------------
                            
                                          
create  PROCEDURE [dbo].[NCMS_LDmargin_Upload_Utility]                                                                      
                                                            
    @Action VARCHAR(100) = NULL                                                                     
   ,@Client_Code VARCHAR(100) = NULL                                                                
  ,@Var_Margin VARCHAR(100) = NULL                                                         
  ,@Peak_Margin VARCHAR(100) = NULL    
  ,@MTM_Loss VARCHAR(100) = NULL    
  ,@Prev_Var_Margin VARCHAR(100) = NULL    
  ,@Prev_MTM_Loss VARCHAR(100) = NULL    
  ,@Span_Exp_Margin VARCHAR(100) = NULL    
   ,@Delivery_Margin VARCHAR(100) = NULL    
   ,@Premium_Value VARCHAR(100) = NULL    
       
                                                          
AS                                                                      
BEGIN                                                           
                                                                                 
     SET NOCOUNT ON;      
          
   --truncate table tbl_margin_Cash     
   --TRUNCATE TABLE  tbl_margin_Cash_HIST    
   if(@Action='CASH')  
   --TRUNCATE TABLE tbl_margin_Cash_HIST   
    begin  
    
     insert into  tbl_margin_Cash_HIST select * from tbl_margin_Cash
     
     BEGIN 
     
    INSERT INTO tbl_margin_Cash (Client_Code,Var_Margin,Peak_Margin,MTM_Loss,Prev_Var_Margin,Prev_MTM_Loss)     
     VALUES (@Client_Code,@Var_Margin,@Peak_Margin,@MTM_Loss,@Prev_Var_Margin,@Prev_MTM_Loss)
     
    -- truncate table tbl_margin_Cash 
     END
      
     
   --select * from tbl_margin_Cash_HIST
   --
   
   select count(*) from tbl_margin_Cash
   
   
   ----  TRUNCATE TABLE tbl_margin_Cash_HIST
   --  BEGIN 
   --TRUNCATE TABLE tbl_margin_Cash
   --      END
      
  end
 
  else if(@Action='NCFO')    
      
    begin    
    INSERT INTO tbl_margin_NCFO (Client_Code,Span_Exp_Margin,Peak_Margin,Delivery_Margin,Premium_Value,MTM_Loss)     
     VALUES (@Client_Code,@Span_Exp_Margin,@Peak_Margin,@Delivery_Margin,@Premium_Value,@MTM_Loss)    
      
  end    
      
  else if(@Action='CURUNCY')    
      
    begin    
    INSERT INTO tbl_margin_currency (Client_Code,Span_Exp_Margin,Peak_Margin,Delivery_Margin,Premium_Value,MTM_Loss)     
     VALUES (@Client_Code,@Span_Exp_Margin,@Peak_Margin,@Delivery_Margin,@Premium_Value,@MTM_Loss)    
      
  end    
  else if(@Action='MCDX')    
      
    begin    
    INSERT INTO tbl_margin_MCDX (Client_Code,Span_Exp_Margin,Peak_Margin,Delivery_Margin,Premium_Value,MTM_Loss)     
     VALUES (@Client_Code,@Span_Exp_Margin,@Peak_Margin,@Delivery_Margin,@Premium_Value,@MTM_Loss)    
      
  end    
  else if(@Action='NCDX')    
      
    begin    
    INSERT INTO tbl_margin_NCDX (Client_Code,Span_Exp_Margin,Peak_Margin,Delivery_Margin,Premium_Value,MTM_Loss)     
     VALUES (@Client_Code,@Span_Exp_Margin,@Peak_Margin,@Delivery_Margin,@Premium_Value,@MTM_Loss)    
      
  end    
      
 --SELECT * FROM tbl_margin_Cash    
 -- SELECT * FROM tbl_margin_NCFO    
 --SELECT * FROM tbl_margin_MCDX    
 -- SELECT * FROM tbl_margin_NCDX    
 -- SELECT * FROM tbl_margin_currency    
 ------  --    
 ---TRUNCATE TABLE  tbl_margin_Cash    
 --TRUNCATE TABLE  tbl_margin_NCFO    
 --TRUNCATE TABLE  tbl_margin_MCDX    
 --TRUNCATE TABLE  tbl_margin_NCDX    
 --TRUNCATE TABLE  tbl_margin_currency    
      
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_POdet](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          


if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update [INTRANET].CMS.dbo.ncms_batch_process set StartDate=GETDATE() where srno=3
End

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur/*sdtnxt*/ from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
   
     select distinct party_code into #PO_client from  [INTRANET].cms.dbo.NCMS_PO_Request_ForPayout with(nolock) 

  create index #PO_cli on #PO_client(Party_code)
   
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35  and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)   ,#PO_client p           
 where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
  /** adding for Unsetteled debit bill**/
 -- Truncate table NCMS_PO_UnsetDr          
    
 -- insert into NCMS_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
 -- select Getdate(),CLTCODE,          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 -- UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
 -- UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
 -- 0,0          
 -- from account_ab.dbo.ledger a with (nolock) ,#PO_client p           
 --where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
 ---- and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 ----and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
 -- group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco_ForPO          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END          


if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update [INTRANET].CMs.dbo.ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=3
End          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_03Apr2018
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_03Apr2018](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          
          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO         
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_03March2017
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_03March2017](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          
          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate          
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO         
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode          
 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_05Apr2017
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_05Apr2017](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
  UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate          
  /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18        )
 /********************************************************************************/
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO         
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode   
   /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18        )
 /********************************************************************************/       
 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_06May2022
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_06May2022](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          


if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update [196.1.115.132].CMS.dbo.ncms_batch_process set StartDate=GETDATE() where srno=3
End

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
  /** adding for Unsetteled debit bill**/
  Truncate table NCMS_PO_UnsetDr          
    
  insert into NCMS_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
  UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
  group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END          


if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update [196.1.115.132].CMs.dbo.ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=3
End          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_25Nov2020
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_25Nov2020](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_30Mar2019
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_30Mar2019](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         
          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_bkup_23122019
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_bkup_23122019](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_Commodity
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_POdet_Commodity](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          


declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur/*sdtnxt*/ from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
   
     select distinct party_code into #PO_client from  [INTRANET].cms.dbo.NCMS_Commodity_clients
   where CAST(updatedOn as date)=CAST(GETDATE() as date)

    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35  and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)   ,#PO_client p           
 where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
  /** adding for Unsetteled debit bill**/
 -- Truncate table NCMS_PO_UnsetDr          
    
 -- insert into NCMS_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
 -- select Getdate(),CLTCODE,          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 -- UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
 -- UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
 -- 0,0          
 -- from account_ab.dbo.ledger a with (nolock) ,#PO_client p           
 --where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
 ---- and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 ----and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
 -- group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco_ForPO          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END          
         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_ForRealTime_PO
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_ForRealTime_PO](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur/*sdtnxt*/ from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

     select distinct party_code into #PO_client from  [INTRANET].cms.dbo.NCMS_RealPO_ForProcess  with(nolock)  where  validationtxt='OK'

  create index #PO_cli on #PO_client(Party_code)
   
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)   ,#PO_client p           
 where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
  /** adding for Unsetteled debit bill**/
 -- Truncate table NCMS_PO_UnsetDr          
    
 -- insert into NCMS_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
 -- select Getdate(),CLTCODE,          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 -- UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
 -- UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
 -- 0,0          
 -- from account_ab.dbo.ledger a with (nolock) ,#PO_client p           
 --where VDT>=@sdtcur and VDT <= @ToDate and CLTCODE=p.party_code
 ---- and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 ----and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
 -- group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco_ForPO          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_morning
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_POdet_morning](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          


declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table NCMS_PO          
    
  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35  and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
  /** adding for Unsetteled debit bill**/
 -- Truncate table NCMS_PO_UnsetDr          
    
 -- insert into NCMS_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
 -- select Getdate(),CLTCODE,          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 -- UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
 -- UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
 -- 0,0          
 -- from account_ab.dbo.ledger a with (nolock)           
 -- where VDT>=@sdtcur and VDT <= @ToDate
 -- and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 --and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
 -- group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco          
    
  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NCMS_PO where Cltcode=@pcode          
          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
          
 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          
 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        
           
END          


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_unpledge
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_unpledge](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

          
IF @Pcode is null          
BEGIN          
    
  Truncate table Unpleadge_po          
    
  insert into Unpleadge_po(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      
  
    
  exec Fetch_CliUnreco          
    
  update Unpleadge_po set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where Unpleadge_po.cltcode=b.cltcode          
    
  update Unpleadge_po set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from Unpleadge_po  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where Unpleadge_po.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update Unpleadge_po set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where Unpleadge_po.cltcode=b.cltcode    
  /* B2B End */    
    
  
END          
ELSE          
BEGIN          
          
 delete from Unpleadge_po where Cltcode=@pcode          
          
 insert into Unpleadge_po(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update Unpleadge_po set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where Unpleadge_po.cltcode=b.cltcode and Unpleadge_po.Cltcode=@pcode          
          
 update Unpleadge_po set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from Unpleadge_po  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where Unpleadge_po.cltcode=b.cltcode and Unpleadge_po.Cltcode=@pcode          
        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_WithOutTdayBilling
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_WithOutTdayBilling](@pcode as varchar(10) = null)          
as                 
Set nocount on                          
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 

--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         
/*Code added to handle Financial year end issue on 3rd April 2017*/

/********************************************************************************/

declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse
select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =

(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )

/********************************************************************************/
IF @Pcode is null          
BEGIN          
  Truncate table NCMS_PO          

  insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
 /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )

 /********************************************************************************/

  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

  group by cltcode          
  exec Fetch_CliUnreco          

  update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NCMS_PO.cltcode=b.cltcode          

   
  update NCMS_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NCMS_PO.cltcode=b.cltcode          

   
  /* Bill to Bill Client */    

  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode    

  /* B2B End */    
 /* REMOVAL of Tday Bill Added by Siva */ 

 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then VAMT else -VAMT end) into #tdaybill        
 from account_ab.dbo.ledger  with (nolock) where vtyp in (15,35) --and (narration like '%NSECMNBILL POSTED%' or narration like '%NSECMWBILL POSTED%')
 and VDT>=(CONVERT(varchar(11),getdate())) and VDT <=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 group by cltcode

 Create index #t on #tdaybill (cltcode)

 update NCMS_PO set VBal=VBal+t.B2Bamt
 from #tdaybill t where NCMS_PO.cltcode =T.CLTCODE 

 /*****Completed ******/
    

  truncate table NCMS_PO_BSEIPO        
  insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from NCMS_PO  with(nolock)        
  where cltcode like '6%' and ISNUMERIC(cltcode)=0        

         
END          
ELSE          
BEGIN          
 delete from NCMS_PO where Cltcode=@pcode          
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */

    /*Added to exclude opening balance of current year*/

  /********************************************************************************/
 and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )

 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/

 -- and  

 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')

 /********************************************/
 group by cltcode     
            
 exec Fetch_CliUnreco @pcode          

           

 update NCMS_PO set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          

          

 update NCMS_PO set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode          

   
 /* Bill to Bill Client */    

 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    

  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     

  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     

 /* B2B End */    

 /* REMOVAL of Tday Bill Added by Siva */ 

 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then VAMT else -VAMT end) into #tdaybill1        
 from account_ab.dbo.ledger  with (nolock) where vtyp in (15,35) --and (narration like '%NSECMNBILL POSTED%' or narration like '%NSECMWBILL POSTED%')
 and VDT>=(CONVERT(varchar(11),getdate())) and VDT <=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 group by cltcode

 Create index #t on #tdaybill1 (cltcode)

 update NCMS_PO set VBal=VBal+t.B2Bamt
 from #tdaybill1 t where NCMS_PO.cltcode =T.CLTCODE 

 /*****Completed ******/      

 delete from NCMS_PO_BSEIPO where Cltcode=@pcode          

 insert into NCMS_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 from NCMS_PO  with(nolock)         
 where substring(Cltcode,2,10)=@pcode        

END                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NRMS_LiveLedger
-- --------------------------------------------------
CREATE Procedure [dbo].[NRMS_LiveLedger](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/
--select * into  NRMS_BSECM_LEDGER from NRMS_BSECM_LEDGER where 1=2
          
IF @Pcode is null          
BEGIN          
    
  Truncate table NRMS_BSECM_LEDGER          
    
  insert into NRMS_BSECM_LEDGER(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode          
    
  exec Fetch_CliUnreco          
    
  update NRMS_BSECM_LEDGER set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where NRMS_BSECM_LEDGER.cltcode=b.cltcode          
    
  update NRMS_BSECM_LEDGER set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from NRMS_BSECM_LEDGER  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where NRMS_BSECM_LEDGER.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update NRMS_BSECM_LEDGER set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NRMS_BSECM_LEDGER.cltcode=b.cltcode    
  /* B2B End */    
    
 -- truncate table NRMS_BSECM_LEDGER_BSEIPO        
 -- insert into NRMS_BSECM_LEDGER_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 -- select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 -- from NRMS_BSECM_LEDGER  with(nolock)        
 --where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
ELSE          
BEGIN          
          
 delete from NRMS_BSECM_LEDGER where Cltcode=@pcode          
          
 insert into NRMS_BSECM_LEDGER(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select Getdate(),CLTCODE,          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
 UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),          
 0,0          
 from account_ab.dbo.ledger a with (nolock)           
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process')            */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18   AND A.VNO=B.VNO     )
 /********************************************************************************/    
   /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/

 group by cltcode          
          
 exec Fetch_CliUnreco @pcode          
           
 update NRMS_BSECM_LEDGER set UNRecoCr=-b.UnRecoCr from           
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
 where NRMS_BSECM_LEDGER.cltcode=b.cltcode and NRMS_BSECM_LEDGER.Cltcode=@pcode          
          
 update NRMS_BSECM_LEDGER set OTherDr=b.Vbal from          
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NRMS_BSECM_LEDGER  with(nolock) where cltcode like '98%' and VBAL < 0) b          
 where NRMS_BSECM_LEDGER.cltcode=b.cltcode and NRMS_BSECM_LEDGER.Cltcode=@pcode          
    
 /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NRMS_BSECM_LEDGER set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account_ab.dbo.ledger  with(nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NRMS_BSECM_LEDGER.cltcode=b.cltcode    
 END     
 /* B2B End */    
    
        
 --delete from NRMS_BSECM_LEDGER_BSEIPO where Cltcode=@pcode          
 --insert into NRMS_BSECM_LEDGER_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
 --select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
 --from NRMS_BSECM_LEDGER  with(nolock)         
 --where substring(Cltcode,2,10)=@pcode        
           
END                             
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)
AS

--return 0

BEGIN

BEGIN
--exec  Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New 'CP5674','APR 1 2016','Mar 31 2017'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #teMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end),


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX 

FROM AngelBSECM.BSEDB_AB.DBO. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not in ('ar','ap') 
	--AND  MARKETRATE<>0

 




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO, SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end)  ,
 

Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 


RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate            
and  AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0



insert into #temp
SELECT
EXCHANGE='BSE' ,SETT_NO=CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT =convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,
SER_TAX = (CD_TotalSerTax)
--- END
FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND 
CD_SAUDA_DATE <= @@ToDate            




insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
and AuctionPart not in ('ar','ap') and BILLFLAG<>0

--AND MARKETRATE<>0



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),''), 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT =TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
and AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax) 
-- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate       
 AND 
CD_SAUDA_DATE <= @@ToDate             



update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
       
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'    





   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,Trade_Type,
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName=(case 
		                   when Trade_Type='Auction'   THEN   SCRIPName+'('+Trade_Type+')'
		                   when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' 
						   when Trade_Type='POBKG'   THEN   SCRIPName+'('+Trade_Type+')'
						    ELSE  SCRIPName end),
				
	   
	       Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
         
		  Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		 
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    --order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName
	  order by   CONVERT(date, TRD_DT, 103),--(case when SCRIP_CD='zzzzzzzzzzzz' THEN ltrim(rtrim(SCRIP_CD)) else  ltrim(rtrim(SCRIP_CD)) END),
	  replace (scrip_cd,' ',''),
	 (                     
	 
	                       case 
						   when Trade_Type='Auction'   THEN   'A'
						   when Trade_Type='Trading'    THEN  'B'
                           when Trade_Type='Delivery'   THEN   'C'
						   when Trade_Type='POBKG'   THEN 'D'
						   ELSE 'Z' end)
						   
 

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_archival
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_archival]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)
AS

--return 0
BEGIN

BEGIN
--exec  Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New 'CP5674','APR 1 2016','Mar 31 2017'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #teMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end),


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX 

FROM ANAND.BSEDB_AB.DBO. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not in ('ar','ap') 
	--AND  MARKETRATE<>0

 
union



SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end),


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX 

FROM [172.31.16.30].BSEDB_AB.dbo. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not in ('ar','ap') 
	--AND  MARKETRATE<>0




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO, SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end)  ,
 

Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 


RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate            
and  AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0



insert into #temp
SELECT
EXCHANGE='BSE' ,SETT_NO=CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT =convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,
SER_TAX = (CD_TotalSerTax)
--- END
FROM ANAND.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND 
CD_SAUDA_DATE <= @@ToDate            




insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
and AuctionPart not in ('ar','ap')
union



SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM  [172.31.16.30].MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
and AuctionPart not in ('ar','ap')

--AND MARKETRATE<>0



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),''), 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT =TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
and AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax) 
-- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate       
 AND 
CD_SAUDA_DATE <= @@ToDate             



update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
       
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'    





   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,Trade_Type,
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName=(case 
		                   when Trade_Type='Auction'   THEN   SCRIPName+'('+Trade_Type+')'
		                   when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' 
						   when Trade_Type='POBKG'   THEN   SCRIPName+'('+Trade_Type+')'
						    ELSE  SCRIPName end),
				
	   
	       Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
         
		  Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		 
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    --order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName
	  order by   CONVERT(date, TRD_DT, 103),--(case when SCRIP_CD='zzzzzzzzzzzz' THEN ltrim(rtrim(SCRIP_CD)) else  ltrim(rtrim(SCRIP_CD)) END),
	  replace (scrip_cd,' ',''),
	 (                     
	 
	                       case 
						   when Trade_Type='Auction'   THEN   'A'
						   when Trade_Type='Trading'    THEN  'B'
                           when Trade_Type='Delivery'   THEN   'C'
						   when Trade_Type='POBKG'   THEN 'D'
						   ELSE 'Z' end)
						   
 

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_bakFeb92018
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_bakFeb92018]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)
AS
BEGIN

BEGIN
--exec  Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New 'P46144','APR 1 2016','Mar 31 2017'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #teMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	--start BSE Exchange--
--select * into #temp 
--from (

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
when BILLFLAG in('4','5') then 'Delivery'  end) ,


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX 

FROM ANAND.BSEDB_AB.DBO. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	--  AuctionPart not in ('ar','ap') AND 
	MARKETRATE<>0

 --GROUP BY  PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
         
	--	  BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series

--) as c




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO, SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 


RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate            
--and  AuctionPart not in ('ar','ap')
AND MARKETRATE<>0

--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,  -- m.SCRIPName,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series


insert into #temp
SELECT
EXCHANGE='BSE' ,SETT_NO=CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT =convert(varchar(11), CD_SAUDA_DATE,103),
CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
Trade_Type='zzzzzzzzzzzz',
Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
FROM ANAND.BSEDB_AB.DBO.CHARGES_DETAIL with(NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND 
CD_SAUDA_DATE <= @@ToDate            

--GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES ,CD_SETT_TYPE


print 'hi'
--STOP BSE Exchange--
--start NSE Exchange--

insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
--and AuctionPart not in ('ar','ap')

AND MARKETRATE<>0

--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series   



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),''), 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT =TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
--and AuctionPart not in ('ar','ap')
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),SCRIP_CD,  
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series 




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
Trade_Type='zzzzzzzzzzzz',
Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with(NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate       
 AND 
CD_SAUDA_DATE <= @@ToDate             

-- GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES , CD_SETT_TYPE



 --STOP NSE Exchange--


update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
       
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'    





   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,Trade_Type,
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName=(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' ELSE  SCRIPName end),
           Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
         
		  Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		 
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 --select top 100 * from MIMANSA.angelcs.dbo.angelscrip where   scrip_cd='532978'

	--select * from ANAND1.MSAJAG.DBO.CLIENT_DETAILS where PARENTCODE='a100044'



END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_IPFT
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_IPFT]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)
AS

--return 0

BEGIN

BEGIN
--exec  [Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_IPFT]  'C145465','OCT 01 2024','OCT 01 2024'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #teMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,
IPFT numeric(36, 12) null

)
	

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end),


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX ,
IPFT=0

FROM AngelBSECM.BSEDB_AB.DBO. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not in ('ar','ap') 
	--AND  MARKETRATE<>0

 




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO, SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end)  ,
 

Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 


RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX,
IPFT=0
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate            
and  AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0



insert into #temp
SELECT
EXCHANGE='BSE' ,SETT_NO=CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT =convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,
SER_TAX = (CD_TotalSerTax),
IPFT=0
--- END
FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND 
CD_SAUDA_DATE <= @@ToDate            




insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(S.SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX ,IPFT_CHRG
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
Left outer join  
		(
		Select Sauda_date as SDATE,Party_code as cl_code,Order_no as ordno ,Trade_no as trdno,IPFT_CHRG  ,
		SCRIP_CD
		from ANGELNSECM.MSAJAG.DBO.TBL_ADDITIONAL_TAX_DATA  WITH(NOLOCK) 
		where Party_code=@partycode and  SAUDA_DATE >= @@FromDate AND SAUDA_DATE <= @@ToDate 
		)R  
        ON S.Party_code=R.cl_code and S.order_no=R.ordno and S.trade_no=R.trdno  
		and s.SCRIP_CD=R.SCRIP_CD    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
and AuctionPart not in ('ar','ap') and BILLFLAG<>0

--AND MARKETRATE<>0



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(S.SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),''), 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT =TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX ,IPFT_CHRG
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 
Left outer join  
		(
		Select Sauda_date as SDATE,Party_code as cl_code,Order_no as ordno ,Trade_no as trdno,IPFT_CHRG  ,
		SCRIP_CD
		from ANGELNSECM.MSAJAG.DBO.TBL_ADDITIONAL_TAX_DATA  WITH(NOLOCK) 
		where Party_code=@partycode and  SAUDA_DATE >= @@FromDate AND SAUDA_DATE <= @@ToDate 
		)R  
        ON S.Party_code=R.cl_code and S.order_no=R.ordno and S.trade_no=R.trdno  
		and s.SCRIP_CD=R.SCRIP_CD    
where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
and AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=(CD_TRDBUY_QTY),0,Sell_qty=(CD_TRDSELL_QTY),0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax),
IPFT_CHRG=0
-- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate       
 AND 
CD_SAUDA_DATE <= @@ToDate             



update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
       
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'    





   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,Trade_Type,
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName=(case 
		                   when Trade_Type='Auction'   THEN   SCRIPName+'('+Trade_Type+')'
		                   when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' 
						   when Trade_Type='POBKG'   THEN   SCRIPName+'('+Trade_Type+')'
						    ELSE  SCRIPName end),
				
	   
	       Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
         
		  Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		 
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   
		   ReportDate=convert(varchar(11),getdate(),109) ,
		   IPFT
	from #temp   A ,[mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    --order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName
	  order by   CONVERT(date, TRD_DT, 103),--(case when SCRIP_CD='zzzzzzzzzzzz' THEN ltrim(rtrim(SCRIP_CD)) else  ltrim(rtrim(SCRIP_CD)) END),
	  replace (scrip_cd,' ',''),
	 (                     
	 
	                       case 
						   when Trade_Type='Auction'   THEN   'A'
						   when Trade_Type='Trading'    THEN  'B'
                           when Trade_Type='Delivery'   THEN   'C'
						   when Trade_Type='POBKG'   THEN 'D'
						   ELSE 'Z' end)
						   
 

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_mg
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New_mg]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)
AS
BEGIN

BEGIN
--exec  Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_New 'P46144','APR 1 2016','Mar 31 2017'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #teMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO, SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end),


Buy_qty=isnull( (case when sell_buy=1 then Tradeqty end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY =BROKER_CHRG,SER_TAX = NSERTAX 

FROM ANAND.BSEDB_AB.DBO. HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not in ('ar','ap') 
	--AND  MARKETRATE<>0

 




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO, SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') AND Sett_type not in ('AD','AC')  then 'Delivery' ELSE 'Auction' end)  ,
 

Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull( (case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 


RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate            
and  AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0



insert into #temp
SELECT
EXCHANGE='BSE' ,SETT_NO=CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT =convert(varchar(11), CD_SAUDA_DATE,103),
CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
Trade_Type='zzzzzzzzzzzz',
Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
FROM ANAND.BSEDB_AB.DBO.CHARGES_DETAIL with(NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND 
CD_SAUDA_DATE <= @@ToDate            




insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),'') , 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT = TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE =TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     
and AuctionPart not in ('ar','ap')

--AND MARKETRATE<>0



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') AND Sett_type not in ('A','X')  then 'Delivery' ELSE 'Auction' end)  ,


Buy_qty=isnull((case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then TRADEQTY*MARKETRATE/TRADEQTY end),''),               
Sell_qty= isnull((case when sell_buy=2 then Tradeqty end),''), 

SellMarketRate=isnull((case when sell_buy=2 then TRADEQTY*MARKETRATE/TRADEQTY end),''), 

RATE = TRADEQTY*MARKETRATE/TRADEQTY,TRADE_AMOUNT = TRADEQTY*MARKETRATE,
BKG_UNIT =TRADEQTY*NBROKAPP/TRADEQTY,NET_RATE = TRADEQTY*N_NETRATE/TRADEQTY,
BROKERAGE = TRADEQTY*NBROKAPP,STT = INS_CHRG,TO_TAX = TURN_TAX,SEBI_TAX = SEBI_TAX,
STAMPDUTY = BROKER_CHRG,SER_TAX = NSERTAX 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
and AuctionPart not in ('ar','ap')
--AND MARKETRATE<>0




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
Trade_Type='zzzzzzzzzzzz',
Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with(NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate       
 AND 
CD_SAUDA_DATE <= @@ToDate             



update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
       
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'    





   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,
		  Trade_Type,
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName=(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' 
						   when Trade_Type='Auction'   THEN   SCRIPName+'('+Trade_Type+')'ELSE  SCRIPName end),
				
	   
	       Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
         
		  Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		 
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   CONVERT(date, TRD_DT, 103),(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName
	
	
	--Exchange, CONVERT(DATETIME, TRD_DT, 103) ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 

END




END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)


AS
--return 0

BEGIN
-- EXEC  PDF_CASHTRADESREPORT_DETAILSWITHLEVIES_BSE_NSE_SCRIPWISE_NEW 'P140864','JUN  1 2020','JUN  1 2020'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #TEMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	--start BSE Exchange--
--select * into #temp 
--from (

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO,SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
when BILLFLAG in('4','5') then 'Delivery'  end) ,
Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 
SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 
RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 

FROM AngelBSECM.BSEDB_AB.DBO.HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
	 AND MARKETRATE<>0

--GROUP BY  PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
         
		--  BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series

--) as c




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull( (case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 


RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE =(TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate    AND        
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,  -- m.SCRIPName,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series


insert into #temp
SELECT
EXCHANGE = 'BSE' ,SETT_NO = CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE = (CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
--END
FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND CD_SAUDA_DATE <= @@ToDate            
--GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES ,CD_SETT_TYPE

print 'hi'
--STOP BSE Exchange--
--start NSE Exchange--

insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 

RATE = (TRADEQTY*MARKETRATE)/(nullif(TRADEQTY,0)),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(nullif(TRADEQTY,0)),NET_RATE = (TRADEQTY*N_NETRATE)/(nullif(TRADEQTY,0)),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     AND
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/

AND MARKETRATE<>0 and BILLFLAG<>0


--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series   


--select * from #temp where Buy_qty=0

--return
insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''), 

RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
AND AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),SCRIP_CD,  
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series 




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---*************************** ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *******************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
 --- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate     AND CD_SAUDA_DATE <= @@ToDate             

 --GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES , CD_SETT_TYPE



 --STOP NSE Exchange--


update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
        
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'

   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO+'-'+SETT_TYPE)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,
		  Trade_Type=(case when Trade_Type='zzzzzzzzzzzz'    THEN   ''
                           when Trade_Type is null  THEN  'Auction' ELSE  Trade_Type end),
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName= SCRIPName,     --(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           --when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' ELSE  SCRIPName end),  
           scripOrderingName= (case when  SCRIPName='**Additional Brokerage**' then 'zzzzzzzzzzzzzz' else SCRIPName end),

           Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
          
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[Mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 --select top 100 * from MIMANSA.angelcs.dbo.angelscrip where   scrip_cd='532978'

	--select * from ANAND1.MSAJAG.DBO.CLIENT_DETAILS where PARENTCODE='a100044'



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_bkp19sep2022
-- --------------------------------------------------


create  PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_bkp19sep2022]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)


AS
--return 0

BEGIN
-- EXEC  PDF_CASHTRADESREPORT_DETAILSWITHLEVIES_BSE_NSE_SCRIPWISE_NEW 'P140864','JUN  1 2020','JUN  1 2020'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #TEMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	--start BSE Exchange--
--select * into #temp 
--from (

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO,SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
when BILLFLAG in('4','5') then 'Delivery'  end) ,
Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 
SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 
RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 

FROM ANAND.BSEDB_AB.DBO.HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
	 AND MARKETRATE<>0

--GROUP BY  PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
         
		--  BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series

--) as c




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull( (case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 


RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE =(TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate    AND        
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,  -- m.SCRIPName,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series


insert into #temp
SELECT
EXCHANGE = 'BSE' ,SETT_NO = CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE = (CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
--END
FROM ANAND.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND CD_SAUDA_DATE <= @@ToDate            
--GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES ,CD_SETT_TYPE


print 'hi'
--STOP BSE Exchange--
--start NSE Exchange--

insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 

RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     AND
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/

AND MARKETRATE<>0

--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series   



insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''), 

RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
AND AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),SCRIP_CD,  
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series 




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---*************************** ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *******************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
 --- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate     AND CD_SAUDA_DATE <= @@ToDate             

 --GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES , CD_SETT_TYPE



 --STOP NSE Exchange--


update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
        
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'

   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO+'-'+SETT_TYPE)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,
		  Trade_Type=(case when Trade_Type='zzzzzzzzzzzz'    THEN   ''
                           when Trade_Type is null  THEN  'Auction' ELSE  Trade_Type end),
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName= SCRIPName,     --(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           --when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' ELSE  SCRIPName end),  
           scripOrderingName= (case when  SCRIPName='**Additional Brokerage**' then 'zzzzzzzzzzzzzz' else SCRIPName end),

           Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
          
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[Mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 --select top 100 * from MIMANSA.angelcs.dbo.angelscrip where   scrip_cd='532978'

	--select * from ANAND1.MSAJAG.DBO.CLIENT_DETAILS where PARENTCODE='a100044'



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_IPFT
-- --------------------------------------------------




CREATE  PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_IPFT]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)


AS
--return 0

BEGIN
-- EXEC  [Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_IPFT]  'C145465','OCT 01 2024','OCT 01 2024'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #TEMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,
IPFT numeric(18, 4) null

)
	--start BSE Exchange--
--select * into #temp 
--from (

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO,SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
when BILLFLAG in('4','5') then 'Delivery'  end) ,
Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 
SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 
RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) ,IPFT=0

FROM AngelBSECM.BSEDB_AB.DBO.HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
	 AND MARKETRATE<>0

--GROUP BY  PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
         
		--  BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series

--) as c




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull( (case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 


RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE =(TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) ,IPFT=0
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate    AND        
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,  -- m.SCRIPName,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series


insert into #temp
SELECT
EXCHANGE = 'BSE' ,SETT_NO = CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE = (CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax),
IPFT=0
--END
FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND CD_SAUDA_DATE <= @@ToDate            
--GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES ,CD_SETT_TYPE

print 'hi'
--STOP BSE Exchange--
--start NSE Exchange--

insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(s.SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 

RATE = (TRADEQTY*MARKETRATE)/(nullif(TRADEQTY,0)),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(nullif(TRADEQTY,0)),NET_RATE = (TRADEQTY*N_NETRATE)/(nullif(TRADEQTY,0)),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) ,IPFT_CHRG
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
 Left outer join  
		(
		Select Sauda_date as SDATE,Party_code as cl_code,Order_no as ordno ,Trade_no as trdno,IPFT_CHRG  ,
		SCRIP_CD
		from ANGELNSECM.MSAJAG.DBO.TBL_ADDITIONAL_TAX_DATA  WITH(NOLOCK) 
		where Party_code=@partycode and  SAUDA_DATE >= @@FromDate AND SAUDA_DATE <= @@ToDate 
		)R  
        ON S.Party_code=R.cl_code and S.order_no=R.ordno and S.trade_no=R.trdno  
		and s.SCRIP_CD=R.SCRIP_CD       
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     AND
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/

AND MARKETRATE<>0 and BILLFLAG<>0


--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series   


--select * from #temp where Buy_qty=0

--return
insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(S.SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''), 

RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) ,IPFT_CHRG
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 
Left outer join  
		(
		Select Sauda_date as SDATE,Party_code as cl_code,Order_no as ordno ,Trade_no as trdno,IPFT_CHRG  ,
		SCRIP_CD
		from ANGELNSECM.MSAJAG.DBO.TBL_ADDITIONAL_TAX_DATA  WITH(NOLOCK) 
		where Party_code=@partycode and  SAUDA_DATE >= @@FromDate AND SAUDA_DATE <= @@ToDate 
		)R  
        ON S.Party_code=R.cl_code and S.order_no=R.ordno and S.trade_no=R.trdno  
		and s.SCRIP_CD=R.SCRIP_CD   
where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
AND AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),SCRIP_CD,  
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series 




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---*************************** ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *******************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
,IPFT_CHRG=0
 --- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate     AND CD_SAUDA_DATE <= @@ToDate             

 --GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES , CD_SETT_TYPE



 --STOP NSE Exchange--


update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
        
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'

   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO+'-'+SETT_TYPE)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,
		  Trade_Type=(case when Trade_Type='zzzzzzzzzzzz'    THEN   ''
                           when Trade_Type is null  THEN  'Auction' ELSE  Trade_Type end),
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName= SCRIPName,     --(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           --when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' ELSE  SCRIPName end),  
           scripOrderingName= (case when  SCRIPName='**Additional Brokerage**' then 'zzzzzzzzzzzzzz' else SCRIPName end),

           Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
          
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		   
		   ReportDate=convert(varchar(11),getdate(),109) ,IPFT
	from #temp   A ,[Mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 --select top 100 * from MIMANSA.angelcs.dbo.angelscrip where   scrip_cd='532978'

	--select * from ANAND1.MSAJAG.DBO.CLIENT_DETAILS where PARENTCODE='a100044'



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_uat
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[Pdf_CashTradesReport_Detailswithlevies_BSE_NSE_ScripWise_New_uat]
@partycode varchar(20),
@FromDate varchar(20),
@ToDate varchar(20)


AS
--return 0

BEGIN
-- EXEC  PDF_CASHTRADESREPORT_DETAILSWITHLEVIES_BSE_NSE_SCRIPWISE_NEW 'P140864','JUN  1 2020','JUN  1 2020'
 DECLARE 
        @@FromDate VARCHAR(50), 
		@@ToDate varchar(50)

		SET @@FromDate=left(ltrim(rtrim(Cast(@FromDate as datetime))),11) +' 00:00:000'
		SET @@ToDate=left(ltrim(rtrim(Cast(@ToDate as datetime))),11)+' 23:59:000'
  
		print  @@ToDate
		print  @@FromDate


		
CREATE TABLE  #TEMP
(
EXCHANGE  VARCHAR(25) NULL,
SETT_NO varchar(50) null,
SETT_TYPE varchar (50) null,
PARTY_CODE  VARCHAR(15) NULL,
TRD_DT  varchar(11) NULL,
SCRIP_CD VARCHAR(50) NULL,
Series varchar(30) null,
SCRIPName VARCHAR(100) NULL,
BILLFLAG int,
Trade_Type varchar(30),
Buy_qty numeric(36, 0) null ,
BuyMarketRate numeric(36, 12) null,
Sell_qty numeric(36, 0) null,
SellMarketRate numeric(36, 12) null,
RATE numeric(36, 12) null,
TRADE_AMOUNT numeric(36, 12) null,
BKG_UNIT numeric(36, 12) null,
NET_RATE numeric(36, 12) NULL ,
BROKERAGE numeric(36, 12) null,
STT numeric(36, 12) null,
TO_TAX numeric(36, 12) null,
SEBI_TAX numeric(36, 12) null,
STAMPDUTY numeric(36, 12) null,
SER_TAX numeric(36, 12) null,

)
	--start BSE Exchange--
--select * into #temp 
--from (

insert into #temp

SELECT  
EXCHANGE = 'BSE',SETT_NO=SETT_NO,SETT_TYPE,
PARTY_CODE,TRD_DT =convert (varchar(11),s.SAUDA_DATE ,103),
SCRIP_CD=cast(S.SCRIP_CD as varchar),s.Series, 
SCRIPName=cast('' as varchar(max)),
BILLFLAG,Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
when BILLFLAG in('4','5') then 'Delivery'  end) ,
Buy_qty=isnull( (case when sell_buy=1 then Tradeqty  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 
SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 
RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 

FROM ANAND.BSEDB_AB.DBO.HISTORY S WITH (NOLOCK) 
where   
      PARTY_CODE =@partycode AND 
	  SAUDA_DATE >= @@FromDate AND 
      SAUDA_DATE <= @@ToDate   AND
	 AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
	 AND MARKETRATE<>0

--GROUP BY  PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
         
		--  BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series

--) as c




insert into #temp

SELECT
EXCHANGE = 'BSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=S.SCRIP_CD,
s.Series,' ',BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	            when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull( (case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull( (case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull( (case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull( (case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 


RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE =(TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S WITH (NOLOCK) 

where  PARTY_CODE =@partycode     
AND SAUDA_DATE >= @@FromDate AND 
SAUDA_DATE <= @@ToDate    AND        
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,  -- m.SCRIPName,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series


insert into #temp
SELECT
EXCHANGE = 'BSE' ,SETT_NO = CD_SETT_NO,
CD_SETT_TYPE,CD_PARTY_CODE,
TRD_DT = convert(varchar(11), CD_SAUDA_DATE,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT = 0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---******************* ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *****************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BRKSCR' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BRKSCR' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE = (CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
--END
FROM ANAND.BSEDB_AB.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate        
AND CD_SAUDA_DATE <= @@ToDate            
--GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES ,CD_SETT_TYPE

print 'hi'
--STOP BSE Exchange--
--start NSE Exchange--

insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD)),
s.Series, ''    
,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=   isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),'') , 

RATE = (TRADEQTY*MARKETRATE)/(nullif(TRADEQTY,0)),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(nullif(TRADEQTY,0)),NET_RATE = (TRADEQTY*N_NETRATE)/(nullif(TRADEQTY,0)),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.HISTORY S WITH (NOLOCK) 
    
where      
 PARTY_CODE =@partycode    
AND SAUDA_DATE >=@@FromDate      
 AND 
SAUDA_DATE <=@@ToDate     AND
AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/

AND MARKETRATE<>0 and BILLFLAG<>0


--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),S.SCRIP_CD,
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series   


--select * from #temp where Buy_qty=0

--return
insert into #temp
SELECT EXCHANGE = 'NSE', SETT_NO=SETT_NO,SETT_TYPE ,
PARTY_CODE,TRD_DT= convert(varchar(11),SAUDA_DATE,103), SCRIP_CD=ltrim(rtrim(SCRIP_CD))
,s.Series,' ' 

,BILLFLAG,
Trade_Type=(case when BILLFLAG in('2','3') then 'Trading'
	             when BILLFLAG in('4','5') then 'Delivery'  end) ,

Buy_qty=isnull((case when sell_buy=1 then (Tradeqty)  end),''),
BuyMarketRate= isnull((case when sell_buy=1 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''),               
Sell_qty= isnull((case when sell_buy=2 then (Tradeqty) end),''), 

SellMarketRate=isnull((case when sell_buy=2 then (TRADEQTY*MARKETRATE)/(TRADEQTY) end),''), 

RATE = (TRADEQTY*MARKETRATE)/(TRADEQTY),TRADE_AMOUNT = (TRADEQTY*MARKETRATE),
BKG_UNIT = (TRADEQTY*NBROKAPP)/(TRADEQTY),NET_RATE = (TRADEQTY*N_NETRATE)/(TRADEQTY),
BROKERAGE = (TRADEQTY*NBROKAPP),STT = (INS_CHRG),TO_TAX = (TURN_TAX),SEBI_TAX = (SEBI_TAX),
STAMPDUTY = (BROKER_CHRG),SER_TAX = (NSERTAX) 
FROM ANAND1.MSAJAG.DBO.SETTLEMENT S WITH (NOLOCK) 

where 
 PARTY_CODE =@partycode   
AND SAUDA_DATE >=@@FromDate     
AND 
SAUDA_DATE <=@@ToDate      
AND AuctionPart not like'A%' /*Added By Dinesh Suggested By Dharmesh on Apr 23 2020*/
AND MARKETRATE<>0
--GROUP BY PARTY_CODE,CONVERT(VARCHAR(11),SAUDA_DATE,103),SCRIP_CD,  
--BILLFLAG,SELL_BUY ,TMark,SETT_NO,SETT_TYPE,s.Series 




insert into #temp 
SELECT EXCHANGE='NSE' ,SETT_NO=CD_SETT_NO,CD_SETT_TYPE ,
CD_PARTY_CODE,TRD_DT = convert(varchar(11), CD_SAUDA_DATE ,103),
--CD_SCRIP_CD='zzzzzzzzzzzz',CD_SERIES,SCRIPName='**Additional Brokerage**', BILLFLAG = 0 ,
--Trade_Type='zzzzzzzzzzzz',
--Buy_qty=CD_TRDBUY_QTY,0,Sell_qty=CD_TRDSELL_QTY,0,RATE = 0,TRADE_AMOUNT =0,
--BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=CD_TOTALBROKERAGE,STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = CD_DELBUYSERTAX
---*************************** ADDED BY DHARMESH MISTRY ON 20-DEC-2021 *******************----------
CD_SCRIP_CD = case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else CD_SCRIP_CD end,
CD_SERIES,SCRIPName = case when CD_SCRIP_CD = 'BROKERAGE' then '**Additional Brokerage**' else '' end, BILLFLAG = 9 ,
Trade_Type= case when CD_SCRIP_CD = 'BROKERAGE' then 'zzzzzzzzzzzz' else 'POBKG' end ,
Buy_qty=0,0,Sell_qty=0,0,RATE = 0,TRADE_AMOUNT = 0,
BKG_UNIT = 0 ,NET_RATE = 0,BROKERAGE=(CD_TOTALBROKERAGE),STT = 0,TO_TAX = 0,SEBI_TAX = 0,STAMPDUTY = 0,SER_TAX = (CD_TotalSerTax)
 --- END
FROM ANAND1.MSAJAG.DBO.CHARGES_DETAIL with (NOLOCK) WHERE CD_PARTY_CODE = @partycode  
AND CD_SAUDA_DATE >= @@FromDate     AND CD_SAUDA_DATE <= @@ToDate             

 --GROUP BY CD_PARTY_CODE,CONVERT(VARCHAR(11),cd_SAUDA_DATE,103),CD_SCRIP_CD,CD_SETT_NO,CD_SERIES , CD_SETT_TYPE



 --STOP NSE Exchange--


update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where   #temp.SCRIP_CD=m.SCRIP_CD and EXCHANGE='BSE' 
        
update #temp  set  SCRIPName=m.SCRIPName from #temp, [MIMANSA].angelcs.dbo.angelscrip m WITH (NOLOCK) 
where    #temp.SCRIP_CD=m.nsescrip_cd AND M.NseSeries='EQ' AND EXCHANGE='NSE'
        
update #temp  set  SCRIPName=SCRIP_CD 
          where isnull(SCRIPName,'')='' AND EXCHANGE='NSE'

   select 
          c.Long_Name,  
		  Address = c.L_Address1 + ', ' + c.L_Address2 + ', ' + c.L_Address3 + ', ' + c.L_City + ', ' + c.L_Zip + ' ' + c.L_State + ', ' + c.L_Nation,
		  c.Branch_Cd, 
          EXCHANGE=(CASE WHEN EXCHANGE='BSE' THEN 'BSECM'
		             WHEN EXCHANGE='NSE' THEN 'NSECM' END),
		  SETT_NO=ltrim(rtrim(SETT_NO+'-'+SETT_TYPE)),  --SETT_TYPE,
          a.PARTY_CODE,TRD_DT=TRD_DT,
		  Trade_Type=(case when Trade_Type='zzzzzzzzzzzz'    THEN   ''
                           when Trade_Type is null  THEN  'Auction' ELSE  Trade_Type end),
          SCRIP_CD = (case when SCRIP_CD='zzzzzzzzzzzz' THEN ' '
		               WHEN EXCHANGE='NSE'THEN SCRIP_CD+'-'+Series ELSE  SCRIP_CD END)

          ,SCRIPName= SCRIPName,     --(case when Trade_Type='Trading'    THEN   SCRIPName+'('+Trade_Type+')'
                           --when Trade_Type='Delivery'   THEN   SCRIPName+'('+Trade_Type+')' ELSE  SCRIPName end),  
           scripOrderingName= (case when  SCRIPName='**Additional Brokerage**' then 'zzzzzzzzzzzzzz' else SCRIPName end),

           Buy_qty,BuyMarketRate,Sell_qty,SellMarketRate,RATE,TRADE_AMOUNT
          ,BKG_UNIT,NET_RATE,BROKERAGE,STT,TO_TAX,SEBI_TAX,STAMPDUTY,SER_TAX ,BILLFLAG,
          
		  -- Period=upper(@FromDate +' To '+ @ToDate),
		   
		   Period= UPPER(convert(varchar(11),@FromDate,109)+' To '+convert(varchar(11),@ToDate,109)),

		   
		   ReportDate=convert(varchar(11),getdate(),109) 
	from #temp   A ,[Mimansa].Angelcs.dbo.Angelclient1 C with (nolock) 
	where A.Party_code =C.Party_code 
    order by   Exchange,convert(date,TRD_DT, 103)  ,(case when SCRIP_CD='zzzzzzzzzzzz' THEN SCRIP_CD END) , SCRIPName

 --select top 100 * from MIMANSA.angelcs.dbo.angelscrip where   scrip_cd='532978'

	--select * from ANAND1.MSAJAG.DBO.CLIENT_DETAILS where PARENTCODE='a100044'



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.price_rigging
-- --------------------------------------------------
CREATE procedure [dbo].[price_rigging](@pcode as varchar(11),@scode as varchar(10),@settno as varchar(11))      
as      
----201---AngelBSECM(BSE)      
declare @Order_No varchar(50),@cnt int     
set @cnt=1    
select marketrate as Rate,case when Sell_Buy ='1' then 'Buy' else 'Sell' end as [Sell/Buy],TradeQty,    
Order_No as [Order No],Trade_No as [Trade No],right(sauda_date,7) as Time,flag=space(2) into #file     
from bsedb_ab.dbo.history where partY_code=@pcode  and scrip_cd=@scode      
and sett_type in('d','C') and sett_no=@settno order by order_no      
insert into #file    
select  marketrate as Rate,case when Sell_Buy ='1' then 'Buy' else 'Sell' end as [Sell/Buy],TradeQty,    
Order_No  as [Order No],Trade_No as [Trade No],right(sauda_date,7) as Time,flag=space(2) from bsedb_ab.dbo.settlement     
where partY_code=@pcode  and scrip_cd=@scode      
and sett_type in('d','C') and sett_no=@settno order by order_no      
declare @val int,@abc varchar(20)    
set @val=1    
DECLARE error_cursor CURSOR FOR                                     
select [Order No] from #file order by  [Order No]    
    
OPEN error_cursor                                    
FETCH NEXT FROM error_cursor                                     
INTO @Order_No                    
WHILE @@FETCH_STATUS = 0                                    
BEGIN                        
if @val=1    
      begin     
      update #file set flag=@cnt where [Order No]=@Order_No    
      set @val=@val+1    
      set @abc=@Order_No    
      end    
else    
    begin    
 if (@abc<>@Order_No)                           
    begin    
----    
   if (@abc<>@Order_No and @cnt=4 )                           
     begin    
      set @abc=@Order_No    
      set @cnt=0    
      --update #file set flag=@cnt where [Order No]=@Order_No    
      end    
----    
     set @abc=@Order_No    
     set @cnt=@cnt+1    
      update #file set flag=@cnt where [Order No]=@Order_No    
   end    
else    
   begin    
   update #file set flag=@cnt where [Order No]=@Order_No    
------    
--if (@abc<>@Order_No and @cnt=4 )                           
--begin    
--    
--set @abc=@Order_No    
--set @cnt=1    
--update #file set flag=@cnt where [Order No]=@Order_No    
--end    
------    
end    
end    
--if ((@abc<>@Order_No)  and @cnt=4 )    
--if @cnt=4     
--    
--    set @cnt=0    
  FETCH NEXT FROM error_cursor                                     
  INTO @Order_No                 
END       
    
CLOSE error_cursor                                    
DEALLOCATE error_cursor                                    
    
select * from #file order by  [Order No]

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[SEBI_POdet](@Flag as varchar(10) = null)            
as            
            
Set nocount on                            
  
 select distinct party_code into #aa from [MIS].sccs.dbo.sccs_clientmaster with(nolock)  
          /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                                                                
          and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                                
          where sccs_settDate_last>=convert(varchar(11),getdate())                                                                                
          and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'              
          and exclude='N'   
            
if @Flag='Daily'  
Begin  
 insert into #aa  
 select  distinct party_code from [INTRANET].cms.dbo.sccs_clientmaster_provisional with(nolock) where  
 SCCS_SettDate_Last =  DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE)) and exclude='N'  
end  
  
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()   
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =  
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )           
  
  
  
/*Code added to handle Financial year end issue on 3rd April 2017*/  
/********************************************************************************/  
declare @ccsy datetime,@ccse datetime  
set @ccsy=@sdtcur  
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'  
  
--select @ccsy, @ccse  
  
  
select @sdtcur=sdtcur/*sdtnxt*/ from account_ab.dbo.parameter where ldtcur        =  
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )  
/********************************************************************************/  
      
  Truncate table SEBI_PO            
      
  insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
  select Getdate(),CLTCODE,            
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */          
  VBal=sum(case when drcr='D' then -VAMT  
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND   
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),  
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/  
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                  
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */  
  and CLTCODE in (select party_code from #aa)  
    /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
    
  /********Added on 03 Apr 2018*************/  
 -- and    
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')  
 /********************************************/  
  group by cltcode        
  
  /** adding for Unsetteled debit bill**/  
  Truncate table SEBI_PO_UnsetDr            
      
  insert into SEBI_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)            
  select Getdate(),CLTCODE,       
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),    
  UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                           
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate  and CLTCODE in (select party_code from #aa)  
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)  
  group by cltcode   
  /**/      
      
  exec Fetch_CliUnreco            
      
  update SEBI_PO set UNRecoCr=-b.UnRecoCr from             
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b            
  where SEBI_PO.cltcode=b.cltcode            
      
  update SEBI_PO set OTherDr=b.Vbal from            
  (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b            
  where SEBI_PO.cltcode=b.cltcode        
    
  select * into #FutureCharges from account_ab.dbo.ledger a with (nolock)               
 where VDT>@ToDate and VDT <= convert(varchar(11),getdate()+3)+' 23:59:59'   and drcr='d'  
  
  select cltcode,charges=SUM(case when drcr='D' then -vamt else vamt end) into #finalchrg from #FutureCharges group by cltcode  
          
 update SEBI_PO set VBal=VBal+charges from               
 (select cltcode,charges  from #finalchrg with (nolock) ) b              
 where SEBI_PO.cltcode=b.cltcode  
            
      
  /* Bill to Bill Client */      
  --select       
  --CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
  --into #b2B      
  --from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
  --and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')      
  --group by cltcode      
      
  --update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode      
  /* B2B End */      
      
  truncate table SEBI_PO_BSEIPO          
  insert into SEBI_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
  from SEBI_PO  with(nolock)          
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
                                  
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet_ForFinancialyear
-- --------------------------------------------------

create Procedure [dbo].[SEBI_POdet_ForFinancialyear](@pcode as varchar(10) = null)          
as          
          
Set nocount on                          

declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'           
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE() 
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )         



/*Code added to handle Financial year end issue on 3rd April 2017*/
/********************************************************************************/
declare @ccsy datetime,@ccse datetime
set @ccsy=@sdtcur
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'

--select @ccsy, @ccse


select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )
/********************************************************************************/

         
IF @Pcode is null          
BEGIN          
    
  Truncate table SEBI_PO          
    
  insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */        
  VBal=sum(case when drcr='D' then -VAMT
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND 
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */
    /*Added to exclude opening balance of current year*/
  /********************************************************************************/
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )
 /********************************************************************************/
  
  /********Added on 03 Apr 2018*************/
 -- and  
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')
 /********************************************/
  group by cltcode      

  /** adding for Unsetteled debit bill**/
  Truncate table SEBI_PO_UnsetDr          
    
  insert into SEBI_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)          
  select Getdate(),CLTCODE,          
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),           
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),  
  UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                         
  0,0          
  from account_ab.dbo.ledger a with (nolock)           
  where VDT>=@sdtcur and VDT <= @ToDate
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)
  group by cltcode 
  /**/    
    
  exec Fetch_CliUnreco          
    
  update SEBI_PO set UNRecoCr=-b.UnRecoCr from           
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b          
  where SEBI_PO.cltcode=b.cltcode          
    
  update SEBI_PO set OTherDr=b.Vbal from          
  (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b          
  where SEBI_PO.cltcode=b.cltcode          
    
  /* Bill to Bill Client */    
  select     
  CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
  into #b2B    
  from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
  and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')    
  group by cltcode    
    
  update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode    
  /* B2B End */    
    
  truncate table SEBI_PO_BSEIPO        
  insert into SEBI_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)        
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr         
  from SEBI_PO  with(nolock)        
 where cltcode like '6%' and ISNUMERIC(cltcode)=0        
         
END          
                       
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet_New
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SEBI_POdet_New](@Flag as varchar(10) = null)            
as            
            
Set nocount on                            
  
-- select distinct party_code into #aa from [MIS].sccs.dbo.sccs_clientmaster with(nolock)  
--          /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                                                                
--          and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                                
--          where sccs_settDate_last>=convert(varchar(11),getdate())                                                                                
--          and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'              
--          and exclude='N'   
            
--if @Flag='Daily'  
--Begin  
-- insert into #aa  
-- select  distinct party_code from [INTRANET].cms.dbo.sccs_clientmaster_provisional with(nolock) where  
-- SCCS_SettDate_Last =  DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE)) and exclude='N'  
--end  
  
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account_ab.dbo.parameter with(nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()   
--select @sdtcur=sdtcur from account_ab.dbo.parameter where ldtcur        =  
--(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )           
  
  
  
/*Code added to handle Financial year end issue on 3rd April 2017*/  
/********************************************************************************/  
declare @ccsy datetime,@ccse datetime  
set @ccsy=@sdtcur  
set @ccse=Convert(varchar(11),@sdtcur,121)+ ' 23:59:59'  
  
--select @ccsy, @ccse  
  
  
select @sdtcur=sdtcur/*sdtnxt*/ from account_ab.dbo.parameter where ldtcur        =  
(select ldtprv from account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()          )  
/********************************************************************************/  
      
  Truncate table SEBI_PO            
      
  insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
  select Getdate(),CLTCODE,            
 /* VBal=sum(case when drcr='D' then -VAMT else VAMT end),   */  /*Commented on 17 Apr 2021 */          
  VBal=sum(case when drcr='D' then -VAMT  
  when drcr='C' and ( CONVERT(datetime,cdt) not BETWEEN CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '00:00' AND   
 CONVERT(DATETIME, CONVERT(DATE, CURRENT_TIMESTAMP)) + '23:59' or VTYP not in (2,8)) then isnull(VAMT,0.00) end),  
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),*/  /*Commented on 11 Oct 2017 as per Bhumika's mail*/  
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                  
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate /*and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') */  
  --and CLTCODE in (select party_code from #aa)  
    /*Added to exclude opening balance of current year*/  
  /********************************************************************************/  
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO      )  
 /********************************************************************************/  
    
  /********Added on 03 Apr 2018*************/  
 -- and    
 --(VTYP<>'18' or  VDT<>'2018-04-01 00:00:00.000')  
 /********************************************/  
  group by cltcode        
  
  /** adding for Unsetteled debit bill**/  
  Truncate table SEBI_PO_UnsetDr            
      
  insert into SEBI_PO_UnsetDr(ProcessDateTime,Cltcode,VBal,UCV,UDebitV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
  VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
  UCV=sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),    
  UDebitV=sum(Case when edt > @Todate and Drcr='D' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),                           
  0,0            
  from account_ab.dbo.ledger a with (nolock)             
  where VDT>=@sdtcur and VDT <= @ToDate   
  --and CLTCODE in (select party_code from #aa)  
  and not exists (select cltcode,vdt,vtyp from account_ab.dbo.ledger b with (nolock)   where VDT between @ccsy and @ccse  
 and a.cltcode=b.cltcode and a.vtyp=b.vtyp and vtyp=18  AND A.VNO=B.VNO)  
  group by cltcode   
  /**/      
      
  exec Fetch_CliUnreco    
    
  /*added for unsetteledDrbills*/  
    select cltcode,sum(VAMT) as UnsettledDrBill into #drbills from Account_AB.dbo.ledger WITH(NOLOCK)    
  where cast(EDT as date)>cast(getdate() as date) and VTYP in ('79','15') and DRCR='D' group by cltcode  
  
  update  a set a.UnsettledDrBill=b.UnsettledDrBill from SEBI_PO a, (select cltcode,UnsettledDrBill from #drbills) b where a.Cltcode=b.CLTCODE  
  /****************************/  
      
  update SEBI_PO set UNRecoCr=-b.UnRecoCr from             
  (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno  with(nolock) group by cltcode) b            
  where SEBI_PO.cltcode=b.cltcode            
      
  update SEBI_PO set OTherDr=b.Vbal from            
  (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO  with(nolock) where cltcode like '98%' and VBAL < 0) b            
  where SEBI_PO.cltcode=b.cltcode        
    
  select * into #FutureCharges from account_ab.dbo.ledger a with (nolock)               
 where VDT>@ToDate and VDT <= convert(varchar(11),getdate()+3)+' 23:59:59'   and drcr='d'  
  
  select cltcode,charges=SUM(case when drcr='D' then -vamt else vamt end) into #finalchrg from #FutureCharges group by cltcode  
          
 update SEBI_PO set VBal=VBal+charges from               
 (select cltcode,charges  from #finalchrg with (nolock) ) b              
 where SEBI_PO.cltcode=b.cltcode  
            
      
  /* Bill to Bill Client */      
  --select       
  --CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
  --into #b2B      
  --from account_ab.dbo.ledger  with(nolock) where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
  --and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark  with(nolock) where payoutType='B')      
  --group by cltcode      
      
  --update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode      
  /* B2B End */      
      
  truncate table SEBI_PO_BSEIPO          
  insert into SEBI_PO_BSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
  select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
  from SEBI_PO  with(nolock)          
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
                                  
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Fund_Allocation
-- --------------------------------------------------
    
-- =============================================      
-- Author:  Neha Naiwar      
-- Create date: 19 Jan 2022      
-- Description: Fund Allocation      
-- Server : AngelBSECM      
-- Db    : Inhouse      
-- =============================================      
CREATE PROCEDURE [dbo].[SP_Fund_Allocation]       
AS      
BEGIN      
 /*Ledger Balance*/       
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from AngelBSECM.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()                   
          
  --select CLTCODE,                        
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0,       
  --UnRecoCr =0                   
  --INTO #BSECMcltop                                     
  --from AngelBSECM.account_ab.dbo.ledger a with (nolock)                         
  --where EDT>=@sdtcur and EDT <= @Todate --  and cltcode in (select party_code from #RepledgeCodes)        
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode       
        
        
Select CLTCODE,Sum(vamt) vbal INTO #BSECMcltop                                     
from (      
select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from AngelBSECM.account_ab.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
union all      
select sum(case when drcr ='d' then vamt  else vamt*-1 end) vamt,CLTCODE from AngelBSECM.account_ab.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
          
 --select CLTCODE,                      
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
 -- UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
 -- UnRecoCr=0                            
 -- into  #NSECMcltop                     
 -- from anand1.account.dbo.ledger a with (nolock)                             
 -- where EDT>=@sdtcur and EDT <= @Todate        
 -- and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
 -- group by cltcode            
        
        
Select CLTCODE,Sum(vamt) vbal INTO #NSECMcltop                                     
from (      
select sum(case when drcr ='d' then vamt*-1 else vamt  end) vamt,CLTCODE  from anand1.account.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
union all      
select sum(case when drcr ='d' then vamt else vamt*-1 end)vamt,CLTCODE from anand1.account.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end)   ,        
  --UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr =0                
  --into #NSEFOcltop                      
  --from angelfo.accountfo.dbo.ledger a with (nolock)                             
  --where EDT>=@sdtcur and  EDT <= @Todate         
  --  and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode                          
          
      
 Select CLTCODE,Sum(vamt) vbal INTO #NSEFOcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelfo.accountfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from  angelfo.accountfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
           
                 
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                   
  --into #NSXcltop                      
  --from angelfo.accountcurfo.dbo.ledger a with (nolock)                             
  --where EDT>=@sdtcur and  EDT <= @Todate           
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode               
            
       
 Select CLTCODE,Sum(vamt) vbal INTO #NSXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelfo.accountcurfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from  angelfo.accountcurfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                     
  --into #BSXcltop                      
  --from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                           
  --where EDT>=@sdtcur and  EDT <= @Todate                          
  --  and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode           
            
Select CLTCODE,Sum(vamt) vbal INTO #BSXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelcommodity.ACCOUNTcurbfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.ACCOUNTcurbfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
         
  --select CLTCODE,                
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                    
  --into #MCDcltop                      
  --from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock) order by vdt desc                           
  --where EDT>=@sdtcur and  EDT <= @Todate            
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode      
      
        
Select CLTCODE,Sum(vamt) vbal INTO #MCDcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
      
 --select CLTCODE,                          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
 -- UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
 -- UnRecoCr=0                         
 ------ into #MCDXcltop                          
 ----select *      
 --from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                                 
 -- where EDT>=@sdtcur and  EDT <= @Todate  and vdt<@sdtcur and vtyp=18  and  cltcode='A102352'-- order by EDT desc      
 -- --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
 -- group by cltcode       
      
        
Select CLTCODE,Sum(vamt) vbal INTO #MCDXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.accountmcdx.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
                            
  --select CLTCODE,                          
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                          
  --into #NCDXcltop                         
  --from angelcommodity.accountncdx.dbo.ledger a with (nolock)                                 
  --where EDT>=@sdtcur and  EDT <= @Todate           
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode       
        
        
Select CLTCODE,Sum(vamt) vbal INTO #NCDXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from angelcommodity.accountncdx.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) Vamt,CLTCODE from angelcommodity.accountncdx.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
        
  select  SUM(vbal)as vbal,cltcode,'Cash' as segment  into #Cash from      
  (      
   select SUM(vbal)as vbal,cltcode from #NSECMcltop  group by  cltcode                         
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #BSECMcltop   group by  cltcode            
  )x group by  cltcode         
        
  select  SUM(vbal)as vbal,cltcode,'CDS' as segment  into #Currency from      
  (      
   select SUM(vbal)as vbal,cltcode from #NSXcltop  group by  cltcode                         
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #MCDcltop   group by  cltcode            
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #BSXcltop   group by  cltcode            
  )x group by  cltcode           
      
 select * into #Bal from (                                                    
  select vbal,cltcode,segment from #Cash                               
  union all                                                    
  select vbal,cltcode,'NSEFO'segment from #NSEFOcltop        
  union all                                                          
  select vbal,cltcode,segment from #Currency         
  union all                                                                                        
  select vbal,cltcode,'MCX' segment from #MCDXcltop                                                    
  union all                                                    
  select vbal,cltcode,'NCDX' segment from #NCDXcltop                                       
  )x        
      
      
  select party_code as CLTCODE,vbal=case when SUM(Available_Cash_bal)>0 then SUM(Available_Cash_bal) else 0  end, /*SUM(Available_Cash_bal), */        
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/        
  UnRecoCr=0        
  into #MTFcltop           
  from   Anand1.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where sauda_date>=@sdtcur and sauda_date <= @Todate        
  group by party_code        
        
  --select a.cltcode,segment,a.vbal+b.vbal as TotalCash from #Bal a join #MTFcltop b on a.cltcode=b.CLTCODE and a.segment='Cash'      
      
  Update a  set a.vbal= a.vbal+b.vbal from #Bal a join #MTFcltop b on a.cltcode=b.CLTCODE and a.segment='Cash'       
        
/**Margin Pleadge***/      
        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from [AngelDemat].msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'        
group by bcltdpid,party_code,certno,sett_no        
union all        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from [AngelDemat].bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'        
group by bcltdpid,party_code,certno,sett_no        
        
select * into #client_col from  [CSOKYC-6].GENERAL.DBO.client_collaterals with(nolock)         
      
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [CSOKYC-6].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN         
       
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,        
CONVERT(MONEY, 0) as Var_margin,        
CONVERT(varchar(10), '') as series,        
CONVERT(MONEY, 0) as Value_BHC,        
CONVERT(MONEY, 0) as Value_AHC        
  into #marPledge from #MarginPleadge a left join        
 #Combine_Closing_File b with(nolock) on       
a.certno=b.security_isin        
        
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)        
        
        
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b        
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin         
         
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00        
        
        
update #marPledge set Value_BHC=qty*MTM_Price        
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)        
        
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code,'NSEFO' as segment into #marPledge_Final from #marPledge group by party_code        
      
/*Repleadge Codes*/      
select bcltdpid,party_code,certno,sum(qty) as QTY,convert(varchar(10),'Cash') as Segment into #RepledgeCodes from [AngelDemat].Msajag.dbo.DELTRANS_PLD with(nolock)      
where  drcr='d' and delivered ='0'      
and filler2='1' and BCLTDPID='1100001100020926'      
--and party_code ='GGKH1021'      
--and certno ='INE021A01026'      
group by bcltdpid,party_code,certno      
      
insert into #RepledgeCodes      
select bcltdpid,party_code,certno,sum(qty) as QTY,'NSEFO' as Segment  from [AngelDemat].Msajag.dbo.DELTRANS_PLD with(nolock)      
where  drcr='d' and delivered ='0'      
and filler2='1' and BCLTDPID='1601430000005208'      
group by bcltdpid,party_code,certno      
      
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,        
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00         
when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin        
,c.series,        
CONVERT(MONEY, 0) as Value_BHC,        
CONVERT(MONEY, 0) as Value_AHC,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol        
  into #RepledgeCodes_Value from #RepledgeCodes a left join        
 [CSOKYC-6].GENERAL.DBO.Combine_Closing_File  b with(nolock) on        
a.certno=b.security_isin left join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.certno=c.[isin no]        
        
        
update #RepledgeCodes_Value set Value_BHC=qty*MTM_Price        
update #RepledgeCodes_Value set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_margin,0)/100)        
        
select sum(Value_AHC) as Value_AHC,party_Code,Segment into #RepledgeCodes_final from #RepledgeCodes_Value  group by party_code,Segment        
      
/*CUSA Codes*/      
      
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #CUSA_code from [AngelDemat].msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320018512051'        
--and  sett_type not in ('H','T','F') /*Added on 29 Jun 2021 as per mail of ashok*/        
group by bcltdpid,party_code,certno,sett_no        
        
union all        
        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from [AngelDemat].bsedb.dbo.deltrans with (nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320018512051'        
---and  sett_type not in ('H','T') /*Added on 29 Jun 2021 as per mail of ashok*/        
group by bcltdpid,party_code,certno,sett_no        
      
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price_cusa,c.[Angel scrip category] as Angel_Scrip_cusa,        
/*case when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %] end as Var_margin_cusa*/        
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00         
         when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin_cusa        
,c.series,        
CONVERT(MONEY, 0) as Value_BHC_cusa,        
CONVERT(MONEY, 0) as Value_AHC_cusa,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol        
  into #CUSA_code_Main from #CUSA_code a left join        
/* [CSOKYC-6].GENERAL.DBO.Combine_Closing_File*/ #Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/        
a.certno=b.security_isin join [CSOKYC-6].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS  c with(nolock) on a.certno=c.[isin no]        
        
        
update #CUSA_code_Main set Value_BHC_cusa=qty*MTM_Price_cusa        
update #CUSA_code_Main set Value_AHC_cusa=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)        
        
select sum(Value_AHC_cusa) as Value_AHC_cusa,party_Code,'Cash' as Segment into #CUSA_code_final from #CUSA_code_Main  group by party_code        
      
select party_code,Value_AHC as TotalNoncash,segment into #totalNon from      
(      
--select party_code,Margin_pleadge_AHC,segment from #marPledge_Final      
--union all      
select party_code,Value_AHC,segment from #RepledgeCodes_final      
--union all      
--select party_code,Value_AHC_cusa,segment from #CUSA_code_final      
)x      
      
select party_code,segment,sum(TotalNoncash) TotalNoncash into #TotalNonCash from #totalNon group by party_code,segment      
      
select a.cltcode,a.segment,isnull(vbal,0.00)+isnull(TotalNoncash,0.00) as totalFund into  #TotalFunds from  #Bal a left join #TotalNonCash b on a.cltcode=b.party_code and a.segment=b.segment      
      
/*Margin Requierment*/      
      
 select [Client code],convert(money,[Var Margin])+convert(money,[MTM Loss])+convert(money,[Prev Var Margin]) as TotalOblication,'Cash' segment into #cashLD from [Cash_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Delivery Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'NSEFO' segment into #NSEFOLD  from [NSEFO_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #NSXLD from [NSX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #MCDLD from [MCD_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #BSXLD from [BSX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'MCX' segment into #MCXLD from [MCX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'NCDX' segment into #NCDXLD from [NCDX_LD]      
      
  select  SUM(TotalOblication)as TotalOblication,[Client code],segment  into #TotalObligationCurrency from      
  (      
   select SUM(TotalOblication)as TotalOblication,[Client code],segment from #NSXLD  group by  [Client code],segment                         
  union all                                                    
  select SUM(TotalOblication)as TotalOblication,[Client code],segment  from #MCDLD   group by  [Client code],segment           
  union all                                                    
  select SUM(TotalOblication)as TotalOblication,[Client code],segment  from #BSXLD   group by  [Client code], segment           
  )x group by  [Client code],segment           
      
 Select * into #toatlObligations from      
 (      
 select [Client code],segment,TotalOblication from #cashLD      
union All      
 select [Client code],segment,TotalOblication from #NSEFOLD      
 union All      
 select [Client code],segment,TotalOblication from #TotalObligationCurrency      
 union All      
 select [Client code],segment,TotalOblication from #MCXLD      
 union All      
 select [Client code],segment,TotalOblication from #NCDXLD      
 )x      
       
      
 select cltcode,a.segment,isnull(a.vbal,0.00) as TotalCash,isnull(b.TotalOblication,0.00) TotalOblication,      
 CONVERT(money,0.00) as CashShortage,CONVERT(money,0.00) as CashSurplus into #data from #bal a left join #toatlObligations b on a.cltcode=b.[Client code]       
 and a.segment=b.segment       
      
  update #data set  CashShortage=case when isnull(TotalCash,0.00)>0 then (case when isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5)<0 then  isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else isnull(TotalCash,0.00)-(isnull
    
(TotalOblication,0.00)*0.5) end      
        
 --select cltcode,a.segment,isnull(a.vbal,0.00) as TotalCash,isnull(b.TotalOblication,0.00) TotalOblication,      
 --CashShortage=case when isnull(vbal,0.00)>0 then (case when isnull(vbal,0.00)-(isnull(TotalOblication,0.00)*0.5)<0 then  isnull(vbal,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else isnull(vbal,0.00)+(isnull(TotalOblication,0.00)*0.5) end,CONVERT(money,0.00) as CashSurplus into #data from #bal a left join #toatlObligations b on a.cltcode=b.[Client code]       
 --and a.segment=b.segment       
       
 update #data set CashSurplus=case when isnull(TotalCash,0.00)>0 then (case when isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5)>=0 then  isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else 0 end      
      
      
 select cltcode,a.segment,isnull(a.TotalCash,0.00) as TotalCash,isnull(a.TotalOblication,0.00) TotalOblication,isnull(TotalNoncash,0.00) as TotalNoncash,isnull(CashShortage,0.00)CashShortage,isnull(CashSurplus,0.00) CashSurplus,      
 CONVERT(money,0.00) as NonCashShortage, CONVERT(money,0.00) as NonCashSurplus,      
 CashShortage as OrigninalCashShortage,cashsurplus as Origninalcashsurplus      
 into #dataWithNoncash from #data a left join #TotalNonCash b on a.cltcode=b.Party_Code       
 and a.segment=b.segment       
      
 /**For Cash Segment****/      
 select * into #cashSh from #dataWithNoncash where CashShortage<0 and segment='Cash'      
       
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #main112 from #dataWithNoncash where cltcode in (select distinct cltcode from #cashSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww from #dataWithNoncash where cltcode in (select cltcode from #main112) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into  #ee  from #cashSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #ee1  from #ww  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #eee from #ee a join #ee1 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumCshShort from #eee --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='Cash'      
      
update a set  a.cashsurplus =0 from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'Cash'      
      
      
 select a.cltcode into  #cltd  from #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'Cash' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='Cash' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #cltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'Cash' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #cltd) --order by a.cltcode      
      
      
 select a.cltcode into  #cltdcode  from #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'Cash' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='Cash' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #cltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'Cash' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #cltdcode)-- and a.cltcode='S527369'      
      
----#ww where TotalOblication>0 and totalcash<0      
--#ww where cltcode='P338252'      
--select top 300000 cltcode,segment,TotalCash,(TotalOblication*-1) as TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,ReplicaCashShortage as       
--OrignalCashShortage,Replicacashsurplus as OrignalCashSurplus      
--into #send from #ww where cltcode not in (select distinct cltcode from #holding)   order by cltcode      
--update #send set TotalOblication=TotalOblication*-1      
--select * from #send      
--#send where TotalOblication<0      
       
 --update a set cashsurplus=0 from #ww a join       
--(      
--select cltcode ,sum(CashShortage)CashShortage,sum(cashsurplus) as cashsurplus from #ww where cltcode in  (select cltcode from #cltd) group by cltcode      
--having sum(CashShortage)<sum(cashsurplus))x on a.cltcode=x.cltcode      
       
 select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 1   
    when segment='NSEFO' then 2        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holding                
from #ww  where cltcode in       
(select cltcode from #cltdcode)      
      
insert into #holding                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
   when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww  where   cltcode  in       
(select cltcode from #cltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hld --where party_code='A219410'      
from #holding --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hld a  where a.sqoffsseg=1      
--update a set a.CashShortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hld a  where a.sqoffsseg=1      
      
--D235596      
--#holdd where cltcode='SF29'      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hld e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holdd      
from hold_cte option  (maxrecursion 32767) ;      
       
 update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
      
select cltcode, maxsq= max(sqoffsseg) into #maxseq from #holdd group by cltcode      
      
update #holdd set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holdd F inner join #maxseq m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='T43922'      
)A  where #holdd.cltcode=A.cltcode and sqoffsseg=1      
      
      
      
--drop table #holdd      
--drop table #finalValue      
--drop table #finalCash      
--drop table #holdd      
----#dataWithNoncash where cltcode='SF29'      
      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holdd       
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 --  #holdd where cltcode='A19529'      
      
--#holdd where cltcode='L51146'      
--select * into #finalCash from #holdd where shortage>0  and  cltcode='L51146'      
      
--update a set  CashShortage =case when b.shortage=(a.cashshoratge*-1)=0 and   b.shortage from   #holdd  a join        
--(select cltcode,shortage from #finalCash) b on  a.cltcode=b.cltcode  where segment='Cash' and  a.cltcode='G128872'      
      
--update a set  CashSurplus =b.shortagereduction from   #holdd  a join        
--(select cltcode,shortagereduction,segment from #finalCash) b on  a.cltcode=b.cltcode and a.segment=b.segment where a.segment<>'Cash' and a.shortagereduction>0-- and a.cltcode='R221967'      
      
--select * into  #finalValue from #holdd where shortage>0 and shortagereduction=0  --and cltcode='I36075'      
      
-- update a set  CashShortage = case when a.CashShortage<=b.shortage then 0 when a.CashShortage>b.shortage then CashShortage+b.shortage else b.shortage end from #holdd  a join        
--(select cltcode,shortage,segment from #finalValue) b on  a.cltcode=b.cltcode  and a.segment=b.segment where  a.segment='Cash' and a.cltcode='SLUE1108'--   a.cltcode='G17022'      
--select * from #finalValue where cltcode='SLUE1108'      
--select * from #holdd where cltcode='G128872'      
      
      
--update a set  CashSurplus =case when a.CashSurplus<=b.shortage then 0 when a.CashShortage>b.shortage then CashShortage+b.shortage else b.shortage end from   #holdd  a join        
--(select cltcode,shortage,segment,shortagereduction from #finalValue  ) b on  a.cltcode=b.cltcode and a.segment=b.segment where a.segment<>'Cash' and a.cltcode='SLUE1108'      
      
--#holdd where CashShortage<0      
/***************************/      
      
 /**For NSEFO Segment****/      
 select * into #FoSh from #dataWithNoncash where CashShortage<0 and segment='NSEFO'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='BSX' then 3        
 when segment='MCD' then 4        
    when segment='NSX' then 5      
 when segment='MCX' then 6      
 when segment='NCDX' then 7 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainFO from #dataWithNoncash where cltcode in (select distinct cltcode from #FoSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into  #ww1 from #dataWithNoncash where cltcode in (select cltcode from #mainFO) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #Fo1  from #FoSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #FO2  from #ww1  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #FFf from #Fo1 a join #FO2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumFoShort from #FFf --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='NSEFO'      
      
update a set  a.cashsurplus =0 from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'NSEFO'      
      
      
 select a.cltcode into  #FOcltd  from #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NSEFO' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NSEFO' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #FOcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NSEFO' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #FOcltd) --order by a.cltcode      
      
      
 select a.cltcode into #FOcltdcode  from #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NSEFO' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NSEFO' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #FOcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NSEFO' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #FOcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 1        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingFO                
from #ww1  where cltcode in       
(select cltcode from #FOcltdcode)      
      
insert into #holdingFO                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 1       
   when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww1  where   cltcode  in       
(select cltcode from #FOcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldFO --where party_code='A219410'      
from #holdingFO --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldFO a  where a.sqoffsseg=1      
      
      
--;with hold_cte as (      
--select       
--id,denseid      
--,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
--replicaCashShortage,replicaCashSurplus,      
--shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
--shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldFO x       
--where  sqoffsseg=1 --  and cltcode='CCKL1005'      
--union all      
--select       
--id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
--,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,shortagereduction,      
--shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--from #hldFO e inner join (select cltcode,sqoffsseg,shortage from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
--)      
--select * into #holddFO      
--from hold_cte option  (maxrecursion 32767) ;      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldFO x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldFO e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddFO      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddFO set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqFO from #holddFO group by cltcode      
      
update #holddFO set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddFO F inner join #maxseqFO m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddFO.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww1 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddFO      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww1      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 /**For CDS Segment****/      
 select * into #CDSSh from #dataWithNoncash where CashShortage<0 and segment='CDS'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainCDS from #dataWithNoncash where cltcode in (select distinct cltcode from #CDSSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into  #ww2 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainCDS) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #CDS1  from #CDSSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #CDS2  from #ww2  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #CDSS from #CDS1 a join #CDS2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumCDXShort from #CDSS --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='CDS'      
      
update a set  a.cashsurplus =0 from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'CDS'      
      
      
 select a.cltcode into  #CDScltd  from #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'CDS' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='CDS' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #CDScltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'CDS' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #CDScltd) --order by a.cltcode      
      
      
 select a.cltcode into #CDScltdcode  from #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'CDS' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='CDS' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #CDScltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'CDS' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #CDScltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 1        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingCDS                
from #ww2  where cltcode in       
(select cltcode from #CDScltdcode)      
      
insert into #holdingCDS                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 1        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww2  where   cltcode  in       
(select cltcode from #CDScltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldCDS --where party_code='A219410'      
from #holdingCDS --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldCDS a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldCDS x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldCDS e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddCDS      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddCDS set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqCDS from #holddCDS group by cltcode      
      
update #holddCDS set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddCDS F inner join #maxseqCDS m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddCDS.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww2 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddCDS      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww2      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 /**For MCX Segment****/      
 select * into #MCXSh from #dataWithNoncash where CashShortage<0 and segment='MCX'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainMCX from #dataWithNoncash where cltcode in (select distinct cltcode from #MCXSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww3 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainMCX) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #mcx1  from #MCXSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #mcx2  from #ww3  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into  #MCX from #mcx1 a join #mcx2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumMCXShort from #MCX --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='MCX'      
      
update a set  a.cashsurplus =0 from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'MCX'      
      
      
 select a.cltcode into  #MCXcltd  from #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'MCX' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='MCX' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #MCXcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'MCX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #MCXcltd) --order by a.cltcode      
      
      
 select a.cltcode into #MCXcltdcode  from #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'MCX' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='MCX' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #MCXcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'MCX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #MCXcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 4        
 when segment='MCX' then 1      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingMCX                
from #ww3  where cltcode in       
(select cltcode from #MCXcltdcode)      
      
insert into #holdingMCX                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 4       
 when segment='MCX' then 1      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww3  where   cltcode  in       
(select cltcode from #MCXcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldMCX --where party_code='A219410'      
from #holdingMCX --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldMCX a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldMCX x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldMCX e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddMCX      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddMCX set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqMCX from #holddMCX group by cltcode      
      
update #holddMCX set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddMCX F inner join #maxseqMCX m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddMCX.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww3 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddMCX      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww3      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
      
 /**For NCDX Segment****/      
 select * into #NCDXSh from #dataWithNoncash where CashShortage<0 and segment='NCDX'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainNCDX from #dataWithNoncash where cltcode in (select distinct cltcode from #NCDXSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww4 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainNCDX) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #NCDX1  from #NCDXSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #NCDX2  from #ww4  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into  #NCDX from #NCDX1 a join #NCDX2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumNCDXShort from #NCDX --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='NCDX'      
      
update a set  a.cashsurplus =0 from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'NCDX'      
      
      
 select a.cltcode into  #NCDXcltd  from #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NCDX' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NCDX' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #NCDXcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NCDX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #NCDXcltd) --order by a.cltcode      
      
      
 select a.cltcode into #NCDXcltdcode  from #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NCDX' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NCDX' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #NCDXcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NCDX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #NCDXcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 4        
 when segment='MCX' then 5      
 when segment='NCDX' then 1 end Priority_seg,              
*                
into #holdingNCDX                
from #ww4  where cltcode in       
(select cltcode from #NCDXcltdcode)      
      
insert into #holdingNCDX                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 4       
 when segment='MCX' then 5      
 when segment='NCDX' then 1 end Priority_seg,              
* from #ww4  where   cltcode  in       
(select cltcode from #NCDXcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldNCDX --where party_code='A219410'      
from #holdingNCDX --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldNCDX a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldNCDX x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldNCDX e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddNCDX      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddNCDX set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqNCDX from #holddNCDX group by cltcode      
      
update #holddNCDX set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddNCDX F inner join #maxseqNCDX m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddNCDX.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww4 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddNCDX      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww4      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 update #dataWithNoncash set NonCashShortage=case when (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5)<0 then (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5) else 0 end      
      
 update #dataWithNoncash set NonCashSurplus=case when (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5)>=0 then (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5) else 0 end      
      
update #dataWithNoncash set TotalOblication=TotalOblication*-1      
      
      
declare @mdate as varchar(11),@dd as varchar(11)                
               
select @mdate=max(vdt)+1 from anand1.account.dbo.ledger WITH(NOLOCK)                
where vtyp=15 and vdt <=convert(varchar(11),getdate())                
and narration like 'SETTNO=_______NSECMNBill Posted'                  
               
select top 1 @mdate=start_date                
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)                
where co_code='BSECM' and sett_type='D'                
and start_Date >= @mdate                  
order by Start_date          
        
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num                
into #day3              
from [CSOKYC-6].general.dbo.BO_Sett_Mst WITH(NOLOCK)                
where co_code='BSECM'                
and sett_type='D'                
and start_Date <= @mdate         
      
 select @dd =convert(varchar(11),Start_date)     from  #day3 where Start_date< convert(varchar(11),getdate())        
print @dd      
      
SELECT CASH_WNCL+BG_WNCL+FD_WNCL As PropFund ,CASH_WNCL,BG_WNCL,FD_WNCL,party_code,PROCESS_DT,      
(case when exchange='MCX' and segment='FUTURES' then 'MCX'      
     when exchange='NCX' and segment='FUTURES' then 'NCDX'      
  when exchange='NSE' and segment='CAPITAL' then 'Cash'      
  when exchange='NSE' and segment='FUTURES' then 'NSEFO'      
  when exchange='NSX' and segment='FUTURES' then 'CDS' end) as Segment      
   into  #PropFund FROM [AngelNseCM].MSAJAG.DBO.CLIENT_COLLATERAL_REPORTING_DETAILS WITH (NOLOCK)      
WHERE PROCESS_DT =@dd      
AND ACCOUNT_TYPE = 'P'      
      
delete from #PropFund where Segment is null      
alter table #dataWithNoncash add PropFund money      
alter table #dataWithNoncash add AdjustedPropFund money      
alter table #dataWithNoncash add RevisedCashShortage money      
      
update a set PropFund=b.propfund from #dataWithNoncash a      
join #PropFund b on a.segment= b.Segment      
      
update #dataWithNoncash set AdjustedPropFund=case when PropFund>(CashShortage*-1) then PropFund+CashShortage      
              when PropFund<(CashShortage*-1) then 0 end where CashShortage<0      
      
update #dataWithNoncash set RevisedCashShortage=case when PropFund>(CashShortage*-1) then 0      
                                                     when PropFund<(CashShortage*-1) then CashShortage-PropFund end where CashShortage<0      
      
select cltcode,sum(totalcash)totalcash into #er1 from #dataWithNoncash group by cltcode having count(1)>1      
select * into #qw from #er1 where totalcash<>0      
      
select top 500000 cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,OrigninalCashShortage,      
Origninalcashsurplus,isnull(AdjustedPropFund,0.00)AdjustedPropFund,isnull(RevisedCashShortage,0.00)RevisedCashShortage,isnull(PropFund,0.00)PropFund      
 from  #dataWithNoncash where cltcode in (select cltcode from #qw)   order by cltcode      
 -- #dataWithNoncash where cltcode='A19529'      
 --#dataWithNoncash where  CashShortage<>0      
       
 --#dataWithNoncash where segment='MCX'       
      
       
      
--SELECT CASH_WNCL+BG_WNCL+FD_WNCL  FROM MSAJAG.DBO.CLIENT_COLLATERAL_REPORTING_DETAILS WITH (NOLOCK)      
--WHERE PROCESS_DT = 'FEB  2 2022'      
--AND ACCOUNT_TYPE = 'P'      
      
End      
      
--drop table #ww      
--drop table #ww1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_Fund_Allocation_17Mar2022
-- --------------------------------------------------
      
-- =============================================      
-- Author:  Neha Naiwar      
-- Create date: 19 Jan 2022      
-- Description: Fund Allocation      
-- Server : AngelBSECM      
-- Db    : Inhouse      
-- =============================================      
CREATE PROCEDURE [dbo].[SP_Fund_Allocation_17Mar2022]       
AS      
BEGIN      
 /*Ledger Balance*/       
declare @sdtcur as datetime,@Todate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from anand.account_ab.dbo.parameter where sdtcur <= GETDATE() and ldtcur >=GETDATE()                   
          
  --select CLTCODE,                        
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0,       
  --UnRecoCr =0                   
  --INTO #BSECMcltop                                     
  --from anand.account_ab.dbo.ledger a with (nolock)                         
  --where EDT>=@sdtcur and EDT <= @Todate --  and cltcode in (select party_code from #RepledgeCodes)        
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode       
        
        
Select CLTCODE,Sum(vamt) vbal INTO #BSECMcltop                                     
from (      
select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from anand.account_ab.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
union all      
select sum(case when drcr ='d' then vamt  else vamt*-1 end) vamt,CLTCODE from anand.account_ab.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
          
 --select CLTCODE,                      
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
 -- UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
 -- UnRecoCr=0                            
 -- into  #NSECMcltop                     
 -- from anand1.account.dbo.ledger a with (nolock)                             
 -- where EDT>=@sdtcur and EDT <= @Todate        
 -- and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
 -- group by cltcode            
        
        
Select CLTCODE,Sum(vamt) vbal INTO #NSECMcltop                                     
from (      
select sum(case when drcr ='d' then vamt*-1 else vamt  end) vamt,CLTCODE  from anand1.account.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
union all      
select sum(case when drcr ='d' then vamt else vamt*-1 end)vamt,CLTCODE from anand1.account.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end)   ,        
  --UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr =0                
  --into #NSEFOcltop                      
  --from angelfo.accountfo.dbo.ledger a with (nolock)                             
  --where EDT>=@sdtcur and  EDT <= @Todate         
  --  and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode                          
          
      
 Select CLTCODE,Sum(vamt) vbal INTO #NSEFOcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelfo.accountfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from  angelfo.accountfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
           
                 
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                   
  --into #NSXcltop                      
  --from angelfo.accountcurfo.dbo.ledger a with (nolock)                             
  --where EDT>=@sdtcur and  EDT <= @Todate           
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode               
            
       
 Select CLTCODE,Sum(vamt) vbal INTO #NSXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelfo.accountcurfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from  angelfo.accountcurfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
  --select CLTCODE,                      
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                     
  --into #BSXcltop                      
  --from angelcommodity.ACCOUNTcurbfo.dbo.ledger  a with (nolock)                           
  --where EDT>=@sdtcur and  EDT <= @Todate                          
  --  and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'      
  --group by cltcode           
            
Select CLTCODE,Sum(vamt) vbal INTO #BSXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelcommodity.ACCOUNTcurbfo.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.ACCOUNTcurbfo.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
         
  --select CLTCODE,                
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                    
  --into #MCDcltop                      
  --from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock) order by vdt desc                           
  --where EDT>=@sdtcur and  EDT <= @Todate            
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode      
      
        
Select CLTCODE,Sum(vamt) vbal INTO #MCDcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from  angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
      
 --select CLTCODE,                          
 -- VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
 -- UnsettledCrBill=0 ,/*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
 -- UnRecoCr=0                         
 ------ into #MCDXcltop                          
 ----select *      
 --from angelcommodity.accountmcdx.dbo.ledger a with (nolock)                                 
 -- where EDT>=@sdtcur and  EDT <= @Todate  and vdt<@sdtcur and vtyp=18  and  cltcode='A102352'-- order by EDT desc      
 -- --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
 -- group by cltcode       
      
        
Select CLTCODE,Sum(vamt) vbal INTO #MCDXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from angelcommodity.accountmcdx.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) vamt,CLTCODE from angelcommodity.accountmcdx.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
                            
  --select CLTCODE,                          
  --VBal=sum(case when drcr='D' then -VAMT else VAMT end) ,        
  --UnsettledCrBill=0, /*sum(Case when edt > @Todate and Drcr='C' and (VTYP<>35 and isnull(enteredby,'')<>'mtf process') then -Vamt else 0 end),*/        
  --UnRecoCr=0                          
  --into #NCDXcltop                         
  --from angelcommodity.accountncdx.dbo.ledger a with (nolock)                                 
  --where EDT>=@sdtcur and  EDT <= @Todate           
  --and  CLTCODE BETWEEN 'A' AND 'ZZZZ9999'        
  --group by cltcode       
        
        
Select CLTCODE,Sum(vamt) vbal INTO #NCDXcltop                                     
 from (      
 select sum(case when drcr ='d' then vamt*-1 else vamt end) vamt,CLTCODE  from angelcommodity.accountncdx.dbo.ledger a with (nolock)    where  edt >=@sdtcur and vdt <=@Todate group by CLTCODE      
 union all      
 select sum(case when drcr ='d' then vamt else vamt*-1 end) Vamt,CLTCODE from angelcommodity.accountncdx.dbo.ledger a with (nolock) where  edt >=@sdtcur and vdt <@sdtcur group by CLTCODE )a      
 where CLTCODE BETWEEN 'A' AND 'ZZZZ9999' group by CLTCODE      
            
        
  select  SUM(vbal)as vbal,cltcode,'Cash' as segment  into #Cash from      
  (      
   select SUM(vbal)as vbal,cltcode from #NSECMcltop  group by  cltcode                         
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #BSECMcltop   group by  cltcode            
  )x group by  cltcode         
        
  select  SUM(vbal)as vbal,cltcode,'CDS' as segment  into #Currency from      
  (      
   select SUM(vbal)as vbal,cltcode from #NSXcltop  group by  cltcode                         
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #MCDcltop   group by  cltcode            
  union all                                                    
  select SUM(vbal)as vbal,cltcode  from #BSXcltop   group by  cltcode            
  )x group by  cltcode           
      
 select * into #Bal from (                                                    
  select vbal,cltcode,segment from #Cash                               
  union all                                                    
  select vbal,cltcode,'NSEFO'segment from #NSEFOcltop        
  union all                                                          
  select vbal,cltcode,segment from #Currency         
  union all                                                                                        
  select vbal,cltcode,'MCX' segment from #MCDXcltop                                                    
  union all                                                    
  select vbal,cltcode,'NCDX' segment from #NCDXcltop                                       
  )x        
      
      
  select party_code as CLTCODE,vbal=case when SUM(Available_Cash_bal)>0 then SUM(Available_Cash_bal) else 0  end, /*SUM(Available_Cash_bal), */        
  UnsettledCrBill=0,/*sum(case when drcr='D' then -VAMT else VAMT end) ,*/        
  UnRecoCr=0        
  into #MTFcltop           
  from   Anand1.MTFTrade.dbo.MTF_Avilable_Cash with(nolock) where sauda_date>=@sdtcur and sauda_date <= @Todate        
  group by party_code        
        
  --select a.cltcode,segment,a.vbal+b.vbal as TotalCash from #Bal a join #MTFcltop b on a.cltcode=b.CLTCODE and a.segment='Cash'      
      
  Update a  set a.vbal= a.vbal+b.vbal from #Bal a join #MTFcltop b on a.cltcode=b.CLTCODE and a.segment='Cash'       
        
/**Margin Pleadge***/      
        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #MarginPleadge  from [AngelDemat].msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'        
group by bcltdpid,party_code,certno,sett_no        
union all        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from [AngelDemat].bsedb.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320030135814'        
group by bcltdpid,party_code,certno,sett_no        
      
select * into #client_col from  [196.1.115.182].GENERAL.DBO.client_collaterals with(nolock)         
      
select Security_Symbol,Security_ISIN,MAX(mtm_price) as mtm_price  into #Combine_Closing_File from [196.1.115.182].GENERAL.DBO.Combine_Closing_File with(nolock) group by Security_Symbol,Security_ISIN         
       
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,'' as Angel_Scrip,        
CONVERT(MONEY, 0) as Var_margin,        
CONVERT(varchar(10), '') as series,        
CONVERT(MONEY, 0) as Value_BHC,        
CONVERT(MONEY, 0) as Value_AHC        
  into #marPledge from #MarginPleadge a left join        
 #Combine_Closing_File b with(nolock) on       
a.certno=b.security_isin        
        
select party_code,scrip_cd,isin,cl_rate,haircut,series into #wre from #client_col where party_code in (select distinct party_code from #marPledge)        
        
        
update #marPledge set series=b.series,var_margin=case when b.[isin] like 'INF%' and b.haircut=100.00 then 15.00 else b.haircut end  from #wre b        
where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin         
         
update #marPledge set MTM_Price=b.cl_rate from #wre b where #marPledge.party_code=b.party_code and  #marPledge.certno=b.isin and #marPledge.MTM_Price=0.00        
        
        
update #marPledge set Value_BHC=qty*MTM_Price        
update #marPledge set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_Margin,0)/100)        
        
select SUM(Value_AHC) as Margin_pleadge_AHC,party_code,'NSEFO' as segment into #marPledge_Final from #marPledge group by party_code        
      
/*Repleadge Codes*/      
select bcltdpid,party_code,certno,sum(qty) as QTY,convert(varchar(10),'Cash') as Segment into #RepledgeCodes from [AngelDemat].Msajag.dbo.DELTRANS_PLD with(nolock)      
where  drcr='d' and delivered ='0'      
and filler2='1' and BCLTDPID='1100001100020926'      
--and party_code ='GGKH1021'      
--and certno ='INE021A01026'      
group by bcltdpid,party_code,certno      
      
insert into #RepledgeCodes      
select bcltdpid,party_code,certno,sum(qty) as QTY,'NSEFO' as Segment  from [AngelDemat].Msajag.dbo.DELTRANS_PLD with(nolock)      
where  drcr='d' and delivered ='0'      
and filler2='1' and BCLTDPID='1601430000005208'      
group by bcltdpid,party_code,certno      
      
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price,c.[Angel scrip category] as Angel_Scrip,        
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00         
when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin        
,c.series,        
CONVERT(MONEY, 0) as Value_BHC,        
CONVERT(MONEY, 0) as Value_AHC,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol        
  into #RepledgeCodes_Value from #RepledgeCodes a left join        
 [196.1.115.182].GENERAL.DBO.Combine_Closing_File  b with(nolock) on        
a.certno=b.security_isin left join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS c with(nolock) on a.certno=c.[isin no]        
        
        
update #RepledgeCodes_Value set Value_BHC=qty*MTM_Price        
update #RepledgeCodes_Value set Value_AHC=isnull(Value_BHC,0)-(isnull(Value_BHC,0)*isnull(Var_margin,0)/100)        
        
select sum(Value_AHC) as Value_AHC,party_Code,Segment into #RepledgeCodes_final from #RepledgeCodes_Value  group by party_code,Segment        
      
/*CUSA Codes*/      
      
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty into #CUSA_code from [AngelDemat].msajag.dbo.deltrans with(nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320018512051'        
--and  sett_type not in ('H','T','F') /*Added on 29 Jun 2021 as per mail of ashok*/       
group by bcltdpid,party_code,certno,sett_no        
        
union all        
        
select bcltdpid,party_code,certno,sett_no,sum(qty) as qty  from [AngelDemat].bsedb.dbo.deltrans with (nolock) where drcr='d' and delivered ='0' and filler2='1' and bcltdpid ='1203320018512051'        
---and  sett_type not in ('H','T') /*Added on 29 Jun 2021 as per mail of ashok*/        
group by bcltdpid,party_code,certno,sett_no        
      
select a.*,isnull(convert(money,MTM_Price),0.00) as MTM_Price_cusa,c.[Angel scrip category] as Angel_Scrip_cusa,        
/*case when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %] end as Var_margin_cusa*/        
case when c.[isin no] like 'INF%' and c.[angel_var %]=100.00 then 15.00         
         when c.[ANGEL_VAR %]<20.00 then 20.00 else c.[ANGEL_VAR %]   end  as Var_margin_cusa        
,c.series,        
CONVERT(MONEY, 0) as Value_BHC_cusa,        
CONVERT(MONEY, 0) as Value_AHC_cusa,[BSE code] as BSEcode,[NSE symbol] as NSEsymbol        
  into #CUSA_code_Main from #CUSA_code a left join        
/* [196.1.115.182].GENERAL.DBO.Combine_Closing_File*/ #Combine_Closing_File b with(nolock) on /*a.scrip =b.Security_Symbol and*/        
a.certno=b.security_isin join [196.1.115.182].GENERAL.DBO.TBL_NRMS_RESTRICTED_SCRIPS  c with(nolock) on a.certno=c.[isin no]        
        
        
update #CUSA_code_Main set Value_BHC_cusa=qty*MTM_Price_cusa        
update #CUSA_code_Main set Value_AHC_cusa=isnull(Value_BHC_cusa,0)-(isnull(Value_BHC_cusa,0)*isnull(Var_margin_cusa,0)/100)        
        
select sum(Value_AHC_cusa) as Value_AHC_cusa,party_Code,'Cash' as Segment into #CUSA_code_final from #CUSA_code_Main  group by party_code        
      
select party_code,Margin_pleadge_AHC as TotalNoncash,segment into #totalNon from      
(      
select party_code,Margin_pleadge_AHC,segment from #marPledge_Final      
union all      
select party_code,Value_AHC,segment from #RepledgeCodes_final      
union all      
select party_code,Value_AHC_cusa,segment from #CUSA_code_final      
)x      
      
select party_code,segment,sum(TotalNoncash) TotalNoncash into #TotalNonCash from #totalNon group by party_code,segment      
      
select a.cltcode,a.segment,isnull(vbal,0.00)+isnull(TotalNoncash,0.00) as totalFund into #TotalFunds from  #Bal a left join #TotalNonCash b on a.cltcode=b.party_code and a.segment=b.segment      
      
/*Margin Requierment*/      
      
 select [Client code],convert(money,[Var Margin])+convert(money,[MTM Loss])+convert(money,[Prev Var Margin]) as TotalOblication,'Cash' segment into #cashLD from [Cash_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Delivery Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'NSEFO' segment into #NSEFOLD  from [NSEFO_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #NSXLD from [NSX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #MCDLD from [MCD_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'CDS' segment into #BSXLD from [BSX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'MCX' segment into #MCXLD from [MCX_LD]      
 select [Client code],convert(money,[Span + Exp Margin])+convert(money,[Premium Value])+convert(money,[MTM Loss]) as TotalOblication,'NCDX' segment into #NCDXLD from [NCDX_LD]      
      
  select  SUM(TotalOblication)as TotalOblication,[Client code],segment  into #TotalObligationCurrency from      
  (      
   select SUM(TotalOblication)as TotalOblication,[Client code],segment from #NSXLD  group by  [Client code],segment                         
  union all                                                    
  select SUM(TotalOblication)as TotalOblication,[Client code],segment  from #MCDLD   group by  [Client code],segment           
  union all                                                    
  select SUM(TotalOblication)as TotalOblication,[Client code],segment  from #BSXLD   group by  [Client code], segment           
  )x group by  [Client code],segment           
      
 Select * into #toatlObligations from      
 (      
 select [Client code],segment,TotalOblication from #cashLD      
union All      
 select [Client code],segment,TotalOblication from #NSEFOLD      
 union All      
 select [Client code],segment,TotalOblication from #TotalObligationCurrency      
 union All      
 select [Client code],segment,TotalOblication from #MCXLD      
 union All      
 select [Client code],segment,TotalOblication from #NCDXLD      
 )x      
       
      
 select cltcode,a.segment,isnull(a.vbal,0.00) as TotalCash,isnull(b.TotalOblication,0.00) TotalOblication,      
 CONVERT(money,0.00) as CashShortage,CONVERT(money,0.00) as CashSurplus into #data from #bal a left join #toatlObligations b on a.cltcode=b.[Client code]       
 and a.segment=b.segment       
      
  update #data set  CashShortage=case when isnull(TotalCash,0.00)>0 then (case when isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5)<0 then  isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5) end      
        
 --select cltcode,a.segment,isnull(a.vbal,0.00) as TotalCash,isnull(b.TotalOblication,0.00) TotalOblication,      
 --CashShortage=case when isnull(vbal,0.00)>0 then (case when isnull(vbal,0.00)-(isnull(TotalOblication,0.00)*0.5)<0 then  isnull(vbal,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else isnull(vbal,0.00)+(isnull(TotalOblication,0.00)*0.5) end,CONVERT(money,0.00) as CashSurplus into #data from #bal a left join #toatlObligations b on a.cltcode=b.[Client code]       
 --and a.segment=b.segment       
       
 update #data set CashSurplus=case when isnull(TotalCash,0.00)>0 then (case when isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5)>=0 then  isnull(TotalCash,0.00)-(isnull(TotalOblication,0.00)*0.5) else 0 end) else 0 end      
      
      
 select cltcode,a.segment,isnull(a.TotalCash,0.00) as TotalCash,isnull(a.TotalOblication,0.00) TotalOblication,isnull(TotalNoncash,0.00) as TotalNoncash,isnull(CashShortage,0.00)CashShortage,isnull(CashSurplus,0.00) CashSurplus,      
 CONVERT(money,0.00) as NonCashShortage, CONVERT(money,0.00) as NonCashSurplus,      
 CashShortage as OrigninalCashShortage,cashsurplus as Origninalcashsurplus      
 into #dataWithNoncash from #data a left join #TotalNonCash b on a.cltcode=b.Party_Code       
 and a.segment=b.segment       
      
 /**For Cash Segment****/      
 select * into #cashSh from #dataWithNoncash where CashShortage<0 and segment='Cash'      
       
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #main112 from #dataWithNoncash where cltcode in (select distinct cltcode from #cashSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww from #dataWithNoncash where cltcode in (select cltcode from #main112) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into  #ee  from #cashSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #ee1  from #ww  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #eee from #ee a join #ee1 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumCshShort from #eee --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='Cash'      
      
update a set  a.cashsurplus =0 from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'Cash'      
      
      
 select a.cltcode into  #cltd  from #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'Cash' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='Cash' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #cltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'Cash' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #cltd) --order by a.cltcode      
      
      
 select a.cltcode into  #cltdcode  from #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'Cash' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='Cash' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #cltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCshShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'Cash' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #cltdcode)-- and a.cltcode='S527369'      
      
----#ww where TotalOblication>0 and totalcash<0      
--#ww where cltcode='P338252'      
--select top 300000 cltcode,segment,TotalCash,(TotalOblication*-1) as TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,ReplicaCashShortage as       
--OrignalCashShortage,Replicacashsurplus as OrignalCashSurplus      
--into #send from #ww where cltcode not in (select distinct cltcode from #holding)   order by cltcode      
--update #send set TotalOblication=TotalOblication*-1      
--select * from #send      
--#send where TotalOblication<0      
       
 --update a set cashsurplus=0 from #ww a join       
--(      
--select cltcode ,sum(CashShortage)CashShortage,sum(cashsurplus) as cashsurplus from #ww where cltcode in  (select cltcode from #cltd) group by cltcode      
--having sum(CashShortage)<sum(cashsurplus))x on a.cltcode=x.cltcode      
       
 select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holding                
from #ww  where cltcode in       
(select cltcode from #cltdcode)      
      
insert into #holding                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
   when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww  where   cltcode  in       
(select cltcode from #cltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hld --where party_code='A219410'      
from #holding --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hld a  where a.sqoffsseg=1      
--update a set a.CashShortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hld a  where a.sqoffsseg=1      
      
--D235596      
--#holdd where cltcode='SF29'      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hld x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hld e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holdd      
from hold_cte option  (maxrecursion 32767) ;      
       
 update #holdd set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
      
select cltcode, maxsq= max(sqoffsseg) into #maxseq from #holdd group by cltcode      
      
update #holdd set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holdd F inner join #maxseq m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='T43922'      
)A  where #holdd.cltcode=A.cltcode and sqoffsseg=1      
      
      
      
--drop table #holdd      
--drop table #finalValue      
--drop table #finalCash      
--drop table #holdd      
----#dataWithNoncash where cltcode='SF29'      
      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holdd       
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 --  #holdd where cltcode='A19529'      
      
--#holdd where cltcode='L51146'      
--select * into #finalCash from #holdd where shortage>0  and  cltcode='L51146'      
      
--update a set  CashShortage =case when b.shortage=(a.cashshoratge*-1)=0 and   b.shortage from   #holdd  a join        
--(select cltcode,shortage from #finalCash) b on  a.cltcode=b.cltcode  where segment='Cash' and  a.cltcode='G128872'      
      
--update a set  CashSurplus =b.shortagereduction from   #holdd  a join        
--(select cltcode,shortagereduction,segment from #finalCash) b on  a.cltcode=b.cltcode and a.segment=b.segment where a.segment<>'Cash' and a.shortagereduction>0-- and a.cltcode='R221967'      
      
--select * into  #finalValue from #holdd where shortage>0 and shortagereduction=0  --and cltcode='I36075'      
      
-- update a set  CashShortage = case when a.CashShortage<=b.shortage then 0 when a.CashShortage>b.shortage then CashShortage+b.shortage else b.shortage end from #holdd  a join        
--(select cltcode,shortage,segment from #finalValue) b on  a.cltcode=b.cltcode  and a.segment=b.segment where  a.segment='Cash' and a.cltcode='SLUE1108'--   a.cltcode='G17022'      
--select * from #finalValue where cltcode='SLUE1108'      
--select * from #holdd where cltcode='G128872'      
      
      
--update a set  CashSurplus =case when a.CashSurplus<=b.shortage then 0 when a.CashShortage>b.shortage then CashShortage+b.shortage else b.shortage end from   #holdd  a join        
--(select cltcode,shortage,segment,shortagereduction from #finalValue  ) b on  a.cltcode=b.cltcode and a.segment=b.segment where a.segment<>'Cash' and a.cltcode='SLUE1108'      
      
--#holdd where CashShortage<0      
/***************************/      
      
 /**For NSEFO Segment****/      
 select * into #FoSh from #dataWithNoncash where CashShortage<0 and segment='NSEFO'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='BSX' then 3        
 when segment='MCD' then 4        
    when segment='NSX' then 5      
 when segment='MCX' then 6      
 when segment='NCDX' then 7 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainFO from #dataWithNoncash where cltcode in (select distinct cltcode from #FoSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into  #ww1 from #dataWithNoncash where cltcode in (select cltcode from #mainFO) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #Fo1  from #FoSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #FO2  from #ww1  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #FFf from #Fo1 a join #FO2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumFoShort from #FFf --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='NSEFO'      
      
update a set  a.cashsurplus =0 from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'NSEFO'      
      
      
 select a.cltcode into  #FOcltd  from #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NSEFO' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NSEFO' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #FOcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NSEFO' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #FOcltd) --order by a.cltcode      
      
      
 select a.cltcode into #FOcltdcode  from #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NSEFO' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NSEFO' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #FOcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww1  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumFoShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NSEFO' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #FOcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 1        
    when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingFO                
from #ww1  where cltcode in       
(select cltcode from #FOcltdcode)      
      
insert into #holdingFO                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 1       
   when segment='CDS' then 3        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww1  where   cltcode  in       
(select cltcode from #FOcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldFO --where party_code='A219410'    
from #holdingFO --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldFO a  where a.sqoffsseg=1      
      
      
--;with hold_cte as (      
--select       
--id,denseid      
--,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
--replicaCashShortage,replicaCashSurplus,      
--shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
--shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldFO x       
--where  sqoffsseg=1 --  and cltcode='CCKL1005'      
--union all      
--select       
--id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
--,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,shortagereduction,      
--shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--from #hldFO e inner join (select cltcode,sqoffsseg,shortage from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
--)      
--select * into #holddFO      
--from hold_cte option  (maxrecursion 32767) ;      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldFO x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldFO e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddFO      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddFO set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqFO from #holddFO group by cltcode      
      
update #holddFO set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddFO F inner join #maxseqFO m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddFO.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww1 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddFO      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww1      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 /**For CDS Segment****/      
 select * into #CDSSh from #dataWithNoncash where CashShortage<0 and segment='CDS'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainCDS from #dataWithNoncash where cltcode in (select distinct cltcode from #CDSSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into  #ww2 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainCDS) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #CDS1  from #CDSSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #CDS2  from #ww2  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into #CDSS from #CDS1 a join #CDS2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumCDXShort from #CDSS --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='CDS'      
      
update a set  a.cashsurplus =0 from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'CDS'      
      
      
 select a.cltcode into  #CDScltd  from #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'CDS' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='CDS' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #CDScltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'CDS' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #CDScltd) --order by a.cltcode      
      
      
 select a.cltcode into #CDScltdcode  from #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'CDS' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='CDS' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #CDScltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww2  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'CDS' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #CDScltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 1        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingCDS                
from #ww2  where cltcode in       
(select cltcode from #CDScltdcode)      
      
insert into #holdingCDS                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 1        
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww2  where   cltcode  in       
(select cltcode from #CDScltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldCDS --where party_code='A219410'      
from #holdingCDS --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldCDS a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldCDS x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldCDS e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddCDS      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddCDS set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqCDS from #holddCDS group by cltcode      
      
update #holddCDS set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddCDS F inner join #maxseqCDS m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddCDS.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww2 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddCDS      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww2      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 /**For MCX Segment****/      
 select * into #MCXSh from #dataWithNoncash where CashShortage<0 and segment='MCX'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainMCX from #dataWithNoncash where cltcode in (select distinct cltcode from #MCXSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww3 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainMCX) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #mcx1  from #MCXSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #mcx2  from #ww3  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into  #MCX from #mcx1 a join #mcx2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumMCXShort from #MCX --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='MCX'      
      
update a set  a.cashsurplus =0 from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'MCX'      
      
      
 select a.cltcode into  #MCXcltd  from #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'MCX' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='MCX' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #MCXcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'MCX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #MCXcltd) --order by a.cltcode      
      
      
 select a.cltcode into #MCXcltdcode  from #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'MCX' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='MCX' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #MCXcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww3  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumMCXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'MCX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #MCXcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 4        
 when segment='MCX' then 1      
 when segment='NCDX' then 5 end Priority_seg,              
*                
into #holdingMCX                
from #ww3  where cltcode in       
(select cltcode from #MCXcltdcode)      
      
insert into #holdingMCX                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 4       
 when segment='MCX' then 1      
 when segment='NCDX' then 5 end Priority_seg,              
* from #ww3  where   cltcode  in       
(select cltcode from #MCXcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldMCX --where party_code='A219410'      
from #holdingMCX --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldMCX a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldMCX x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldMCX e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddMCX      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddMCX set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqMCX from #holddMCX group by cltcode      
      
update #holddMCX set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddMCX F inner join #maxseqMCX m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddMCX.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww3 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddMCX      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww3      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
      
 /**For NCDX Segment****/      
 select * into #NCDXSh from #dataWithNoncash where CashShortage<0 and segment='NCDX'      
      
select case when segment='Cash' then 1        
    when segment='NSEFO' then 2        
    when segment='CDS' then 3      
 when segment='MCX' then 4      
 when segment='NCDX' then 5 end Priority_segwise,CONVERT(money,0.00) as AllocationForCash,CONVERT(money,0.00)deductionFromCashSuplus, * into      
 #mainNCDX from #dataWithNoncash where cltcode in (select distinct cltcode from #NCDXSh) and cashsurplus>0   order by cltcode      
      
 select *,CashShortage as ReplicaCashShortage,cashsurplus as Replicacashsurplus into #ww4 from #dataWithNoncash where cltcode      
 in (select cltcode from #mainNCDX) order by cltcode      
      
select cltcode,convert(decimal(18,2),sum(CashShortage*-1)) as CashShortage into #NCDX1  from #NCDXSh  group by cltcode      
      
select cltcode, convert(decimal(18,2),sum(cashsurplus)) as cashsurplus into  #NCDX2  from #ww4  group by cltcode      
      
select a.cltcode,a.CashShortage,b.cashsurplus into  #NCDX from #NCDX1 a join #NCDX2 b on a.cltcode=b.cltcode-- where a.cltcode='A344235'      
      
Select * into #MinmumNCDXShort from #NCDX --where CashShortage<=cashsurplus  --where CashShortage=cashsurplus          
--Select * into  #MinmumCshShort1 from #ee where CashShortage=cashsurplus          
update a set  a.CashShortage =0 from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode   where segment='NCDX'      
      
update a set  a.cashsurplus =0 from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort where CashShortage=cashsurplus    ) b on  a.cltcode=b.cltcode  where segment<>'NCDX'      
      
      
 select a.cltcode into  #NCDXcltd  from #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NCDX' and a.cashsurplus>0        
group by a.cltcode      
having COUNT(1)>1      
      
      
update a set  a.CashShortage = 0   from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NCDX' and a.CashShortage<0  and       
a.cltcode not in      
(select cltcode from #NCDXcltd)       
       
 update a set  a.cashsurplus =   a.CashSurplus-b.CashShortage   from   #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage<cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NCDX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #NCDXcltd) --order by a.cltcode      
      
      
 select a.cltcode into #NCDXcltdcode  from #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode where segment<>'NCDX' and a.cashsurplus>0   group by a.cltcode      
having COUNT(1)>1      
      
update a set  a.CashShortage =   a.CashShortage+b.CashSurplus   from  #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment='NCDX' and a.CashShortage<0  and      
a.cltcode not in      
(select cltcode from #NCDXcltdcode) --and a.cltcode='S527369'      
      
      
update a set  a.CashSurplus = 0   from  #ww4  a join        
(select cltcode,CashShortage,cashsurplus from #MinmumNCDXShort  where CashShortage>cashsurplus ) b on  a.cltcode=b.cltcode   where segment<>'NCDX' and a.cashsurplus>0  and      
a.cltcode not in      
(select cltcode from #NCDXcltdcode)-- and a.cltcode='S527369'      
        
  select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2        
    when segment='NSEFO' then 3        
    when segment='CDS' then 4        
 when segment='MCX' then 5      
 when segment='NCDX' then 1 end Priority_seg,              
*                
into #holdingNCDX                
from #ww4  where cltcode in       
(select cltcode from #NCDXcltdcode)      
      
insert into #holdingNCDX                
select id=row_number() over(order by  segment )                
,denseid=dense_rank() over(order by cltcode)      
,case when segment='Cash' then 2       
    when segment='NSEFO' then 3       
   when segment='CDS' then 4       
 when segment='MCX' then 5      
 when segment='NCDX' then 1 end Priority_seg,              
* from #ww4  where   cltcode  in       
(select cltcode from #NCDXcltd ) order by cltcode      
      
      
select       
id,denseid,Priority_seg      
,sqoffsseg=row_number() over(partition by cltcode order by Priority_seg )                  
,cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus      
,adjamt=convert(money,0),actualsqoffqty=0,avgrate=convert(money,0),replicaCashShortage,replicaCashSurplus,      
shortagereduction=CashSurplus,shortage=convert(money,0)      
into  #hldNCDX --where party_code='A219410'      
from #holdingNCDX --where party_code='A219410'      
order by sqoffsseg      
      
update a set a.shortage=(case when a.CashShortage<0 then (a.CashShortage*-1) else a.CashShortage end)  from #hldNCDX a  where a.sqoffsseg=1      
      
;with hold_cte as (      
select       
id,denseid      
,Priority_seg,sqoffsseg,cltcode,segment,TotalCash,TotalOblication,TotalNoncash      
--,CashSurplus=case when CashShortage>CashSurplus then 0 when CashShortage<CashSurplus then CashSurplus-CashShortage end,      
--CashShortage=case when CashShortage<=CashSurplus  then 0 when  CashShortage>CashSurplus then  CashShortage-CashSurplus end      
,CashSurplus=case when (shortage-CashSurplus)<0 then shortage else CashSurplus end,CashShortage      
--CashShortage=case when  (CashShortage-CashSurplus)<0 then 0 else(CashShortage-CashSurplus) end      
,NonCashShortage,NonCashSurplus,adjamt,actualsqoffqty,avgrate,      
replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortage-shortagereduction)<0 then shortage else shortagereduction end,      
shortage=case when (shortage-shortagereduction)<0 then 0 else(shortage-shortagereduction) end from #hldNCDX x       
where  sqoffsseg=1 -- and cltcode='SF29'      
union all      
select       
id,denseid,Priority_seg,e.sqoffsseg,e.cltcode,segment,TotalCash,TotalOblication,TotalNoncash,      
--CashSurplus=case when ecte.CashShortage>e.CashSurplus then 0 when  ecte.CashShortage<e.CashSurplus then e.CashSurplus- ecte.CashShortage end,      
--CashShortage=case when ecte.CashShortage<=e.CashSurplus then 0 when ecte.CashShortage>e.CashSurplus then  ecte.CashShortage-e.CashSurplus end,      
CashSurplus=case when (e.CashSurplus-ecte.shortage)<0 then 0 else (e.CashSurplus-ecte.shortage) end,E.CashShortage,      
--CashShortage=case when  (ecte.CashShortage-e.CashSurplus)<0 then 0 else (ecte.CashShortage-e.CashSurplus) end,      
NonCashShortage,NonCashSurplus      
,adjamt,actualsqoffqty,avgrate,replicaCashShortage,replicaCashSurplus,      
shortagereduction=case when (shortagereduction-ecte.shortage)<0 then 0 else (shortagereduction-ecte.shortage) end,      
shortage=CASE when  (ecte.shortage-shortagereduction)<0 then 0 else (ecte.shortage-shortagereduction) end      
--=shortagereduction-ecte.shortage      
from #hldNCDX e inner join (select cltcode,sqoffsseg,shortage,CashShortage ,CashSurplus from  hold_cte) ecte on ecte.cltcode = e.cltcode and e.sqoffsseg=ecte.sqoffsseg+1       
--and ecte.shortage>0      
)      
select * into #holddNCDX      
from hold_cte option  (maxrecursion 32767) ;      
       
      
      
update #holddNCDX set shortagereduction=shortagereduction+shortage,shortage=0 where shortage<0       
select cltcode, maxsq= max(sqoffsseg) into #maxseqNCDX from #holddNCDX group by cltcode      
      
update #holddNCDX set  CashShortage=A.shortage from      
(      
select F.cltcode, F.shortage from  #holddNCDX F inner join #maxseqNCDX m on f.cltcode=m.cltcode and F.sqoffsseg=m.maxsq --where F.cltcode='M313261'      
)A  where #holddNCDX.cltcode=A.cltcode and sqoffsseg=1      
      
update b  set  CashShortage=case when A.cashshortage>0 then A.cashshortage*-1 else A.cashshortage end,cashsurplus=A.cashsurplus from #ww4 b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #holddNCDX      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment      
      
update b  set  CashShortage=A.cashshortage,cashsurplus=A.cashsurplus from #dataWithNoncash b join      
(      
select cltcode,segment,cashshortage,cashsurplus from #ww4      
)A  on b.cltcode=A.cltcode and  b.segment=A.segment       
      
 update #dataWithNoncash set NonCashShortage=case when (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5)<0 then (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5) else 0 end      
      
 update #dataWithNoncash set NonCashSurplus=case when (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5)>=0 then (isnull(TotalNoncash,0.00)+isnull(CashSurplus,0.00))-(isnull(TotalOblication,0.00)*0.5) else 0 end      
      
update #dataWithNoncash set TotalOblication=TotalOblication*-1      
      
      
declare @mdate as varchar(11),@dd as varchar(11)                
               
select @mdate=max(vdt)+1 from anand1.account.dbo.ledger WITH(NOLOCK)                
where vtyp=15 and vdt <=convert(varchar(11),getdate())                
and narration like 'SETTNO=_______NSECMNBill Posted'                  
               
select top 1 @mdate=start_date                
from [196.1.115.182].general.dbo.BO_Sett_Mst WITH(NOLOCK)                
where co_code='BSECM' and sett_type='D'                
and start_Date >= @mdate                  
order by Start_date          
        
select top 2 start_date,Row_number() Over(Order By start_Date desc) As Row_num                
into #day3              
from [196.1.115.182].general.dbo.BO_Sett_Mst WITH(NOLOCK)                
where co_code='BSECM'                
and sett_type='D'                
and start_Date <= @mdate         
      
 select @dd =convert(varchar(11),Start_date)     from  #day3 where Start_date< convert(varchar(11),getdate())        
print @dd      
      
SELECT CASH_WNCL+BG_WNCL+FD_WNCL As PropFund ,CASH_WNCL,BG_WNCL,FD_WNCL,party_code,PROCESS_DT,      
(case when exchange='MCX' and segment='FUTURES' then 'MCX'      
     when exchange='NCX' and segment='FUTURES' then 'NCDX'      
  when exchange='NSE' and segment='CAPITAL' then 'Cash'      
  when exchange='NSE' and segment='FUTURES' then 'NSEFO'      
  when exchange='NSX' and segment='FUTURES' then 'CDS' end) as Segment      
   into  #PropFund FROM [AngelNseCM].MSAJAG.DBO.CLIENT_COLLATERAL_REPORTING_DETAILS WITH (NOLOCK)      
WHERE PROCESS_DT =@dd      
AND ACCOUNT_TYPE = 'P'      
      
delete from #PropFund where Segment is null      
alter table #dataWithNoncash add PropFund money      
alter table #dataWithNoncash add AdjustedPropFund money      
alter table #dataWithNoncash add RevisedCashShortage money      
      
update a set PropFund=b.propfund from #dataWithNoncash a      
join #PropFund b on a.segment= b.Segment      
      
update #dataWithNoncash set AdjustedPropFund=case when PropFund>(CashShortage*-1) then PropFund+CashShortage      
              when PropFund<(CashShortage*-1) then 0 end where CashShortage<0      
      
update #dataWithNoncash set RevisedCashShortage=case when PropFund>(CashShortage*-1) then 0      
                                                     when PropFund<(CashShortage*-1) then CashShortage-PropFund end where CashShortage<0      
      
select cltcode,sum(totalcash)totalcash into #er1 from #dataWithNoncash group by cltcode having count(1)>1      
select * into #qw from #er1 where totalcash<>0      
      
select top 500000 cltcode,segment,TotalCash,TotalOblication,TotalNoncash,CashShortage,CashSurplus,NonCashShortage,NonCashSurplus,OrigninalCashShortage,      
Origninalcashsurplus,isnull(AdjustedPropFund,0.00)AdjustedPropFund,isnull(RevisedCashShortage,0.00)RevisedCashShortage,isnull(PropFund,0.00)PropFund      
 from  #dataWithNoncash where cltcode in (select cltcode from #qw)   order by cltcode      
 -- #dataWithNoncash where cltcode='A19529'      
 --#dataWithNoncash where  CashShortage<>0      
       
 --#dataWithNoncash where segment='MCX'       
      
       
      
--SELECT CASH_WNCL+BG_WNCL+FD_WNCL  FROM MSAJAG.DBO.CLIENT_COLLATERAL_REPORTING_DETAILS WITH (NOLOCK)      
--WHERE PROCESS_DT = 'FEB  2 2022'      
--AND ACCOUNT_TYPE = 'P'      
      
End      
      
--drop table #ww      
--drop table #ww1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_sendmail_Brokerage_plan
-- --------------------------------------------------
  
  
-- =============================================  
create PROCEDURE [dbo].[SP_sendmail_Brokerage_plan]  
AS  
BEGIN  
   
   
   
 --truncate table CP_Personsmail----------Used to delete old data for trigering Email  
    
  
 --insert into  CP_Personsmail  
 --select * from Persons    
 -----Used to Insert current date data after 9PM as per process   
  
  
    --select * from Persons
    
----------------------------------------------------------------------------------------  
---Variable Declaration for EMAIL  
DECLARE  
@Sub VARCHAR(500),  
--@MESS1 NVARCHAR(MAX),  
@MESS NVARCHAR(MAX)     
  
--DECLARE @MessBody NVARCHAR(MAX),@MESS1 NVARCHAR(MAX)  ,@Data NVARCHAR(MAX) ,@MESS NVARCHAR(MAX),@Count1 int     
--   select [name] 
--   into #CP_Personsmail1  
--   from  Persons  
   
   --drop  table #CP_Personsmail1
 ----Inserting data into temp table---  
   
 ----Creating the body/header for the tables in the Email--  
  
  
-- set @MESS1=''            
 --SET @MESS1=                                  
 -- '<Table border="1" >                                  
 -- <tr style="Background-color:#808080">                                                        
 --  <th> [name] </th>        
 --  </tr>'        
  
  
 --set @Count1=1   
  
 --declare @name as varchar=''   
 --declare @totctrOT1 int=0   
 --SELECT @totctrOT1=count(1) from #CP_Personsmail1      
 --set @Data=''     
  
 --WHILE @Count1 <= @totctrOT1    
 --BEGIN   
 -- SELECT @name=[name]  
 -- FROM #CP_Personsmail1      
 -- set @Data=@Data+  
 -- '<tr>                                
 --   <td> '+ CONVERT(VARCHAR,@name) +' </td>                                
 --  </tr>'  
 --      SET   @Count1=@Count1+1   
 -- END  
  
 --  drop table #CP_Personsmail1   
 --  SET @MESS1= @MESS1 + @Data +'</Table>'    
  
   SET @MESS='Dear user <br><Br>we are pleased to change your Brokerage plan to Angel iTrade Prime Plus  Rs. 20/- for Equity Delivery and Rs.20/- per executed order for Intraday, FO, Currency and Commodity. Statutory taxes as applicable.'+'<Br><Br>Regards,<Br><Br><b>Angle One</B>.'  
        
                              
  --Set @Sub='Square off T+7 Exemption  '  + @ACCESSCODE                                 
  Set @Sub='Brokerage plan -  '+ CONVERT(VARCHAR(11), GETDATE(), 23)                                
     
  
  DECLARE @TO VARCHAR(MAX),@CC VARCHAR(MAX),@BCC VARCHAR(MAX)  
      
    SET @MESS = @MESS  
 EXEC MSDB.DBO.SP_SEND_DBMAIL    
 @RECIPIENTS = 'Nitin.1Bhosale@angelbroking.com',  
 @COPY_RECIPIENTS = 'Nitin.1Bhosale@angelbroking.com',    
 @BLIND_COPY_RECIPIENTS = '',    
 @PROFILE_NAME = 'AngelBroking',    
 @BODY_FORMAT ='HTML',    
 @SUBJECT = @Sub ,    
 @BODY =@MESS  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPTestPrepaid
-- --------------------------------------------------
CREATE proc SPTestPrepaid                                 
( @fvdt as datetime,@tvdt as datetime, @code as varchar(10))                                       
                                      
as                                      
          
set nocount on                                               
                                 
select * into #t from account_ab.dbo.ledger  where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                                      
                          
                              
select drcr= case                               
when drcr = 'D' then 'C'                               
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                              
select convert(varchar(11),vdt,103) as [Date],VNO,cltcode,acname, segment='BSE',vamt,narration as [Narration],DRCR,vtyp  into #file1 from                              
(                              
select * from #t                            
union                             
select x.* from                              
(                              
select l.*                      
from account_ab.dbo.ledger l , #t t                       
where l.vtyp = t.vtyp and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '2%' and l.cltcode  like '5%')                     
              
) x              
inner join                              
(select * from #l1)y                              
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                              
) x where cltcode not like '27%'  and cltcode not like '26%' --and cltcode  like '5%'            
            
    
select * into #P from account_ab.dbo.ledger  where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt         
    
    
select l.vtyp,l.vno,l.acname,l.drcr,l.vamt,l.cltcode  into #prepaid1                   
from account_ab.dbo.ledger l , #p p                       
where l.vtyp = p.vtyp and l.vtyp <> '18' and l.vno = p.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' and l.cltcode not like '2%')    
    
    
select t.vdt,t.VTYP,t.vno,t.cltcode,t.acname,t.drcr,t.vamt,t.narration,p.cltcode,p.acname,p.drcr,p.vamt    
from #t t left join #prepaid1 p    
on t.vtyp=p.vtyp and t.vno=p.vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPX_DUMP_201BSEDB_AB_CLIENT4_MULTICLTID
-- --------------------------------------------------
-- =============================================
-- AUTHOR:		<SOFTWARE>
-- CREATE DATE: <JUN 22,2013>
-- DESCRIPTION:	<BACKUP CLIENT4 AND MULTICLTID DATA FROM 201/BSEDB_AB TO 201/INHOUSE DATABASE>
-- =============================================


CREATE PROC [dbo].[SPX_DUMP_201BSEDB_AB_CLIENT4_MULTICLTID]

AS

DECLARE @ROWSCLT4 BIGINT,@ROWSMULTICLT BIGINT

SET @ROWSCLT4=0
SET @ROWSMULTICLT=0
--DELETE 7 DAYS OLD RECORDS---

DELETE FROM CLIENT4_DUMP WHERE DATE<=GETDATE()-7

DELETE FROM MULTICLTID_DUMP WHERE DATE<=GETDATE()-7
------------------------------

--INSERT DATA-----------------

INSERT INTO CLIENT4_DUMP(Cl_code,Party_code,Instru,BankID,Cltdpid,Depository,DefDp,date)
SELECT Cl_code,	Party_code,	Instru,	BankID,	Cltdpid, Depository, DefDp,GETDATE() FROM BSEDB_AB.DBO.CLIENT4 WITH(NOLOCK)

SET @ROWSCLT4=@@ROWCOUNT 

INSERT INTO TBL_BACKUP_PROCESS_STATUS(ProcessName ,Status,RowsCount)
VALUES('201BSEDB_AB_CLIENT4_BK','SUCCESS',@ROWSCLT4)


INSERT INTO MULTICLTID_DUMP(Party_code, CltDpNo, DpId, Introducer, DpType, Def, date)
SELECT Party_code,	CltDpNo,	DpId,	Introducer,	DpType,	Def, GETDATE() FROM BSEDB_AB.DBO.MULTICLTID WITH(NOLOCK)

SET @ROWSMULTICLT=@@ROWCOUNT 

INSERT INTO TBL_BACKUP_PROCESS_STATUS(ProcessName ,Status,RowsCount)
VALUES('201BSEDB_AB_MULTICLTID_BK','SUCCESS',@ROWSMULTICLT)

-----------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AD_QueryBackendChange_User_Access
-- --------------------------------------------------
CREATE PROCEDURE USP_AD_QueryBackendChange_User_Access
(
  @UserId INT
)
AS
BEGIN
SELECT 0 QueryId ,'-- Select the Query Type -- ' AS Name     ---+''+ CONVERT(VARCHAR(4),ISNULL(A.PORT,''))
	 
UNION ALL

SELECT 
A.QueryId ,LTRIM(RTRIM(A.Name)) Name  --+''+ CONVERT(CHAR(40),ISNULL(A.PORT,'')) 
FROM tbl_AD_QueryChange_Mst A 
INNER JOIN tbl_AD_Backend_ChangeMst_User_Mapping B on A.QueryId= B.QueryId
INNER JOIN tbl_EmpDetails C on C.EmpId= B.EmpId
WHERE C.EmpId =@UserId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_angel_STREG
-- --------------------------------------------------
--sp_helptext usp_angel_STREG         
          
--sp_helptext usp_angel_STREG2              
              
--exec usp_angel_STREG2 '2009-03-01','2009-03-28'            
--exec usp_angel_STREG '2008-09-01','2008-09-30'               
CREATE proc [dbo].[usp_angel_STREG]                              
( @fvdt as datetime,@tvdt as datetime)                               
                              
as                              
set nocount on                            
                  
                  
--declare @fvdt as datetime,@tvdt as datetime                  
--set @fvdt = '2008-09-01'                  
--set @tvdt = '2008-09-01'         
--left(convert(varchar,vdt,121),11)  --convert(varchar(11),convert(datetime,vdt),103)             
                         
select * into #t from  account_ab.dbo.ledger  where  cltcode='400002' and left(convert(varchar,vdt,121),11)>=@fvdt and left(convert(varchar,vdt,121),11)<=@tvdt                              
                  
                      
select drcr= case                       
when drcr = 'D' then 'C'                       
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                      
                      
select left(vdt,11) as [Date],VNO,cltcode,acname, segment='ABL',vamt,space(10) as [Expense Code],space(100) as [Expense Code Name],space(20) as [Expense Amount], space(20) as [400002],space(20) as [410002],space(20) as [420002],space(20) as [Total],space 
 
(20) as [Rate],space(30) as [PAN No.],space(50) as [Service Tax No.],space(500) as [Address],narration as [Narration],DRCR,vtyp  into #file1 from                      
(                      
select * from #t                    
union                     
select x.* from                      
(                      
select l.*              
from  account_ab.dbo.ledger l , #t t               
where l.vtyp = t.vtyp and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and (l.cltcode not like '4%' or l.cltcode not like '5%')                       
) x      
inner join                      
(select * from #l1)y                      
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                      
) x where cltcode not like '26%'                      
                              
  update #file1 set vamt = 0 where vamt = ''                
update #file1 set [Expense Amount] = 0 where [Expense Amount] = ''                  
  update #file1 set [400002] = 0 where [400002] = ''                
update #file1 set [410002] = 0 where [410002] = ''               
update #file1 set [420002] = 0 where [420002] = ''         
        
--select * from #file1                  
                              
update #file1 set [Expense Code]=b.cltcode,[Expense Amount]=b.vamt from                              
(select cltcode,vno,vamt,vtyp from  account_ab.dbo.ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a        
 where a.vno=b.vno  and a.vtyp=b.vtyp           
        
update #file1 set [Expense Code Name]=b.acname from                              
(select cltcode,vno,vamt,acname from  account_ab.dbo.ledger  where cltcode like '5%' and vno in ( select vno from #t))b, #file1 a        
 where a.vno=b.vno           
                      
----------------    cltcode like '5%' and                          
update #file1 set [Service Tax No.]=v.st_no, [PAN No.]= v.pan_no, [Address]=v.add1+' '+v.add2+' '+v.add3+' '+v.city+' '+v.pin+' '+v.state  from                              
(select cltcode,vno from  account_ab.dbo.ledger  where  vno in ( select vno from #t))b, #file1 a, [172.19.2.98].account123.dbo.vendormaster v        
 where a.vno=b.vno and v.segment= 'BSECM' and convert(varchar,v.cltcode)=b.cltcode        
-----------------        
                              
update #file1 set [400002]=b.vamt from                              
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode ='400002' and vno in ( select vno from #t))b,#file1 a    where a.vno=b.vno                                
                              
                              
update #file1 set [410002]=b.vamt from                              
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode ='410002' and vno in ( select vno from #t))b,#file1 a                      
 where a.vno=b.vno                                
                              
                              
update #file1 set [420002]=b.vamt from                              
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno                
          
update #File1 set [Total] = convert(money,[400002])+convert(money,[410002])+convert(money,[420002])                              
            
update #File1 set [Rate] = case when convert(money,[Expense Amount]) <> 0 then convert(money,[Total])/convert(money,[Expense Amount])*100             
else 0 end --from                    
--(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode ='420002' and vno in ( select vno from #t))b,#file1 a        where a.vno=b.vno              
              
select * from #file1 where cltcode <> '400002'                  
                  
                  
                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_angel_STREG1
-- --------------------------------------------------
CREATE proc [dbo].[usp_angel_STREG1]                                                          
(@fvdt as datetime,@tvdt as datetime, @code as varchar(10))                 
as                                                          
                              
set nocount on     
 --usp_angel_STREG1 '2010-04-01','2010-04-30','400001'   
--drop table #t           
--drop table #l1
--drop table #file1
--drop table #temp
--drop table #xx   
--declare @fvdt as datetime,@tvdt as datetime, @code as varchar(10)                                                  
--set @fvdt='2010-04-01'  
--set @tvdt='2010-04-30'      
--set @code='400001'
                
declare @code1 as varchar(10), @code2 as varchar(10)                              
                
set @code1 = '4100' + right(@code, 2)                              
set @code2= '4200' + right(@code, 2)                                  
                                                     
-------- account_ab.dbo.ledger Copy                
select * into #t from  account_ab.dbo.ledger  where  cltcode=@code and left(convert(varchar,vdt,121),11)>=@fvdt and
 left(convert(varchar,vdt,121),11)<=@tvdt                                              
                                                  
select drcr= case                                                   
when drcr = 'D' then 'C'                                                   
when drcr = 'C' then 'D' end, vno,left(convert(varchar,vdt,121),11) vdt,vtyp into #l1 from #t                            
                
--declare  @code1 as varchar(10), @code2 as varchar(10)                              
set @code1 = '4100' + right(@code, 2)                              
set @code2= '4200' + right(@code, 2)                                  
                                                  
select convert(varchar(11),x.vdt,103) as [Date],x.VNO,cltcode,acname, segment='ABL',vamt,space(10) as [Expense Code],
space(100) as [Expense Code Name],space(20) as [Expense Amount], space(20) as [ST],space(20) as [EC],                  
space(20) as [SHEC],space(20) as [Total], space(100) as [Trade Name],space(20) as [Rate],space(30) as [PAN No.],
space(50) as [Service Tax No.],space(500) as [Address1],space(500) as [Address2],space(500) as [Address3],space(500) as [City],
space(500) as [Pin],space(500) as [State], narration as [Narration],x.DRCR,x.vtyp  into #file1 from                                                  
(
select * from #t                                                
union                                                 
select x.* from                                                  
(                                                  
select l.*                                          
from  account_ab.dbo.ledger l , #t t                                           
where l.vtyp = t.vtyp  and l.vtyp <> '18' and l.vno = t.vno and left(convert(varchar,l.vdt,121),11)>=@fvdt                   
and left(convert(varchar,l.vdt,121),11)<=@tvdt and isnumeric(l.cltcode) = 1 and                   
(l.cltcode not like '4%' or l.cltcode not like '5%')                                                 
) x                                  
inner join                                                  
(select * from #l1)y                                                  
on left(convert(varchar,x.vdt,121),11) = y.vdt and x.drcr = y.drcr and x.vno = y.vno                 
) x  where cltcode not like '26%'  
                                                          
update #file1 set vamt = 0 where vamt = ''                                            
update #file1 set [Expense Amount] = 0 where [Expense Amount] = ''                                              
update #file1 set [ST] = 0 where [ST] = ''                                            
update #file1 set [EC] = 0 where [EC] = ''                                           
update #file1 set [SHEC] = 0 where [SHEC] = ''                 
                                                          
update #file1 set [Expense Code]=b.cltcode,[Expense Amount]=b.vamt from                                                          
(select cltcode,vno,vamt,vtyp from  account_ab.dbo.ledger  where cltcode like '5%' and vno in (select vno from #t))b, #file1 a 
where a.vno=b.vno  and a.vtyp=b.vtyp                                       
----------------------------------------------------------------                
--select distinct x.vNo,x.cltcode,x.vamt,x.acname,x.vtyp into #temp2 from                
--(                
--select cltcode,Vno,vamt,acname,vtyp from  account_ab.dbo.ledger x (nolock) where cltcode like '5%' and exists                
--(select * from #t y where x.vno = y.vno)                
--)x                
--inner join                
--(select * from #file1)y                
--on x.vno = y.vno  and x.vtyp=y.vtyp                
--                  
--update #file1 set [Expense Code] = x.cltcode, [Expense Amount]=x.vamt                 
--from #file1 x,#temp2 y                 
--where x.Vno = y.Vno  and x.vtyp=y.vtyp                      
----------------------------------------------------------------                                    
update #file1 set [Expense Code Name]=b.acname from                     
(select cltcode,vno,vamt,acname,vtyp from  account_ab.dbo.ledger  where cltcode like '5%' and vno in ( select vno from #t))b,               
#file1 a                    
 where a.vno=b.vno  and a.vtyp=b.vtyp                          
-------------------------------------                
--select distinct x.vNo,x.cltcode,x.vamt,x.acname into #temp1 from                
--(                
--select cltcode,Vno,vamt,acname from  account_ab.dbo.ledger x (nolock) where cltcode like '5%' and exists                
--(select * from #t y where x.vno = y.vno)                
--)x                
--inner join                
--(select * from #file1)y                
--on x.vno = y.vno               
--                  
--update #file1 set [Expense Code Name] = x.acname from #file1 x,#temp1 y                 
--where x.Vno = y.Vno                
--                                                  
----------------cltcode like '5%' and                
                
select distinct x.vNo,x.cltcode,z.st_No,z.pan_No,                
Address1=z.add1, Address2=z.add2, Address3=z.add3, city=z.city, pin=z.pin, state=z.state,                
TradeName=case when z.Trade_Name is null then '' else z.Trade_Name end into #temp from                
(                
select cltcode,Vno from  account_ab.dbo.ledger x (nolock) where exists                
(select * from #t y where x.vno = y.vno)                
)x                
inner join                
(select * from #file1)y                
on x.vno = y.vno                
inner join                
(select * from Intranet.Angelvms.dbo.vendormaster  where segment = 'BSECM')z                
on x.cltcode = z.cltcode                 
                
select y.pan_no,y.st_No,          
y.Address1, y.Address2,y.Address3,y.city,y.pin,y.state,                
y.TradeName,x.cltcode,x.vno into #xx from                
(select * from #file1)x                
left outer join           
#temp y on x.Vno = y.Vno and x.cltcode = y.cltcode                
                
update #file1 set [Pan No.] = y.Pan_No,Address1 = y.Address1,Address2=y.Address2,          
Address3=y.Address3,City=y.City,Pin=y.Pin,State=y.state,[service Tax No.] = y.st_No,                
[trade Name] = y.tradename           
from #file1 x,#temp y          
where x.Vno = y.Vno and x.cltcode = y.cltcode                
                
-----------------                                                                              
update #file1 set [ST]=b.vamt from                                                          
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode =@code and vno in ( select vno from #t))b,#file1 a                     
where a.vno=b.vno                                                           
                                                          
update #file1 set [EC]=b.vamt from                                                       
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode =@code1 and vno in ( select vno from #t))b,#file1 a                              
where a.vno=b.vno                                                                                                      
                                                          
update #file1 set [SHEC]=b.vamt from                          
(select cltcode,vno,vamt from  account_ab.dbo.ledger  where cltcode =@code2 and vno in ( select vno from #t))b,#file1 a                          
where a.vno=b.vno                                            
                   
update #File1 set [Total] = convert(money,[ST])+convert(money,[EC])+convert(money,[SHEC])                
                                            
update #File1 set [Rate] = case                 
when convert(money,[Expense Amount]) <> 0 then                 
convert(money,[Total])/convert(money,[Expense Amount])*100 else 0 end                 
                                          
select * from #file1 where cltcode <> @code                                                
                                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_bse_reco1
-- --------------------------------------------------
CREATE PROCEDURE usp_bse_reco1                     
 as                       
set nocount on                       
set transaction isolation level read uncommitted             
            
/*RECO - check reconsiled suspense a/c with unrecosiled client ledger */          
          
select * into #bse_cr from ACCOUNT_AB.DBO.ledger (nolock) where vdt >=getdate()-60 and vtyp=2 and drcr='C' and  cltcode='5100000001'          
          
select * into #bse_dr from ACCOUNT_AB.DBO.ledger (nolock) where vdt >=getdate()-60 and vtyp=3 and drcr='D' and  cltcode='5100000001'          
          
select ddno,vno,lno,reldt into #chqnodr from ACCOUNT_AB.DBO.ledger1 (nolock) where vtyp=3 and vno >='200801010000'            
              
select ddno,vno,lno,reldt into #chqno from ACCOUNT_AB.DBO.ledger1 (nolock) where vtyp=2 and vno >='200801010000'                
          
select a.*,b.ddno,b.reldt into #bse1dr from #bse_dr a, #chqnodr b where a.vno=b.vno and a.lno=b.lno                
          
select a.*,b.ddno,b.reldt into #bse1 from #bse_cr a, #chqno b where a.vno=b.vno and a.lno=b.lno                
          
delete from #bse1 where cltcode+'|'+convert(varchar(25),ddno) in (select cltcode+'|'+convert(varchar(25),ddno)  from #bse1dr)            
          
delete from mis.bse.dbo.bse_reco1           
          
         
select  a.vtyp,a.vno,a.vdt,a.drcr,a.vamt,a.ddno,b.cltcode,b.ddno as ddno1,b.cramt,a.reldt ,a.edt, a.narration         
          
into #temp from          
          
(select *  from #bse1  where cltcode='5100000001'  and reldt <> 'Jan  1 1900') a,          
          
ACCOUNT_AB.DBO.angel_client_deposit_recno b where a.ddno=b.ddno and a.vamt=b.cramt          
    
insert into mis.bse.dbo.bse_reco1      
select  a.*,b.cltcode,b.acname from #temp a inner join ACCOUNT_AB.DBO.ledger b on a.vno=b.vno where b.drcr='d'and b.vtyp='2'           
          
----------------- check for unreconsiled suspense account          
          
--select * from #bse1  where cltcode='5100000001' and reldt ='Jan  1 1900'          
          
          
delete mis.bse.dbo.bse_noreco              
select vtyp,vno,edt,acname,drcr,vamt,balamt,cltcode,ddno,vdt,narration into #temp1 from #bse1  where cltcode='5100000001' and reldt ='Jan  1 1900'     
insert into  mis.bse.dbo.bse_noreco     
    
select a.*,b.cltcode,b.acname from #temp1 a inner join ACCOUNT_AB.DBO.ledger b on a.vno=b.vno where b.drcr='d' and b.vtyp='2'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Check_Login_Details
-- --------------------------------------------------
 CREATE PROCEDURE dbo.USP_Check_Login_Details
(
@UserName varchar(100),
@Pass     varchar(20),
@EmpName  varchar(100),
@Email    varchar(100),
@Dept     varchar(100)
)
AS

BEGIN
--DECLARE
--@UserName varchar(100),
--@Pass     varchar(20) ='',
--@EmpName  varchar(100),
--@Email    varchar(100),
--@Dept     varchar(100)

--SET @UserName ='nilesh.parmar'
--SET @Pass     ='Angel@1234'
--SET @EmpName  ='Nilesh Parmar'
--SET @Email    ='Nilesh.Parmar@angelbroking.com'
--SET @Dept     ='Updation'
 

 DECLARE @Flag  INT=0

--select * from tbl_EmpDetails
IF EXISTS (SELECT TOP 1 * FROM tbl_EmpDetails WITH(NOLOCK) WHERE UserName =@UserName )
BEGIN
select 1
  UPDATE A
  SET LastLoginDate = GETDATE() ,
      version = version +1
      FROM tbl_EmpDetails A 
  WHERE UserName =@UserName
  SELECT 1 AS FLAG 
  
END
ELSE 
BEGIN
DECLARE @EMPID INT
INSERT INTO tbl_EmpDetails 
(
   FullName
 , UserName
 , Dept
 , LastLoginDate
 , version ,
   EmpCode
)
SELECT
@EmpName,
--(CAST(@EmpName as varbinary(max)) FOR XML PATH(''), BINARY BASE64),
 @UserName,@Dept,getdate(),1  ,@UserName

 SET @EMPID = @@IDENTITY
 --Select @EMPID = MAX(EmpId)  FROm tbl_EmpDetails
  INSERT INTO tbl_Emp_Role_Mapping
  (EmpId ,RoleId)
  VALUES (@EMPID ,1)

 SELECT 1 AS FLAG

END 
 
-- Select 'Ahsan' Binary base64
--  SELECT CAST('Ahsan' as varbinary(max)) FOR XML PATH(''), BINARY BASE64  
--SELECT CAST( CAST( 'QWhzYW4=' as XML ).value('.','varbinary(max)') AS varchar(max) )


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DELPAYOUT_REPORT_DATA
-- --------------------------------------------------
CREATE PROCEDURE DBO.USP_DELPAYOUT_REPORT_DATA  
(  
  @SETT_NO VARCHAR(20)  = NULL  
)  
AS  
  
BEGIN  
  
--SELECT *  FROM   
--   [AngelDemat].[MSAJAG].dbo.DELPAYOUT_REPORT_DATA             
--ORDER BY POAID, DPTYPE, PARTY_CODE, SCRIP_CD  
  
IF OBJECT_ID('tempdb..#DELPAYOUT_REPORT_DATA_temp', 'U') IS NOT NULL  
DROP TABLE #DELPAYOUT_REPORT_DATA_temp  
SELECT * INTO #DELPAYOUT_REPORT_DATA_temp  FROM   
   [AngelDemat].[MSAJAG].dbo.DELPAYOUT_REPORT_DATA             
ORDER BY POAID, DPTYPE, PARTY_CODE, SCRIP_CD  
  
IF OBJECT_ID('tempdb..#COUNTTABLE', 'U') IS NOT NULL  
DROP TABLE #COUNTTABLE  
CREATE TABLE #COUNTTABLE   
(  
ID INT IDENTITY(1,1),  
TABCOUNT INT  
)  
  
DECLARE @INTCount INT   
SELECT @INTCount  = COUNT(*) FROM #DELPAYOUT_REPORT_DATA_temp  
--SELECT @INTCount   
DECLARE @MIN INT =9000  
WHILE (@MIN <@INTCount)  
BEGIN  
  
INSERT INTO #COUNTTABLE  
(  
  TABCOUNT  
)  
VALUES(@INTCount)  
SET @INTCount = @INTCount-@MIN  
    PRINT @INTCount  
END  
IF (@INTCount >0 AND @INTCount < @MIN)  
BEGIN  
  
INSERT INTO #COUNTTABLE  
(  
  TABCOUNT  
)  
VALUES(@INTCount)  
SET @INTCount =0  
END  
  
--- NEXT STATMENT    
DECLARE @MN INT =1  
DECLARE @MX INT  
SELECT @MX = MAX(ID) FROM #COUNTTABLE  
SELECT @MX DSTABLECount  
WHILE (@MN <=@MX)  
BEGIN  
  
 SELECT TOP 9000 A.* from #DELPAYOUT_REPORT_DATA_temp A   
 ;  
 WITH CTE AS  
 (  
   SELECT TOP 9000 *FROM #DELPAYOUT_REPORT_DATA_temp  
   
 )  
 DELETE FROM CTE    
 SET @MN = @MN +1  
END  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DP_M3_M4_Progress_Status
-- --------------------------------------------------
CREATE PROCEDURE dbo.USP_DP_M3_M4_Progress_Status  
(  
  
@UploadTypeId      INT,  
@UploadSubTypeId   INT,  
@Stage             INT,  
@FileName          VARCHAR(100)   = NULL,  
@FilePath          VARCHAR(100)   = NULL,  
@UploadedDate      SMALLDATETIME,  
@UserId            INT  
)  
AS  
  
BEGIN  
  
  IF (@Stage =1 )  
  BEGIN  
  
   INSERT INTO tbl_FileUploadMaker_Checker_Log  
    (  
     UploadeDate  ,UploadTypeId  ,UploadSubTypeId  
    ,MakerBy  ,MakerDateTime   ,TempTableName  
    ,FileName,FilePath,SourceServer , DPM3_M4_Progress  
    )  
    VALUES (@UploadedDate ,@UploadTypeId ,@UploadSubTypeId ,   
            @UserId  , GETDATE(),'tbl_DP_M3_Holding_Balance_tmp' ,  
            @FileName ,@FilePath ,'AngelDemat' , 'Initite Process' )  
            SELECT 1 CNT  
            --RETURN ;   
  END  
  
--SELECT   
-- CONVERT(DATE,UploadeDate) AS OnDate  
--,UploadTypeId  
--,UploadSubTypeId  
--,MakerBy  
--,MakerDateTime  
--,TempTableName  
--,RecordCount  
--,FileName  
--,FilePath  
--,SourceServer  
--,DPM3_M4_Progress  
--FROM dbo.tbl_FileUploadMaker_Checker_Log  
--     WHERE DPM3_M4_Progress IS NULL OR DPM3_M4_Progress =''  
  
END  
  
--Select * from tbl_FileUploadMst

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DP_M3M4_UploadTypeMSt
-- --------------------------------------------------
CREATE PROCEDURE DBO.USP_DP_M3M4_UploadTypeMSt
(
@UploadTypeId INT = 0,
@UserId INT
)
AS

BEGIN
 
--DECLARE 
--@UploadTypeId INT = 0,
--@UserId INT

--SET @UploadTypeId =3
--SET @UserId =1

 -- TAB 0
SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,'' UserName,'' Pass ,'' TempTable
UNION ALL
SELECT 
	A.UploadTypeId  ,
	A.UploadType,
	A.DB DBName,
	A.DBServer IpAdd,
	A.SampleFormat ,
	A.UserName ,
	A.Pass ,
	TempTable
FROM dbo.tbl_FileUploadMst A
INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
WHERE B.EmpId =@UserId AND ParentId_PK =0 AND A.UploadTypeId =2
GROUP BY
    A.UploadTypeId  ,
	A.UploadType,
	A.DB,
	A.DBServer,
	A.SampleFormat ,A.UserName , A.Pass ,TempTable

	--- TAB 1
SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,
       '' UserName,'' Pass ,'' TempTable
UNION ALL
	SELECT 
		A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,
		A.UserName ,
	    A.Pass ,	TempTable
	FROM dbo.tbl_FileUploadMst A
	--INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
	WHERE ParentId_PK =@UploadTypeId AND ParentId_PK <>0
	GROUP BY A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,A.UserName , A.Pass ,TempTable
--- TAB 2

SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,
       '' UserName,'' Pass ,'' TempTable
UNION ALL
	SELECT 
		A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,
		A.UserName ,
	    A.Pass ,	TempTable
	FROM dbo.tbl_FileUploadMst A
	--INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
	WHERE UploadTypeId =@UploadTypeId AND ParentId_PK <>0
	GROUP BY A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,A.UserName , A.Pass ,TempTable

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Emp_DBServer_Access
-- --------------------------------------------------

CREATE PROCEDURE USP_Emp_DBServer_Access
(
@UserId INT
)
AS
BEGIN
SELECT 0 DBServerId ,'-- Select the DB Server -- ' IPAdd     ---+''+ CONVERT(VARCHAR(4),ISNULL(A.PORT,''))
	 
UNION ALL

SELECT 
A.DBServerId ,LTRIM(RTRIM(A.IPAdd)) IPAdd  --+''+ CONVERT(CHAR(40),ISNULL(A.PORT,'')) 
FROM tbl_Server_DBServerAccess A 
INNER JOIN tbl_Emp_DBServer_Mapping B on A.DBServerId= B.DBServerId
INNER JOIN tbl_EmpDetails C on C.EmpId= B.EmpId
WHERE C.EmpId =@UserId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------

Create Procedure usp_findinJobs(@Str as varchar(500))  
as  
  
select b.name,  
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,  
date_created,date_modified,a.step_id,a.step_name,a.command  
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b  
where command like '%'+@Str+'%'  
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findInUSP
-- --------------------------------------------------
CREATE PROCEDURE usp_findInUSP          
@dbname varchar(500),        
@srcstr varchar(500)          
AS          
          
 set nocount on        
 set @srcstr  = '%' + @srcstr + '%'          
        
 declare @str as varchar(1000)        
 set @str=''        
 if @dbname <>''        
 Begin        
 set @dbname=@dbname+'.dbo.'        
 End        
 else        
 begin        
 set @dbname=db_name()+'.dbo.'        
 End        
 print @dbname        
        
 set @str='select distinct O.name,O.xtype from '+@dbname+'sysComments  C '         
 set @str=@str+' join '+@dbname+'sysObjects O on O.id = C.id '         
 set @str=@str+' where O.xtype in (''P'',''V'') and C.text like '''+@srcstr+''''          
 print @str        
  exec(@str)        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP_UD
-- --------------------------------------------------

CREATE PROCEDURE USP_FINDINUSP_UD                                   
@DBNAME VARCHAR(500),                                  
@SRCSTR VARCHAR(500)                                    
AS                                    
                                    
 SET NOCOUNT ON              
 --                                
 SET @SRCSTR  = '%' + @SRCSTR + '%'                                    
                                  
 DECLARE @STR AS VARCHAR(1000)                                  
 SET @STR=''                                  
 IF @DBNAME <>''                                  
 BEGIN                                  
 SET @DBNAME=@DBNAME+'.DBO.'                                  
 END                                  
 ELSE                                  
 BEGIN                                  
 SET @DBNAME=DB_NAME()+'.DBO.'                                  
 END                                  
-- PRINT @DBNAME                                  
                               
 SET @STR=' INSERT INTO BO_OBJECT '                      
 SET @STR=@STR+' SELECT DISTINCT O.NAME,O.XTYPE,'''+@DBNAME+''',SUBSTRING('''+@SRCSTR+''',2,100) FROM '+@DBNAME+'SYSCOMMENTS  C '                                   
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                                   
 SET @STR=@STR+' WHERE O.XTYPE  IN(''P'',''V'') AND (C.TEXT LIKE ''%insert%'' or C.TEXT LIKE ''%update%'' or  C.TEXT LIKE ''%delete%'') '                        
 SET @STR=@STR+' AND REPLACE(C.TEXT,'' '','''') LIKE '''+@SRCSTR+''''                                    
                      
--PRINT @STR                                  
EXEC(@STR)                                  
SELECT * FROM  BO_OBJECT              
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_General_Application_Log
-- --------------------------------------------------

 CREATE PROCEDURE dbo.USP_General_Application_Log
 (
  @LoginId   VARCHAR(30),
  @Task      VARCHAR(100),
  @Page      VARCHAR(100),
  @Action    VARCHAR(500), 
  @Error     VARCHAR(500)
 )
 AS

 BEGIN 

 INSERT INTO tbl_General_Application_Log
 (LoginId,Task,Page,Action,Error )
  VALUES(@LoginId ,@Task  ,@Page ,@Action ,@Error )  
  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GET_AD_QueryChange_Details
-- --------------------------------------------------

CREATE PROCEDURE USP_GET_AD_QueryChange_Details
	(
		@QueryId INT
	)
	AS
BEGIN

  SELECT 0 QueryId ,'-- Select the Query Type -- ' Name , 
  '' TempTable ,'' FileType , '' SampleFile 
    UNION ALL
  SELECT 
  A.QueryId ,LTRIM(RTRIM(A.Name))  Name  ,
  TempTable  , FileType ,  SampleFile 
  FROM tbl_AD_QueryChange_Mst A 
  WHERE A.QueryId =@QueryId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GET_DBServer_Details
-- --------------------------------------------------

CREATE PROCEDURE USP_GET_DBServer_Details
	(
		@DBServerId INT
	)
	AS
BEGIN

SELECT 0 DBServerId ,'-- Select the DB Server -- ' IPAdd  ,   ---+''+ CONVERT(VARCHAR(4),ISNULL(A.PORT,''))
	'' DBUserName,''DBPass ,'master' DefaultDB
	UNION ALL
SELECT 
	A.DBServerId ,LTRIM(RTRIM(A.IPAdd))  IPAdd  ,   ---+''+ CONVERT(VARCHAR(4),ISNULL(A.PORT,''))
	DBUserName,DBPass ,'master' DefaultDB
	FROM tbl_Server_DBServerAccess A 
	WHERE A.DBServerId =@DBServerId

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETDATA_MYSQL
-- --------------------------------------------------
-- =============================================      
-- Author:  <Author,,Pramod Jadhav>      
-- Create date: <Create Date,26-Aug-2021,>      
-- Description: <Description,Developed for AWS R&D>      
-- =============================================      
      
CREATE PROC [dbo].[USP_GETDATA_MYSQL]      
 AS BEGIN       
      
SELECT UCV,Cltcode INTO #UnsettledCrBill FROM (SELECT  UCV,cltCode FROM inhouse.dbo.SEBI_PO       
union      
SELECT  UCV,cltCode FROM [AngelNseCM].inhouse.dbo.SEBI_PO       
union      
SELECT  UCV,cltCode FROM [AngelNseCM].MTFTRADE.dbo.SEBI_PO       
UNION       
SELECT  received UCV,Clcode cltCode FROM [AngelFO].INHOUSE.dbo.SEBI_marh      
      
UNION       
SELECT received UCV,Clcode cltCode FROM [AngelFO].inhouse_curfo.dbo.SEBI_marh      
      
UNION       
SELECT  received UCV,Clcode cltCode FROM [AngelCommodity].inhouse_bsx.dbo.SEBI_marh      
      
UNION       
SELECT  received UCV,Clcode cltCode FROM [AngelCommodity].INHOUSE_MCDCS.dbo.SEBI_marh      
      
UNION       
SELECT  received UCV,Clcode cltCode FROM [AngelCommodity].inhouse_NCDX.dbo.SEBI_marh      
      
UNION       
SELECT received UCV,Clcode cltCode FROM [AngelCommodity].inhouse_MCDX.dbo.SEBI_marh      
      
UNION       
SELECT   UCV,Cltcode cltCode FROM [AngelFO].inhouse.dbo.SEBI_PO_BSEMFSS)A      
      
      
      
      
      
      
      
SELECT * INTO #UnrecoAmt FROM (      
SELECT UnrecoCr,Cltcode FROM inhouse.dbo.SEBI_PO      
union      
SELECT UnrecoCr,Cltcode FROM [AngelNseCM].inhouse.DBO.SEBI_PO       
UNION      
SELECT UnrecoCr,Cltcode FROM [AngelNseCM].MTFTRADE.DBO.SEBI_PO       
union      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelFO].inhouse.DBO.SEBI_marh       
UNION      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelFO].inhouse_curfo.DBO.SEBI_marh      
UNION      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelCommodity].INHOUSE_MCDCS.DBO.SEBI_marh      
UNION      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelCommodity].inhouse_bsx.DBO.SEBI_marh       
UNION      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelCommodity].inhouse_NCDX.DBO.SEBI_marh       
UNION      
SELECT UnrecoCr,Clcode Cltcode FROM [AngelCommodity].inhouse_MCDX.DBO.SEBI_marh       
UNION      
SELECT UnrecoCr,Cltcode FROM [AngelFO].inhouse.DBO.SEBI_PO_BSEMFSS      
UNION      
SELECT UnrecoCr,Cltcode FROM [AngelFO].inhouse.DBO.SEBI_PO_NSEMFSS )B      
      
      
SELECT NetShortValue ,PARTY_cODE AS Cltcode INTO #ShortSellValue FROM [INTRANET].CMS.dbo.NCMS_ShortSell      
      
      
      
      
--SELECT  EQ_IntAmt,partY_code cltCode FROM [INTRANET].misc.dbo.Accrued_PenalCharges WHERE EQ_IntAmt<>0      
      
      
SELECT * INTO #NonCashColl FROM (SELECT non_cash,Clcode Cltcode FROM [AngelFO].inhouse.dbo.SEBI_marh       
UNION      
SELECT non_cash,Clcode Cltcode FROM [AngelFO].inhouse_curfo.dbo.SEBI_marh       
--UNION      
--SELECT non_cash,Clcode Cltcode FROM [AngelCommodity].INHOUSE_MCDCS.dbo.EBI_marh       
UNION      
SELECT non_cash,Clcode Cltcode FROM [AngelCommodity].inhouse_bsx.dbo.SEBI_marh       
UNION      
SELECT non_cash,Clcode Cltcode FROM [AngelCommodity].inhouse_NCDX.dbo.SEBI_marh      
UNION      
SELECT non_cash,Clcode Cltcode FROM [AngelCommodity].inhouse_MCDX.dbo.SEBI_marh )C      
      
      
      
      
      
SELECT * INTO #MarginAmt FROM (SELECT imargin,Clcode FROM [AngelFO].inhouse.dbo.SEBI_marh      
union      
SELECT imargin,Clcode FROM [AngelFO].inhouse_curfo.dbo.SEBI_marh      
union      
SELECT imargin,Clcode FROM [AngelCommodity].INHOUSE_MCDCS.dbo.SEBI_marh      
union      
SELECT imargin,Clcode FROM [AngelCommodity].inhouse_bsx.dbo.SEBI_marh      
union      
SELECT imargin,Clcode FROM [AngelCommodity].inhouse_NCDX.dbo.SEBI_marh      
union      
SELECT imargin,Clcode FROM [AngelCommodity].inhouse_MCDX.dbo.SEBI_marh)D      
      
      
SELECT u.Cltcode,u.UCV,m.imargin,rec.UnRecoCr,short.NetShortValue,col.non_cash FROM #UnsettledCrBill u      
JOIN #MarginAmt m      
ON u.Cltcode=m.Clcode      
JOIN #UnrecoAmt rec      
ON m.Clcode=rec.Cltcode      
JOIN #ShortSellValue short      
ON u.Cltcode=short.Cltcode   
JOIN #NonCashColl col      
ON u.Cltcode=col.Cltcode      
WHERE u.UCV<>0 AND m.imargin<>0 AND UnRecoCr<>0 AND short.NetShortValue<>0      
      
      
      
      
          
      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_illiquid_branchwise
-- --------------------------------------------------
CREATE Proc  Usp_illiquid_branchwise  
  
(  
@fromdate as varchar(11),  
@todate as varchar(11),
@regcode as varchar(25) 
)  
as  
set @fromdate = convert(datetime,@fromdate,103)  
set @todate = convert(datetime,@todate,103) 

--declare @fromdate as varchar(11),    
--@todate as varchar(11)  
--  
--set @fromdate = convert(datetime,'01/12/2009',103)    
--set @todate = convert(datetime,'12/12/2009',103)   
  
SELECT * INTO #tbl_illiquidscrip_upload from mis.bse.dbo.tbl_illiquidscrip_upload with (nolock)   
  
select b.* into #temp from   
#tbl_illiquidscrip_upload a   WITH(NOLOCK)  
inner join  
bsedb_ab.dbo.cmbillvalan B   WITH (NOLOCK)  
on a.fld_scrip_cd = b.scrip_cd   
where sauda_date >= @fromdate  
and sauda_date <= @todate + ' 23:59:59.000'  
  
select Branch_Cd,region,count(party_code) as [Total_Clients],  
ClientsPercentage=convert(varchar,convert(decimal(10,2),convert(decimal(10,2),(count(party_code))*100)/convert(decimal(10,2),(Select count=count(Branch_Cd) from #temp)))),                                      
count(distinct sub_broker) as [Subroker_Count] ,  
subrokerPercentage=convert(varchar,convert(decimal(10,2),convert(decimal(10,2),(count(distinct sub_broker))*100)/convert(decimal(10,2),(Select count=count(distinct sub_broker) from #temp))))                                     
into #tr from #temp group by Branch_Cd,region


select   
a.Branch_Cd, 
a.region,   
a.total_clients,  
a.clientspercentage+'%'  as clientspercentage,  
convert(varchar,sum(convert(decimal(10,2),b.clientspercentage)))+ '%' as cum_clientspercentage ,  
a.[Subroker_Count],  
a.subrokerPercentage+'%' as subrokerPercentage ,  
convert(varchar,sum(convert(decimal(10,2),b.subrokerPercentage))) +'%'as cum_branchpercentage   
from #tr a cross join #tr b   
where convert(decimal(10,2),b.clientspercentage) >= convert(decimal(10,2),a.clientspercentage )  and a.region like @regcode
group by a.Branch_Cd,a.total_clients,a.clientspercentage,a.[Subroker_Count],a.subrokerPercentage,a.region 
order by a.total_clients desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_illiquid_regionwise
-- --------------------------------------------------
CREATE Proc  Usp_illiquid_regionwise  
  
(  
@fromdate as varchar(11),  
@todate as varchar(11)  
)  
as  


--declare @fromdate as varchar(11),  
--@todate as varchar(11)
--
--set @fromdate = convert(datetime,'01/12/2009',103)  
--set @todate = convert(datetime,'12/12/2009',103) 

set @fromdate = convert(datetime,@fromdate,103)  
set @todate = convert(datetime,@todate,103)  
  
SELECT * INTO #tbl_illiquidscrip_upload from mis.bse.dbo.tbl_illiquidscrip_upload with (nolock)   
  
select b.* into #temp from   
#tbl_illiquidscrip_upload a   WITH(NOLOCK)  
inner join  
bsedb_ab.dbo.cmbillvalan B   WITH (NOLOCK)  
on a.fld_scrip_cd = b.scrip_cd   
where sauda_date >= @fromdate  
and sauda_date <= @todate + ' 23:59:59.000'  
  
select region,count(party_code) as [Total_Clients],  
ClientsPercentage=convert(varchar,convert(decimal(10,2),convert(decimal(10,2),(count(party_code))*100)/convert(decimal(10,2),(Select count=count(region) from #temp)))),                                      
count(distinct branch_cd) as [Branch_Count] ,  
branchPercentage=convert(varchar,convert(decimal(10,2),convert(decimal(10,2),(count(distinct branch_cd))*100)/convert(decimal(10,2),(Select count=count(distinct branch_cd) from #temp))))                                      
 into #tr from #temp   
group by region   
order by count(party_code) desc  

select 
a.region,
a.total_clients,
a.clientspercentage+'%'  as clientspercentage,
convert(varchar,sum(convert(decimal(10,2),b.clientspercentage)))+ '%' as cum_clientspercentage ,
a.branch_count,
a.branchpercentage+'%' as branchpercentage ,
convert(varchar,sum(convert(decimal(10,2),b.branchpercentage))) +'%'as cum_branchpercentage 
from #tr a cross join #tr b 
where convert(decimal(10,2),b.clientspercentage) >= convert(decimal(10,2),a.clientspercentage )
group by a.region,a.total_clients,a.clientspercentage,a.branch_count,a.branchpercentage
order by a.total_clients desc

  
  
/*select  
Percentage=convert(varchar,convert(decimal(10,2),convert(decimal(10,2),(count(party_code))*100)/convert(decimal(10,2),(Select count=count(region) from #temp))))+'%' from #temp                           */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_illiquid_subbrokerwise
-- --------------------------------------------------
CREATE Proc  Usp_illiquid_subbrokerwise    
    
(    
@fromdate as varchar(11),    
@todate as varchar(11),  
@brcode as varchar(25)   
)    
as    
set @fromdate = convert(datetime,@fromdate,103)    
set @todate = convert(datetime,@todate,103)   
  
--declare @fromdate as varchar(11),      
--@todate as varchar(11) ,@regcode as varchar(25)     
--    
--set @fromdate = convert(datetime,'01/12/2009',103)      
--set @todate = convert(datetime,'12/12/2009',103)     
--set @regcode = '%' 

SELECT * INTO #tbl_illiquidscrip_upload from mis.bse.dbo.tbl_illiquidscrip_upload with (nolock)     
    
select b.* into #temp from     
#tbl_illiquidscrip_upload a   WITH(NOLOCK)    
inner join    
bsedb_ab.dbo.cmbillvalan B   WITH (NOLOCK)    
on a.fld_scrip_cd = b.scrip_cd     
where sauda_date >= @fromdate    
and sauda_date <= @todate + ' 23:59:59.000'  

select party_code,scrip_cd,convert(varchar(11),sauda_date,103)as sauda_date,
case when pqtytrd <> 0.00 then 'P' when pqtydel <> 0 then 'P'
when sqtytrd <> 0 then 'S' when sqtydel <> 0 then 'S' end as sell_buy,
case when pqtytrd <> 0.00 then pqtytrd when pqtydel <> 0 then pqtydel
when sqtytrd <> 0 then sqtytrd when sqtydel <> 0 then sqtydel end as tradeqty,sett_no,sett_type,
region,branch_cd,sub_broker,scrip_name,terminal_id
from #temp  where branch_cd like @brcode

/*set @sql = 'select a.party_code,a.scrip_cd,a.sauda_date,
case when a.pqtytrd <> 0.00 then ''P'' when a.pqtydel <> 0 then ''P''
when a.sqtytrd <> 0 then ''S'' when a.sqtydel <> 0 then ''S'' end as sell_buy,
case when a.pqtytrd <> 0.00 then a.pqtytrd when a.pqtydel <> 0 then a.pqtydel
when a.sqtytrd <> 0 then a.sqtytrd when a.sqtydel <> 0 then a.sqtydel end as tradeqty,a.sett_no,a.sett_type,
a.region,a.branch_cd,a.sub_broker,a.scrip_name,a.terminal_id,b.total
from #temp a left outer join '+@date+'  b on
a.party_Code = b.party_code  order by a.party_Code'
print @sql*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ING_DATES
-- --------------------------------------------------
CREATE proc USP_ING_DATES --'05/05/2001','C'  
(  
@date varchar(11),  
@type varchar(5)  
)  
as  
SET NOCOUNT ON   
  
select  convert(varchar(11),funds_payout,103) as Payout_date,convert(varchar(11),sec_payout,103) as Sec_delvDate  
from bsedb_ab.dbo.sett_mst(nolock) where convert(varchar(11),start_date,103)=@date and sett_type=@type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_INSERT_DP_M3_Holding_Balance
-- --------------------------------------------------
CREATE PROCEDURE DBO.USP_INSERT_DP_M3_Holding_Balance
(
@DataSource    VARCHAR (100) = '' ,
@SubType       VARCHAR (100) = '' ,
@FileName      VARCHAR (200)  ,
@UploadedDate  Smalldatetime ,
@UserId        VARCHAR (100) = '' 

)
AS
BEGIN

--Declare @filename varchar(200)
--SET @filename ='D:\InHouseApplications\DPM3_M4\11DPM3UX.16122021044842.EOD'

DECLARE @CMD VARCHAR(MAX)
SET @CMD = LOWER( ' BULK INSERT tbl_DP_M3_Holding_Balance_tmp FROM ''' + @FileName + ''' WITH  (ROWTERMINATOR = ''0x0a'',FIELDTERMINATOR = ''~'') ')
EXEC (@CMD)

DECLARE @Count INT
SELECT @Count =count(*) FROm tbl_DP_M3_Holding_Balance_tmp
IF (@Count  > 0)
BEGIN
	SELECT @Count CNT 
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PeakMarginfileUpload
-- --------------------------------------------------
CREATE proc [dbo].[USP_PeakMarginfileUpload]
(
@filename varchar(500)
)
AS
BEGIN

--Exec master.dbo.xp_cmdshell 'NET USE \\INHOUSELIVEAPP1-FS.angelone.in\IPC$ /USER:Administrator Winw0rld@1604'
 
 declare @startime as datetime ,@Endtime as datetime--,@tradedate as varchar(20)
 set @startime=GETDATE()
 -- declare  @filename varchar(500) ='PeakMarginUAT.csv'
   truncate table tbl_TmppeakMarginfile
	Declare @filePath varchar(500)=''                             
	set @filePath ='\\INHOUSELIVEAPP1-FS.angelone.in\d\upload1\PeakMarginFile\'+@filename               
	DECLARE @sql NVARCHAR(4000) = 'BULK INSERT tbl_TmppeakMarginfile FROM ''' + @filePath + ''' WITH ( FIELDTERMINATOR ='','', ROWTERMINATOR =''\n'',FirstRow=2 )'; 
	  EXEC(@sql) 
 
 
 insert into tbl_peakMarginfile_hist 
 select *,GETDATE() from tbl_peakMarginfile
 
 Truncate table tbl_peakMarginfile

 insert into tbl_peakMarginfile(Tradedate,Clientcode,TotalPeakMargin,FOMargin,NScurMargin,BSEcurMargin,Mcxmargin,Ncdexmargin,EqMargin,UploadStartTime)
 select Convert(datetime,Tradedate,103),Clientcode,TotalPeakMargin,FOMargin,NScurMargin,BSEcurMargin,Mcxmargin,Ncdexmargin,EqMargin,@startime from tbl_TmppeakMarginfile



 set @Endtime=GETDATE()

 update tbl_peakMarginfile
 set UploadENDTime=@Endtime 
 where UploadStartTime= @startime

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PenalReverse
-- --------------------------------------------------
  CREATE PROCEDURE Usp_penalreverse
AS
    SET nocount ON

    DECLARE @FromDate AS DATETIME,
            @ToDate   AS DATETIME

    SELECT @FromDate = sdtcur
    FROM   account_ab.dbo.parameter
    WHERE  sdtnxt = (SELECT sdtcur
                     FROM   account_ab.dbo.parameter
                     WHERE  sdtcur <= Getdate()
                            AND ldtcur >= Getdate())

    SET @ToDate=CONVERT(DATETIME, CONVERT(VARCHAR(10), Getdate(), 101)
                                  + ' 23:59:59')

    SELECT vno,
           vtyp
    INTO   #bb
    FROM   account_ab.dbo.ledger WITH (nolock)
    WHERE  cltcode = '560001'
           AND vdt >= @FromDate
           AND vdt <= @ToDate
           AND drcr = 'D'
           AND vtyp = 8

    CREATE CLUSTERED INDEX idxvno
      ON #bb (vno, vtyp)

    TRUNCATE TABLE penalrev_table

    INSERT INTO penalrev_table
                (revdate,
                 party_code,
                 revamount)
    SELECT vdt=CONVERT(DATETIME, CONVERT(VARCHAR(11), vdt)),
           cltcode,
           Vamt=Sum(vamt)
    FROM   (SELECT a.vdt,
                   a.cltcode,
                   a.vamt
            FROM   account_ab.dbo.ledger a WITH (nolock)
                   INNER JOIN #bb b
                           ON a.vno = b.vno
                              AND a.vtyp = b.vtyp
                              /* and vdt>=@FromDate and vdt <=@ToDate */
                              AND drcr = 'C') X
    GROUP  BY CONVERT(DATETIME, CONVERT(VARCHAR(11), vdt)),
              cltcode

    SET nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_TransactionReport
-- --------------------------------------------------


CREATE proc usp_TransactionReport --'P','01/06/2010','N'      
@ReportType char(1),             
@TradeDate varchar(21),          
@SettType varchar(2)          
as                
/*----Sell-----*/                
IF @ReportType = 'S'        
begin        
  select top 5 a.Sauda_Date, Segment='BSE', a.Sett_Type, PayinDate = c.Funds_Payin,            
  SecSettDt = c.sec_payout, DelDt = a.sauda_date+3,            
  a.Party_Name, b.Party_Code, SCrip = SCrip_CD +' '+ Scrip_Name,                
  ISIN, a.Sett_NO, BillNO,  Cl_Type, CltDpId1, QtyDel =SQtyDel, AmtDel = SAmtDel,            
  Price = (SAmtDel/SQtyDel),      
--CASE WHEN SQtyDel<>0 THEN (SAmtDel/SQtyDel) ELSE SQtyDel END,       
Val = SAmtDel, CASA = (SAmtDel + SBrokDel),            
  NetAmt =  (SAmtDel - SBrokDel)               
  from           
bsedb_ab.dbo.cmbillvalan a with (nolock)                
  inner join                
  intranet.risk.dbo.client_details b with (nolock)                
  on                
  a.party_code = b.cl_code               
  inner join              
bsedb_ab.dbo.sett_mst c              
  on              
  a.sett_type = c.sett_type and convert(varchar,a.sauda_date,103) = convert(varchar,c.start_date,103)              
  where           
  a.sett_type = @SettType          
  and             
  b.branch_cd = 'CHEN'                
  and                
    clientType  = 'CLI'                
  and                  
  convert(varchar(11),a.sauda_date,103) = @TradeDate       
  --and a.sauda_date < convert(varchar,@TradeDate+' 23:59:59',103)               
  and a.SQtyDel > 0        
  and c.Exchange = 'BSE'             
  order by           
  b.Party_Code, SCrip          
End         
      
      
              
                
/*----Purchase-----*/                
        
IF @ReportType = 'P'        
Begin        
  select top 5 a.Sauda_Date, Segment='BSE', a.Sett_Type, PayinDate = c.Funds_Payout,            
  SecSettDt = c.sec_payin, DelDt = a.sauda_date+3,            
  a.Party_Name, b.Party_Code, SCrip = SCrip_CD +' '+ Scrip_Name,                
  ISIN, a.Sett_NO, BillNO,  Cl_Type, CltDpId1, QtyDel = PQtyDel, AmtDel = PAmtDel,            
  Price = (PAmtDel/PQtyDel), Val = PAmtDel, CASA = (PAmtDel + PBrokDel),            
  NetAmt =  (PAmtDel + PBrokDel)               
                  
  from           
  bsedb_ab.dbo.cmbillvalan a with (nolock)                
  inner join                
  intranet.risk.dbo.client_details b with (nolock)                
  on                
  a.party_code = b.cl_code               
  inner join              
bsedb_ab.dbo.sett_mst c              
  on              
  a.sett_type = c.sett_type and convert(varchar,a.sauda_date,103) = convert(varchar,c.start_date,103)              
  where        
  a.sett_type = @SettType          
  and                      
  --b.branch_cd = 'CHEN'                
  --and                
  clientType = 'CLI'                
  and                  
  convert(varchar(11),a.sauda_date,103) = @TradeDate      
--and convert(varchar(11),a.sauda_date,103) < '24/06/2010'+' 23:59:59'              
  and PQTYDel > 0      
  and c.Exchange = 'BSE'           
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_MICR_IFSC_CODE_57
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_UPDATE_MICR_IFSC_CODE_57]  
(  
 @UploadTypeId  INT          ,--=1 ,  
 @UploadedDate SMALLDATETIME ,-- =null ,  
 @UserId   INT               --=1   
)  
AS  
BEGIN  
  
--BEGIN TRY  
--BEGIN TRAN  
--select * from tbl_MICR_IFSC_UPD_UPLOAD_TMP  
  
DELETE FROm tbl_MICR_IFSC_UPD_UPLOAD_TMP WHERE  IFSC_CODE like 'IFSC%CODE%'  
Declare @rowcount int   
 DECLARE @RBI_BANKID INT      
 SELECT @RBI_BANKID = MAX(RBI_BANKID) from [ABVSCITRUS].CRMDB_A.dbo.RBIBANKMASTER WITH (NOLOCK)  
 PRINT @RBI_BANKID  
   
 INSERT INTO [ABVSCITRUS].CRMDB_A.dbo.RBIBANKMASTER   
  (  
  BANK_NAME,IFSC_CODE ,MICR_CODE,  
  BRANCH_NAME,ADDRESS,CONTACT,  
  CENTRE,DISTRICT,STATE  
  )   
  SELECT   
  B.BANK_NAME,B.IFSC_CODE ,B.MICR_CODE,  
  B.BRANCH_NAME,B.ADDRESS,'',  
  '',B.DISTRICT,B.STATE  
  FROm [ABVSCITRUS].CRMDB_A.dbo.RBIBANKMASTER A WITH(NOLOCK)  
  RIGHT OUTER JOIN tbl_MICR_IFSC_UPD_UPLOAD_TMP B ON A.IFSC_CODE =B.IFSC_CODE AND A.MICR_CODE = B.MICR_CODE AND   
                                                  A.STATE = B.STATE  
  WHERE  A.BANK_NAME IS NULL AND B.STATE IS NOT NULL  
  SET @rowcount = @@ROWCOUNT  
     INSERT INTO [ABVSCITRUS].CRMDB_A.dbo.RBIBANKMASTER_UPDATE_LOG  
  (  
   BANK_NAME     ,IFSC_CODE     ,MICR_CODE   ,  
   BRANCH_NAME   ,ADDRESS    ,CONTACT    ,  
   CENTRE    ,DISTRICT   ,STATE    ,  
   ModifyType ,RBI_BANKID  
  )  
  SELECT   
  B.BANK_NAME,B.IFSC_CODE ,B.MICR_CODE,  
  B.BRANCH_NAME,B.ADDRESS,'',  
  '',DISTRICT,B.STATE ,  
  'INSERT' ,RBI_BANKID  
  FROm [ABVSCITRUS].CRMDB_A.dbo.RBIBANKMASTER B WITH(NOLOCK)  
  WHERE   RBI_BANKID>@RBI_BANKID   
  
SELECT @rowcount 'Updated'  
  
--COMMIT TRAN  
--END TRY     
--BEGIN CATCH  
--ROLLBACK TRAN  
--  SELECT 0 'Updated'  
--END CATCH  
   
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UploadTypeMSt
-- --------------------------------------------------
 CREATE PROCEDURE DBO.USP_UploadTypeMSt
(
@UploadTypeId INT = 0,
@UserId INT
)
AS

BEGIN
 
--DECLARE 
--@UploadTypeId INT = 0,
--@UserId INT

--SET @UploadTypeId =13
--SET @UserId =3

 -- TAB 0
SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,'' UserName,'' Pass ,'' TempTable
UNION ALL
SELECT 
	A.UploadTypeId  ,
	A.UploadType,
	A.DB DBName,
	A.DBServer IpAdd,
	A.SampleFormat ,
	A.UserName ,
	A.Pass ,
	TempTable
FROM dbo.tbl_FileUploadMst A
INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
WHERE B.EmpId =@UserId AND ParentId_PK =0
      
GROUP BY
    A.UploadTypeId  ,
	A.UploadType,
	A.DB,
	A.DBServer,
	A.SampleFormat ,A.UserName , A.Pass ,TempTable

	--- TAB 1
SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,
       '' UserName,'' Pass ,'' TempTable
UNION ALL
	SELECT 
		A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,
		A.UserName ,
	    A.Pass ,	TempTable
	FROM dbo.tbl_FileUploadMst A
	--INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
	WHERE ParentId_PK =@UploadTypeId AND ParentId_PK <>0
	GROUP BY A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,A.UserName , A.Pass ,TempTable
--- TAB 2

SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,
       '' UserName,'' Pass ,'' TempTable
UNION ALL
	SELECT 
		A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,
		A.UserName ,
	    A.Pass ,	TempTable
	FROM dbo.tbl_FileUploadMst A
	--INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
	WHERE UploadTypeId =@UploadTypeId AND ParentId_PK <>0
	GROUP BY A.UploadTypeId  ,
		A.UploadType,
		A.DB,
		A.DBServer,
		A.SampleFormat ,A.UserName , A.Pass ,TempTable

    ---- TAB 3
 SELECT 0 UploadTypeId ,'-- Select Upload File Type --' UploadType,'' DBName,'' IpAdd ,'' SampleFormat,'' UserName,'' Pass ,'' TempTable
UNION ALL
SELECT 
	A.UploadTypeId  ,
	A.UploadType,
	A.DB DBName,
	A.DBServer IpAdd,
	A.SampleFormat ,
	A.UserName ,
	A.Pass ,
	TempTable
FROM dbo.tbl_FileUploadMst A
INNER JOIN dbo.tbl_FileUploadUserMapping B ON A.UploadTypeId= B.UploadTypeId
WHERE A.UploadTypeId =@UploadTypeId AND ParentId_PK =0
      
GROUP BY
    A.UploadTypeId  ,
	A.UploadType,
	A.DB,
	A.DBServer,
	A.SampleFormat ,A.UserName , A.Pass ,TempTable

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UserRoleMapping
-- --------------------------------------------------
CREATE PROCEDURE DBO.USP_UserRoleMapping
(
@userid INT 
)
AS
BEGIN

SELECT C.RoleId ,C.RoleName , CASE WHEN B.RoleId IS NULL THEN '0' ELSE '1' END STATUS
FROm  tbl_RoleMst  C
LEFT OUTER JOIN tbl_Emp_Role_Mapping B    ON B.RoleId=C.RoleId
AND B.EMpID =@userid   
--GROUP BY C.RoleId  ,C.RoleName
ORDER BY C.RoleId 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Validate_UserName_Pass
-- --------------------------------------------------
CREATE PROCEDURE DBO.USP_Validate_UserName_Pass
(
@UserName VARCHAR (100),
@Pass     VARCHAR(10)
)
AS
BEGIN

--DECLARE 
--@UserName VARCHAR (100),
--@Pass     VARCHAR(10)
--SET @UserName ='MohammadAhsan.F'
--SET @Pass ='pass@123'
 

IF EXISTS (SELECT TOP 1 * FROm tbl_EmpDetails A WHERE A.UserName =@UserName)
BEGIN
	SELECT 
	A.EmpId ,A.FullName , A.UserName AS EmpCode
	FROM       tbl_EmpDetails A
	WHERE A.UserName =@UserName  --AND Pass = @Pass
	GROUP BY A.EmpId ,A.FullName ,A.UserName  
	ORDER BY A.EmpId
END
ELSE
BEGIN
SELECT '0'
END

END

GO

-- --------------------------------------------------
-- TABLE dbo.19072022_12798
-- --------------------------------------------------
CREATE TABLE [dbo].[19072022_12798]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL,
    [Column 4] VARCHAR(50) NULL,
    [Column 5] VARCHAR(50) NULL,
    [Column 6] VARCHAR(50) NULL,
    [Column 7] VARCHAR(50) NULL,
    [Column 8] VARCHAR(50) NULL,
    [Column 9] VARCHAR(50) NULL,
    [Column 10] VARCHAR(50) NULL,
    [Column 11] VARCHAR(50) NULL,
    [Column 12] VARCHAR(50) NULL,
    [Column 13] VARCHAR(50) NULL,
    [Column 14] VARCHAR(50) NULL,
    [Column 15] VARCHAR(50) NULL,
    [Column 16] VARCHAR(50) NULL,
    [Column 17] VARCHAR(50) NULL,
    [Column 18] VARCHAR(50) NULL,
    [Column 19] VARCHAR(50) NULL,
    [Column 20] VARCHAR(50) NULL,
    [Column 21] VARCHAR(50) NULL,
    [Column 22] VARCHAR(50) NULL,
    [Column 23] VARCHAR(50) NULL,
    [Column 24] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.abc_lg
-- --------------------------------------------------
CREATE TABLE [dbo].[abc_lg]
(
    [fld] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast]
(
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ADT_File
-- --------------------------------------------------
CREATE TABLE [dbo].[ADT_File]
(
    [TBDate] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [Balance] MONEY NULL,
    [Margin] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Flag] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AGG_DupRecLog
-- --------------------------------------------------
CREATE TABLE [dbo].[AGG_DupRecLog]
(
    [DupCount] INT NULL,
    [PrpTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_Dabba_trader
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_Dabba_trader]
(
    [sub_broker] VARCHAR(10) NULL,
    [tradeqty] INT NULL,
    [Amount] MONEY NULL,
    [nor] INT NULL,
    [Update_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCHEME_MAPPING_05082022
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCHEME_MAPPING_05082022]
(
    [SP_SRNO] INT NOT NULL,
    [SP_PARTY_CODE] VARCHAR(10) NOT NULL,
    [SP_COMPUTATION_LEVEL] CHAR(1) NOT NULL,
    [SP_INST_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCRIP] VARCHAR(12) NOT NULL,
    [SP_SCHEME_ID] INT NOT NULL,
    [SP_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCHEME_TYPE] CHAR(1) NOT NULL,
    [SP_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_BUY_BROK_TYPE] CHAR(1) NULL,
    [SP_SELL_BROK_TYPE] CHAR(1) NULL,
    [SP_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_SELL_BROK] NUMERIC(18, 4) NULL,
    [SP_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SP_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SP_TURNOVERON] VARCHAR(7) NOT NULL,
    [SP_BROK_COMPUTEON] CHAR(1) NOT NULL,
    [SP_BROK_COMPUTETYPE] CHAR(1) NOT NULL,
    [SP_MIN_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MIN_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_DATE_FROM] DATETIME NOT NULL,
    [SP_DATE_TO] DATETIME NOT NULL,
    [SP_CREATEDBY] VARCHAR(20) NOT NULL,
    [SP_CREATEDON] DATETIME NOT NULL,
    [SP_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SP_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCHEME_MAPPING_050820221
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCHEME_MAPPING_050820221]
(
    [SP_PARTY_CODE] VARCHAR(10) NULL,
    [SP_COMPUTATION_LEVEL] CHAR(1) NOT NULL,
    [SP_INST_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCRIP] VARCHAR(12) NOT NULL,
    [SP_SCHEME_ID] INT NOT NULL,
    [SP_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCHEME_TYPE] CHAR(1) NOT NULL,
    [SP_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_BUY_BROK_TYPE] CHAR(1) NULL,
    [SP_SELL_BROK_TYPE] CHAR(1) NULL,
    [SP_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_SELL_BROK] NUMERIC(18, 4) NULL,
    [SP_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SP_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SP_TURNOVERON] VARCHAR(7) NOT NULL,
    [SP_BROK_COMPUTEON] CHAR(1) NOT NULL,
    [SP_BROK_COMPUTETYPE] CHAR(1) NOT NULL,
    [SP_MIN_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MIN_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_DATE_FROM] DATETIME NOT NULL,
    [SP_DATE_TO] DATETIME NOT NULL,
    [SP_CREATEDBY] VARCHAR(20) NOT NULL,
    [SP_CREATEDON] DATETIME NOT NULL,
    [SP_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SP_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCHEME_MAPPING_14112023
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCHEME_MAPPING_14112023]
(
    [SP_SRNO] INT NOT NULL,
    [SP_PARTY_CODE] VARCHAR(10) NOT NULL,
    [SP_COMPUTATION_LEVEL] CHAR(1) NOT NULL,
    [SP_INST_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCRIP] VARCHAR(12) NOT NULL,
    [SP_SCHEME_ID] INT NOT NULL,
    [SP_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCHEME_TYPE] CHAR(1) NOT NULL,
    [SP_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_BUY_BROK_TYPE] CHAR(1) NULL,
    [SP_SELL_BROK_TYPE] CHAR(1) NULL,
    [SP_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_SELL_BROK] NUMERIC(18, 4) NULL,
    [SP_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SP_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SP_TURNOVERON] VARCHAR(7) NOT NULL,
    [SP_BROK_COMPUTEON] CHAR(1) NOT NULL,
    [SP_BROK_COMPUTETYPE] CHAR(1) NOT NULL,
    [SP_MIN_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MIN_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_DATE_FROM] DATETIME NOT NULL,
    [SP_DATE_TO] DATETIME NOT NULL,
    [SP_CREATEDBY] VARCHAR(20) NOT NULL,
    [SP_CREATEDON] DATETIME NOT NULL,
    [SP_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SP_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCHEME_MAPPING_141120231
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCHEME_MAPPING_141120231]
(
    [SP_PARTY_CODE] VARCHAR(10) NULL,
    [SP_COMPUTATION_LEVEL] CHAR(1) NOT NULL,
    [SP_INST_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCRIP] VARCHAR(12) NOT NULL,
    [SP_SCHEME_ID] INT NOT NULL,
    [SP_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCHEME_TYPE] CHAR(1) NOT NULL,
    [SP_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_BUY_BROK_TYPE] CHAR(1) NULL,
    [SP_SELL_BROK_TYPE] CHAR(1) NULL,
    [SP_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_SELL_BROK] NUMERIC(18, 4) NULL,
    [SP_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SP_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SP_TURNOVERON] VARCHAR(7) NOT NULL,
    [SP_BROK_COMPUTEON] CHAR(1) NOT NULL,
    [SP_BROK_COMPUTETYPE] CHAR(1) NOT NULL,
    [SP_MIN_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MIN_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_DATE_FROM] DATETIME NOT NULL,
    [SP_DATE_TO] DATETIME NOT NULL,
    [SP_CREATEDBY] VARCHAR(20) NOT NULL,
    [SP_CREATEDON] DATETIME NOT NULL,
    [SP_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SP_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_client_deposit_recno
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_client_deposit_recno]
(
    [co_Code] VARCHAR(10) NULL,
    [Upd_date] DATETIME NOT NULL,
    [accno] VARCHAR(16) NOT NULL,
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(25) NULL,
    [cltcode] VARCHAR(20) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] CHAR(12) NULL,
    [last_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_client_deposit_recno_bond
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_client_deposit_recno_bond]
(
    [co_Code] VARCHAR(10) NULL,
    [Upd_date] DATETIME NOT NULL,
    [accno] VARCHAR(25) NULL,
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NOT NULL,
    [vno] VARCHAR(25) NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(25) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] VARCHAR(25) NULL,
    [last_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_client_deposit_recno_GSec
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_client_deposit_recno_GSec]
(
    [co_Code] VARCHAR(10) NULL,
    [Upd_date] DATETIME NOT NULL,
    [accno] VARCHAR(25) NULL,
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NOT NULL,
    [vno] VARCHAR(25) NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(25) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] VARCHAR(25) NULL,
    [last_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_OBJECT
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_OBJECT]
(
    [ObjName] VARCHAR(500) NULL,
    [ObjType] VARCHAR(10) NULL,
    [ObjDbName] VARCHAR(100) NULL,
    [ObjComdType] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bond_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[Bond_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(50) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bond_PO_BSEIPO
-- --------------------------------------------------
CREATE TABLE [dbo].[Bond_PO_BSEIPO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branches
-- --------------------------------------------------
CREATE TABLE [dbo].[branches]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Short_Name] CHAR(20) NOT NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(100) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [DefTrader] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Broktable
-- --------------------------------------------------
CREATE TABLE [dbo].[Broktable]
(
    [Table_No] INT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] NUMERIC(10, 2) NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(30) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSX_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[BSX_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cash_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[Cash_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Var Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Prev Var Margin] VARCHAR(50) NULL,
    [Prev MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Payment_reco_BSE
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Payment_reco_BSE]
(
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(30) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NOT NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] CHAR(12) NULL,
    [last_Date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client1
-- --------------------------------------------------
CREATE TABLE [dbo].[client1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(40) NOT NULL,
    [L_Address2] VARCHAR(40) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] NUMERIC(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(6) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] NUMERIC(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(40) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(20) NULL,
    [trader] VARCHAR(20) NULL,
    [Ward_No] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Area] VARCHAR(10) NULL,
    [Clrating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client2
-- --------------------------------------------------
CREATE TABLE [dbo].[client2]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Table_no] INT NULL,
    [Sub_TableNo] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] INT NULL,
    [P_To_P] INT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] INT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] INT NULL,
    [SB_tableno] INT NULL,
    [brok1_tableno] INT NULL,
    [brok2_tableno] INT NULL,
    [brok3_tableno] INT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [contcharge] TINYINT NULL,
    [mincontamt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [InsCont] CHAR(1) NULL,
    [SerTaxMethod] INT NULL,
    [dummy6] VARCHAR(5) NULL,
    [dummy7] VARCHAR(4) NULL,
    [dummy8] VARCHAR(20) NULL,
    [dummy9] VARCHAR(20) NULL,
    [dummy10] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client3
-- --------------------------------------------------
CREATE TABLE [dbo].[client3]
(
    [cl_code] VARCHAR(10) NULL,
    [party_code] CHAR(10) NOT NULL,
    [exchange] CHAR(3) NOT NULL,
    [markettype] VARCHAR(15) NOT NULL,
    [margin] MONEY NOT NULL,
    [nooftimes] NUMERIC(2, 0) NOT NULL,
    [margin_recd] NUMERIC(18, 4) NULL,
    [MtoM] NUMERIC(18, 4) NULL,
    [pmarginrate] NUMERIC(5, 2) NULL,
    [MtoMdate] DATETIME NULL,
    [InitialMargin] NUMERIC(18, 4) NULL,
    [MainenancetMargin] NUMERIC(18, 4) NULL,
    [MarginExchange] NUMERIC(18, 4) NULL,
    [MarginBroker] NUMERIC(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4
-- --------------------------------------------------
CREATE TABLE [dbo].[client4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(16) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client4_dump
-- --------------------------------------------------
CREATE TABLE [dbo].[client4_dump]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] INT NULL,
    [date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client5
-- --------------------------------------------------
CREATE TABLE [dbo].[client5]
(
    [cl_code] VARCHAR(10) NULL,
    [BirthDate] DATETIME NULL,
    [Sex] CHAR(1) NULL,
    [ActiveFrom] DATETIME NULL,
    [InteractMode] TINYINT NULL,
    [RepatriatAC] TINYINT NULL,
    [RepatriatBank] TINYINT NULL,
    [RepatriatACNO] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [KYCForm] TINYINT NULL,
    [BankCert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [VotersID] TINYINT NULL,
    [VotersIDdtl] VARCHAR(30) NULL,
    [ITReturn] TINYINT NULL,
    [ITReturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [InactiveFrom] DATETIME NULL,
    [P_Address1] VARCHAR(50) NULL,
    [P_Address2] VARCHAR(50) NULL,
    [P_Address3] VARCHAR(50) NULL,
    [P_City] VARCHAR(20) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [addemailid] VARCHAR(230) NULL,
    [PassportDateOfIssue] DATETIME NULL,
    [PassportPlaceOfIssue] VARCHAR(30) NULL,
    [VoterIdDateOfIssue] DATETIME NULL,
    [VoterIdPlaceOfIssue] VARCHAR(30) NULL,
    [ITReturnDateOfFiling] DATETIME NULL,
    [LicenceNoDateOfIssue] DATETIME NULL,
    [LicenceNoPlaceOfIssue] VARCHAR(30) NULL,
    [RationCardDateOfIssue] DATETIME NULL,
    [RationCardPlaceOfIssue] VARCHAR(30) NULL,
    [Client_Agre_Dt] DATETIME NULL,
    [Regr_No] VARCHAR(50) NULL,
    [Regr_Place] VARCHAR(50) NULL,
    [Regr_Date] DATETIME NULL,
    [Regr_Auth] VARCHAR(50) NULL,
    [Introd_Client_Id] VARCHAR(50) NULL,
    [Introd_Relation] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Sett_Mode] VARCHAR(50) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Systumdate] DATETIME NULL,
    [Passportexpdate] DATETIME NULL,
    [Driveexpdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client6
-- --------------------------------------------------
CREATE TABLE [dbo].[client6]
(
    [Cl_Code] VARCHAR(10) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbillvalan
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbillvalan]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [BillNo] VARCHAR(10) NULL,
    [ContractNo] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [ISIN] VARCHAR(12) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ClientType] VARCHAR(10) NULL,
    [TradeType] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Pamt] MONEY NOT NULL,
    [Samt] MONEY NOT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [TrdAmt] MONEY NULL,
    [DelAmt] MONEY NULL,
    [SerInEx] SMALLINT NULL,
    [Service_Tax] MONEY NULL,
    [ExService_Tax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Region] VARCHAR(50) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [Update_Date] VARCHAR(11) NULL,
    [Status_Name] VARCHAR(15) NULL,
    [Exchange] VARCHAR(5) NULL,
    [Segment] VARCHAR(10) NULL,
    [MemberType] VARCHAR(3) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL,
    [Dummy3] VARCHAR(1) NULL,
    [Dummy4] MONEY NULL,
    [Dummy5] MONEY NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast]
(
    [COSTNAME] CHAR(35) NOT NULL,
    [COSTCODE] SMALLINT NOT NULL,
    [CATCODE] SMALLINT NULL,
    [grpcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dd.1
-- --------------------------------------------------
CREATE TABLE [dbo].[dd.1]
(
    [fr_name] VARCHAR(50) NULL,
    [mob_no] INT NULL,
    [addr] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DPC_TB_NB_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[DPC_TB_NB_TEMP]
(
    [Segment] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DPC_TB_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[DPC_TB_TEMP]
(
    [Segment] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_after_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_after_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fragmentaion_before_reorg
-- --------------------------------------------------
CREATE TABLE [dbo].[Fragmentaion_before_reorg]
(
    [Schema] NVARCHAR(128) NOT NULL,
    [Table] NVARCHAR(128) NOT NULL,
    [Index] NVARCHAR(128) NULL,
    [avg_fragmentation_in_percent] FLOAT NULL,
    [page_count] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.globals
-- --------------------------------------------------
CREATE TABLE [dbo].[globals]
(
    [year] VARCHAR(4) NULL,
    [exchange] VARCHAR(3) NULL,
    [service_tax] NUMERIC(10, 4) NULL,
    [service_tax_ac] VARCHAR(30) NULL,
    [turnover_ac] INT NULL,
    [sebi_turn_ac] INT NULL,
    [broker_note_ac] INT NULL,
    [other_chrg_ac] INT NULL,
    [exchange_gl_ac] VARCHAR(30) NULL,
    [year_start_dt] DATETIME NULL,
    [year_end_dt] DATETIME NULL,
    [CESS_Tax] NUMERIC(10, 4) NULL,
    [TrdBuyTrans] NUMERIC(18, 4) NULL,
    [TrdSellTrans] NUMERIC(18, 4) NULL,
    [DelBuyTrans] NUMERIC(18, 4) NULL,
    [DelSellTrans] NUMERIC(18, 4) NULL,
    [EDUCESSTAX] NUMERIC(18, 4) NULL,
    [STT_TAX_AC] INT NULL,
    [TOTTAXES_LESS] NUMERIC(18, 6) NULL,
    [TOTTAXES_HIGH] NUMERIC(18, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GSec_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[GSec_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(50) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GSec_PO_BSEIPO
-- --------------------------------------------------
CREATE TABLE [dbo].[GSec_PO_BSEIPO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.isettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[isettlement]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(16) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(18, 4) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(18, 4) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(10) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1]
(
    [bnkname] VARCHAR(50) NULL,
    [brnname] VARCHAR(20) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(30) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCD_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[MCD_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCD_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[MCD_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCX_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[MCX_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mimansa_angel_tbl_ucc_bsecm_trade
-- --------------------------------------------------
CREATE TABLE [dbo].[mimansa_angel_tbl_ucc_bsecm_trade]
(
    [party_code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mimansa_angel_ucc_bsecm_client_data
-- --------------------------------------------------
CREATE TABLE [dbo].[mimansa_angel_ucc_bsecm_client_data]
(
    [new_modify] VARCHAR(1) NOT NULL,
    [sub_bat_user] VARCHAR(11) NOT NULL,
    [equity_client] VARCHAR(1) NOT NULL,
    [derivative_client] VARCHAR(1) NOT NULL,
    [reserved_001] VARCHAR(1) NOT NULL,
    [reserved_002] VARCHAR(1) NOT NULL,
    [reserved_003] VARCHAR(1) NOT NULL,
    [client_code] VARCHAR(10) NOT NULL,
    [client_status] VARCHAR(11) NOT NULL,
    [client_category] VARCHAR(15) NOT NULL,
    [client_long_name] VARCHAR(100) NOT NULL,
    [client_first_name] VARCHAR(50) NOT NULL,
    [client_middle_name] VARCHAR(50) NOT NULL,
    [client_last_name] VARCHAR(50) NOT NULL,
    [client_address] VARCHAR(250) NOT NULL,
    [city] VARCHAR(25) NOT NULL,
    [state] VARCHAR(25) NOT NULL,
    [country] VARCHAR(25) NOT NULL,
    [pin_code] VARCHAR(10) NOT NULL,
    [std_code] VARCHAR(10) NOT NULL,
    [phone] VARCHAR(15) NOT NULL,
    [email] VARCHAR(50) NOT NULL,
    [MobilePager] VARCHAR(40) NOT NULL,
    [pan_no] VARCHAR(10) NOT NULL,
    [registration_no] VARCHAR(50) NOT NULL,
    [registering_authority] VARCHAR(50) NOT NULL,
    [place_of_registration] VARCHAR(50) NOT NULL,
    [date_of_registration] VARCHAR(10) NOT NULL,
    [passport_no] VARCHAR(50) NOT NULL,
    [place_of_issue_of_passport] VARCHAR(50) NOT NULL,
    [date_of_issue_of_passport] VARCHAR(10) NOT NULL,
    [driving_license_no] VARCHAR(50) NOT NULL,
    [place_of_issue_of_driving_license] VARCHAR(50) NOT NULL,
    [date_of_issue_of_driving_license] VARCHAR(10) NOT NULL,
    [voter_id] VARCHAR(50) NOT NULL,
    [place_of_issue_of_voter_id] VARCHAR(50) NOT NULL,
    [date_of_issue_of_voter_id] VARCHAR(10) NOT NULL,
    [ration_card_number] VARCHAR(50) NOT NULL,
    [place_of_issue_of_ration_card] VARCHAR(50) NOT NULL,
    [date_of_issue_of_ration_card] VARCHAR(10) NOT NULL,
    [bank_name] VARCHAR(50) NOT NULL,
    [bank_address] VARCHAR(200) NOT NULL,
    [bank_account_type] VARCHAR(20) NOT NULL,
    [bank_account_no] VARCHAR(20) NOT NULL,
    [depository_name] VARCHAR(50) NOT NULL,
    [depository_participant] VARCHAR(50) NOT NULL,
    [client_dp_id] VARCHAR(50) NOT NULL,
    [remarks] VARCHAR(200) NOT NULL,
    [introducers_name] VARCHAR(50) NOT NULL,
    [sub_broker] VARCHAR(50) NOT NULL,
    [date_of_birth] VARCHAR(10) NOT NULL,
    [client_agreement_date] VARCHAR(10) NOT NULL,
    [Type_Of_Service] VARCHAR(20) NOT NULL,
    [is_active] VARCHAR(1) NOT NULL,
    [record_time] VARCHAR(10) NOT NULL,
    [pan_orig] VARCHAR(50) NULL,
    [client_code_orig] VARCHAR(50) NULL,
    [dummy_001] CHAR(1) NOT NULL,
    [dummy_002] CHAR(1) NOT NULL,
    [dummy_003] CHAR(1) NOT NULL,
    [dummy_004] CHAR(1) NOT NULL,
    [dummy_005] CHAR(1) NOT NULL,
    [dummy_006] CHAR(1) NOT NULL,
    [dummy_007] CHAR(1) NOT NULL,
    [dummy_008] CHAR(1) NOT NULL,
    [dummy_009] CHAR(1) NOT NULL,
    [dummy_010] CHAR(1) NOT NULL,
    [CP_CODE] VARCHAR(14) NULL,
    [EQ_CMID] VARCHAR(5) NULL,
    [FNO_CP_CODE] VARCHAR(14) NULL,
    [FNO_CMID] VARCHAR(5) NULL,
    [CIN] VARCHAR(21) NULL,
    [WHETHER_CORPORATE_WITH_CIN] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multicltid_dump
-- --------------------------------------------------
CREATE TABLE [dbo].[Multicltid_dump]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [CltDpNo] VARCHAR(16) NULL,
    [DpId] VARCHAR(16) NULL,
    [Introducer] VARCHAR(100) NULL,
    [DpType] VARCHAR(4) NULL,
    [Def] INT NULL,
    [date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NBFC_RevData
-- --------------------------------------------------
CREATE TABLE [dbo].[NBFC_RevData]
(
    [segment] VARCHAR(5) NOT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [vamt] MONEY NULL,
    [reldt] DATETIME NULL,
    [int_days] INT NULL,
    [InstNo] VARCHAR(15) NULL,
    [Vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCDX_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[NCDX_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCDX_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[NCDX_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL DEFAULT ((0)),
    [UCV] MONEY NULL DEFAULT ((0)),
    [UnRecoCr] MONEY NULL DEFAULT ((0)),
    [OtherDr] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO_B2B
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO_B2B]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(25) NULL,
    [B2Bamt] MONEY NULL,
    [SettNo] INT NULL,
    [SettType] CHAR(1) NULL,
    [NARRATION] VARCHAR(234) NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO_BSEIPO
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO_BSEIPO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO_UnsetDr
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO_UnsetDr]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL,
    [UDebitV] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NRMS_BSECM_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[NRMS_BSECM_LEDGER]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nse_led
-- --------------------------------------------------
CREATE TABLE [dbo].[nse_led]
(
    [Exchange] VARCHAR(3) NOT NULL,
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecm_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecm_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEFO_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEFO_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Delivery Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSX_final1
-- --------------------------------------------------
CREATE TABLE [dbo].[NSX_final1]
(
    [ProcessDate] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [BSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSECM_ledger] MONEY NULL DEFAULT ((0)),
    [NSEFO_ledger] MONEY NULL DEFAULT ((0)),
    [MCX_ledger] MONEY NULL DEFAULT ((0)),
    [NCDEX_ledger] MONEY NULL DEFAULT ((0)),
    [MCD_ledger] MONEY NULL DEFAULT ((0)),
    [NSX_ledger] MONEY NULL DEFAULT ((0)),
    [BSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSECM_UnClear] MONEY NULL DEFAULT ((0)),
    [NSEFO_UnClear] MONEY NULL DEFAULT ((0)),
    [MCX_UnClear] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnClear] MONEY NULL DEFAULT ((0)),
    [MCD_UnClear] MONEY NULL DEFAULT ((0)),
    [NSX_UnClear] MONEY NULL DEFAULT ((0)),
    [BSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSECM_Shortage] MONEY NULL DEFAULT ((0)),
    [NSEFO_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NCDEX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [MCD_MrgnNet] MONEY NULL DEFAULT ((0)),
    [NSX_MrgnNet] MONEY NULL DEFAULT ((0)),
    [BSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSECM_NetPO] MONEY NULL DEFAULT ((0)),
    [NSEFO_NetPO] MONEY NULL DEFAULT ((0)),
    [MCX_NetPO] MONEY NULL DEFAULT ((0)),
    [NCDEX_NetPO] MONEY NULL DEFAULT ((0)),
    [MCD_NetPO] MONEY NULL DEFAULT ((0)),
    [NSX_NetPO] MONEY NULL DEFAULT ((0)),
    [TOTAL_NetPO] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSX_LD
-- --------------------------------------------------
CREATE TABLE [dbo].[NSX_LD]
(
    [Client Code] VARCHAR(50) NULL,
    [Span + Exp Margin] VARCHAR(50) NULL,
    [Peak Margin] VARCHAR(50) NULL,
    [Premium Value] VARCHAR(50) NULL,
    [MTM Loss] VARCHAR(50) NULL,
    [Shortfall] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter]
(
    [sdtcur] DATETIME NULL,
    [ldtcur] DATETIME NULL,
    [ldtprv] DATETIME NULL,
    [sdtnxt] DATETIME NULL,
    [curyear] TINYINT NULL,
    [vnoflag] SMALLINT NULL,
    [Match_BtoB] SMALLINT NULL,
    [Match_CtoC] SMALLINT NULL,
    [Maker_Checker] SMALLINT NULL,
    [branchflag] TINYINT NULL,
    [voucherprintflag] TINYINT NULL,
    [reportdays] INT NULL,
    [FLDAUTO] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PE_BadDebts_lbdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[PE_BadDebts_lbdetails]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [narration] VARCHAR(234) NULL,
    [Seg] VARCHAR(5) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PenalRev_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[PenalRev_Table]
(
    [RevDate] DATETIME NULL,
    [Party_Code] VARCHAR(10) NULL,
    [RevAmount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_BSE_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_BSE_omnesys]
(
    [sauda_date] DATETIME NULL,
    [USER_ID] VARCHAR(10) NOT NULL,
    [order_no] VARCHAR(20) NULL,
    [trade_no] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_FNO_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_FNO_omnesys]
(
    [sauda_date] DATETIME NOT NULL,
    [USER_ID] INT NOT NULL,
    [order_no] VARCHAR(16) NULL,
    [trade_no] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_MCDX_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_MCDX_omnesys]
(
    [sauda_date] DATETIME NOT NULL,
    [USER_ID] INT NOT NULL,
    [order_no] VARCHAR(15) NOT NULL,
    [trade_no] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_NCDX_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_NCDX_omnesys]
(
    [sauda_date] DATETIME NOT NULL,
    [USER_ID] INT NOT NULL,
    [order_no] VARCHAR(15) NOT NULL,
    [trade_no] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_NSECUR_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_NSECUR_omnesys]
(
    [sauda_date] DATETIME NOT NULL,
    [USER_ID] VARCHAR(15) NULL,
    [order_no] VARCHAR(16) NULL,
    [trade_no] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_omnesys
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_omnesys]
(
    [sauda_date] DATETIME NULL,
    [USER_ID] VARCHAR(10) NULL,
    [order_no] VARCHAR(16) NULL,
    [trade_no] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_trd_omnesys_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_trd_omnesys_nse]
(
    [sauda_date] DATETIME NULL,
    [USER_ID] VARCHAR(10) NULL,
    [order_no] VARCHAR(16) NULL,
    [trade_no] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.region
-- --------------------------------------------------
CREATE TABLE [dbo].[region]
(
    [Regioncode] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sauda_summaryJun302014
-- --------------------------------------------------
CREATE TABLE [dbo].[Sauda_summaryJun302014]
(
    [Exchange] VARCHAR(10) NULL,
    [TradeDate] SMALLDATETIME NULL,
    [TradeType] VARCHAR(2) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Inst_type] VARCHAR(10) NULL,
    [Symbol ] VARCHAR(20) NULL,
    [ExpiryDate] DATETIME NULL,
    [OPTION_TYPE] VARCHAR(5) NULL,
    [STRIKE_PRICE] SMALLMONEY NULL,
    [CL_RATE] SMALLMONEY NULL,
    [BUYQTY] INT NULL,
    [BUYRATE] SMALLMONEY NULL,
    [SELLQTY] SMALLMONEY NULL,
    [SELLRATE] SMALLMONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] VARCHAR(2) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SCRIP_NAME] VARCHAR(50) NULL,
    [LONG_NAME] VARCHAR(200) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(30) NULL,
    [L_ZIP] VARCHAR(20) NULL,
    [MOBILE_PAGER] VARCHAR(30) NULL,
    [RES_PHONE1] VARCHAR(30) NULL,
    [RES_PHONE2] VARCHAR(30) NULL,
    [OFF_PHONE1] VARCHAR(30) NULL,
    [REGION] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip1
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip1]
(
    [co_code] INT NULL,
    [series] VARCHAR(3) NOT NULL,
    [short_name] VARCHAR(50) NULL,
    [long_name] VARCHAR(50) NULL,
    [market_lot] INT NULL,
    [face_val] FLOAT NULL,
    [book_cl_dt] DATETIME NULL,
    [ex_div_dt] DATETIME NULL,
    [ex_bon_dt] DATETIME NULL,
    [ex_rit_dt] DATETIME NULL,
    [eqt_type] VARCHAR(3) NULL,
    [sub_type] VARCHAR(3) NULL,
    [agent_cd] VARCHAR(6) NULL,
    [demat_flag] SMALLINT NULL,
    [demat_date] DATETIME NULL,
    [rec1] VARCHAR(10) NULL,
    [rec2] VARCHAR(10) NULL,
    [rec3] VARCHAR(10) NULL,
    [rec4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.scrip2
-- --------------------------------------------------
CREATE TABLE [dbo].[scrip2]
(
    [co_code] INT NULL,
    [series] VARCHAR(3) NOT NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [scrip_cat] VARCHAR(3) NULL,
    [no_del_fr] DATETIME NULL,
    [no_del_to] DATETIME NULL,
    [cl_rate] FLOAT NULL,
    [clos_rate_dt] DATETIME NULL,
    [min_trd_qty] INT NULL,
    [BseCode] VARCHAR(10) NULL,
    [Isin] VARCHAR(20) NULL,
    [delsc_cat] VARCHAR(3) NULL,
    [Sector] VARCHAR(10) NULL,
    [Track] VARCHAR(1) NULL,
    [CDOL_No] VARCHAR(15) NULL,
    [Res1] VARCHAR(10) NULL,
    [Res2] VARCHAR(10) NULL,
    [Res3] VARCHAR(10) NULL,
    [Res4] VARCHAR(10) NULL,
    [Globalcustodian] VARCHAR(25) NULL,
    [common_code] VARCHAR(25) NULL,
    [IndexName] VARCHAR(10) NULL,
    [Industry] VARCHAR(10) NULL,
    [Bloomberg] VARCHAR(10) NULL,
    [RicCode] VARCHAR(10) NULL,
    [Reuters] VARCHAR(10) NULL,
    [IES] VARCHAR(10) NULL,
    [NoofIssuedshares] NUMERIC(18, 4) NULL,
    [Status] VARCHAR(10) NULL,
    [ADRGDRRatio] NUMERIC(18, 4) NULL,
    [GEMultiple] NUMERIC(18, 4) NULL,
    [GroupforGE] INT NULL,
    [RBICeilingIndicatorFlag] VARCHAR(2) NULL,
    [RBICeilingIndicatorValue] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL,
    [UnsettledDrBill] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_PO_BSEIPO
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_PO_BSEIPO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_PO_UnsetDr
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_PO_UnsetDr]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL,
    [UDebitV] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] CHAR(7) NOT NULL,
    [Start_date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.settlement
-- --------------------------------------------------
CREATE TABLE [dbo].[settlement]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(16) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(18, 4) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(18, 4) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(10) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sub_broker_list_02052018
-- --------------------------------------------------
CREATE TABLE [dbo].[sub_broker_list_02052018]
(
    [SBCode] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokers]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] VARCHAR(30) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AD_Backend_ChangeMst_User_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AD_Backend_ChangeMst_User_Mapping]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [EmpId] INT NULL,
    [QueryId] INT NULL,
    [CreateDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Ad_Deltrans_Series_Change_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Ad_Deltrans_Series_Change_Log]
(
    [OnDate] DATE NULL,
    [SNo] NUMERIC(18, 0) NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NOT NULL,
    [PartipantCode] VARCHAR(10) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [LogId] INT NULL,
    [NewSeries] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AD_DelTrans_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AD_DelTrans_Temp]
(
    [SettNo] VARCHAR(50) NULL,
    [SettType] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [Scrip] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [Records] VARCHAR(50) NULL,
    [qty] VARCHAR(50) NULL,
    [NewSeries] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AD_QueryChange_Mst
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AD_QueryChange_Mst]
(
    [QueryId] INT IDENTITY(1,1) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [DBServer] VARCHAR(20) NULL,
    [DB] VARCHAR(10) NULL,
    [SPName] VARCHAR(MAX) NULL,
    [FileType] VARCHAR(6) NULL,
    [SampleFile] VARCHAR(100) NULL,
    [CreatedBy] VARCHAR(20) NULL,
    [Createdate] DATETIME NULL DEFAULT (getdate()),
    [TempTable] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ADDBROK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ADDBROK]
(
    [SEGMENT] VARCHAR(5) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [ADD_BRK] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BACKUP_PROCESS_STATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BACKUP_PROCESS_STATUS]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [ProcessName] VARCHAR(100) NULL,
    [Status] VARCHAR(15) NULL,
    [Date] DATETIME NULL DEFAULT (getdate()),
    [RowsCount] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BUYDATA_UPD
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BUYDATA_UPD]
(
    [EXCHANGESEGMENT] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [PQTYDEL] INT NULL,
    [PAMTDEL] MONEY NULL,
    [PBROKDEL] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [OTHER_CHRG] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Cash_shortage_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Cash_shortage_test]
(
    [id] BIGINT NULL,
    [denseid] BIGINT NULL,
    [Priority_seg] INT NULL,
    [sqoffsseg] BIGINT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [segment] VARCHAR(5) NOT NULL,
    [TotalCash] MONEY NOT NULL,
    [TotalOblication] MONEY NOT NULL,
    [TotalNoncash] MONEY NOT NULL,
    [CashShortage] MONEY NOT NULL,
    [CashSurplus] MONEY NOT NULL,
    [NonCashShortage] MONEY NULL,
    [NonCashSurplus] MONEY NULL,
    [adjamt] MONEY NULL,
    [actualsqoffqty] INT NOT NULL,
    [avgrate] MONEY NULL,
    [replicaCashShortage] MONEY NOT NULL,
    [replicaCashSurplus] MONEY NOT NULL,
    [shortagereduction] MONEY NOT NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade1_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade1_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade2_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade2_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade3_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade3_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade4_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade4_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade5_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade5_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CNT_Omnesys_Trade6_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CNT_Omnesys_Trade6_temp]
(
    [ExhgSeg] VARCHAR(200) NULL,
    [UserId] VARCHAR(200) NULL,
    [AccountId] VARCHAR(200) NULL,
    [TradeDate] VARCHAR(200) NULL,
    [TradeTime] VARCHAR(200) NULL,
    [Participantcode] VARCHAR(200) NULL,
    [BuySell] VARCHAR(200) NULL,
    [TradingSymbol] VARCHAR(200) NULL,
    [ProductType] VARCHAR(200) NULL,
    [ExchangeOrderNo] VARCHAR(200) NULL,
    [TradePrice] VARCHAR(200) NULL,
    [TradeQty] VARCHAR(200) NULL,
    [BWL] VARCHAR(200) NULL,
    [OrderSource] VARCHAR(200) NULL,
    [NestOrderNo] VARCHAR(200) NULL,
    [PanNumber] VARCHAR(200) NULL,
    [AlgoIdentifier] VARCHAR(200) NULL,
    [ExchangeAlgoCategory] VARCHAR(200) NULL,
    [TradeExchange] VARCHAR(200) NULL,
    [OrderUserMessage] VARCHAR(200) NULL,
    [EQSIPRegistrationNo] VARCHAR(200) NULL,
    [GroupName] VARCHAR(200) NULL,
    [SpreadReferenceNo] VARCHAR(200) NULL,
    [ExchangeAccountId] VARCHAR(200) NULL,
    [QtyUnits] VARCHAR(200) NULL,
    [ModifiedByUser] VARCHAR(200) NULL,
    [AccountName] VARCHAR(200) NULL,
    [OrderPlacedBy] VARCHAR(200) NULL,
    [QtyInLots] VARCHAR(200) NULL,
    [GiveupIndicator] VARCHAR(200) NULL,
    [ModificationRemarks] VARCHAR(200) NULL,
    [ReportType] VARCHAR(200) NULL,
    [QtytoFill] VARCHAR(200) NULL,
    [AuctionNumber] VARCHAR(200) NULL,
    [BranchId] VARCHAR(200) NULL,
    [BrokerId] VARCHAR(200) NULL,
    [OptionType] VARCHAR(200) NULL,
    [MarketType] VARCHAR(200) NULL,
    [OrderType] VARCHAR(200) NULL,
    [Remarks] VARCHAR(200) NULL,
    [ProCli] VARCHAR(200) NULL,
    [TradeID] VARCHAR(200) NULL,
    [TradeStatus] VARCHAR(200) NULL,
    [ExpiryDate] VARCHAR(200) NULL,
    [StrikePrice] VARCHAR(200) NULL,
    [InstrumentName] VARCHAR(200) NULL,
    [Symbol] VARCHAR(200) NULL,
    [RequestId] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CTCL_Terminal_Data_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CTCL_Terminal_Data_Temp]
(
    [OdinId] VARCHAR(100) NULL,
    [Final_SB_Tag] VARCHAR(100) NULL,
    [Type] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CUSA_PAYOUT_DEALLOCATION_UPLOAD_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CUSA_PAYOUT_DEALLOCATION_UPLOAD_TEMP]
(
    [SETT_NO] VARCHAR(100) NULL,
    [TODP] VARCHAR(100) NULL,
    [CERTNO] VARCHAR(100) NULL,
    [QTY] VARCHAR(100) NULL,
    [PARTY_CODE] VARCHAR(100) NULL,
    [BNO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_dob_mismatch
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_dob_mismatch]
(
    [basicid] VARCHAR(50) NULL,
    [application_no] VARCHAR(50) NULL,
    [UserEnteredDob] DATE NULL,
    [PartyCode] VARCHAR(50) NULL,
    [Digi_DOB] DATE NULL,
    [DateDifferenceInDays] INT NULL,
    [age_as_per_user] VARCHAR(5) NULL,
    [age_as_per_Digi] VARCHAR(5) NULL,
    [Last_Trade_date] DATETIME NULL,
    [Filler1] VARCHAR(5) NULL,
    [Filler2] VARCHAR(5) NULL,
    [Filler3] VARCHAR(100) NULL,
    [Active_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_dob_mismatch_2020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_dob_mismatch_2020]
(
    [basicid] VARCHAR(50) NULL,
    [UserEnteredDob] VARCHAR(50) NULL,
    [PartyCode] VARCHAR(50) NULL,
    [DigiLockerDOB] VARCHAR(50) NULL,
    [DateDifferenceInDays] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_dob_mismatch_2021
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_dob_mismatch_2021]
(
    [basicid] VARCHAR(50) NULL,
    [UserEnteredDob] VARCHAR(50) NULL,
    [PartyCode] VARCHAR(50) NULL,
    [DigiLockerDOB] VARCHAR(50) NULL,
    [DateDifferenceInDays] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DP_M3_Holding_Balance_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DP_M3_Holding_Balance_tmp]
(
    [FILLER1] VARCHAR(MAX) NULL,
    [FILLER2] VARCHAR(MAX) NULL,
    [FILLER3] VARCHAR(MAX) NULL,
    [FILLER4] VARCHAR(MAX) NULL,
    [FILLER5] VARCHAR(MAX) NULL,
    [FILLER6] VARCHAR(MAX) NULL,
    [FILLER7] VARCHAR(MAX) NULL,
    [FILLER8] VARCHAR(MAX) NULL,
    [FILLER9] VARCHAR(MAX) NULL,
    [FILLER10] VARCHAR(MAX) NULL,
    [FILLER11] VARCHAR(MAX) NULL,
    [FILLER12] VARCHAR(MAX) NULL,
    [FILLER13] VARCHAR(MAX) NULL,
    [FILLER14] VARCHAR(MAX) NULL,
    [FILLER15] VARCHAR(MAX) NULL,
    [FILLER16] VARCHAR(MAX) NULL,
    [FILLER17] VARCHAR(MAX) NULL,
    [FILLER18] VARCHAR(MAX) NULL,
    [FILLER19] VARCHAR(MAX) NULL,
    [FILLER20] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_DBServer_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_DBServer_Mapping]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [DBServerId] INT NULL,
    [EmpId] INT NULL,
    [CreateDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Emp_Role_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Emp_Role_Mapping]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [EmpId] INT NULL,
    [RoleId] INT NULL,
    [CreateDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_EmpDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_EmpDetails]
(
    [EmpId] INT IDENTITY(1,1) NOT NULL,
    [EmpCode] VARCHAR(30) NULL,
    [Pass] VARCHAR(100) NULL,
    [FullName] VARCHAR(100) NULL,
    [ParentId] INT NULL,
    [CreatedBy] VARCHAR(10) NULL,
    [Createdate] DATETIME NULL DEFAULT (getdate()),
    [UserName] VARCHAR(50) NULL,
    [EmpName] VARCHAR(100) NULL,
    [Dept] VARCHAR(100) NULL,
    [LastLoginDate] DATETIME NULL,
    [version] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FileUploadMaker_Checker_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FileUploadMaker_Checker_Log]
(
    [MakerCheckerId] INT IDENTITY(1,1) NOT NULL,
    [UploadeDate] DATE NULL,
    [UploadTypeId] INT NULL,
    [UploadSubTypeId] INT NULL,
    [MakerBy] INT NULL,
    [MakerDateTime] DATETIME NULL DEFAULT (getdate()),
    [IsChecked] BIT NULL DEFAULT ((0)),
    [TempTableName] VARCHAR(100) NULL,
    [RecordCount] INT NULL,
    [FileName] VARCHAR(100) NULL,
    [FilePath] VARCHAR(500) NULL,
    [SourceServer] VARCHAR(50) NULL,
    [DPM3_M4_Progress] VARCHAR(20) NULL,
    [CheckerBy] INT NULL,
    [CheckerDateTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FileUploadMst
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FileUploadMst]
(
    [UploadTypeId] INT IDENTITY(1,1) NOT NULL,
    [UploadType] VARCHAR(50) NULL,
    [ParentId_PK] INT NULL DEFAULT ((0)),
    [SampleFormat] VARCHAR(20) NULL,
    [DBServer] VARCHAR(30) NULL,
    [DB] VARCHAR(20) NULL,
    [CreatedBy] VARCHAR(10) NULL,
    [Createdate] DATETIME NULL DEFAULT (getdate()),
    [UserName] VARCHAR(10) NULL,
    [Pass] VARCHAR(50) NULL,
    [TempTable] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FileUploadUserMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FileUploadUserMapping]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [UploadTypeId] INT NULL,
    [EmpId] INT NULL,
    [CreateDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_General_Application_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_General_Application_Log]
(
    [LogId] INT IDENTITY(1,1) NOT NULL,
    [LoginId] VARCHAR(30) NULL,
    [Task] VARCHAR(100) NULL,
    [Page] VARCHAR(100) NULL,
    [Action] VARCHAR(500) NULL,
    [Error] VARCHAR(500) NULL,
    [CreatedDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LoginDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LoginDetails]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [EmpCode] VARCHAR(10) NULL,
    [Pass] VARCHAR(100) NULL,
    [FullName] VARCHAR(100) NULL,
    [ParentId] INT NULL,
    [CreatedBy] VARCHAR(10) NULL,
    [Createdate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_Cash
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_Cash]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Var_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL,
    [Prev_Var_Margin] VARCHAR(100) NOT NULL,
    [Prev_MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_Cash_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_Cash_HIST]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Var_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL,
    [Prev_Var_Margin] VARCHAR(100) NOT NULL,
    [Prev_MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_currency
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_currency]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Span_Exp_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [Delivery_Margin] VARCHAR(100) NOT NULL,
    [Premium_Value] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_MCDX
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_MCDX]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Span_Exp_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [Delivery_Margin] VARCHAR(100) NOT NULL,
    [Premium_Value] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_NCDX
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_NCDX]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Span_Exp_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [Delivery_Margin] VARCHAR(100) NOT NULL,
    [Premium_Value] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_margin_NCFO
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_margin_NCFO]
(
    [Client_Code] VARCHAR(100) NOT NULL,
    [Span_Exp_Margin] VARCHAR(100) NOT NULL,
    [Peak_Margin] VARCHAR(100) NOT NULL,
    [Delivery_Margin] VARCHAR(100) NOT NULL,
    [Premium_Value] VARCHAR(100) NOT NULL,
    [MTM_Loss] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MICR_IFSC_UPD_UPLOAD_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MICR_IFSC_UPD_UPLOAD_TMP]
(
    [BANK_NAME] VARCHAR(100) NULL,
    [IFSC_CODE] VARCHAR(25) NULL,
    [MICR_CODE] VARCHAR(25) NULL,
    [BRANCH_NAME] VARCHAR(150) NULL,
    [ADDRESS] VARCHAR(255) NULL,
    [DISTRICT] VARCHAR(255) NULL,
    [STATE] VARCHAR(255) NULL,
    [PINCCODE] VARCHAR(20) NULL,
    [UserName] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NCMS_Peak_margin_file_NSX
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NCMS_Peak_margin_file_NSX]
(
    [Trade date] VARCHAR(100) NULL,
    [Client Code] VARCHAR(100) NULL,
    [SPAN Margin] VARCHAR(100) NULL,
    [Filler] VARCHAR(100) NULL,
    [Extreme Loss Margin] VARCHAR(100) NULL,
    [Margin on consolidated crystallized obligation] VARCHAR(100) NULL,
    [Total margin to be collected (SPAN Margin + Extreme Loss Margin)] VARCHAR(100) NULL,
    [Client/Proprietary Flag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_omni_offline_trade
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_omni_offline_trade]
(
    [Exhg. Seg] NVARCHAR(MAX) NULL,
    [UserId] NVARCHAR(MAX) NULL,
    [Account Id] NVARCHAR(MAX) NULL,
    [Trade Date] NVARCHAR(MAX) NULL,
    [Trade Time] NVARCHAR(MAX) NULL,
    [Participant code] NVARCHAR(MAX) NULL,
    [Buy/Sell] NVARCHAR(MAX) NULL,
    [Trading Symbol] NVARCHAR(MAX) NULL,
    [Product Type] NVARCHAR(MAX) NULL,
    [ExchangeOrderNo] NVARCHAR(MAX) NULL,
    [Trade Price] NVARCHAR(MAX) NULL,
    [Trade Qty] NVARCHAR(MAX) NULL,
    [B - W - L] NVARCHAR(MAX) NULL,
    [Order Source] NVARCHAR(MAX) NULL,
    [NestOrderNo] NVARCHAR(MAX) NULL,
    [Pan Number] NVARCHAR(MAX) NULL,
    [Algo Identifier] NVARCHAR(MAX) NULL,
    [Exchange Algo Category] NVARCHAR(MAX) NULL,
    [Trade Exchange] NVARCHAR(MAX) NULL,
    [Order User Message] NVARCHAR(MAX) NULL,
    [EQ SIP Registration No] NVARCHAR(MAX) NULL,
    [Group Name] NVARCHAR(MAX) NULL,
    [Spread Reference No] NVARCHAR(MAX) NULL,
    [Exchange Account Id] NVARCHAR(MAX) NULL,
    [Qty Units] NVARCHAR(MAX) NULL,
    [Modified By User] NVARCHAR(MAX) NULL,
    [Account Name] NVARCHAR(MAX) NULL,
    [Order Placed By] NVARCHAR(MAX) NULL,
    [Qty In Lots] NVARCHAR(MAX) NULL,
    [Giveup Indicator] NVARCHAR(MAX) NULL,
    [Modification Remarks] NVARCHAR(MAX) NULL,
    [Report Type] NVARCHAR(MAX) NULL,
    [Qty to Fill] NVARCHAR(MAX) NULL,
    [Auction Number] NVARCHAR(MAX) NULL,
    [BranchId] NVARCHAR(MAX) NULL,
    [BrokerId] NVARCHAR(MAX) NULL,
    [Option Type] NVARCHAR(MAX) NULL,
    [Market Type] NVARCHAR(MAX) NULL,
    [Order Type] NVARCHAR(MAX) NULL,
    [Remarks] NVARCHAR(MAX) NULL,
    [Pro/Cli] NVARCHAR(MAX) NULL,
    [Trade ID] NVARCHAR(MAX) NULL,
    [Trade Status] NVARCHAR(MAX) NULL,
    [ExpiryDate] NVARCHAR(MAX) NULL,
    [Strike Price] NVARCHAR(MAX) NULL,
    [InstrumentName] NVARCHAR(MAX) NULL,
    [Symbol] NVARCHAR(MAX) NULL,
    [RequestId] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_omni_offline_trade_null
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_omni_offline_trade_null]
(
    [Exhg. Seg] NVARCHAR(MAX) NULL,
    [UserId] NVARCHAR(MAX) NULL,
    [Account Id] NVARCHAR(MAX) NULL,
    [Trade Date] NVARCHAR(MAX) NULL,
    [Trade Time] NVARCHAR(MAX) NULL,
    [Participant code] NVARCHAR(MAX) NULL,
    [Buy/Sell] NVARCHAR(MAX) NULL,
    [Trading Symbol] NVARCHAR(MAX) NULL,
    [Product Type] NVARCHAR(MAX) NULL,
    [ExchangeOrderNo] NVARCHAR(MAX) NULL,
    [Trade Price] NVARCHAR(MAX) NULL,
    [Trade Qty] NVARCHAR(MAX) NULL,
    [B - W - L] NVARCHAR(MAX) NULL,
    [Order Source] NVARCHAR(MAX) NULL,
    [NestOrderNo] NVARCHAR(MAX) NULL,
    [Pan Number] NVARCHAR(MAX) NULL,
    [Algo Identifier] NVARCHAR(MAX) NULL,
    [Exchange Algo Category] NVARCHAR(MAX) NULL,
    [Trade Exchange] NVARCHAR(MAX) NULL,
    [Order User Message] NVARCHAR(MAX) NULL,
    [EQ SIP Registration No] NVARCHAR(MAX) NULL,
    [Group Name] NVARCHAR(MAX) NULL,
    [Spread Reference No] NVARCHAR(MAX) NULL,
    [Exchange Account Id] NVARCHAR(MAX) NULL,
    [Qty Units] NVARCHAR(MAX) NULL,
    [Modified By User] NVARCHAR(MAX) NULL,
    [Account Name] NVARCHAR(MAX) NULL,
    [Order Placed By] NVARCHAR(MAX) NULL,
    [Qty In Lots] NVARCHAR(MAX) NULL,
    [Giveup Indicator] NVARCHAR(MAX) NULL,
    [Modification Remarks] NVARCHAR(MAX) NULL,
    [Report Type] NVARCHAR(MAX) NULL,
    [Qty to Fill] NVARCHAR(MAX) NULL,
    [Auction Number] NVARCHAR(MAX) NULL,
    [BranchId] NVARCHAR(MAX) NULL,
    [BrokerId] NVARCHAR(MAX) NULL,
    [Option Type] NVARCHAR(MAX) NULL,
    [Market Type] NVARCHAR(MAX) NULL,
    [Order Type] NVARCHAR(MAX) NULL,
    [Remarks] NVARCHAR(MAX) NULL,
    [Pro/Cli] NVARCHAR(MAX) NULL,
    [Trade ID] NVARCHAR(MAX) NULL,
    [Trade Status] NVARCHAR(MAX) NULL,
    [ExpiryDate] NVARCHAR(MAX) NULL,
    [Strike Price] NVARCHAR(MAX) NULL,
    [InstrumentName] NVARCHAR(MAX) NULL,
    [Symbol] NVARCHAR(MAX) NULL,
    [RequestId] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_omni_offline_trade_null_date
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_omni_offline_trade_null_date]
(
    [Exhg. Seg] NVARCHAR(MAX) NULL,
    [UserId] NVARCHAR(MAX) NULL,
    [Account Id] NVARCHAR(MAX) NULL,
    [Trade Date] NVARCHAR(MAX) NULL,
    [Trade Time] NVARCHAR(MAX) NULL,
    [Participant code] NVARCHAR(MAX) NULL,
    [Buy/Sell] NVARCHAR(MAX) NULL,
    [Trading Symbol] NVARCHAR(MAX) NULL,
    [Product Type] NVARCHAR(MAX) NULL,
    [ExchangeOrderNo] NVARCHAR(MAX) NULL,
    [Trade Price] NVARCHAR(MAX) NULL,
    [Trade Qty] NVARCHAR(MAX) NULL,
    [B - W - L] NVARCHAR(MAX) NULL,
    [Order Source] NVARCHAR(MAX) NULL,
    [NestOrderNo] NVARCHAR(MAX) NULL,
    [Pan Number] NVARCHAR(MAX) NULL,
    [Algo Identifier] NVARCHAR(MAX) NULL,
    [Exchange Algo Category] NVARCHAR(MAX) NULL,
    [Trade Exchange] NVARCHAR(MAX) NULL,
    [Order User Message] NVARCHAR(MAX) NULL,
    [EQ SIP Registration No] NVARCHAR(MAX) NULL,
    [Group Name] NVARCHAR(MAX) NULL,
    [Spread Reference No] NVARCHAR(MAX) NULL,
    [Exchange Account Id] NVARCHAR(MAX) NULL,
    [Qty Units] NVARCHAR(MAX) NULL,
    [Modified By User] NVARCHAR(MAX) NULL,
    [Account Name] NVARCHAR(MAX) NULL,
    [Order Placed By] NVARCHAR(MAX) NULL,
    [Qty In Lots] NVARCHAR(MAX) NULL,
    [Giveup Indicator] NVARCHAR(MAX) NULL,
    [Modification Remarks] NVARCHAR(MAX) NULL,
    [Report Type] NVARCHAR(MAX) NULL,
    [Qty to Fill] NVARCHAR(MAX) NULL,
    [Auction Number] NVARCHAR(MAX) NULL,
    [BranchId] NVARCHAR(MAX) NULL,
    [BrokerId] NVARCHAR(MAX) NULL,
    [Option Type] NVARCHAR(MAX) NULL,
    [Market Type] NVARCHAR(MAX) NULL,
    [Order Type] NVARCHAR(MAX) NULL,
    [Remarks] NVARCHAR(MAX) NULL,
    [Pro/Cli] NVARCHAR(MAX) NULL,
    [Trade ID] NVARCHAR(MAX) NULL,
    [Trade Status] NVARCHAR(MAX) NULL,
    [ExpiryDate] NVARCHAR(MAX) NULL,
    [Strike Price] NVARCHAR(MAX) NULL,
    [InstrumentName] NVARCHAR(MAX) NULL,
    [Symbol] NVARCHAR(MAX) NULL,
    [RequestId] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_peakMarginfile
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_peakMarginfile]
(
    [Tradedate] DATETIME NULL,
    [Clientcode] VARCHAR(20) NULL,
    [TotalPeakMargin] MONEY NULL,
    [FOMargin] MONEY NULL,
    [NScurMargin] MONEY NULL,
    [BSEcurMargin] MONEY NULL,
    [Mcxmargin] MONEY NULL,
    [Ncdexmargin] MONEY NULL,
    [EqMargin] MONEY NULL,
    [UploadStartTime] DATETIME NULL,
    [UploadENDTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_peakMarginfile_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_peakMarginfile_hist]
(
    [Tradedate] DATETIME NULL,
    [Clientcode] VARCHAR(20) NULL,
    [TotalPeakMargin] MONEY NULL,
    [FOMargin] MONEY NULL,
    [NScurMargin] MONEY NULL,
    [BSEcurMargin] MONEY NULL,
    [Mcxmargin] MONEY NULL,
    [Ncdexmargin] MONEY NULL,
    [EqMargin] MONEY NULL,
    [UploadStartTime] DATETIME NULL,
    [UploadENDTime] DATETIME NULL,
    [LastUpdateddate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Quarterly_Cash_SaudaSummary_Mimansa
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Quarterly_Cash_SaudaSummary_Mimansa]
(
    [EXCHANGE] VARCHAR(50) NULL,
    [TRDTYPE] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(20) NULL,
    [TRADEDATE] VARCHAR(50) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SCRIP_NAME] VARCHAR(150) NULL,
    [SETT_NO] VARCHAR(50) NULL,
    [SETT_TYPE] VARCHAR(50) NULL,
    [BUYQTY] BIGINT NULL,
    [BUYAVGRATE] MONEY NULL,
    [BUYAMOUNT] MONEY NULL,
    [SELLQTY] BIGINT NULL,
    [SELLAVGRATE] MONEY NULL,
    [SELLAMOUNT] MONEY NULL,
    [NETQTY] BIGINT NULL,
    [NETAVGRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [FLAG] INT NULL,
    [LONG_NAME] VARCHAR(150) NULL,
    [BRANCH_CD] VARCHAR(20) NULL,
    [SUB_BROKER] VARCHAR(20) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(50) NULL,
    [MOBILE_PAGER] VARCHAR(50) NULL,
    [RES_PHONE1] VARCHAR(50) NULL,
    [RES_PHONE2] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_REBILLING_UPD
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_REBILLING_UPD]
(
    [EXCHANGESEGMENT] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [PQTYDEL] INT NULL,
    [PAMTDEL] MONEY NULL,
    [PBROKDEL] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [OTHER_CHRG] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_RoleMst
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_RoleMst]
(
    [RoleId] INT IDENTITY(1,1) NOT NULL,
    [RoleName] VARCHAR(20) NULL,
    [CreatedDate] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCSANNEXURE_A_TEMP_Bak_14102022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCSANNEXURE_A_TEMP_Bak_14102022]
(
    [PARTY_CODE] VARCHAR(20) NULL,
    [UNENCUMBERED_BAL] MONEY NULL,
    [UNENCUMBERED_MARGIN] MONEY NULL,
    [VALUE_SECURITIESTDAY] MONEY NULL,
    [FUNDS_RETAINED] MONEY NULL,
    [VALUE_SECURITIESRETAINED] MONEY NULL,
    [FUNDS_RELEASED] MONEY NULL,
    [SECURITIES_RELEASED] MONEY NULL,
    [OTHERSEGMENTDEBIT] MONEY NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Server_DBServerAccess
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Server_DBServerAccess]
(
    [DBServerId] INT IDENTITY(1,1) NOT NULL,
    [IPAdd] VARCHAR(50) NULL,
    [Port] INT NULL,
    [Segment] VARCHAR(50) NULL,
    [DB] VARCHAR(100) NULL,
    [Remarks] VARCHAR(100) NULL,
    [OwnerShipTeam] VARCHAR(20) NULL,
    [ServerOwner] VARCHAR(50) NULL,
    [CreateDate] DATETIME NULL DEFAULT (getdate()),
    [DBUserName] VARCHAR(10) NULL,
    [DBPass] VARCHAR(20) NULL,
    [DBUserName_Citrus] VARCHAR(10) NULL,
    [DBPass_Citrus] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TmppeakMarginfile
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TmppeakMarginfile]
(
    [Tradedate] VARCHAR(25) NULL,
    [Clientcode] VARCHAR(20) NULL,
    [TotalPeakMargin] MONEY NULL,
    [FOMargin] MONEY NULL,
    [NScurMargin] MONEY NULL,
    [BSEcurMargin] MONEY NULL,
    [Mcxmargin] MONEY NULL,
    [Ncdexmargin] MONEY NULL,
    [EqMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_VIRTUAL_MIS_LEDGER_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_VIRTUAL_MIS_LEDGER_temp]
(
    [BusinessDate] VARCHAR(200) NULL,
    [VANumber] VARCHAR(200) NULL,
    [Channel] VARCHAR(200) NULL,
    [TransactionAmount] VARCHAR(200) NULL,
    [TransactionDetails1] VARCHAR(200) NULL,
    [TransactionDetails2] VARCHAR(200) NULL,
    [TransactionDetails3] VARCHAR(200) NULL,
    [TransactionDetails4] VARCHAR(200) NULL,
    [TransactionDetails5] VARCHAR(200) NULL,
    [TransactionDetails6] VARCHAR(200) NULL,
    [TransactionDetails7] VARCHAR(200) NULL,
    [TransactionDetails8] VARCHAR(200) NULL,
    [TransactionDetails9] VARCHAR(200) NULL,
    [TransactionDetails10] VARCHAR(200) NULL,
    [TransactionDetails11] VARCHAR(200) NULL,
    [TransactionDetails12] VARCHAR(200) NULL,
    [TransactionDetails13] VARCHAR(200) NULL,
    [TransactionDetails14] VARCHAR(200) NULL,
    [TransactionDetails15] VARCHAR(200) NULL,
    [TransactionDetails16] VARCHAR(200) NULL,
    [TransactionDetails17] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_VIRTUAL_MIS_LEDGER_temp_1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_VIRTUAL_MIS_LEDGER_temp_1]
(
    [Business_Date] DATE NULL,
    [VA_Number] NVARCHAR(50) NULL,
    [Channel] NVARCHAR(50) NULL,
    [Transaction_Amount] FLOAT NULL,
    [Transaction_Details1] NVARCHAR(50) NULL,
    [Transaction_Details2] NVARCHAR(1) NULL,
    [Transaction_Details3] NVARCHAR(50) NULL,
    [Transaction_Details4] NVARCHAR(50) NULL,
    [Transaction_Details5] NVARCHAR(50) NULL,
    [Transaction_Details6] NVARCHAR(50) NULL,
    [Transaction_Details7] NVARCHAR(50) NULL,
    [Transaction_Details8] NVARCHAR(50) NULL,
    [Transaction_Details9] NVARCHAR(50) NULL,
    [Transaction_Details10] NVARCHAR(1) NULL,
    [Transaction_Details11] NVARCHAR(1) NULL,
    [Transaction_Details12] NVARCHAR(1) NULL,
    [Transaction_Details13] NVARCHAR(1) NULL,
    [Transaction_Details14] NVARCHAR(1) NULL,
    [Transaction_Details15] NVARCHAR(1) NULL,
    [Transaction_Details16] NVARCHAR(1) NULL,
    [Transaction_Details17] NVARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_VIRTUAL_MIS_LEDGER_temp_917
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_VIRTUAL_MIS_LEDGER_temp_917]
(
    [Business_Date] DATE NULL,
    [VA_Number] NVARCHAR(50) NULL,
    [Channel] NVARCHAR(50) NULL,
    [Transaction_Amount] FLOAT NULL,
    [Transaction_Details1] NVARCHAR(50) NULL,
    [Transaction_Details2] NVARCHAR(1) NULL,
    [Transaction_Details3] NVARCHAR(50) NULL,
    [Transaction_Details4] NVARCHAR(50) NULL,
    [Transaction_Details5] NVARCHAR(50) NULL,
    [Transaction_Details6] NVARCHAR(50) NULL,
    [Transaction_Details7] NVARCHAR(50) NULL,
    [Transaction_Details8] NVARCHAR(50) NULL,
    [Transaction_Details9] NVARCHAR(50) NULL,
    [Transaction_Details10] NVARCHAR(1) NULL,
    [Transaction_Details11] NVARCHAR(1) NULL,
    [Transaction_Details12] NVARCHAR(1) NULL,
    [Transaction_Details13] NVARCHAR(1) NULL,
    [Transaction_Details14] NVARCHAR(1) NULL,
    [Transaction_Details15] NVARCHAR(1) NULL,
    [Transaction_Details16] NVARCHAR(1) NULL,
    [Transaction_Details17] NVARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp
-- --------------------------------------------------
CREATE TABLE [dbo].[temp]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [EmpId] INT NULL,
    [RoleId] INT NULL,
    [CreateDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [EmpId] INT NULL,
    [RoleId] INT NULL,
    [CreateDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempbse
-- --------------------------------------------------
CREATE TABLE [dbo].[tempbse]
(
    [cltcode] VARCHAR(10) NULL,
    [vtyp] SMALLINT NOT NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trade_summary
-- --------------------------------------------------
CREATE TABLE [dbo].[trade_summary]
(
    [Party_Code] VARCHAR(10) NULL,
    [sauda_date] VARCHAR(11) NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [series] VARCHAR(3) NOT NULL,
    [Trade_Type] VARCHAR(8) NOT NULL,
    [Buyqty] INT NULL,
    [Sellqty] INT NULL,
    [Buy_Turover] MONEY NULL,
    [Sell_Turover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [Service_tax] MONEY NULL,
    [STT] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [turntax] MONEY NULL,
    [Stamp_duty] MONEY NULL,
    [other_charges] MONEY NULL,
    [ISIN] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.U2927
-- --------------------------------------------------
CREATE TABLE [dbo].[U2927]
(
    [Sett_No] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [BillNo] VARCHAR(10) NULL,
    [ContractNo] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Scrip_Name] VARCHAR(50) NULL,
    [ISIN] VARCHAR(12) NULL,
    [Sauda_Date] DATETIME NULL,
    [PQtyTrd] INT NULL,
    [PAmtTrd] MONEY NULL,
    [PQtyDel] INT NULL,
    [PAmtDel] MONEY NULL,
    [SQtyTrd] INT NULL,
    [SAmtTrd] MONEY NULL,
    [SQtyDel] INT NULL,
    [SAmtDel] MONEY NULL,
    [PBrokTrd] MONEY NULL,
    [SBrokTrd] MONEY NULL,
    [PBrokDel] MONEY NULL,
    [SBrokDel] MONEY NULL,
    [Family] VARCHAR(10) NULL,
    [Family_Name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [ClientType] VARCHAR(10) NULL,
    [TradeType] VARCHAR(3) NULL,
    [Trader] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Pamt] MONEY NOT NULL,
    [Samt] MONEY NOT NULL,
    [PRate] MONEY NULL,
    [SRate] MONEY NULL,
    [TrdAmt] MONEY NULL,
    [DelAmt] MONEY NULL,
    [SerInEx] SMALLINT NULL,
    [Service_Tax] MONEY NULL,
    [ExService_Tax] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Region] VARCHAR(50) NULL,
    [Start_Date] VARCHAR(11) NULL,
    [End_Date] VARCHAR(11) NULL,
    [Update_Date] VARCHAR(11) NULL,
    [Status_Name] VARCHAR(15) NULL,
    [Exchange] VARCHAR(5) NULL,
    [Segment] VARCHAR(10) NULL,
    [MemberType] VARCHAR(3) NULL,
    [CompanyName] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL,
    [Dummy3] VARCHAR(1) NULL,
    [Dummy4] MONEY NULL,
    [Dummy5] MONEY NULL,
    [Area] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Unpleadge_po
-- --------------------------------------------------
CREATE TABLE [dbo].[Unpleadge_po]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [ShortDesc] CHAR(6) NULL,
    [DispFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.AIAAS_ExEmpActiveLogin
-- --------------------------------------------------
CREATE View AIAAS_ExEmpActiveLogin    
as    
select fldusername as BO_LoginId,emp_no,Emp_name,designation,CostCode,separationdate,CategoryDesc,Department,Sr_Name from    
(select * from AIAAS_UserInfo where active='Yes') a,    
intranet.risk.dbo.Vw_EmpInfoBlock  b 
where CHARINDEX(b.emp_no,fldusername) > 0

GO

-- --------------------------------------------------
-- VIEW dbo.AIAAS_UserInfo
-- --------------------------------------------------

CREATE View AIAAS_UserInfo  
as  
select a.fldauto,fldusername,username=fldfirstname+' '+fldmiddlename+' '+fldlastname,
Active=(Case   
when isnull(b.fldstatus,9)=0 then 'Yes'   
when isnull(b.fldstatus,9)=1 then 'No'   
else 'Missing' end)  
from bsedb_Ab.dbo.tblpradnyausers a with (nolock) left outer join bsedb_Ab.dbo.tblUserControlMaster b with (nolock)  
on a.fldauto=b.flduserid  
where fldadminauto in (1,2,1162,1163)

GO

-- --------------------------------------------------
-- VIEW dbo.Angel_CMS_client_deposit_recno
-- --------------------------------------------------
CREATE VIEW Angel_CMS_client_deposit_recno
AS
SELECT 
accno,vtyp,booktype,vno,vdt,tdate,ddno,cltcode,acname,drcr,Dramt,Cramt,treldt,refno,last_Date
FROM 
BO_client_deposit_recno WITH (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CliLedBal
-- --------------------------------------------------
CREATE View CliLedBal  
as  
select a.*,isnull(b.Cramt,0) as UnClearAmt, ClearBal=a.balance+isnull(b.Cramt,0) from   
(select cltcode,balance=sum(case when drcr='D' then vamt else -vamt end)  
from account_Ab.dbo.ledger with (nolock)   
where vdt >= (select sdtcur from account_Ab.dbo.parameter with (nolock) where sdtcur <= getdate() and ldtcur >= getdate())  
and vdt <=getdate()+1 and isnumeric(cltcode)=0 group by cltcode  
) a left outer join  
(select cltcode,cramt=sum(cramt) from account_Ab.dbo.Angel_client_deposit_recno with (nolock) group by cltcode) b   
on a.cltcode=b.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.Fragmentaion_details
-- --------------------------------------------------
create view Fragmentaion_details
as 

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent > 0

GO

-- --------------------------------------------------
-- VIEW dbo.NBFC_CliLedBal
-- --------------------------------------------------
CREATE View NBFC_CliLedBal
as
select   
a.cltcode,  
BSE=sum(case when drcr='D' then vamt else vamt*-1 end)   
from account_ab.dbo.ledger a with(nolock) , (
select cltcode from intranet.risk.dbo.nbfc_client_codes with (nolock)) b  
where vdt>=
(select sdtcur from account_ab.dbo.parameter with (nolock) where sdtcur <= getdate() and ldtcur>=getdate())
and vdt<=convert(char(11),getdate()-1)+' 23:59:59'
and a.cltcode=b.cltcode  
group by a.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.ROE_Bank_Balance
-- --------------------------------------------------
create view ROE_Bank_Balance
as
select b.branch_Code,b.segment,a.cltcode,Fund_Balance=sum(case when drcr='D' then -vamt else vamt end)            
from  
(select cltcode,drcr,vamt,vdt from account_ab.dbo.ledger with (nolock) where vdt >=
(select sdtcur from account_ab.dbo.parameter with (nolock) where sdtcur <=getdate() and ldtcur >=getdate())   
and vdt<=getdate()) a,            
(select * from intranet.roe.dbo.FF_bank_Details with (nolock) where segment='BSECM') b            
where a.cltcode=b.cltcode            
group by b.branch_Code,b.segment,a.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.ROE_GetAcMast
-- --------------------------------------------------
create view ROE_GetAcMast
as
select cltcode from account_ab.dbo.acmast with (nolock) where       
grpcode in (select grpcode from intranet.roe.dbo.ff_bank_grpcode with (nolock) where segment='BSECM')      
and cltcode not in (SELECT CLTCODE FROM intranet.roe.dbo.FF_REJ_BANK_DETAILS with (nolock) WHERE SEGMENT='BSECM')      
and cltcode not in (select cltcode from intranet.roe.dbo.ff_bank_details with (nolock) where segment='BSECM' and cltcode <> 0)      
and branchcode not in (select distinct(branch_code) from intranet.roe.dbo.ff_bank_details with (nolock) where branch_code <> 'HO')

GO

-- --------------------------------------------------
-- VIEW dbo.ROE_GetHOfund
-- --------------------------------------------------
CREATE view ROE_GetHOfund
as
select Fund_balance=sum(case when drcr='D' then -vamt else vamt end)  
from account_ab.dbo.ledger (nolock) where vdt >=
(select sdtcur from account_ab.dbo.parameter with (nolock) where sdtcur <=getdate() and ldtcur >=getdate())   
and vdt<=getdate()and cltcode in (select cltcode from ROE_GetAcMast)

GO

-- --------------------------------------------------
-- VIEW dbo.V_ING_Inactive_Customer_Report
-- --------------------------------------------------
Create view V_ING_Inactive_Customer_Report
as
(
select cl_status,Short_name as clientName,party_code as Customer_Code,dpid1,cltdpid1,case when bse_last_date>nse_last_date 
then bse_last_date else nse_last_date end as Last_Transaction_Date,ac_num as CASA_Number
from intranet.risk.dbo.client_details where cl_type='NRI' and bse_last_date<>'1900-01-01 00:00:00.000' and nse_last_date<>'1900-01-01 00:00:00.000'
and last_inactive_date>getdate() and (bse_last_date<getdate()-30 or nse_last_date<getdate()-30))

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_2927
-- --------------------------------------------------
CREATE view Vw_2927  
as  
select * from  
(  
select 'C'as flag,* from bsedb_Ab.dbo.cmbillvalan where party_code in ('U2927','R20816','P14467','M36073','M1114') 
and sauda_date > (select max(sauda_date) from u2927)  
union all  
select 'A' as flag,* from U2927  
) x where scrip_Cd <> 'BRKSCR'

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_KYC_BankReco_02006
-- --------------------------------------------------


create View Vw_KYC_BankReco_02006
as

select * from (select tdate=convert(varchar,l.vdt,103), cltcode = isnull(cltcode ,'') , 
acname=isnull( acname ,''), vno=l.vno, drcr=l.drcr ,lno=l.lno, vtyp=l.vtyp,chequeno=isnull(ddno,''), /*refno= l.refno ,*/
amt= l.vamt,reldt=convert(varchar,ll1.reldt,103),booktype=l.booktype, 
ageing =datediff(dd,vdt,reldt) 
From account_ab.dbo.ledger l (nolock) , account_ab.dbo.LEDGER1 ll1 (nolock) 
WHERE l.vtyp in ('2','3','5','16','17','19','20' ) 
and cltcode <>'02006'
and ll1.vno=l.vno and ll1.vtyp=l.vtyp and ll1.booktype= l.booktype and ll1.lno = l.lno and ll1.drcr=l.drcr 
and l.vno in 
(select vno from account_ab.dbo.ledger l1 (nolock) where cltcode ='02006' and l.vtyp=l1.vtyp and booktype=l1.booktype) 
and 
ll1.reldt <>'1900-01-01 00:00:00.000' 
and vdt >= convert(varchar(11),getdate()-30) and vdt < = convert(varchar(11),getdate())+' 23:59:59' 
and l.drcr like '%')a left outer join 
(select cl_code as party_code,sub_broker,branch_cd from bsedb_ab.dbo.client1 with (nolock)) b on a.cltcode=b.party_code

GO

