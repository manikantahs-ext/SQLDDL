-- DDL Export
-- Server: 10.253.50.28
-- Database: CTCL
-- Exported: 2026-02-01T02:30:19.947181

USE CTCL;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.get_code
-- --------------------------------------------------
CREATE function get_code(@brcode varchar(10))                        
returns varchar(10)                        
as                        
BEGIN                        
declare @icode as varchar(10),@icode1 as varchar(10),@code as varchar(10),@NOR AS INT                       
--set @brcode='KAND'            
             
select @icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end) from risk.dbo.region where code=@brcode                        
            
declare @count1 as int,@region1 as varchar(10),@region2 as varchar(10),@count11 as int         
SELECT @count1=COUNT(SBCODE) from MFIPOAppln2 (nolock) where sbcode like @icode+'%'            
--select @count1=count(*) from intranet.risk.dbo.region a inner join intranet.risk.dbo.region_03072008 b on a.code=b.code            
-- where a.code=@brcode            
  --print @count1          
if @count1=0            
begin             
 select @region1=a.regioncode+a.nbranchcode,@region2=b.regioncode+b.nbranchcode from intranet.risk.dbo.region a        
 --inner join intranet.risk.dbo.region_03072008 b on a.code=b.code    
 inner join intranet.risk.dbo.region b on a.code=b.code           
  where a.code=@brcode            
       --select @count11=count(*) from intranet.risk.dbo.region a inner join intranet.risk.dbo.region_03072008 b on a.code=b.code            
       select @count11=count(*) from intranet.risk.dbo.region a inner join intranet.risk.dbo.region b on a.code=b.code            
       where a.code=@brcode            
       if @count11=0      
        begin      
  set @region1=''      
  set @region2=''      
  end      
   if @region1<>@region2            
   begin            
         select @icode1=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end) from risk.dbo.region where code=@brcode                        
         SELECT @NOR=COUNT(SBCODE) from MFIPOAppln2 (nolock) where sbcode like @icode1+'%'              
  IF @NOR = 0                       
     BEGIN                      
        select @code=@icode+'0000'                         
     END                      
  ELSE                      
     BEGIN                      
     select @code=@icode+replicate('0',4-len(convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)))+convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)                        
     from MFIPOAppln2 (nolock) where sbcode like                        
     (select icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end)+'%' from risk.dbo.region where code=@brcode)                        
     group by substring(sbcode,1,6)                        
     END                 
   end            
   if @region1=@region2           
   begin          
       SELECT @NOR=COUNT(SBCODE) from MFIPOAppln2 (nolock) where sbcode like @icode+'%'                      
                        
    IF @NOR = 0                       
    BEGIN                      
  select @code=@icode+'0000'                         
    END                      
    ELSE                      
    BEGIN                      
  select @code=@icode+replicate('0',4-len(convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)))+convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)                        
  from MFIPOAppln2 (nolock) where sbcode like                        
  (select icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end)+'%' from risk.dbo.region where code=@brcode)                        
  group by substring(sbcode,1,6)                        
    END           
       --print @code           
    end          
end            
else             
begin            
     SELECT @NOR=COUNT(SBCODE) from MFIPOAppln2 (nolock) where sbcode like @icode+'%'                      
                        
 IF @NOR = 0                       
 BEGIN                      
  select @code=@icode+'0000'                         
 END                      
 ELSE                      
 BEGIN           
  select @code=@icode+replicate('0',4-len(convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)))+convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)                        
  from MFIPOAppln2 (nolock) where sbcode like                        
  (select icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end)+'%' from risk.dbo.region where code=@brcode)                        
  group by substring(sbcode,1,6)                        
 END                
end            
--print @code                     
RETURN(@code)                   
                
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.MNY2DEC
-- --------------------------------------------------
CREATE FUNCTION MNY2DEC(@VAL MONEY)
RETURNS MONEY 
AS 
BEGIN
declare @dec as int,@DEC2 AS MONEY
set @dec = charindex('.',convert(varchar(20),@VAL))
select @DEC2=CONVERT(MONEY,substring(convert(varchar(20),@VAL),1,@dec-1)+substring(convert(varchar(20),@VAL),@DEC,3))
RETURN @DEC2
END

GO

-- --------------------------------------------------
-- INDEX dbo.BO_CLIENT_PASSWORD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PcodeDt] ON [dbo].[BO_CLIENT_PASSWORD] ([party_code], [GeneratedOn])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT_MAST79
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ODIN_SERVER] ON [dbo].[CLIENT_MAST79] ([ODIN_SERVER])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT_MAST79
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [party_Code] ON [dbo].[CLIENT_MAST79] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT_TRMAST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[CLIENT_TRMAST] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ClientRequestOfflineOnline
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Party_code] ON [dbo].[ClientRequestOfflineOnline] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.crms_online_offline
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_cli] ON [dbo].[crms_online_offline] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_contest
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Clparty_code] ON [dbo].[ebrok_contest] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_contest
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[ebrok_contest] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.ebrok_contest
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sauda_date] ON [dbo].[ebrok_contest] ([sauda_date], [Branch], [Region], [mode], [points])

GO

-- --------------------------------------------------
-- INDEX dbo.MFIPOAppln2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [sbcode] ON [dbo].[MFIPOAppln2] ([SbCode])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MFIPOAppln2
-- --------------------------------------------------
ALTER TABLE [dbo].[MFIPOAppln2] ADD CONSTRAINT [PK_MFIPOAppln2] PRIMARY KEY ([SbCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagr__C2B05B616C390A4C] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master
-- --------------------------------------------------
CREATE procedure check_diet_master          
as          
          
set transaction isolation level read uncommitted          
set nocount on          
        
        
update CLIENT_MAST79 set brcode = b.tag from mis.dbo.odinuserinfo b where b.pcode=CLIENT_MAST79.party_Code          
and odin_server ='odin6'         
        
update CLIENT_MAST79 set brcode = b.tag from mis.dbo.odin_7 b where b.pcode=CLIENT_MAST79.party_Code        
and odin_server ='odin7'         
      
insert into client_mast79           
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','odin7','',0,-1,NUll from mis.dbo.odin_7 a, risk.dbo.finmast b          
where a.pcode=b.party_code and pcode not in (select party_code from CLIENT_MAST79)          
          
insert into CLIENT_MAST79           
select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin6','',0,-1,Null from mis.dbo.odinuserinfo a, risk.dbo.finmast b          
where a.pcode=b.party_code and pcode not in (select party_code from CLIENT_MAST79  )      
          
          
update CLIENT_MAST79 set location = b.location from          
(select usercode,location from testdb.dbo.ODIN_LIMITS) b          
where CLIENT_MAST79.location ='' and CLIENT_MAST79.party_code=b.usercode          
          
          
update CLIENT_MAST79 set location='AKRUTI' where location=''           
          
update CLIENT_MAST79 set odin_server ='odin6' where party_code in (select pcode from mis.dbo.odinuserinfo)          
update CLIENT_MAST79 set odin_server='odin7' where party_code in (select pcode from mis.dbo.odin_7)          
          
update CLIENT_MAST79 set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp b where CLIENT_MAST79.party_code=b.pcode          
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S1
-- --------------------------------------------------
CREATE procedure check_diet_master710S1        
as                    
                    
set transaction isolation level read uncommitted                    
set nocount on                    
                  
                  
--update client_mast79 set brcode = b.tag from mis.dbo.odinuserinfo b where b.pcode=client_mast.party_Code                    
--and odin_server ='odin6'                   
            
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S1 b where b.pcode=client_mast79.party_Code                  
--and odin_server ='odin79'                   
and odin_server ='ODIN710S1'                   
          
  
UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE
and ODIN_SERVER='ODIN710S1'            
                
insert into client_mast79                     
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                    
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S1','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                    
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                    
                    
--insert into client_mast                     
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin6','',0,-1,Null from mis.dbo.odinuserinfo a, risk.dbo.finmast b                    
--where a.pcode=b.party_code and pcode not in (select party_code from client_mast  )                
                    
                    
update client_mast79 set location = b.location from                    
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                    
where client_mast79.location ='' and client_mast79.party_code=b.usercode                    
                    
update client_mast79 set location='AKRUTI' where location=''                     
                    
--update client_mast set odin_server ='odin6' where party_code in (select pcode from mis.dbo.odinuserinfo)                    
--update client_mast79 set odin_server='odin79' where party_code in (select pcode from mis.dbo.ODIN_710S1)                    
update client_mast79 set odin_server='ODIN710S1' where party_code in (select pcode from mis.dbo.ODIN_710S1)                    
                    
--update client_mast79 set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp79 b where client_mast79.party_code=b.pcode                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S2
-- --------------------------------------------------
CREATE procedure check_diet_master710S2        
as                    
                    
set transaction isolation level read uncommitted                    
set nocount on                    
                  
                  
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S2 b where b.pcode=client_mast79.party_Code                  
and odin_server ='ODIN710S2'                   
             
UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S2' 
   
insert into client_mast79                     
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                    
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S2','',0,-1,NUll from mis.dbo.ODIN_710S2 a, risk.dbo.finmast b                    
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                    
                    
update client_mast79 set location = b.location from                    
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                    
where client_mast79.location ='' and client_mast79.party_code=b.usercode                    
                    
update client_mast79 set location='AKRUTI' where location=''                     
                    
update client_mast79 set odin_server='ODIN710S2' where party_code in (select pcode from mis.dbo.ODIN_710S2)                    
                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S3
-- --------------------------------------------------
CREATE procedure check_diet_master710S3          
as                      
                      
set transaction isolation level read uncommitted                      
set nocount on                      
                    
                    
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S3 b where b.pcode=client_mast79.party_Code                    
and odin_server ='ODIN710S3'                     

UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S3' 
                  
insert into client_mast79                       
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                      
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S3','',0,-1,NUll from mis.dbo.ODIN_710S3 a, risk.dbo.finmast b                      
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                      
                      
update client_mast79 set location = b.location from                      
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                      
where client_mast79.location ='' and client_mast79.party_code=b.usercode                      
                      
update client_mast79 set location='AKRUTI' where location=''                       
                      
update client_mast79 set odin_server='ODIN710S3' where party_code in (select pcode from mis.dbo.ODIN_710S3)                      
                      
                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S4
-- --------------------------------------------------
CREATE procedure check_diet_master710S4            
as                        
                        
set transaction isolation level read uncommitted                        
set nocount on                        
                      
                      
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S4 b where b.pcode=client_mast79.party_Code                      
and odin_server ='ODIN710S4'                       

UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S4'
                    
insert into client_mast79                         
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                        
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S4','',0,-1,NUll from mis.dbo.ODIN_710S4 a, risk.dbo.finmast b                        
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                        
                        
update client_mast79 set location = b.location from                        
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                        
where client_mast79.location ='' and client_mast79.party_code=b.usercode                        
                        
update client_mast79 set location='AKRUTI' where location=''                         
                        
update client_mast79 set odin_server='ODIN710S4' where party_code in (select pcode from mis.dbo.ODIN_710S4)                        
                        
                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S5
-- --------------------------------------------------
CREATE procedure check_diet_master710S5              
as                          
                          
set transaction isolation level read uncommitted                          
set nocount on                          
                        
                        
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S5 b where b.pcode=client_mast79.party_Code                        
and odin_server ='ODIN710S5'                         
                      

UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S5'

insert into client_mast79                           
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                          
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S5','',0,-1,NUll from mis.dbo.ODIN_710S5 a, risk.dbo.finmast b                          
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                          
                          
update client_mast79 set location = b.location from                          
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                          
where client_mast79.location ='' and client_mast79.party_code=b.usercode                          
                          
update client_mast79 set location='AKRUTI' where location=''                           
                          
update client_mast79 set odin_server='ODIN710S5' where party_code in (select pcode from mis.dbo.ODIN_710S5)                          
                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S6
-- --------------------------------------------------
CREATE procedure check_diet_master710S6              
as                          
                          
set transaction isolation level read uncommitted                          
set nocount on                          
                        
                        
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S6 b where b.pcode=client_mast79.party_Code                        
and odin_server ='ODIN710S6'                         
       
UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S6'  
               
insert into client_mast79                           
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                          
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S6','',0,-1,NUll from mis.dbo.ODIN_710S6 a, risk.dbo.finmast b                          
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                          
                          
update client_mast79 set location = b.location from                          
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                          
where client_mast79.location ='' and client_mast79.party_code=b.usercode                          
                          
update client_mast79 set location='AKRUTI' where location=''                           
                          
update client_mast79 set odin_server='ODIN710S6' where party_code in (select pcode from mis.dbo.ODIN_710S6)                          
                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S7
-- --------------------------------------------------
CREATE procedure check_diet_master710S7              
as                          
                          
set transaction isolation level read uncommitted                          
set nocount on                          
                        
                        
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S7 b where b.pcode=client_mast79.party_Code                        
and odin_server ='ODIN710S7'                         
       
UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE  
and ODIN_SERVER='ODIN710S7' 
               
insert into client_mast79                           
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                          
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S7','',0,-1,NUll from mis.dbo.ODIN_710S7 a, risk.dbo.finmast b                          
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                          
                          
update client_mast79 set location = b.location from                          
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                          
where client_mast79.location ='' and client_mast79.party_code=b.usercode                          
                          
update client_mast79 set location='AKRUTI' where location=''                           
                          
update client_mast79 set odin_server='ODIN710S7' where party_code in (select pcode from mis.dbo.ODIN_710S7)                          
                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master710S8
-- --------------------------------------------------
CREATE procedure check_diet_master710S8                
as                            
                            
set transaction isolation level read uncommitted                            
set nocount on                            
                          
                          
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_710S8 b where b.pcode=client_mast79.party_Code                          
and odin_server ='ODIN710S8'                           
         
UPDATE CLIENT_MAST79 SET SBCODE=B.SUBGROUP FROM RISK.DBO.FINMAST B WHERE B.PARTY_cODE=CLIENT_MAST79.PARTY_cODE    
and ODIN_SERVER='ODIN710S8'   
                 
insert into client_mast79                             
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_710S1 a, risk.dbo.finmast b                            
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN710S8','',0,-1,NUll from mis.dbo.ODIN_710S8 a, risk.dbo.finmast b                            
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                            
                            
update client_mast79 set location = b.location from                            
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                            
where client_mast79.location ='' and client_mast79.party_code=b.usercode                            
                            
update client_mast79 set location='AKRUTI' where location=''                             
                            
update client_mast79 set odin_server='ODIN710S8' where party_code in (select pcode from mis.dbo.ODIN_710S8)                            
                            
                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master79
-- --------------------------------------------------
CREATE procedure check_diet_master79        
as        
        
set transaction isolation level read uncommitted        
set nocount on        
      
      
--update client_mast79 set brcode = b.tag from mis.dbo.odinuserinfo b where b.pcode=client_mast.party_Code        
--and odin_server ='odin6'       
      
update client_mast79 set brcode = b.tag from mis.dbo.odin_79 b where b.pcode=client_mast79.party_Code      
and odin_server ='odin79'       
    
insert into client_mast79         
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.odin_79 a, risk.dbo.finmast b        
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)        
        
--insert into client_mast         
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin6','',0,-1,Null from mis.dbo.odinuserinfo a, risk.dbo.finmast b        
--where a.pcode=b.party_code and pcode not in (select party_code from client_mast  )    
        
        
update client_mast79 set location = b.location from        
(select usercode,location from testdb.dbo.ODIN_LIMITS) b        
where client_mast79.location ='' and client_mast79.party_code=b.usercode        
        
        
update client_mast79 set location='AKRUTI' where location=''         
        
--update client_mast set odin_server ='odin6' where party_code in (select pcode from mis.dbo.odinuserinfo)        
update client_mast79 set odin_server='odin79' where party_code in (select pcode from mis.dbo.odin_79)        
        
update client_mast79 set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp79 b where client_mast79.party_code=b.pcode        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master79new
-- --------------------------------------------------
CREATE procedure check_diet_master79new            
as            
            
set transaction isolation level read uncommitted            
set nocount on            
          
          
--update client_mast79 set brcode = b.tag from mis.dbo.odinuserinfo b where b.pcode=client_mast.party_Code            
--and odin_server ='odin6'           
    
update client_mast79 set brcode = b.tag from mis.dbo.odin_79new b where b.pcode=client_mast79.party_Code          
--and odin_server ='odin79'           
and odin_server ='ODIN79S2'           
  
  
        
insert into client_mast79             
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.odin_79new a, risk.dbo.finmast b            
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN79S2','',0,-1,NUll from mis.dbo.odin_79new a, risk.dbo.finmast b            
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)            
            
--insert into client_mast             
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin6','',0,-1,Null from mis.dbo.odinuserinfo a, risk.dbo.finmast b            
--where a.pcode=b.party_code and pcode not in (select party_code from client_mast  )        
            
            
update client_mast79 set location = b.location from            
(select usercode,location from testdb.dbo.ODIN_LIMITS) b            
where client_mast79.location ='' and client_mast79.party_code=b.usercode            
            
update client_mast79 set location='AKRUTI' where location=''             
            
--update client_mast set odin_server ='odin6' where party_code in (select pcode from mis.dbo.odinuserinfo)            
--update client_mast79 set odin_server='odin79' where party_code in (select pcode from mis.dbo.odin_79new)            
update client_mast79 set odin_server='ODIN79S2' where party_code in (select pcode from mis.dbo.odin_79new)            
            
update client_mast79 set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp79 b where client_mast79.party_code=b.pcode            
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_diet_master79S3
-- --------------------------------------------------
CREATE procedure check_diet_master79S3    
as                
                
set transaction isolation level read uncommitted                
set nocount on                
              
              
--update client_mast79 set brcode = b.tag from mis.dbo.odinuserinfo b where b.pcode=client_mast.party_Code                
--and odin_server ='odin6'               
        
update client_mast79 set brcode = b.tag from mis.dbo.ODIN_79S3 b where b.pcode=client_mast79.party_Code              
--and odin_server ='odin79'               
and odin_server ='ODIN79S3'               
      
      
            
insert into client_mast79                 
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin7.9','',0,-1,NUll from mis.dbo.ODIN_79S3 a, risk.dbo.finmast b                
select sbtag,tag,pcode,pname,1,-1,-1,.25,-1,' ','ODIN79S3','',0,-1,NUll from mis.dbo.ODIN_79S3 a, risk.dbo.finmast b                
where a.pcode=b.party_code and pcode not in (select party_code from client_mast79)                
                
--insert into client_mast                 
--select sbtag,tag,pcode,pname,6,-1,-1,.25,-1,' ','odin6','',0,-1,Null from mis.dbo.odinuserinfo a, risk.dbo.finmast b                
--where a.pcode=b.party_code and pcode not in (select party_code from client_mast  )            
                
                
update client_mast79 set location = b.location from                
(select usercode,location from testdb.dbo.ODIN_LIMITS) b                
where client_mast79.location ='' and client_mast79.party_code=b.usercode                
                
update client_mast79 set location='AKRUTI' where location=''                 
                
--update client_mast set odin_server ='odin6' where party_code in (select pcode from mis.dbo.odinuserinfo)                
--update client_mast79 set odin_server='odin79' where party_code in (select pcode from mis.dbo.ODIN_79S3)                
update client_mast79 set odin_server='ODIN79S3' where party_code in (select pcode from mis.dbo.ODIN_79S3)                
                
update client_mast79 set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp79 b where client_mast79.party_code=b.pcode                
                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_tradeanywhere_master
-- --------------------------------------------------
CREATE procedure check_tradeanywhere_master        
as        
        
set transaction isolation level read uncommitted        
set nocount on        
  
  
select a.client_code    
into #aa from mis.testdb.dbo.tradeanywhere_master   
a, risk.dbo.finmast b where a.client_code=b.party_code   
  
  
update client_trmast set brcode = b.branch from mis.testdb.dbo.tradeanywhere_master  b   
where b.Client_code=client_trmast.party_Code   
--and odin_server ='odin6'       
  
insert into client_trmast         
select sbtag,a.branch,client_code,party_name,6,-1,-1,.25,-1,' ','tradeanywhere','',0,-1,NUll   
from mis.testdb.dbo.tradeanywhere_master a, risk.dbo.finmast b where a.client_code=b.party_code   
and client_code not in (select party_code from client_trmast (nolock))        
  
---confirm tbale odin_limit  
update client_trmast set location = b.location from        
(select usercode,location from testdb.dbo.ODIN_LIMITS (nolock)) b        
where client_trmast.location ='' and client_trmast.party_code=b.usercode   
     
update client_trmast set location='AKRUTI' where location=''   
    
update client_trmast set odin_server ='tradeanywhere' where party_code in (select client_code from mis.testdb.dbo.tradeanywhere_master)        
  
---confirm this query  
--update client_trmast set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp b where client_mast.party_code=b.pcode        
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.check_tradeanywhere_master2
-- --------------------------------------------------
CREATE procedure check_tradeanywhere_master2          
as          
          
set transaction isolation level read uncommitted          
set nocount on          
    
    
select a.client_code      
into #aa from mis.testdb.dbo.tradeanywhere_master_newver     
a, risk.dbo.finmast b where a.client_code=b.party_code     
    
    
update client_trmast set brcode = b.branch from mis.testdb.dbo.tradeanywhere_master_newver  b     
where b.Client_code=client_trmast.party_Code     
--and odin_server ='odin6'         
    
insert into client_trmast           
select sbtag,a.branch,client_code,party_name,6,-1,-1,.25,-1,' ','tradeanywhere','',0,-1,NUll     
from mis.testdb.dbo.tradeanywhere_master_newver a, risk.dbo.finmast b where a.client_code=b.party_code     
and client_code not in (select party_code from client_trmast (nolock))          
    
---confirm tbale odin_limit    
update client_trmast set location = b.location from          
(select usercode,location from testdb.dbo.ODIN_LIMITS (nolock)) b          
where client_trmast.location ='' and client_trmast.party_code=b.usercode     
       
update client_trmast set location='AKRUTI' where location=''     
      
update client_trmast set odin_server ='tradeanywhere' where party_code in (select client_code from mis.testdb.dbo.tradeanywhere_master_newver)          
    
---confirm this query    
--update client_trmast set sbcode = b.tag, odin_Server=b.odin  from odin_xtemp b where client_mast.party_code=b.pcode          
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cli_interested
-- --------------------------------------------------
CREATE proc dbo.cli_interested (@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))      
as      
set nocount on              
if @access_to='BROKER'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end) from mimansa_interested_cli a join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where a.party_code not in       
(select party_code from ebrok_client (nolock)) and entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59'      
end    
if @access_to='REGION'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end) from mimansa_interested_cli a join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where a.party_code not in       
(select party_code from ebrok_client (nolock)) and entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59'  AND    
b.branch_cd in (select code from RISK.DBO.region where reg_code=@access_code)    
end    
if @access_to='BRMAST'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end) from mimansa_interested_cli a join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where a.party_code not in       
(select party_code from ebrok_client (nolock)) and entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59' and b.branch_cd in    
(select branch_cd from RISK.DBO.branch_master where brmast_cd=@access_code)     
end    
if @access_to='BRANCH'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end) from mimansa_interested_cli a join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where a.party_code not in       
(select party_code from ebrok_client (nolock)) and entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59' and b.branch_cd=@access_code     
end    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.cli_interested_proton
-- --------------------------------------------------
CREATE proc dbo.cli_interested_proton (@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))      
as      
set nocount on              
if @access_to='BROKER'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end),A.status from mimansa_interested_cli_proton a (nolock) join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where  entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59'      
end    
if @access_to='REGION'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end),A.status from mimansa_interested_cli_proton a (nolock) join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where  entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59'  AND    
b.branch_cd in (select code from region where reg_code=@access_code)    
end    
if @access_to='BRMAST'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end),A.status from mimansa_interested_cli_proton a (nolock) join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where  entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59' and b.branch_cd in    
(select branch_cd from branch_master where brmast_cd=@access_code)     
end    
if @access_to='BRANCH'              
BEGIN     
select entry_time_stamp,b.branch_cd,a.party_code,b.short_name,mobile_pager=(case when a.mobile_pager='' then b.mobile_pager else a.mobile_pager end),A.status from mimansa_interested_cli_proton a (nolock) join       
risk.dbo.client_details b (nolock) on a.party_code=b.party_code where  entry_time_stamp>=convert(datetime,@fdate,103) + ' 00:00:00'       
 and entry_time_stamp<=convert(datetime,@tdate,103) + ' 23:59:59' and b.branch_cd=@access_code     
end    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.client_reward
-- --------------------------------------------------
CREATE proc dbo.client_reward (@flag as varchar(5),@flag1 as varchar(5),@fdate as varchar(25),@tdate as varchar(25),@access_to varchar(25),@access_code as varchar(25))                      
as                      
set nocount on                      
Declare @str as varchar(2500)                   
set @str=''                   
                  
if @flag='b'                    
begin                      
set @str=''                    
 set @str=@str + 'select distinct branch_cd=a.branch,a.party_code,short_name=a.client_name,brokerage=SUM(a.tot_brok),points=SUM(a.cli_points),redeemed=isnull(d.valuepoints,0),balance=SUM(isnull(a.cli_points,0))-isnull(d.valuepoints ,0) '                  
  
   
 set @str=@str + ' from ebrok_contest a  '                        
 set @str=@str + ' left outer join (select clientid,valuepoints=sum(valuepoints) from middleware.mimansa.dbo.GiftVoucherRequest group by clientid) d on a.party_code=d.clientid '                      
 set @str=@str + ' where a.sauda_date>=convert(datetime,'''+@fdate+''',103)+'' 00:00:00'' and a.sauda_date<=convert(datetime,'''+@tdate+''',103)+'' 23:59:59'' '+risk.dbo.GetFilterString_final(@access_to,@access_code,'and','a.Branch','')+''                
  
     
 set @str=@str + ' group by a.party_code,a.client_name,a.branch,d.valuepoints order by a.party_code'                     
end                    
if @flag='a'                    
begin  
if @access_to='BRANCH' or @access_to='BR_MAST'  
begin  
SET  @flag='c'    
end   
if @access_to='BROKER' or @access_to='REGION'  
begin                    
set @str=''                     
 set @str=@str + 'select Region=''<a href=report.aspx?reportno=150&flag=c&flag1=''+A.REGION+''&fdate='+@fdate+'&tdate='+@tdate+'&access_to='+@access_to+'&access_code='+@access_code+'>''+a.region+''</a>'','                     
 set @str=@str + ' points=sum(a.cli_points),redeemed=isnull(d.valuepoints,0),balance=SUM(isnull(a.cli_points,0))-isnull(d.valuepoints ,0) '                      
 set @str=@str + ' from ebrok_contest A '                       
 set @str=@str + '  left outer join (select clientid,valuepoints=sum(valuepoints) from middleware.mimansa.dbo.GiftVoucherRequest group by clientid) d on a.party_code=d.clientid '                   
 set @str=@str + ' where a.sauda_date>=convert(datetime,'''+@fdate+''',103)+'' 00:00:00'' and a.sauda_date<=convert(datetime,'''+@tdate+''',103)+'' 23:59:59'' '+risk.dbo.GetFilterString_final(@access_to,@access_code,'and','a.Branch','')+''                
  
    
 set @str=@str + ' group by a.region,d.valuepoints order by a.region'                       
 END                   
end                    
if @flag='c'                    
begin    
                 
set @str=''                     
 set @str=@str + 'select Branch=''<a href=report.aspx?reportno=150&flag=d&flag1=''+A.BRANCH+''&fdate='+@fdate+'&tdate='+@tdate+'&access_to='+@access_to+'&access_code='+@access_code+'>''+a.branch+''</a>'','                     
 set @str=@str + ' points=sum(a.cli_points) '                      
 set @str=@str + ' from ebrok_contest A '                              
 set @str=@str + ' where a.sauda_date>=convert(datetime,'''+@fdate+''',103)+'' 00:00:00'' and a.sauda_date<=convert(datetime,'''+@tdate+''',103)+'' 23:59:59'' '+risk.dbo.GetFilterString_final(@access_to,@access_code,'and','a.Branch','')+''                
  
    
 set @str=@str + ' and a.region='''+@flag1+''' group by a.branch having sum(a.cli_points)<>0 order by a.branch'                       
                    
end                    
if @flag='d'                    
begin                    
set @str=''                     
 set @str=@str + 'select a.party_code,short_name=a.client_name,'                     
 set @str=@str + ' points=sum(a.cli_points),redeemed=isnull(d.valuepoints,0),balance=SUM(isnull(a.cli_points,0))-isnull(d.valuepoints ,0) '                      
 set @str=@str + ' from ebrok_contest A  left outer join (select clientid,valuepoints=sum(valuepoints) from middleware.mimansa.dbo.GiftVoucherRequest group by clientid) d on a.party_code=d.clientid '                     
 set @str=@str + ' where a.sauda_date>=convert(datetime,'''+@fdate+''',103)+'' 00:00:00'' and a.sauda_date<=convert(datetime,'''+@tdate+''',103)+'' 23:59:59'' '                    
 set @str=@str + ' and a.branch='''+@flag1+''' '+risk.dbo.GetFilterString_final(@access_to,@access_code,'and','a.Branch','')+'  group by a.party_code,a.client_name,d.valuepoints having sum(a.cli_points)<>0 order by a.party_code'                       
                    
end                    
--print @str                    
exec(@str)                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis
-- --------------------------------------------------
CREATE proc dbo.contest_mis (@flag as varchar(5),@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))            
as            
set nocount on            
Declare @str as varchar(3500)           
/*        
set @str=''          
 set @str=@str + 'select Branch=C.BRANCH_CD,[Client Code]=C.party_code,[Name]=c.short_name,[brokerage]=sum(case when user_stat<>'''' then d.brokerage else 0 end),'           
 set @str=@str + ' [Total No. of Points] =sum(case when b.mode=''1st trade'' then b.points else 0 end)'            
 set @str=@str + 'from ClientRequestOfflineOnline a (nolock) left outer join ebrok_contest b on a.party_code=b.party_code join risk.dbo.client_details c on a.party_code=c.party_code join '             
 set @str=@str + '(select distinct party_code,brokerage=sum(brokerage),user_stat  from bsedb_ab.dbo.MIS_ebroking_cli (nolock)  where sauda_date>=convert(datetime,'''+ @fdate +''',103) + '' 00:00:00'' '           
 set @str=@str + 'and sauda_date<=convert(datetime,'''+ @tdate +''',103) + '' 23:59:59'' and user_stat<>'''' group by party_code,user_stat) d '             
 set @str=@str + 'on c.party_CODE=d.party_CODE collate Latin1_General_CI_AS where a.request_date>=convert(datetime,'''+ @fdate +''',103) + '' 00:00:00'' '            
 set @str=@str + 'and a.request_date<=convert(datetime,'''+ @tdate +''',103) + '' 23:59:59'' and c.branch_cd in (select code from risk.dbo.region d (nolock) where reg_code='''+ @flag +''') '           
 set @str=@str + 'group by C.BRANCH_CD,C.party_code,c.short_name having sum(case when b.mode=''1st trade'' then b.points else 0 end) <>0 order by C.party_code'           
*/        
if @access_to='BROKER'        
begin        
set @str=''          
 set @str=@str + 'select c.branch_cd,a.party_code,c.short_name,brok=sum(b.brokerage),points'           
 set @str=@str + ' from ebrok_contest a join bsedb_ab.dbo.MIS_ebroking_cli b on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS'            
 set @str=@str + ' and a.sauda_date=b.sauda_date join risk.dbo.client_details c on a.party_code=c.party_code where a.sauda_date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00''  '             
 set @str=@str + ' and a.sauda_date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'' and c.branch_cd in (select code from risk.dbo.region where reg_code='''+@flag+''') group by b.sauda_date,c.branch_cd,a.party_code,c.short_name,points'           
   --print @str      
if @flag='a'          
begin          
set @str=''           
 set @str=@str + 'select Region=''<a href=report.aspx?reportno=148&flag=''+d.reg_code+''&fdate='+@fdate+'&tdate='+@tdate+'&access_to='+@access_to+'&access_code='+@access_code+'>''+d.reg_code+''</a>'',[No. of Applications Recd. in KYC]=sum(case when usercode =''kyc'' then 1 else 0 end),'        
 set @str=@str + ' [No. of Applications Approved]=sum(case when usercode <>''kyc'' then 1 else 0 end), '           
 set @str=@str + ' [No. of Clients Activated]=sum(case when b.mode=''1st trade'' then 1 else 0 end),'            
 set @str=@str + ' [Total No. of Points] =sum(isnull(points,''''))'             
 set @str=@str + ' from (SELECT DISTINCT PARTY_CODE,USERCODE=(CASE WHEN USERCODE<>''KYC'' THEN '''' ELSE ''KYC'' END) FROM mis.genodinlimit.dbo.diet_cli_all_hist where date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00'' '            
 set @str=@str + ' and date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'') a left outer join ebrok_contest b '           
 set @str=@str + ' on a.party_code=b.party_code join risk.dbo.client_details c on a.party_code=c.party_code join risk.dbo.region d '             
 set @str=@str + ' on c.branch_cd=d.code group by d.reg_code order by d.reg_code'           
 end          
end          
if @access_to='REGION'        
begin        
set @str=''          
 set @str=@str + 'select c.branch_cd,a.party_code,c.short_name,brok=sum(b.brokerage),points'           
 set @str=@str + ' from ebrok_contest a join bsedb_ab.dbo.MIS_ebroking_cli b on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS'            
 set @str=@str + ' and a.sauda_date=b.sauda_date join risk.dbo.client_details c on a.party_code=c.party_code where a.sauda_date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00''  '             
 set @str=@str + ' and a.sauda_date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'' and c.branch_cd in (select code from risk.dbo.region where reg_code='''+@flag+''') group by b.sauda_date,c.branch_cd,a.party_code,c.short_name,points'           
       
if @flag='a'          
begin          
set @str=''           
 set @str=@str + 'select Region=''<a href=report.aspx?reportno=148&flag=''+d.reg_code+''&fdate='+@fdate+'&tdate='+@tdate+'&access_to='+@access_to+'&access_code='+@access_code+'>''+d.reg_code+''</a>'',[No. of Applications Recd. in KYC]=sum(case when userco
de =''kyc'' then 1 else 0 end),'        
 set @str=@str + ' [No. of Applications Approved]=sum(case when usercode <>''kyc'' then 1 else 0 end), '           
 set @str=@str + ' [No. of Clients Activated]=sum(case when b.mode=''1st trade'' then 1 else 0 end),'            
 set @str=@str + ' [Total No. of Points] =sum(isnull(points,''''))'             
 set @str=@str + ' from (SELECT DISTINCT PARTY_CODE,USERCODE=(CASE WHEN USERCODE<>''KYC'' THEN '''' ELSE ''KYC'' END) FROM mis.genodinlimit.dbo.diet_cli_all_hist where date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00'' '            
 set @str=@str + ' and date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'') a left outer join ebrok_contest b '           
 set @str=@str + ' on a.party_code=b.party_code join risk.dbo.client_details c on a.party_code=c.party_code left outer join risk.dbo.region d '             
 set @str=@str + ' on c.branch_cd=d.code  where d.reg_code='''+ @access_code +''' group by d.reg_code order by d.reg_code'           
 end          
end         
if @access_to='BRMAST'        
begin        
set @str=''          
 set @str=@str + 'select c.branch_cd,a.party_code,c.short_name,brok=sum(b.brokerage),points'           
 set @str=@str + ' from ebrok_contest a join bsedb_ab.dbo.MIS_ebroking_cli b on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS'            
 set @str=@str + ' join risk.dbo.client_details c on a.party_code=c.party_code where b.sauda_date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00''  '             
 set @str=@str + ' and b.sauda_date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'' and c.branch_cd in (select branch_cd from risk.dbo.branch_master where brmast_cd='''+@access_code+''') group by c.branch_cd,a.party_code,c.short_name,points'           
        
end         
if @access_to='BRANCH'        
begin        
set @str=''          
 set @str=@str + 'select c.branch_cd,a.party_code,c.short_name,brok=sum(b.brokerage),points'           
 set @str=@str + ' from ebrok_contest a join bsedb_ab.dbo.MIS_ebroking_cli b on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS'            
 set @str=@str + ' join risk.dbo.client_details c on a.party_code=c.party_code where b.sauda_date>=convert(datetime,'''+ @fdate +''',103)+'' 00:00:00''  '             
 set @str=@str + ' and b.sauda_date<=convert(datetime,'''+ @tdate +''',103)+'' 23:59:59'' and c.branch_cd in (select code from risk.dbo.region where reg_code='''+@access_code+''') group by c.branch_cd,a.party_code,c.short_name,points'           
        
end         
--print @str          
exec(@str)          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_all
-- --------------------------------------------------

CREATE proc dbo.contest_mis_all (@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))                                  
as                                  
set nocount on         
 --select * from ebrok_contest       
--select party_code,status=case when usercode='KYC' then 'NEW' else 'EXISTING' END INTO #TEMP1 from  mis.genodinlimit.dbo.diet_cli_all_hist where date>='aug 01 2009'          
if @access_to='BROKER'                
begin           
  
select distinct c.reg_code,b.branch_cd,b.sub_broker,intrucode='',emp_name='',department='',a.party_code,short_name=max(b.short_name),  
STATUS=case when max(usercode)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=0,total=0,points=0 from  
(select distinct party_code,usercode=max(usercode),date=max(date) from mis.genodinlimit.dbo.diet_cli_all_hist group by party_code) a join risk.dbo.client_details b (nolock) on a.party_code=b.party_code  
left outer join risk.dbo.region_temp c (nolock) on b.branch_cd=c.code  
where a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@tdate,103) and  
b.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )   
and a.party_code not in (select party_code from  ebrok_contest  (nolock))
and a.party_code collate Latin1_General_CI_AS not in (select party_code from  risk.dbo.ebroking_contest_exclude1 (nolock))  
group by c.reg_code,b.branch_cd,b.sub_broker,a.party_code   
union  
select distinct reg_code=region,branch_cd=branch,sub_broker,INTRUCODE,emp_name,department=emp_dept,party_code,short_name=max(client_name),      
STATUS=case when max(cli_type)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=sum(online_brok),                  
total=sum(tot_brok)                  
,points=sum(points) from                  
 ebrok_contest  (nolock)               
where  sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103)               
group by region,branch,sub_broker,party_code,INTRUCODE,emp_name,emp_dept--,cli_type      
order by a.party_code             
end          
if @access_to='BRANCH'                
begin           
  
select distinct c.reg_code,b.branch_cd,b.sub_broker,intrucode='',emp_name='',department='',a.party_code,short_name=max(b.short_name),  
STATUS=case when max(usercode)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=0,total=0,points=0 from  
(select distinct party_code,usercode=max(usercode),date=max(date) from mis.genodinlimit.dbo.diet_cli_all_hist group by party_code) a join risk.dbo.client_details b (nolock) on a.party_code=b.party_code  
left outer join risk.dbo.region_temp c (nolock) on b.branch_cd=c.code  
where a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@tdate,103) and b.branch_cd=@access_code and  
b.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )   
and a.party_code not in (select party_code from  ebrok_contest  (nolock))
and a.party_code  collate Latin1_General_CI_AS not in (select party_code from  risk.dbo.ebroking_contest_exclude1 (nolock))    
group by c.reg_code,b.branch_cd,b.sub_broker,a.party_code   
union  
select distinct reg_code=region,branch_cd=branch,sub_broker,INTRUCODE,emp_name,department=emp_dept,party_code,short_name=max(client_name),      
STATUS=case when max(cli_type)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=sum(online_brok),                  
total=sum(tot_brok)                  
,points=sum(points) from                  
 ebrok_contest  (nolock)               
where  sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103) and branch=@access_code              
group by region,branch,sub_broker,party_code,INTRUCODE,emp_name,emp_dept--,cli_type      
order by a.party_code             
end           
if @access_to='BRMAST'                
begin           
select distinct c.reg_code,b.branch_cd,b.sub_broker,intrucode='',emp_name='',department='',a.party_code,short_name=max(b.short_name),  
STATUS=case when max(usercode)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=0,total=0,points=0 from  
(select distinct party_code,usercode=max(usercode),date=max(date) from mis.genodinlimit.dbo.diet_cli_all_hist group by party_code) a join risk.dbo.client_details b (nolock) on a.party_code=b.party_code  
left outer join risk.dbo.region_temp c (nolock) on b.branch_cd=c.code  
 left outer join risk.dbo.branch_master X (nolock) on b.branch_cd=X.branch_cd  
where a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@tdate,103) and X.brmast_cd=@ACCESS_CODE and  
b.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )   
and a.party_code not in (select party_code from  ebrok_contest  (nolock))  
and a.party_code  collate Latin1_General_CI_AS not in (select party_code from  risk.dbo.ebroking_contest_exclude1 (nolock))  
group by c.reg_code,b.branch_cd,b.sub_broker,a.party_code   
union  
select distinct reg_code=region,branch_cd=branch,sub_broker,INTRUCODE,emp_name,department=emp_dept,party_code,short_name=max(client_name),      
STATUS=case when max(cli_type)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=sum(online_brok),                  
total=sum(tot_brok)                  
,points=sum(points) from                  
 ebrok_contest a (nolock)  left outer join risk.dbo.branch_master X (nolock) on a.branch=X.branch_cd              
where  sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103) and X.brmast_cd=@ACCESS_CODE                
group by region,branch,sub_broker,party_code,INTRUCODE,emp_name,emp_dept--,cli_type      
order by a.party_code   
end           
if @access_to='REGION'                
begin           
select distinct c.reg_code,b.branch_cd,b.sub_broker,intrucode='',emp_name='',department='',a.party_code,short_name=max(b.short_name),  
STATUS=case when max(usercode)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=0,total=0,points=0 from  
(select distinct party_code,usercode=max(usercode),date=max(date) from mis.genodinlimit.dbo.diet_cli_all_hist group by party_code) a join risk.dbo.client_details b (nolock) on a.party_code=b.party_code  
left outer join risk.dbo.region_temp c (nolock) on b.branch_cd=c.code  
   
where a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@tdate,103) and c.reg_code=@ACCESS_CODE and  
b.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )   
and a.party_code not in (select party_code from  ebrok_contest  (nolock)) 
and a.party_code  collate Latin1_General_CI_AS not in (select party_code from  risk.dbo.ebroking_contest_exclude1 (nolock))   
group by c.reg_code,b.branch_cd,b.sub_broker,a.party_code   
union  
select distinct reg_code=region,branch_cd=branch,sub_broker,INTRUCODE,emp_name,department=emp_dept,party_code,short_name=max(client_name),      
STATUS=case when max(cli_type)='KYC' THEN 'NEW' ELSE 'EXISTING' END,online=sum(online_brok),                  
total=sum(tot_brok)                  
,points=sum(points) from                  
 ebrok_contest (nolock)             
where  sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103) and region=@ACCESS_CODE                
group by region,branch,sub_broker,party_code,INTRUCODE,emp_name,emp_dept--,cli_type      
order by a.party_code              
end                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_branch
-- --------------------------------------------------
CREATE proc dbo.contest_mis_branch(@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25),@flag as varchar(25))                              
as                              
set nocount on                              
Declare @str as varchar(3500)       
      
select * into #temp_hist from mis.genodinlimit.dbo.diet_cli_all_hist where date >='aug 01 2009'                 
                
select distinct branch_cd=b.branch,reg_code=region, [No. of Clients Activated]=sum(case when b.mode='1st trade' then 1 else 0 end),                              
 [Total No. of Points] =sum(isnull(points,0)) into #fil                 
FROM ebrok_contest b                              
  where b.sauda_date>=convert(datetime,@fdate,103) and b.sauda_date<=convert(datetime,@tdate,103)                
--and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )               
 group by branch,region          
                
select reg_code,c.branch_cd,[No. of Applications Recd. in KYC]=sum(case when y.usercode ='kyc' then 1 else 0 end),                          
 [No. of Applications Approved]=sum(case when y.usercode <>'kyc' then 1 else 0 end) into #fil2 from                
 (select distinct party_code,usercode=max(usercode),date=max(date) from #temp_hist (nolock) group by party_code) y join risk.dbo.client_details c (nolock) on y.party_code=c.party_code   
join risk.dbo.region_temp d (nolock)  on c.branch_cd=d.code                
 where y.date>=convert(datetime,@fdate,103) and y.date<=convert(datetime,@tdate,103)               
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )        
and y.party_code collate Latin1_General_CI_AS          
not in (select party_code from risk.dbo.ebroking_contest_exclude1 (nolock))                     
 group by reg_code,c.branch_cd           
  
/*select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],                
 [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2a a left outer join #fil b on                 
 a.branch_cd=b.branch_cd  where a.reg_code like 'MUMCENT'    
  
MUMCENT       
select code from risk.dbo.region_temp where reg_code='MUMCENT'  
select * from #fil2 where branch_cd in (select code from risk.dbo.region_temp where reg_code='MUMCENT')*/  
                
if @access_to='BROKER' or @access_to='REGION'                         
begin                
set @str=''                
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'                 
 set @str=@str + ' a.branch_cd=b.branch_cd  where a.reg_code like '''+@flag+''''                
end                
if @access_to='BRANCH'                    
begin                
set @str=''                
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'                 
 set @str=@str + ' a.branch_cd=b.branch_cd  where a.branch_cd like '''+@access_code+''''                
end                
if @access_to='BRMAST'                    
begin                
set @str=''                
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'                 
 set @str=@str + ' a.branch_cd=b.branch_cd join risk.dbo.branch_master c on a.branch_cd=c.branch_cd where c.brmast_cd like '''+@access_code+''''                
                
end                
exec(@str)                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_branch1
-- --------------------------------------------------
CREATE proc dbo.contest_mis_branch1(@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25),@flag as varchar(25))                                
as                                
set nocount on                                
Declare @str as varchar(3500)         
        
select * into #temp_hist from mis.genodinlimit.dbo.diet_cli_all_hist where date >='aug 01 2009'                   
                  
select distinct branch_cd=b.branch,reg_code=region, [No. of Clients Activated]=sum(case when b.mode='1st trade' then 1 else 0 end),                                
 [Total No. of Points] =sum(isnull(points,0)) into #fil                   
FROM ebrok_contest b                                
  where b.sauda_date>=convert(datetime,@fdate,103) and b.sauda_date<=convert(datetime,@tdate,103)                  
--and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )                 
 group by branch,region            
                  
select reg_code,c.branch_cd,[No. of Applications Recd. in KYC]=sum(case when y.usercode ='kyc' then 1 else 0 end),                            
 [No. of Applications Approved]=sum(case when y.usercode <>'kyc' then 1 else 0 end) into #fil2 from                  
 (select distinct party_code,usercode=max(usercode),date=max(date) from #temp_hist (nolock) group by party_code) y join risk.dbo.client_details c (nolock) on y.party_code=c.party_code     
join risk.dbo.region_temp d (nolock)  on c.branch_cd=d.code                  
 where y.date>=convert(datetime,@fdate,103) and y.date<=convert(datetime,@tdate,103)                 
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )          
and y.party_code collate Latin1_General_CI_AS            
not in (select party_code from risk.dbo.ebroking_contest_exclude1 (nolock))                       
 group by reg_code,c.branch_cd             
    
/*select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],                  
 [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2a a left outer join #fil b on                   
 a.branch_cd=b.branch_cd  where a.reg_code like 'MUMCENT'      
    
MUMCENT         
select code from risk.dbo.region_temp where reg_code='MUMCENT'    
select * from #fil2 where branch_cd in (select code from risk.dbo.region_temp where reg_code='MUMCENT')*/    
                  
if @access_to='BROKER' or @access_to='REGION'                           
begin                  
set @str=''                  
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                  
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'                   
 set @str=@str + ' a.branch_cd=b.branch_cd  where a.reg_code like '''+@flag+''''                  
end                  
if @access_to='BRANCH'                      
begin                  
set @str=''                  
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                  
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'                   
 set @str=@str + ' a.branch_cd=b.branch_cd  where a.branch_cd like '''+@access_code+''''                  
end                  
if @access_to='BRMAST'                      
begin                  
set @str=''                  
 set @str=@str + 'select a.branch_cd,[No. of Applications Recd. in KYC], [No. of Applications Approved],'                  
 set @str=@str + ' [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) from #fil2 a full outer join #fil b on'         
 set @str=@str + ' a.branch_cd=b.branch_cd join risk.dbo.branch_master c on a.branch_cd=c.branch_cd where c.brmast_cd like '''+@access_code+''''                  
                  
end                  
exec(@str)                              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_cli
-- --------------------------------------------------
CREATE proc dbo.contest_mis_cli (@fdate as varchar(25),@tdate as varchar(25),@branch as varchar(25),@flag as varchar(25),@reg as varchar(25))                          
as                          
set nocount on            
if @flag='a'          
begin          
SELECT X.party_code,X.short_name,X.online,X.total,POINTS=SUM(Y.POINTS)      
FROM (select distinct a.party_code,short_name=max(c.short_name),online=sum(case when user_stat<>'' then d.brokerage else 0 end),          
total=sum(d.brokerage)          
 from          
mis.genodinlimit.dbo.diet_cli_all_hist a left outer join ebrok_contest b on a.party_code=b.party_code          
join risk.dbo.client_details c on a.party_code=c.party_code left outer join bsedb_ab.dbo.MIS_ebroking_cli d          
on b.party_code=d.party_code collate Latin1_General_CI_AS and b.sauda_date=d.sauda_date   
left outer join risk.dbo.region_temp e on c.branch_cd=e.code          
where c.branch_cd like @branch and usercode='kyc'  and e.reg_code like @reg     
and a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@Tdate,103)       
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )        
group by a.party_code  ) X LEFT OUTER JOIN ebrok_contest Y ON X.PARTY_CODE=Y.PARTY_CODE      
GROUP BY X.party_code,X.short_name,X.online,X.total      
end          
if @flag='b'          
begin          
SELECT X.party_code,X.short_name,X.online,X.total,POINTS=SUM(Y.POINTS)      
FROM (select distinct a.party_code,short_name=max(c.short_name),online=sum(case when user_stat<>'' then d.brokerage else 0 end),          
total=sum(d.brokerage)          
 from          
mis.genodinlimit.dbo.diet_cli_all_hist a left outer join ebrok_contest b on a.party_code=b.party_code          
join risk.dbo.client_details c on a.party_code=c.party_code left outer join bsedb_ab.dbo.MIS_ebroking_cli d          
on b.party_code=d.party_code collate Latin1_General_CI_AS and b.sauda_date=d.sauda_date   
left outer join risk.dbo.region_temp e on c.branch_cd=e.code            
where c.branch_cd like @branch and usercode<>'kyc'  and e.reg_code like @reg        
and a.date>=convert(datetime,@fdate,103) and a.date<=convert(datetime,@Tdate,103)       
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )        
group by a.party_code  ) X LEFT OUTER JOIN ebrok_contest Y ON X.PARTY_CODE=Y.PARTY_CODE      
GROUP BY X.party_code,X.short_name,X.online,X.total      
end          
if @flag='c'          
begin          
select distinct party_code,short_name=max(client_name),online=sum(online_brok),          
total=sum(tot_brok)          
,points from          
 ebrok_contest               
where branch like @branch and mode='1st trade' and region like @reg and sauda_date>=convert(datetime,@fdate,103) and sauda_date<=convert(datetime,@tdate,103)       
and sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )          
group by party_code,points          
end          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_reg
-- --------------------------------------------------
CREATE proc dbo.contest_mis_reg (@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))                                    
as                                    
set nocount on                                    
Declare @str as varchar(3500)     
    
select * into #temp_hist from mis.genodinlimit.dbo.diet_cli_all_hist where date >='aug 01 2009'                          
                      
select distinct reg_code=region, [No. of Clients Activated]=sum(case when b.mode='1st trade' then 1 else 0 end),                                    
 [Total No. of Points] =sum(isnull(points,0)) into #file FROM ebrok_contest b                                    
 where b.sauda_date>=convert(datetime,@FDATE,103) and b.sauda_date<=convert(datetime,@tdate,103)                     
--and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )                     
 group by region                    
                      
    
  
select d.reg_code,[No. of Applications Recd. in KYC]=sum(case when y.usercode ='kyc' then 1 else 0 end),                          
 [No. of Applications Approved]=sum(case when y.usercode <>'kyc' then 1 else 0 end),  
[Total Clients Added]=count(y.party_code) into #file2 from                
 (select distinct party_code,usercode=max(usercode),date=max(date) from #temp_hist (nolock) group by party_code) y   
join risk.dbo.client_details c (nolock) on y.party_code=c.party_code   
join risk.dbo.region_temp d (nolock)  on c.branch_cd=d.code                
 where y.date>=convert(datetime,@fdate,103) and y.date<=convert(datetime,@tdate,103)               
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )        
and y.party_code collate Latin1_General_CI_AS          
not in (select party_code from risk.dbo.ebroking_contest_exclude1 (nolock))    
 group by d.reg_code          
        
           
                      
IF @access_code='CSO'                      
begin                      
SET @access_code='%'                      
end                      
                      
if @access_to='BROKER' or @access_to='REGION'                               
begin                      
                    
select a.reg_code,[No. of Applications Recd. in KYC], [No. of Applications Approved],[Total Clients Added],                      
 [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) into #f from #file2 a left outer join #file b on                       
 a.reg_code=b.reg_code where a.reg_code like @access_code  
          
 select reg_code,[No. of Applications Recd. in KYC], [No. of Applications Approved],[Total Clients Added],          
 [No. of Clients Activated],[% of Active Clients]=case when [Total Clients Added]=0 then 0 else (([No. of Clients Activated]*100)/[Total Clients Added]) end,[Total No. of Points],          
 [Points per active cleint]=case when [No. of Clients Activated]=0 then 0 else ([Total No. of Points]/[No. of Clients Activated]) end from #f order by reg_code                 
          
end                      
                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.contest_mis_reg1
-- --------------------------------------------------
CREATE proc dbo.contest_mis_reg1 (@fdate as varchar(25),@tdate as varchar(25),@access_to as varchar(25),@access_code as varchar(25))                                      
as                                      
set nocount on                                      
Declare @str as varchar(3500)       
      
select * into #temp_hist from mis.genodinlimit.dbo.diet_cli_all_hist where date >='aug 01 2009'                            
                        
select distinct reg_code=region, [No. of Clients Activated]=sum(case when b.mode='1st trade' then 1 else 0 end),                                      
 [Total No. of Points] =sum(isnull(points,0)) into #file FROM ebrok_contest b                                      
 where b.sauda_date>=convert(datetime,@FDATE,103) and b.sauda_date<=convert(datetime,@tdate,103)                       
--and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )                       
 group by region                      
                        
      
    
select d.reg_code,[No. of Applications Recd. in KYC]=sum(case when y.usercode ='kyc' then 1 else 0 end),                            
 [No. of Applications Approved]=sum(case when y.usercode <>'kyc' then 1 else 0 end),    
[Total Clients Added]=count(y.party_code) into #file2 from                  
 (select distinct party_code,usercode=max(usercode),date=max(date) from #temp_hist (nolock) group by party_code) y     
join risk.dbo.client_details c (nolock) on y.party_code=c.party_code     
join risk.dbo.region_temp d (nolock)  on c.branch_cd=d.code                  
 where y.date>=convert(datetime,@fdate,103) and y.date<=convert(datetime,@tdate,103)                 
and c.sub_broker in (select distinct b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )          
and y.party_code collate Latin1_General_CI_AS            
not in (select party_code from risk.dbo.ebroking_contest_exclude1 (nolock))      
 group by d.reg_code            
          
             
                        
IF @access_code='CSO'                        
begin                        
SET @access_code='%'                        
end                        
                        
if @access_to='BROKER' or @access_to='REGION'                                 
begin                        
                      
select a.reg_code,[No. of Applications Recd. in KYC], [No. of Applications Approved],[Total Clients Added],                        
 [No. of Clients Activated]=isnull([No. of Clients Activated],0),[Total No. of Points]=isnull([Total No. of Points],0) into #f from #file2 a left outer join #file b on                         
 a.reg_code=b.reg_code where a.reg_code like @access_code    
            
 select reg_code,[No. of Applications Recd. in KYC], [No. of Applications Approved],[Total Clients Added],            
 [No. of Clients Activated],[% of Active Clients]=case when [Total Clients Added]=0 then 0 else (([No. of Clients Activated]*100)/[Total Clients Added]) end,[Total No. of Points],            
 [Points per active cleint]=case when [No. of Clients Activated]=0 then 0 else ([Total No. of Points]/[No. of Clients Activated]) end from #f order by reg_code                   
            
end                        
                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.createregion
-- --------------------------------------------------
CREATE procedure createregion
as
insert into MAPPED_BRCODE
select x.branch,x.code,x.branch,y.NBranchCode,y.RegionCode,y.code,'Y' from
(select * from angel3.investment.dbo.branch_master where code not in
(select code from MAPPED_BRCODE)) x
inner join
(
select * from intranet.risk.dbo.region
) y on x.cata = y.Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.crisis_cliposition
-- --------------------------------------------------

CREATE procedure crisis_cliposition(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))        
as        
        
set transaction isolation level read uncommitted        
set nocount on        
        
SELECT * into #file1 FROM CLIENT_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'        
    
    
/*        
SELECT            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,            
DEPOSIT=ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0),LIMIT_MULTI,            
GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0))*LIMIT_MULTI,            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,            
ALLOWED_DEBIT,GOODWILL,            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),            
HOLDING            
INTO #FILE2            
FROM #file1 a left outer join            
RISK.DBO.collection_client_details b            
on a.party_code=b.party_code            
            
            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b            
WHERE #file2.PARTY_CODE=B.CLCODE            
            
            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b            
WHERE #file2.PARTY_CODE=B.CLCODE            
            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b            
WHERE #file2.PARTY_CODE=B.CLCODE            
*/    
    
----------------- NEW LOGIC     
    
update #file1 set LIMIT_MULTI = 1    
    
update #file1 set LIMIT_MULTI = 4 where party_code in    
(    
select distinct party_code     
from ANGELFO.NSEFO.DBO.fobillvalan     
WHERE sauda_date  = (Select max(sauda_Date) from ANGELFO.NSEFO.DBO.fobillvalan)     
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type    
having sum(pqty-sqty) <> 0    
)    
    
    
update #file1 set LIMIT_MULTI = 4 where party_code in    
(    
select distinct party_code     
from ANGELCOMMODITY.MCDX.DBO.fobillvalan     
WHERE sauda_date  = (Select max(sauda_Date) from ANGELCOMMODITY.MCDX.DBO.fobillvalan)     
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type    
having sum(pqty-sqty) <> 0    
)    
    
update #file1 set LIMIT_MULTI = 4 where party_code in    
(    
select distinct party_code     
from ANGELCOMMODITY.NCDX.DBO.fobillvalan     
WHERE sauda_date  = (Select max(sauda_Date) from ANGELCOMMODITY.NCDX.DBO.fobillvalan)     
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type    
having sum(pqty-sqty) <> 0    
)    
    
    
SELECT            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,            
LEDGER=isnull(ABL,0)+isnull(ACDL,0)+isnull(CASH_DEPOSIT,0),    
HOLDING,    
LIMIT_MULTI,            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,            
ALLOWED_DEBIT,GOODWILL,            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),    
FO_COLL=convert(money,0)    
INTO #FILE2x    
FROM #file1 a left outer join            
RISK.DBO.collection_client_details b            
on a.party_code=b.party_code            
    
UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b            
WHERE #file2x.PARTY_CODE=B.CLCODE 
--and #FILE2x.LIMIT_MULTI=4    
                    
UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b            
WHERE #file2x.PARTY_CODE=B.CLCODE 
--and #FILE2x.LIMIT_MULTI=4    

UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b            
WHERE #file2x.PARTY_CODE=B.CLCODE 
--and #FILE2x.LIMIT_MULTI=4    
    
    
SELECT            
BRCODE,SBCODE,PARTY_CODE,PARTY_NAME,            
DEPOSIT=((case when ledger < ledger-holding then ledger-holding else ledger end)+fo_coll)*-1    
,LIMIT_MULTI,            
GROSS_EXP=(((case when ledger < ledger-holding then ledger-holding else ledger end)+fo_coll)*-1)*LIMIT_MULTI,    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,    
ALLOWED_DEBIT,GOODWILL,            
DEBIT_VALUE=ISNULL(ledger,0),            
HOLDING            
INTO #FILE2            
FROM #file2x    
    
--DROP TABLE #FILE2            
update #file2 set deposit=0, gross_exp=0 where deposit < 0    
---------------------------- NEW LOGIC END    
            
--select * from #file2            
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,      
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,      
cast(holding as int)as holding from #file2                  
       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.crms_online_ebrok_cli
-- --------------------------------------------------
CREATE proc dbo.crms_online_ebrok_cli          
as            
select distinct party_code into #online_cli from ebrok_client (nolock) where party_code in (select party_code from risk.dbo.client_details (nolock))           
    
select sauda_date,party_code,overall_brok_earned,ebrok_brok_earned    
into #mis_online       
from mis.remisior.dbo.tbl_ebrok_detail_cli    
where     
sauda_date>=Convert(datetime,'01'+'/'+Convert(varchar,datepart(mm,getdate()-90))+'/'+Convert(varchar,datepart(yyyy,getdate()-90)),103)        
and sauda_date<=dateadd(mm,3,Convert(datetime,'01'+'/'+Convert(varchar,datepart(mm,getdate()-90))+'/'+Convert(varchar,datepart(yyyy,getdate()-90)),103))-1     
    
-------------------------------------------------------------------------          
    
select party_code into #temp from #online_cli where party_code collate SQL_Latin1_General_CP1_CI_AS          
not in     
(select party_code   from #mis_online )          
    
    
Begin tran
          
truncate table crms_online_offline                                  
                
insert into crms_online_offline          
select party_code,status from (          
select distinct party_code,'online' as status --into #online           
from #online_cli where party_code in          
(select distinct party_code collate Latin1_General_CI_AS from #mis_online          
where ebrok_brok_earned>0.0    
 )          
union          
select distinct party_code,'online' from #online_cli where party_code not in           
(select distinct party_code collate Latin1_General_CI_AS  from #mis_online      )          
union all          
select distinct party_code,'offline' from #online_cli where party_code in          
(select distinct party_code collate Latin1_General_CI_AS from #mis_online          
 group by party_code having sum(ebrok_brok_earned)=0.0  
)           
) a     
order by party_code          

update crms_online_offline_updatetime set updt=getdate()

commit tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S1(@br as varchar(20))                              
AS                      
SET NOCOUNT ON                      
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #BSE from mis.dbo.ODIN_710S1 where tag like @br                     
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NSE from mis.dbo.ODIN_710S1 where tag like @br                     
                      
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='1',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='1',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NSEFO from mis.dbo.ODIN_710S1 where tag like @br                     
        
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #MCX from mis.dbo.ODIN_710S1 where tag like @br                             
                      
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='1',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NCDEX from mis.dbo.ODIN_710S1 where tag like @br                                           
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='0',Iclude_Book_Lose='0',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'          
--,Filler2='$'                      
into #COMMON from mis.dbo.ODIN_710S1 where tag like @br                                           
                      
                      
SELECT * FROM                      
(                      
select * from #BSE                      
union all                      
select * from #NSE           
union all                      
select * from #NSEFO                      
union all                      
select * from #MCX                      
union all                      
select * from #NCDEX              
union all                      
select * from #COMMON                      
)A                       
ORDER BY A.USER_ID                      
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S1_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S1_test1(@br as varchar(20),@search as varchar(10))                         
AS                      
SET NOCOUNT ON                      
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #BSE from mis.dbo.ODIN_710S1 where tag like @br and pcode like @search+'%'                                   
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NSE from mis.dbo.ODIN_710S1 where tag like @br   and pcode like @search+'%'                                 
                      
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='1',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='1',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NSEFO from mis.dbo.ODIN_710S1 where tag like @br  and pcode like @search+'%'                                  
        
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #MCX from mis.dbo.ODIN_710S1 where tag like @br  and pcode like @search+'%'                                          
                      
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                      
Include_Exposure_Margin='1',                      
Include_Book_Profit='1',Iclude_Book_Lose='1',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'          
--,Filler2='$'                      
into #NCDEX from mis.dbo.ODIN_710S1 where tag like @br and pcode like @search+'%'                                               
                      
        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                      
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                      
Include_Exposure_Margin='0',                      
Include_Book_Profit='0',Iclude_Book_Lose='0',                      
Include_Net_Permium='0',                      
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                      
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',        
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'          
--,Filler2='$'                      
into #COMMON from mis.dbo.ODIN_710S1 where tag like @br  and pcode like @search+'%'                                                        
                      
                      
SELECT * FROM                      
(                      
select * from #BSE                      
union all                      
select * from #NSE           
union all                      
select * from #NSEFO                      
union all                      
select * from #MCX                      
union all                      
select * from #NCDEX              
union all                      
select * from #COMMON                      
)A                       
ORDER BY A.USER_ID                      
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S2
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S2(@br as varchar(20))                                
AS                        
SET NOCOUNT ON                        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #BSE from mis.dbo.ODIN_710S2 where tag like @br                       
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NSE from mis.dbo.ODIN_710S2 where tag like @br                       
                        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='1',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='1',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NSEFO from mis.dbo.ODIN_710S2 where tag like @br                       
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #MCX from mis.dbo.ODIN_710S2 where tag like @br                               
                        
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='1',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NCDEX from mis.dbo.ODIN_710S2 where tag like @br                                             
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='0',Iclude_Book_Lose='0',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'            
--,Filler2='$'                        
into #COMMON from mis.dbo.ODIN_710S2 where tag like @br                                             
                        
                        
SELECT * FROM                        
(                        
select * from #BSE                        
union all                        
select * from #NSE             
union all                        
select * from #NSEFO                        
union all                        
select * from #MCX                        
union all                        
select * from #NCDEX                
union all                        
select * from #COMMON                        
)A                         
ORDER BY A.USER_ID                        
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S2_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S2_test1(@br as varchar(20),@search as varchar(10))                           
AS                        
SET NOCOUNT ON                        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #BSE from mis.dbo.ODIN_710S2 where tag like @br and pcode like @search+'%'                                     
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NSE from mis.dbo.ODIN_710S2 where tag like @br   and pcode like @search+'%'                                   
                        
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='1',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='1',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NSEFO from mis.dbo.ODIN_710S2 where tag like @br  and pcode like @search+'%'                                    
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #MCX from mis.dbo.ODIN_710S2 where tag like @br  and pcode like @search+'%'                                            
                        
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                        
Include_Exposure_Margin='1',                        
Include_Book_Profit='1',Iclude_Book_Lose='1',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'            
--,Filler2='$'                        
into #NCDEX from mis.dbo.ODIN_710S2 where tag like @br and pcode like @search+'%'                                                 
                        
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                        
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                        
Include_Exposure_Margin='0',                        
Include_Book_Profit='0',Iclude_Book_Lose='0',                        
Include_Net_Permium='0',                        
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                        
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',          
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'            
--,Filler2='$'                        
into #COMMON from mis.dbo.ODIN_710S2 where tag like @br  and pcode like @search+'%'                                                          
                        
                        
SELECT * FROM                        
(                        
select * from #BSE                        
union all                        
select * from #NSE             
union all                        
select * from #NSEFO                        
union all                        
select * from #MCX                        
union all                        
select * from #NCDEX                
union all                        
select * from #COMMON                        
)A                         
ORDER BY A.USER_ID                        
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S3
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S3(@br as varchar(20))                                  
AS                          
SET NOCOUNT ON                          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #BSE from mis.dbo.ODIN_710S3 where tag like @br                         
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NSE from mis.dbo.ODIN_710S3 where tag like @br                         
                          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='1',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='1',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NSEFO from mis.dbo.ODIN_710S3 where tag like @br                         
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #MCX from mis.dbo.ODIN_710S3 where tag like @br                                 
                          
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='1',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NCDEX from mis.dbo.ODIN_710S3 where tag like @br                                               
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='0',Iclude_Book_Lose='0',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'              
--,Filler2='$'                          
into #COMMON from mis.dbo.ODIN_710S3 where tag like @br                                               
                          
                          
SELECT * FROM                          
(                          
select * from #BSE                          
union all                          
select * from #NSE               
union all                          
select * from #NSEFO                          
union all                          
select * from #MCX                          
union all                          
select * from #NCDEX                  
union all                          
select * from #COMMON                          
)A                           
ORDER BY A.USER_ID                          
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S3_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S3_test1(@br as varchar(20),@search as varchar(10))                             
AS                          
SET NOCOUNT ON                          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #BSE from mis.dbo.ODIN_710S3 where tag like @br and pcode like @search+'%'                                       
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NSE from mis.dbo.ODIN_710S3 where tag like @br   and pcode like @search+'%'                                     
                          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='1',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='1',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NSEFO from mis.dbo.ODIN_710S3 where tag like @br  and pcode like @search+'%'                                      
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #MCX from mis.dbo.ODIN_710S3 where tag like @br  and pcode like @search+'%'                                              
                          
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                          
Include_Exposure_Margin='1',                          
Include_Book_Profit='1',Iclude_Book_Lose='1',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'              
--,Filler2='$'                          
into #NCDEX from mis.dbo.ODIN_710S3 where tag like @br and pcode like @search+'%'                                                   
                          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                          
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                          
Include_Exposure_Margin='0',                          
Include_Book_Profit='0',Iclude_Book_Lose='0',                          
Include_Net_Permium='0',                          
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',            
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'              
--,Filler2='$'                          
into #COMMON from mis.dbo.ODIN_710S3 where tag like @br  and pcode like @search+'%'                                                            
                          
                          
SELECT * FROM                          
(                          
select * from #BSE                          
union all                          
select * from #NSE               
union all                          
select * from #NSEFO                          
union all                          
select * from #MCX                          
union all                          
select * from #NCDEX                  
union all                          
select * from #COMMON                          
)A                           
ORDER BY A.USER_ID                          
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S4
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S4(@br as varchar(20))                                    
AS                            
SET NOCOUNT ON                            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #BSE from mis.dbo.ODIN_710S4 where tag like @br                           
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NSE from mis.dbo.ODIN_710S4 where tag like @br                           
                            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='1',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='1',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NSEFO from mis.dbo.ODIN_710S4 where tag like @br                           
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #MCX from mis.dbo.ODIN_710S4 where tag like @br                                   
                            
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='1',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NCDEX from mis.dbo.ODIN_710S4 where tag like @br                                                 
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='0',Iclude_Book_Lose='0',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                
--,Filler2='$'                            
into #COMMON from mis.dbo.ODIN_710S4 where tag like @br                                                 
                            
                            
SELECT * FROM                            
(                            
select * from #BSE                            
union all                            
select * from #NSE                 
union all                            
select * from #NSEFO                            
union all                            
select * from #MCX                            
union all                            
select * from #NCDEX                    
union all                            
select * from #COMMON                            
)A                             
ORDER BY A.USER_ID                            
                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S4_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S4_test1(@br as varchar(20),@search as varchar(10))                               
AS                            
SET NOCOUNT ON                            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #BSE from mis.dbo.ODIN_710S4 where tag like @br and pcode like @search+'%'                                         
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NSE from mis.dbo.ODIN_710S4 where tag like @br   and pcode like @search+'%'                                       
                            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='1',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='1',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NSEFO from mis.dbo.ODIN_710S4 where tag like @br  and pcode like @search+'%'                                        
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #MCX from mis.dbo.ODIN_710S4 where tag like @br  and pcode like @search+'%'                                                
                            
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',         
Include_Exposure_Margin='1',                            
Include_Book_Profit='1',Iclude_Book_Lose='1',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                
--,Filler2='$'                            
into #NCDEX from mis.dbo.ODIN_710S4 where tag like @br and pcode like @search+'%'                                                     
                            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                            
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                            
Include_Exposure_Margin='0',                            
Include_Book_Profit='0',Iclude_Book_Lose='0',                            
Include_Net_Permium='0',                            
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',              
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                
--,Filler2='$'                            
into #COMMON from mis.dbo.ODIN_710S4 where tag like @br  and pcode like @search+'%'                                                              
                            
                            
SELECT * FROM                            
(                            
select * from #BSE                            
union all                            
select * from #NSE                 
union all                            
select * from #NSEFO                            
union all                            
select * from #MCX                            
union all                            
select * from #NCDEX                    
union all                            
select * from #COMMON                            
)A                             
ORDER BY A.USER_ID                            
                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S5
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S5(@br as varchar(20))                                      
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S5 where tag like @br                             
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S5 where tag like @br                             
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S5 where tag like @br                             
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S5 where tag like @br                                     
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                            Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S5 where tag like @br                                                   
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S5 where tag like @br                                                   
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S5_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S5_test1(@br as varchar(20),@search as varchar(10))                                 
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S5 where tag like @br and pcode like @search+'%'                                           
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S5 where tag like @br   and pcode like @search+'%'                                         
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S5 where tag like @br  and pcode like @search+'%'                                          
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S5 where tag like @br  and pcode like @search+'%'                                                  
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',           
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S5 where tag like @br and pcode like @search+'%'                                                       
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S5 where tag like @br  and pcode like @search+'%'                                                                
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S6
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S6(@br as varchar(20))                                      
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S6 where tag like @br                             
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S6 where tag like @br                             
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S6 where tag like @br                             
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S6 where tag like @br                                     
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                            Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S6 where tag like @br                                                   
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S6 where tag like @br                                                   
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S6_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S6_test1(@br as varchar(20),@search as varchar(10))                                 
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S6 where tag like @br and pcode like @search+'%'                                           
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S6 where tag like @br   and pcode like @search+'%'                                         
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S6 where tag like @br  and pcode like @search+'%'                                          
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S6 where tag like @br  and pcode like @search+'%'                                                  
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',           
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S6 where tag like @br and pcode like @search+'%'                                                       
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S6 where tag like @br  and pcode like @search+'%'                                                                
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S7
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S7(@br as varchar(20))                                      
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S7 where tag like @br                             
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S7 where tag like @br                             
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S7 where tag like @br                             
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S7 where tag like @br                                     
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                            Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S7 where tag like @br                                                   
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S7 where tag like @br                                                   
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S7_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S7_test1(@br as varchar(20),@search as varchar(10))                                 
AS                              
SET NOCOUNT ON                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #BSE from mis.dbo.ODIN_710S7 where tag like @br and pcode like @search+'%'                                           
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSE from mis.dbo.ODIN_710S7 where tag like @br   and pcode like @search+'%'                                         
                              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='1',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NSEFO from mis.dbo.ODIN_710S7 where tag like @br  and pcode like @search+'%'                                          
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #MCX from mis.dbo.ODIN_710S7 where tag like @br  and pcode like @search+'%'                                                  
                              
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',           
Include_Exposure_Margin='1',                              
Include_Book_Profit='1',Iclude_Book_Lose='1',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                  
--,Filler2='$'                              
into #NCDEX from mis.dbo.ODIN_710S7 where tag like @br and pcode like @search+'%'                                                       
                              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                              
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                              
Include_Exposure_Margin='0',                              
Include_Book_Profit='0',Iclude_Book_Lose='0',                              
Include_Net_Permium='0',                              
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                  
--,Filler2='$'                              
into #COMMON from mis.dbo.ODIN_710S7 where tag like @br  and pcode like @search+'%'                                                                
                              
                              
SELECT * FROM                              
(                              
select * from #BSE                              
union all                              
select * from #NSE                   
union all                              
select * from #NSEFO                              
union all                              
select * from #MCX                              
union all                              
select * from #NCDEX                      
union all                              
select * from #COMMON                              
)A                               
ORDER BY A.USER_ID                              
                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S8
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S8(@br as varchar(20))                                        
AS                                
SET NOCOUNT ON                                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #BSE from mis.dbo.ODIN_710S8 where tag like @br                               
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NSE from mis.dbo.ODIN_710S8 where tag like @br                               
                                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='1',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='1',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NSEFO from mis.dbo.ODIN_710S8 where tag like @br                               
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #MCX from mis.dbo.ODIN_710S8 where tag like @br                                       
                                
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='1',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                            Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NCDEX from mis.dbo.ODIN_710S8 where tag like @br                                                     
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='0',Iclude_Book_Lose='0',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                    
--,Filler2='$'                                
into #COMMON from mis.dbo.ODIN_710S8 where tag like @br                                                     
                                
                                
SELECT * FROM                                
(                                
select * from #BSE                                
union all                                
select * from #NSE                     
union all                                
select * from #NSEFO                                
union all                                
select * from #MCX                                
union all                                
select * from #NCDEX                        
union all                                
select * from #COMMON                                
)A                                 
ORDER BY A.USER_ID                                
                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_710S8_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_710S8_test1(@br as varchar(20),@search as varchar(10))                                   
AS                                
SET NOCOUNT ON                                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #BSE from mis.dbo.ODIN_710S8 where tag like @br and pcode like @search+'%'                                             
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='1',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NSE from mis.dbo.ODIN_710S8 where tag like @br   and pcode like @search+'%'                                           
                                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='1',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='1',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NSEFO from mis.dbo.ODIN_710S8 where tag like @br  and pcode like @search+'%'                                            
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #MCX from mis.dbo.ODIN_710S8 where tag like @br  and pcode like @search+'%'                                                    
                                
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='1',Include_MTML='1',             
Include_Exposure_Margin='1',                                
Include_Book_Profit='1',Iclude_Book_Lose='1',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='1',Delivery_Allowed='0',Margin_Plus_Allowed='1'                    
--,Filler2='$'                                
into #NCDEX from mis.dbo.ODIN_710S8 where tag like @br and pcode like @search+'%'                                                         
                                
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                                
TopUP_Margin='0',Maximum_Order='0',Include_MTMP='0',Include_MTML='0',                                
Include_Exposure_Margin='0',                                
Include_Book_Profit='0',Iclude_Book_Lose='0',                                
Include_Net_Permium='0',                                
Include_Surveillance_for_AMO='1',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0',                  
Margin_Allowed='0',Delivery_Allowed='0',Margin_Plus_Allowed='0'                    
--,Filler2='$'                                
into #COMMON from mis.dbo.ODIN_710S8 where tag like @br  and pcode like @search+'%'                                                                  
                                
                                
SELECT * FROM                                
(                                
select * from #BSE                                
union all                                
select * from #NSE                     
union all                                
select * from #NSEFO                                
union all                                
select * from #MCX                                
union all                                
select * from #NCDEX                        
union all                                
select * from #COMMON                                
)A                                 
ORDER BY A.USER_ID                                
                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S1
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S1(@br as varchar(20))                  
AS          
SET NOCOUNT ON          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #BSE from mis.dbo.odin_79 where tag like @br        
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NSE from mis.dbo.odin_79 where tag like @br   
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='1',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NSEFO from mis.dbo.odin_79 where tag like @br   
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #MCX from mis.dbo.odin_79 where tag like @br   
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NCDEX from mis.dbo.odin_79 where tag like @br    
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #COMMON from mis.dbo.odin_79 where tag like @br   
          
SELECT * FROM          
(          
select * from #BSE          
union all          
select * from #NSE          
union all          
select * from #NSEFO          
union all          
select * from #MCX          
union all          
select * from #NCDEX          
union all          
select * from #COMMON          
)A           
ORDER BY A.USER_ID          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S1_test
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S1_test(@br as varchar(20))                    
AS            
SET NOCOUNT ON            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #BSE from mis.dbo.odin_79 where tag like @br   
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSE from mis.dbo.odin_79 where tag like @br          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='1',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSEFO from mis.dbo.odin_79 where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
---,Filler2=' '            
into #MCX from mis.dbo.odin_79 where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NCDEX from mis.dbo.odin_79 where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #COMMON from mis.dbo.odin_79 where tag like @br          
            
SELECT * FROM            
(            
select * from #BSE            
union all            
select * from #NSE            
union all            
select * from #NSEFO            
union all            
select * from #MCX            
union all            
select * from #NCDEX            
union all     
select * from #COMMON            
)A             
ORDER BY A.USER_ID            
            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S1_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S1_test1(@br as varchar(20),@search as varchar(10))                  
AS          
  
SET NOCOUNT ON          
  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #BSE from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'  
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NSE from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='1',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NSEFO from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
---,Filler2=' '          
into #MCX from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #NCDEX from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
          
          
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',          
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',          
Include_Exposure_Margin='0',          
Include_Book_Profit='1',Iclude_Book_Lose='1',          
Include_Net_Permium='0',          
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',          
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '          
into #COMMON from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
          
SELECT * FROM          
(          
select * from #BSE          
union all          
select * from #NSE          
union all          
select * from #NSEFO          
union all          
select * from #MCX          
union all          
select * from #NCDEX          
union all          
select * from #COMMON          
)A           
ORDER BY A.USER_ID          
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S2
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S2(@br as varchar(20))                    
AS            
SET NOCOUNT ON            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #BSE from mis.dbo.odin_79NEW where tag like @br            
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSE from mis.dbo.odin_79NEW  where tag like @br          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='1',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSEFO from mis.dbo.odin_79NEW  where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #MCX from mis.dbo.odin_79NEW where tag like @br           
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NCDEX from mis.dbo.odin_79NEW  where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #COMMON from mis.dbo.odin_79NEW where tag like @br           
            
SELECT * FROM            
(            
select * from #BSE            
union all            
select * from #NSE            
union all            
select * from #NSEFO            
union all            
select * from #MCX            
union all            
select * from #NCDEX           
union all            
select * from #COMMON            
)A             
ORDER BY A.USER_ID            
            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S2_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S2_test1(@br as varchar(20),@search as varchar(10))  
AS              
SET NOCOUNT ON              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #BSE from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'  
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NSE from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='1',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NSEFO from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'           
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #MCX from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'            
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NCDEX from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'           
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #COMMON from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'            
           
SELECT * FROM              
(              
select * from #BSE              
union all              
select * from #NSE              
union all              
select * from #NSEFO              
union all              
select * from #MCX              
union all              
select * from #NCDEX             
union all              
select * from #COMMON              
)A               
ORDER BY A.USER_ID              
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S3
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S3(@br as varchar(20))                    
AS            
SET NOCOUNT ON            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #BSE from mis.dbo.ODIN_79S3 where tag like @br           
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSE from mis.dbo.ODIN_79S3  where tag like @br          
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='1',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NSEFO from mis.dbo.ODIN_79S3  where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #MCX from mis.dbo.ODIN_79S3  where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #NCDEX from mis.dbo.ODIN_79S3  where tag like @br          
            
            
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',            
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',            
Include_Exposure_Margin='0',            
Include_Book_Profit='1',Iclude_Book_Lose='1',            
Include_Net_Permium='0',            
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',            
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '            
into #COMMON from mis.dbo.ODIN_79S3 where tag like @br           
            
SELECT * FROM            
(            
select * from #BSE            
union all            
select * from #NSE            
union all            
select * from #NSEFO            
union all            
select * from #MCX            
union all            
select * from #NCDEX    
union all            
select * from #COMMON            
)A             
ORDER BY A.USER_ID            
            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRP_79S3_test1
-- --------------------------------------------------
CREATE PROCEDURE CRP_79S3_test1(@br as varchar(20),@search as varchar(10))  
AS              
SET NOCOUNT ON              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #BSE from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'             
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NSE from mis.dbo.ODIN_79S3  where tag like @br and pcode like @search+'%'            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='1',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NSEFO from mis.dbo.ODIN_79S3  where tag like @br and pcode like @search+'%'            
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #MCX from mis.dbo.ODIN_79S3  where tag like @br and pcode like @search+'%'            
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #NCDEX from mis.dbo.ODIN_79S3  where tag like @br and pcode like @search+'%'            
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'
--,Filler2=' '              
into #COMMON from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'       
              
SELECT * FROM              
(              
select * from #BSE              
union all              
select * from #NSE              
union all              
select * from #NSEFO              
union all              
select * from #MCX              
union all              
select * from #NCDEX      
union all              
select * from #COMMON              
)A               
ORDER BY A.USER_ID              
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ctcl_fo_open_position
-- --------------------------------------------------

CREATE procedure ctcl_fo_open_position
as

set nocount on
set transaction isolation level read uncommitted
select party_code,inst_type,symbol, 
tdate=substring(convert(varchar(11),expiryDate),5,2)+'-'+substring(convert(varchar(11),expiryDate),1,3)+'-'+substring(convert(varchar(11),expiryDate),8,4) 
,strike_price,option_type,pqty=sum(pqty),sqty=sum(sqty),pamt=sum(pamt),samt=sum(samt) 
into #file1
from angelfo.nsefo.dbo.fobillvalan where sauda_Date = (select max(sauda_date) from angelfo.nsefo.dbo.fobillvalan) 
and party_Code in  (select clientcode=[user id] from ctcl_client (nolock) where status='A') 
group by party_code,inst_type,symbol,expiryDate,strike_price,option_type 

select a.party_Code,groupid=b.[group id],Terminal='7826',inst_type,symbol,series='',tdate,strike_price,option_type,
pqty,pamt,sqty,samt 
from #file1 a (nolock), ctcl_client b (nolock) where a.party_code=b.[user id]

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_ecn
-- --------------------------------------------------
CREATE proc ebrok_ecn (@branch as varchar(30))          
as           
set nocount on       
       
--select distinct * from    
select client='WITH',ecn=sum(case when repatriat_bank_ac_no like '%ecn%' then 1 else 0 end),          
email=sum(case when email like '%@%' then 1 else 0 end),    
mobile=sum(case when len(mobile_pager)>=10 then 1 else 0 end)           
from risk.dbo.client_details a with (nolock),(select distinct party_code     
from ebrok_client1 with (nolock)) b     
where branch_cd like @branch and a.party_code=b.party_code and a.last_inactive_date>getdate()          
union     
select  client='WITHOUT',ecn=sum(case when repatriat_bank_ac_no not like '%ecn%' then 1 else 0 end),          
email=sum(case when email not like '%@%' then 1 else 0 end),    
mobile=sum(case when len(mobile_pager)<10 then 1 else 0 end)           
from risk.dbo.client_details a with (nolock) ,(select distinct party_code     
from ebrok_client1 with (nolock)) b     
where branch_cd like @branch and a.party_code=b.party_code and a.last_inactive_date>getdate()    
       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrok_ecn_details
-- --------------------------------------------------
CREATE proc ebrok_ecn_details (@branch as varchar(30),@flag as varchar(5),@client as varchar(30))          
as          
set nocount on          
if @flag='A'          
begin          
if @client='with'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')    
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code and repatriat_bank_ac_no like 'ECN%' and a.last_inactive_date>getdate()      
    
end          
if @client='without'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code and repatriat_bank_ac_no not like 'ECN%' and a.last_inactive_date>getdate()      
end          
if @client='%'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code  and a.last_inactive_date>getdate()      
end          
end          
if @flag='B'          
begin          
if @client='with'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where     
 branch_cd like @branch and  a.party_code=b.party_code and EMAIL like '%@%' and a.last_inactive_date>getdate()      
end          
if @client='without'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where  branch_cd like @branch and  a.party_code=b.party_code and EMAIL not like '%@%' and a.last_inactive_date>getdate()      
end          
if @client='%'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code  and a.last_inactive_date>getdate()      
end          
end          
if @flag='C'          
begin          
if @client='with'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date =replace(comb_last_date,'Jan  1 1900 12:00AM','')  
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and  a.party_code=b.party_code and len(mobile_pager)>=10 and a.last_inactive_date>getdate()      
end          
if @client='without'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and  a.party_code=b.party_code and len(mobile_pager)<10  and a.last_inactive_date>getdate()      
end          
if @client='%'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code  and a.last_inactive_date>getdate()      
end          
end          
if @flag='O'          
begin          
if @client='with'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')    
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code and repatriat_bank_ac_no like 'ECN%'     
 and EMAIL like '%@%'     
 and len(mobile_pager)>=10 and a.last_inactive_date>getdate()      
end          
if @client='without'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')    
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code and repatriat_bank_ac_no not like 'ECN%' and a.last_inactive_date>getdate()      
or branch_cd like @branch and  a.party_code=b.party_code and EMAIL not like '%@%' and a.last_inactive_date>getdate()      
or branch_cd like @branch and  a.party_code=b.party_code and len(mobile_pager)<10  and a.last_inactive_date>getdate()      
    
end          
if @client='%'          
begin          
select distinct branch_cd,sub_broker,a.party_code,short_name,    
ECN=case when repatriat_bank_ac_no like 'ECN%' then 'YES' Else 'NO' end,    
EMAIL=case when email like '%@%' then 'YES' Else 'NO' end,    
mobile_pager=case when len(mobile_pager)>=10  then 'YES' Else 'NO' end ,comb_last_date=replace(comb_last_date,'Jan  1 1900 12:00AM','')   
from risk.dbo.client_details a , ebrok_client1 b (nolock)    
where branch_cd like @branch and a.party_code=b.party_code  and a.last_inactive_date>getdate()      
end          
end          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebroking_contest
-- --------------------------------------------------
CREATE proc dbo.ebroking_contest(@fdate as varchar(11))                          
as                          
if @fdate='%'             
BEGIN            
--declare @fdate as varchar(11)                          
 select @fdate=max(sauda_date) from mis.remisior.dbo.comb_co                                   
END            
                          
      
select party_code,usercode,insert_date=MAX(insert_date),Introducer=space(20),sub_broker=space(12) into #file1                          
from mis.genodinlimit.dbo.diet_cli_all_hist where insert_date>='aug 01 2009'                          
GROUP BY party_code,usercode                      
                          
    
DELETE FROM #file1 WHERE USERCODE='CALLNTRADE' AND PARTY_CODE IN    
(    
SELECT PARTY_CODE FROM #file1 where USERCODE='kyc'    
)                          
                          
update #file1 set Introducer=b.intru_code from ClientRequestOfflineOnline b where #file1.party_code=b.party_code                          
and #file1.usercode<>'KYC'                          
                          
/*select   boparty_code,executive from middleware.mimansa.crm.dbo.climast                          
where boparty_code in (select party_code from ebrok_client (nolock)) and entrydate>='jul 01 2009'                          
                        
select * from #file1                        
*/                          
                          
update #file1 set Introducer=b.executive from middleware.mimansa.dbo.climast b where #file1.party_code=b.boparty_code                          
and #file1.usercode='KYC'                          
                          
                          
                          
                          
--b2c and online                          
update #file1 set sub_broker=b.sub_broker from intranet.risk.dbo.client_details b                          
where #file1.party_code=b.party_code                          
                          
select * into #file2  from #file1 where sub_broker in                           
(select b2c_sb from mis.remisior.dbo.b2c_sb  )                            
                          
/*select distinct  a.party_code,intru_code=max(a.intru_code),b.sub_broker into #file2                           
from #file1 a                          
join intranet.risk.dbo.client_details b on a.party_code=b.party_code where b.sub_broker in                           
(select b2c_sb from mis.remisior.dbo.b2c_sb  )                            
 group by a.party_code,b.sub_broker order by a.party_code                          
*/                          
--select * from #file2 order by party_code                                         
                          
                 
--print @fdate                        
                          
---------------subsequent points---------------                          
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                          
tot=sum(brokerage),b.sauda_date into #ff2                         
from intranet.bsedb_ab.dbo.MIS_ebroking_cli b  where party_code in            
( select distinct party_code collate Latin1_General_CI_AS        from ebrok_contest  )              
--on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                          
and b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,party_code                          
having sum(brokerage)>25                                    
                          
--insert points subsequent                          
insert into ebrok_contest                          
select distinct Introducer,b.party_code,b.sauda_date,'subsequent trade',points=case when ((online/tot)*100)<50.00 and tot>25.00 then 25                           
when ((online/tot)*100)>=50.00 and ((online/tot)*100)<75 then 50                          
when ((online/tot)*100)>=75.00 then 100 end,getdate(),cli_points=convert(int,online)/100 from  #file2 a join #ff2 b                          
on a.party_code=b.party_code  collate Latin1_General_CI_AS       
where online>0.0                    
                          
----------------------1st trade------  select convert(int,299.99)/100                        
                        
                         
select distinct a.party_code,sauda_date into #f                         
from #file2 a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                          
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                          
where sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59' and user_stat<>'' and a.party_code not in                          
(select party_code from ebrok_contest)                          
                        
                        
select a.party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                          
tot=sum(brokerage),b.sauda_date into #ff3                         
from #f a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                          
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                          
where b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,a.party_code                          
                          
--insert 1st trade                          
--create table ebrok_contest (intrucode varchar(25),party_code varchar(25),sauda_date datetime,mode varchar(50),points int,update_date datetime)                          
insert into ebrok_contest                          
select distinct Introducer,b.party_code,b.sauda_date,'1st trade',50,getdate(),cli_points=convert(int,online)/100 from #file2 a join #ff3 b                          
on a.party_code collate Latin1_General_CI_AS =b.party_code                          
--and isnull(introducer,'')<>''                          
--(Call N Trade Client igonered)                          
                          
                          
-----month end-------                          
if (datepart(mm,getdate())>8 and datepart(dd,getdate())=1)                          
begin                          
                          
select cnt=count(party_code),party_code into #new1 from ebrok_contest where points>50 and mode='subsequent trade'                          
and sauda_date>=convert(datetime,'01/'+ convert(varchar,datepart(mm,getdate())-1) +'/2009',103) and                          
sauda_date<=convert(datetime,convert(varchar,getdate()-1,103),103)                          
group by party_code                          
having count(party_code)>=5                          
                          
--bonus insert                          
insert into ebrok_contest                          
select distinct intru_code,b.party_code,getdate(),'bonus',50,getdate(),0 from #file2 a join #new1 b                          
on a.party_code=b.party_code                          
                          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebroking_contest1
-- --------------------------------------------------
CREATE proc dbo.ebroking_contest1(@fdate as varchar(11))                                                  
as                                                  
if @fdate='%'                                     
BEGIN                                    
--declare @fdate as varchar(11)                                                  
 select @fdate=max(sauda_date) from mis.remisior.dbo.comb_co                          
--print @fdate                                                         
END                                    
                                                  
                              
select party_code,usercode,insert_date=MAX(insert_date),Introducer=space(20),sub_broker=space(12) into #file1                                                  
from mis.genodinlimit.dbo.diet_cli_all_hist where insert_date>='aug 01 2009'                                                  
GROUP BY party_code,usercode                                              
   
insert into #file1  
SELECT party_code,br_approvedby,request_date=max(request_date),Introducer=space(20),sub_broker=space(12) FROM ClientRequestOfflineOnline (nolock) WHERE PARTY_CODE NOT IN   
(SELECT party_code FROM #file1 ) and BR_APPROVED='Y' AND GENERATED=1   
and request_date>='aug 01 2009'   
group by party_code,br_approvedby                                                    
                            
DELETE FROM #file1 WHERE USERCODE='CALLNTRADE' AND PARTY_CODE IN                            
(                            
SELECT PARTY_CODE FROM #file1 where USERCODE='kyc'                            
)                                                  
                                                  
update #file1 set Introducer=b.intru_code from ClientRequestOfflineOnline b where #file1.party_code=b.party_code                                                  
and #file1.usercode<>'KYC'                                                  
                                                  
/*select   boparty_code,executive from middleware.mimansa.dbo.climast                                                  
where boparty_code in (select party_code from ebrok_client (nolock)) and entrydate>='jul 01 2009'                                                  
                                                
select * from #file1  where party_code='S73151'                                              
*/                                                  
                                                  
update #file1 set Introducer=b.executive from middleware.mimansa.dbo.climast b where #file1.party_code=b.boparty_code                                                  
and #file1.usercode='KYC'                                                  
                                                  
                                                  
                                                  
                                                  
--b2c and online                                                  
update #file1 set sub_broker=b.sub_broker from intranet.risk.dbo.client_details b                                                  
where #file1.party_code=b.party_code                                                  
                                                  
select * into #file2  from #file1 where sub_broker in                                                   
(select b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )              
              
DELETE from #file2 where party_code in (select DISTINCT PARTY_CODE collate Latin1_General_CI_AS from bsedb_ab.dbo.MIS_ebroking_cli (NOLOCK)   
where sauda_date>='apr 01 2009' and sauda_date<='jul 31 2009'                                                  
AND user_stat<>'' AND BROKERAGE>0.0  )               
              
                                               
/*select distinct  a.party_code,intru_code=max(a.intru_code),b.sub_broker into #file2                                                   
from #file1 a                                                  
join intranet.risk.dbo.client_details b on a.party_code=b.party_code where b.sub_broker in                                                   
(select b2c_sb from mis.remisior.dbo.b2c_sb  )                                                    
 group by a.party_code,b.sub_broker order by a.party_code                                                  
*/                                                  
--select (datepart(mm,sauda_date)) from ebrok_contest order by party_code                         
                        
-------bonus-------------------------  select * from #temp                                                              
select party_code into #temp                    
from ebrok_contest where (datepart(mm,sauda_date))=(datepart(mm,getdate())) group by party_code,(datepart(mm,sauda_date)) having count(1)>=5                                        
                        
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                  
tot=sum(brokerage),b.sauda_date into #temp2  from intranet.bsedb_ab.dbo.MIS_ebroking_cli b  where party_code in                                        
( select distinct party_code collate Latin1_General_CI_AS from #temp)                        
and sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59'   group by sauda_date,party_code                                                  
having  sum(brokerage)>25 and (((sum(case when user_stat<>'' then brokerage else 0 end))/(sum(brokerage)))*100)>=50                         
                        
                        
insert into ebrok_contest                          
select distinct max(isnull(intrucode,'')),party_code,@fdate,'Bonus',50,getdate(),0 from ebrok_contest where party_code in                         
(select distinct party_code collate Latin1_General_CI_AS from #temp2)       
group by party_code                       
--print @fdate select * from ebrok_contest where party_code='A19613'                                              
                                        
---------------subsequent points---------------                                                  
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                  
tot=sum(brokerage),b.sauda_date into #ff2                                                 
from intranet.bsedb_ab.dbo.MIS_ebroking_cli b  where party_code in                                    
( select distinct party_code collate Latin1_General_CI_AS from ebrok_contest  )                                      
--on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                                  
and b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,party_code                                                  
having sum(brokerage)>25                                                            
                                                  
--insert points subsequent                                                  
insert into ebrok_contest                                                  
select distinct max(isnull(c.intrucode,'')),b.party_code,b.sauda_date,'subsequent trade',points=case when ((online/tot)*100)<50.00 and tot>25.00 then 25                                                   
when ((online/tot)*100)>=50.00 and ((online/tot)*100)<75 then 50                                                  
when ((online/tot)*100)>=75.00 then 100 end,getdate(),cli_points=convert(int,online)/100 from  #file2 a join #ff2 b                                                  
on a.party_code=b.party_code  collate Latin1_General_CI_AS join  ebrok_contest c on      
  b.party_code=c.party_code collate Latin1_General_CI_AS                        
where online>0.0 group by b.party_code,b.sauda_date ,online,tot                                          
                                                  
----------------------1st trade------  select convert(int,299.99)/100                                                
                                                
                                                 
select distinct a.party_code,sauda_date into #f                                                 
from #file2 a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                                                  
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                                  
where sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59' and user_stat<>'' and a.party_code not in                                                  
(select party_code from ebrok_contest)                                                  
                                                
              
select a.party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                  
tot=sum(brokerage),b.sauda_date into #ff3                                                 
from #f a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                                                  
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                                  
where b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,a.party_code                                                  
                                                  
--insert 1st trade                                                  
--create table ebrok_contest (intrucode varchar(25),party_code varchar(25),sauda_date datetime,mode varchar(50),points int,update_date datetime)                                                  
insert into ebrok_contest                                                  
select distinct max(isnull(Introducer,'')),b.party_code,b.sauda_date,'1st trade',50,getdate(),cli_points=convert(int,online)/100 from #file2 a join #ff3 b                                                  
on a.party_code collate Latin1_General_CI_AS =b.party_code          
group by b.party_code,b.sauda_date,online                                              
--and isnull(introducer,'')<>''                                                  
--(Call N Trade Client igonered)                                                  
                                                  
                                                  
-----month end-------                                       
/*if (datepart(mm,getdate())>8 and datepart(dd,getdate())=1)                                                  
begin                                                  
                                                  
select cnt=count(party_code),party_code into #new1 from ebrok_contest where points>50 and mode='subsequent trade'                                                  
and sauda_date>=convert(datetime,'01/'+ convert(varchar,datepart(mm,getdate())-1) +'/2009',103) and                                      
sauda_date<=convert(datetime,convert(varchar,getdate()-1,103),103)                                                  
group by party_code                                                  
having count(party_code)>=5                       
                                                  
--bonus insert                                                  
insert into ebrok_contest                                                  
select distinct intru_code,b.party_code,getdate(),'bonus',50,getdate(),0 from #file2 a join #new1 b                            
on a.party_code=b.party_code                                                  
                                                  
end */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebroking_contest1_TEMP
-- --------------------------------------------------
CREATE proc dbo.ebroking_contest1_TEMP(@fdate as varchar(11))                                              
as                                              
if @fdate='%'                                 
BEGIN                                
--declare @fdate as varchar(11)                                              
 select @fdate=max(sauda_date) from mis.remisior.dbo.comb_co                      
--print @fdate                                                     
END                                
                                              
                          
select party_code,usercode,insert_date=MAX(insert_date),Introducer=space(20),sub_broker=space(12) into #file1                                              
from mis.genodinlimit.dbo.diet_cli_all_hist where insert_date>='aug 01 2009'                                              
GROUP BY party_code,usercode                                          
                                              
                        
DELETE FROM #file1 WHERE USERCODE='CALLNTRADE' AND PARTY_CODE IN                        
(                        
SELECT PARTY_CODE FROM #file1 where USERCODE='kyc'                        
)                                              
                                              
update #file1 set Introducer=b.intru_code from ClientRequestOfflineOnline b where #file1.party_code=b.party_code                                              
and #file1.usercode<>'KYC'                                              
                                              
/*select   boparty_code,executive from middleware.mimansa.dbo.climast                                              
where boparty_code in (select party_code from ebrok_client (nolock)) and entrydate>='jul 01 2009'                                              
                                            
select * from #file1  where party_code='S73151'                                          
*/                                              
                                              
update #file1 set Introducer=b.executive from middleware.mimansa.dbo.climast b where #file1.party_code=b.boparty_code                                              
and #file1.usercode='KYC'                                              
                                              
                                              
                                              
                                              
--b2c and online                                              
update #file1 set sub_broker=b.sub_broker from intranet.risk.dbo.client_details b                                              
where #file1.party_code=b.party_code                                              
                                              
select * into #file2  from #file1 where sub_broker in                                               
(select b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )          
          
DELETE from #file2 where party_code in (select DISTINCT PARTY_CODE collate Latin1_General_CI_AS from bsedb_ab.dbo.MIS_ebroking_cli (NOLOCK) where sauda_date>='apr 01 2009' and sauda_date<='jul 31 2009'                                              
AND user_stat<>'' AND BROKERAGE>0.0  )           
          
                                           
/*select distinct  a.party_code,intru_code=max(a.intru_code),b.sub_broker into #file2                                               
from #file1 a                                              
join intranet.risk.dbo.client_details b on a.party_code=b.party_code where b.sub_broker in                                               
(select b2c_sb from mis.remisior.dbo.b2c_sb  )                                                
 group by a.party_code,b.sub_broker order by a.party_code                                              
*/                                              
--select (datepart(mm,sauda_date)) from ebrok_contest order by party_code                     
                    
-------bonus-------------------------  select * from #temp                                                          
select party_code into #temp                
from ebrok_contest123 group by party_code,(datepart(mm,sauda_date)) having count(1)>=5                                    
                    
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                              
tot=sum(brokerage),b.sauda_date into #temp2  from intranet.bsedb_ab.dbo.MIS_ebroking_cli b  where party_code in                                    
( select distinct party_code collate Latin1_General_CI_AS from #temp)                    
and sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59'   group by sauda_date,party_code                                              
having  sum(brokerage)>0.0 and (((sum(case when user_stat<>'' then brokerage else 0 end))/(sum(brokerage)))*100)>=50                     
                    
                    
insert into ebrok_contest123                      
select distinct max(intrucode),party_code,@fdate,'Bonus',50,getdate(),0 from ebrok_contest123 where party_code in                     
(select distinct party_code collate Latin1_General_CI_AS from #temp2)   
group by party_code                   
--print @fdate select * from ebrok_contest where party_code='A19613'                                          
                                    
---------------subsequent points---------------                                              
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                              
tot=sum(brokerage),b.sauda_date into #ff2                                             
from intranet.bsedb_ab.dbo.MIS_ebroking_cli b  where party_code in                                
( select distinct party_code collate Latin1_General_CI_AS from ebrok_contest123  )                                  
--on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                              
and b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,party_code                                              
having sum(brokerage)>25                                                        
                                              
--insert points subsequent                                              
insert into ebrok_contest123                                              
select distinct max(c.intrucode),b.party_code,b.sauda_date,'subsequent trade',points=case when ((online/tot)*100)<50.00 and tot>25.00 then 25                                               
when ((online/tot)*100)>=50.00 and ((online/tot)*100)<75 then 50                                              
when ((online/tot)*100)>=75.00 then 100 end,getdate(),cli_points=convert(int,online)/100 from  #file2 a join #ff2 b                                              
on a.party_code=b.party_code  collate Latin1_General_CI_AS join  ebrok_contest123 c on  
  b.party_code=c.party_code collate Latin1_General_CI_AS                    
where online>0.0 group by b.party_code,b.sauda_date ,online,tot                                      
                                              
----------------------1st trade------  select convert(int,299.99)/100                                            
                                            
                                             
select distinct a.party_code,sauda_date into #f                                             
from #file2 a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                                              
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                              
where sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59' and user_stat<>'' and a.party_code not in                                              
(select party_code from ebrok_contest123)                                              
                                            
              
select a.party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                              
tot=sum(brokerage),b.sauda_date into #ff3                                             
from #f a join intranet.bsedb_ab.dbo.MIS_ebroking_cli b                                              
on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                              
where b.sauda_date>=@fdate and b.sauda_date<=@fdate+' 23:59:59'   group by b.sauda_date,a.party_code                                              
                                              
--insert 1st trade                                              
--create table ebrok_contest (intrucode varchar(25),party_code varchar(25),sauda_date datetime,mode varchar(50),points int,update_date datetime)                                              
insert into ebrok_contest123                                              
select distinct max(Introducer),b.party_code,b.sauda_date,'1st trade',50,getdate(),cli_points=convert(int,online)/100 from #file2 a join #ff3 b                                              
on a.party_code collate Latin1_General_CI_AS =b.party_code      
group by b.party_code,b.sauda_date,online                                          
--and isnull(introducer,'')<>''                                              
--(Call N Trade Client igonered)                                              
                                              
                                              
-----month end-------                                   
/*if (datepart(mm,getdate())>8 and datepart(dd,getdate())=1)                                              
begin                                              
                                              
select cnt=count(party_code),party_code into #new1 from ebrok_contest where points>50 and mode='subsequent trade'                                              
and sauda_date>=convert(datetime,'01/'+ convert(varchar,datepart(mm,getdate())-1) +'/2009',103) and                                  
sauda_date<=convert(datetime,convert(varchar,getdate()-1,103),103)                                              
group by party_code                                              
having count(party_code)>=5                   
                                              
--bonus insert                                              
insert into ebrok_contest                                              
select distinct intru_code,b.party_code,getdate(),'bonus',50,getdate(),0 from #file2 a join #new1 b                        
on a.party_code=b.party_code                                              
                                              
end */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebroking_contest2
-- --------------------------------------------------
CREATE proc dbo.ebroking_contest2(@fdate as varchar(11))                                                                                  
as                                                                                  
if @fdate='%'                                                                     
BEGIN                                                                    
 --declare @fdate as varchar(11)                                                                                  
 select @fdate=max(sauda_date) from mis.remisior.dbo.comb_co                                                          
--print @fdate                                                                                        
END                                                                    
                                
                                                                      
                                                              
select party_code,usercode,insert_date=MAX(insert_date),Introducer=space(20),sub_broker=space(12) into #file1                                                                                  
from mis.genodinlimit.dbo.diet_cli_all_hist where insert_date>='aug 01 2009'  and insert_date<=@fdate + ' 23:59:59'                                                                                 
GROUP BY party_code,usercode                                                                              
                                   
insert into #file1                                  
SELECT party_code,br_approvedby,request_date=max(request_date),Introducer=space(20),sub_broker=space(12) FROM ClientRequestOfflineOnline (nolock) WHERE PARTY_CODE NOT IN                                   
(SELECT party_code FROM #file1 ) and BR_APPROVED='Y' AND GENERATED=1                                   
and request_date>='aug 01 2009' and request_date<=@fdate + ' 23:59:59'                                      
group by party_code,br_approvedby                                                                                    
                                                            
DELETE FROM #file1 WHERE USERCODE='CALLNTRADE' AND PARTY_CODE IN                                                            
(                                                            
SELECT PARTY_CODE FROM #file1 where USERCODE='kyc'                                                            
)                                                                                  
                                                                                  
update #file1 set Introducer=b.intru_code from ClientRequestOfflineOnline b where #file1.party_code=b.party_code                                                                                  
and #file1.usercode<>'KYC'                                                                                  
                                                                                  
                                                                                  
update #file1 set Introducer=b.executive from middleware.mimansa.dbo.climast b where #file1.party_code=b.boparty_code                                                                                  
and #file1.usercode='KYC'                                                                                  
                                                                                  
                                                                                  
                                
                                                                                  
--b2c and online                                                                                  
update #file1 set sub_broker=b.sub_broker from risk.dbo.client_details b                                                                                  
where #file1.party_code=b.party_code                                                                                  
                                                                         
select *,region=space(15),branch=space(15),client_name=space(30),emp_name=space(50)                             
,emp_dept=space(60),cli_type=space(15),tot_brok=convert(money,0),Online_brok=convert(money,0)                                 
into #file2  from #file1 where sub_broker in                      
(select b2c_sb from mis.remisior.dbo.B2c_excl_franchisee  )                   
                                
update #file2 set client_name=b.short_name,branch=b.branch_cd--,sub_broker=b.sub_broker                                
from risk.dbo.client_details b                                
where #file2.party_code=b.party_code                                
                                
update #file2 set emp_name=b.emp_name,emp_dept=b.department from risk.dbo.emp_info b                                
where #file2.Introducer=b.emp_no                            
                                
update #file2 set region=b.reg_code from risk.dbo.region_temp b                                
where #file2.branch=b.code                                
                                
update #file2 set cli_type=b.usercode from #file1 b                                
where #file2.party_code=b.party_code                                
                                
                                            
 /*                                             
DELETE from #file2 where party_code collate Latin1_General_CI_AS in                                 
(select party_code from risk.dbo.ebroking_contest_exclude) */                             
                            
DELETE from #file2 where party_code in (select DISTINCT PARTY_CODE collate Latin1_General_CI_AS from bsedb_ab.dbo.MIS_ebroking_cli (NOLOCK)                               
where sauda_date>='apr 01 2009' and sauda_date<='jul 31 2009'                                                                              
AND user_stat<>'' AND BROKERAGE>0.0  )                                                         
                                              
select sauda_date,party_code,brokerage=sum(brokerage),user_stat into #brokfile from bsedb_ab.dbo.MIS_ebroking_cli   where                                 
sauda_date>=@fdate and sauda_date<=@fdate+' 23:59:59'                                   
group by sauda_date,party_code,user_stat                                                       
                                                        
-------bonus-------------------------  select * from #temp                                                                                              
select party_code into #temp                                                    
from ebrok_contest where (datepart(mm,sauda_date))=(datepart(mm,getdate()-1)) group by party_code,(datepart(mm,sauda_date)) having count(1)>=5                                                                        
                                                        
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                                                  
tot=sum(brokerage),b.sauda_date into #temp2  from #brokfile b  where party_code in                                                                        
( select distinct party_code collate Latin1_General_CI_AS from #temp)                                                        
group by sauda_date,party_code                                                                                  
having  sum(brokerage)>=25 and (((sum(case when user_stat<>'' then brokerage else 0 end))/CASE WHEN (sum(brokerage))=0 THEN 1 ELSE (sum(brokerage)) END)*100)>=50                    
                    
                                                        
                                
----------------------------------                                
insert into ebrok_contest                                                          
select distinct max(isnull(intrucode,'')),party_code,@fdate,'Bonus',50,getdate(),0,region,branch,sub_broker,client_name,emp_name,emp_dept,cli_type,0,0                               from ebrok_contest where party_code in                                    
 
                      
(select distinct party_code collate Latin1_General_CI_AS from #temp2)                              
group by party_code,region,branch,sub_broker,client_name,emp_name,emp_dept,cli_type                                
                                             
---------------subsequent points---------------                                                                                  
select party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                                                  
tot=sum(brokerage),b.sauda_date into #ff2                                                                                 
from #brokfile b  where party_code in                                          
( select distinct party_code collate Latin1_General_CI_AS from ebrok_contest  )                                                                      
  group by b.sauda_date,party_code                                                                                  
having sum(brokerage)>=25                 
              
update  #ff2 set online= #ff2.online-b.total_brok from mis.terminalmaster.dbo.ebrokingOfflineTrades b              
where  #ff2.party_code=b.party_code collate Latin1_General_CI_AS and  #ff2.sauda_date=b.sauda_date                          
                                                                                  
--insert points subsequent                                                                                  
insert into ebrok_contest                                                      
select distinct max(isnull(c.intrucode,'')),b.party_code,b.sauda_date,'subsequent trade',points=case when ((online/tot)*100)<50.00 and tot>25.00 then 25                                                                   
when ((online/tot)*100)>=50.00 and ((online/tot)*100)<75 then 50                                                                                  
when ((online/tot)*100)>=75.00 then 100 end,getdate(),cli_points=convert(int,online)/100                                
,c.region,c.branch,c.sub_broker,c.client_name,                                
emp_name=max(case when isnull(c.intrucode,'')='' then '' else c.emp_name end )                                
,emp_dept=max(case when isnull(c.intrucode,'')='' then '' else c.emp_dept end ),cli_type=max(c.cli_type),tot_brok=tot,online                                 
from  #file2 a join #ff2 b                                    
on a.party_code=b.party_code  collate Latin1_General_CI_AS join  ebrok_contest c on                                      
b.party_code=c.party_code collate Latin1_General_CI_AS                                                        
where online>0.0 --and a.party_code='ALWR819'                                
group by b.party_code,b.sauda_date ,online,tot,c.region,c.branch,c.sub_broker,c.client_name--,a.emp_name,a.emp_dept                                                                          
order by b.party_code                                                
                                
---------------------1st trade------  select convert(int,299.99)/100                                                                                
--                                                                  
--                                                                                 
--select distinct a.party_code,sauda_date into #f                                                                                 
--from #file2 a join #brokfile b                                                                                  
--on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                       
--where  user_stat<>'' and a.party_code not in                                                                                  
--(select party_code from ebrok_contest)             
--                                                                                
--                                              
--select a.party_code,online=sum(case when user_stat<>'' then brokerage else 0 end),                                                       
--tot=sum(brokerage),b.sauda_date into #ff3                                                                                 
--from #f a join #brokfile b                                                                                  
--on a.party_CODE=b.party_CODE collate Latin1_General_CI_AS                                                                                  
--group by b.sauda_date,a.party_code                
--              
--update  #ff3 set online= #ff3.online-b.total_brok from mis.terminalmaster.dbo.ebrokingOfflineTrades b              
--where  #ff3.party_code=b.party_code collate Latin1_General_CI_AS and  #ff3.sauda_date=b.sauda_date                                           
--                                                                                  
--insert into ebrok_contest                                                                                  
--                                
--select distinct max(isnull(Introducer,'')),b.party_code,b.sauda_date,'1st trade',50,getdate(),cli_points=convert(int,online)/100                                 
--,a.region,a.branch,a.sub_broker,a.client_name,                                
--emp_name=max(a.emp_name)                                
--,emp_dept=max(a.emp_dept),cli_type=CASE WHEN max(cli_type)='KYC' THEN 'KYC' ELSE 'OLD' END,tot_brok=tot,online                                 
--from #file2 a join #ff3 b                                                                                  
--on a.party_code collate Latin1_General_CI_AS =b.party_code                                          
--group by b.party_code,b.sauda_date,online,a.region,a.branch,a.sub_broker,a.client_name,tot

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrokingreward
-- --------------------------------------------------
CREATE proc DBO.ebrokingreward (@FDATE AS VARCHAR(25),@TDATE AS VARCHAR(25),@access_to as varchar(25),@access_code as varchar(25))                    
as                    
IF @access_to='BROKER'                    
begin                    
select reg_code=region,first_trade=sum(case when mode='1st trade' then points else 0 end),                    
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                    
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                    
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                    
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                    
from ebrok_contest (nolock)                    
where  SAUDA_DATE>=@FDATE AND SAUDA_DATE<=@TDATE                    
group by region  
order by  region                 
end                    
IF @access_to='REGION'                     
begin       
    
select branch_cd=branch,first_trade=sum(case when mode='1st trade' then points else 0 end),                    
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                    
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                    
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                    
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                    
from ebrok_contest (nolock)                     
where  region like @access_code AND  SAUDA_DATE>=@FDATE AND SAUDA_DATE<=@TDATE                    
group by branch 
order by  branch                     
end       
                   
IF @access_to='BRMAST'                     
begin                    
select branch_cd=a.branch,first_trade=sum(case when mode='1st trade' then points else 0 end),                    
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                    
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                    
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                    
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                    
from ebrok_contest a (nolock)  join risk.dbo.branch_master c (nolock) on a.branch=c.branch_cd                     
where  C.brmast_cd like @access_code AND  A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE                    
group by a.branch 
order by  a.branch                   
end                   
IF @access_to='BRANCH'                     
begin                    
select intrucode=isnull(LTRIM(RTRIM(intrucode)),''),a.emp_name,department=a.emp_dept,c.designation,first_trade=sum(case when mode='1st trade' then points else 0 end),                    
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                    
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                    
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                    
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                    
from ebrok_contest a (nolock)  LEFT OUTER join risk.dbo.emp_info c (nolock) on a.INTRUCODE=c.emp_no                        
where  a.branch like @access_code AND  A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE --AND INTRODUCER IS NOT NULL                    
group by isnull(LTRIM(RTRIM(intrucode)),''),a.emp_dept,c.designation,a.emp_name 
order by isnull(LTRIM(RTRIM(intrucode)),'')                   
end                    
IF @access_to='INTRODUCER'                     
begin                    
select A.PARTY_CODE,first_trade=sum(case when mode='1st trade' then points else 0 end),                    
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                    
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                    
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                    
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                    
from ebrok_contest a (nolock)                     
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE AND ISNULL(A.INTRUCODE,'')=@access_code                    
group by A.PARTY_CODE  
order by A.PARTY_CODE                  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrokingreward_new
-- --------------------------------------------------
CREATE proc DBO.ebrokingreward_new (@FDATE AS VARCHAR(25),@TDATE AS VARCHAR(25),@access_to as varchar(25),@access_code as varchar(25))                  
as                  
IF @access_to='BROKER'                  
begin                  
select region,first_trade=sum(case when mode='1st trade' then points else 0 end),                  
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                  
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                  
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                  
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                  
from ebrok_contest (nolock)                  
where  SAUDA_DATE>=@FDATE AND SAUDA_DATE<=@TDATE                  
group by region                  
end                  
IF @access_to='REGION'                   
begin     
  
select branch,first_trade=sum(case when mode='1st trade' then points else 0 end),                  
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                  
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                  
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                  
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                  
from ebrok_contest (nolock)                   
where  region like @access_code AND  SAUDA_DATE>=@FDATE AND SAUDA_DATE<=@TDATE                  
group by branch                  
end     
                 
IF @access_to='BRMAST'                   
begin                  
select a.branch,first_trade=sum(case when mode='1st trade' then points else 0 end),                  
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                  
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                  
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                  
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                  
from ebrok_contest a (nolock)  join risk.dbo.branch_master c (nolock) on a.branch=c.branch_cd                   
where  C.brmast_cd like @access_code AND  A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE                  
group by a.branch                  
end                 
IF @access_to='BRANCH'                   
begin                  
select intrucode=isnull(LTRIM(RTRIM(intrucode)),''),a.emp_name,a.emp_dept,c.designation,first_trade=sum(case when mode='1st trade' then points else 0 end),                  
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                  
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                  
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                  
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                  
from ebrok_contest a (nolock)  LEFT OUTER join risk.dbo.emp_info c (nolock) on a.INTRUCODE=c.emp_no                      
where  a.branch like @access_code AND  A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE --AND INTRODUCER IS NOT NULL                  
group by isnull(LTRIM(RTRIM(intrucode)),''),a.emp_dept,c.designation,a.emp_name                  
end                  
IF @access_to='INTRODUCER'                   
begin                  
select A.PARTY_CODE,first_trade=sum(case when mode='1st trade' then points else 0 end),                  
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                  
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                  
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                  
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                  
from ebrok_contest a (nolock)                   
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE AND ISNULL(A.INTRUCODE,'')=@access_code                  
group by A.PARTY_CODE                  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrokingreward1
-- --------------------------------------------------
CREATE proc DBO.ebrokingreward1 (@FDATE AS VARCHAR(25),@TDATE AS VARCHAR(25),@access_code as varchar(25),@FLAG AS VARCHAR(25))                      
as            
 if @access_code='CSO'      
begin      
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                      
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                      
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                      
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                      
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                      
from ebrok_contest a (nolock)                  
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE     
group by A.PARTY_CODE,a.region,a.branch,a.intrucode 
order by A.PARTY_CODE     
end      
if @access_code<>'CSO'      
begin         
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                      
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                      
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                      
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                      
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                      
from ebrok_contest a (nolock)                      
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE AND ISNULL(A.INTRUCODE,'')=@access_code           
AND BRANCH like @FLAG                     
group by A.PARTY_CODE,region,branch,a.intrucode    
order by A.PARTY_CODE      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ebrokingreward2
-- --------------------------------------------------
CREATE proc DBO.ebrokingreward2 (@FDATE AS VARCHAR(25),@TDATE AS VARCHAR(25),@access_code as varchar(25),@access_to AS VARCHAR(25))                        
as              
 if @access_to='REGION'        
begin        
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                        
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                        
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                        
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                        
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                        
from ebrok_contest a (nolock)               
where  region like @access_code                 
and A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE       
group by A.PARTY_CODE,region,branch,a.intrucode 
order by A.PARTY_CODE       
end        
if @access_to='BRMAST'        
begin        
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                        
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                        
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                        
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                        
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                        
from ebrok_contest a (nolock)        
join risk.dbo.branch_master c (nolock) on a.branch=c.branch_cd   
where  C.brmast_cd like @access_code                  
and A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE       
group by A.PARTY_CODE,region,branch,a.intrucode  
order by A.PARTY_CODE            
end     
if @access_to='BRANCH'        
begin        
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                        
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                        
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                        
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                        
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                        
from ebrok_contest a (nolock)                 
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE AND branch=@ACCESS_CODE      
group by A.PARTY_CODE,region,branch,a.intrucode    
order by A.PARTY_CODE          
end   
if @access_to='BROKER'        
begin        
select reg_code=region,branch_cd=branch,A.PARTY_CODE,a.intrucode,first_trade=sum(case when mode='1st trade' then points else 0 end),                        
sub_less=sum(case when mode='subsequent trade' and points=25 then points else 0 end),                        
sub_medium=sum(case when mode='subsequent trade' and points=50 then points else 0 end),                        
sub_high=sum(case when mode='subsequent trade' and points=100 then points else 0 end),                        
bonus=sum(case when mode='bonus' then points else 0 end),total=sum(points)                        
from ebrok_contest a (nolock)                       
where A.SAUDA_DATE>=@FDATE AND A.SAUDA_DATE<=@TDATE --AND b.branch_cd=@ACCESS_CODE      
group by A.PARTY_CODE,region,branch,a.intrucode  
order by A.PARTY_CODE            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EMail7_10
-- --------------------------------------------------
CREATE procedure EMail7_10      
(      
      
  --@var1 varchar(100),       
  @fieldname varchar(100),       
  @to varchar(100),      
  --@from varchar(100),      
  --@subject varchar(100),      
 -- @bcc varchar(100),      
 -- @cc varchar(100),      
  @pwd varchar(100),      
  @prd varchar(100),
@email as varchar(50)    
)      
As      
declare @tableBody as varchar(5000)         
declare @mailitem_id int      
Declare @currdt varchar(11)      
Set @currdt=convert(varchar(11),getdate(),103)      
--print @currdt      
Set @tableBody =      
N'<br><html> <head><br><br>' +       
N'<Link href=''http://rm.angelbackoffice.com/upload1/limitgenerator/angel.css'' type=text/css rel=stylesheet>'+                       
N'</head> '+      
N'<body>'+ '<table width=''500'' border=''0'' align=''center'' cellpadding=''0'' cellspacing=''0'' >' +      
N'<tr><td bgcolor=''#d7d7d7''><table width=''500'' border=''0'' align=''center'' cellpadding=''0'' cellspacing=''1''>' +      
N'<tr><td bgcolor=''#FFFFFF''><table width=''500'' border=''0'' cellspacing=''0'' cellpadding=''0'' >'+       
N' <tr><td><table width=''500'' border=''0'' cellspacing=''0'' cellpadding=''0'' >'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/strip_gray.gif'' width=''500'' height=''12'' /></td></tr>'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/gray_small.jpg'' width=''100%''height=''2'' /></td></tr>'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/header_trade.gif'' width=''500'' height=''70'' /></td></tr>'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/gray_small.jpg'' width=''100%'' height=''2'' /></td></tr>'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/strip_gray.gif'' width=''500'' height=''12'' /></td></tr>'+      
N'<tr><td><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/gray_small.jpg'' width=''100%'' height=''1'' /></td></tr>'+      
N'</table></td></tr>'+      
N'<tr><td valign=''top''><table width=''485'' border=''0'' align=''center'' cellpadding=''0'' cellspacing=''0'' >'+      
N'<tr><td valign=''top''><img src=''http://rm.angelbackoffice.com/upload1/limitgenerator/spacer.gif'' width=''1'' height=''5'' /></td></tr>'+      
N'<tr><td class=''date''><div align=''right''>Date :' + @currdt +'  </div></td></tr>'+      
N'<tr><td><p align=''justify'' class=''date''>Dear <strong>' +@fieldname+  '</strong>, <br /><br />'+      
N'Your welcome kit has been generated and you would  be receiving the same shortly. Incase of any queries regarding the same or related to your trading account, kindly email us on&nbsp; <a href=''mailto:productsupport@angeltrade.com''class=''date''><stron
  
    
g>productsupport@angeltrade.com</strong></a><br /><br />'+      
N'Your Client code will be mentioned to  you in the welcome letter sent to you through courier or you could get the same from your respective branch. <br /><br />'+      
N'Your trading password is       : <strong> '+ @pwd+ '</strong><br />' +       
N'And your trading platform is   :<strong> '+ @prd +' </strong><br /><br />'+      
N'Please remember that this password is case  sensitive. Please note that you will be prompted to change the password when you login to the trading system for the first time with the above provided password.  Please enter a new password which should be a 
  
    
combination of alphabets and numbers  and which should have a minimum length of 8 characters. You will also be  prompted to change the password every 15 days.<br /><br />'+      
N'We thank you for choosing <a class=''date'' href=''http://www.angeltrade.com/''>angeltrade.com</a> as your online trading  account; hope you have a wonderful trading experience.</p>'+      
N'<p class=''date''><br />Warm regards, <br />'+      
N'CustomerCare <br />'+      
N'<a href=''http://www.angeltrade.com/'' class=''date''><strong>angeltrade.com</strong></a></p>'+      
N'<span class=''date''>Kindly forward all your queries to <a href=''mailto:feedback@angeltrade.com'' class=''date''><strong>feedback@angeltrade.com</strong></a></span></td>'+      
N'</tr><tr><td>&nbsp;</td></tr></table></td></tr>'+      
N'<tr><td><table width=''100%''border=''0'' cellspacing=''0'' cellpadding=''0'''+      
N'<tr><td width=''60%'' bgcolor=''#999999''><div align=''center'''+      
N'<font color=''#FFFFFF'' size=''1'' face=''arial''>copyright &copy; angeltrade.com 2010 All Rights Reserved</font></div></td>'+      
N'<td width=''40%'' height=''25'' align=''center'' valign=''middle'' bgcolor=''62A1B7'' class=''new3w''><div align=''center''></div></td>'+      
N'</tr></table></td></tr>'+      
N'</table></td></tr></table></td></tr></table>'+      
N'</body>'+      
N'</html>';      
       
      
--N'The new E-Learning file <B>'+@ETopic+'</B> has been added by <B>'+@ETopi1+'</B> in E-Learning Option of Tech-Tools.<br><br>' +                        
-- N'<I>Regards,</I><br>' +                       
-- N'<I>'+@ETopic2+'</I>' +                       
-- N'<br>Software Department' +                        
-- N'<br><br>';       
      
exec msdb.dbo.sp_send_dbmail               
@profile_name='Intranet',                   
@recipients =@email,          
--@copy_recipients =@cc,          
@blind_copy_recipients ='rozinar.raje@angeltrade.com;yash.shah@angeltrade.com;Hiren.Yadav@angeltrade.com,aaryan08_me@yahoo.com',               
@subject = 'Welcome to Angeltrade' ,              
@body=@tableBody,              
@body_format = 'HTML',            
@mailitem_id = @mailitem_id output

GO

-- --------------------------------------------------
-- PROCEDURE dbo.failed3times
-- --------------------------------------------------
CREATE proc failed3times     
as            
SET NOCOUNT ON     
--------- failed 3 times single day    
select [DealerID],[GroupId],[LogonTime],[LogonAttempt],[Reason],    
IP=replace(substring([Reason],charindex('(IP Address:',[Reason])+13,    
charindex('||',[Reason])-charindex('(IP Address:',[Reason])-13    
--50    
),')',''),    
GateWay=replace(substring([Reason],charindex('||',[Reason])+3,50),')',''),    
date=convert(varchar(8),[logonTime])    
from CtclLogTab where [dealerid] in    
(    
select [dealerid] from CtclLogTab     
where [logonattempt]='FAIL'     
group by [dealerid],convert(varchar(11),[logonTime]) having count(*) >= 3    
)    
and  [logonattempt]='FAIL'  --and reason not like 'Your Password has expired%'   
SET NOCOUNT off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_product
-- --------------------------------------------------
CREATE procedure find_product(@code as varchar(10))
as
select CurProduct=case when AngelDiet='Y' then 'AngelDiet' 
when AngelTrade='Y' then 'AngelTrade' 
when AngelInvestor='Y' then 'AngelInvestor' 
when AngelSwift='Y' then 'AngelSwift' 
when AngelSpeedPro='Y' then 'AngelSpeedPro' 
when AngelWebPro='Y' then 'AngelWebPro' 
else '' end + '|' + odin_server 
from mis.dbo.ebrok_client_product 
where party_Code=@code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_table
-- --------------------------------------------------
CREATE proc find_table @content varchar(20)  
as   
print @content  
select * from information_schema.tables where table_name like '%'+@content+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_BO_Client_password
-- --------------------------------------------------

---exec Gen_BO_Client_password 'sep 21 2012','sep 21 2012'

CREATE procedure Gen_BO_Client_password(@tfdate as varchar(20),@ttdate as varchar(20))                                  
as                                                    
--SET NOCOUNT ON                                                    
                                                    
DECLARE                                                     
@pcode varchar(10)                                  
                                  
declare @ss as table                                  
(Password varchar(25))                           
                        
                        
set @tfdate =  convert(datetime,@tfdate+' 00:00:00',121)                          
set @ttdate =  convert(datetime,@ttdate+' 23:59:59',121)                                                                   
                                  
select party_code,password=space(10),GeneratedOn=getdate(),encruppswd=space(10) into #temp1                                   
from nsecourier.dbo.hist_temp_offlinemaster where tdate >=@tfdate and tdate <= @ttdate-- @ttdate +'23:59:59.000'                                  
and party_Code       
not in (select party_code from BO_Client_Password (nolock))                                  
                                           
                                                  
DECLARE error_cursor CURSOR FOR                                                     
select party_code from #temp1                                   
                                                   
OPEN error_cursor                                                    
                                                    
FETCH NEXT FROM error_cursor                                                     
INTO @pcode                                  
                                                    
WHILE @@FETCH_STATUS = 0                                                    
BEGIN                                        
                                                    
  insert into @ss (password) exec random_password1 8,''                                   
            
  update @ss set password=replace(password,'O','x')               
  update @ss set password=replace(password,'0','q')               
  update @ss set password=replace(password,'B','e')               
  update @ss set password=replace(password,'8','n')               
  update @ss set password=replace(password,'5','k')               
  update @ss set password=replace(password,'S','d')               
  update @ss set password=replace(password,'1','w')               
  update @ss set password=replace(password,'I','z')               
  update @ss set password=replace(password,'L','v')               
  update @ss set password=lower(password)               
          
/*                                  
  update #temp1 set password=replace(b.password,'''','a') from @ss b where #temp1.party_code=@pcode                                  
  update #temp1 set password=replace(b.password,'"','a') from @ss b where #temp1.party_code=@pcode                                  
  update #temp1 set password=replace(b.password,'O','x') from @ss b where #temp1.party_code=@pcode                                  
  update #temp1 set password=replace(b.password,'0','x') from @ss b where #temp1.party_code=@pcode                                  
*/                
  update #temp1 set password=b.password from @ss b where #temp1.party_code=@pcode                                  
  delete from @ss                                  
                                                    
  FETCH NEXT FROM error_cursor                                                     
  INTO @pcode                                  
                                                    
END                                                   
                                                    
CLOSE error_cursor                                                    
DEALLOCATE error_cursor                                                    
                    
--update #temp1 set password=replace(password,'O','x')                     
--update #temp1 set password=replace(password,'0','x')                     
                            
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                            
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                            
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                            
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                            
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                            
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                            
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                            
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                            
                            
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                      
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                      
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                      
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')    update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3)                 
where ascii(substring(password,5,1))=ascii('j')                      
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                      
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                      
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                      
        
insert into BO_Client_Password select *,'WelcomeKit','' from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_BO_Client_password_New
-- --------------------------------------------------
        
---exec Gen_BO_Client_password 'sep 21 2012','sep 21 2012'       
      
--select  * from BO_Client_Password where source='Welcomekit' order by GeneratedOn desc      
    --select GETDATE()-3    
CREATE procedure [dbo].[Gen_BO_Client_password_New]                                        
as                                                            
      
DECLARE                                                            
@pcode varchar(10)                                          
                                          
declare @ss as table                                          
(Password varchar(25))                                   
                                
DECLARE @date DATETIME            
DECLARE @DeleteDate DATETIME            
SET @date=GETDATE()-5  
           
DECLARE @DAY INT,@MONTH INT,@YEAR INT            
Select @DAY=DAY(@date),@MONTH=MONTH(@date),@YEAR=YEAR(@date)                                                                       
                                          
select cl_code as party_code,password=space(10),GeneratedOn=getdate(),encruppswd=space(10) into #temp1                                           
from Risk.Dbo.client_details with(Nolock)                               
where first_active_date>=@date
--DAY(first_active_date)=@DAY AND MONTH(first_active_date)=@MONTH             
--AND YEAR(first_active_date)=@YEAR               
and cl_code not like '98%'       
      
--and cl_code not in       
-- (select party_code from BO_Client_Password (nolock))                                       
     
 delete from #temp1 where party_code in (select party_code from BO_Client_Password (nolock) WHERE ISNULL(password,'')<>'')    
                                   
                                                   
                                                          
DECLARE error_cursor CURSOR FOR                                                             
select party_code from #temp1                                           
                                                           
OPEN error_cursor                                                            
                                                            
FETCH NEXT FROM error_cursor                                                             
INTO @pcode                                          
                                                            
WHILE @@FETCH_STATUS = 0                                                            
BEGIN                                                
                                                            
  insert into @ss (password) exec random_password1 8,''                                           
                    
  update @ss set password=replace(password,'O','x')                       
  update @ss set password=replace(password,'0','q')                       
  update @ss set password=replace(password,'B','e')                       
  update @ss set password=replace(password,'8','n')                       
  update @ss set password=replace(password,'5','k')                       
  update @ss set password=replace(password,'S','d')                       
  update @ss set password=replace(password,'1','w')                       
  update @ss set password=replace(password,'I','z')                       
  update @ss set password=replace(password,'L','v')                       
  update @ss set password=lower(password)                       
                  
                      
  update #temp1 set password=b.password from @ss b where #temp1.party_code=@pcode                                          
  delete from @ss                                          
                                                            
  FETCH NEXT FROM error_cursor                                                             
  INTO @pcode                                          
                                                            
END                                                           
                 
CLOSE error_cursor                                            
DEALLOCATE error_cursor                                                            
              
--update #temp1 set password=replace(password,'O','x')                             
--update #temp1 set password=replace(password,'0','x')                             
                                    
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                                    
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                                    
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                                    
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                                    
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                                    
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                                    
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                                    
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                                    
                                    
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                              
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                              
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                              
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')          
update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3)                         
where ascii(substring(password,5,1))=ascii('j')                              
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                              
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                              
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                              
                
insert into BO_Client_Password select *,'WelcomeKit','' from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_BO_Client_password_New_ClCodeWise
-- --------------------------------------------------
 
CREATE procedure [dbo].[Gen_BO_Client_password_New_ClCodeWise]
(
 @Party_Code varchar(12)
)                                        
as                                                            
      
DECLARE                                                            
@pcode varchar(10)                                          
                                          
declare @ss as table                                          
(Password varchar(25))                                   
                                
                                                                     
                                          
select cl_code as party_code,password=space(10),GeneratedOn=getdate(),encruppswd=space(10) into #temp1                                           
from AngelNseCM.Msajag.Dbo.client_details with(Nolock)                               
where cl_code=@Party_Code
           
and cl_code not like '98%'       
    
                                      
     
 delete from #temp1 where party_code in (select party_code from BO_Client_Password (nolock) WHERE ISNULL(password,'')<>'')    
                                   
                                                   
                                                          
DECLARE error_cursor CURSOR FOR                                                             
select party_code from #temp1                                           
                                                           
OPEN error_cursor                                                            
                                                            
FETCH NEXT FROM error_cursor                                                             
INTO @pcode                                          
                                                            
WHILE @@FETCH_STATUS = 0                                                            
BEGIN                                                
                                                            
  insert into @ss (password) exec random_password1 8,''                                           
                    
  update @ss set password=replace(password,'O','x')                       
  update @ss set password=replace(password,'0','q')                       
  update @ss set password=replace(password,'B','e')                       
  update @ss set password=replace(password,'8','n')                       
  update @ss set password=replace(password,'5','k')                       
  update @ss set password=replace(password,'S','d')                       
  update @ss set password=replace(password,'1','w')                       
  update @ss set password=replace(password,'I','z')                       
  update @ss set password=replace(password,'L','v')                       
  update @ss set password=lower(password)                       
                  
                      
  update #temp1 set password=b.password from @ss b where #temp1.party_code=@pcode                                          
  delete from @ss                                          
                                                            
  FETCH NEXT FROM error_cursor                                                             
  INTO @pcode                                          
                                                            
END                                                           
                 
CLOSE error_cursor                                            
DEALLOCATE error_cursor                                                            
              
--update #temp1 set password=replace(password,'O','x')                             
--update #temp1 set password=replace(password,'0','x')                             
                                    
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                                    
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                                    
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                                    
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                                    
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                                    
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                                    
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                                    
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                                    
                                    
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                              
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                              
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                              
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')          
update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3)                         
where ascii(substring(password,5,1))=ascii('j')                              
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                              
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                              
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                              
                
insert into BO_Client_Password select *,'WelcomeKit','' from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_BO_SingleClient_password
-- --------------------------------------------------
CREATE procedure [dbo].[Gen_BO_SingleClient_password](@clcode as varchar(20),@user as varchar(16))                              
as                                                
SET NOCOUNT ON                                                
                                                
DECLARE @pcode varchar(20)                              
                              
declare @ss as table                              
(Password varchar(25))                              
                              
select party_code=@clcode,password=space(10),GeneratedOn=getdate(),encruppswd=space(10) into #temp1                               
                                              
DECLARE error_cursor CURSOR FOR                                                 
select party_code from #temp1                               
                                               
OPEN error_cursor                                                
           
FETCH NEXT FROM error_cursor                                                 
INTO @pcode                              
                                                
WHILE @@FETCH_STATUS = 0                                                
BEGIN                                    
      
  insert into @ss (password) exec random_password1 8,''                               
  update @ss set password=replace(password,'O','x')         
  update @ss set password=replace(password,'0','q')         
  update @ss set password=replace(password,'B','e')         
  update @ss set password=replace(password,'8','n')         
  update @ss set password=replace(password,'5','k')         
  update @ss set password=replace(password,'S','d')         
  update @ss set password=replace(password,'1','w')         
  update @ss set password=replace(password,'I','z')         
  update @ss set password=replace(password,'L','v')         
  update @ss set password=lower(password)         
    
  update #temp1 set password=b.password from @ss b where #temp1.party_code=@pcode                              
         
  delete from @ss                              
                                               
  FETCH NEXT FROM error_cursor                                                 
  INTO @pcode                              
                                                
END                                               
                                                
CLOSE error_cursor                                                
DEALLOCATE error_cursor                                                
              
---update #temp1 set password=replace(password,'O','x')               
--update #temp1 set password=replace(password,'0','x')               
                      
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                      
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                      
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                      
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                      
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                      
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                      
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                      
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                      
                
                      
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')                
update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')                
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                
                
                                  
insert into BO_Client_Password select *,'Request',@user from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_BO_SingleSB_password
-- --------------------------------------------------
CREATE procedure Gen_BO_SingleSB_password(@sbcode as varchar(10),@user as varchar(10))                              
as                                                
SET NOCOUNT ON                                                
                                                
DECLARE @scode varchar(10)                              
                              
declare @ss as table                              
(Password varchar(25))                              
                              
select sb_code=@sbcode,password=space(10),GeneratedOn=getdate(),encruppswd=space(10) into #temp1                               
                                              
DECLARE error_cursor CURSOR FOR                                                 
select sb_code from #temp1                               
                                               
OPEN error_cursor                                                
           
FETCH NEXT FROM error_cursor                                                 
INTO @scode                              
                                                
WHILE @@FETCH_STATUS = 0                                                
BEGIN                                    
      
  insert into @ss (password) exec random_password1 8,''                               
  update @ss set password=replace(password,'O','x')         
  update @ss set password=replace(password,'0','q')         
  update @ss set password=replace(password,'B','e')         
  update @ss set password=replace(password,'8','n')         
  update @ss set password=replace(password,'5','k')         
  update @ss set password=replace(password,'S','d')         
  update @ss set password=replace(password,'1','w')         
  update @ss set password=replace(password,'I','z')         
  update @ss set password=replace(password,'L','v')         
  update @ss set password=lower(password)         
    
  update #temp1 set password=b.password from @ss b where #temp1.sb_code=@scode                              
         
  delete from @ss                              
                                               
  FETCH NEXT FROM error_cursor                                                 
  INTO @scode                              
                                                
END                                               
                                                
CLOSE error_cursor                                                
DEALLOCATE error_cursor                                                
              
---update #temp1 set password=replace(password,'O','x')               
--update #temp1 set password=replace(password,'0','x')               
                      
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                      
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                      
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                      
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                      
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                      
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                      
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                      
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                      
                
                      
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')                
update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')                
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                
                
                                  
insert into BO_Sb_Password select *,'Request',@user from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Gen_Sify_SingleClient_password
-- --------------------------------------------------

CREATE procedure Gen_Sify_SingleClient_password(@clcode as varchar(10),@user as varchar(10))                              
as                                                
SET NOCOUNT ON                                                
                                                
DECLARE @pcode varchar(10)                              
                              
declare @ss as table                              
(Password varchar(25))                              
                              
select party_code=@clcode,password=space(10),GeneratedOn=getdate() into #temp1                               
                                              
DECLARE error_cursor CURSOR FOR                                                 
select party_code from #temp1                               
                                               
OPEN error_cursor                                                
           
FETCH NEXT FROM error_cursor                                                 
INTO @pcode                              
                                                
WHILE @@FETCH_STATUS = 0                                                
BEGIN                                    
      
  insert into @ss (password) exec random_password1 8,''                               
  update @ss set password=replace(password,'O','x')         
  update @ss set password=replace(password,'0','q')         
  update @ss set password=replace(password,'B','e')         
  update @ss set password=replace(password,'8','n')         
  update @ss set password=replace(password,'5','k')         
  update @ss set password=replace(password,'S','d')         
  update @ss set password=replace(password,'1','w')         
  update @ss set password=replace(password,'I','z')         
  update @ss set password=replace(password,'L','v')         
  update @ss set password=lower(password)         
    
  update #temp1 set password=b.password from @ss b where #temp1.party_code=@pcode                              
         
  delete from @ss                              
                                               
  FETCH NEXT FROM error_cursor                                                 
  INTO @pcode                              
                                                
END                                               
                                                
CLOSE error_cursor                                                
DEALLOCATE error_cursor                                                
              
---update #temp1 set password=replace(password,'O','x')               
--update #temp1 set password=replace(password,'0','x')               
                      
update #temp1 set password = 'x'+substring(password,2,7) where ascii(substring(password,1,1))=113                      
update #temp1 set password = substring(password,1,1)+'x'+substring(password,3,6) where ascii(substring(password,2,1))=70                      
update #temp1 set password = substring(password,1,2)+'x'+substring(password,4,5) where ascii(substring(password,3,1))=69                      
update #temp1 set password = substring(password,1,3)+'x'+substring(password,5,4) where ascii(substring(password,4,1))=71                      
update #temp1 set password = substring(password,1,4)+'x'+substring(password,6,3) where ascii(substring(password,5,1))=114                      
update #temp1 set password = substring(password,1,5)+'x'+substring(password,7,2) where ascii(substring(password,6,1))=73                      
update #temp1 set password = substring(password,1,6)+'x'+substring(password,8,1) where ascii(substring(password,7,1))=122                      
update #temp1 set password = substring(password,1,7)+'x' where ascii(substring(password,8,1))=118                      
                
                      
update #temp1 set password = 'e'+substring(password,2,7) where ascii(substring(password,1,1))=ascii('i')                
update #temp1 set password = substring(password,1,1)+'e'+substring(password,3,6) where ascii(substring(password,2,1))=ascii('x')                
update #temp1 set password = substring(password,1,2)+'e'+substring(password,4,5) where ascii(substring(password,3,1))=ascii('w')                
update #temp1 set password = substring(password,1,3)+'e'+substring(password,5,4) where ascii(substring(password,4,1))=ascii('y')                
update #temp1 set password = substring(password,1,4)+'e'+substring(password,6,3) where ascii(substring(password,5,1))=ascii('j')                
update #temp1 set password = substring(password,1,5)+'e'+substring(password,7,2) where ascii(substring(password,6,1))=ascii('A')                
update #temp1 set password = substring(password,1,6)+'e'+substring(password,8,1) where ascii(substring(password,7,1))=ascii('r')                
update #temp1 set password = substring(password,1,7)+'e' where ascii(substring(password,8,1))=ascii('n')                
                
                                  
insert into Sify_Client_Password select *,'Request',@user from #temp1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_Capital_BO
-- --------------------------------------------------
CREATE procedure [dbo].[get_Capital_BO](@tdate as varchar(11),@bkp as varchar(1))      
as      
      
set nocount on      
      
select * into #bsetrd from AngelBSECM.bsedb_Ab.dbo.settlement 
where sauda_DAte >=@tdate+' 00:00:00' and sauda_DAte <=@tdate+' 23:59:59' 

set transaction isolation level read uncommitted      
select sdate=convert(varchar(11),sauda_date),sell_buy,party_code,scrip_Cd,TO_Qty=sum(tradeqty)       
into #bse_Data      
from #bsetrd 
--where sauda_DAte >=@tdate+' 00:00:00' and sauda_DAte <=@tdate+' 23:59:59' 
group by sell_buy,party_code,scrip_Cd,convert(varchar(11),sauda_date)      

      
set transaction isolation level read uncommitted      
select b.sell_buy,b.party_code,b.scrip_cd,a.scrip_name,share=(TO_qty*100)/(capital*100000)         
into #file1      
from BSE_CI a, #bse_Data b      
where a.scrip_cd=b.scrip_Cd      
and (TO_qty*100)/(capital*100000)  >= 0.5      

set transaction isolation level read uncommitted      
select Broker='0612',a.scrip_Cd,b.scrip_name,      
a.party_Code,Party_name =space(150),      
SP=(case when a.sell_buy = 1 then 'P' else 'S' end),      
Quantity=sum(tradeQty),Rate=sum((MarketRate/100)*tradeQty)/sum(tradeQty),      
Sauda_Date=convert(varchar(11),sauda_date),b.share      
into #file2      
from #bsetrd a, #file1 b      
where a.party_code=b.party_code and a.scrip_cd=b.scrip_cd   and a.sell_buy=b.sell_buy   
group by a.scrip_Cd,b.scrip_name,a.party_code,a.sell_buy,convert(varchar(11),sauda_date),b.share      
      
update #file2 set party_name = b.long_name from risk.dbo.client_details b where #file2.party_Code=b.party_code      
      
set transaction isolation level read uncommitted      
/*      
select data=broker+'|'+scrip_Cd+'|'+scrip_name+'|'+party_code+'|'+party_name+'|'+sp+'|'+convert(varchar(10),quantity)+'|'      
+convert(varchar(10),rate)+'|'+convert(varchar(11),sauda_date,103)      
*/      
  
if @bkp='Y' 
begin
	delete from bulk_deal_history where sauda_date in (select distinct sauda_Date from #file2)  
	insert into bulk_deal_history select *,'B' from #file2  
end
  
select * from #file2 order by party_code,scrip_name      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_Capital_crosser
-- --------------------------------------------------
CREATE procedure get_Capital_crosser      
as      
      
set nocount on      
      
set transaction isolation level read uncommitted      
select sdate=convert(varchar(11),sauda_date),sell_buy,party_code,scrip_Cd,TO_Qty=sum(tradeqty)       
into #bse_Data      
from mis.bse.dbo.bsecashtrd_mis group by sell_buy,party_code,scrip_Cd,convert(varchar(11),sauda_date)      
      
set transaction isolation level read uncommitted      
select b.sell_buy,b.party_code,b.scrip_cd,a.scrip_name,share=(TO_qty*100)/(capital*100000)         
into #file1      
from BSE_CI a, #bse_Data b      
where a.scrip_cd=b.scrip_Cd      
and (TO_qty*100)/(capital*100000)  >= 0.5      
      
set transaction isolation level read uncommitted      
select Broker='0612',a.scrip_Cd,b.scrip_name,      
a.party_Code,Party_name =space(150),      
SP=(case when a.sell_buy = 'B' then 'P' else 'S' end),      
Quantity=sum(tradeQty),Rate=sum((MarketRate/100)*tradeQty)/sum(tradeQty),      
Sauda_Date,b.share      
into #file2      
from mis.bse.dbo.bsecashtrd_mis  a, #file1 b      
where a.party_code=b.party_code and a.scrip_cd=b.scrip_cd   and a.sell_buy=b.sell_buy   
group by a.scrip_Cd,b.scrip_name,a.party_code,a.sell_buy,sauda_Date,b.share      
      
update #file2 set party_name = b.long_name from risk.dbo.client_details b where #file2.party_Code=b.party_code      
      
set transaction isolation level read uncommitted      
/*      
select data=broker+'|'+scrip_Cd+'|'+scrip_name+'|'+party_code+'|'+party_name+'|'+sp+'|'+convert(varchar(10),quantity)+'|'      
+convert(varchar(10),rate)+'|'+convert(varchar(11),sauda_date,103)      
*/      
  
delete from bulk_deal_history where sauda_date in (select distinct sauda_Date from #file2)  
insert into bulk_deal_history select *,'T' from #file2  
  
select * from #file2 order by party_code,scrip_name      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.get_ipocode
-- --------------------------------------------------
create procedure get_ipocode(@brcode as varchar(10))
as

declare @icode as varchar(10)
select @icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end) from risk.dbo.region where code=@brcode

select code=@icode+(case when max(sbcode) is null then '0001' 
else
replicate('0',4-len(convert(varchar(4),max(convert(int,sbcode))+1)))+convert(varchar(4),max(convert(int,substring(sbcode,7,4)))+1)
end)
from MFIPOAppln2 (nolock) where sbcode like
(select icode=regioncode+nbranchcode+(case when franchisee = 'B' then '1' else '2' end)+'%' from risk.dbo.region where code=@brcode)
group by substring(sbcode,1,6)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_NewPswd
-- --------------------------------------------------
create procedure Get_NewPswd
as
set nocount on
update BO_Client_Password set password=replace(password,'"','a') where isnull(encruppswd,'')=''
update BO_Client_Password set password=replace(password,'''','a') where isnull(encruppswd,'')=''
select * from ctcl.dbo.BO_Client_Password where isnull(encruppswd,'')=''
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LMT_710S1
-- --------------------------------------------------
create procedure LMT_710S1(@location as varchar(50),@sbcode as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                                                      
                                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                      
set @location='acm'                                                      
set @odinserver='odin6'                                                      
set @search = ''                                                      
  */                                                 
                   
  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'               
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location and sbcode like @sbcode AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'raj' and sbcode like 'raje' AND ODIN_SERVER='ODIN710S1' and party_code like '%' and flag is null                            
                                  
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
                                                 
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                                    
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),      
dummy1                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                 
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                 
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                        
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0         
      
                                      
update #file2 set EFF_DEPOSIT=deposit                                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  
                                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                        
                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                       
cast(debit_value as int)as debit_value,                                                              
cast(Appr as int)as holding,          
cast(eff_deposit as int)as eff_deposit, dummy1,           
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                             
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LMT_710S2
-- --------------------------------------------------
CREATE procedure LMT_710S2(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                            
as                                                            
                                                            
set transaction isolation level read uncommitted                                                            
set nocount on                                                            
                                                  
                                                  
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                  
set @location='acm'                                                  
set @odinserver='odin6'                                                  
set @search = ''                                                  
  */                                             
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'           
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                        

UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                    
                                                    
SELECT                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                              
EFF_DEPOSIT=convert(money,0)                    ,                                                                
ALLOWED_DEBIT,GOODWILL,                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                
HOLDING,                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),
dummy1                                                                                                        
INTO #FILE2                                                                
FROM #file1 a left outer join                                                                
RISK.DBO.collection_client_details b                                                                
on a.party_code=b.party_code                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                             
                               
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                   
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                    
                                               
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     

update #file2 set EFF_DEPOSIT=deposit                                   
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                              
                                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                    
                                            
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                              
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                          
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                   
cast(debit_value as int)as debit_value,                                                          
cast(Appr as int)as holding,      
cast(eff_deposit as int)as eff_deposit, dummy1,  
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                       
                                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S3
-- --------------------------------------------------
CREATE procedure Lmt_710S3(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                              
as                                                              
                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                                              
                                                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                    
set @location='acm'                                                    
set @odinserver='odin6'                                                    
set @search = ''                                                    
  */                                               
                  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'             
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          

UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                      
                                                      
SELECT                                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                  
GROSS_EXP=CONVERT(MONEY,0),                                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                
EFF_DEPOSIT=convert(money,0)                    ,                                                                  
ALLOWED_DEBIT,GOODWILL,                                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                  
HOLDING,                                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                      
INTO #FILE2                                                                  
FROM #file1 a left outer join                                                                  
RISK.DBO.collection_client_details b                                                                  
on a.party_code=b.party_code                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                               
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                      
                                                 
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                      
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     

update #file2 set EFF_DEPOSIT=deposit                                     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
                                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                      
                                              
                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                            
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                     
cast(debit_value as int)as debit_value,                                                            
cast(Appr as int)as holding,        
cast(eff_deposit as int)as eff_deposit,dummy1,  
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                       
                                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S4
-- --------------------------------------------------
CREATE procedure Lmt_710S4(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                                                      
                                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                      
set @location='acm'                                                      
set @odinserver='odin6'                                                      
set @search = ''                                                      
  */                                                 
                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'               
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            

UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                                    
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
  
update #file2 set EFF_DEPOSIT=deposit                                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  
                                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                        
                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                       
cast(debit_value as int)as debit_value,                                                              
cast(Appr as int)as holding,          
cast(eff_deposit as int)as eff_deposit,dummy1,    
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                         
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S5
-- --------------------------------------------------
CREATE procedure Lmt_710S5(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                                                      
                                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                      
set @location='acm'                                                      
set @odinserver='odin6'                                                      
set @search = ''                                                      
  */                                                 
                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'               
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            

UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                                    
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     

                                 
update #file2 set EFF_DEPOSIT=deposit                                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  
                                                         
                                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                        
                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                       
cast(debit_value as int)as debit_value,                                                              
cast(Appr as int)as holding,          
cast(eff_deposit as int)as eff_deposit, dummy1,   
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                         
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S6
-- --------------------------------------------------
CREATE procedure Lmt_710S6(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                                                        
                                                        
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                        
set @location='acm'                                                        
set @odinserver='odin6'                                                        
set @search = ''                                                        
  */                                                   
                      
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'                 
                      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                     
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                              
                                    
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                          
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
EFF_DEPOSIT=convert(money,0)                    ,                                                                      
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                     
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
                                        
update #file2 set EFF_DEPOSIT=deposit                                         
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                    
                                                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                          
                                                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                    
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                                
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                         
cast(debit_value as int)as debit_value,                                                                
cast(Appr as int)as holding,            
cast(eff_deposit as int)as eff_deposit,dummy1,      
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                           
                                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S7
-- --------------------------------------------------
CREATE procedure Lmt_710S7(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                                                        
                                                        
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                        
set @location='acm'                                                        
set @odinserver='odin6'                                                        
set @search = ''                                                        
  */                                                   
                      
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'                 
                      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                     
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                              

UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                          
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
EFF_DEPOSIT=convert(money,0)                    ,                                                                      
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                     
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
                                        
update #file2 set EFF_DEPOSIT=deposit                                         
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                    
                                                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                          
                                                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                    
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                                
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                         
cast(debit_value as int)as debit_value,                                                                
cast(Appr as int)as holding,            
cast(eff_deposit as int)as eff_deposit,dummy1,      
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                           
                                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Lmt_710S8
-- --------------------------------------------------
CREATE procedure Lmt_710S8(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                    
as                                                                    
                                                                    
set transaction isolation level read uncommitted                                                                    
set nocount on                                                                    
                                                          
                                                          
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                          
set @location='acm'                                                          
set @odinserver='odin6'                                                          
set @search = ''                                                          
  */                                                     
                        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'                   
                        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                       
                                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                                
  
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                            
                                                            
SELECT                                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                      
EFF_DEPOSIT=convert(money,0)                    ,                                                                        
ALLOWED_DEBIT,GOODWILL,                                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                        
HOLDING,                                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                            
INTO #FILE2                                                                        
FROM #file1 a left outer join                                                                        
RISK.DBO.collection_client_details b                                                                        
on a.party_code=b.party_code                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                                                     
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                            
                                                       
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                            
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                      
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0       
                                          
update #file2 set EFF_DEPOSIT=deposit                                           
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                        
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                      
                                                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                            
                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                      
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                                  
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                           
cast(debit_value as int)as debit_value,                                                                  
cast(Appr as int)as holding,              
cast(eff_deposit as int)as eff_deposit,dummy1,        
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                             
                                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LMT_AMR
-- --------------------------------------------------
CREATE procedure LMT_AMR(@location as varchar(50))                                                  
as                                                  
                                                  
set transaction isolation level read uncommitted                                                  
set nocount on                                                  
                                        
                
SELECT * into #file1 FROM client_trmast WHERE brcode like @location and flag is null                  
--AND ODIN_SERVER=@odinserver                  
                
--SELECT * into #file1 FROM client_trmast WHERE brcode like '%'  and flag is null                
--AND ODIN_SERVER='tradeanywhere'                  
                
                
---For All segment detail                
SELECT                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                      
GROSS_EXP=CONVERT(MONEY,0),                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
ALLOWED_DEBIT,GOODWILL,                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                      
HOLDING,APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                          
INTO #FILE2                                                      
FROM #file1 a left outer join                                                      
RISK.DBO.collection_client_details b                                                      
on a.party_code=b.party_code                                          
                
---For FO Holding details                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                
----(not applicatble to ncdx,mcx)                
                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                
                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                                          
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                          
                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                      
                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                          
              
--select * from #file2  where party_code='P11599'              
            
--select '03',party_code,DBO.MNY2DEC(eff_deposit) from #file2               
    
select '03',party_code,eff_deposit from #file2               
              
--SELECT * FROM                                          
--(                                          
--select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
--Periodicity=17,                                          
--Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                    
--GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
----Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
--Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
--Net_Sale_Expo_Multi=-1,                                            
--NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                
--Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                    
--Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                                    
--Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
--from #file2                                             
                                          
--UNION                                          
                                          
--select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
--Periodicity=17,                                          
--Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                    
--GELimit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
----Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
--Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
--Net_Sale_Expo_Multi=-1,                                                    
--NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                               
--Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                    
--Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                                 
--Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
--from #file2                                             
---) A ORDER BY PARTY_cODE,RECTYPE                                          
                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LMT_TRFile
-- --------------------------------------------------
CREATE procedure LMT_TRFile(@location as varchar(50),@sbcode as varchar(50),@search as varchar(10))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
                                      
                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                      
set @location='acm'                                      
set @odinserver='odin6'                                      
set @search = ''                                      
  */                                 
            
SELECT * into #file1 FROM client_trmast WHERE brcode like @location and sbcode like @sbcode AND party_code like @search+'%' and flag is null            
--AND ODIN_SERVER=@odinserver    
                  
--select * from #file1  where party_code='d6207'                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                      
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                    
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),  
dummy1                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
--select * from #file2  where party_code='d6207'                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                        
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                      
----test                                  
--drop table #file2                               
--select * from #file2                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                               
                      
update #file2 set EFF_DEPOSIT=deposit                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                  
--update #file2 set deposit=EFF_DEPOSIT                                    
---                                          
                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                                
---old logic                                        
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
------                                
                                                    
--select * from #file2                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                  
cast(debit_value as int)as debit_value,                                              
cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit,dummy1,
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                               
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LMTFO_710S1
-- --------------------------------------------------
CREATE procedure LMTFO_710S1(@location as varchar(50),@sbcode as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                              
as                                                              
                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                                              
                                                    
                                                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                    
set @location='acm'                                                    
set @odinserver='odin6'                                                    
set @search = ''                                                    
  */                                               
                 

SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'             
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location and sbcode like @sbcode AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'raj' and sbcode like 'raje' AND ODIN_SERVER='ODIN710S1' and party_code like '%' and flag is null                          
                                
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                      
                                               
                                                      
SELECT                                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                  
GROSS_EXP=CONVERT(MONEY,0),                                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                
EFF_DEPOSIT=convert(money,0)                    ,                                                                  
ALLOWED_DEBIT,GOODWILL,                                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                  
HOLDING,                                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),    
dummy1                                                      
INTO #FILE2                                                                  
FROM #file1 a left outer join                                                                  
RISK.DBO.collection_client_details b                                                                  
on a.party_code=b.party_code                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                               
                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                               
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                      
                                                 
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                      
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                      
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0       
    
                                    
update #file2 set EFF_DEPOSIT=deposit                                     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
                                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                      
                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                            
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                     
cast(debit_value as int)as debit_value,                                                            
cast(Appr as int)as holding,        
cast(eff_deposit as int)as eff_deposit, dummy1,         
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                           
                                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S1
-- --------------------------------------------------
CREATE procedure lmtGE_710S1(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                        
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              

                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
SELECT * FROM                                        
(         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                           
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',               
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
UNION                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                  
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S2
-- --------------------------------------------------
CREATE procedure lmtGE_710S2(@location as varchar(50),@odinserver as varchar(50))                                                  
as                                                  
                                                  
set transaction isolation level read uncommitted                                                  
set nocount on                                                  
          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'        
          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                         
          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                  
                                
SELECT                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                      
GROSS_EXP=CONVERT(MONEY,0),                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
ALLOWED_DEBIT,GOODWILL,                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                      
HOLDING,                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                          
INTO #FILE2                                                      
FROM #file1 a left outer join                                                      
RISK.DBO.collection_client_details b                                                      
on a.party_code=b.party_code                                          
                                          
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                       
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                          
                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                          
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     

                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                      
                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                          
                      
SELECT * FROM                                          
(           
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                             
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                 
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                             
UNION                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                    
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                    
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
from #file2                                             
) A ORDER BY PARTY_cODE,RECTYPE                                          
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtGE_710S3
-- --------------------------------------------------
CREATE procedure LmtGE_710S3(@location as varchar(50),@odinserver as varchar(50))                                                    
as                                                    
                                                    
set transaction isolation level read uncommitted                                                    
set nocount on                                                    
            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'          
            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                           
            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                    
                                            
SELECT                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                    
ALLOWED_DEBIT,GOODWILL,                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                        
HOLDING,                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                            
INTO #FILE2                                                        
FROM #file1 a left outer join                                                        
RISK.DBO.collection_client_details b                                                        
on a.party_code=b.party_code                                            
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                            
                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                        
Update #file2 SET eff_deposit=0 Where eff_deposit<0                        
                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                            
                        
SELECT * FROM                                            
(             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                               
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                   
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                               
UNION                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                      
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                      
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                      
from #file2                                               
) A ORDER BY PARTY_cODE,RECTYPE                                            
                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtGE_710S4
-- --------------------------------------------------
CREATE procedure LmtGE_710S4(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'            
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE              
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                

update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
SELECT * FROM                                              
(               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                 
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                     
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                                 
UNION                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                        
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                        
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                        
from #file2                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S5
-- --------------------------------------------------
CREATE procedure lmtGE_710S5(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'            
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE              
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
SELECT * FROM                                              
(               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                 
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                     
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                                 
UNION                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                        
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                        
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                        
from #file2                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S6
-- --------------------------------------------------
CREATE procedure lmtGE_710S6(@location as varchar(50),@odinserver as varchar(50))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                             
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                            
                                                  
SELECT * FROM                                                
(                 
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                   
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                       
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                                   
UNION                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                          
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                          
from #file2                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S7
-- --------------------------------------------------
CREATE procedure lmtGE_710S7(@location as varchar(50),@odinserver as varchar(50))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                          
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
                               
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                            
SELECT * FROM                                                
(                 
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                   
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                       
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                                   
UNION                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                          
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                          
from #file2                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtGE_710S8
-- --------------------------------------------------
CREATE procedure lmtGE_710S8(@location as varchar(50),@odinserver as varchar(50))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'                
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                          
                                                  
SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                          
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                  
WHERE #file2.PARTY_CODE=B.CLCODE                  
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                               
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                  
                                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                            
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                  
                                 
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              
Update #file2 SET eff_deposit=0 Where eff_deposit<0                              
                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                              
SELECT * FROM                                                  
(                   
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                            
Periodicity=17,                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                     
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                    
Net_Sale_Expo_Multi=-1,                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                         
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
from #file2                                                     
UNION                                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                            
Periodicity=17,                                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                    
Net_Sale_Expo_Multi=-1,                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                            
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                            
from #file2                                                     
) A ORDER BY PARTY_cODE,RECTYPE                                                  
                                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.lmtME_710S1
-- --------------------------------------------------
CREATE procedure lmtME_710S1(@location as varchar(50),@odinserver as varchar(50))                                                                    
as                                                                    
                                                                    
set transaction isolation level read uncommitted                                                                    
set nocount on                                                                    
                            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'                          
                            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                           
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
                                                  
                                                            
SELECT                                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
ALLOWED_DEBIT,GOODWILL,                                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                        
HOLDING,                                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                             
INTO #FILE2                                                                        
FROM #file1 a left outer join                                                                        
RISK.DBO.collection_client_details b                                                                        
on a.party_code=b.party_code                                                            
                                                            
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                                                        
                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                   
WHERE #file2.PARTY_CODE=B.CLCODE                                    
                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)        
                                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                            
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                            
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                        
        
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \          
commented by manesh on 22/10/2007          
*/          
        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                        
      
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */            
update #file2  set eff_Deposit=debit_value*-1       
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0      
                                              
                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                            
                                        
                                                              
SELECT * FROM                                                            
(                             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
dummy='',                    
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                               
UNION                                                           
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
dummy='',                    
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                      
from #file2                                                               
) A ORDER BY PARTY_cODE,RECTYPE                                                            
                                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S2
-- --------------------------------------------------
CREATE procedure LmtME_710S2(@location as varchar(50),@odinserver as varchar(50))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'                        
                          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                         
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                  
                                                
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                             
                               
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                     
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                 
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                       

UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0     
                                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
    
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \      
commented by manesh on 22/10/2007      
*/      
    
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                      
  
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */        
update #file2  set eff_Deposit=debit_value*-1   
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0  
                                            
                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI       
                                                            
SELECT * FROM                                                          
(                           
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                  
Gross_Expo_Mult=-1,GE_Limit=-1,                    
Net_Expo_Multi=-1,                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                  
dummy='',                  
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                
from #file2                                                             
UNION                                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                  
Gross_Expo_Mult=-1,GE_Limit=-1,                    
Net_Expo_Multi=-1,                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                  
dummy='',                  
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                    
from #file2                                                             
) A ORDER BY PARTY_cODE,RECTYPE                                                          
                                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S3
-- --------------------------------------------------
CREATE procedure LmtME_710S3(@location as varchar(50),@odinserver as varchar(50))                                                                    
as                                                                    
                                                                    
set transaction isolation level read uncommitted                                                                    
set nocount on                                                                    
                            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'                          
                            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                           
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
                                                            
SELECT                                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
ALLOWED_DEBIT,GOODWILL,                                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                        
HOLDING,                                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                            
INTO #FILE2                                                                        
FROM #file1 a left outer join                                                                        
RISK.DBO.collection_client_details b                                                                        
on a.party_code=b.party_code                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                          

UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                   
WHERE #file2.PARTY_CODE=B.CLCODE                                    
                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                            
                                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0            
                                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                        
      
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \        
commented by manesh on 22/10/2007        
*/        
      
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                        
  
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */        
update #file2  set eff_Deposit=debit_value*-1   
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0  
                                              
                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI         
                                        
                                                              
SELECT * FROM                                                            
(                             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
dummy='',                    
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                               
UNION                                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
dummy='',                    
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                      
from #file2                                                               
) A ORDER BY PARTY_cODE,RECTYPE                                                            
                                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S4
-- --------------------------------------------------
CREATE procedure LmtME_710S4(@location as varchar(50),@odinserver as varchar(50))                                                                      
as                                                                      
                                                                      
set transaction isolation level read uncommitted                                                                      
set nocount on                                                                      
                              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'                            
                              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                             
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
                                                              
SELECT                                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                      
ALLOWED_DEBIT,GOODWILL,                                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                          
HOLDING,                                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                              
INTO #FILE2                                                                          
FROM #file1 a left outer join                                                                          
RISK.DBO.collection_client_details b                                                                          
on a.party_code=b.party_code                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                         
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                     
WHERE #file2.PARTY_CODE=B.CLCODE                                      
                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                                          
                                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                              
                                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                              
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0            
                                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                          
        
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \          
commented by manesh on 22/10/2007          
*/          
        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                          
    
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */          
update #file2  set eff_Deposit=debit_value*-1     
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0    
                                                
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI           
                                          
                                                              
                                                                
SELECT * FROM                                                              
(                               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
dummy='',                      
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                
from #file2                                                                 
UNION                                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
dummy='',                      
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                        
from #file2                                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                                              
                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S5
-- --------------------------------------------------
CREATE procedure LmtME_710S5(@location as varchar(50),@odinserver as varchar(50))                                                                      
as                                                                      
                                                                      
set transaction isolation level read uncommitted                                                                      
set nocount on                                                                      
                              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'                            
                              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                             
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
                                                              
SELECT                                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                      
ALLOWED_DEBIT,GOODWILL,                                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                          
HOLDING,                                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                              
INTO #FILE2                                                                          
FROM #file1 a left outer join                                                                          
RISK.DBO.collection_client_details b                                                                          
on a.party_code=b.party_code                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                         
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                     
WHERE #file2.PARTY_CODE=B.CLCODE                                      
                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                                          
                                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                              
                                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                              
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0            

update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                          
        
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \          
commented by manesh on 22/10/2007          
*/          
        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                          
    
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */          
update #file2  set eff_Deposit=debit_value*-1     
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0    
                                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI           
                                          
                                                                
SELECT * FROM                                                              
(                               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
dummy='',                      
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                
from #file2                                                                 
UNION                                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
dummy='',                      
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                        
from #file2                                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                                              
                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S6
-- --------------------------------------------------
CREATE procedure LmtME_710S6(@location as varchar(50),@odinserver as varchar(50))                                                                        
as                                                                        
                                                                        
set transaction isolation level read uncommitted                                                                        
set nocount on                                                                        
                                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'                              
                                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                               
                                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                        
                                                                
SELECT                                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                        
ALLOWED_DEBIT,GOODWILL,                                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                            
HOLDING,                                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                                
INTO #FILE2                                                                            
FROM #file1 a left outer join                                                                            
RISK.DBO.collection_client_details b                                                                            
on a.party_code=b.party_code                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                           
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                       
WHERE #file2.PARTY_CODE=B.CLCODE                                        
                                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                                            
                                             
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                                
                                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                                
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                            
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0            
                                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                            
          
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \            
commented by manesh on 22/10/2007            
*/            
          
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                            
      
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */            
update #file2  set eff_Deposit=debit_value*-1       
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0      
                                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI             
                                            
                                                                  
SELECT * FROM                                                                
(                                 
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                          
Periodicity=17,                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                        
Gross_Expo_Mult=-1,GE_Limit=-1,                          
Net_Expo_Multi=-1,                                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                  
Net_Sale_Expo_Multi=-1,                                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                        
dummy='',   
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                  
from #file2                                                                   
UNION                                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                          
Periodicity=17,                                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                        
Gross_Expo_Mult=-1,GE_Limit=-1,                          
Net_Expo_Multi=-1,                                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                  
Net_Sale_Expo_Multi=-1,                                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                        
dummy='',                        
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                          
from #file2                                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                                
                                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S7
-- --------------------------------------------------
CREATE procedure LmtME_710S7(@location as varchar(50),@odinserver as varchar(50))                                                                            
as                                                                            
                                                                            
set transaction isolation level read uncommitted                                                                            
set nocount on                                                                            
                                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'                                  
                                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                                   
                                    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                            
                                                                    
SELECT                                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                            
ALLOWED_DEBIT,GOODWILL,                                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                                
HOLDING,                                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                                    
INTO #FILE2                                                                                
FROM #file1 a left outer join                                                                                
RISK.DBO.collection_client_details b                                                                                
on a.party_code=b.party_code                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                         
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                               
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                           
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                                
WHERE #file2.PARTY_CODE=B.CLCODE      
    
  
  
update #file2 set dummy1 = -1 where dummy1=''  
                                               
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                                    
                                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                                    
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                                
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                               
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                
                                                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                                
              
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \                
commented by manesh on 22/10/2007                
*/                
              
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                                
          
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */                
update #file2  set eff_Deposit=debit_value*-1           
where (appr+fo_col) < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0          
       
                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                 
                                                
                                                                      
SELECT * FROM                                                                    
(                                     
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                              
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                            
Gross_Expo_Mult=-1,GE_Limit=-1,                              
Net_Expo_Multi=-1,                                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                      
Net_Sale_Expo_Multi=-1,                                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                            
dummy='',       
MTM_Limit_in_000=cast(limit_multi as int),                          
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                                  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                      
from #file2                                                                       
UNION                                                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                              
Periodicity=17,                                                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                            
Gross_Expo_Mult=-1,GE_Limit=-1,                              
Net_Expo_Multi=-1,                                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                      
Net_Sale_Expo_Multi=-1,                                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                            
dummy='',                            
MTM_Limit_in_000=cast(limit_multi as int),                          
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                                  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                              
from #file2                                                                       
) A ORDER BY PARTY_cODE,RECTYPE                                                                    
                                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LmtME_710S8
-- --------------------------------------------------
CREATE procedure LmtME_710S8(@location as varchar(50),@odinserver as varchar(50))                                                                          
as                                                                          
                                                                          
set transaction isolation level read uncommitted                                                                          
set nocount on                                                                          
                                  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'                                
                                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                                 
                                  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                          
                                                                  
SELECT                                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                          
ALLOWED_DEBIT,GOODWILL,                                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                              
HOLDING,                                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                                  
INTO #FILE2                                                                              
FROM #file1 a left outer join                                                                              
RISK.DBO.collection_client_details b                                                                              
on a.party_code=b.party_code                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                       
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                             
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                         
WHERE #file2.PARTY_CODE=B.CLCODE                                          
                                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                                              
                                               
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                                  
                                                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                                  
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                              
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                             
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0              
                                                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                              
            
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \              
commented by manesh on 22/10/2007              
*/              
            
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                              
        
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */              
update #file2  set eff_Deposit=debit_value*-1         
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0        
                                                    
                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI               
                                              
                                                                    
SELECT * FROM                                                                  
(                                   
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                            
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                          
Gross_Expo_Mult=-1,GE_Limit=-1,                            
Net_Expo_Multi=-1,                                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                    
Net_Sale_Expo_Multi=-1,                                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                          
dummy='',     
MTM_Limit_in_000=cast(limit_multi as int),                        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                                
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                    
from #file2                                                                     
UNION                                                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                            
Periodicity=17,                                                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                          
Gross_Expo_Mult=-1,GE_Limit=-1,                            
Net_Expo_Multi=-1,                                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                    
Net_Sale_Expo_Multi=-1,                                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                          
dummy='',                          
MTM_Limit_in_000=cast(limit_multi as int),                        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                                
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                            
from #file2                                                                     
) A ORDER BY PARTY_cODE,RECTYPE                                                                  
                                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_client
-- --------------------------------------------------
CREATE procedure [dbo].[mis_ebrok_client] (@flag as varchar(8),@pcode as varchar(11),@dpid as varchar(20),@access_to AS VARCHAR(11),@access_code AS VARCHAR(11))      

as      

      

set nocount on      

      

IF @FLAG=''      

BEGIN      

select [Client Code]=a.party_code,      

DPID=b.cm_cd    

,[POA Status]=b.po_status,[Product Assigned]=a.product     

into #client_dp1    

from       

(select *,      

product=(case when odin_server='172.31.15.34' then 'Angel Trade'  else 'Angel Diet' end)      

from ebrok_client      

where party_code=@pcode      

)a      

left outer join      

(      

select  cm_cd,cm_blsavingcd ,      

po_status=(case when cm_poaforpayin = 'Y'  and cm_poaname like '%Angel%' and left(cm_cd,8) ='12033200' then      

'Active' else 'Inactive' end )      

from [AngelDP4].DMAT.[citrus_usr].[Synergy_Client_Master]      

--order by cm_blsavingcd      

)b      

on a.party_code=b.cm_blsavingcd      

      

    

select [Client Code],DPID=case when b.hld_ac_code is null then DPID else '<A HREF=/Global3/Report.aspx?reportno=26&flag=holding&dpid='+DPID+'>'+DPID+'</a>' end    

,[POA Status],[Product Assigned] from #client_dp1 a    

left outer join    

(select hld_ac_code,hold=sum(hld_ac_pos) from [AngelDP4].DMAT.[dbo].[synergy_holding] group by hld_ac_code)b    

on DPID=b.hld_ac_code    

    

    

END      

      

      

IF @FLAG='holding'      

BEGIN      

       

      

select [Client Code]=b.cm_blsavingcd,DPID=a.hld_ac_code,[ISISN/Script]=a.hld_isin_code,Quantity=a.hld_ac_pos from       

(select hld_ac_code,hld_isin_code,hld_ac_pos from [AngelDP4].DMAT.[dbo].[synergy_holding]       

where  hld_ac_code=@dpid)a      

left outer join      

[AngelDP4].DMAT.[citrus_usr].[Synergy_Client_Master] b       

on a.hld_ac_code =b.cm_cd              

      

      

END      

      

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_client_23dec2019
-- --------------------------------------------------
CREATE procedure mis_ebrok_client_23dec2019 (@flag as varchar(8),@pcode as varchar(11),@dpid as varchar(20),@access_to AS VARCHAR(11),@access_code AS VARCHAR(11))    
as    
    
set nocount on    
    
IF @FLAG=''    
BEGIN    
select [Client Code]=a.party_code,    
DPID=b.cm_cd  
,[POA Status]=b.po_status,[Product Assigned]=a.product   
into #client_dp1  
from     
(select *,    
product=(case when odin_server='172.31.15.34' then 'Angel Trade'  else 'Angel Diet' end)    
from ebrok_client    
where party_code=@pcode    
)a    
left outer join    
(    
select  cm_cd,cm_blsavingcd ,    
po_status=(case when cm_poaforpayin = 'Y'  and cm_poaname like '%Angel%' and left(cm_cd,8) ='12033200' then    
'Active' else 'Inactive' end )    
from [196.1.115.199].synergy.dbo.client_master    
--order by cm_blsavingcd    
)b    
on a.party_code=b.cm_blsavingcd    
  
  
  
select [Client Code],DPID=case when b.hld_ac_code is null then DPID else '<A HREF=/Global3/Report.aspx?reportno=26&flag=holding&dpid='+DPID+'>'+DPID+'</a>' end  
,[POA Status],[Product Assigned] from #client_dp1 a  
left outer join  
(select hld_ac_code,hold=sum(hld_ac_pos) from [196.1.115.199].synergy.dbo.holding group by hld_ac_code)b  
on DPID=b.hld_ac_code  
  
  
END    
    
    
IF @FLAG='holding'    
BEGIN    
     
    
select [Client Code]=b.cm_blsavingcd,DPID=a.hld_ac_code,[ISISN/Script]=a.hld_isin_code,Quantity=a.hld_ac_pos from     
(select hld_ac_code,hld_isin_code,hld_ac_pos from [196.1.115.199].synergy.dbo.holding     
where  hld_ac_code=@dpid)a    
left outer join    
[196.1.115.199].synergy.dbo.client_master b     
on a.hld_ac_code =b.cm_cd            
    
    
END    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_client_25jan2022
-- --------------------------------------------------
CREATE procedure mis_ebrok_client_25jan2022 (@flag as varchar(8),@pcode as varchar(11),@dpid as varchar(20),@access_to AS VARCHAR(11),@access_code AS VARCHAR(11))      
as      
      
set nocount on      
      
IF @FLAG=''      
BEGIN      
select [Client Code]=a.party_code,      
DPID=b.cm_cd    
,[POA Status]=b.po_status,[Product Assigned]=a.product     
into #client_dp1    
from       
(select *,      
product=(case when odin_server='172.31.15.34' then 'Angel Trade'  else 'Angel Diet' end)      
from ebrok_client      
where party_code=@pcode      
)a      
left outer join      
(      
select  cm_cd,cm_blsavingcd ,      
po_status=(case when cm_poaforpayin = 'Y'  and cm_poaname like '%Angel%' and left(cm_cd,8) ='12033200' then      
'Active' else 'Inactive' end )      
from [172.31.16.94].DMAT.[citrus_usr].[Synergy_Client_Master]      
--order by cm_blsavingcd      
)b      
on a.party_code=b.cm_blsavingcd      
      
    
select [Client Code],DPID=case when b.hld_ac_code is null then DPID else '<A HREF=/Global3/Report.aspx?reportno=26&flag=holding&dpid='+DPID+'>'+DPID+'</a>' end    
,[POA Status],[Product Assigned] from #client_dp1 a    
left outer join    
(select hld_ac_code,hold=sum(hld_ac_pos) from [172.31.16.94].DMAT.[dbo].[synergy_holding] group by hld_ac_code)b    
on DPID=b.hld_ac_code    
    
    
END      
      
      
IF @FLAG='holding'      
BEGIN      
       
      
select [Client Code]=b.cm_blsavingcd,DPID=a.hld_ac_code,[ISISN/Script]=a.hld_isin_code,Quantity=a.hld_ac_pos from       
(select hld_ac_code,hld_isin_code,hld_ac_pos from [172.31.16.94].DMAT.[dbo].[synergy_holding]       
where  hld_ac_code=@dpid)a      
left outer join      
[172.31.16.94].DMAT.[citrus_usr].[Synergy_Client_Master] b       
on a.hld_ac_code =b.cm_cd              
      
      
END      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mis_ebrok_client31122012
-- --------------------------------------------------
CREATE procedure mis_ebrok_client31122012(@flag as varchar(8),@pcode as varchar(11),@dpid as varchar(20),@access_to AS VARCHAR(11),@access_code AS VARCHAR(11))    
as    
    
set nocount on    
    
IF @FLAG=''    
BEGIN    
select [Client Code]=a.party_code,    
DPID=b.cm_cd  
,[POA Status]=b.po_status,[Product Assigned]=a.product   
into #client_dp1  
from     
(select *,    
product=(case when odin_server='172.31.15.34' then 'Angel Trade'  else 'Angel Diet' end)    
from ebrok_client    
where party_code=@pcode    
)a    
left outer join    
(    
select  cm_cd,cm_blsavingcd ,    
po_status=(case when cm_poaforpayin = 'Y'  and cm_poaname like '%Angel%' and left(cm_cd,8) ='12033200' then    
'Active' else 'Inactive' end )    
from dpbackoffice.acercross.dbo.client_master    
--order by cm_blsavingcd    
)b    
on a.party_code=b.cm_blsavingcd    
  
  
  
select [Client Code],DPID=case when b.hld_ac_code is null then DPID else '<A HREF=/Global3/Report.aspx?reportno=26&flag=holding&dpid='+DPID+'>'+DPID+'</a>' end  
,[POA Status],[Product Assigned] from #client_dp1 a  
left outer join  
(select hld_ac_code,hold=sum(hld_ac_pos) from dpbackoffice.acercross.dbo.holding group by hld_ac_code)b  
on DPID=b.hld_ac_code  
  
  
END    
    
    
IF @FLAG='holding'    
BEGIN    
     
    
select [Client Code]=b.cm_blsavingcd,DPID=a.hld_ac_code,[ISISN/Script]=a.hld_isin_code,Quantity=a.hld_ac_pos from     
(select hld_ac_code,hld_isin_code,hld_ac_pos from dpbackoffice.acercross.dbo.holding     
where  hld_ac_code=@dpid)a    
left outer join    
dpbackoffice.acercross.dbo.client_master b     
on a.hld_ac_code =b.cm_cd            
    
    
END    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.multiple_login
-- --------------------------------------------------
create proc multiple_login 
as        
SET NOCOUNT ON 
--------- multiple login from same ip
select *,
IP=(
Case when [reason] like '%(IP Address:%' and [reason] like '%||%' 
then replace(substring([Reason],charindex('(IP Address:',[Reason])+13, charindex('||',[Reason])-charindex('(IP Address:',[Reason])-13 ),')','')
when [reason] like '%(IP Address:%' and [reason] not like '%||%' 
then replace(substring([Reason],
charindex('(IP Address:',[Reason])+13, 
50 ),')'
,'')
else '' end)
,
GateWay=(Case when [reason] like '%||%' then
replace(substring([Reason],charindex('||',[Reason])+3,50),')','')
else '' end)
,
TDate=convert(varchar(8),[logonTime])
into #filex
from CtclLogTab where isnull([reason],'') <> ''
and [logonattempt]<>'FAIL' 

select [DealerID],[GroupId],[LogonTime],[LogonAttempt],[Reason],IP,GateWay,Tdate
from #filex where ip in
(
select IP from (select distinct IP,[DealerId],Tdate from #filex where Ip <> '') a group by ip,Tdate having count(*) > 1
)
order by IP,[LogonTime]
SET NOCOUNT off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_ClientRequestOfflineOnline_process
-- --------------------------------------------------
CREATE Procedure dbo.Proc_ClientRequestOfflineOnline_process(@pcode as varchar(12))      
as      
set nocount on
select party_Code,br_approved from ClientRequestOfflineOnline  where party_Code=@pcode and br_approved in ('Y','')     
and party_code in (select party_code from intranet.ctcl.dbo.ebrok_client)     
union      
select party_Code,br_approved='Y' from mis.genodinlimit.dbo.diet_cli_all where party_Code=@pcode 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Proc_ClientRequestOfflineOnline_process_CS
-- --------------------------------------------------
CREATE Procedure Proc_ClientRequestOfflineOnline_process_CS(@pcode as varchar(12))  
as  
select party_Code,br_approved from ClientRequestOfflineOnline(nolock) where party_Code=@pcode 
and isnull(br_approved,'N')=('Y')
union  
select party_Code,br_approved='Y' from mis.genodinlimit.dbo.diet_cli_all where party_Code=@pcode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.random_password
-- --------------------------------------------------
CREATE PROC random_password
(
@len int = 8, --Length of the password to be generated
@password_type char(7) = 'simple' 
--Default is to generate a simple password with lowecase letters. 
--Pass anything other than 'simple' to generate a complex password. 
--The complex password includes numbers, special characters, upper case and lower case letters
)
AS
/*************************************************************************************************
		Copyright  2001 Angel Broking Ltd. All rights reserved.
                                          
Purpose:	To generate a random password

Written by:	Manesh Mukherjee

Tested on: 	SQL Server 7.0 and SQL Server 2000

Date modified:	March-29-2001 01:15 PM

Email: 		manesh@angelbroking.com

Examples:

To generate a simple password with a length of 8 characters:
EXEC random_password

To generate a simple password with 6 characters:
EXEC random_password 6

To generate a complex password with 8 characters:
EXEC random_password @Password_type = 'complex'

To generate a comples password with 6 characters:
EXEC random_password 6, 'complex'
*************************************************************************************************/
BEGIN
DECLARE @password varchar(25), @type tinyint, @bitmap char(6)
SET @password='' 
SET @bitmap = 'uaeioy' 
--@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords

WHILE @len > 0
BEGIN
	IF @password_type = 'simple' --Generating a simple password
	BEGIN
	IF (@len%2) = 0  --Appending a random vowel to @password
		
		SET @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RAND() * (5)),0)),1)
	ELSE --Appending a random alphabet
		SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))
		
	END
	ELSE --Generating a complex password
	BEGIN
		SET @type = ROUND(1 + (RAND() * (3)),0)

		IF @type = 1 --Appending a random lower case alphabet to @password
			SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))
		ELSE IF @type = 2 --Appending a random upper case alphabet to @password
			SET @password = @password + CHAR(ROUND(65 + (RAND() * (25)),0))
		ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password
			SET @password = @password + CHAR(ROUND(48 + (RAND() * (9)),0))
		ELSE IF @type = 4 --Appending a random special character to @password
			SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))
	END

	SET @len = @len - 1
END

SELECT @password --Here's the result

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.random_password1
-- --------------------------------------------------
CREATE PROC Random_password1 (@len           INT = 8,--Length of the password to be generated        
                              @password_type CHAR(7) = 'simple'
--Default is to generate a simple password with lowecase letters.         
--Pass anything other than 'simple' to generate a complex password.         
--The complex password includes numbers, special characters, upper case and lower case letters        
)
AS
  /*************************************************************************************************        
    Copyright  2001 Angel Broking Ltd. All rights reserved.        
  Purpose: To generate a random password        
  Written by: Manesh Mukherjee        
  Tested on:  SQL Server 7.0 and SQL Server 2000        
  Date modified: March-29-2001 01:15 PM        
  Email:   manesh@angelbroking.com        
  Examples:        
  To generate a simple password with a length of 8 characters:        
  EXEC random_password2        
          
  To generate a simple password with 6 characters:        
  EXEC random_password2 6        
          
  To generate a complex password with 8 characters:        
  EXEC random_password @Password_type = 'complex'        
          
  To generate a comples password with 6 characters:        
  EXEC random_password 6, 'complex'        
  *************************************************************************************************/
  BEGIN
      DECLARE @password VARCHAR(25),
              @type     TINYINT,
              @bitmap   CHAR(6)

      SET @password=''
      --SET @bitmap = '#$%^&~!'         
      SET @bitmap = 'aeruoy'

      --@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords        
      IF @password_type <> 'simple'
        BEGIN
            SET @password = @password + Substring(@bitmap, CONVERT(INT, Round(1 + ( Rand() * ( 5 ) ), 0)), 1)
            SET @len = @len - 1
        END

      SET @bitmap = 'aerouy'

      --set @len =len(@password)      
      WHILE @len > 0
        BEGIN
            IF @password_type = 'simple' --Generating a simple password        
              BEGIN
                  IF ( @len%2 ) = 0 --Appending a random vowel to @password        
                    SET @password = @password + Substring(@bitmap, CONVERT(INT, Round(1 + ( Rand() * ( 5 ) ), 0)), 1)
                  ELSE --Appending a random alphabet        
                    SET @password = @password + Char(Round(97 + ( Rand() * ( 25 ) ), 0))
              END
            ELSE --Generating a complex password        
              BEGIN
                  SET @type = Round(1 + ( Rand() * ( 3 ) ), 0)

                  IF @type = 1 --Appending a random lower case alphabet to @password        
                    SET @password = @password + Char(Round(97 + ( Rand() * ( 25 ) ), 0))
                  ELSE IF @type = 2 --Appending a random upper case alphabet to @password        
                    SET @password = @password + Char(Round(65 + ( Rand() * ( 25 ) ), 0))
                  ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password        
                    --SET @password = @password + Char(Round(48 + ( Rand() * ( 9 ) ), 0))
					/*to exclude 0 and 1 as per mail received from pawan on jun 21 2013*/
                    SET @password = @password + Char(Round(50 + ( Rand() * ( 7 ) ), 0))
                  ELSE IF @type = 4 --Appending a random special character to @password        
                    --    below ascii code is off. replace with numeric code between 0 and 9    
                    --    SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))       
                    SET @password = @password + Char(Round(48 + ( Rand() * ( 9 ) ), 0))
              END

            SET @len = @len - 1
        END

      SELECT @password --Here's the result        
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.random_password1_21062013
-- --------------------------------------------------
CREATE PROC [dbo].[random_password1_21062013]
(        
@len int = 8, --Length of the password to be generated        
@password_type char(7) = 'simple'         
--Default is to generate a simple password with lowecase letters.         
--Pass anything other than 'simple' to generate a complex password.         
--The complex password includes numbers, special characters, upper case and lower case letters        
)        
AS        
/*************************************************************************************************        
  Copyright  2001 Angel Broking Ltd. All rights reserved.        
                                                  
Purpose: To generate a random password        
        
Written by: Manesh Mukherjee        
        
Tested on:  SQL Server 7.0 and SQL Server 2000        
        
Date modified: March-29-2001 01:15 PM        
        
Email:   manesh@angelbroking.com        
        
Examples:        
        
To generate a simple password with a length of 8 characters:        
EXEC random_password2        
        
To generate a simple password with 6 characters:        
EXEC random_password2 6        
        
To generate a complex password with 8 characters:        
EXEC random_password @Password_type = 'complex'        
        
To generate a comples password with 6 characters:        
EXEC random_password 6, 'complex'        
*************************************************************************************************/        
BEGIN        
DECLARE @password varchar(25), @type tinyint, @bitmap char(6)        
SET @password=''         
--SET @bitmap = '#$%^&~!'         
SET @bitmap = 'aeruoy'         
--@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords        
IF @password_type <> 'simple'       
begin      
  SET @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RAND() * (5)),0)),1)        
  set @len = @len-1      
end      
SET @bitmap = 'aerouy'         
--set @len =len(@password)      
      
WHILE @len > 0        
BEGIN        
 IF @password_type = 'simple' --Generating a simple password        
 BEGIN        
  IF (@len%2) = 0  --Appending a random vowel to @password        
    SET @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RAND() * (5)),0)),1)        
  ELSE --Appending a random alphabet        
    SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))        
  END        
 ELSE --Generating a complex password        
  BEGIN        
  SET @type = ROUND(1 + (RAND() * (3)),0)        
        
   IF @type = 1 --Appending a random lower case alphabet to @password        
    SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))        
 ELSE IF @type = 2 --Appending a random upper case alphabet to @password        
    SET @password = @password + CHAR(ROUND(65 + (RAND() * (25)),0))        
 ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password        
    SET @password = @password + CHAR(ROUND(48 + (RAND() * (9)),0))        
 ELSE IF @type = 4 --Appending a random special character to @password        
--    below ascii code is off. replace with numeric code between 0 and 9    
--    SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))       
    SET @password = @password + CHAR(ROUND(48 + (RAND() * (9)),0))         
  END        
  SET @len = @len - 1        
END        
        
SELECT @password --Here's the result        
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.random_password2
-- --------------------------------------------------
CREATE PROC random_password2  
(  
@len int = 8, --Length of the password to be generated  
@password_type char(7) = 'simple'   
--Default is to generate a simple password with lowecase letters.   
--Pass anything other than 'simple' to generate a complex password.   
--The complex password includes numbers, special characters, upper case and lower case letters  
)  
AS  
/*************************************************************************************************  
  Copyright  2001 Angel Broking Ltd. All rights reserved.  
                                            
Purpose: To generate a random password  
  
Written by: Manesh Mukherjee  
  
Tested on:  SQL Server 7.0 and SQL Server 2000  
  
Date modified: March-29-2001 01:15 PM  
  
Email:   manesh@angelbroking.com  
  
Examples:  
  
To generate a simple password with a length of 8 characters:  
EXEC random_password2  
  
To generate a simple password with 6 characters:  
EXEC random_password2 6  
  
To generate a complex password with 8 characters:  
EXEC random_password @Password_type = 'complex'  
  
To generate a comples password with 6 characters:  
EXEC random_password 6, 'complex'  
*************************************************************************************************/  
BEGIN  
DECLARE @password varchar(25), @type tinyint, @bitmap char(6)  
SET @password=''   
SET @bitmap = '#$%^&~!'   
--@bitmap contains all the vowels, which are a, e, i, o, u and y. These vowels are used to generate slightly readable/rememberable simple passwords  
IF @password_type <> 'simple' 
begin
		SET @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RAND() * (5)),0)),1)  
		set @len = @len-1
end
SET @bitmap = 'aeiouy'   
--set @len =len(@password)

WHILE @len > 0  
BEGIN  
 IF @password_type = 'simple' --Generating a simple password  
 BEGIN  
	 IF (@len%2) = 0  --Appending a random vowel to @password  
		  SET @password = @password + SUBSTRING(@bitmap,CONVERT(int,ROUND(1 + (RAND() * (5)),0)),1)  
	 ELSE --Appending a random alphabet  
		  SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))  
	 END  
 ELSE --Generating a complex password  
	 BEGIN  
	 SET @type = ROUND(1 + (RAND() * (3)),0)  
  
  	IF @type = 1 --Appending a random lower case alphabet to @password  
	   SET @password = @password + CHAR(ROUND(97 + (RAND() * (25)),0))  
	ELSE IF @type = 2 --Appending a random upper case alphabet to @password  
	   SET @password = @password + CHAR(ROUND(65 + (RAND() * (25)),0))  
	ELSE IF @type = 3 --Appending a random number between 0 and 9 to @password  
	   SET @password = @password + CHAR(ROUND(48 + (RAND() * (9)),0))  
	ELSE IF @type = 4 --Appending a random special character to @password  
	   SET @password = @password + CHAR(ROUND(33 + (RAND() * (13)),0))  
	 END  
	 SET @len = @len - 1  
END  
  
SELECT @password --Here's the result  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remDblQuotes
-- --------------------------------------------------
CREATE procedure remDblQuotes
as
update CtclLogTab set reason = replace(reason,'"','')
update CtclLogTab set reason = replace(reason,',',' ')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_cliposition
-- --------------------------------------------------
CREATE procedure rpt_cliposition(@location as varchar(50),@odinserver as varchar(50))        
as        
        
set transaction isolation level read uncommitted        
set nocount on        
        
SELECT * into #file1 FROM CLIENT_MAST WHERE LOCATION=@location AND ODIN_SERVER=@odinserver        
        
SELECT        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,        
DEPOSIT=ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0),LIMIT_MULTI,        
GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0))*LIMIT_MULTI,        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,        
ALLOWED_DEBIT,GOODWILL,        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),        
HOLDING        
INTO #FILE2        
FROM #file1 a left outer join        
RISK.DBO.collection_client_details b        
on a.party_code=b.party_code        
        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
--select * from #file2        
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,  
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,  
cast(holding as int)as holding from #file2              
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_CRISIS_cliposition
-- --------------------------------------------------
CREATE procedure rpt_CRISIS_cliposition(@location as varchar(50),@odinserver as varchar(50))        
as        
        
set transaction isolation level read uncommitted        
set nocount on        
        
SELECT * into #file1 FROM CLIENT_MAST WHERE LOCATION=@location AND ODIN_SERVER=@odinserver        
        
SELECT        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,        
DEPOSIT=ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0),LIMIT_MULTI,        
GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0))*LIMIT_MULTI,        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,        
ALLOWED_DEBIT,GOODWILL,        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),        
HOLDING        
INTO #FILE2        
FROM #file1 a left outer join        
RISK.DBO.collection_client_details b        
on a.party_code=b.party_code        
        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b        
WHERE #file2.PARTY_CODE=B.CLCODE        
        
--select * from #file2        
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,  
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,  
cast(holding as int)as holding from #file2              
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_CRISIS_limit_file
-- --------------------------------------------------

CREATE procedure rpt_CRISIS_limit_file(@location as varchar(50),@odinserver as varchar(50))                
as                
          
/*  
declare @location as varchar(50),@odinserver as varchar(50)          
set @location = '%'          
set @odinserver = 'odin6'          
*/  
          
set transaction isolation level read uncommitted                
set nocount on                
      
SELECT distinct * into #file1 FROM CLIENT_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver       
--and party_code like @search+'%'            
        
/*                
SELECT * into #file1 FROM CLIENT_MAST WHERE LOCATION=@location AND ODIN_SERVER=@odinserver                
                
SELECT                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                
DEPOSIT=ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0),LIMIT_MULTI,                
GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0))*LIMIT_MULTI,                
MTM_LIMIT,MIN_LIMIT,MAX_LIMIT,                
ALLOWED_DEBIT,GOODWILL,                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                
HOLDING                
INTO #FILE2                
FROM #file1 a left outer join                
RISK.DBO.collection_client_details b                
on a.party_code=b.party_code                
          
                
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                
--select * from #file2                
*/          
      
      
----------------- NEW LOGIC         
    
update #file1 set LIMIT_MULTI = 1        
        
update #file1 set LIMIT_MULTI = 4 where party_code in        
(        
select distinct party_code         
from ANGELFO.NSEFO.DBO.fobillvalan         
WHERE sauda_date  = (Select max(sauda_Date) from ANGELFO.NSEFO.DBO.fobillvalan)         
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type        
having sum(pqty-sqty) <> 0        
)        
        
        
update #file1 set LIMIT_MULTI = 4 where party_code in        
(        
select distinct party_code         
from ANGELCOMMODITY.MCDX.DBO.fobillvalan         
WHERE sauda_date  = (Select max(sauda_Date) from ANGELCOMMODITY.MCDX.DBO.fobillvalan)         
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type        
having sum(pqty-sqty) <> 0        
)        
        
update #file1 set LIMIT_MULTI = 4 where party_code in        
(        
select distinct party_code         
from ANGELCOMMODITY.NCDX.DBO.fobillvalan         
WHERE sauda_date  = (Select max(sauda_Date) from ANGELCOMMODITY.NCDX.DBO.fobillvalan)         
group by party_code,inst_type,symbol,expirydate,Strike_price,Option_type        
having sum(pqty-sqty) <> 0        
)        
    
    
SELECT                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                
LEDGER=isnull(ABL,0)+isnull(ACDL,0)+isnull(CASH_DEPOSIT,0),        
HOLDING,        
LIMIT_MULTI,                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                
ALLOWED_DEBIT,GOODWILL,                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),        
FO_COLL=convert(money,0)        
INTO #FILE2x        
FROM #file1 a left outer join                
RISK.DBO.collection_client_details b                
on a.party_code=b.party_code                
        
UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                
WHERE #file2x.PARTY_CODE=B.CLCODE     
--and #FILE2x.LIMIT_MULTI=4        
                        
UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2x.PARTY_CODE=B.CLCODE     
--and #FILE2x.LIMIT_MULTI=4        
                
UPDATE #FILE2x SET ledger=ledger+(b.LEDGERAMOUNT*-1),fo_coll=fo_coll+cash_coll+non_cash                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                
WHERE #file2x.PARTY_CODE=B.CLCODE     
--and #FILE2x.LIMIT_MULTI=4        
        
        
SELECT                
BRCODE,SBCODE,PARTY_CODE,PARTY_NAME,                
DEPOSIT=((case when ledger < ledger-holding then ledger-holding else ledger end)+fo_coll)*-1        
,LIMIT_MULTI,                
GROSS_EXP=(((case when ledger < ledger-holding then ledger-holding else ledger end)+fo_coll)*-1)*LIMIT_MULTI,        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,        
ALLOWED_DEBIT,GOODWILL,                
DEBIT_VALUE=ISNULL(ledger,0),                
HOLDING                
INTO #FILE2                
FROM #file2x        
        
--DROP TABLE #FILE2                
update #file2 set deposit=0, gross_exp=0 where deposit < 0        
  
  
---------------------------- NEW LOGIC END        
  
  
select * into #file3 from #file2 where DEPOSIT < 100000 and holding > 0  
  
--update #file3 set deposit=(CASE WHEN DEPOSIT > HOLDING THEN DEPOSIT ELSE HOLDING END), limit_multi=2,gross_exp=holding*2   
update #file3 set deposit=DEPOSIT+(HOLDING*2), limit_multi=1,gross_exp=DEPOSIT+(HOLDING*2)

--update #file2 set deposit=(CASE WHEN DEPOSIT > HOLDING THEN DEPOSIT ELSE HOLDING END), limit_multi=2,gross_exp=holding*2 where DEPOSIT < 100000 and holding > 0  
update #file2 set deposit=DEPOSIT+(HOLDING*2), limit_multi=1,gross_exp=DEPOSIT+(HOLDING*2) where DEPOSIT < 100000 and holding > 0  
--------------------------------------------------------      
  
if @odinserver = 'odin6'    
begin  
         
 select * from  
 (  
 select rectype='1',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
 Periodicity=17,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),          
 GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,Net_Purchase_Premium=-1,Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,          
 Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0          
 from #file2                      
 union all  
 select rectype='2',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
 Periodicity=17,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),          
 GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,Net_Purchase_Premium=-1,Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,          
 Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0          
 from #file2                      
 union all  

 select rectype='1',party_code,brcode,cast(deposit-(holding*2) as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
 Periodicity=7,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=-1,          
 GE_Limit=-1,Net_Expo_Multi=-1,Net_Purchase_Premium=cast(deposit-(holding*2) as int),Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='-1',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=400000,Max_Order_Qty=3000,Retain_Multi=0,          
 Inclu_MTMP=0,Inclu_Net_Premium=-1,Gross_Net=0          
 from #file3  

 union all  
 select rectype='2',party_code,brcode,cast(deposit-(holding*2) as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
 Periodicity=7,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=-1,          
 GE_Limit=-1,Net_Expo_Multi=-1,Net_Purchase_Premium=cast(deposit-(holding*2) as int),Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='-1',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=400000,Max_Order_Qty=3000,Retain_Multi=0,          
 Inclu_MTMP=0,Inclu_Net_Premium=-1,Gross_Net=0          
 from #file3  
 ) a order by party_Code,rectype  
end  
  
  
if @odinserver = 'odin7'    
begin  
         
 select * from  
 (  
 select rectype='2',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
 Periodicity=17,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),          
 GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,Net_Purchase_Premium=-1,Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,          
 Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0          
 from #file2                      
 union all  
 select rectype='2',party_code,brcode,deposit=cast(deposit-(holding*2) as int),Code='',Symbol='',Series='',XGroup='',          
 Periodicity=7,Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=-1,          
 GE_Limit=-1,Net_Expo_Multi=-1,Net_Purchase_Premium=cast(deposit-(holding*2) as int),Net_Sale_Expo_Multi=-1,          
 NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
 Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='-1',          
 Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=400000,Max_Order_Qty=3000,Retain_Multi=0,          
 Inclu_MTMP=0,Inclu_Net_Premium=-1,Gross_Net=0          
 from #file3  
 ) a order by party_Code  
end  
  
/*  
select rectype='2',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',          
Periodicity=(case when limit_multi =2 then 8 else 17 end),  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,  
Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),  
Net_Sale_Expo_Multi=-1,          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(2,2)),MTM_Limit_in_000='',          
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0          
from #file2                      
*/  
          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_deal_limit_file
-- --------------------------------------------------
CREATE procedure rpt_deal_limit_file(@location as varchar(50),@odinserver as varchar(50))                              
as                              
                              
set transaction isolation level read uncommitted                              
set nocount on                              
                    
SELECT * into #file1 FROM DEALER_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver    
            
                     
SELECT                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),          
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                  
GROSS_EXP=CONVERT(MONEY,0),                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,              
           
ALLOWED_DEBIT,GOODWILL,                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                  
HOLDING,                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                      
INTO #FILE2                                  
FROM #file1 a left outer join                                  
RISK.DBO.collection_client_details b                                  
on a.party_code=b.party_code                      
                      
                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                  
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                      
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                      
                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                      
----test              
--update #file2 set max_limit=-1 where party_code='n3417'            
--select * from #file2  where party_code='A780'      
      
update #file2 set EFF_DEPOSIT=deposit     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0  
        
-------      
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit               
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1              
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1              
              
--update #file2 set deposit=EFF_DEPOSIT              
              
---      
  
  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                      
  
------old log                      
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                      
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                       
                      
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
  
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                            
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                       
                      
                        
SELECT * FROM                      
(                      
select rectype='1',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                
Periodicity=17,                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                        
Net_Sale_Expo_Multi=-1,                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                            
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                
from #file2                         
                      
UNION                      
                      
select rectype='2',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                
Periodicity=17,                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                        
Net_Sale_Expo_Multi=-1,                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,           
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                             
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                
from #file2                         
) A ORDER BY PARTY_cODE,RECTYPE                      
                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_dealposition
-- --------------------------------------------------
CREATE procedure rpt_dealposition(@location as varchar(50),@odinserver as varchar(50))          
as          
          
set transaction isolation level read uncommitted          
set nocount on          
          
SELECT * into #file1 FROM DEALER_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver          
          
SELECT          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,          
DEPOSIT=ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0),LIMIT_MULTI,          
GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+ISNULL(APPR,0))*LIMIT_MULTI,          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,          
ALLOWED_DEBIT,GOODWILL,          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),          
HOLDING          
INTO #FILE2          
FROM #file1 a left outer join          
RISK.DBO.collection_client_details b          
on a.party_code=b.party_code          
          
          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b          
WHERE #file2.PARTY_CODE=B.CLCODE          
          
          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b          
WHERE #file2.PARTY_CODE=B.CLCODE          
          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1)          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b          
WHERE #file2.PARTY_CODE=B.CLCODE          
          
--select * from #file2          
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,    
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,    
cast(holding as int)as holding from #file2                
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file
-- --------------------------------------------------
CREATE procedure rpt_limit_file(@location as varchar(50),@odinserver as varchar(50))                
as                
                
set transaction isolation level read uncommitted                
set nocount on                
      
SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver         
      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE        
UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'      
        
SELECT                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                    
GROSS_EXP=CONVERT(MONEY,0),            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                    
ALLOWED_DEBIT,GOODWILL,                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                    
HOLDING,        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)        
INTO #FILE2                    
FROM #file1 a left outer join                    
RISK.DBO.collection_client_details b                    
on a.party_code=b.party_code        
        
                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                    
WHERE #file2.PARTY_CODE=B.CLCODE                    
                    
                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                    
WHERE #file2.PARTY_CODE=B.CLCODE                    
                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                    
WHERE #file2.PARTY_CODE=B.CLCODE                    
        
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)        
        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0        
        
UPDATE #FILE2 SET GROSS_EXP=DEPOSIT*LIMIT_MULTI        
        
UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT        
UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT        
UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0        
UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0         
        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,              
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                         
        
          
SELECT * FROM        
(        
select rectype='1',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                  
Periodicity=17,        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),          
Net_Sale_Expo_Multi=-1,          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                  
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                  
from #file2           
        
UNION        
        
select rectype='2',party_code,brcode,cast(deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                  
Periodicity=17,        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),          
Net_Sale_Expo_Multi=-1,                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                  
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                  
from #file2           
) A ORDER BY PARTY_cODE,RECTYPE        
             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S1(@location as varchar(50),@odinserver as varchar(50))                                              
as                                              
                                              
set transaction isolation level read uncommitted                                              
set nocount on                                              
      
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'    
      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                     
      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null              
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null              
                         
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null              
              
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                      
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                      
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                    
                            
                                      
SELECT                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                          
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                  
GROSS_EXP=CONVERT(MONEY,0),                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                              
                           
ALLOWED_DEBIT,GOODWILL,                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                  
HOLDING,                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                      
INTO #FILE2                                                  
FROM #file1 a left outer join                                                  
RISK.DBO.collection_client_details b                                                  
on a.party_code=b.party_code                                      
                                      
                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                      
                                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                      
----test                              
--update #file2 set max_limit=-1 where party_code='n3417'                            
--select * from #file2  where party_code='A780'                      
                      
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                  
                        
-------                      
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                               
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                              
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                              
                              
--update #file2 set deposit=EFF_DEPOSIT                              
                              
---                      
                  
                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                      
                  
------old log                                      
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                      
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                       
                                      
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
              
                 
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                            
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                       
                                      
                                        
SELECT * FROM                                      
(                                      
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                
Periodicity=17,                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                         
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                        
Net_Sale_Expo_Multi=-1,                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                            
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',             
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                        
from #file2                                         
                                      
UNION                                      
                                      
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                
Periodicity=17,                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                        
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                           
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                             
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                         
) A ORDER BY PARTY_cODE,RECTYPE                                      
                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S1_GElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S1_GElimit(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                
                
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                      
                              
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
                             
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                        
----test                                
--update #file2 set max_limit=-1 where party_code='n3417'                              
--select * from #file2  where party_code='A780'                        
                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
-------                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                
                                
--update #file2 set deposit=EFF_DEPOSIT                                
                                
---                        
                    
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
------old log                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
                                        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
                
                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                         
                                        
                                          
SELECT * FROM                                        
(         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
----old logic  
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic  
Gross_Expo_Mult=-1,GE_Limit=-1,  
Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
--old logic---  
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---  
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
                                        
UNION                                        
                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
---old logic----  
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic  
Gross_Expo_Mult=-1,GE_Limit=-1,  
Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
-----old logic----  
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---  
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S1_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S1_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                              
as                                                              
                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                                              
                      
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'                    
                      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                     
                      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                              
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                              
                                         
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                    
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                      
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                      
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                    
                                            
                                                      
SELECT                                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                          
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                  
GROSS_EXP=CONVERT(MONEY,0),                                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                              
                                           
ALLOWED_DEBIT,GOODWILL,                                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                  
HOLDING,                                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                      
INTO #FILE2                                                                  
FROM #file1 a left outer join                                                                  
RISK.DBO.collection_client_details b                                                                  
on a.party_code=b.party_code                                                      
                                                      
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                 
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                             
WHERE #file2.PARTY_CODE=B.CLCODE                              
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                      
                                                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                      
----test                                              
--update #file2 set max_limit=-1 where party_code='n3417'                                            
--select * from #file2  where party_code='A780'                                      
                                      
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                  
  
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \    
commented by manesh on 22/10/2007    
*/    
  
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                                        
-------                                      
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                               
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                              
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                              
                                              
--update #file2 set deposit=EFF_DEPOSIT                                              
                                              
---                                      
                                  
                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                      
                                  
------old log                                                      
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                      
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                   
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                       
                                           
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
            
              
                
                  
                              
                                 
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                            
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                             
                                                      
                                                        
SELECT * FROM                                                      
(                       
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
----old logic                
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
Net_Expo_Multi=-1,                                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                        
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                            
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
--old logic---                
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,              
----new logic---             
dummy='',              
---old logic            
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                
---new logic            
MTM_Limit_in_000=cast(limit_multi as int),            
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                    
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                        
from #file2                                                         
                                                      
UNION                                                      
                                                      
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                
Periodicity=17,                                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
---old logic----                
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
Net_Expo_Multi=-1,                                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                        
Net_Sale_Expo_Multi=-1,                                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                           
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
-----old logic----                
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,              
----new logic---              
dummy='',              
---old logic            
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                
---new logic            
MTM_Limit_in_000=cast(limit_multi as int),            
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                    
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                             
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                
from #file2                                                         
) A ORDER BY PARTY_cODE,RECTYPE                                                      
                                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S1_MElimit_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S1_MElimit_test1(@location as varchar(50),@odinserver as varchar(50))                                                            
as                                                            
                                                            
set transaction isolation level read uncommitted                                                            
set nocount on                                                            
                    
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN710S1'                  
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                            
                                       
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                  
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                    
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                    
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                  
                                          
                                                    
SELECT                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
                                         
ALLOWED_DEBIT,GOODWILL,                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                
HOLDING,                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                    
INTO #FILE2                                                                
FROM #file1 a left outer join                                                                
RISK.DBO.collection_client_details b                                                                
on a.party_code=b.party_code                                                    
                                                    
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                           
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                           
WHERE #file2.PARTY_CODE=B.CLCODE                            
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                    
                                                    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                    
----test                                            
--update #file2 set max_limit=-1 where party_code='n3417'                                          
--select * from #file2  where party_code='A780'                                    
                                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                


/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0

                                      
-------                                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                             
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                            
                                            
--update #file2 set deposit=EFF_DEPOSIT                                            
                                            
---                                    
                                
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                    
                                
------old log                                                    
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                    
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                                                                       
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                       
          
            
              
                
                            
                               
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                          
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                           
                                                    
                                                      
SELECT * FROM                                                    
(                     
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                              
Periodicity=17,                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
----old logic              
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic              
Gross_Expo_Mult=-1,GE_Limit=-1,              
Net_Expo_Multi=-1,                                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                      
Net_Sale_Expo_Multi=-1,                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
--old logic---              
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---           
dummy='',            
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                      
from #file2                                                       
                                                    
UNION                                                    
                                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                              
Periodicity=17,                                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
---old logic----              
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic              
Gross_Expo_Mult=-1,GE_Limit=-1,              
Net_Expo_Multi=-1,                                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                      
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),          -----old logic----              
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---            
dummy='',            
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                       
) A ORDER BY PARTY_cODE,RECTYPE                                                    
                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S1_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S1_test1(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN710S1'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                
                
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                      
                              
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
                             
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                        
----test                                
--update #file2 set max_limit=-1 where party_code='n3417'                              
--select * from #file2  where party_code='A780'                        
                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
-------                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                
                                
--update #file2 set deposit=EFF_DEPOSIT                                
                                
---                        
                    
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
------old log                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
                                        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
                
                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                         
                                        
                                          
SELECT * FROM                                        
(         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                           
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',               
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
                                        
UNION                                        
                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                  
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S2
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S2(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                
                
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                      
                              
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
                             
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                        
----test                                
--update #file2 set max_limit=-1 where party_code='n3417'                              
--select * from #file2  where party_code='A780'                        
                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
-------                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                
                                
--update #file2 set deposit=EFF_DEPOSIT                                
                                
---                        
                    
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
------old log                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
                                        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
                
                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                         
                                        
                                          
SELECT * FROM                                        
(         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                           
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',               
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
                                        
UNION                                        
                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                  
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S2_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S2_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'                      
                        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                       
                        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                
                                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                      
                                              
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                
                                             
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
                             
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                   
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                               
WHERE #file2.PARTY_CODE=B.CLCODE                                
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                        
----test                                                
--update #file2 set max_limit=-1 where party_code='n3417'                                              
--select * from #file2  where party_code='A780'                                        
                                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
  
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \    
commented by manesh on 22/10/2007    
*/    
  
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                    

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                                          
-------                                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                
                                                
--update #file2 set deposit=EFF_DEPOSIT                                                
                                                
---                                        
                                    
                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI     
                                    
------old log                                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                     
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                         
                                             
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
              
                
                  
                    
                                
                                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                               
                                                        
                                                          
SELECT * FROM                                                        
(                         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                  
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                
----old logic                  
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                
---new logic                  
Gross_Expo_Mult=-1,GE_Limit=-1,                  
Net_Expo_Multi=-1,                                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                          
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                
--old logic---                  
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                
----new logic---               
dummy='',                
---old logic              
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                  
---new logic              
MTM_Limit_in_000=cast(limit_multi as int),              
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                      
      
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                          
from #file2                                                           
                                                        
UNION                                                        
                                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                  
Periodicity=17,                                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                
---old logic----                  
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                
---new logic                  
Gross_Expo_Mult=-1,GE_Limit=-1,                  
Net_Expo_Multi=-1,                                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                          
Net_Sale_Expo_Multi=-1,                                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                
-----old logic----                  
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                
----new logic---                
dummy='',                
---old logic              
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                  
---new logic              
MTM_Limit_in_000=cast(limit_multi as int),              
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                      
      
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                  
from #file2                                                           
) A ORDER BY PARTY_cODE,RECTYPE                                                        
                                              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S3
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S3(@location as varchar(50),@odinserver as varchar(50))                                                  
as                                                  
                                                  
set transaction isolation level read uncommitted                                                  
set nocount on                                                  
          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'        
          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                         
          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                  
                             
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                  
                  
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                          
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                          
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                        
                                
                                          
SELECT                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                      
GROSS_EXP=CONVERT(MONEY,0),                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
                               
ALLOWED_DEBIT,GOODWILL,                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                      
HOLDING,                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                          
INTO #FILE2                                                      
FROM #file1 a left outer join                                                      
RISK.DBO.collection_client_details b                                                      
on a.party_code=b.party_code                                          
                                          
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                          
                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                          
----test                                  
--update #file2 set max_limit=-1 where party_code='n3417'                                
--select * from #file2  where party_code='A780'                          
                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                      
                            
-------                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                   
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                  
                                  
--update #file2 set deposit=EFF_DEPOSIT                                  
                                  
---                          
                      
                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                          
                      
------old log                                          
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                          
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                          
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
                                          
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
      
                  
                     
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                         
                                          
                                            
SELECT * FROM                                          
(           
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                             
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                 
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                             
                                          
UNION                                          
                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                    
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                    
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
from #file2                                             
) A ORDER BY PARTY_cODE,RECTYPE                                          
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S3_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S3_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'                        
                          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                         
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                  
                                             
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                        
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                          
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                          
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                        
                                                
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
                                               
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                             
                               
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                     
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                 
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                          
----test                                                  
--update #file2 set max_limit=-1 where party_code='n3417'                                                
--select * from #file2  where party_code='A780'                                          
                                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
    
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \      
commented by manesh on 22/10/2007      
*/      
    
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                      

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                                            
-------                                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                   
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                  
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                  
                                                  
--update #file2 set deposit=EFF_DEPOSIT                                                  
                                                  
---                                          
                                      
                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI       
                                      
------old log                                                          
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                          
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                       
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                           
                                               
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
 
    
                
                  
                    
                      
                                  
                                     
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                 
                                                          
                                                            
SELECT * FROM                                                          
(                           
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                  
----old logic                    
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                  
---new logic                    
Gross_Expo_Mult=-1,GE_Limit=-1,                    
Net_Expo_Multi=-1,                                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                  
--old logic---                    
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                  
----new logic---                 
dummy='',                  
---old logic                
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                    
---new logic                
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                            
from #file2                                                             
                                                          
UNION                                                          
                                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                  
---old logic----                    
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                  
---new logic                    
Gross_Expo_Mult=-1,GE_Limit=-1,                    
Net_Expo_Multi=-1,                                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                  
-----old logic----                    
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                  
----new logic---                  
dummy='',                  
---old logic                
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                    
---new logic                
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                    
from #file2                                                             
) A ORDER BY PARTY_cODE,RECTYPE                                                          
                                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S4
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S4(@location as varchar(50),@odinserver as varchar(50))                                                    
as                                                    
                                                    
set transaction isolation level read uncommitted                                                    
set nocount on                                                    
            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'          
            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                           
            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                    
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                    
                               
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                    
                    
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                            
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                            
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                          
                                  
                                            
SELECT                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                        
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                        
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                    
                                 
ALLOWED_DEBIT,GOODWILL,                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                        
HOLDING,                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                            
INTO #FILE2                                                        
FROM #file1 a left outer join                                                        
RISK.DBO.collection_client_details b                                                        
on a.party_code=b.party_code                                            
                                            
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                            
                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                            
----test                                    
--update #file2 set max_limit=-1 where party_code='n3417'                                  
--select * from #file2  where party_code='A780'                            
                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                        
Update #file2 SET eff_deposit=0 Where eff_deposit<0                        
                              
-------                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                     
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                    
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                    
                                    
--update #file2 set deposit=EFF_DEPOSIT                                    
                                    
---                            
                        
                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                            
                        
------old log                                            
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                            
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                            
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                            
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                             
                                            
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
      
        
                    
                       
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                  
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                           
                                            
                                              
SELECT * FROM                                            
(             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                               
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                   
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                               
                                            
UNION                                            
                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                      
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                      
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                      
from #file2                                               
) A ORDER BY PARTY_cODE,RECTYPE                                            
                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S4_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S4_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                    
as                                                                    
                                                                    
set transaction isolation level read uncommitted                                                                    
set nocount on                                                                    
                            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'                          
                            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                           
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
                                               
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                            
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                            
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                          
                                                  
                                                            
SELECT                                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                        
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                        
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
                                                 
ALLOWED_DEBIT,GOODWILL,                                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                        
HOLDING,                                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                            
INTO #FILE2                                                                        
FROM #file1 a left outer join                                                                        
RISK.DBO.collection_client_details b                                                                        
on a.party_code=b.party_code                                                            
                                                            
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                               
                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                   
WHERE #file2.PARTY_CODE=B.CLCODE                                    
                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                            
                                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
----test                                                    
--update #file2 set max_limit=-1 where party_code='n3417'                                                  
--select * from #file2  where party_code='A780'                                            
                                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                        
      
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \        
commented by manesh on 22/10/2007        
*/        
      
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                        
  
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */        
update #file2  set eff_Deposit=debit_value*-1   
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0  
                                              
-------                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                     
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1   
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                    
                                                    
--update #file2 set deposit=EFF_DEPOSIT                                                    
                                                    
---                                            
                                        
                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI         
                                        
------old log                                                            
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                            
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                            
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                         
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                             
                                                 
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
   
   
      
                  
                    
                      
                        
                                    
                                       
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                  
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                                            
                                                              
SELECT * FROM                                                            
(                             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
----old logic                      
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
--old logic---                      
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                    
----new logic---                   
dummy='',                    
---old logic                  
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                      
---new logic                  
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                               
                                                            
UNION                                                            
                                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
---old logic----                      
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
-----old logic----                      
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                    
----new logic---                    
dummy='',                    
---old logic                  
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                      
---new logic                  
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                      
from #file2                                                               
) A ORDER BY PARTY_cODE,RECTYPE                                                            
                                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S5
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S5(@location as varchar(50),@odinserver as varchar(50))                                                    
as                                                    
                                                    
set transaction isolation level read uncommitted                                                    
set nocount on                                                    
            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'          
            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                           
            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                    
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                    
                               
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                    
                    
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                            
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                            
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                          
                                  
                                            
SELECT                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                        
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                        
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                    
                                 
ALLOWED_DEBIT,GOODWILL,                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                        
HOLDING,                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                            
INTO #FILE2                                                        
FROM #file1 a left outer join                                                        
RISK.DBO.collection_client_details b                                                        
on a.party_code=b.party_code                                            
                                            
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                        
                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                            
                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                            
----test                                    
--update #file2 set max_limit=-1 where party_code='n3417'                                  
--select * from #file2  where party_code='A780'                            
                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                        
Update #file2 SET eff_deposit=0 Where eff_deposit<0                        
                              
-------                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                     
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                    
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                    
                                    
--update #file2 set deposit=EFF_DEPOSIT                                    
                                    
---                            
                        
                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                            
                        
------old log                                            
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                            
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                            
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                            
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                             
                                            
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
      
        
                    
                       
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                  
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                           
                                            
                                              
SELECT * FROM                                            
(             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                               
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                   
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                               
                                            
UNION                                            
                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                      
Periodicity=17,                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                      
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                              
Net_Sale_Expo_Multi=-1,                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                      
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                      
from #file2                                               
) A ORDER BY PARTY_cODE,RECTYPE                                            
                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S5_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S5_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                    
as                                                                    
                                                                    
set transaction isolation level read uncommitted                                                                    
set nocount on                                                                    
                            
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'                          
                            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                           
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                    
                                               
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                            
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                            
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                          
                                                  
                                                            
SELECT                                                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                        
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                        
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                        
GROSS_EXP=CONVERT(MONEY,0),                                                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
                                                 
ALLOWED_DEBIT,GOODWILL,                                                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                        
HOLDING,                                                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                            
INTO #FILE2                                                                        
FROM #file1 a left outer join                                                                        
RISK.DBO.collection_client_details b                                                                        
on a.party_code=b.party_code                                                            
                                                            
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                               
                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                   
WHERE #file2.PARTY_CODE=B.CLCODE                                    
                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                                                        
                                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                            
                                                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                            
----test                                                    
--update #file2 set max_limit=-1 where party_code='n3417'                                                  
--select * from #file2  where party_code='A780'                                            
                                            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                        
      
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \        
commented by manesh on 22/10/2007        
*/        
      
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                        
  
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */        
update #file2  set eff_Deposit=debit_value*-1   
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0  
                                              
-------                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                     
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1   
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                    
                                                    
--update #file2 set deposit=EFF_DEPOSIT                                                    
                                                    
---                                            
                                        
                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI         
                                        
------old log                                                            
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                            
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                            
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                         
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                             
                                                 
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
   
   
      
                  
                    
                      
                        
                                    
                                       
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                  
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                                            
                                                              
SELECT * FROM                                                            
(                             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
----old logic                      
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
--old logic---                      
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                    
----new logic---                   
dummy='',                    
---old logic                  
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                      
---new logic                  
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                               
                                                            
UNION                                                            
                                                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                      
Periodicity=17,                                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
---old logic----                      
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                              
Net_Sale_Expo_Multi=-1,                                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
-----old logic----                      
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                    
----new logic---                    
dummy='',                    
---old logic                  
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                      
---new logic                  
MTM_Limit_in_000=cast(limit_multi as int),                  
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                          
          
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                      
from #file2                                                               
) A ORDER BY PARTY_cODE,RECTYPE                                                            
                                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S6
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S6(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'            
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                      
                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                            
                                    
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
                                   
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE              
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                           
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              
----test                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                    
--select * from #file2  where party_code='A780'                              
                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
                                
-------                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                       
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                      
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                      
                                      
--update #file2 set deposit=EFF_DEPOSIT                                      
                                      
---                              
                          
                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
------old log                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                               
                                              
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,         
    
      
        
          
                      
                         
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                             
                                              
                                                
SELECT * FROM                                              
(               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                 
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                     
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                                 
                                              
UNION                                              
                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                        
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                        
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                        
from #file2                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S6_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S6_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                      
as                                                                      
                                                                      
set transaction isolation level read uncommitted                                                                      
set nocount on                                                                      
                              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'                            
                              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                             
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
                                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                            
                                                    
                                                              
SELECT                                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                      
                                                   
ALLOWED_DEBIT,GOODWILL,                                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                          
HOLDING,                                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                              
INTO #FILE2                                                                          
FROM #file1 a left outer join                                                                          
RISK.DBO.collection_client_details b                                                                          
on a.party_code=b.party_code                                                              
                                                              
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                 
                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                         
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                     
WHERE #file2.PARTY_CODE=B.CLCODE                                      
                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                                          
                                           
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                              
                                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                              
----test                                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                                    
--select * from #file2  where party_code='A780'                                              
                                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                          
        
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \          
commented by manesh on 22/10/2007          
*/          
        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                          
    
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */          
update #file2  set eff_Deposit=debit_value*-1     
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0    
                                                
-------                                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1     
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                      
                                                      
--update #file2 set deposit=EFF_DEPOSIT                                                      
                                                      
---                                              
                                          
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI           
                                          
------old log                                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                           
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                               
                                                   
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
     
     
        
                    
                      
                        
                          
                                      
                                         
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                     
                                                              
                                                                
SELECT * FROM                                                              
(                               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
----old logic                        
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                      
---new logic                        
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
--old logic---                        
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                      
----new logic---                     
dummy='',                      
---old logic                    
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                        
---new logic                    
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                
from #file2                                                                 
                                                              
UNION                                                              
                                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
---old logic----                        
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                      
---new logic                        
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
-----old logic----                        
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                      
----new logic---                      
dummy='',                      
---old logic                    
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                        
---new logic                    
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                        
from #file2                                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                                              
                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S7
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S7(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'            
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                      
                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                            
                                    
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
                                   
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE              
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                           
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              
----test                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                    
--select * from #file2  where party_code='A780'                              
                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
                                
-------                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                       
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                      
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                      
                                      
--update #file2 set deposit=EFF_DEPOSIT                                      
                                      
---                              
                          
                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
------old log                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                               
                                              
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,         
    
      
        
          
                      
                         
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                             
                                              
                                                
SELECT * FROM                                              
(               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                 
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                     
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                                 
                                              
UNION                                              
                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                        
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                        
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                        
from #file2                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S7_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S7_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                      
as                                                                      
                                                                      
set transaction isolation level read uncommitted                                                                      
set nocount on                                                                      
                              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'                            
                              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                             
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                      
                                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                            
                                                    
                                                              
SELECT                                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                      
                                                   
ALLOWED_DEBIT,GOODWILL,                                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                          
HOLDING,                                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                              
INTO #FILE2                                                                          
FROM #file1 a left outer join                                                                          
RISK.DBO.collection_client_details b                                                                          
on a.party_code=b.party_code                                                              
                                                              
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                 
                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                         
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                     
WHERE #file2.PARTY_CODE=B.CLCODE                                      
                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                                          
                                           
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                              
                                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                              
----test                                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                                    
--select * from #file2  where party_code='A780'                                              
                                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                          
        
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \          
commented by manesh on 22/10/2007          
*/          
        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                          
    
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */          
update #file2  set eff_Deposit=debit_value*-1     
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0    
                                                
-------                                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1     
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                      
                                                      
--update #file2 set deposit=EFF_DEPOSIT                                                      
                                                      
---                                              
                                          
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI           
                                          
------old log                                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                           
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                               
                                                   
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
     
     
        
                    
                      
                        
                          
                                      
                                         
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                     
                                                              
                                                                
SELECT * FROM                                                              
(                               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
----old logic                        
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                      
---new logic                        
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
--old logic---                        
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                      
----new logic---                     
dummy='',                      
---old logic                    
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                        
---new logic                    
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                
from #file2                                                                 
                                                              
UNION                                                              
                                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                        
Periodicity=17,                                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                      
---old logic----                        
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                      
---new logic                        
Gross_Expo_Mult=-1,GE_Limit=-1,                        
Net_Expo_Multi=-1,                                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                
Net_Sale_Expo_Multi=-1,                                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                      
-----old logic----                        
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                      
----new logic---                      
dummy='',                      
---old logic                    
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                        
---new logic                    
MTM_Limit_in_000=cast(limit_multi as int),                    
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                            
            
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                        
from #file2                                                                 
) A ORDER BY PARTY_cODE,RECTYPE                                                              
                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S8
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S8(@location as varchar(50),@odinserver as varchar(50))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
                                   
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                        
                        
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                              
                                      
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
                                     
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
----test                                        
--update #file2 set max_limit=-1 where party_code='n3417'                                      
--select * from #file2  where party_code='A780'                                
                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
                                  
-------                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                         
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                        
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                        
                                        
--update #file2 set deposit=EFF_DEPOSIT                                        
                                        
---                                
                            
                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                            
------old log                                                
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                 
                                                
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,           
      
        
          
            
                        
                           
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                      
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                               
                                                
                                                  
SELECT * FROM                                                
(                 
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                   
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                       
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                                   
                                                
UNION                                                
                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                          
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                          
from #file2                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_7_10_S8_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_7_10_S8_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                                        
as                                                                        
                                                                        
set transaction isolation level read uncommitted                                                                        
set nocount on                                                                        
                                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'                              
                                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                               
                                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                        
                                                   
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin710S1' and flag is null                                                              
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                                
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                                
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                              
                                                      
                                                                
SELECT                                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                        
                                                     
ALLOWED_DEBIT,GOODWILL,                                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                            
HOLDING,                                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                                
INTO #FILE2                                                                            
FROM #file1 a left outer join                                                                            
RISK.DBO.collection_client_details b                                                                            
on a.party_code=b.party_code                                                                
                                                                
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                   
                                     
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                           
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                       
WHERE #file2.PARTY_CODE=B.CLCODE                                        
                                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                                            
                                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                                
                                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                                
----test                                                        
--update #file2 set max_limit=-1 where party_code='n3417'                                                      
--select * from #file2  where party_code='A780'                                                
                                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                            
          
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \            
commented by manesh on 22/10/2007            
*/            
          
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                            
      
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */            
update #file2  set eff_Deposit=debit_value*-1       
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0      
                                                  
-------                                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                          
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1       
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                        
                                                        
--update #file2 set deposit=EFF_DEPOSIT                                                        
                                                        
---                                                
                                            
                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI             
                                            
------old log                                                                
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                                
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                             
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                                 
                                                     
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
 
    
       
       
          
                      
                        
                          
                            
                                        
                                           
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                      
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                       
                                                                
                                                                  
SELECT * FROM                                                                
(                                 
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                          
Periodicity=17,                                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                        
----old logic                          
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                        
---new logic                          
Gross_Expo_Mult=-1,GE_Limit=-1,                          
Net_Expo_Multi=-1,                                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                  
Net_Sale_Expo_Multi=-1,                                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                        
--old logic---                          
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                        
----new logic---                       
dummy='',   
---old logic                      
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                          
---new logic                      
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                  
from #file2                                                                   
                                                                
UNION                                                                
                                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                          
Periodicity=17,                                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                        
---old logic----                          
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                        
---new logic                          
Gross_Expo_Mult=-1,GE_Limit=-1,                          
Net_Expo_Multi=-1,                                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                                  
Net_Sale_Expo_Multi=-1,                                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                        
-----old logic----                          
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                        
----new logic---                        
dummy='',                        
---old logic                      
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                          
---new logic                      
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                          
from #file2                                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                                
                                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79(@location as varchar(50),@odinserver as varchar(50))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
  
SELECT * into #file_1 FROM CLIENT_MAST79  
  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                 
  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null          
          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                
                        
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
                       
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----test                          
--update #file2 set max_limit=-1 where party_code='n3417'                        
--select * from #file2  where party_code='A780'                  
                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
                    
-------                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                          
                          
--update #file2 set deposit=EFF_DEPOSIT                          
                          
---                  
              
              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
              
------old log                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
  
  
   
       
        
          
             
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                        
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                  
                                    
SELECT * FROM                                  
(                                  
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',         
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                                     
                                  
UNION                                  
                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                            
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                     
) A ORDER BY PARTY_cODE,RECTYPE                                  
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79_GElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79_GElimit(@location as varchar(50),@odinserver as varchar(50))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
  
SELECT * into #file_1 FROM CLIENT_MAST79  
  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                 
  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'acm' AND ODIN_SERVER='odin79'  and flag is null          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null          
          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                
                        
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
                       
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----test                          
--update #file2 set max_limit=-1 where party_code='n3417'                        
--select * from #file2  where party_code='A780'                  
                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
                    
-------                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                          
                          
--update #file2 set deposit=EFF_DEPOSIT                          
                          
---                  
              
              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
              
------old log                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                        
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                  
                                    
SELECT * FROM                                  
(                                  
select rectype='1',party_code,brcode,
cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
----old logic
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic
Gross_Expo_Mult=-1,GE_Limit=-1,
Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
--old logic---
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2         
---where party_code='A10656'
                          
UNION                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
---old logic----
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic
Gross_Expo_Mult=-1,GE_Limit=-1,
Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
-----old logic----
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                     
--where party_code='A10656'
) A ORDER BY PARTY_cODE,RECTYPE                                  
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                  
as                                                  
                                                  
set transaction isolation level read uncommitted                                                  
set nocount on                                                  
          
SELECT * into #file_1 FROM CLIENT_MAST79          
          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                         
          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                  
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'acm' AND ODIN_SERVER='odin79'  and flag is null                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                  
                             
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null                  
                  
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                          
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                          
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                        
                                
                                          
SELECT                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                      
GROSS_EXP=CONVERT(MONEY,0),                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
                               
ALLOWED_DEBIT,GOODWILL,                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                      
HOLDING,                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                          
INTO #FILE2                                                      
FROM #file1 a left outer join                                                      
RISK.DBO.collection_client_details b                                                      
on a.party_code=b.party_code                                          
                                          
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                     
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                      
                                          
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                          
                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                          
----test                                  
--update #file2 set max_limit=-1 where party_code='n3417'                                
--select * from #file2  where party_code='A780'                          
                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                      
  
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \    
commented by manesh on 22/10/2007    
*/    
  
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                      

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                            
-------                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                   
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                  
                                  
--update #file2 set deposit=EFF_DEPOSIT                                  
                                  
---                          
                      
                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                          
                      
------old log                                          
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                          
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                          
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
                                          
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
 
     
      
        
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                           
                                          
                                            
SELECT * FROM                                          
(                                          
select rectype='1',party_code,brcode,        
cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',        
----old logic        
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),        
---new logic        
Gross_Expo_Mult=-1,GE_Limit=-1,        
Net_Expo_Multi=-1,                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),        
--old logic---        
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,        
----new logic---        
dummy='',      
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                 
---where party_code='A10656'        
                                  
UNION                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                    
Periodicity=17,                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',        
---old logic----        
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),        
---new logic        
Gross_Expo_Mult=-1,GE_Limit=-1,        
Net_Expo_Multi=-1,                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                            
Net_Sale_Expo_Multi=-1,                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),        
-----old logic----        
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,        
----new logic---        
dummy='',      
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                    
from #file2                                             
--where party_code='A10656'        
) A ORDER BY PARTY_cODE,RECTYPE                                          
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79_test1(@location as varchar(50),@odinserver as varchar(50))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
  
SELECT * into #file_1 FROM CLIENT_MAST79_test1  
  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                 
  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null          
          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                
                        
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
                       
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----test                          
--update #file2 set max_limit=-1 where party_code='n3417'                        
--select * from #file2  where party_code='A780'                  
                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
                    
-------                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                          
                          
--update #file2 set deposit=EFF_DEPOSIT                          
                          
---                  
              
              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
              
------old log                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
  
  
   
       
        
          
             
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                        
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                  
                                    
SELECT * FROM                                  
(                                  
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',         
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                                     
                                  
UNION                                  
                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                            
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                     
) A ORDER BY PARTY_cODE,RECTYPE                                  
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79NEW
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79NEW(@location as varchar(50),@odinserver as varchar(50))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'
  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                 
  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null          
          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                
                        
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
                       
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----test                          
--update #file2 set max_limit=-1 where party_code='n3417'                        
--select * from #file2  where party_code='A780'                  
                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
                    
-------                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                          
                          
--update #file2 set deposit=EFF_DEPOSIT                          
                          
---                  
              
              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
              
------old log                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
  
  
   
       
        
          
             
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                        
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                                  
                                    
SELECT * FROM                                  
(                                  
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',         
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                                     
                                  
UNION                                  
                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                            
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                     
) A ORDER BY PARTY_cODE,RECTYPE                                  
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79NEW_GElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79NEW_GElimit(@location as varchar(50),@odinserver as varchar(50))                                            
as                                            
                                            
set transaction isolation level read uncommitted                                            
set nocount on                                            
    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'  
    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                   
    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
                       
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null            
            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                    
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                    
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                  
                          
                                    
SELECT                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                
GROSS_EXP=CONVERT(MONEY,0),                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                            
                         
ALLOWED_DEBIT,GOODWILL,                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                
HOLDING,                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                    
INTO #FILE2                                                
FROM #file1 a left outer join                                                
RISK.DBO.collection_client_details b                                                
on a.party_code=b.party_code                                    
                                    
                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                    
                                    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                    
----test                            
--update #file2 set max_limit=-1 where party_code='n3417'                          
--select * from #file2  where party_code='A780'                    
                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                
                      
-------                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                             
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                            
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                            
                            
--update #file2 set deposit=EFF_DEPOSIT                            
                            
---                    
                
                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                    
                
------old log                                    
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                    
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                     
                                    
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                          
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                     
                                    
                                      
SELECT * FROM                                    
(                                    
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
----old logic  
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic  
Gross_Expo_Mult=-1,GE_Limit=-1,  

Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
--old logic---  
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---  
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),  

Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                      
from #file2                                       
                                    
UNION                                    
                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',
---old logic----  
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),
---new logic  
Gross_Expo_Mult=-1,GE_Limit=-1,  

Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),
-----old logic----  
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,
----new logic---  
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,  

Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                       
) A ORDER BY PARTY_cODE,RECTYPE                                    
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79NEW1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79NEW1(@location as varchar(50),@odinserver as varchar(50))                                            
as                                            
                                            
set transaction isolation level read uncommitted                                            
set nocount on                                            
    
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S2'  
    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                   
    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
                       
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null            
            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                    
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                    
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                  
                          
                                    
SELECT                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                
GROSS_EXP=CONVERT(MONEY,0),                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                            
                         
ALLOWED_DEBIT,GOODWILL,                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                
HOLDING,                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                    
INTO #FILE2                                                
FROM #file1 a left outer join                                                
RISK.DBO.collection_client_details b                                                
on a.party_code=b.party_code                                    
                                    
                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                    
                                    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                    
----test                            
--update #file2 set max_limit=-1 where party_code='n3417'                          
--select * from #file2  where party_code='A780'                    
                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                
                      
-------                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                             
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                            
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                            
                            
--update #file2 set deposit=EFF_DEPOSIT                            
                            
---                    
                
                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                    
                
------old log                                    
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                    
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                     
                                    
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
    
    
     
         
          
            
               
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                          
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                     
                                    
                                      
SELECT * FROM                                    
(                                    
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                       
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',           
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                      
from #file2                                       
                                    
UNION                                    
                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                              
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                              
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                       
) A ORDER BY PARTY_cODE,RECTYPE                                    
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S1_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S1_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79              
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'acm' AND ODIN_SERVER='odin79'  and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null                      
                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                            
                                    
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
                                   
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                      
WHERE #file2.PARTY_CODE=B.CLCODE                  
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                           
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                              
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              
----test                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                    
--select * from #file2  where party_code='A780'                              
                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
  
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \  
commented by manesh on 22/10/2007  
*/  
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
    
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                              
-------                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                       
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                      
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                      
                                      
--update #file2 set deposit=EFF_DEPOSIT                                      
                                      
---                              
                          
                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
------old log                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                               
                                              
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
     
     
         
          
            
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                               
                                              
                                                
SELECT * FROM                                              
(                                              
select rectype='1',party_code,brcode,            
cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
----old logic            
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
--old logic---            
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---            
dummy='',          
---old logic            
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                
---new logic            
MTM_Limit_in_000=cast(limit_multi as int),            
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                    
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                
from #file2                     
---where party_code='A10656'            
                                      
UNION                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
---old logic----            
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
-----old logic----            
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---            
dummy='',          
---old logic            
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                
---new logic            
MTM_Limit_in_000=cast(limit_multi as int),            
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                    
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                     
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                        
from #file2                                                 
--where party_code='A10656'            
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S1_MElimit_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S1_MElimit_test1(@location as varchar(50),@odinserver as varchar(50))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
              
SELECT * into #file_1 FROM CLIENT_MAST79_test1              
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'acm' AND ODIN_SERVER='odin79'  and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                      
                                 
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null                      
                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                              
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                            
                                    
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                  
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                      
                                   
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                              
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                           
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                              
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                              
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              
----test                                      
--update #file2 set max_limit=-1 where party_code='n3417'                                    
--select * from #file2  where party_code='A780'                              
                              
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          


/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                                
-------                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                       
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                      
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                      
                                      
--update #file2 set deposit=EFF_DEPOSIT                                      
                                      
---                              
                          
                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                          
------old log                                              
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                               
                                              
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
     
     
         
          
            
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                    
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                               
                                              
                                                
SELECT * FROM                                              
(                                              
select rectype='1',party_code,brcode,            
cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
----old logic            
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                    
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
--old logic---            
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---            
dummy='',          
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                        
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                
from #file2                     
---where party_code='A10656'            
                                      
UNION                                              
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                        
Periodicity=17,                                              
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
---old logic----            
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                
Net_Sale_Expo_Multi=-1,                                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                   
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
-----old logic----            
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---            
dummy='',          
    
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                        
from #file2                                                 
--where party_code='A10656'            
) A ORDER BY PARTY_cODE,RECTYPE                                              
                                                   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S2_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S2_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
                                   
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                        
                        
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                              
                                      
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
                                     
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                    
WHERE #file2.PARTY_CODE=B.CLCODE                    
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
----test                                        
--update #file2 set max_limit=-1 where party_code='n3417'                                      
--select * from #file2  where party_code='A780'                                
                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            
  
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \    
commented by manesh on 22/10/2007    
*/    
  
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                            

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
                                  
-------                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                         
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                        
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                        
                                        
--update #file2 set deposit=EFF_DEPOSIT                                        
                                        
---                                
                            
                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                            
------old log                                                
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                 
                     
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
     
      
        
         
             
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                   
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                                 
                                                
                                         
SELECT * FROM                                                
(                                                
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
----old logic              
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic              
Gross_Expo_Mult=-1,GE_Limit=-1,              
            
Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
--old logic---              
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---              
dummy='',          
---old logic          
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),          
--Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),                  
---new logic          
MTM_Limit_in_000=cast(limit_multi as int),          
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                  
from #file2                                                   
                                                
UNION                                                
                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',            
---old logic----              
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),            
---new logic              
Gross_Expo_Mult=-1,GE_Limit=-1,              
            
Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),            
-----old logic----              
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---              
dummy='',          
---old logic          
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),          
--Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),                  
---new logic          
MTM_Limit_in_000=cast(limit_multi as int),          
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                  
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                          
from #file2                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S2_MElimit1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S2_MElimit1(@location as varchar(50),@odinserver as varchar(50))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                  
--SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S2'                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'  
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                          
                                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                          
                          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                
                                        
                                                  
SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                          
                                       
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                                  
                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                       
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                             
WHERE #file2.PARTY_CODE=B.CLCODE                             
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                               
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                  
                                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                  
----test                                          
--update #file2 set max_limit=-1 where party_code='n3417'                                        
--select * from #file2  where party_code='A780'                                  
                                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              


/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                              
                                    
-------                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                          
                                          
--update #file2 set deposit=EFF_DEPOSIT                                          
                                          
---                                  
                              
                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                              
------old log                                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                     
                                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
   
   
      
         
          
           
           
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                            
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                                   
                                                  
                                           
SELECT * FROM                                                  
(                                                  
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                            
Periodicity=17,                                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
----old logic                
---Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
              
Net_Expo_Multi=-1,                                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                    
Net_Sale_Expo_Multi=-1,                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
--old logic---                
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,              
----new logic---                
dummy='',            
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),        
--Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),                
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int),                
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                    
from #file2                                                     
                                                  
UNION                                                  
                                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                            
Periodicity=17,                                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
---old logic----                
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
              
Net_Expo_Multi=-1,                                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                    
Net_Sale_Expo_Multi=-1,                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
-----old logic----                
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,              
----new logic---                
dummy='',            
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),        
--Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),                
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                            
from #file2                                                     
) A ORDER BY PARTY_cODE,RECTYPE                                                  
                                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3(@location as varchar(50),@odinserver as varchar(50))                                            
as                                            
                                            
set transaction isolation level read uncommitted                                            
set nocount on                                            
    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'  
    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                   
    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null            
                       
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null            
            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                    
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                    
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                  
                          
                                    
SELECT                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                
GROSS_EXP=CONVERT(MONEY,0),                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                            
                         
ALLOWED_DEBIT,GOODWILL,                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                
HOLDING,                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                    
INTO #FILE2                                                
FROM #file1 a left outer join                                                
RISK.DBO.collection_client_details b                                                
on a.party_code=b.party_code                                    
                                    
                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                    
                                    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                    
----test                            
--update #file2 set max_limit=-1 where party_code='n3417'                          
--select * from #file2  where party_code='A780'                    
                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                
                      
-------                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                             
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                            
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                            
                            
--update #file2 set deposit=EFF_DEPOSIT                            
                            
---                    
                
                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                    
                
------old log                                    
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                    
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                     
                                    
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
            
               
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                          
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                     
                                    
                                      
SELECT * FROM                                    
(                                    
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                       
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',           
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                      
from #file2                                       
                                    
UNION                                    
                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                              
Periodicity=17,                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                              
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                      
Net_Sale_Expo_Multi=-1,                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                              
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                              
from #file2                                       
) A ORDER BY PARTY_cODE,RECTYPE                                    
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_GElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_GElimit(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                
                
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                      
                              
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
                             
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                        
----test                                
--update #file2 set max_limit=-1 where party_code='n3417'                              
--select * from #file2  where party_code='A780'                        
                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
-------                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                
                                
--update #file2 set deposit=EFF_DEPOSIT                                
                                
---                        
                    
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
------old log                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
                                        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
    
                
                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                         
                                        
                                          
SELECT * FROM                                        
(             
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',  
----old logic    
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),  
---new logic    
Gross_Expo_Mult=-1,GE_Limit=-1,    
Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),  
--old logic---    
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,    
----new logic---  
dummy='',  
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int),    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
                                        
UNION                                        
                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',  
---old logic----    
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),  
---new logic    
Gross_Expo_Mult=-1,GE_Limit=-1,    
Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),  
-----old logic----    
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,  
----new logic---    
dummy='',
MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_MElimit
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_MElimit(@location as varchar(50),@odinserver as varchar(50))                                                            
as                                                            
                                                            
set transaction isolation level read uncommitted                                                            
set nocount on                                                            
                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'                  
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                            
                                       
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                            
                            
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                    
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                    
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                  
                                          
                                                    
SELECT                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                        
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
                                         
ALLOWED_DEBIT,GOODWILL,                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                
HOLDING,                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                    
INTO #FILE2                                                                
FROM #file1 a left outer join                                                                
RISK.DBO.collection_client_details b                                                                
on a.party_code=b.party_code                                                    
                                                    
                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                        
WHERE #file2.PARTY_CODE=B.CLCODE                        
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                    
                                                    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                    
----*****test on 05/11/2007                        
---logic for credit bal    
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                   
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                  
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                              
----test                                            
--update #file2 set max_limit=-1 where party_code='n3417'                                          
--select * from #file2  where party_code='A780'     
    
---logic for debit bal    
--select * from #file2  where debit_value>0 and debit_value>appr     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr  ----1432      
    
--select * from #file2  where debit_value>0 and debit_value<appr     
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                               
                       
--update #file2 set max_limit=-1 where party_code='n3417'                                          
--select * from #file2  where party_code='A780'                                    
                                    
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                
      
      
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \        
commented by manesh on 22/10/2007        
*/        
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
  
  
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */        
update #file2  set eff_Deposit=debit_value*-1   
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0  
  
-------                                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                             
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                            
                                            
--update #file2 set deposit=EFF_DEPOSIT                                            
                                            
---                                    
                                
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                    
                                
------old log                                                    
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                    
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                    
                                                    
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                   
          
            
              
                
                            
                               
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                          
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                       
                                                    
                                                      
SELECT * FROM                                                    
(                         
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                              
Periodicity=17,                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
----old logic                
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
Net_Expo_Multi=-1,                                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                      
Net_Sale_Expo_Multi=-1,                                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                          
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
--old logic---                
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                
----new logic---              
dummy='',              
---old logic                
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                    
---new logic                
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                              
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1              
from #file2                                                       
                                                    
UNION                                                    
                                                    
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                              
Periodicity=17,                                                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',              
---old logic----                
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),              
---new logic                
Gross_Expo_Mult=-1,GE_Limit=-1,                
Net_Expo_Multi=-1,                                                      
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                      
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                      
Net_Sale_Expo_Multi=-1,                                                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                         
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),        
-----old logic----                
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,              
----new logic---                
dummy='',            
---old logic                
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                    
---new logic                
MTM_Limit_in_000=cast(limit_multi as int),                
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                        
        
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                           
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                              
from #file2                                                       
) A ORDER BY PARTY_cODE,RECTYPE                                                    
                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_MElimit_test
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_MElimit_test(@location as varchar(50),@odinserver as varchar(50))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'                        
                          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                         
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                                  
                                             
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                                  
                                  
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                          
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                          
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                                        
                                                
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
                                               
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                              
WHERE #file2.PARTY_CODE=B.CLCODE                              
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                                          
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                         
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0          
    
/******  
---******new logic applied from 02/11/2007 for credit bal     
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                     
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0          
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                                
    
    
----*****new logic apllied from 02/11/2007 for debit bal      
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end) WHERE debit_value>0 and debit_value>appr        
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                                 
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                                 
                                                                     
----*****test on 05/11/2007                              
---logic for credit bal          
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                         
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                        
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                                    
----test                                         
--update #file2 set max_limit=-1 where party_code='n3417'                                                
--select * from #file2  where party_code='A780'           
          
---logic for debit bal          
--select * from #file2  where debit_value>0 and debit_value>appr           
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr  ----1432            
          
--select * from #file2  where debit_value>0 and debit_value<appr           
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                                     
                             
--update #file2 set max_limit=-1 where party_code='n3417'                                                
--select * from #file2  where party_code='A780'                                          
*********/    
                                          
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
            
            
/* based on the request from ritul dated : 18/10/2007 to display deposits with -ve values. the below statement is \              
commented by manesh on 22/10/2007              
*/              
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                                      
        
        
/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */              
update #file2  set eff_Deposit=debit_value*-1         
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0        
        
-------                                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                   
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                  
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                                  
                                                  
--update #file2 set deposit=EFF_DEPOSIT                                                  
                                                  
---                                          
                                      
                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                          
                                      
------old log                                                          
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                          
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                          
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                          
                                                          
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
                
                  
                    
                      
                                  
                                     
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                                
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                             
                                                          
                                                            
SELECT * FROM                                                          
(                               
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
----old logic                      
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),                    
--old logic---                      
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,                      
----new logic---                    
dummy='',                    
---old logic                      
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                          
---new logic                      
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                    
from #file2                                                             
                                                          
UNION                                                          
                                                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                                    
Periodicity=17,                                                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',                    
---old logic----                      
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),                    
---new logic                      
Gross_Expo_Mult=-1,GE_Limit=-1,                      
Net_Expo_Multi=-1,                                                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                            
Net_Sale_Expo_Multi=-1,                                                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),              
-----old logic----                      
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,                    
----new logic---                      
dummy='',                  
---old logic                      
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,                          
---new logic                      
MTM_Limit_in_000=cast(limit_multi as int),                      
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                              
              
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                                    
from #file2                                                             
) A ORDER BY PARTY_cODE,RECTYPE                                                          
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_MElimit_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_MElimit_test1(@location as varchar(50),@odinserver as varchar(50))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S3'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                        
                                   
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                        
                        
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                                
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                              
                                      
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
                                     
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                
WHERE #file2.PARTY_CODE=B.CLCODE                                
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                                
----test                                        
--update #file2 set max_limit=-1 where party_code='n3417'                                      
--select * from #file2  where party_code='A780'                                
                                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            

/* based on the request from ritul dated : 07/11/2007 to display deposit = Debit balance in case Debit balance is less then holding */      
update #file2  set eff_Deposit=debit_value*-1 
where appr < debit_value and converT(money,debit_value) <> eff_deposit*-1 and debit_value > 0
--Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
                                  
-------                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                         
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                        
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                        
                                        
--update #file2 set deposit=EFF_DEPOSIT                                        
                                        
---                                
                            
                            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                            
------old log                                                
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                 
                                                
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
  
      
        
          
            
                        
                           
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                                      
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                   
                                                
                                                  
SELECT * FROM                                                
(                     
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',          
----old logic            
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),          
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),          
--old logic---            
---MTM_Limit_in_000='',Margin_Limit_Multi=-1,            
----new logic---          
dummy='',          
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                  
from #file2                                                   
                                                
UNION                                                
                                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                          
Periodicity=17,                                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',          
---old logic----            
--Gross_Expo_Mult=cast(limit_multi as int),GE_Limit=cast(gross_exp as int),          
---new logic            
Gross_Expo_Mult=-1,GE_Limit=-1,            
Net_Expo_Multi=-1,                                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                                  
Net_Sale_Expo_Multi=-1,                                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),          
-----old logic----            
----MTM_Limit_in_000='',Margin_Limit_Multi=-1,          
----new logic---            
dummy='',        
---old logic        
--MTM_Limit_in_000=cast(limit_multi/5 as decimal(5,1)),Margin_Limit_Multi=cast((limit_multi/5)*eff_deposit as int) ,            
---new logic        
MTM_Limit_in_000=cast(limit_multi as int),        
Margin_Limit_Multi=cast((limit_multi*eff_deposit) as int) ,                
    
Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,Retain_Multi=0,                                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0,Include_Exposure_Margin=1                                                          
from #file2                                                   
) A ORDER BY PARTY_cODE,RECTYPE                                                
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_test
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_test(@location as varchar(50),@odinserver as varchar(50))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
        
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'      
        
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                       
        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null                
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='ODIN79S3'  and flag is null                
  
                           
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null                
                
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                        
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                      
                              
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                            
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
                             
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),dummy1                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                     
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0                                        
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                              
  

/*                 
---******new logic applied from 02/11/2007 for credit bal   
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                   
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0        
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                              
  
  
----*****new logic apllied from 02/11/2007 for debit bal    
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end) WHERE debit_value>0 and debit_value>appr      
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                               
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                               
*/  
                                  
----test                                
--update #file2 set max_limit=-1 where party_code='n3417'                              
--select * from #file2  where party_code='A780'                        
                        
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                    
                          
-------                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                 
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                
                                
--update #file2 set deposit=EFF_DEPOSIT                   
                                
---                        
                    
                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                    
------old log                                        
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
                                        
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
   
    
                
                   
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                         
                                        
                                          
SELECT * FROM                                        
(                                        
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                    
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                           
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                              
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',               
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                  
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                           
                                        
UNION                                        
                                        
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                  
Periodicity=17,                                        
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                  
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                          
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                          
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                          
Net_Sale_Expo_Multi=-1,                                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                             
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                 
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                               
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                  
from #file2                                           
) A ORDER BY PARTY_cODE,RECTYPE                                        
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_79S3_test1
-- --------------------------------------------------
CREATE procedure rpt_limit_file_79S3_test1(@location as varchar(50),@odinserver as varchar(50))                                              
as                                              
                                              
set transaction isolation level read uncommitted                                              
set nocount on                                              
      
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S3'    
      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                     
      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null              
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null              
                         
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79S2' and flag is null              
              
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                      
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                      
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                    
                            
                                      
SELECT                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                          
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                                  
GROSS_EXP=CONVERT(MONEY,0),                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                              
                           
ALLOWED_DEBIT,GOODWILL,                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                  
HOLDING,                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                      
INTO #FILE2                                                  
FROM #file1 a left outer join                                                  
RISK.DBO.collection_client_details b                                                  
on a.party_code=b.party_code                                      
                                      
                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                      
                                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                      
----test                              
--update #file2 set max_limit=-1 where party_code='n3417'                            
--select * from #file2  where party_code='A780'                      
                      
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                  
                        
-------                      
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                               
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                              
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                              
                              
--update #file2 set deposit=EFF_DEPOSIT                              
                              
---                      
                  
                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                      
                  
------old log                                      
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                      
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                       
                                      
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
              
                 
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                            
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                       
                                      
                                        
SELECT * FROM                                      
(                                      
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                
Periodicity=17,                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                         
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                        
Net_Sale_Expo_Multi=-1,                                        
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                            
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',             
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                                
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                        
from #file2                                         
                                      
UNION                                      
                                      
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                                
Periodicity=17,                                      
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                                
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                        
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                        
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                        
Net_Sale_Expo_Multi=-1,                                                
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                           
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                                
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                             
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                                
from #file2                                         
) A ORDER BY PARTY_cODE,RECTYPE                                      
                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file_CTCL
-- --------------------------------------------------
CREATE procedure rpt_limit_file_CTCL (@location as varchar(50),@odinserver as varchar(50))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
  
select brcode=d.sbtag,sbcode=d.subgroup,a.party_Code,party_name=a.partyname,limit_multi=lmtmulti,max_limit=maxlimit,min_limit=minlimit,mtm_limit=mtmlimit,  
allowed_debit=drallowed,location=a.branch_cd,odin_server='odin79',dummy1=' ',dummy2=0,goodwill=-1,flag=null  
into #file_1   
from mis.dbo.ctcl_client_79 A,   
mis.dbo.BrCTCLLimitMaster C,  
RISK.DBO.FINMAST D  
WHERE  
A.PARTY_CODE=D.PARTY_CODE  
AND D.SBTAG = c.branch_Cd  
AND a.branch_cd=@location  
--and a.party_Code in ('H5555','A12222','H331','V613','D4674','P11000','N8384','H6162','BC35')  
  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                 
  
--SELECT * into #file1 FROM #file_1 WHERE brcode like 'NCG' AND ODIN_SERVER='odin79' and flag is null          
--SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
SELECT * into #file1 FROM #file_1 WHERE ODIN_SERVER=@odinserver  and flag is null          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null          
                     
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79' and flag is null          
          
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                  
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                                
                        
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                      
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
                       
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
/*                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
*/                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                                  
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                  
----test                          
--update #file2 set max_limit=-1 where party_code='n3417'                        
--select * from #file2  where party_code='A780'                  
                  
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
                    
-------                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                           
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                          
                          
--update #file2 set deposit=EFF_DEPOSIT                          
                          
---                  
              
              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
              
------old log                                  
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
                                  
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                         
   
  
  
  
   
       
        
          
             
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                        
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                   
                         
                                    
SELECT * FROM                                  
(                                  
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                        
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',         
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                            
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                                     
                                  
UNION                                  
                                  
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                            
Periodicity=17,                                  
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                            
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                    
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                    
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                    
Net_Sale_Expo_Multi=-1,                                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                       
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                            
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1=-1,t2=-1,Retain_Multi=0,                                         
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                            
from #file2                                     
) A ORDER BY PARTY_cODE,RECTYPE                                  
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file1
-- --------------------------------------------------
CREATE procedure rpt_limit_file1(@location as varchar(50),@odinserver as varchar(50))                                    
as                                    
                                    
set transaction isolation level read uncommitted                                    
set nocount on                                    
                          
SELECT * into #file1 FROM CLIENT_MAST79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null    
                  
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like 'delhi' AND ODIN_SERVER='odin6' and flag is null    
    
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                            
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                            
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                          
                  
----all segment Detail                            
SELECT                                        
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                        
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                        
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                        
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                        
GROSS_EXP=CONVERT(MONEY,0),                                
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                    
                 
ALLOWED_DEBIT,GOODWILL,                                        
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                        
HOLDING,                            
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                            
INTO #FILE2                                        
FROM #file1 a left outer join                                        
RISK.DBO.collection_client_details b                                        
on a.party_code=b.party_code                            
                            
----Fo holding detail                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                            
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                        
                                        
---ncdx holding detail                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                        
                        
----mcx holding details                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                            
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                        
WHERE #file2.PARTY_CODE=B.CLCODE                                        
                            
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                            
                            
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                            
----test                    
--update #file2 set max_limit=-1 where party_code='n3417'                  
--select * from #file2  where party_code='A780'            
            
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                        
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0          
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0        
Update #file2 SET eff_deposit=0 Where eff_deposit<0        
              
-------            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                      
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                     
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                    
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                    
                    
--update #file2 set deposit=EFF_DEPOSIT                    
                    
---            
        
        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                            
        
------old log                            
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                            
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                            
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                            
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                             
                            
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
  
  
    
       
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                  
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                             
                            
                              
SELECT * FROM                            
(                            
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                      
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                      
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                              
Net_Sale_Expo_Multi=-1,                              
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                  
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                      
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                      
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                      
from #file2                               
                            
UNION                            
                            
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                      
Periodicity=17,                            
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                      
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                              
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                              
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                              
Net_Sale_Expo_Multi=-1,                                      
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                 
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                      
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                   
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                      
from #file2                               
) A ORDER BY PARTY_cODE,RECTYPE                            
                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_file79
-- --------------------------------------------------
CREATE procedure rpt_limit_file79(@location as varchar(50),@odinserver as varchar(50))                                        
as                                        
                                        
set transaction isolation level read uncommitted                                        
set nocount on                                        
                              
--SELECT * into #file1 FROM climast_testing WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null        
SELECT * into #file1 FROM CLIENT_MAST79 WHERE brcode like @location AND ODIN_SERVER=@odinserver  and flag is null        
                      
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like 'delhi' AND ODIN_SERVER='odin6' and flag is null        
        
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver                                
--UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                
--UPDATE #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'                              
                      
                                
SELECT                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),                    
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                            
GROSS_EXP=CONVERT(MONEY,0),                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                        
                     
ALLOWED_DEBIT,GOODWILL,                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                            
HOLDING,                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                
INTO #FILE2                                            
FROM #file1 a left outer join                                            
RISK.DBO.collection_client_details b                                            
on a.party_code=b.party_code                                
                                
                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                            
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                
                                
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                
----test                        
--update #file2 set max_limit=-1 where party_code='n3417'                      
--select * from #file2  where party_code='A780'                
                
update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0            
Update #file2 SET eff_deposit=0 Where eff_deposit<0            
                  
-------                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                          
--update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                         
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                        
--update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                        
                        
--update #file2 set deposit=EFF_DEPOSIT                        
                        
---                
            
            
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                
            
------old log                                
---UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                
---UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                 
                                
--select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(3,2))as MTM_limit,cast(min_limit as int)as min_limit,                          
 
     
      
        
           
--cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                      
--cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                                                 
                                
                                  
SELECT * FROM                                
(                                
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                          
Periodicity=17,                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                  
Net_Sale_Expo_Multi=-1,                                  
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                      
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',       
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1='',t2='',Retain_Multi=0,                                          
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                  
from #file2                                   
                                
UNION                                
                                
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                          
Periodicity=17,                                
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                          
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                                  
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                                  
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                                  
Net_Sale_Expo_Multi=-1,                                          
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                     
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                          
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,t1='',t2='',Retain_Multi=0,                                       
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                          
from #file2                                   
) A ORDER BY PARTY_cODE,RECTYPE                                
                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_limit_trfile
-- --------------------------------------------------
CREATE procedure rpt_limit_trfile(@location as varchar(50))                                  
as                                  
                                  
set transaction isolation level read uncommitted                                  
set nocount on                                  
                        

SELECT * into #file1 FROM client_trmast WHERE brcode like @location and flag is null  
--AND ODIN_SERVER=@odinserver  

--SELECT * into #file1 FROM client_trmast WHERE brcode like '%'  and flag is null
--AND ODIN_SERVER='tradeanywhere'  


---For All segment detail
SELECT                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),              
EFF_DEPOSIT=convert(money,0),LIMIT_MULTI,                                      
GROSS_EXP=CONVERT(MONEY,0),                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                  
ALLOWED_DEBIT,GOODWILL,                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                      
HOLDING,APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                          
INTO #FILE2                                      
FROM #file1 a left outer join                                      
RISK.DBO.collection_client_details b                                      
on a.party_code=b.party_code                          

---For FO Holding details
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                      

----(not applicatble to ncdx,mcx)

UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)

---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                          

update #file2 set EFF_DEPOSIT=deposit       update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1       
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1       
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0      
Update #file2 SET eff_deposit=0 Where eff_deposit<0      

UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                          


SELECT * FROM                          
(                          
select rectype='1',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                    
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                    
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                            
Net_Sale_Expo_Multi=-1,                            
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,                                
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                    
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                    
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                             
                          
UNION                          
                          
select rectype='2',party_code,brcode,cast(eff_deposit as int)as deposit,Code='',Symbol='',Series='',XGroup='',                                    
Periodicity=17,                          
Instrument_Name='',Expiry='',Strike_Price='',Option_Type='',Gross_Expo_Mult=cast(limit_multi as int),                                    
GE_Limit=cast(gross_exp as int),Net_Expo_Multi=-1,                            
--Net_Purchase_Premium=(case when limit_multi =2 then 0 else -1 end),                            
Net_Purchase_Premium=(case when (debit_value > 0 and holding > 0) then 0 else -1 end),                            
Net_Sale_Expo_Multi=-1,                                    
NSE_Write_Limit=-1,Net_Pos_Multi=-1,NP_Limit=-1,Turnover_Multi=-1,TurnOver_Limit=-1,               
Pending_Order_Multi=-1,Pending_Order_Limit=-1,MTM_Loss_Multi=cast(mtm_limit as decimal(5,3)),MTM_Limit_in_000='',                                    
Margin_Limit_Multi=-1,Margin_Limit=-1,NQ_Limit=-1,Max_Order_Value=-1,Max_Order_Qty=-1,Retain_Multi=0,                                 
Inclu_MTMP=1,Inclu_Net_Premium=0,Gross_Net=0                                    
from #file2                             
) A ORDER BY PARTY_cODE,RECTYPE                          
                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sb_dealposition
-- --------------------------------------------------

CREATE procedure sb_dealposition (@location as varchar(50),@odinserver as varchar(50),@search as varchar(10),@sbcode as varchar(10))                                              
as                                              
                                              
set transaction isolation level read uncommitted                                              
set nocount on                                              
                                    
                                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10),@sbcode as varchar(10)                                    
set @location='acm'                                    
set @odinserver='odin7'                                    
set @search = ''                    
set @sbcode ='acm'                            
*/                              
                         
               
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'                                      
                
SELECT * into #file1 FROM DEALER_MAST WHERE LOCATION like @location AND ODIN_SERVER like @odinserver and party_code like @search+'%'                           
and party_code in (select party_Code from risk.dbo.finmast where subgroup=@sbcode)              
                              
--select * from #file1                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                      
                                      
SELECT                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                  
GROSS_EXP=CONVERT(MONEY,0),                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                
EFF_DEPOSIT=convert(money,0)                    ,                                                  
ALLOWED_DEBIT,GOODWILL,                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                  
HOLDING,                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                      
INTO #FILE2                                                  
FROM #file1 a left outer join                                                  
RISK.DBO.collection_client_details b                                                  
on a.party_code=b.party_code                                      
                                      
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b             
WHERE #file2.PARTY_CODE=B.CLCODE                                                  
                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                      
                                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                           
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                    
----test                                
--drop table #file2                             
--select * from #file2                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                             
                    
update #file2 set EFF_DEPOSIT=deposit                     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                  
                                
--update #file2 set deposit=EFF_DEPOSIT                                  
---                                        
                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                      
                              
---old logic                                      
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                      
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                         
------                              
                                                  
--select * from #file2           
          
                                                 
-- -- select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as                          
-- --  min_limit,                                            
-- -- cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                            
-- -- cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit from  #file2 where deposit <= 0 ORDER BY PARTY_CODE                                                       
    
    
select a.brcode,a.sbcode,a.party_code,a.party_name,    
cast(a.deposit as int)as deposit,    
cast(a.limit_multi as int)as limit_multi,    
cast(a.gross_exp as int)as gross_exp,    
cast(a.MTM_limit as decimal(5,2))as MTM_limit,    
cast(a.min_limit as int)as min_limit,                                          
cast(a.max_limit as int)as max_limit,    
cast(a.allowed_debit as int)as allowed_debit,    
cast(a.goodwill as int)as goodwill,    
cast(a.debit_value as int)as debit_value,                                          
cast(a.holding as int)as holding,    
cast(a.eff_deposit as int)as eff_deposit,    
b.exposure,b.date_of_sub from  #file2 as a left outer join sbexposure  as b on ltrim(rtrim(a.party_code)) = ltrim(rtrim(b.clientcode))     
AND Convert(Varchar(8),Convert(datetime,date_of_sub),112) = Convert(Varchar(8), getdate(), 112) 
where deposit <= 0 ORDER BY PARTY_CODE                                                     
    
                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sb_dealposition2
-- --------------------------------------------------
CREATE procedure sb_dealposition2 (@location as varchar(50),@odinserver as varchar(50),@search as varchar(10),@sbcode as varchar(10))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
                                      
                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10),@sbcode as varchar(10)                                      
set @location='acm'                                      
set @odinserver='odin7'                                      
set @search = ''                      
set @sbcode ='acm'                              
*/                                
                           
                 
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'                                        
                  
SELECT * into #file1 FROM DEALER_MAST WHERE LOCATION like @location AND ODIN_SERVER like @odinserver and party_code like @search+'%'                             
and party_code in (select party_Code from risk.dbo.finmast where subgroup=@sbcode)                
                                
--select * from #file1                                
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                    
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
       
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b               
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                           
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                        
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                      
----test                                  
--drop table #file2                               
--select * from #file2                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                               
                      
update #file2 set EFF_DEPOSIT=deposit                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
                                  
--update #file2 set deposit=EFF_DEPOSIT                                    
---                                          
                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                                
---old logic                                        
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
------                                
                                                    
--select * from #file2             
            
                                                   
-- -- select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as                            
-- --  min_limit,                                              
-- -- cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                                              
-- -- cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit from  #file2 where deposit <= 0 ORDER BY PARTY_CODE                                                         
      
      
select a.brcode,a.sbcode,a.party_code,a.party_name,      
cast(a.deposit as int)as deposit,      
cast(a.limit_multi as int)as limit_multi,      
cast(a.gross_exp as int)as gross_exp,      
cast(a.MTM_limit as decimal(5,2))as MTM_limit,      
cast(a.min_limit as int)as min_limit,                                            
cast(a.max_limit as int)as max_limit,      
cast(a.allowed_debit as int)as allowed_debit,      
cast(a.goodwill as int)as goodwill,      
cast(a.debit_value as int)as debit_value,                                            
cast(a.holding as int)as holding,      
cast(a.eff_deposit as int)as eff_deposit,      
b.exposure,b.date_of_sub from  #file2 as a left outer join sbexposure  as b on ltrim(rtrim(a.party_code)) = ltrim(rtrim(b.clientcode))       
-- AND Convert(Varchar(8),Convert(datetime,date_of_sub),112) = Convert(Varchar(8), getdate(), 112)   
where deposit <= 0 ORDER BY PARTY_CODE                                                       
      
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.search_dealposition
-- --------------------------------------------------
CREATE procedure search_dealposition (@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                              
as                              
                              
set transaction isolation level read uncommitted                              
set nocount on                              
                    
                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                    
set @location='acm'                    
set @odinserver='odin6'                    
set @search = ''                    
  */               
              
              
--SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'                      

SELECT * into #file1 FROM DEALER_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'           
              
--select * from #file1              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                      
                      
SELECT                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                  
GROSS_EXP=CONVERT(MONEY,0),                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                
EFF_DEPOSIT=convert(money,0)                    ,                                  
ALLOWED_DEBIT,GOODWILL,                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                  
HOLDING,                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                      
INTO #FILE2                                  
FROM #file1 a left outer join                                  
RISK.DBO.collection_client_details b                                  
on a.party_code=b.party_code                      
                      
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                  
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                  
                      
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                      
                      
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0           
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                    
----test                
--drop table #file2             
--select * from #file2                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1            
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1             
    
update #file2 set EFF_DEPOSIT=deposit     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0  
                
--update #file2 set deposit=EFF_DEPOSIT                  
---                        
                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                      
              
---old logic                      
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                      
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                         
------              
                                  
--select * from #file2                                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as          
 min_limit,                            
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                            
cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                       
                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.seg_allocation
-- --------------------------------------------------

create proc seg_allocation
as
set nocount on

select party_code,brokerage=sum(brokerage)   
into #BSE_BR
from  bsedb_ab.dbo.mis_to where company='ablcm'
and sauda_date>=getdate()-60 AND SAUDA_DATE<=GETDATE()
and party_code collate Latin1_General_CI_AS in (select party_code from  client_mast )
group by party_code,company

select party_code,brokerage=sum(brokerage)   
into #NSE_BR
from  bsedb_ab.dbo.mis_to where company='acdlcm'
and sauda_date>=getdate()-60 AND SAUDA_DATE<=GETDATE()
--and party_code='S8884'
and party_code collate Latin1_General_CI_AS in (select party_code from  client_mast )
group by party_code,company

select party_code,brokerage=sum(brokerage)   
into #FO_BR
from  bsedb_ab.dbo.mis_to where company='acdlfo'
and sauda_date>=getdate()-60 AND SAUDA_DATE<=GETDATE()
--and party_code='S8884'
and party_code collate Latin1_General_CI_AS in (select party_code from  client_mast )
group by party_code,company

select party_code,brokerage=sum(brokerage)   
into #MCX_BR
from  bsedb_ab.dbo.mis_to where company='ACPLMCX'
and sauda_date>=getdate()-60 AND SAUDA_DATE<=GETDATE()
--and party_code='S8884'
and party_code collate Latin1_General_CI_AS in (select party_code from  client_mast )
group by party_code,company


select party_code,brokerage=sum(brokerage)   
into #NCDX_BR
from  bsedb_ab.dbo.mis_to where company='ACPLNCDEX'
and sauda_date>=getdate()-60 AND SAUDA_DATE<=GETDATE()
--and party_code='S8884'
and party_code collate Latin1_General_CI_AS in (select party_code from  client_mast )
group by party_code,company


select party_Code,bse_br=max(bse_br),nse_br=max(nse_br),  
fo_br=max(fo_br),ncdx_br=max(ncdx_br),  
mcdx_br=max(mcdx_br)  
--into #TO_BR   
from   
(  
select party_Code,BSE_BR=brokerage,NSE_BR=0,FO_BR=0,NCDX_BR=0,MCDX_BR=0 from #bse_br 
union  
select party_Code,BSE_BR=0,NSE_BR=brokerage,FO_BR=0,NCDX_BR=0,MCDX_BR=0 from #Nse_br  
union  
select party_Code,BSE_BR=0,NSE_BR=0,FO_BR=brokerage,NCDX_BR=0,MCDX_BR=0 from #FO_br 
union  
select party_Code,BSE_BR=0,NSE_BR=0,FO_BR=0,NCDX_BR=brokerage,MCDX_BR=0 from #ncdx_br
union  
select party_Code,BSE_BR=0,NSE_BR=0,FO_BR=0,NCDX_BR=0,MCDX_BR=brokerage from #mcx_br
) a   
group by party_Code  

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_SysObj
-- --------------------------------------------------
/*  
Author :- Prashant  
Date :- 28/01/2011  
*/  
CREATE Procedure Sp_SysObj  
(  
 @objName as varchar(20),  
 @objType as varchar(3)=''  
)  
as  
Begin  
 select * from sysobjects where name like '%'+@objName+'%' and type like '%'+@objType+'%'--'%batch%'  
 order by name,type  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spBran
-- --------------------------------------------------
Create Proc spBran  
as  
set nocount on   
select distinct branch_name   
INTO #BRAN  
from intranet.ctcl.dbo.mfipo_login   
where branch_name <>'null'   
and branch_name in   
(select branch from branch_master)  
  
sELECT *,rEPLACE(bRANCH_NAME,' ','%20') AS 'BRAN' FROM #braN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.spODINDietExchangeSubmissionReport_JP
-- --------------------------------------------------
CREATE proc [dbo].[spODINDietExchangeSubmissionReport_JP] @FileName as Varchar(20)
as  
set nocount on
  
-- Delete from nsecashtrade where tdate like '%Feb 2007%'  
-- select * from ctt  
-- truncate Table ctt  

-- update ctt set dummy1 = '19_06002.txt'  
update ctt set dummy1 = @FileName
  
delete from ctt where userid not in ('8895','11452','19436','3288')  
update ctt set sdate = convert(datetime,(substring(odate,4,3)+' '+substring(odate,1,2)+' '+substring(odate,8,4)),100)  
update ctt set settno = a.sett_no from (select sett_no,start_date from AngelNseCM.msajag.dbo.sett_mst where sett_type='N') a where a.start_date = ctt.sdate  
  
  
delete from nsecashtrade  where sdate = (  
select distinct sdate from ctt  
) 

insert into nsecashtrade 
select * from ctt  

truncate Table ctt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temp_cliposition
-- --------------------------------------------------
CREATE  procedure TEMP_cliposition(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                  
as                  
                  
set transaction isolation level read uncommitted                  
set nocount on                  
        
/*        
declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)        
set @location='%'        
set @odinserver='odin6'        
set @search = ''        
*/        
    
        
SELECT * into #file1 FROM CLIENT_MAST WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'    and flag is null        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE          
-------UPDATE   #FILE1 SET LIMIT_MULTI=6 WHERE BRCODE='XD'        
          
SELECT                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),    
EFF_DEPOSIT=convert(money,0),    
LIMIT_MULTI,                      
GROSS_EXP=CONVERT(MONEY,0),              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                      
ALLOWED_DEBIT,GOODWILL,                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                      
HOLDING,          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)          
INTO #FILE2                      
FROM #file1 a left outer join                      
RISK.DBO.collection_client_details b                      
on a.party_code=b.party_code          
          
                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                      
WHERE #file2.PARTY_CODE=B.CLCODE                      
                      
                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                      
WHERE #file2.PARTY_CODE=B.CLCODE                      
                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                      
WHERE #file2.PARTY_CODE=B.CLCODE                      
          
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)          
          
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0          
--UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0        
--select * from #file2          
    
----test        
--drop table #file2      
--select * from #file2        
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit        
update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1        
update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1        
        
--update #file2 set deposit=EFF_DEPOSIT          
---                
    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI          
     
--old logic         
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT          
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0          
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                     
                      
--select * from #file2                      
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(eff_deposit as int)as eff_deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as
  
 min_limit,                
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,                
cast(holding as int)as holding from #file2 ORDER BY PARTY_CODE                           
                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_cliposition1
-- --------------------------------------------------
CREATE procedure TEMP_cliposition1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                          
as                                          
                                          
set transaction isolation level read uncommitted                                          
set nocount on                                          
                                
                                
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                
set @location='acm'                                
set @odinserver='odin6'                                
set @search = ''                                
  */                           
      
SELECT * into #file1 FROM CLIENT_MAST79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null      
            
--select * from #file1  where party_code='d6207'                        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                  
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                
                                  
SELECT                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                              
GROSS_EXP=CONVERT(MONEY,0),                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                            
EFF_DEPOSIT=convert(money,0)                    ,                                              
ALLOWED_DEBIT,GOODWILL,                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                              
HOLDING,                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                  
INTO #FILE2                                              
FROM #file1 a left outer join                                              
RISK.DBO.collection_client_details b                                              
on a.party_code=b.party_code                                  
                                  
--select * from #file2  where party_code='d6207'                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                              
                                  
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                  
                             
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                       
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                
----test                            
--drop table #file2                         
--select * from #file2                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                        
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                            
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                            
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                         
                
update #file2 set EFF_DEPOSIT=deposit                 
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0              
Update #file2 SET eff_deposit=0 Where eff_deposit<0            
--update #file2 set deposit=EFF_DEPOSIT                              
---                                    
                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                  
                          
---old logic                                  
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                     
------                          
                                              
--select * from #file2                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,            
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                        
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,            
cast(debit_value as int)as debit_value,                                        
---old logic include approved +non-approved holding
--cast(holding as int)as holding,
---old logic include only approved  holding
cast(Appr as int)as holding,
cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                                   
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest
-- --------------------------------------------------
CREATE procedure TEMP_clipostest(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                        
as                                        
                                        
set transaction isolation level read uncommitted                                        
set nocount on                                        
                              
                              
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                              
set @location='acm'                              
set @odinserver='odin6'                              
set @search = ''                              
  */                         
    
SELECT * into #file1 FROM climast_testing WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null    
          
--select * from #file1  where party_code='d6207'                      
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                              
                                
SELECT                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                            
GROSS_EXP=CONVERT(MONEY,0),                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                          
EFF_DEPOSIT=convert(money,0)                    ,                                            
ALLOWED_DEBIT,GOODWILL,                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                            
HOLDING,                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                
INTO #FILE2                                            
FROM #file1 a left outer join                                            
RISK.DBO.collection_client_details b                                            
on a.party_code=b.party_code                                
                                
--select * from #file2  where party_code='d6207'                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                            
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                            
                                
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                
                           
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                     
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                              
----test                          
--drop table #file2                       
--select * from #file2                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                      
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                          
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                          
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                       
              
update #file2 set EFF_DEPOSIT=deposit               
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0            
Update #file2 SET eff_deposit=0 Where eff_deposit<0          
--update #file2 set deposit=EFF_DEPOSIT                            
---                                  
                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                
                        
---old logic                                
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                   
------                        
                                            
--select * from #file2                                            
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,          
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                      
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,          
cast(debit_value as int)as debit_value,                                      
cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                                 
                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S1
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                                                
                                                
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                
set @location='acm'                                                
set @odinserver='odin6'                                                
set @search = ''                                                
  */                                           
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S1'         
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
                      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
                            
--select * from #file1  where party_code='d6207'                                        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                  
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                
                                                  
SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
EFF_DEPOSIT=convert(money,0)                    ,                                                              
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                                  
--select * from #file2  where party_code='d6207'                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                           
                             
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                  
                                             
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                       
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                
----test                                            
--drop table #file2                                         
--select * from #file2                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                            
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                         
                                
update #file2 set EFF_DEPOSIT=deposit                                 
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
--update #file2 set deposit=EFF_DEPOSIT                                              
---                                                    
                                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                                          
---old logic                                                  
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                     
------                                          
              
--select * from #file2                                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                            
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                        
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                 
cast(debit_value as int)as debit_value,                                                        
---old logic include approved +non-approved holding    
--cast(holding as int)as holding,    
---old logic include only approved  holding    
cast(Appr as int)as holding,    
cast(eff_deposit as int)as eff_deposit,  
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                       
                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S1_test1
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S1_test1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                        
as                                                        
                                                        
set transaction isolation level read uncommitted                                                        
set nocount on                                                        
                                              
                                              
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                              
set @location='acm'                                              
set @odinserver='odin6'                                              
set @search = ''                                              
  */                                         
            
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN710S1'       
            
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                           
                    
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                    
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                    
                          
--select * from #file1  where party_code='d6207'                                      
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                              
                                                
SELECT                                                            
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                            
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                            
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                            
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                            
GROSS_EXP=CONVERT(MONEY,0),                                                    
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                          
EFF_DEPOSIT=convert(money,0)                    ,                                                            
ALLOWED_DEBIT,GOODWILL,                                                            
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                            
HOLDING,                                                
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                
INTO #FILE2                                                            
FROM #file1 a left outer join                                                            
RISK.DBO.collection_client_details b                                                            
on a.party_code=b.party_code                                                
                                                
--select * from #file2  where party_code='d6207'                                                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
                                       
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                            
WHERE #file2.PARTY_CODE=B.CLCODE                                                            
                                               
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                
                                           
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                            
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                     
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                              
----test                                          
--drop table #file2                                       
--select * from #file2                                          
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                      
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                          
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                          
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                       
                              
update #file2 set EFF_DEPOSIT=deposit                               
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                              
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                           
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                           
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                            
Update #file2 SET eff_deposit=0 Where eff_deposit<0                          
--update #file2 set deposit=EFF_DEPOSIT                                            
---                                                  
                                                
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                
                                        
---old logic                                                
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                   
------                                        
            
--select * from #file2                                                            
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                          
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                      
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,               
cast(debit_value as int)as debit_value,                                                      
---old logic include approved +non-approved holding  
--cast(holding as int)as holding,  
---old logic include only approved  holding  
cast(Appr as int)as holding,  
cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                     
                                                       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S2
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S2(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                                                
                                                
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                
set @location='acm'                                                
set @odinserver='odin6'                                                
set @search = ''                                                
  */                                           
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S2'         
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
                      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
                            
--select * from #file1  where party_code='d6207'                                        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                  
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                
                                                  
SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
EFF_DEPOSIT=convert(money,0)                    ,                                                              
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                                  
--select * from #file2  where party_code='d6207'                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                           
                             
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                  
                                             
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                       
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                
----test                                            
--drop table #file2                                         
--select * from #file2                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                            
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                         
                                
update #file2 set EFF_DEPOSIT=deposit                                 
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
--update #file2 set deposit=EFF_DEPOSIT                                              
---                                                    
                                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                                          
---old logic                                                  
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                     
------                                          
              
--select * from #file2                                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                            
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                        
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                 
cast(debit_value as int)as debit_value,                                                        
---old logic include approved +non-approved holding    
--cast(holding as int)as holding,    
---old logic include only approved  holding    
cast(Appr as int)as holding,    
cast(eff_deposit as int)as eff_deposit,
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                     
                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S3
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S3(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                            
as                                                            
                                                            
set transaction isolation level read uncommitted                                                            
set nocount on                                                            
                                                  
                                                  
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                  
set @location='acm'                                                  
set @odinserver='odin6'                                                  
set @search = ''                                                  
  */                                             
                
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S3'           
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                        
                              
--select * from #file1  where party_code='d6207'                                          
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                    
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                  
                                                    
SELECT                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                              
EFF_DEPOSIT=convert(money,0)                    ,                                                                
ALLOWED_DEBIT,GOODWILL,                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                
HOLDING,                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                    
INTO #FILE2                                                                
FROM #file1 a left outer join                                                                
RISK.DBO.collection_client_details b                                                                
on a.party_code=b.party_code                                                    
                                                    
--select * from #file2  where party_code='d6207'                                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                             
                               
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)            
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                    
                                               
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                         
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                  
----test                                              
--drop table #file2                                           
--select * from #file2                                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                              
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                              
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                           
                                  
update #file2 set EFF_DEPOSIT=deposit                                   
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                              
--update #file2 set deposit=EFF_DEPOSIT                                                
---                                                      
                                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                    
                                            
---old logic                                                    
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT      
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                       
------                                            
                
--select * from #file2                                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                              
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                          
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                   
cast(debit_value as int)as debit_value,                                                          
---old logic include approved +non-approved holding      
--cast(holding as int)as holding,      
---old logic include only approved  holding      
cast(Appr as int)as holding,      
cast(eff_deposit as int)as eff_deposit,
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                     
                                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S4
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S4(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                              
as                                                              
                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                                              
                                                    
                                                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                    
set @location='acm'                                                    
set @odinserver='odin6'                                                    
set @search = ''                                                    
  */                                               
                  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S4'             
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          
                                
--select * from #file1  where party_code='d6207'                                            
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                      
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                    
                                                      
SELECT                                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                  
GROSS_EXP=CONVERT(MONEY,0),                                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                
EFF_DEPOSIT=convert(money,0)                    ,                                                                  
ALLOWED_DEBIT,GOODWILL,                                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                  
HOLDING,                                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                      
INTO #FILE2                                                                  
FROM #file1 a left outer join                                                                  
RISK.DBO.collection_client_details b                                                                  
on a.party_code=b.party_code                                                      
                                                      
--select * from #file2  where party_code='d6207'                                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                               
                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                      
                                                 
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                           
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                    
----test                                                
--drop table #file2                                             
--select * from #file2                                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                             
                                    
update #file2 set EFF_DEPOSIT=deposit                                     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
--update #file2 set deposit=EFF_DEPOSIT                                                  
---                                                        
                                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                      
                                              
---old logic                                    
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                         
------                                              
                  
--select * from #file2                                                                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                            
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                     
cast(debit_value as int)as debit_value,                                                            
---old logic include approved +non-approved holding        
--cast(holding as int)as holding,        
---old logic include only approved  holding        
cast(Appr as int)as holding,        
cast(eff_deposit as int)as eff_deposit,  
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                       
                                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S5
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S5(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                              
as                                                              
                                                              
set transaction isolation level read uncommitted                                                              
set nocount on                                                              
                                                    
                                                    
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                    
set @location='acm'                                                    
set @odinserver='odin6'                                                    
set @search = ''                                                    
  */                                               
                  
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S5'             
                  
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                 
                          
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                          
                                
--select * from #file1  where party_code='d6207'                                            
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                      
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                    
                                                      
SELECT                                                                  
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                  
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                  
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                  
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                  
GROSS_EXP=CONVERT(MONEY,0),                                                          
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                
EFF_DEPOSIT=convert(money,0)                    ,                                                                  
ALLOWED_DEBIT,GOODWILL,                                                                  
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                  
HOLDING,                                                      
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                      
INTO #FILE2                                                                  
FROM #file1 a left outer join                                                                  
RISK.DBO.collection_client_details b                                                                  
on a.party_code=b.party_code                                                      
                                                      
--select * from #file2  where party_code='d6207'                                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                               
                                 
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)              
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                      
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                  
WHERE #file2.PARTY_CODE=B.CLCODE                                                                  
                                                     
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                      
                                                 
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                           
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                    
----test                                                
--drop table #file2                                             
--select * from #file2                                                
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                            
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                             
                                    
update #file2 set EFF_DEPOSIT=deposit                                     
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                  
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                    
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                 
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                 
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                  
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                
--update #file2 set deposit=EFF_DEPOSIT                                                  
---                                                        
                                                      
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                      
                                              
---old logic                                    
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                      
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                      
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                         
------                                              
                  
--select * from #file2                                                                  
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                            
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                     
cast(debit_value as int)as debit_value,                                                            
---old logic include approved +non-approved holding        
--cast(holding as int)as holding,        
---old logic include only approved  holding        
cast(Appr as int)as holding,        
cast(eff_deposit as int)as eff_deposit,  
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                       
                                                             
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S6
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S6(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                                                      
                                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                      
set @location='acm'                                                      
set @odinserver='odin6'                                                      
set @search = ''                                                      
  */                                                 
                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S6'               
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            
                                  
--select * from #file1  where party_code='d6207'                                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                      
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                                    
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
--select * from #file2  where party_code='d6207'                                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                 
                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                      
----test                                                  
--drop table #file2                                               
--select * from #file2                                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                               
                                      
update #file2 set EFF_DEPOSIT=deposit                                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  
--update #file2 set deposit=EFF_DEPOSIT                                                    
---                                                          
                                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                        
                                                
---old logic                                      
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT          
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                           
------                                                
                    
--select * from #file2                                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                       
cast(debit_value as int)as debit_value,                                                              
---old logic include approved +non-approved holding          
--cast(holding as int)as holding,          
---old logic include only approved  holding          
cast(Appr as int)as holding,          
cast(eff_deposit as int)as eff_deposit,    
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                         
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S7
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S7(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                
as                                                                
                                                                
set transaction isolation level read uncommitted                                                                
set nocount on                                                                
                                                      
                                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                      
set @location='acm'                                                      
set @odinserver='odin6'                                                      
set @search = ''                                                      
  */                                                 
                    
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S7'               
                    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                   
                            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                            
                                  
--select * from #file1  where party_code='d6207'                                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                        
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                      
                                                        
SELECT                                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                    
GROSS_EXP=CONVERT(MONEY,0),                                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                                    
ALLOWED_DEBIT,GOODWILL,                                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                    
HOLDING,                                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                        
INTO #FILE2                                                                    
FROM #file1 a left outer join                                                                    
RISK.DBO.collection_client_details b                                                                    
on a.party_code=b.party_code                                                        
                                                        
--select * from #file2  where party_code='d6207'                                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                 
                                   
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                                    
                                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                        
                                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                      
----test                                                  
--drop table #file2                                               
--select * from #file2                                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                               
                                      
update #file2 set EFF_DEPOSIT=deposit                                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                  
--update #file2 set deposit=EFF_DEPOSIT                                                    
---                                                          
                                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                        
                                                
---old logic                                      
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT          
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                           
------                                                
                    
--select * from #file2                                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                       
cast(debit_value as int)as debit_value,                                                              
---old logic include approved +non-approved holding          
--cast(holding as int)as holding,          
---old logic include only approved  holding          
cast(Appr as int)as holding,          
cast(eff_deposit as int)as eff_deposit,    
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                         
                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_710S8
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_710S8(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                                  
as                                                                  
                                                                  
set transaction isolation level read uncommitted                                                                  
set nocount on                                                                  
                                                        
                                                        
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                        
set @location='acm'                                                        
set @odinserver='odin6'                                                        
set @search = ''                                                        
  */                                                   
                      
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN710S8'                 
                      
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                                     
                              
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                              
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                              
                                    
--select * from #file1  where party_code='d6207'                                                
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                          
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                        
                                                          
SELECT                                                                      
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                      
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                      
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                      
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                      
GROSS_EXP=CONVERT(MONEY,0),                                                              
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                                    
EFF_DEPOSIT=convert(money,0)                    ,                                                                      
ALLOWED_DEBIT,GOODWILL,                                                                      
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                      
HOLDING,                                                          
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                          
INTO #FILE2                                                                      
FROM #file1 a left outer join                                                                      
RISK.DBO.collection_client_details b                                                                      
on a.party_code=b.party_code                                                          
                                                          
--select * from #file2  where party_code='d6207'                                                                                  
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                   
                                     
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                  
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                          
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                      
WHERE #file2.PARTY_CODE=B.CLCODE                                                                      
                                                         
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                          
                                                     
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                      
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                               
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                        
----test                                                    
--drop table #file2                                                 
--select * from #file2                                                    
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                                    
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                                    
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                                 
                                        
update #file2 set EFF_DEPOSIT=deposit                                         
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                      
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                        
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                                     
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                                     
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                      
Update #file2 SET eff_deposit=0 Where eff_deposit<0                                    
--update #file2 set deposit=EFF_DEPOSIT                      
---                                                            
                                                          
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                          
                                                  
---old logic                                        
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT            
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                          
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                          
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                             
------                                                  
                      
--select * from #file2                                                                      
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                                    
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                                
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                         
cast(debit_value as int)as debit_value,                                                                
---old logic include approved +non-approved holding            
--cast(holding as int)as holding,            
---old logic include only approved  holding            
cast(Appr as int)as holding,            
cast(eff_deposit as int)as eff_deposit,      
cast(FO_COL as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                           
                                                                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
                                      
                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                      
set @location='acm'                                      
set @odinserver='odin6'                                      
set @search = ''                                      
  */                                 
    
SELECT * into #file_1 FROM CLIENT_MAST79    
    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                   
            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null            
                  
--select * from #file1  where party_code='d6207'                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                      
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                    
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
--select * from #file2  where party_code='d6207'                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                             
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                      
----test                                  
--drop table #file2                               
--select * from #file2                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                               
                      
update #file2 set EFF_DEPOSIT=deposit                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                  
--update #file2 set deposit=EFF_DEPOSIT                                    
---                                          
                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                                
---old logic                                        
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
------                                
                                                    
--select * from #file2                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                  
cast(debit_value as int)as debit_value,                                              
---old logic include approved +non-approved holding  
--cast(holding as int)as holding,  
---old logic include only approved  holding  
cast(Appr as int)as holding,  
cast(eff_deposit as int)as eff_deposit,
cast(FO_col as int) as FO_COL
 from #file2 ORDER BY PARTY_CODE                             
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79_test1
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79_test1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                
as                                                
                                                
set transaction isolation level read uncommitted                                                
set nocount on                                                
                                      
                                      
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                      
set @location='acm'                                      
set @odinserver='odin6'                                      
set @search = ''                                      
  */                                 
    
SELECT * into #file_1 FROM CLIENT_MAST79_test1    
    
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                   
            
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null            
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null            
                  
--select * from #file1  where party_code='d6207'                              
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                        
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                      
                                        
SELECT                                                    
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                    
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                    
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                    
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                    
GROSS_EXP=CONVERT(MONEY,0),                                            
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                  
EFF_DEPOSIT=convert(money,0)                    ,                                                    
ALLOWED_DEBIT,GOODWILL,                                                    
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                    
HOLDING,                                        
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                        
INTO #FILE2                                                    
FROM #file1 a left outer join                                                    
RISK.DBO.collection_client_details b                                                    
on a.party_code=b.party_code                                        
                                        
--select * from #file2  where party_code='d6207'                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                                    
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                         
                                                    
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                        
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                    
WHERE #file2.PARTY_CODE=B.CLCODE                                                    
                                       
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                        
                                   
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                        
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                             
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                      
----test                                  
--drop table #file2                               
--select * from #file2                                  
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                              
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                  
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                  
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                               
                      
update #file2 set EFF_DEPOSIT=deposit                       
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                      
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                   
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                   
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                    
Update #file2 SET eff_deposit=0 Where eff_deposit<0                  
--update #file2 set deposit=EFF_DEPOSIT                                    
---                                          
                                        
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                        
                                
---old logic                                        
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                        
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                        
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                           
------                                
                                                    
--select * from #file2                                                    
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                  
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                              
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                  
cast(debit_value as int)as debit_value,                                              
---old logic include approved +non-approved holding  
--cast(holding as int)as holding,  
---old logic include only approved  holding  
cast(Appr as int)as holding,  
cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                             
                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79NEW
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79NEW(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
                                            
                                            
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                            
set @location='acm'                                            
set @odinserver='odin6'                                            
set @search = ''                                            
  */                                       
          
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'        
          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                         
                  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                  
                        
--select * from #file1  where party_code='d6207'                                    
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                            
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
EFF_DEPOSIT=convert(money,0)                    ,                                                          
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
--select * from #file2  where party_code='d6207'                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                         
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                   
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                            
----test                                        
--drop table #file2                                     
--select * from #file2                                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                        
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                        
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                     
                            
update #file2 set EFF_DEPOSIT=deposit                             
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                        
--update #file2 set deposit=EFF_DEPOSIT                                          
---                                                
                                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                                      
---old logic                                              
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                 
------                                      
                      
--select * from #file2                                                          
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,      
cast(limit_multi as int)as limit_multi,                        
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                    
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,             
cast(debit_value as int)as debit_value,                                                    
---old logic include approved +non-approved holding
--cast(holding as int)as holding,
---old logic include only approved  holding
cast(Appr as int)as holding,
cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                   
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79NEW1
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79NEW1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                            
as                                                            
                                                            
set transaction isolation level read uncommitted                                                            
set nocount on                                                            
                                                  
                                                  
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                  
set @location='acm'                                                  
set @odinserver='odin6'                                                  
set @search = ''                                                  
  */                                             
                
--SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S2'              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S2'              
                
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                               
                        
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                        
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                        
                              
--select * from #file1  where party_code='d6207'                                          
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                    
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                  
                                                    
SELECT                                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                                
GROSS_EXP=CONVERT(MONEY,0),                                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                              
EFF_DEPOSIT=convert(money,0)                    ,                                                                
ALLOWED_DEBIT,GOODWILL,                                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                                
HOLDING,                                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                    
INTO #FILE2                                                                
FROM #file1 a left outer join                                                                
RISK.DBO.collection_client_details b                                                                
on a.party_code=b.party_code                                                    
                                                    
--select * from #file2  where party_code='d6207'                                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE         
                                                                
                                        
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                                
                                                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                    
                                               
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                         
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                                  
----test                                              
--drop table #file2                                           
--select * from #file2                                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                              
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                              
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                           
                                  
update #file2 set EFF_DEPOSIT=deposit                                   
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                                
Update #file2 SET eff_deposit=0 Where eff_deposit<0                              
--update #file2 set deposit=EFF_DEPOSIT                                                
---                                                      
                                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                    
                                            
---old logic                                                    
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                    
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT     
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                       
------                                            
                            
--select * from #file2                                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,            
cast(limit_multi as int)as limit_multi,                              
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                          
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                   
cast(debit_value as int)as debit_value,                                                          
---old logic include approved +non-approved holding      
--cast(holding as int)as holding,      
---old logic include only approved  holding      
cast(Appr as int)as holding,      
cast(eff_deposit as int)as eff_deposit,  
cast(FO_col as int) as FO_COL  from #file2 ORDER BY PARTY_CODE                                         
                                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79S3
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79S3(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                                                
                                                
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                
set @location='acm'                                                
set @odinserver='odin6'                                                
set @search = ''                                                
  */                                           
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'         
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
                      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
                            
--select * from #file1  where party_code='d6207'                                        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                  
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                
                                                  
SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
EFF_DEPOSIT=convert(money,0)                    ,                                                              
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                                  
--select * from #file2  where party_code='d6207'                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                         
                           
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                                  
                                             
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
----old logic  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0   

/*
---new logic applied from 02/11/2007 for credit bal  
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                 
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                            
  
---new logic apllied from 02/11/2007 for debit bal  
---UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr    
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                             
  */                                    
----test                                            
--drop table #file2                                         
--select * from #file2                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                            
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                         
                                
update #file2 set EFF_DEPOSIT=deposit                                 
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
--update #file2 set deposit=EFF_DEPOSIT                                              
---                                                    
                                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                                          
---old logic                                                  
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                     
------                                          
            
--select * from #file2                                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                            
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                        
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                 
cast(debit_value as int)as debit_value,                                                        
---old logic include approved +non-approved holding      
--cast(holding as int)as holding,      
---old logic include only approved  holding      
cast(Appr as int)as holding,      
cast(eff_deposit as int)as eff_deposit,    
cast(FO_Col as int)as FO_COL from #file2 ORDER BY PARTY_CODE                                       
                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79S3_test
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79S3_test(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                          
as                                                          
                                                          
set transaction isolation level read uncommitted                                                          
set nocount on                                                          
                                                
                                                
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                                
set @location='acm'                                                
set @odinserver='odin6'                                                
set @search = ''                                                
  */                                           
              
SELECT * into #file_1 FROM CLIENT_MAST79  WHERE ODIN_SERVER='ODIN79S3'         
              
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                             
                      
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
--SELECT * into #file1 FROM #file_1 WHERE brcode like '%' AND ODIN_SERVER='odin79s3' and party_code like '%' and flag is null                      
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                      
                            
--select * from #file1  where party_code='d6207'                                        
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                                  
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                                

SELECT                                                              
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                              
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                              
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                              
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                              
GROSS_EXP=CONVERT(MONEY,0),                                                      
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                            
EFF_DEPOSIT=convert(money,0),                                                              
ALLOWED_DEBIT,GOODWILL,                                                              
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                              
HOLDING,                                                  
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0),
dummy1                                                  
INTO #FILE2                                                              
FROM #file1 a left outer join                                                              
RISK.DBO.collection_client_details b                                                              
on a.party_code=b.party_code                                                  
                                              

--select * from #file2  where party_code='d6207'                                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                         
                           
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)          
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                              
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                                  
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                              
WHERE #file2.PARTY_CODE=B.CLCODE                                                              
                                                 
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                                  

UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)    

                                             
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                                  
----old logic  
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                                  
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL < 0                                                  
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                              
----UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0   
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0   

/******
---******new logic applied from 02/11/2007 for credit bal  
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0                                                 
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL < 0 and debit_value<=0      
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0 and debit_value<=0                                                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0  and debit_value<=0                                            


----*****new logic apllied from 02/11/2007 for debit bal  
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL WHERE debit_value>0 and debit_value>appr    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end) WHERE debit_value>0 and debit_value>appr    
--UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                             
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(case when fo_col>dummy1 and dummy1>0 then dummy1 else fo_col end)+(APPR*.90) WHERE debit_value>0 and debit_value<appr                                                                             
*******/
                                      
----test                                            
--drop table #file2                                         
--select * from #file2                                            
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                        
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                            
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                            
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                         
                                
update #file2 set EFF_DEPOSIT=deposit                                 
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                              
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                                
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                             
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                             
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                              
Update #file2 SET eff_deposit=0 Where eff_deposit<0                            
--update #file2 set deposit=EFF_DEPOSIT                                              
---                                                    
                                                  
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                                  
                                          
---old logic                                                  
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                                  
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                                  
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                     
------                                          
            
--select * from #file2                                                              
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                            
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                        
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,                 
cast(debit_value as int)as debit_value,                                                        
---old logic include approved +non-approved holding      
--cast(holding as int)as holding,      
---old logic include only approved  holding      
cast(Appr as int)as holding,      
cast(eff_deposit as int)as eff_deposit, dummy1,   
cast(FO_Col as int)as FO_COL from #file2 ORDER BY PARTY_CODE                                       
                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_clipostest_79S3_test1
-- --------------------------------------------------
CREATE procedure TEMP_clipostest_79S3_test1(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))                                                      
as                                                      
                                                      
set transaction isolation level read uncommitted                                                      
set nocount on                                                      
                                            
                                            
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                            
set @location='acm'                                            
set @odinserver='odin6'                                            
set @search = ''                                            
  */                                       
          
SELECT * into #file_1 FROM CLIENT_MAST79_test1  WHERE ODIN_SERVER='ODIN79S3'     
          
update #file_1 set BRCODE=replace(BRCODE,'Diet','')                                         
                  
SELECT * into #file1 FROM #file_1 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                  
--SELECT * into #file1 FROM client_mast79 WHERE brcode like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%' and flag is null                  
                        
--select * from #file1  where party_code='d6207'                                    
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                              
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                            
                                              
SELECT                                                          
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                          
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                          
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                          
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                          
GROSS_EXP=CONVERT(MONEY,0),                                                  
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                                        
EFF_DEPOSIT=convert(money,0)                    ,                                                          
ALLOWED_DEBIT,GOODWILL,                                                          
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                          
HOLDING,                                              
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                              
INTO #FILE2                                                          
FROM #file1 a left outer join                                                          
RISK.DBO.collection_client_details b                                                          
on a.party_code=b.party_code                                              
                                              
--select * from #file2  where party_code='d6207'                                                                      
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)      
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                                          
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                              
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                          
WHERE #file2.PARTY_CODE=B.CLCODE                                                          
                                             
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                              
                                         
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                              
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                          
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                                   
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                            
----test                                        
--drop table #file2                                     
--select * from #file2                                        
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                    
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                                        
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                                        
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                                     
                            
update #file2 set EFF_DEPOSIT=deposit                             
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                          
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                            
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1                         
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1                         
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                          
Update #file2 SET eff_deposit=0 Where eff_deposit<0                        
--update #file2 set deposit=EFF_DEPOSIT                                          
---                                                
                                              
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                              
                                      
---old logic                                              
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                              
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                              
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                                 
------                                      
                    
--select * from #file2                                                          
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,                        
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                                    
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,             
cast(debit_value as int)as debit_value,                                                    
---old logic include approved +non-approved holding  
--cast(holding as int)as holding,  
---old logic include only approved  holding  
cast(Appr as int)as holding,  
cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                   
                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEMP_TRclipostest
-- --------------------------------------------------
CREATE procedure TEMP_TRclipostest(@location as varchar(50),@search as varchar(10))                                            
as                                            
                                            
set transaction isolation level read uncommitted                                            
set nocount on                                            
                                  
                                  
/*declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)                                  
set @location='acm'                                  
set @odinserver='odin6'                                  
set @search = ''                                  
  */                             
        
SELECT * into #file1 FROM client_trmast WHERE brcode like @location  and party_code like @search+'%' and flag is null        
--AND ODIN_SERVER=@odinserver
              
--select * from #file1  where party_code='d6207'                          
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE                                    
--UPDATE   #FILE1 SET LIMIT_MULTI=10 WHERE BRCODE='XD'                                  
                                    
SELECT                                                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                                                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                                                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                                                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                                                
GROSS_EXP=CONVERT(MONEY,0),                                        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                              
EFF_DEPOSIT=convert(money,0)                    ,                                                
ALLOWED_DEBIT,GOODWILL,                                                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                                                
HOLDING,                                    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)                                    
INTO #FILE2                                                
FROM #file1 a left outer join                                                
RISK.DBO.collection_client_details b                                                
on a.party_code=b.party_code                                    
                                    
--select * from #file2  where party_code='d6207'                                                            
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=.#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=#file2.DEPOSIT+(B.CASH_COLL)                                    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                                                
WHERE #file2.PARTY_CODE=B.CLCODE                                                
                                   
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)                                    
                               
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0                                    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0                
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0                         
  --UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0                                  
----test                              
--drop table #file2                           
--select * from #file2                              
--update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                          
---update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit                              
--update #file2 set eff_DEPOSIT=min_limit where deposit<min_limit and min_limit<>-1                              
--update #file2 set eff_deposit=max_limit where deposit>max_limit and max_limit<>-1                           
                  
update #file2 set EFF_DEPOSIT=deposit                   
update #file2 set EFF_DEPOSIT=deposit where min_limit=-1 and max_limit=-1                                
update #file2 set Eff_DEPOSIT=deposit where deposit>min_limit and  deposit<max_limit  and  min_limit >= 0 and max_limit >= 0                  
update #file2 set eff_DEPOSIT=min_limit where deposit<=min_limit and min_limit<>-1               
update #file2 set eff_deposit=max_limit where deposit>=max_limit and max_limit<>-1               
Update #file2 SET eff_deposit=0 Where debit_value > allowed_debit and allowed_debit >= 0                
Update #file2 SET eff_deposit=0 Where eff_deposit<0              
--update #file2 set deposit=EFF_DEPOSIT                                
---                                      
                                    
UPDATE #FILE2 SET GROSS_EXP=eff_DEPOSIT*LIMIT_MULTI                                    
                            
---old logic                                    
--UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT                                    
--UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT                                    
--UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0                                    
--UPDATE #FILE2 SET DEPOSIT=0, GRoSS_EXP=0 WHERE GRoSS_EXP < 0                                       
------                            
                                                
--select * from #file2                                                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,              
cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,                                          
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,              
cast(debit_value as int)as debit_value,                                          
cast(holding as int)as holding,cast(eff_deposit as int)as eff_deposit from #file2 ORDER BY PARTY_CODE                                                     
                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.temptest
-- --------------------------------------------------
CREATE procedure temptest(@location as varchar(50),@odinserver as varchar(50),@search as varchar(10))            
as            
            
set transaction isolation level read uncommitted            
set nocount on            
  
/*  
declare @location as varchar(50),@odinserver as varchar(50),@search as varchar(10)  
set @location='%'  
set @odinserver='odin6'  
set @search = ''  
*/  
            
SELECT * into #file1 FROM CLIENT_MAST WHERE LOCATION like @location AND ODIN_SERVER=@odinserver and party_code like @search+'%'    
UPDATE #FILE1 SET SBCODE=B.SUBGROUP FROM INTRANET.RISK.DBO.FINMAST B WHERE #FILE1.PARTY_cODE=B.PARTY_cODE    
    
    
SELECT                
BRCODE,SBCODE,A.PARTY_CODE,A.PARTY_NAME,                
--DEPOSIT=ISNULL(CASH_DEPOSIT,0)+((ISNULL(APPR,0)*.90),LIMIT_MULTI,                
--GROSS_EXP=(ISNULL(CASH_DEPOSIT,0)+(ISNULL(APPR,0)*.90))*LIMIT_MULTI,                
DEPOSIT=ISNULL(CASH_DEPOSIT,0),LIMIT_MULTI,                
GROSS_EXP=CONVERT(MONEY,0),        
MTM_Limit,MIN_LIMIT,MAX_LIMIT,                
ALLOWED_DEBIT,GOODWILL,                
DEBIT_VALUE=ISNULL(ABL,0)+ISNULL(ACDL,0),                
HOLDING,    
APPR=ISNULL(APPR,0),FO_COL=CONVERT(MONEY,0)    
INTO #FILE2                
FROM #file1 a left outer join                
RISK.DBO.collection_client_details b                
on a.party_code=b.party_code    
    
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)    
from (select* from RISK.DBO.FOMARH where sauda_Date = (select max(sauda_date) from RISK.DBO.FOMARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)    
from (select* from RISK.DBO.ncdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.ncdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
                
UPDATE #FILE2 SET DEBIT_VALUE=DEBIT_VALUE+(b.LEDGERAMOUNT*-1),FO_COL=FO_COL+NON_cASH,DEPOSIT=DEPOSIT+(B.CASH_COLL)    
from (select* from RISK.DBO.mcdx_MARH where sauda_Date = (select max(sauda_date) from RISK.DBO.mcdx_MARH)) b                
WHERE #file2.PARTY_CODE=B.CLCODE                
    
---- DEPOSIT = CASH DEPOSIT + LEDGER DEBIT/CREDIT    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+(DEBIT_VALUE*-1)    
    
---- HERE GOODWILL STAND AS A MAX COLLETERAL VALUE    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL < 0    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+FO_COL+APPR*.90 WHERE GOODWILL >= FO_COL+APPR*.90 AND GOODWILL >= 0    
UPDATE #FILE2 SET DEPOSIT=DEPOSIT+GOODWILL WHERE GOODWILL < FO_COL+APPR*.90 AND GOODWILL >= 0    
  
UPDATE #FILE2 SET DEPOSIT=0 where deposit < 0  
    
UPDATE #FILE2 SET GROSS_EXP=DEPOSIT*LIMIT_MULTI    
    
UPDATE #FILE2 SET GROSS_EXP=MAX_LIMIT WHERE MAX_LIMIT >= 0 AND GROSS_EXP > MAX_LIMIT    
UPDATE #FILE2 SET GROSS_EXP=MIN_LIMIT WHERE MIN_LIMIT >= 0 AND GROSS_EXP < MIN_LIMIT    
UPDATE #FILE2 SET GROSS_EXP=0 WHERE ALLOWED_DEBIT < DEBIT_VALUE AND ALLOWED_DEBIT >= 0    
    
                
--select * from #file2                
select brcode,sbcode,party_code,party_name,cast(deposit as int)as deposit,cast(limit_multi as int)as limit_multi,cast(gross_exp as int)as gross_exp,cast(MTM_limit as decimal(5,2))as MTM_limit,cast(min_limit as int)as min_limit,          
cast(max_limit as int)as max_limit,cast(allowed_debit as int)as allowed_debit,cast(goodwill as int)as goodwill,cast(debit_value as int)as debit_value,          
cast(holding as int)as holding from #file2 where sbcode=@location ORDER BY PARTY_CODE                     
           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Trade_Upload
-- --------------------------------------------------
CREATE proc [dbo].[Trade_Upload]  
as                  
  
set transaction  isolation  level read uncommitted                  
  
declare @filename as varchar(100)  
declare @path as varchar(100)              
declare @sql as varchar(1000)               
  
truncate table Trd_upload   
--set @filename= '11_06002.txt'  
  

/*set @path='d:\upload1\Diet\nsecash.txt'*/
set @path='I:\upload1\Diet\nsecash.txt'
SET @SQL = 'BULK INSERT Trd_upload FROM '''+@Path+''' WITH (FIELDTERMINATOR = '','', FirstRow=2,KeepNULLS)'              
exec (@SQL)              
  
truncate table ctt  
  
insert into ctt /*TRDNO,AA,SYMBOL,SERIES,SCRIPNAME,BB,CC,DD,USERID,BRID,BS,QTY,RATE,CLTYPE,clcode,BRCODE,MKTTYPE,EE,FF,tdate,odate,ORDNO,REMARKS,flag,dummy1,sdate,settno,sett_type */  
select a,b,c,d,e,f,g,h,i,j,k,l,convert(money,m),n,o,p,q,r,s,t,u,v,w,'','',x,'','' from Trd_upload  
  
update ctt set dummy1 = @filename  
  
delete from ctt where userid not in ('21659','3039','19436','3288')  
update ctt set sdate = convert(datetime,(substring(odate,4,3)+' '+substring(odate,1,2)+' '+substring(odate,8,4)),100)  
update ctt set settno = a.sett_no from (select sett_no,start_date from AngelNseCM.msajag.dbo.sett_mst where sett_type='N') a where a.start_date = ctt.sdate  
  
delete from nsecashtrade  where sdate = (select distinct sdate from ctt)  
insert into nsecashtrade select * from ctt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Upd_blank_pswd
-- --------------------------------------------------
CREATE procedure [dbo].[Upd_blank_pswd]  
as  
exec AngelBSECM.bsedb_AB.dbo.Angel_updateBlankPswd  
exec AngelNseCM.msajag.dbo.Angel_updateBlankPswd  
exec angelfo.nsefo.dbo.Angel_updateBlankPswd  
exec angelcommodity.mcdx.dbo.Angel_updateBlankPswd  
exec angelcommodity.ncdx.dbo.Angel_updateBlankPswd  
exec AngelBSECM.inhouse.dbo.Angel_updateBlankPswd_bsefo
exec angelcommodity.inhouse.dbo.Angel_updateBlankPswd_mcdxcds
exec angelfo.inhouse.dbo.Angel_updateBlankPswd_nsecurfo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Update_BO_Pswd
-- --------------------------------------------------
CREATE procedure [dbo].[Update_BO_Pswd]  
as  
exec AngelNseCM.msajag.dbo.Angel_Generate_Client_Login  
--go
exec angelfo.nsefo.dbo.Angel_Generate_Client_Login  
--go
exec angelcommodity.mcdx.dbo.Angel_Generate_Client_Login  
--go
exec angelcommodity.ncdx.dbo.Angel_Generate_Client_Login  
--go
exec angelfo.nsecurfo.dbo.Angel_Generate_Client_Login  
--go
exec angelcommodity.mcdxcds.dbo.Angel_Generate_Client_Login  
--go
exec AngelBseCM.bsedb_ab.dbo.Angel_Generate_Client_Login 
--print 'COmpleted'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_allSB4Sachin
-- --------------------------------------------------
CREATE proc usp_allSB4Sachin            
as            
set nocount on                           
            
-- Exec usp_allSB4Sachin            
            
SELECT regexchangesegment=case LEFT(b.regexchangesegment,1)+RIGHT(b.regexchangesegment,2)                               
when  'BCR' then 'BSE Remisior'                               
when  'BCS' then 'BSE '                              
when  'NCS' then 'NSE'                               
when  'NFA' then 'NSEFO'                              
when  'MCX' then 'MCX'                               
when  'NCX' then 'NCDEX'                              
End,                              
b.TAGbranch,RegTag,b.Regname,b.RegTradeName,b.type,b.RegPAN as 'PANNo',b.RegMAPIN as 'STNo' ,                             
b.regResAdd1,b.RegResAdd2,b.RegResCity,b.RegResAdd3,b.RegResPin,                              
b.GLRegisteredCode,b.GLUnregisteredcode,            
b.regResPhone,b.RegoffPhone,b.regResFAX,b.REgEmailId,appstatus=isnull(a.appstatus,''),sebiregno=isnull(a.sebiregno,'')          
into #t        
FROM mis.sb_comp.dbo.bpregmaster B join mis.sb_comp.dbo.bpapplication A                              
on b.RegAprRefNo=A.AppRefNo and b.RegExchangeSegment=a.EST                              
order by RegTag                
        
select distinct a.*,b.ctcl_status,b.Ctclid,b.ctcl_allotdate,b.ctcl_Disablingdate,b.Ctcl_ContactPerson,b.Address,  
b.Ctcl_LineMode from #t a left outer join        
[CTCL1.1].DBO.View_Odin_mast b on  a.regTag = b.Ctcl_ISBtag  and a.regexchangesegment = b.CtclBranch_Segment       
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ClientRequestOfflineOnline_insert
-- --------------------------------------------------
create procedure usp_ClientRequestOfflineOnline_insert 
(@code as varchar(10),@ipAddr as varchar(20),@prdID as varchar(5),@email as varchar(100),@username as varchar(10))
as
insert into ClientRequestOfflineOnline 
(Party_code,Request_Date,Request_IP,EbrokingProduct,email,br_approved,
br_approveddate,generated,br_approvedBy,intru_code) 
select @code,getdate(),@ipAddr,@prdID,@email,'Y',getdate(),0,@username,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------
Create Procedure usp_findinJobs(@Str as varchar(500))  
as  
select b.name,  
Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,  
date_created,date_modified,a.step_id,a.step_name,a.command  
from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b  
where command like '%'+@Str+'%'  
and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findInUSP
-- --------------------------------------------------
CREATE PROCEDURE usp_findInUSP      
@dbname varchar(500),    
@srcstr varchar(500)      
AS      
      
 set nocount on    
 set @srcstr  = '%' + @srcstr + '%'      
    
 declare @str as varchar(1000)    
 set @str=''    
 if @dbname <>''    
 Begin    
 set @dbname=@dbname+'.dbo.'    
 End    
 else    
 begin    
 set @dbname=db_name()+'.dbo.'    
 End    
 print @dbname    
    
 set @str='select O.name,O.xtype from '+@dbname+'sysComments  C '     
 set @str=@str+' join '+@dbname+'sysObjects O on O.id = C.id '     
 set @str=@str+' where O.xtype in (''P'',''V'') and C.text like '''+@srcstr+''''      
 --print @str    
  exec(@str)    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_functions_findInUSP
-- --------------------------------------------------
create PROCEDURE usp_functions_findInUSP  
@str varchar(500)  
AS  
  
 set @str = '%' + @str + '%'  
   
 select O.name from sysComments  C  
 join sysObjects O on O.id = C.id  
 where O.xtype = 'P' and C.text like @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Gen_IPO_File
-- --------------------------------------------------

CREATE Proc [dbo].[USP_Gen_IPO_File](@Type as varchar(20))  
as  
  
truncate table tbl_import_ipo  
  
if @Type = 'CLIENTMASTER'  
Begin   
  
 insert into tbl_import_ipo  
 select left(replace(rtrim(ltrim(party_code)),'|',''),20)+'|'+  
 left(replace(rtrim(ltrim(long_name)),'|',''),25)+'|'+  
 left(replace(rtrim(ltrim(l_address1)),'|',''),50)+'|'+  
 left(replace(rtrim(ltrim(l_address2)),'|',''),50)+'|'+  
 left(replace(rtrim(ltrim(l_address3)),'|',''),50)+'|'+  
 left(replace(rtrim(ltrim(l_city))+' '+rtrim(ltrim(l_zip)),'|',''),50)+'|'+  
 left(replace(rtrim(ltrim(cl_type)),'|',''),5)+'|'+  
 ltrim(rtrim(left(case when DpID1 is null then DpID2 when DpID2 is null then DpID3 else DpID1 end,8)))+'|'+  
 ltrim(rtrim(left(case when cltdpid1 is null then cltdpid2 when cltdpid2 is null then cltdpid3 else cltdpid1 end,16)))+'|'+'A'+'|'+  
 left(replace(rtrim(ltrim(pan_gir_no)),'|',''),20)+'|'+  
 --left(replace(rtrim(ltrim(bsecm)),'|',''),20)+'|'+  
 case when bsecm is null then 'NSE' else 'BSE' end +'|'+  
 left(replace(rtrim(ltrim(lower(email))),'|',''),100)+'|'  
 from risk.dbo.client_details where party_code <> '' and long_name <> '' and cl_type <> '' and (bsecm = 'Y' or NSECM = 'Y')  
 and party_code in (select USERID from risk.dbo.tbl_mf WHERE USERID not in  
 (select Fld_Code from tbl_IPO_Code) ) 
   
 insert into tbl_IPO_Code  
 select party_code from risk.dbo.client_details  (nolock) where party_code <> '' and long_name <> '' and cl_type <> '' and (bsecm = 'Y' or NSECM = 'Y')  
 and party_code in (select USERID from risk.dbo.tbl_mf (nolock) WHERE  USERID not in  
 (select Fld_Code from tbl_IPO_Code))  
  
end   
  
else  
  
begin  
 insert into tbl_import_ipo  
 select rtrim(ltrim(branch_code))+'|'+rtrim(ltrim(branch))+'|'+rtrim(ltrim(Address1))+'|'+rtrim(ltrim(Address2))+'|'+rtrim(ltrim(city))+'|'+rtrim(ltrim(state))+'|'+'A'+'|'+'Y'+'|'+'Y'+'|'+email from risk.dbo.branches  
   
 insert into tbl_Branch_Code  
 select branch_code from risk.dbo.branches where branch_code not in (select * from tbl_Branch_Code)  
end   
  
Declare @s as varchar(1000)  
Declare @s1 as varchar(1000)  
  
/*set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Fld_IPO FROM intranet.CTCL.DBO.tbl_import_ipo" queryout '+'d:\upload1\'+@Type+'.csv -c -SMis -Usa -Pnirwan612'                        */
set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Fld_IPO FROM intranet.CTCL.DBO.tbl_import_ipo" queryout '+'I:\upload1\'+@Type+'.csv -c -SMis -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                        
set @s1= @s+''''                                 
exec(@s1)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Generate_EmpCode
-- --------------------------------------------------
create Proc USP_Generate_EmpCode      
as     

------------------Declare Variables---------
declare @Emp_name as varchar(50)
declare @Emp_No as varchar(50)
declare @Address as varchar(100)
declare @Phone as varchar(100)
declare @Pin as varchar(10)
declare @Email as varchar(100)
declare @City as varchar(50)
declare @State as Varchar(100)
declare @Acntno as varchar(100)
declare @Region as varchar(10)
declare @IPO_Code as varchar(10) 
declare @Qry as varchar(5000)
declare @Ref as Varchar(10)
declare @code as varchar(10)

------------------Query For Emp Code Not Having in Investment Database--------------------  
select Top 10  a.*,b.regioncode+b.nbranchcode as region into #t from emp_info a inner join View_Region b on a.emp_No = b.emp_No  
and a.Emp_NO not in   
(select rtrim(ltrim(remarks)) from ANGEL3.investment.dbo.sub_mast where category = 'E' and remarks is not null)  
and status = 'A'  

---------------------Cursor For UPdating Investment Database for Generate New IPO Employee Code------
DECLARE GenIPOCode_cursor CURSOR FOR select Emp_name,isnull(Address,'') as Address,isnull(Phone,'') as Phone,
isnull(Email,'') as Email,isnull(Acntno,'') as Acntno,isnull(Region,'') as  Region,isnull(Emp_No,'') as Emp_No,
isnull(Pin,'') as Pin,isnull(city,'') as city,isnull(state,'') as state
from #t                    
OPEN GenIPOCode_cursor
                        
FETCH NEXT FROM GenIPOCode_cursor                         
INTO @Emp_name,@Address,@Phone,@Email,@Acntno,@Region,@Emp_No,@Pin,@city,@state                       
                        
WHILE @@FETCH_STATUS = 0                        
BEGIN

set @code = (select Code from mapped_brcode where region+brcd = @Region)

set @Ref = (select @Code+'S'+replace(str(max(right(code,5))+1,5),' ',0) from ANGEL3.investment.dbo.sub_mast where  branchcode = @Code)
 
set @IPO_Code = (select '9'+convert(varchar,replace(str(max(right(subcode,4))+1,4),' ',0))  
from ANGEL3.investment.dbo.sub_mast where category = 'E' and left(subcode,5) = @Region
group by convert(varchar,left(subcode,5)))  

set @IPO_Code = @Region+@IPO_Code
/*
insert into sub_mast values(NULL, '"& code &"',@Emp_name,@Address,@Phone,NULL,@Email,'"& panno &"',NULL,NULL,'IMPORT FROM MF/IPO APPLN on ' + convert(varchar(10),getdate(),103),NULL,NULL,NULL,1, 
NULL, 0, null,NULL,'A',NULL,NULL,NULL,NULL,NULL,'"& mappedcode &"',@IPO_Code,@IPO_Code,'"& doe &"' 
,@Phone,@Acntno,'"& bankname &"','"& branch &"',newid(),NULL,NULL,NULL,NULL, '"& Company &"' ,'"& AmfiReg &"','"& ARNoF &"',convert(datetime,'"& ARNDate &"',103),NULL, 
NULL,NULL ,NULL,NULL,NULL,NULL)
*/

set @Qry = 'insert into sub_mast values(NULL, '''+@Ref+''','''+@Emp_name+''','''+@Address+''','''+@Phone+''',NULL,'''+@Email+''',''"& panno &"'',NULL,NULL,
'''+@Emp_No+''',NULL,''Cheque'','''+@Pin+''',1,1, 0,'''+@City+''','''+@State+''',''E'',NULL,NULL,NULL,NULL,NULL,''"& mappedcode &"'','''+@IPO_Code+''','''+@IPO_Code+''',convert(datetime,convert(varchar(11),getdate(),103),103),'''+@Phone+''','''+@Acntno+''',''HDFC'',''"& branch &"'',newid(),NULL,NULL,NULL,''N'', ''N'' ,
''N'',Null,convert(datetime,convert(varchar(11),getdate(),103),103),NULL,'''+@IPO_Code+''','''+@IPO_Code+''',NULL,''N'',NULL,NULL)'

print @IPO_Code
print @Qry

FETCH NEXT FROM GenIPOCode_cursor                        
INTO @Emp_name,@Address,@Phone,@Email,@Acntno,@Region,@Emp_No,@Pin,@city,@state           
END                                               

CLOSE GenIPOCode_cursor                        
DEALLOCATE GenIPOCode_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Trade_Upload
-- --------------------------------------------------
CREATE proc [dbo].[Usp_Trade_Upload]
(            
@filename as varchar(100)            
)             
as                
set transaction  isolation  level read uncommitted                

--declare @filename as varchar(100)
declare @path as varchar(100)            
declare @sql as varchar(1000)             

--set @filename= '11_06002.txt'
--set @path='d:\upload1\' + @filename            
truncate table Trd_upload 

SET @SQL = 'BULK INSERT Trd_upload FROM '''+@Path+''' WITH (FIELDTERMINATOR = '','', FirstRow=2,KeepNULLS)'            
exec @SQL            
--print @SQL
--BULK INSERT Trd_upload FROM 'd:\upload1\11_06002.txt' WITH (FIELDTERMINATOR = ',', FirstRow=2,KeepNULLS)

truncate table ctt

insert into ctt /*TRDNO,AA,SYMBOL,SERIES,SCRIPNAME,BB,CC,DD,USERID,BRID,BS,QTY,RATE,CLTYPE,clcode,BRCODE,MKTTYPE,EE,FF,tdate,odate,ORDNO,REMARKS,flag,dummy1,sdate,settno,sett_type */
select a,b,c,d,e,f,g,h,i,j,k,l,convert(money,m),n,o,p,q,r,s,t,u,v,w,'','',x,'','' from Trd_upload

update ctt set dummy1 = @filename

delete from ctt where userid not in ('21659','3039','19436','3288')
update ctt set sdate = convert(datetime,(substring(odate,4,3)+' '+substring(odate,1,2)+' '+substring(odate,8,4)),100)
update ctt set settno = a.sett_no from (select sett_no,start_date from AngelNseCM.msajag.dbo.sett_mst where sett_type='N') a where a.start_date = ctt.sdate

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S1
-- --------------------------------------------------
CREATE PROCEDURE VAR_79S1(@br as varchar(20))              
AS              
SET NOCOUNT ON              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '              
into #BSE from mis.dbo.odin_79 where tag like @br      
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '              
into #NSE from mis.dbo.odin_79  where tag like @br            
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='1',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='1',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
---,Filler2=' '              
into #NSEFO from mis.dbo.odin_79  where tag like @br            
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '              
into #MCX from mis.dbo.odin_79 where tag like @br             
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='1',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '              
into #NCDEX from mis.dbo.odin_79 where tag like @br             
              
              
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',              
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',              
Include_Exposure_Margin='0',              
Include_Book_Profit='1',Iclude_Book_Lose='1',              
Include_Net_Permium='0',              
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',              
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '              
into #COMMON from mis.dbo.odin_79  where tag like @br            
              
SELECT * FROM              
(              
select * from #BSE              
union all              
select * from #NSE              
union all              
select * from #NSEFO              
union all              
select * from #MCX              
union all              
select * from #NCDEX              
union all              
select * from #COMMON              
)A               
ORDER BY A.USER_ID              
              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S1_test1
-- --------------------------------------------------
CREATE PROCEDURE VAR_79S1_test1(@br as varchar(20),@search as varchar(10))    
AS                
SET NOCOUNT ON                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #BSE from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'        
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #NSE from mis.dbo.odin_79  where tag like @br and pcode like @search+'%'              
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='1',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='1',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #NSEFO from mis.dbo.odin_79  where tag like @br and pcode like @search+'%'              
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #MCX from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='1',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #NCDEX from mis.dbo.odin_79 where tag like @br and pcode like @search+'%'               
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  --,Filler2=' '                
into #COMMON from mis.dbo.odin_79  where tag like @br and pcode like @search+'%'              
                
SELECT * FROM                
(                
select * from #BSE                
union all                
select * from #NSE                
union all                
select * from #NSEFO                
union all                
select * from #MCX                
union all                
select * from #NCDEX                
union all                
select * from #COMMON                
)A                 
ORDER BY A.USER_ID                
                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S2
-- --------------------------------------------------
CREATE PROCEDURE VAR_79S2(@br as varchar(20))                    
AS                
SET NOCOUNT ON                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
---,Filler2=' '                
into #BSE from mis.dbo.odin_79NEW where tag like @br               
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
---,Filler2=' '                
into #NSE from mis.dbo.odin_79NEW where tag like @br               
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='1',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='1',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #NSEFO from mis.dbo.odin_79NEW where tag like @br               
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #MCX from mis.dbo.odin_79NEW  where tag like @br              
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='1',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #NCDEX from mis.dbo.odin_79NEW  where tag like @br              
                
                
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                
Include_Exposure_Margin='0',                
Include_Book_Profit='1',Iclude_Book_Lose='1',                
Include_Net_Permium='0',                
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                
into #COMMON from mis.dbo.odin_79NEW  where tag like @br              
                
SELECT * FROM                
(                
select * from #BSE                
union all                
select * from #NSE                
union all                
select * from #NSEFO                
union all                
select * from #MCX                
union all                
select * from #NCDEX                
union all                
select * from #COMMON          
)A                 
ORDER BY A.USER_ID                
                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S2_test1
-- --------------------------------------------------
CREATE  PROCEDURE VAR_79S2_test1(@br as varchar(20),@search as varchar(10))    
AS                  
SET NOCOUNT ON                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #BSE from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSE from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'                 
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='1',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSEFO from mis.dbo.odin_79NEW where tag like @br and pcode like @search+'%'                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #MCX from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'                
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NCDEX from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'                
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #COMMON from mis.dbo.odin_79NEW  where tag like @br and pcode like @search+'%'                
                  
SELECT * FROM                  
(                  
select * from #BSE                  
union all                  
select * from #NSE                  
union all                  
select * from #NSEFO                  
union all                  
select * from #MCX                  
union all                  
select * from #NCDEX                  
union all                  
select * from #COMMON            
)A                   
ORDER BY A.USER_ID                  
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S3
-- --------------------------------------------------
CREATE PROCEDURE VAR_79S3(@br as varchar(20))                          
AS                  
SET NOCOUNT ON                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #BSE from mis.dbo.ODIN_79S3 where tag like @br                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSE from mis.dbo.ODIN_79S3 where tag like @br                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='1',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSEFO from mis.dbo.ODIN_79S3 where tag like @br                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #MCX from mis.dbo.ODIN_79S3 where tag like @br                  
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NCDEX from mis.dbo.ODIN_79S3 where tag like @br                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #COMMON from mis.dbo.ODIN_79S3 where tag like @br                 
                  
SELECT * FROM                  
(                
select * from #BSE                  
union all                  
select * from #NSE                  
union all                  
select * from #NSEFO                  
union all                  
select * from #MCX                  
union all                  
select * from #NCDEX                  
union all                  
select * from #COMMON            
)A                   
ORDER BY A.USER_ID                  
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VAR_79S3_test1
-- --------------------------------------------------
CREATE PROCEDURE VAR_79S3_test1(@br as varchar(20),@search as varchar(10))    
AS                  
SET NOCOUNT ON                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='8',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #BSE from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSE from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='2',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='1',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NSEFO from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='16',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #MCX from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                  
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='64',Margin_Indicator='1',Client_Margin='20',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='1',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
--,Filler2=' '                  
into #NCDEX from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                 
                  
                  
select Operational_code='2',Group_ID=tag,User_ID=pcode,Market_segment='-1',Margin_Indicator='0',Client_Margin='0',                  
TopUP_Margin='0',Filler1='0',Include_MTMP='1',Include_MTML='1',                  
Include_Exposure_Margin='0',                  
Include_Book_Profit='1',Iclude_Book_Lose='1',                  
Include_Net_Permium='0',                  
Include_Surveillance_for_AMO='0',Pre_Square_Off_Mode='0',Auto_SquareOff_Mode='0',                  
Force_SquareOff_Mode='0',MTM_Pre_SquareOff='0',MTM_Auto_SqaureOff='0'  
---,Filler2=' '                  
into #COMMON from mis.dbo.ODIN_79S3 where tag like @br and pcode like @search+'%'                 
                  
SELECT * FROM                  
(                  
select * from #BSE                  
union all                  
select * from #NSE                  
union all                  
select * from #NSEFO                  
union all                  
select * from #MCX                  
union all                  
select * from #NCDEX                  
union all                  
select * from #COMMON            
)A                   
ORDER BY A.USER_ID                  
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.verification_status
-- --------------------------------------------------
CREATE proc verification_status (@flag as varchar(5),@verified_by as varchar(10),@fdate as varchar (25),@tdate as varchar (25))
as
set nocount on

if @flag='a'
begin
if @verified_by<>''
begin
if @verified_by='all'
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
else
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by=@verified_by 
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
end
if @verified_by=''
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by is null
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end

end

if @flag='b'
begin
if @verified_by<>''
begin
if @verified_by='all'
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verification_status='Reject'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
else
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by=@verified_by and a.verification_status='Reject'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
end
if @verified_by=''
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by is null and a.verification_status='Reject'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end

end

if @flag='c'
begin
if @verified_by<>''
begin
if @verified_by='all'
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verification_status='Pending'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
else
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by=@verified_by and a.verification_status='Pending'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
end
if @verified_by=''
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by is null and a.verification_status='Pending'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end

end

if @flag='d'
begin
if @verified_by<>''
begin
if @verified_by='all'
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where  a.verification_status='Confirmed'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
else
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by=@verified_by and a.verification_status='Confirmed'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
end
if @verified_by=''
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by is null and a.verification_status='Confirmed'
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end

end

if @flag='e'
begin
if @verified_by<>''
begin
if @verified_by='all'
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where  a.verification_status is null
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
else 
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by=@verified_by and a.verification_status is null
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end
end
if @verified_by=''
begin
select a.requestdatetime,b.branch_cd,b.sub_broker,a.party_code,b.short_name,a.mobile_no,a.email,a.remark 
from misc.dbo.bo_passwordreset a (nolock) join risk.dbo.client_details b (nolock)
on a.party_code=b.party_code where a.verified_by is null and a.verification_status is null
and a.requestdatetime>=@fdate+' 00:00:00' and a.requestdatetime<=@tdate+' 23:59:59'
end

end

set nocount off

GO

-- --------------------------------------------------
-- TABLE dbo.26temp
-- --------------------------------------------------
CREATE TABLE [dbo].[26temp]
(
    [party_codeParty_name] NVARCHAR(255) NULL,
    [F2] NVARCHAR(255) NULL,
    [t1] NVARCHAR(255) NULL,
    [t2] FLOAT NULL,
    [t3] NVARCHAR(255) NULL,
    [branch] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_client_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_client_mast]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak2_client_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[bak2_client_mast]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.blank_pswd_2007
-- --------------------------------------------------
CREATE TABLE [dbo].[blank_pswd_2007]
(
    [party_Code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [encruppswd] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.blank_pswd_2008
-- --------------------------------------------------
CREATE TABLE [dbo].[blank_pswd_2008]
(
    [party_Code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [encruppswd] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_CLIENT_PASSWORD
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_CLIENT_PASSWORD]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL,
    [Source] VARCHAR(25) NULL,
    [GeneratedBy] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_client_password_email
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_client_password_email]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL,
    [Source] VARCHAR(25) NULL,
    [email] VARCHAR(80) NULL,
    [Status] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Client_Password1
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Client_Password1]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL,
    [Source] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bo_client_password2
-- --------------------------------------------------
CREATE TABLE [dbo].[bo_client_password2]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_CLIENT_PASSWORD3
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_CLIENT_PASSWORD3]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Sb_Password
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Sb_Password]
(
    [sbcode] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [encruppswd] VARCHAR(25) NULL,
    [Source] VARCHAR(25) NULL,
    [genertaedby] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_BRFile
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_BRFile]
(
    [broker_code] VARCHAR(10) NULL,
    [Broker_type] VARCHAR(10) NULL,
    [Scrip_cd] VARCHAR(10) NULL,
    [scrip_name] VARCHAR(50) NULL,
    [rate] VARCHAR(10) NULL,
    [qty] VARCHAR(10) NULL,
    [cpty1] VARCHAR(10) NULL,
    [cpty2] VARCHAR(10) NULL,
    [tradetime] VARCHAR(25) NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [orderno] VARCHAR(15) NULL,
    [trdtype] VARCHAR(10) NULL,
    [buy_sell] VARCHAR(10) NULL,
    [tradno] VARCHAR(10) NULL,
    [cli] VARCHAR(10) NULL,
    [isin] VARCHAR(15) NULL,
    [scp_group] VARCHAR(10) NULL,
    [sett_no] VARCHAR(15) NULL,
    [ordertime] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bse_cash
-- --------------------------------------------------
CREATE TABLE [dbo].[bse_cash]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_CI
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_CI]
(
    [scrip_cd] VARCHAR(10) NULL,
    [scrip_name] VARCHAR(150) NULL,
    [capital] MONEY NULL,
    [upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_CI_History
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_CI_History]
(
    [scrip_cd] VARCHAR(10) NULL,
    [scrip_name] VARCHAR(150) NULL,
    [capital] MONEY NULL,
    [upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecashtrade
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecashtrade]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsetemp
-- --------------------------------------------------
CREATE TABLE [dbo].[bsetemp]
(
    [bse] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bulk_deal_history
-- --------------------------------------------------
CREATE TABLE [dbo].[bulk_deal_history]
(
    [Broker] VARCHAR(4) NOT NULL,
    [scrip_Cd] VARCHAR(20) NULL,
    [scrip_name] VARCHAR(150) NULL,
    [party_Code] VARCHAR(50) NULL,
    [Party_name] VARCHAR(150) NULL,
    [SP] VARCHAR(1) NOT NULL,
    [Quantity] INT NULL,
    [Rate] MONEY NULL,
    [Sauda_Date] DATETIME NULL,
    [share] MONEY NULL,
    [Source] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bulk_ResetPswd
-- --------------------------------------------------
CREATE TABLE [dbo].[bulk_ResetPswd]
(
    [pcode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CITY_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CITY_MASTER]
(
    [RecId] VARCHAR(255) NULL,
    [City] VARCHAR(255) NULL,
    [Pincode] VARCHAR(255) NULL,
    [State] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cli_ebrok
-- --------------------------------------------------
CREATE TABLE [dbo].[cli_ebrok]
(
    [party_code] VARBINARY(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_MAST
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_MAST]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_MAST1
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_MAST1]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_MAST79
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_MAST79]
(
    [BRCODE] VARCHAR(15) NULL,
    [SBCODE] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_mast79_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_mast79_temp]
(
    [BRCODE] VARCHAR(15) NULL,
    [SBCODE] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_mast79_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[client_mast79_TEST]
(
    [BRCODE] VARCHAR(15) NULL,
    [SBCODE] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_MAST79_test1
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_MAST79_test1]
(
    [BRCODE] VARCHAR(15) NULL,
    [SBCODE] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_TRMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_TRMAST]
(
    [BRCODE] VARCHAR(30) NULL,
    [SBCODE] VARCHAR(20) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientRequestOfflineOnline
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientRequestOfflineOnline]
(
    [Party_code] VARCHAR(10) NULL,
    [Request_Date] DATETIME NULL,
    [Request_IP] VARCHAR(25) NULL,
    [EbrokingProduct] VARCHAR(25) NULL,
    [Br_approved] VARCHAR(1) NULL,
    [Br_approvedIP] VARCHAR(25) NULL,
    [Br_approvedBy] VARCHAR(25) NULL,
    [Br_approvedDate] DATETIME NULL,
    [email] VARCHAR(80) NULL,
    [Generated] NUMERIC(18, 0) NULL,
    [intru_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.climast_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[climast_testing]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.crms_online_offline
-- --------------------------------------------------
CREATE TABLE [dbo].[crms_online_offline]
(
    [party_code] VARCHAR(25) NULL,
    [status] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.crms_online_offline_updatetime
-- --------------------------------------------------
CREATE TABLE [dbo].[crms_online_offline_updatetime]
(
    [updt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCL
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCL]
(
    [RecId] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL,
    [OdinID] VARCHAR(255) NULL,
    [OffNature] VARCHAR(255) NULL,
    [City] VARCHAR(255) NULL,
    [Pincode] VARCHAR(255) NULL,
    [State] VARCHAR(255) NULL,
    [ContactPerson] VARCHAR(255) NULL,
    [Designation] VARCHAR(255) NULL,
    [LineMode] VARCHAR(255) NULL,
    [ResAddress5] VARCHAR(255) NULL,
    [PerAddress5] VARCHAR(255) NULL,
    [AllotDate] VARCHAR(255) NULL,
    [Status] VARCHAR(255) NULL,
    [Audit] VARCHAR(255) NULL,
    [CTCLID] VARCHAR(255) NULL,
    [CTCLDTL_ID] VARCHAR(255) NULL,
    [Remark] VARCHAR(255) NULL,
    [Created_Date] VARCHAR(255) NULL,
    [IPin] VARCHAR(255) NULL,
    [ICity] VARCHAR(255) NULL,
    [IState] VARCHAR(255) NULL,
    [Approval_Status] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ctcl_Client
-- --------------------------------------------------
CREATE TABLE [dbo].[ctcl_Client]
(
    [OpCode] VARCHAR(100) NULL,
    [User Id] VARCHAR(100) NULL,
    [Group Id] VARCHAR(100) NULL,
    [UserName] VARCHAR(100) NULL,
    [Password] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State pin] VARCHAR(100) NULL,
    [Telephone No] VARCHAR(100) NULL,
    [Fax No] VARCHAR(100) NULL,
    [Email] VARCHAR(100) NULL,
    [Status] VARCHAR(100) NULL,
    [Brokerage] VARCHAR(100) NULL,
    [Surv On_Off] VARCHAR(100) NULL,
    [Surv Auto_Manual] VARCHAR(100) NULL,
    [BankDPOnOff] VARCHAR(100) NULL,
    [ParticipantCode] VARCHAR(100) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] VARCHAR(100) NULL,
    [Filler3] VARCHAR(100) NULL,
    [Filler4] VARCHAR(100) NULL,
    [Trading Allowed] VARCHAR(100) NULL,
    [ClientValidationOnOff] VARCHAR(100) NULL,
    [SpanOnOff] VARCHAR(100) NULL,
    [dervpartcode] VARCHAR(100) NULL,
    [IP Address] VARCHAR(100) NULL,
    [MaxNoOfOrder] VARCHAR(100) NULL,
    [Max. BCast Scrips] VARCHAR(100) NULL,
    [Alias DealerId] VARCHAR(100) NULL,
    [PinCode] VARCHAR(100) NULL,
    [EqFlag] VARCHAR(100) NULL,
    [DervFlag] VARCHAR(100) NULL,
    [CombFlag] VARCHAR(100) NULL,
    [BSEEq] VARCHAR(100) NULL,
    [NEBEComb] VARCHAR(100) NULL,
    [NEBEEq] VARCHAR(100) NULL,
    [Cash CTCL BranchId] VARCHAR(100) NULL,
    [NSE Cash CTCL Id] VARCHAR(100) NULL,
    [Branch Name] VARCHAR(100) NULL,
    [Derv CTCL BranchId] VARCHAR(100) NULL,
    [Derv CTCL Id] VARCHAR(100) NULL,
    [BSE Cash CTCL BranchId1] VARCHAR(100) NULL,
    [Group Admin] VARCHAR(100) NULL,
    [BSE Cash CTCL BranchId2] VARCHAR(100) NULL,
    [BSE Cash CTCL Id] VARCHAR(100) NULL,
    [Col048] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ctcl_dealer
-- --------------------------------------------------
CREATE TABLE [dbo].[ctcl_dealer]
(
    [OpCode] VARCHAR(100) NULL,
    [User Id] VARCHAR(100) NULL,
    [Group Id] VARCHAR(100) NULL,
    [UserName] VARCHAR(100) NULL,
    [Password] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Address1] VARCHAR(100) NULL,
    [Address2] VARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State pin] VARCHAR(100) NULL,
    [Telephone No] VARCHAR(100) NULL,
    [Fax No] VARCHAR(100) NULL,
    [Email] VARCHAR(100) NULL,
    [Status] VARCHAR(100) NULL,
    [Brokerage] VARCHAR(100) NULL,
    [Surv On/Off] VARCHAR(100) NULL,
    [Surv Auto/Manual] VARCHAR(100) NULL,
    [BankDPOnOff] VARCHAR(100) NULL,
    [ParticipantCode] VARCHAR(100) NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] VARCHAR(100) NULL,
    [Filler3] VARCHAR(100) NULL,
    [Filler4] VARCHAR(100) NULL,
    [Trading Allowed] VARCHAR(100) NULL,
    [ClientValidationOnOff] VARCHAR(100) NULL,
    [SpanOnOff] VARCHAR(100) NULL,
    [dervpartcode] VARCHAR(100) NULL,
    [IP Address] VARCHAR(100) NULL,
    [MaxNoOfOrder] VARCHAR(100) NULL,
    [Max. BCast Scrips] VARCHAR(100) NULL,
    [Alias DealerId] VARCHAR(100) NULL,
    [PinCode] VARCHAR(100) NULL,
    [EqFlag] VARCHAR(100) NULL,
    [DervFlag] VARCHAR(100) NULL,
    [CombFlag] VARCHAR(100) NULL,
    [BSEEq] VARCHAR(100) NULL,
    [NEBEComb] VARCHAR(100) NULL,
    [NEBEEq] VARCHAR(100) NULL,
    [Cash CTCL BranchId] VARCHAR(100) NULL,
    [NSE Cash CTCL Id] VARCHAR(100) NULL,
    [Branch Name] VARCHAR(100) NULL,
    [Derv CTCL BranchId] VARCHAR(100) NULL,
    [Derv CTCL Id] VARCHAR(100) NULL,
    [BSE Cash CTCL BranchId1] VARCHAR(100) NULL,
    [Group Admin] VARCHAR(100) NULL,
    [BSE Cash CTCL BranchId2] VARCHAR(100) NULL,
    [BSE Cash CTCL Id] VARCHAR(100) NULL,
    [Col048] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCL_M
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCL_M]
(
    [Old_id] VARCHAR(255) NULL,
    [New_Id] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CtclLogTab
-- --------------------------------------------------
CREATE TABLE [dbo].[CtclLogTab]
(
    [Server] VARCHAR(25) NULL,
    [DealerId] VARCHAR(25) NULL,
    [GroupId] VARCHAR(25) NULL,
    [LogonTime] VARCHAR(50) NULL,
    [LogonAttempt] VARCHAR(25) NULL,
    [Reason] VARCHAR(500) NULL,
    [Dummy1] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCLSegmentCombination
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCLSegmentCombination]
(
    [BSECM] VARCHAR(255) NULL,
    [NSECM] VARCHAR(255) NULL,
    [NSEFO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL,
    [BSEFO] VARCHAR(255) NULL,
    [TOTAL] VARCHAR(255) NULL,
    [SEGMENT] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ctclsegmentcombination_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ctclsegmentcombination_temp]
(
    [BSECM] VARCHAR(255) NULL,
    [NSECM] VARCHAR(255) NULL,
    [NSEFO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL,
    [BSEFO] VARCHAR(255) NULL,
    [TOTAL] VARCHAR(255) NULL,
    [SEGMENT] VARCHAR(255) NULL,
    [MCXSX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ctt
-- --------------------------------------------------
CREATE TABLE [dbo].[ctt]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dealer_loginmast
-- --------------------------------------------------
CREATE TABLE [dbo].[dealer_loginmast]
(
    [uid] INT IDENTITY(1,1) NOT NULL,
    [uname] VARCHAR(50) NULL,
    [password] VARCHAR(50) NULL,
    [location] VARCHAR(50) NULL,
    [category] VARCHAR(50) NULL,
    [email] VARCHAR(50) NULL,
    [from_dt] DATETIME NULL,
    [to_dt] DATETIME NULL,
    [dum1] CHAR(10) NULL,
    [dum2] CHAR(10) NULL,
    [dum3] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEALER_MAST
-- --------------------------------------------------
CREATE TABLE [dbo].[DEALER_MAST]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEALER_MAST_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[DEALER_MAST_backup]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.demo_1
-- --------------------------------------------------
CREATE TABLE [dbo].[demo_1]
(
    [a] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [Region] VARCHAR(16) NULL,
    [Branch] VARCHAR(16) NULL,
    [Sub_broker] VARCHAR(16) NULL,
    [Client_name] VARCHAR(50) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [cli_type] VARCHAR(16) NULL,
    [Tot_brok] MONEY NULL,
    [Online_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_13082009_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_13082009_backup]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_brok
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_brok]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [online] MONEY NULL,
    [tot] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_final
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_final]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_new
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_new]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [Region] VARCHAR(16) NULL,
    [Branch] VARCHAR(16) NULL,
    [Sub_broker] VARCHAR(16) NULL,
    [Client_name] VARCHAR(50) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [cli_type] VARCHAR(16) NULL,
    [Tot_brok] MONEY NULL,
    [Online_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_temp]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [Region] VARCHAR(16) NULL,
    [Branch] VARCHAR(16) NULL,
    [Sub_broker] VARCHAR(16) NULL,
    [Client_name] VARCHAR(50) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [cli_type] VARCHAR(16) NULL,
    [Tot_brok] MONEY NULL,
    [Online_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest_TEMP1
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest_TEMP1]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [Region] VARCHAR(16) NULL,
    [Branch] VARCHAR(16) NULL,
    [Sub_broker] VARCHAR(16) NULL,
    [Client_name] VARCHAR(50) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [cli_type] VARCHAR(16) NULL,
    [Tot_brok] MONEY NULL,
    [Online_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest1
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest1]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL,
    [Region] VARCHAR(16) NULL,
    [Branch] VARCHAR(16) NULL,
    [Sub_broker] VARCHAR(16) NULL,
    [Client_name] VARCHAR(50) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [cli_type] VARCHAR(16) NULL,
    [Tot_brok] MONEY NULL,
    [Online_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebrok_contest123
-- --------------------------------------------------
CREATE TABLE [dbo].[ebrok_contest123]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ebroking_contest_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[ebroking_contest_backup]
(
    [intrucode] VARCHAR(25) NULL,
    [party_code] VARCHAR(25) NULL,
    [sauda_date] DATETIME NULL,
    [mode] VARCHAR(50) NULL,
    [points] INT NULL,
    [update_date] DATETIME NULL,
    [cli_points] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXP_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[EXP_TEMP]
(
    [CLIENT_CODE] VARCHAR(10) NULL,
    [CLIENT_NAME] VARCHAR(10) NULL,
    [DEPOSIT] MONEY NULL,
    [EXPOSURE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXP_TEMP1
-- --------------------------------------------------
CREATE TABLE [dbo].[EXP_TEMP1]
(
    [brcode] VARCHAR(10) NULL,
    [sbcode] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [deposit] INT NULL,
    [limit_multi] INT NULL,
    [gross_exp] INT NULL,
    [MTM_limit] DECIMAL(5, 2) NULL,
    [min_limit] INT NULL,
    [max_limit] INT NULL,
    [allowed_debit] INT NULL,
    [goodwill] INT NULL,
    [debit_value] INT NULL,
    [holding] INT NULL,
    [eff_deposit] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.exposure
-- --------------------------------------------------
CREATE TABLE [dbo].[exposure]
(
    [sbcode] VARCHAR(10) NULL,
    [partyname] VARCHAR(15) NULL,
    [exposure] MONEY NULL,
    [sbexposure] MONEY NULL,
    [datesub] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1
-- --------------------------------------------------
CREATE TABLE [dbo].[file1]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILE2
-- --------------------------------------------------
CREATE TABLE [dbo].[FILE2]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [DEPOSIT] FLOAT NOT NULL,
    [LIMIT_MULTI] MONEY NULL,
    [GROSS_EXP] MONEY NULL,
    [MTM_Limit] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [EFF_DEPOSIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [GOODWILL] MONEY NULL,
    [DEBIT_VALUE] FLOAT NULL,
    [HOLDING] FLOAT NULL,
    [APPR] FLOAT NOT NULL,
    [FO_COL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fo
-- --------------------------------------------------
CREATE TABLE [dbo].[fo]
(
    [trdno] VARCHAR(50) NULL,
    [aa] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [optype] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [stkprice] MONEY NULL,
    [series] VARCHAR(50) NULL,
    [scripname] VARCHAR(200) NULL,
    [bb] VARCHAR(50) NULL,
    [cc] VARCHAR(50) NULL,
    [userid] VARCHAR(50) NULL,
    [brcode] VARCHAR(50) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(50) NULL,
    [brkcode] VARCHAR(50) NULL,
    [dd] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ordno] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.limit_addodin
-- --------------------------------------------------
CREATE TABLE [dbo].[limit_addodin]
(
    [location] VARCHAR(50) NULL,
    [odinserver] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LIMIT_ADDODINTEST
-- --------------------------------------------------
CREATE TABLE [dbo].[LIMIT_ADDODINTEST]
(
    [location] VARCHAR(50) NULL,
    [odinserver] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.limit_def_setg
-- --------------------------------------------------
CREATE TABLE [dbo].[limit_def_setg]
(
    [LIMIT_MULTI] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [f_date] DATETIME NULL,
    [t_date] DATETIME NULL,
    [location] VARCHAR(50) NULL,
    [sb] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.limit_test
-- --------------------------------------------------
CREATE TABLE [dbo].[limit_test]
(
    [BRCODE] NVARCHAR(255) NULL,
    [SBCODE] NVARCHAR(255) NULL,
    [PARTY_CODE] NVARCHAR(255) NULL,
    [PARTY_NAME] NVARCHAR(255) NULL,
    [LIMIT_MULTI] FLOAT NULL,
    [MAX_LIMIT] FLOAT NULL,
    [MIN_LIMIT] FLOAT NULL,
    [MTM_LIMIT] FLOAT NULL,
    [ALLOWED_DEBIT] FLOAT NULL,
    [LOCATION] NVARCHAR(255) NULL,
    [ODIN_SERVER] NVARCHAR(255) NULL,
    [DUMMY1] NVARCHAR(255) NULL,
    [DUMMY2] FLOAT NULL,
    [GOODWILL] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.limt_loginmast
-- --------------------------------------------------
CREATE TABLE [dbo].[limt_loginmast]
(
    [uid] INT IDENTITY(1,1) NOT NULL,
    [uname] VARCHAR(50) NULL,
    [password] VARCHAR(50) NULL,
    [location] VARCHAR(50) NULL,
    [category] VARCHAR(50) NULL,
    [email] VARCHAR(50) NULL,
    [from_dt] DATETIME NULL,
    [to_dt] DATETIME NULL,
    [dum1] CHAR(10) NULL,
    [dum2] CHAR(10) NULL,
    [dum3] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MAPPED_BRCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[MAPPED_BRCODE]
(
    [branch] VARCHAR(50) NULL,
    [code] VARCHAR(2) NULL,
    [branch_name] VARCHAR(50) NULL,
    [brcd] VARCHAR(5) NULL,
    [region] VARCHAR(5) NULL,
    [username] VARCHAR(20) NULL,
    [Access] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mapped_code
-- --------------------------------------------------
CREATE TABLE [dbo].[mapped_code]
(
    [NEW CODE] VARCHAR(255) NULL,
    [OLD CODE] VARCHAR(53) NULL,
    [ACCOUNT HEAD] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL,
    [BRK OLD] VARCHAR(255) NULL,
    [BRK NEW] VARCHAR(53) NULL,
    [F7] VARCHAR(53) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_dump
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_dump]
(
    [AppFor] VARCHAR(5) NULL,
    [SbCode] VARCHAR(50) NOT NULL,
    [NameOfAppl] VARCHAR(50) NULL,
    [add1] VARCHAR(50) NULL,
    [add2] VARCHAR(50) NULL,
    [add3] VARCHAR(50) NULL,
    [telres] VARCHAR(50) NULL,
    [teloff] VARCHAR(50) NULL,
    [mob] VARCHAR(50) NULL,
    [email] VARCHAR(50) NULL,
    [amfino] VARCHAR(15) NULL,
    [arndate] DATETIME NULL,
    [expdate] DATETIME NULL,
    [catogory] VARCHAR(15) NULL,
    [subname] VARCHAR(20) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(15) NULL,
    [panno] VARCHAR(10) NULL,
    [bankname] VARCHAR(15) NULL,
    [bankadd] VARCHAR(15) NULL,
    [actno] VARCHAR(15) NULL,
    [dateofsub] DATETIME NULL,
    [subbr_tag] VARCHAR(50) NULL,
    [srno] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_exception
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_exception]
(
    [branch_name] VARCHAR(50) NULL,
    [brcd] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_log
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_log]
(
    [AppFor] VARCHAR(5) NULL,
    [SbCode] VARCHAR(50) NOT NULL,
    [NameOfAppl] VARCHAR(50) NULL,
    [add1] VARCHAR(50) NULL,
    [add2] VARCHAR(50) NULL,
    [add3] VARCHAR(50) NULL,
    [telres] VARCHAR(50) NULL,
    [teloff] VARCHAR(50) NULL,
    [mob] VARCHAR(50) NULL,
    [email] VARCHAR(50) NULL,
    [amfino] VARCHAR(15) NULL,
    [arndate] DATETIME NULL,
    [expdate] DATETIME NULL,
    [catogory] VARCHAR(15) NULL,
    [subname] VARCHAR(20) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(15) NULL,
    [panno] VARCHAR(10) NULL,
    [bankname] VARCHAR(30) NULL,
    [bankadd] VARCHAR(50) NULL,
    [actno] VARCHAR(20) NULL,
    [dateofsub] DATETIME NULL,
    [srno] INT NOT NULL,
    [doe] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_log2
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_log2]
(
    [AppFor] VARCHAR(8) NULL,
    [SbCode] VARCHAR(50) NOT NULL,
    [NameOfAppl] VARCHAR(50) NULL,
    [add1] VARCHAR(50) NULL,
    [add2] VARCHAR(50) NULL,
    [add3] VARCHAR(50) NULL,
    [telres] VARCHAR(50) NULL,
    [teloff] VARCHAR(50) NULL,
    [mob] VARCHAR(50) NULL,
    [email] VARCHAR(60) NULL,
    [amfino] VARCHAR(25) NULL,
    [arndate] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [catogory] VARCHAR(15) NULL,
    [subname] VARCHAR(30) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(30) NULL,
    [panno] VARCHAR(10) NULL,
    [bankname] VARCHAR(35) NULL,
    [bankadd] VARCHAR(50) NULL,
    [actno] VARCHAR(25) NULL,
    [dateofsub] DATETIME NULL,
    [srno] INT NOT NULL,
    [doe] DATETIME NULL,
    [username] VARCHAR(30) NULL,
    [del_flag] VARCHAR(10) NULL,
    [exist_sub_br] VARCHAR(10) NULL,
    [sub_name] VARCHAR(20) NULL,
    [pancard] VARCHAR(10) NULL,
    [Photo] VARCHAR(10) NULL,
    [addressproof] VARCHAR(10) NULL,
    [arncard] VARCHAR(10) NULL,
    [amficertificate] VARCHAR(10) NULL,
    [Bank_Statement] VARCHAR(10) NULL,
    [cross_cheque] VARCHAR(10) NULL,
    [IRDA_certificate] VARCHAR(50) NULL,
    [ang_ins] INT NULL,
    [sb_ins] INT NULL,
    [ang_ipo] INT NULL,
    [sb_ipo] INT NULL,
    [ang_mf] INT NULL,
    [sb_mf] INT NULL,
    [ang_loan] INT NULL,
    [sb_loan] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_login
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_login]
(
    [username] VARCHAR(15) NULL,
    [password] VARCHAR(15) NULL,
    [type] VARCHAR(15) NULL,
    [rgcd] VARCHAR(5) NULL,
    [brcd] VARCHAR(5) NULL,
    [branch_name] VARCHAR(100) NULL,
    [status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_onlineusers
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_onlineusers]
(
    [username] VARCHAR(20) NULL,
    [pwd] VARCHAR(20) NULL,
    [status] VARCHAR(10) NULL,
    [lastlogin] DATETIME NULL,
    [lastlogout] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mfipo_usertrack
-- --------------------------------------------------
CREATE TABLE [dbo].[mfipo_usertrack]
(
    [sbcode] VARCHAR(10) NULL,
    [username] VARCHAR(20) NULL,
    [dateE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFIPOAppln
-- --------------------------------------------------
CREATE TABLE [dbo].[MFIPOAppln]
(
    [AppFor] VARCHAR(5) NULL,
    [SbCode] NVARCHAR(25) NULL,
    [NameOfAppl] VARCHAR(20) NULL,
    [add1] NVARCHAR(50) NULL,
    [add2] NVARCHAR(50) NULL,
    [add3] NVARCHAR(50) NULL,
    [telres] NUMERIC(18, 0) NULL,
    [teloff] NUMERIC(18, 0) NULL,
    [mob] NUMERIC(18, 0) NULL,
    [email] NVARCHAR(50) NULL,
    [amfino] VARCHAR(15) NULL,
    [arndate] DATETIME NULL,
    [expdate] DATETIME NULL,
    [catogory] VARCHAR(8) NULL,
    [subname] VARCHAR(20) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(15) NULL,
    [panno] VARCHAR(10) NULL,
    [bankname] VARCHAR(15) NULL,
    [bankadd] VARCHAR(15) NULL,
    [actno] VARCHAR(15) NULL,
    [dateofsub] DATETIME NULL,
    [regioncode] NVARCHAR(25) NULL,
    [branchcode] NVARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFIPOAppln2
-- --------------------------------------------------
CREATE TABLE [dbo].[MFIPOAppln2]
(
    [AppFor] VARCHAR(18) NULL,
    [SbCode] VARCHAR(50) NOT NULL,
    [NameOfAppl] VARCHAR(100) NULL,
    [add1] VARCHAR(100) NULL,
    [add2] VARCHAR(100) NULL,
    [add3] VARCHAR(100) NULL,
    [telres] VARCHAR(50) NULL,
    [teloff] VARCHAR(50) NULL,
    [mob] VARCHAR(50) NULL,
    [email] VARCHAR(100) NULL,
    [amfino] VARCHAR(25) NULL,
    [arndate] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [catogory] VARCHAR(15) NULL,
    [subname] VARCHAR(30) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(30) NULL,
    [panno] VARCHAR(15) NULL,
    [bankname] VARCHAR(35) NULL,
    [bankadd] VARCHAR(50) NULL,
    [actno] VARCHAR(25) NULL,
    [dateofsub] DATETIME NULL,
    [srno] INT NOT NULL,
    [doe] DATETIME NULL,
    [username] VARCHAR(30) NULL,
    [del_flag] VARCHAR(10) NULL,
    [exist_sub_br] VARCHAR(10) NULL,
    [sub_name] VARCHAR(20) NULL,
    [pancard] VARCHAR(10) NULL,
    [Photo] VARCHAR(10) NULL,
    [addressproof] VARCHAR(10) NULL,
    [arncard] VARCHAR(10) NULL,
    [amficertificate] VARCHAR(10) NULL,
    [Bank_Statement] VARCHAR(10) NULL,
    [cross_cheque] VARCHAR(10) NULL,
    [IRDA_certificate] VARCHAR(50) NULL,
    [ang_ins] INT NULL,
    [sb_ins] INT NULL,
    [ang_ipo] INT NULL,
    [sb_ipo] INT NULL,
    [ang_mf] INT NULL,
    [sb_mf] INT NULL,
    [ang_loan] INT NULL,
    [sb_loan] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFIPOAppln3
-- --------------------------------------------------
CREATE TABLE [dbo].[MFIPOAppln3]
(
    [AppFor] VARCHAR(8) NULL,
    [SbCode] VARCHAR(50) NULL,
    [NameOfAppl] VARCHAR(100) NULL,
    [add1] VARCHAR(100) NULL,
    [add2] VARCHAR(100) NULL,
    [add3] VARCHAR(100) NULL,
    [telres] VARCHAR(50) NULL,
    [teloff] VARCHAR(50) NULL,
    [mob] VARCHAR(50) NULL,
    [email] VARCHAR(60) NULL,
    [amfino] VARCHAR(25) NULL,
    [arndate] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [catogory] VARCHAR(15) NULL,
    [subname] VARCHAR(30) NULL,
    [ipoamt] MONEY NULL,
    [mfamt] MONEY NULL,
    [fcode] VARCHAR(30) NULL,
    [panno] VARCHAR(10) NULL,
    [bankname] VARCHAR(35) NULL,
    [bankadd] VARCHAR(50) NULL,
    [actno] VARCHAR(25) NULL,
    [dateofsub] DATETIME NULL,
    [srno] INT NOT NULL,
    [doe] DATETIME NULL,
    [username] VARCHAR(30) NULL,
    [del_flag] VARCHAR(10) NULL,
    [exist_sub_br] VARCHAR(10) NULL,
    [sub_name] VARCHAR(20) NULL,
    [AprRefNo] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NC
-- --------------------------------------------------
CREATE TABLE [dbo].[NC]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [TTIME] VARCHAR(50) NULL,
    [OTIME] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [Col024] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nse_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[nse_temp]
(
    [SEGMENT] VARCHAR(1) NULL,
    [VSAT_LL] VARCHAR(10) NULL,
    [USERID] VARCHAR(10) NULL,
    [CTCL_1] VARCHAR(50) NULL,
    [CTCL_2] VARCHAR(50) NULL,
    [CTCL_3] VARCHAR(50) NULL,
    [CTCL_CITY] VARCHAR(35) NULL,
    [CTCL_PIN] VARCHAR(10) NULL,
    [CTCL_STATE] VARCHAR(35) NULL,
    [CTCL_TEL] VARCHAR(25) NULL,
    [CTCL_FAX] VARCHAR(25) NULL,
    [CTCL_EMAIL] VARCHAR(25) NULL,
    [CTCL_PERS] VARCHAR(50) NULL,
    [CTCL_DESIG] VARCHAR(25) NULL,
    [MODE] VARCHAR(25) NULL,
    [APPR_PERS] VARCHAR(50) NULL,
    [FATHER] VARCHAR(50) NULL,
    [DOB] VARCHAR(50) NULL,
    [RESI_1] VARCHAR(50) NULL,
    [RESI_2] VARCHAR(50) NULL,
    [RESI_3] VARCHAR(50) NULL,
    [RESI_4] VARCHAR(50) NULL,
    [RESI_5] VARCHAR(10) NULL,
    [PERM_1] VARCHAR(50) NULL,
    [PERM_2] VARCHAR(50) NULL,
    [PERM_3] VARCHAR(50) NULL,
    [PERM_4] VARCHAR(50) NULL,
    [PERM_5] VARCHAR(10) NULL,
    [RELATION] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(25) NULL,
    [ALLODT] DATETIME NULL,
    [DISADT] DATETIME NULL,
    [NATURE] VARCHAR(25) NULL,
    [STATUS] VARCHAR(1) NULL,
    [ADT] VARCHAR(10) NULL,
    [DDT] VARCHAR(10) NULL,
    [MRELA] VARCHAR(25) NULL,
    [MSRNO] FLOAT NULL,
    [F_I] VARCHAR(1) NULL,
    [MDDT] VARCHAR(10) NULL,
    [MADT] VARCHAR(10) NULL,
    [ncfn_regn] VARCHAR(30) NULL,
    [ncfn_valid_upto] VARCHAR(10) NULL,
    [purpose_ctcl] VARCHAR(3) NULL,
    [regsb_name] VARCHAR(50) NULL,
    [sb_sebi_regn] VARCHAR(12) NULL,
    [person_name] VARCHAR(50) NULL,
    [mapin_det] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecashtrade
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecashtrade]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecashtrade_15
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecashtrade_15]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecashtrade_16
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecashtrade_16]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecashtrade_20
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecashtrade_20]
(
    [TRDNO] VARCHAR(50) NULL,
    [AA] VARCHAR(50) NULL,
    [SYMBOL] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [SCRIPNAME] VARCHAR(200) NULL,
    [BB] VARCHAR(25) NULL,
    [CC] VARCHAR(25) NULL,
    [DD] VARCHAR(25) NULL,
    [USERID] VARCHAR(50) NULL,
    [BRID] VARCHAR(50) NULL,
    [BS] VARCHAR(50) NULL,
    [QTY] INT NULL,
    [RATE] MONEY NULL,
    [CLTYPE] VARCHAR(10) NULL,
    [clcode] VARCHAR(25) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [MKTTYPE] VARCHAR(25) NULL,
    [EE] VARCHAR(25) NULL,
    [FF] VARCHAR(25) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ORDNO] VARCHAR(50) NULL,
    [REMARKS] VARCHAR(50) NULL,
    [flag] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL,
    [settno] VARCHAR(25) NULL,
    [sett_type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefotrade
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefotrade]
(
    [trdno] VARCHAR(50) NULL,
    [aa] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [optype] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [stkprice] MONEY NULL,
    [series] VARCHAR(50) NULL,
    [scripname] VARCHAR(200) NULL,
    [bb] VARCHAR(50) NULL,
    [cc] VARCHAR(50) NULL,
    [userid] VARCHAR(50) NULL,
    [brcode] VARCHAR(50) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(50) NULL,
    [brkcode] VARCHAR(50) NULL,
    [dd] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ordno] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefotrade_15
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefotrade_15]
(
    [trdno] VARCHAR(50) NULL,
    [aa] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [optype] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [stkprice] MONEY NULL,
    [series] VARCHAR(50) NULL,
    [scripname] VARCHAR(200) NULL,
    [bb] VARCHAR(50) NULL,
    [cc] VARCHAR(50) NULL,
    [userid] VARCHAR(50) NULL,
    [brcode] VARCHAR(50) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(50) NULL,
    [brkcode] VARCHAR(50) NULL,
    [dd] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ordno] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefotrade_16
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefotrade_16]
(
    [trdno] VARCHAR(50) NULL,
    [aa] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [optype] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [stkprice] MONEY NULL,
    [series] VARCHAR(50) NULL,
    [scripname] VARCHAR(200) NULL,
    [bb] VARCHAR(50) NULL,
    [cc] VARCHAR(50) NULL,
    [userid] VARCHAR(50) NULL,
    [brcode] VARCHAR(50) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(50) NULL,
    [brkcode] VARCHAR(50) NULL,
    [dd] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ordno] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefotrade_20
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefotrade_20]
(
    [trdno] VARCHAR(50) NULL,
    [aa] VARCHAR(50) NULL,
    [symbol] VARCHAR(50) NULL,
    [optype] VARCHAR(50) NULL,
    [expdate] VARCHAR(50) NULL,
    [stkprice] MONEY NULL,
    [series] VARCHAR(50) NULL,
    [scripname] VARCHAR(200) NULL,
    [bb] VARCHAR(50) NULL,
    [cc] VARCHAR(50) NULL,
    [userid] VARCHAR(50) NULL,
    [brcode] VARCHAR(50) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] INT NULL,
    [rate] MONEY NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(50) NULL,
    [brkcode] VARCHAR(50) NULL,
    [dd] VARCHAR(50) NULL,
    [tdate] VARCHAR(50) NULL,
    [odate] VARCHAR(50) NULL,
    [ordno] VARCHAR(50) NULL,
    [remarks] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [sdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nselist_pending
-- --------------------------------------------------
CREATE TABLE [dbo].[nselist_pending]
(
    [SEGMENT] VARCHAR(1) NULL,
    [VSAT_LL] VARCHAR(10) NULL,
    [USERID] VARCHAR(10) NULL,
    [CTCL_1] VARCHAR(50) NULL,
    [CTCL_2] VARCHAR(50) NULL,
    [CTCL_3] VARCHAR(50) NULL,
    [CTCL_CITY] VARCHAR(35) NULL,
    [CTCL_PIN] VARCHAR(10) NULL,
    [CTCL_STATE] VARCHAR(35) NULL,
    [CTCL_TEL] VARCHAR(25) NULL,
    [CTCL_FAX] VARCHAR(25) NULL,
    [CTCL_EMAIL] VARCHAR(25) NULL,
    [CTCL_PERS] VARCHAR(50) NULL,
    [CTCL_DESIG] VARCHAR(25) NULL,
    [MODE] VARCHAR(25) NULL,
    [APPR_PERS] VARCHAR(50) NULL,
    [FATHER] VARCHAR(50) NULL,
    [DOB] VARCHAR(50) NULL,
    [RESI_1] VARCHAR(50) NULL,
    [RESI_2] VARCHAR(50) NULL,
    [RESI_3] VARCHAR(50) NULL,
    [RESI_4] VARCHAR(50) NULL,
    [RESI_5] VARCHAR(10) NULL,
    [PERM_1] VARCHAR(50) NULL,
    [PERM_2] VARCHAR(50) NULL,
    [PERM_3] VARCHAR(50) NULL,
    [PERM_4] VARCHAR(50) NULL,
    [PERM_5] VARCHAR(10) NULL,
    [RELATION] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(25) NULL,
    [ALLODT] DATETIME NULL,
    [DISADT] DATETIME NULL,
    [NATURE] VARCHAR(25) NULL,
    [STATUS] VARCHAR(1) NULL,
    [ADT] VARCHAR(10) NULL,
    [DDT] VARCHAR(10) NULL,
    [MRELA] VARCHAR(25) NULL,
    [MSRNO] FLOAT NULL,
    [F_I] VARCHAR(1) NULL,
    [MDDT] VARCHAR(10) NULL,
    [MADT] VARCHAR(10) NULL,
    [ncfn_regn] VARCHAR(30) NULL,
    [ncfn_valid_upto] VARCHAR(10) NULL,
    [purpose_ctcl] VARCHAR(3) NULL,
    [regsb_name] VARCHAR(50) NULL,
    [sb_sebi_regn] VARCHAR(12) NULL,
    [person_name] VARCHAR(50) NULL,
    [mapin_det] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nselist_success
-- --------------------------------------------------
CREATE TABLE [dbo].[nselist_success]
(
    [SEGMENT] VARCHAR(1) NULL,
    [VSAT_LL] VARCHAR(10) NULL,
    [USERID] VARCHAR(10) NULL,
    [CTCL_1] VARCHAR(50) NULL,
    [CTCL_2] VARCHAR(50) NULL,
    [CTCL_3] VARCHAR(50) NULL,
    [CTCL_CITY] VARCHAR(35) NULL,
    [CTCL_PIN] VARCHAR(10) NULL,
    [CTCL_STATE] VARCHAR(35) NULL,
    [CTCL_TEL] VARCHAR(25) NULL,
    [CTCL_FAX] VARCHAR(25) NULL,
    [CTCL_EMAIL] VARCHAR(25) NULL,
    [CTCL_PERS] VARCHAR(50) NULL,
    [CTCL_DESIG] VARCHAR(25) NULL,
    [MODE] VARCHAR(25) NULL,
    [APPR_PERS] VARCHAR(50) NULL,
    [FATHER] VARCHAR(50) NULL,
    [DOB] VARCHAR(50) NULL,
    [RESI_1] VARCHAR(50) NULL,
    [RESI_2] VARCHAR(50) NULL,
    [RESI_3] VARCHAR(50) NULL,
    [RESI_4] VARCHAR(50) NULL,
    [RESI_5] VARCHAR(10) NULL,
    [PERM_1] VARCHAR(50) NULL,
    [PERM_2] VARCHAR(50) NULL,
    [PERM_3] VARCHAR(50) NULL,
    [PERM_4] VARCHAR(50) NULL,
    [PERM_5] VARCHAR(10) NULL,
    [RELATION] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(25) NULL,
    [MADT] CHAR(10) NULL,
    [MDDT] CHAR(10) NULL,
    [NATURE] VARCHAR(25) NULL,
    [ncfn_regn] VARCHAR(30) NULL,
    [ncfn_valid_upto] VARCHAR(10) NULL,
    [purpose_ctcl] VARCHAR(10) NULL,
    [regsb_name] VARCHAR(50) NULL,
    [sb_sebi_regn] VARCHAR(12) NULL,
    [person_name] VARCHAR(50) NULL,
    [mapin_det] VARCHAR(9) NULL,
    [status] VARCHAR(2) NULL,
    [SUCCESS] VARCHAR(5) NULL,
    [F_I] VARCHAR(1) NULL,
    [ALLODT] DATETIME NULL,
    [DISADT] DATETIME NULL,
    [update_time] DATETIME NULL,
    [tempid] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nset
-- --------------------------------------------------
CREATE TABLE [dbo].[nset]
(
    [SEGMENT] VARCHAR(1) NULL,
    [VSAT_LL] VARCHAR(10) NULL,
    [USERID] VARCHAR(10) NULL,
    [CTCL_1] VARCHAR(50) NULL,
    [CTCL_2] VARCHAR(50) NULL,
    [CTCL_3] VARCHAR(50) NULL,
    [CTCL_CITY] VARCHAR(35) NULL,
    [CTCL_PIN] VARCHAR(10) NULL,
    [CTCL_STATE] VARCHAR(35) NULL,
    [CTCL_TEL] VARCHAR(25) NULL,
    [CTCL_FAX] VARCHAR(25) NULL,
    [CTCL_EMAIL] VARCHAR(25) NULL,
    [CTCL_PERS] VARCHAR(50) NULL,
    [CTCL_DESIG] VARCHAR(25) NULL,
    [MODE] VARCHAR(25) NULL,
    [APPR_PERS] VARCHAR(50) NULL,
    [FATHER] VARCHAR(50) NULL,
    [DOB] VARCHAR(50) NULL,
    [RESI_1] VARCHAR(50) NULL,
    [RESI_2] VARCHAR(50) NULL,
    [RESI_3] VARCHAR(50) NULL,
    [RESI_4] VARCHAR(50) NULL,
    [RESI_5] VARCHAR(10) NULL,
    [PERM_1] VARCHAR(50) NULL,
    [PERM_2] VARCHAR(50) NULL,
    [PERM_3] VARCHAR(50) NULL,
    [PERM_4] VARCHAR(50) NULL,
    [PERM_5] VARCHAR(10) NULL,
    [RELATION] VARCHAR(2) NULL,
    [CTCLID] VARCHAR(25) NULL,
    [MADT] CHAR(10) NULL,
    [MDDT] CHAR(10) NULL,
    [NATURE] VARCHAR(25) NULL,
    [ncfn_regn] VARCHAR(30) NULL,
    [ncfn_valid_upto] VARCHAR(10) NULL,
    [purpose_ctcl] VARCHAR(10) NULL,
    [regsb_name] VARCHAR(50) NULL,
    [sb_sebi_regn] VARCHAR(12) NULL,
    [person_name] VARCHAR(50) NULL,
    [mapin_det] VARCHAR(9) NULL,
    [status] VARCHAR(2) NULL,
    [SUCCESS] VARCHAR(5) NULL,
    [F_I] VARCHAR(1) NULL,
    [ALLODT] DATETIME NULL,
    [DISADT] DATETIME NULL,
    [update_time] DATETIME NULL,
    [tempid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Odin_tbl
-- --------------------------------------------------
CREATE TABLE [dbo].[Odin_tbl]
(
    [Segment] VARCHAR(255) NULL,
    [Odin_Id] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.odin_xtemp
-- --------------------------------------------------
CREATE TABLE [dbo].[odin_xtemp]
(
    [pcode] VARCHAR(10) NULL,
    [tag] VARCHAR(10) NULL,
    [odin] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.odin_xtemp79
-- --------------------------------------------------
CREATE TABLE [dbo].[odin_xtemp79]
(
    [pcode] VARCHAR(10) NULL,
    [tag] VARCHAR(10) NULL,
    [odin] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sb_limit_setting
-- --------------------------------------------------
CREATE TABLE [dbo].[sb_limit_setting]
(
    [brcode] VARCHAR(10) NULL,
    [sb_code] VARCHAR(10) NULL,
    [sb_name] VARCHAR(10) NULL,
    [limit_multi] NUMERIC(18, 0) NULL,
    [MTM_limit] NUMERIC(18, 0) NULL,
    [MAX_Dep] MONEY NULL,
    [MIN_Dip] MONEY NULL,
    [DB_Allowed] MONEY NULL,
    [goodwill] MONEY NULL,
    [debit_value] MONEY NULL,
    [holding] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbexposure
-- --------------------------------------------------
CREATE TABLE [dbo].[sbexposure]
(
    [sbcode] VARCHAR(10) NULL,
    [clientcode] VARCHAR(10) NULL,
    [clientname] VARCHAR(50) NULL,
    [act_deposit] NUMERIC(10, 0) NOT NULL DEFAULT 0,
    [exposure] NUMERIC(10, 0) NOT NULL DEFAULT 0,
    [date_of_sub] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SBIPOCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[SBIPOCODE]
(
    [REGCODE] NVARCHAR(255) NULL,
    [REGNAME] NVARCHAR(255) NULL,
    [BRCODE] NVARCHAR(255) NULL,
    [BRANCH] NVARCHAR(255) NULL,
    [BRNAME] NVARCHAR(255) NULL,
    [BRTYPE] NVARCHAR(255) NULL,
    [SUBBROKER] NVARCHAR(255) NULL,
    [REGION] NVARCHAR(255) NULL,
    [SBCODE] NVARCHAR(255) NULL,
    [ADD1] NVARCHAR(255) NULL,
    [ADD2] NVARCHAR(255) NULL,
    [ADD3] NVARCHAR(255) NULL,
    [CITY] NVARCHAR(255) NULL,
    [STATE          ] NVARCHAR(255) NULL,
    [PIN] FLOAT NULL,
    [TEL#NO#] FLOAT NULL,
    [EMAIL] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.series
-- --------------------------------------------------
CREATE TABLE [dbo].[series]
(
    [Party Code] NVARCHAR(255) NULL,
    [EbrokiIng_Status] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SERIES1
-- --------------------------------------------------
CREATE TABLE [dbo].[SERIES1]
(
    [Party Code] NVARCHAR(255) NULL,
    [EbrokiIng_Status] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sify_Client_Password
-- --------------------------------------------------
CREATE TABLE [dbo].[Sify_Client_Password]
(
    [party_code] VARCHAR(30) NULL,
    [password] VARCHAR(25) NULL,
    [GeneratedOn] DATETIME NOT NULL,
    [Source] VARCHAR(25) NULL,
    [GeneratedBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sig_Sigma
-- --------------------------------------------------
CREATE TABLE [dbo].[Sig_Sigma]
(
    [Segment] VARCHAR(255) NULL,
    [Branch] VARCHAR(255) NULL,
    [Reg] VARCHAR(255) NULL,
    [RegisterName] VARCHAR(255) NULL,
    [RegisterTradeName] VARCHAR(255) NULL,
    [Type] VARCHAR(255) NULL,
    [PAN] VARCHAR(255) NULL,
    [STNo] VARCHAR(255) NULL,
    [Address1] VARCHAR(255) NULL,
    [Address2] VARCHAR(255) NULL,
    [Address3] VARCHAR(255) NULL,
    [City] VARCHAR(255) NULL,
    [PinCode] VARCHAR(255) NULL,
    [GLRegisteredCode] VARCHAR(255) NULL,
    [GLUnregisteredcode] VARCHAR(255) NULL,
    [Phone] VARCHAR(255) NULL,
    [OfficePhone] VARCHAR(255) NULL,
    [FAXNO] VARCHAR(255) NULL,
    [EmailId] VARCHAR(255) NULL,
    [ApplicationStatus] VARCHAR(255) NULL,
    [SebiRegistration No] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SLMast_log
-- --------------------------------------------------
CREATE TABLE [dbo].[SLMast_log]
(
    [Fyear_1] DECIMAL(4, 0) NOT NULL,
    [Fyear_2] DECIMAL(4, 0) NOT NULL,
    [GlCode] VARCHAR(8) NOT NULL,
    [SlCode] VARCHAR(10) NULL,
    [SlName] VARCHAR(100) NULL,
    [RefNo] DECIMAL(6, 0) NULL,
    [opdr] DECIMAL(12, 2) NULL,
    [opcr] DECIMAL(12, 2) NULL,
    [EditDate] DATETIME NULL,
    [SeqID] DECIMAL(18, 0) NULL,
    [TDS] CHAR(1) NULL,
    [TDSAmount] DECIMAL(12, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SPchar
-- --------------------------------------------------
CREATE TABLE [dbo].[SPchar]
(
    [SpVarVal] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sub_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[sub_mast]
(
    [glcode] VARCHAR(4) NULL,
    [code] VARCHAR(8) NOT NULL,
    [name] VARCHAR(60) NULL,
    [address] VARCHAR(150) NULL,
    [tel_no] VARCHAR(50) NULL,
    [fax_no] VARCHAR(20) NULL,
    [e_mail] VARCHAR(50) NULL,
    [pan_no] VARCHAR(15) NULL,
    [contact] VARCHAR(50) NULL,
    [reffered_by] VARCHAR(50) NULL,
    [remarks] VARCHAR(150) NULL,
    [open_bal] VARCHAR(15) NULL,
    [pay_mode] VARCHAR(15) NULL,
    [pin_no] VARCHAR(8) NULL,
    [active] BIT NULL,
    [mail] BIT NULL,
    [trailpay] BIT NULL,
    [city] VARCHAR(15) NULL,
    [state] VARCHAR(15) NULL,
    [category] VARCHAR(4) NULL,
    [subname] VARCHAR(50) NULL,
    [up] DECIMAL(12, 2) NULL,
    [up54ea] DECIMAL(12, 2) NULL,
    [up54eb] DECIMAL(12, 2) NULL,
    [trail] DECIMAL(12, 2) NULL,
    [branchcode] VARCHAR(2) NULL,
    [subcode] VARCHAR(10) NULL,
    [psubcode] VARCHAR(10) NULL,
    [doe] DATETIME NULL,
    [mobile] VARCHAR(10) NULL,
    [accno] VARCHAR(15) NULL,
    [bankname] VARCHAR(50) NULL,
    [branch] VARCHAR(50) NULL,
    [rowguid] UNIQUEIDENTIFIER NULL,
    [EditDate] DATETIME NULL,
    [seqID] DECIMAL(18, 0) NULL,
    [TDS] FLOAT NULL,
    [SplTDS] CHAR(1) NULL,
    [Company] CHAR(1) NULL,
    [AmfiReg] CHAR(1) NULL,
    [ARNo] VARCHAR(15) NULL,
    [ARNDate] DATETIME NULL,
    [DOL] DATETIME NULL,
    [user_name] VARCHAR(20) NULL,
    [user_pass] VARCHAR(20) NULL,
    [lastLogin] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sudhakar_ctcl_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Sudhakar_ctcl_temp]
(
    [BranchId] NUMERIC(4, 0) NOT NULL,
    [Segment] CHAR(1) NOT NULL,
    [OdinID] VARCHAR(10) NULL,
    [OffNature] NVARCHAR(50) NULL,
    [PanNo] NVARCHAR(10) NULL,
    [SEBINO] NVARCHAR(12) NULL,
    [SubBrokerName] NVARCHAR(50) NULL,
    [AuthPerson] NVARCHAR(50) NULL,
    [MapinNo] NVARCHAR(9) NULL,
    [Address1] NVARCHAR(50) NOT NULL,
    [Address2] NVARCHAR(50) NULL,
    [Address3] NVARCHAR(50) NULL,
    [City] NVARCHAR(35) NULL,
    [Pincode] NVARCHAR(10) NULL,
    [State] NVARCHAR(35) NULL,
    [ContactPerson] NVARCHAR(50) NULL,
    [Designation] NVARCHAR(25) NULL,
    [Phoneno] NVARCHAR(25) NULL,
    [Fax] NVARCHAR(25) NULL,
    [Mailid] NVARCHAR(25) NULL,
    [LineMode] NVARCHAR(50) NOT NULL,
    [ApprovedPerson] NVARCHAR(50) NOT NULL,
    [FatherName] NVARCHAR(50) NOT NULL,
    [DOB] DATETIME NOT NULL,
    [ResAddress1] NVARCHAR(50) NOT NULL,
    [ResAddress2] NVARCHAR(50) NULL,
    [ResAddress3] NVARCHAR(50) NULL,
    [ResAddress4] NVARCHAR(50) NOT NULL,
    [ResAddress5] NVARCHAR(50) NOT NULL,
    [PerAddress1] NVARCHAR(50) NOT NULL,
    [PerAddress2] NVARCHAR(50) NULL,
    [PerAddress3] NVARCHAR(50) NULL,
    [PerAddress4] NVARCHAR(50) NOT NULL,
    [PerAddress5] NVARCHAR(50) NOT NULL,
    [Relation] NUMERIC(2, 0) NOT NULL,
    [AllotDate] DATETIME NOT NULL,
    [DisablingDate] DATETIME NULL,
    [PayNature] NVARCHAR(25) NOT NULL,
    [Regno] NVARCHAR(30) NULL,
    [RegValidDate] DATETIME NULL,
    [Purpose] CHAR(3) NOT NULL,
    [Status] CHAR(1) NOT NULL,
    [Audit] CHAR(1) NOT NULL,
    [CTCLID] NVARCHAR(12) NULL,
    [CTCLDTL_ID] NUMERIC(18, 0) NULL,
    [Remark] NVARCHAR(100) NULL,
    [NCFMTag] CHAR(1) NULL,
    [Ncfm_Remarks] NVARCHAR(100) NULL,
    [Created_By] NUMERIC(2, 0) NOT NULL,
    [Created_Date] DATETIME NOT NULL,
    [Modified_By] NUMERIC(4, 0) NULL,
    [Modified_Date] DATETIME NULL,
    [IBranch_type] NVARCHAR(15) NULL,
    [IAdd1] NVARCHAR(50) NULL,
    [IAdd2] NVARCHAR(50) NULL,
    [IAdd3] NVARCHAR(50) NULL,
    [IPin] NVARCHAR(10) NULL,
    [ICity] NVARCHAR(20) NULL,
    [IState] NVARCHAR(35) NULL,
    [ISBType] NVARCHAR(30) NULL,
    [ISBName] NVARCHAR(50) NULL,
    [ISBRegno] NVARCHAR(12) NULL,
    [ISBRegdt] DATETIME NULL,
    [IAUType] NVARCHAR(20) NULL,
    [IAUName] NVARCHAR(50) NULL,
    [IAUdt] DATETIME NULL,
    [IRelation] NVARCHAR(50) NULL,
    [IVerified] CHAR(2) NULL,
    [ISBTag] NVARCHAR(25) NULL,
    [Approval_Status] NVARCHAR(1) NULL,
    [Approval_Reason] NVARCHAR(50) NULL,
    [Angel_premises] NVARCHAR(10) NULL,
    [IBranch_cd] NVARCHAR(7) NULL,
    [ConServer] NVARCHAR(50) NULL,
    [CTCL_AngEmpCode] NVARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Branch_Code
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Branch_Code]
(
    [Fld_Branch_Code] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_import_ipo
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_import_ipo]
(
    [Fld_IPO] VARCHAR(411) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IPO_Code
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IPO_Code]
(
    [Fld_Code] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Match_data
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Match_data]
(
    [Regtag] VARCHAR(25) NOT NULL,
    [regPan] VARCHAR(100) NULL,
    [pan_no] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp
-- --------------------------------------------------
CREATE TABLE [dbo].[temp]
(
    [party_codeParty_name] NVARCHAR(255) NULL,
    [F2] NVARCHAR(255) NULL,
    [t1] NVARCHAR(255) NULL,
    [t2] FLOAT NULL,
    [t3] NVARCHAR(255) NULL,
    [branch] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_26
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_26]
(
    [party_codeParty_name] NVARCHAR(255) NULL,
    [F2] NVARCHAR(255) NULL,
    [t1] NVARCHAR(255) NULL,
    [t2] FLOAT NULL,
    [t3] NVARCHAR(255) NULL,
    [branch] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_BSE_CI
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_BSE_CI]
(
    [scrip_cd] VARCHAR(10) NULL,
    [scrip_name] VARCHAR(150) NULL,
    [capital] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempclimast
-- --------------------------------------------------
CREATE TABLE [dbo].[tempclimast]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdealer_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdealer_mast]
(
    [BRCODE] VARCHAR(10) NULL,
    [SBCODE] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [LIMIT_MULTI] MONEY NULL,
    [MAX_LIMIT] MONEY NULL,
    [MIN_LIMIT] MONEY NULL,
    [MTM_LIMIT] MONEY NULL,
    [ALLOWED_DEBIT] MONEY NULL,
    [LOCATION] VARCHAR(50) NULL,
    [ODIN_SERVER] VARCHAR(50) NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] INT NULL,
    [GOODWILL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Term_ID
-- --------------------------------------------------
CREATE TABLE [dbo].[Term_ID]
(
    [TERMINAL ID] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Trd_upload
-- --------------------------------------------------
CREATE TABLE [dbo].[Trd_upload]
(
    [a] VARCHAR(300) NULL,
    [b] VARCHAR(300) NULL,
    [c] VARCHAR(300) NULL,
    [d] VARCHAR(300) NULL,
    [e] VARCHAR(300) NULL,
    [f] VARCHAR(300) NULL,
    [g] VARCHAR(300) NULL,
    [h] VARCHAR(300) NULL,
    [i] VARCHAR(300) NULL,
    [j] VARCHAR(300) NULL,
    [k] VARCHAR(300) NULL,
    [l] VARCHAR(300) NULL,
    [m] VARCHAR(300) NULL,
    [n] VARCHAR(300) NULL,
    [o] VARCHAR(300) NULL,
    [p] VARCHAR(300) NULL,
    [q] VARCHAR(300) NULL,
    [r] VARCHAR(300) NULL,
    [s] VARCHAR(300) NULL,
    [t] VARCHAR(300) NULL,
    [u] VARCHAR(300) NULL,
    [v] VARCHAR(300) NULL,
    [w] VARCHAR(300) NULL,
    [x] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.txt
-- --------------------------------------------------
CREATE TABLE [dbo].[txt]
(
    [TABLE_CATALOG] NVARCHAR(128) NULL,
    [TABLE_SCHEMA] NVARCHAR(128) NULL,
    [TABLE_NAME] NVARCHAR(128) NOT NULL,
    [TABLE_TYPE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.update_intrucode_contest
-- --------------------------------------------------
CREATE TABLE [dbo].[update_intrucode_contest]
(
    [party_code] VARCHAR(25) NULL,
    [intrucode] VARCHAR(25) NULL,
    [emp_name] VARCHAR(50) NULL,
    [emp_dept] VARCHAR(50) NULL,
    [entry_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xyz
-- --------------------------------------------------
CREATE TABLE [dbo].[xyz]
(
    [Appfor] VARCHAR(20) NULL,
    [sbcode] INT NULL,
    [Nameofappl] VARCHAR(20) NULL,
    [add1] VARCHAR(20) NULL,
    [add2] VARCHAR(20) NULL,
    [add3] VARCHAR(20) NULL,
    [branch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.dealer_limit
-- --------------------------------------------------
create view dealer_limit
as

select * from
(
select [user id],[group Id],deposit=9999999999,scpcode='',symbol='',series='',grp='',periodicity=170,
inst='',expiry='',strike='',opttype='',grs_exp_multi=1,grs_exp_limit=9999999999,net_exp_multi=-1,
net_exp=-1,Net_sale=-1,Net_sale_limit=-1,net_position_multi=-1,net_position_limit=-1,
to_multi=-1,to_limit=-1,pend_ord_multi=0,pend_order_limit=-1,mtm_multi=-1,mtm_limit=-1,
init_marg_multi=-1,Init_marg_limit=-1,net_qty_limit=-1,single_trans_limit=-1,
single_trans_qty=-1,retain_multi=0,mtmp=0,net_premium=-1,gross_check=0
from  ctcl_dealer (nolock)

union

select [user id],[group Id],deposit=9999999999,scpcode='',symbol='',series='',grp='',periodicity=17,
inst='',expiry='',strike='',opttype='',grs_exp_multi=1,grs_exp_limit=9999999999,net_exp_multi=-1,
net_exp=-1,Net_sale=-1,Net_sale_limit=-1,net_position_multi=-1,net_position_limit=-1,
to_multi=-1,to_limit=-1,pend_ord_multi=0,pend_order_limit=-1,mtm_multi=1,mtm_limit=9999999999,
init_marg_multi=-1,Init_marg_limit=-1,net_qty_limit=-1,single_trans_limit=-1,
single_trans_qty=-1,retain_multi=0,mtmp=0,net_premium=-1,gross_check=0
from  ctcl_dealer (nolock)
) a

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_client
-- --------------------------------------------------
CREATE VIEW EBROK_CLIENT                          
AS                          
select party_code,odin_server from                                  
(                       
/*Commented By Shweta On Jun 29 2010, As Trade Anywhere product has been deactivated */                              
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master                                          
 --union                                
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master_newver                                          
 --union             
/* Commented By Rozina            
select party_code=pcode,odin_server=servermapped                           
from mis.dbo.odinclientinfo                            
where               
ltrim(rtrim(pcode))+ltrim(rtrim(tag))  not in                            
(                          
select ltrim(rtrim(client_id))+'CALNT'                         
from mis.kyc.dbo.tbl_call_trade where product_id='0' and flag='2'                        
)                
and bbb=4    */            
        
/*        
-- Before adding omnesys online        
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'    */        
      
/*commented by Shweta Tiwari On Feb 06 2012*/        
/*      
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'  or  AngelSpeedPro='Y' or AngelWebPro='Y'        
*/      
select party_code=pcode,odin_server=servermapped    from mis.dbo.odinclientinfo   
    where bbb in ('4','134') --and diet>0      
) a

GO

-- --------------------------------------------------
-- VIEW dbo.EBROK_CLIENT_29122012
-- --------------------------------------------------
CREATE VIEW EBROK_CLIENT_29122012
AS                          
select party_code,odin_server from                                  
(                       
/*Commented By Shweta On Jun 29 2010, As Trade Anywhere product has been deactivated */                              
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master                                          
 --union                                
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master_newver                                          
 --union             
/* Commented By Rozina            
select party_code=pcode,odin_server=servermapped                           
from mis.dbo.odinclientinfo                            
where               
ltrim(rtrim(pcode))+ltrim(rtrim(tag))  not in                            
(                          
select ltrim(rtrim(client_id))+'CALNT'                         
from mis.kyc.dbo.tbl_call_trade where product_id='0' and flag='2'                        
)                
and bbb=4    */            
        
/*        
-- Before adding omnesys online        
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'    */        
      
/*commented by Shweta Tiwari On Feb 06 2012*/        
/*      
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'  or  AngelSpeedPro='Y' or AngelWebPro='Y'        
*/      
select party_code=pcode,odin_server=servermapped    from mis.dbo.odinclientinfo   
    where bbb='4' --and diet>0      
) a

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_client_cnt
-- --------------------------------------------------
CREATE View ebrok_client_cnt       
as            
select * from    
(     
select party_code=client_code,odin_server='172.31.15.13' from mis.testdb.dbo.tradeanywhere_master            
 union            
 select party_code=pcode,odin_server=servermapped from mis.dbo.odinclientinfo     
) a --where party_code not in (select client_id from mis.kyc.dbo.tbl_call_trade where product_id=0 and flag=2)

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_client_consolidated
-- --------------------------------------------------
CREATE View ebrok_client_consolidated
 as      
 select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master      
 union      
 select party_code=pcode,odin_server=servermapped from mis.dbo.odinclientinfo (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_client_KYC
-- --------------------------------------------------
CREATE View ebrok_client_KYC          
as          
select * from  
(   
select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master          
 union          
 select party_code=pcode,odin_server=servermapped from mis.dbo.odinclientinfo   
) a --where party_code not in (select client_id from mis.kyc.dbo.tbl_call_trade where product_id=0)

GO

-- --------------------------------------------------
-- VIEW dbo.EBROK_CLIENT_product_bak_21042011
-- --------------------------------------------------
create VIEW EBROK_CLIENT_product_bak_21042011                    
AS                                
/*select party_code=pcode,odin_server=servermapped,      
AngelDiet=isnull(AngelDiet,'N'),AngelTrade=isnull(AngelTrade,'N'),AngelInvestor=isnull(AngelInvestor,'N')               
from mis.dbo.odinclientinfo a  with (nolock)                    
left outer join      
Ebrok_Product_Master b(nolock)      
on a.win=b.win    */      
/*  -- Before adding omnesys online  select party_code=pcode,odin_server=servermapped,      
AngelDiet=case when isnull(win,'') like '%Diet%' then 'Y' else 'N' end,    
AngelTrade=case when replace(isnull(win,''),'Net.Net Lite','') like '%Net.net%' then 'Y' else 'N' end,    
AngelInvestor=case when isnull(win,'') like '%Net.Net Lite%' then 'Y' else 'N' end,    
AngelSwift=case when isnull(win,'') like '%iWin%' then 'Y' else 'N' end    
from mis.dbo.odinclientinfo a  with (nolock)   */    
select party_code=isnull(pcode,userid),odin_server=servermapped,      
AngelDiet=isnull(case when isnull(win,'') like '%Diet%' then 'Y' else 'N' end,'N'),    
AngelTrade=isnull(case when replace(isnull(win,''),'Net.Net Lite','') like '%Net.net%' then 'Y' else 'N' end,'N'),    
AngelInvestor=isnull(case when isnull(win,'') like '%Net.Net Lite%' then 'Y' else 'N' end,'N'),    
AngelSwift=isnull(case when isnull(win,'') like '%iWin%' then 'Y' else 'N' end,'N'),  
AngelSpeedPro=isnull(AngelSpeedPro,'N'),  
AngelWebPro=isnull(AngelWebPro,'N')  
from mis.dbo.odinclientinfo a  with (nolock)  full outer join   
(select userid,  AngelSpeedPro=case when isnull(useraccesstype,'') like '%TWS%' then 'Y' else 'N' end,    
AngelWebPro=case when isnull(useraccesstype,'') like '%WEB|WEBE|WEBS%' then 'Y' else 'N' end   
from ebroking.dbo.omnesys_userInfo a  with (nolock)  ) b  on pcode=userid

GO

-- --------------------------------------------------
-- VIEW dbo.EBROK_CLIENT_Tag
-- --------------------------------------------------
CREATE VIEW EBROK_CLIENT_Tag                          
AS                          
select party_code,odin_server,Tag from                                  
(                       
/*Commented By Shweta On Jun 29 2010, As Trade Anywhere product has been deactivated */                              
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master                                          
 --union                                
--select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master_newver                                          
 --union             
/* Commented By Rozina            
select party_code=pcode,odin_server=servermapped                           
from mis.dbo.odinclientinfo                            
where               
ltrim(rtrim(pcode))+ltrim(rtrim(tag))  not in                            
(                          
select ltrim(rtrim(client_id))+'CALNT'                         
from mis.kyc.dbo.tbl_call_trade where product_id='0' and flag='2'                        
)                
and bbb=4    */            
        
/*        
-- Before adding omnesys online        
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'    */        
      
/*commented by Shweta Tiwari On Feb 06 2012*/        
/*      
select party_code,odin_server  from mis.dbo.ebrok_client_product           
where angeldiet='Y' or angeltrade='Y' or angelinvestor='Y'  or AngelSwift='Y'  or  AngelSpeedPro='Y' or AngelWebPro='Y'        
*/      
select party_code=pcode,odin_server=servermapped,Tag    from mis.dbo.odinclientinfo   
    where bbb='4' --and diet>0      
) a

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_client1
-- --------------------------------------------------
CREATE View ebrok_client1              
as     
select * from  
(            
 select party_code=client_code,odin_server='Anywhere' from mis.testdb.dbo.tradeanywhere_master              
 union              
select pcode,odin_server from mis.dbo.odinclientinfo a left outer join
(select distinct fld_manager_ip,odin_server=max(fld_manager_name) from mis.genodinlimit.dbo.tbl_ebrok_manager_master 
group by fld_manager_ip )b
on a.servermapped=b.fld_manager_ip
) a where party_code not in (select client_id from mis.kyc.dbo.tbl_call_trade where product_id=0)

GO

-- --------------------------------------------------
-- VIEW dbo.ebrok_product
-- --------------------------------------------------
CREATE view ebrok_product    
as    
/*select distinct a.party_code,products_allowed=max(b.products_allowed) from ebrok_client a join mis.genodinlimit.dbo.diet_cli_all_hist b    
on a.party_code=b.party_code and replace(a.odin_server,'Anywhere','172.31.15.51')=b.server 
--where a.party_code='CHAD082'
group by a.party_code
*/

select party_code,products_allowed=isnull(case 
when angeldiet='Y' then 'AngelDiet|' 
when angeltrade='Y' then 'AngelTrade|'
when angelinvestor='Y' then 'AngelInvestor|'
when AngelSwift='Y' then 'AngelSwift|'
end,'')
from 
mis.dbo.ebrok_client_product (nolock)
where 
(
angeldiet='Y' 
or angeltrade='Y'
or angelinvestor='Y'
or AngelSwift='Y'
)

GO

-- --------------------------------------------------
-- VIEW dbo.get_BoCliEncryptPswd
-- --------------------------------------------------
CREATE view get_BoCliEncryptPswd          
as          

select a.party_Code,a.password,a.encruppswd,a.GeneratedOn from dbo.BO_Client_Password a (nolock),          
(select party_Code,GeneratedOn=max(GeneratedOn) from BO_Client_Password group by party_Code) b
where a.party_Code=b.party_code and a.GeneratedOn=b.GeneratedOn

/*
select party_Code,password,encruppswd,GeneratedOn from dbo.BO_Client_Password (nolock)           
where ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),generatedOn,102),'.','')+replace(convert(varchar(25),generatedOn,108),':','')          
in (select           
ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),max(generatedOn),102),'.','')+replace(convert(varchar(25),max(generatedOn),108),':','')          
from dbo.BO_Client_Password (nolock) group by party_Code) 
*/

GO

-- --------------------------------------------------
-- VIEW dbo.get_BoCliEncryptPswd1
-- --------------------------------------------------
CREATE view get_BoCliEncryptPswd1            
as            
  
select a.party_Code,a.password,a.encruppswd,a.GeneratedOn,generatedby from dbo.BO_Client_Password a (nolock),            
(select party_Code,GeneratedOn=max(GeneratedOn) from BO_Client_Password group by party_Code) b  
where a.party_Code=b.party_code and a.GeneratedOn=b.GeneratedOn  
  
/*  
select party_Code,password,encruppswd,GeneratedOn from dbo.BO_Client_Password (nolock)             
where ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),generatedOn,102),'.','')+replace(convert(varchar(25),generatedOn,108),':','')            
in (select             
ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),max(generatedOn),102),'.','')+replace(convert(varchar(25),max(generatedOn),108),':','')            
from dbo.BO_Client_Password (nolock) group by party_Code)   
*/

GO

-- --------------------------------------------------
-- VIEW dbo.get_BoSBEncryptPswd
-- --------------------------------------------------
CREATE view get_BoSBEncryptPswd      
as      
select sbcode,password,encruppswd,GeneratedOn from ctcl.dbo.BO_SB_Password (nolock)       
where ltrim(rtrim(sbCode))+'|'+replace(convert(varchar(25),generatedOn,102),'.','')+replace(convert(varchar(25),generatedOn,108),':','')      
in (select       
ltrim(rtrim(sbCode))+'|'+replace(convert(varchar(25),max(generatedOn),102),'.','')+replace(convert(varchar(25),max(generatedOn),108),':','')      
from ctcl.dbo.BO_SB_Password (nolock) group by sbcode)

GO

-- --------------------------------------------------
-- VIEW dbo.get_SifyCliPswd
-- --------------------------------------------------
CREATE view get_SifyCliPswd            
as            
  
select a.party_Code,a.password,a.GeneratedOn from dbo.Sify_Client_Password a (nolock),            
(select party_Code,GeneratedOn=max(GeneratedOn) from Sify_Client_Password group by party_Code) b  
where a.party_Code=b.party_code and a.GeneratedOn=b.GeneratedOn  
  
/*  
select party_Code,password,encruppswd,GeneratedOn from dbo.BO_Client_Password (nolock)             
where ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),generatedOn,102),'.','')+replace(convert(varchar(25),generatedOn,108),':','')            
in (select             
ltrim(rtrim(party_Code))+'|'+replace(convert(varchar(25),max(generatedOn),102),'.','')+replace(convert(varchar(25),max(generatedOn),108),':','')            
from dbo.BO_Client_Password (nolock) group by party_Code)   
*/

GO

-- --------------------------------------------------
-- VIEW dbo.mimansa_interested_cli
-- --------------------------------------------------
CREATE view dbo.mimansa_interested_cli        
as       
select entry_time_stamp=max(recieveddate),a.party_code,mobile_pager=convert(varchar(25),max(msisdn))      
from middleware.mimansa.dbo.tbl_smsrecieved a join risk.dbo.client_details b on      
a.party_code=b.party_code where message like '%EBRO%'        
 and a.party_code<>'' and convert(varchar(25),a.msisdn,103)=case when b.mobile_pager is null then '' else '91'+b.mobile_pager  end    
group by a.party_code ,b.mobile_pager       
union       
select distinct entry_time_stamp=max(entry_time_stamp),party_code,mobile_pager=''       
from  middleware.mimansa.dbo.tbl_cs_e_brok_scheme_log where party_code not in       
(select distinct party_code from middleware.mimansa.dbo.tbl_smsrecieved)       
group by party_code

GO

-- --------------------------------------------------
-- VIEW dbo.mimansa_interested_cli_proton
-- --------------------------------------------------
CREATE view dbo.mimansa_interested_cli_proton            
as           
select entry_time_stamp=max(recieveddate),a.party_code,mobile_pager=convert(varchar(25),max(msisdn)),status='SMS'          
from middleware.mimansa.dbo.tbl_smsrecieved a join risk.dbo.client_details b on          
a.party_code=b.party_code where message like '%EBRO+%'            
 and a.party_code<>'' --and convert(varchar(25),a.msisdn,103)=case when b.mobile_pager is null then '' else '91'+b.mobile_pager  end        
group by a.party_code ,b.mobile_pager           
union           
select distinct entry_time_stamp=max(registration_datetime),party_code=client_code,mobile_pager='',status='EMAIL'            
from  [196.1.115.158].missc.dbo.Photon_log     
group by client_code

GO

-- --------------------------------------------------
-- VIEW dbo.nsecashtrade_all
-- --------------------------------------------------
create view nsecashtrade_all
as
select * from nsecashtrade_15
union all
select * from nsecashtrade_16
union all
select * from nsecashtrade_20

GO

-- --------------------------------------------------
-- VIEW dbo.nsefotrade_all
-- --------------------------------------------------
create view nsefotrade_all
as
select * from nsefotrade_15
union all
select * from nsefotrade_16
union all
select * from nsefotrade_20

GO

-- --------------------------------------------------
-- VIEW dbo.Pswd_Request_ofsb_Summary_View
-- --------------------------------------------------
CREATE View Pswd_Request_ofsb_Summary_View  
as  
  
  
select Tdate=isnull(x.GeneratedOn,y.RequestDateTime),  
--WK_Pswd_generated=isnull(WK_Pswd_generated,0),  
Request_Pswd_generated=isnull(Request_Pswd_generated,0),  
Verified=isnull(Verified,0),  
Pending=isnull(Pending,0),  
Rejected=isnull(Rejected,0),  
NotVerified=isnull(NotVerified,0)  
from  
(  
select GeneratedOn,  
--WK_Pswd_generated=sum(case when source = 'WelcomeKit' then 1 else 0 end),  
Request_Pswd_generated=sum(case when source = 'request' then 1 else 0 end)  
from   
(select distinct GeneratedOn=convert(datetime,convert(varchar(11),GeneratedOn)),sbCode,source  
from ctcl.dbo.BO_sb_PASSWORD (nolock)  
) a group by GeneratedOn  
) x full outer join  
(  
select RequestDateTime=convert(datetime,convert(varchar(11),RequestDateTime)),  
Verified=sum(case when Verification_status='Confirmed' then 1 else 0 end) ,  
Pending=sum(case when Verification_status='Pending' then 1 else 0 end),  
Rejected=sum(case when Verification_status='Reject' then 1 else 0 end),  
NotVerified=sum(case when isnull(Verification_status,'')='' then 1 else 0 end)  
from misc.dbo.sb_verification (nolock)  
group by convert(datetime,convert(varchar(11),RequestDateTime))  
) y on x.generatedon=y.requestdatetime

GO

-- --------------------------------------------------
-- VIEW dbo.Pswd_Request_Summary_View
-- --------------------------------------------------
create View Pswd_Request_Summary_View
as


select Tdate=isnull(x.GeneratedOn,y.RequestDateTime),
WK_Pswd_generated=isnull(WK_Pswd_generated,0),
Request_Pswd_generated=isnull(Request_Pswd_generated,0),
Verified=isnull(Verified,0),
Pending=isnull(Pending,0),
Rejected=isnull(Rejected,0),
NotVerified=isnull(NotVerified,0)
from
(
select GeneratedOn,
WK_Pswd_generated=sum(case when source = 'WelcomeKit' then 1 else 0 end),
Request_Pswd_generated=sum(case when source = 'request' then 1 else 0 end)
from 
(select distinct GeneratedOn=convert(datetime,convert(varchar(11),GeneratedOn)),party_Code,source
from ctcl.dbo.BO_CLIENT_PASSWORD (nolock)
) a group by GeneratedOn
) x full outer join
(
select RequestDateTime=convert(datetime,convert(varchar(11),RequestDateTime)),
Verified=sum(case when Verification_status='Confirmed' then 1 else 0 end) ,
Pending=sum(case when Verification_status='Pending' then 1 else 0 end),
Rejected=sum(case when Verification_status='Reject' then 1 else 0 end),
NotVerified=sum(case when isnull(Verification_status,'')='' then 1 else 0 end)
from misc.dbo.BO_PasswordReset (nolock)
group by convert(datetime,convert(varchar(11),RequestDateTime))
) y on x.generatedon=y.requestdatetime

GO

-- --------------------------------------------------
-- VIEW dbo.Reg_UnReg_Bulk
-- --------------------------------------------------
Create View Reg_UnReg_Bulk
as
select a.*,b.mobile,b.email,reg=case when b.party_code is null then 0 else 1 end 
from bulk_ResetPswd a
left outer join
(select party_code,mobile=max(mobile_pager),email=max(email) 
from risk.dbo.Validated_ClientMobile 
--where party_code='bl18999'
group by party_code
) b on a.pcode=b.party_code

GO

-- --------------------------------------------------
-- VIEW dbo.SendPswd_bulk
-- --------------------------------------------------
Create view SendPswd_bulk
as
select a.*,b.short_name from
(
select a.*,b.password from Reg_UnReg_Bulk a
join
(select party_code,password from get_BoCliEncryptPswd
) b
on a.pcode=b.party_code
) a
left outer join (select party_code,short_name from risk.dbo.client_details(nolock)) b
on a.pcode=b.party_code

GO

-- --------------------------------------------------
-- VIEW dbo.vw_CTCL_Odin_ScripBlocking_File
-- --------------------------------------------------
create view vw_CTCL_Odin_ScripBlocking_File
as
select party_code,GroupID,branch_cd,server,Product='CTCL' from mis.dbo.ctcl_vsat_79 
 union all
select pcode,tag,prd,servermapped,Product='Diet' from mis.dbo.odinclientinfo

GO

